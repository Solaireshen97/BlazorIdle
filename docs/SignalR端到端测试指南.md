# SignalR 端到端测试指南

**版本**: 1.0  
**创建日期**: 2025-10-14  
**状态**: 测试就绪

---

## 📋 测试目标

验证 SignalR 实时通信系统在完整用户流程中的功能性、可靠性和性能。

---

## 🧪 测试环境准备

### 1. 环境要求

- .NET 8.0 SDK
- 浏览器支持 WebSocket
- 本地开发环境或测试环境

### 2. 配置检查

**服务端配置** (`appsettings.Development.json`):
```json
{
  "SignalR": {
    "EnableSignalR": true,
    "EnableDetailedLogging": true,
    "Notification": {
      "EnablePlayerDeathNotification": true,
      "EnablePlayerReviveNotification": true,
      "EnableEnemyKilledNotification": true,
      "EnableTargetSwitchedNotification": true
    }
  }
}
```

**客户端配置** (`signalr.Development.json`):
```json
{
  "SignalR": {
    "EnableDetailedLogging": true,
    "ConnectionStatusNotifications": true
  }
}
```

### 3. 启动服务

```bash
# 终端 1: 启动服务端
cd BlazorIdle.Server
dotnet run

# 终端 2: 启动客户端（如果是独立前端）
cd BlazorIdle
dotnet run
```

---

## ✅ 测试用例

### Test Case 1: 基础连接测试

**测试步骤**:
1. 打开浏览器，访问应用首页
2. 登录账号
3. 打开浏览器开发者工具（F12）
4. 切换到 Console 标签页

**预期结果**:
- [ ] 看到日志：`Connected to SignalR Hub: https://localhost:7056/hubs/battle`
- [ ] 看到 Toast 通知：`✅ 实时通知已启用`
- [ ] Network 标签显示 WebSocket 连接建立（状态: 101 Switching Protocols）

**验收标准**:
- 连接在 5 秒内建立
- 无 401/403 认证错误
- WebSocket 连接状态为 "Open"

---

### Test Case 2: 战斗订阅测试

**测试步骤**:
1. 确认已登录且 SignalR 已连接
2. 选择一个角色
3. 启动 Step 战斗（选择敌人、设置时长）
4. 观察控制台日志

**预期结果**:
- [ ] 看到日志：`Subscribed to battle {BattleId}`
- [ ] 战斗开始后，收到 `StateChanged` 事件
- [ ] 看到事件日志：`[SignalR] 收到事件: {EventType}, BattleId: {BattleId}`

**验收标准**:
- 订阅在战斗开始时立即完成
- 无订阅失败错误
- 能接收到事件通知

---

### Test Case 3: 事件通知测试

**前置条件**: 已完成 Test Case 2

**测试步骤**:
1. 观察正在进行的战斗
2. 等待以下事件发生：
   - 玩家死亡
   - 玩家复活
   - 击杀敌人
   - 目标切换

**预期结果**:

| 事件类型 | Toast 通知 | 控制台日志 | 轮询触发 |
|---------|-----------|-----------|---------|
| PlayerDeath | 💀 角色死亡 | ✅ | ✅ |
| PlayerRevive | ✨ 角色已复活 | ✅ | ✅ |
| EnemyKilled | ⚔️ 击杀敌人 | ✅ | ✅ |
| TargetSwitched | 🎯 目标切换 | ✅ | ✅ |

**验收标准**:
- 每个事件都触发相应的 Toast 通知
- 收到事件后立即触发轮询（查看控制台网络请求）
- 通知延迟 <1 秒（从事件发生到收到通知）

---

### Test Case 4: 取消订阅测试

**前置条件**: 已完成 Test Case 3

**测试步骤**:
1. 停止当前战斗
2. 观察控制台日志

**预期结果**:
- [ ] 看到日志：`Unsubscribed from battle {BattleId}`
- [ ] 战斗停止后不再收到该战斗的事件

**验收标准**:
- 取消订阅立即完成
- 无取消订阅错误
- 停止后不再接收事件

---

### Test Case 5: 连接重连测试

**测试步骤**:
1. 确认 SignalR 已连接
2. 停止服务端（Ctrl+C）
3. 观察客户端状态
4. 等待 5 秒
5. 重新启动服务端
6. 观察客户端状态

**预期结果**:
- [ ] 服务端停止后，看到 Toast：`⚠️ SignalR 已断开`
- [ ] 看到 Toast：`🔄 SignalR 重连中...`
- [ ] 服务端重启后，看到 Toast：`✅ SignalR 已连接`
- [ ] 连接状态从"已断开"→"重连中"→"已连接"

**验收标准**:
- 自动尝试重连（不需要用户操作）
- 重连成功后功能正常
- 重连延迟符合指数退避策略（1s, 2s, 4s, 8s, 16s）

---

### Test Case 6: 并发战斗测试

**测试步骤**:
1. 创建多个角色（如果支持）
2. 同时启动多个战斗
3. 观察每个战斗的事件通知

**预期结果**:
- [ ] 每个战斗独立订阅
- [ ] 每个战斗的事件正确路由
- [ ] 不会收到其他战斗的事件

**验收标准**:
- 订阅管理正确
- 事件不会混淆
- 性能无明显下降

---

### Test Case 7: 降级策略测试

**测试步骤**:
1. 修改客户端配置，禁用 SignalR：
   ```json
   {
     "SignalR": {
       "EnableSignalR": false
     }
   }
   ```
2. 重新构建并启动应用
3. 启动战斗

**预期结果**:
- [ ] 看到 Toast：`⚠️ 实时通知不可用，使用轮询模式`
- [ ] 战斗功能正常工作
- [ ] 使用纯轮询模式获取状态

**验收标准**:
- SignalR 禁用不影响核心功能
- 轮询正常工作
- 用户体验可接受

---

### Test Case 8: 性能测试

**测试步骤**:
1. 启动长时间战斗（如 300 秒）
2. 记录以下指标：
   - 事件通知延迟
   - 网络请求频率
   - 内存使用
   - CPU 使用

**预期结果**:
- [ ] 事件通知延迟 < 1 秒（P99）
- [ ] 网络请求频率 < 1 次/秒（有 SignalR 时）
- [ ] 内存使用稳定（无内存泄漏）
- [ ] CPU 使用正常

**验收标准**:
- 性能指标符合预期
- 长时间运行稳定
- 无资源泄漏

---

## 📊 性能基准

### 延迟指标

| 指标 | 目标 | 测试方法 |
|------|------|---------|
| 事件通知延迟 (P50) | < 500ms | 记录事件发生时间到收到通知的时间差 |
| 事件通知延迟 (P99) | < 1s | 同上，取 99 分位数 |
| 连接建立时间 | < 5s | 记录登录到连接成功的时间 |
| 重连时间 | < 10s | 记录断开到重连成功的时间 |

### 资源使用

| 指标 | 目标 | 测试方法 |
|------|------|---------|
| 网络带宽 | < 10 KB/s | 使用浏览器 Network 面板监控 |
| 内存使用 | 增长 < 10 MB/小时 | 使用浏览器 Performance 面板监控 |
| CPU 使用 | < 5% | 使用浏览器 Performance 面板监控 |

---

## 🐛 故障排查清单

如果测试失败，按以下顺序检查：

### 1. 连接失败 (401/403)
- [ ] 检查 CORS 配置是否包含 `AllowCredentials()`
- [ ] 检查 JWT Token 是否正确传递
- [ ] 检查 Hub 是否有 `[Authorize]` 属性

### 2. 订阅失败
- [ ] 检查 battleId 是否正确
- [ ] 检查是否已连接
- [ ] 查看服务端日志

### 3. 收不到事件
- [ ] 检查战斗是否真的产生了事件
- [ ] 检查服务端通知配置是否启用
- [ ] 查看浏览器 WebSocket 消息

### 4. 重连失败
- [ ] 检查重连配置
- [ ] 检查 Token 是否过期
- [ ] 查看服务端日志

---

## 📝 测试报告模板

```markdown
# SignalR 测试报告

**测试日期**: YYYY-MM-DD  
**测试人员**: [姓名]  
**环境**: Development/Staging/Production

## 测试结果概览
- 总测试用例: 8
- 通过: [数量]
- 失败: [数量]
- 跳过: [数量]

## 详细测试结果

### Test Case 1: 基础连接测试
- 状态: ✅ 通过 / ❌ 失败
- 连接时间: [X] 秒
- 备注: [如有问题，记录详细信息]

### Test Case 2: 战斗订阅测试
- 状态: ✅ 通过 / ❌ 失败
- 订阅延迟: [X] ms
- 备注: [如有问题，记录详细信息]

[... 其他测试用例 ...]

## 性能指标

| 指标 | 测试值 | 目标值 | 结果 |
|------|--------|--------|------|
| 事件通知延迟 (P99) | [X] ms | < 1000ms | ✅/❌ |
| 连接建立时间 | [X] s | < 5s | ✅/❌ |
| 网络带宽 | [X] KB/s | < 10 KB/s | ✅/❌ |
| 内存增长 | [X] MB/h | < 10 MB/h | ✅/❌ |

## 问题和建议

1. [问题描述]
   - 影响: [高/中/低]
   - 建议: [解决方案]

2. [问题描述]
   - 影响: [高/中/低]
   - 建议: [解决方案]

## 总结

[整体评价和结论]
```

---

## 🔗 相关文档

- [SignalR配置完整指南.md](./SignalR配置完整指南.md) - 配置说明
- [SignalR前端集成方案.md](./SignalR前端集成方案.md) - 集成指南
- [SignalR优化进度更新.md](./SignalR优化进度更新.md) - 进度跟踪

---

**维护者**: GitHub Copilot Agent  
**最后更新**: 2025-10-14
