# BlazorIdle SignalR 实时通知功能验收文档

**项目名称**: BlazorIdle SignalR 集成  
**版本**: 1.0  
**日期**: 2025-10-13  
**状态**: 待验收

---

## 📋 文档概览

本文档定义了 BlazorIdle 项目 SignalR 实时通知功能的验收标准、测试用例和验收流程。

---

## 1. 验收范围

### 1.1 包含的功能模块

| 模块 | 说明 |
|------|------|
| **SignalR 基础架构** | Hub、连接管理、订阅机制 |
| **实时事件通知** | 玩家死亡、怪物击杀、目标切换等 |
| **进度条同步** | SignalR 中断进度条，重新校准 |
| **降级与容错** | 连接失败时降级到轮询 |
| **性能优化** | 通知节流、批量处理 |
| **可观测性** | 日志、指标、监控面板 |

### 1.2 不包含的功能

- 组队副本实时协作（Phase 4 后续实现）
- 离线战斗通知回放（Phase 4 后续实现）
- PvP 对战同步（长期规划）

---

## 2. 验收标准

### 2.1 Phase 1: 基础架构（必须通过）

#### 2.1.1 SignalR 连接管理

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **建立连接** | 1. 启动服务器<br>2. 打开前端页面 | 浏览器控制台显示 "SignalR connected"<br>服务器日志记录新连接 | P0 |
| **订阅战斗** | 1. 开始 Step 战斗<br>2. 检查订阅状态 | 客户端加入 `battle_{id}` 组<br>服务器日志确认订阅成功 | P0 |
| **取消订阅** | 1. 停止战斗<br>2. 检查订阅状态 | 客户端离开 `battle_{id}` 组<br>不再收到该战斗通知 | P1 |
| **断线重连** | 1. 手动关闭 WebSocket<br>2. 等待 5 秒 | 自动重连成功<br>重新订阅之前的战斗 | P0 |
| **多次重连** | 模拟网络抖动（断开 5 次） | 每次都能成功重连<br>重连次数 ≥5 | P1 |
| **连接失败降级** | 1. 禁用 SignalR 服务<br>2. 启动战斗 | 前端显示"SignalR 不可用，使用轮询"<br>功能完全正常 | P0 |

#### 2.1.2 玩家死亡通知

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **触发死亡通知** | 1. 开始战斗<br>2. 等待玩家 HP 降为 0 | 前端收到 `PlayerDeath` 事件<br>延迟 <1s | P0 |
| **前端响应** | 收到死亡通知后 | 1. 立即停止所有进度条<br>2. 显示死亡状态<br>3. 触发立即轮询 | P0 |
| **多次死亡** | 连续触发 3 次玩家死亡 | 每次都能收到通知<br>无重复通知 | P1 |
| **复活通知** | 等待自动复活 | 收到 `PlayerRevive` 事件<br>进度条恢复动画 | P0 |

#### 2.1.3 怪物击杀通知

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **单怪击杀** | 击杀单个怪物 | 收到 `EnemyKilled` 事件<br>延迟 <1s | P0 |
| **多怪击杀** | 连续击杀 5 个怪物 | 每个都收到通知<br>通知顺序正确 | P0 |
| **波次清空** | 击杀一波所有怪物 | 收到最后一个 `EnemyKilled`<br>随后收到 `WaveCleared` | P1 |

#### 2.1.4 目标切换通知

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **主动切换目标** | 当前目标死亡后自动切换 | 收到 `TargetSwitched` 事件<br>包含新目标信息 | P0 |
| **进度条重置** | 目标切换时 | 攻击进度条立即重置到 0%<br>无视觉跳变 | P0 |
| **多次切换** | 快速击杀 3 个怪物 | 收到 3 次 `TargetSwitched`<br>进度条每次都正确重置 | P1 |

---

### 2.2 Phase 2: 进度条同步（重要）

#### 2.2.1 进度条精准模拟

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **基于 NextSignificantEventAt** | 开始战斗，观察进度条 | 进度条速度与 `NextSignificantEventAt` 一致<br>误差 <5% | P0 |
| **SignalR 中断进度** | 怪物死亡触发目标切换 | 进度条立即停止并重置<br>从 0% 开始新目标 | P0 |
| **无视觉跳变** | 目标切换时 | 进度条平滑过渡<br>无闪烁或突然跳跃 | P1 |
| **暂停状态** | 玩家死亡时 | 进度条冻结在当前位置<br>显示暂停图标 | P1 |

#### 2.2.2 详细事件数据传输

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **TargetSwitchedEventDto** | 检查目标切换事件 | 包含：新目标 ID/名称/血量/下次攻击时间 | P0 |
| **PlayerDeathEventDto** | 检查死亡事件 | 包含：死亡时间/复活时间/是否自动复活 | P0 |
| **EnemyKilledEventDto** | 检查击杀事件 | 包含：怪物 ID/击杀时间/过量伤害 | P1 |

#### 2.2.3 UI 反馈增强

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **死亡 Toast 提示** | 玩家死亡时 | 显示红色 Toast："角色死亡，X秒后复活" | P1 |
| **击杀数量更新** | 击杀怪物时 | 实时更新击杀计数<br>无需等待轮询 | P1 |
| **目标切换动画** | 目标切换时 | 播放切换动画（可选）<br>新目标高亮显示 | P2 |

---

### 2.3 Phase 3: 高级功能（可选）

#### 2.3.1 技能与 Buff 通知

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **重要技能通知** | 施放冷却 ≥10s 的技能 | 收到 `SkillCast` 事件<br>前端播放技能动画 | P2 |
| **关键 Buff 通知** | 获得层数 ≥5 的 Buff | 收到 `BuffChanged` 事件<br>Buff 图标立即显示 | P2 |
| **普通技能不通知** | 施放冷却 <5s 的技能 | 不发送 SignalR 通知<br>通过轮询更新 | P2 |

#### 2.3.2 性能优化

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **通知节流** | 连续暴击 10 次 | 每秒最多收到 1 次暴击通知 | P1 |
| **批量通知** | 同时击杀 5 个怪物 | 通知批量发送或合并<br>网络请求 ≤2 次 | P2 |
| **内存稳定性** | 连接 24 小时 | 客户端内存增长 <10MB<br>服务器内存稳定 | P1 |

#### 2.3.3 安全性

| 测试项 | 测试步骤 | 预期结果 | 优先级 |
|-------|---------|---------|--------|
| **未认证用户** | 未登录状态连接 SignalR | 连接被拒绝<br>返回 401 Unauthorized | P0 |
| **跨用户订阅** | 尝试订阅他人的战斗 | 订阅失败<br>返回 403 Forbidden | P0 |
| **注入攻击防护** | 发送恶意 JSON 数据 | 服务器安全处理<br>不会崩溃 | P1 |

---

## 3. 性能验收指标

### 3.1 延迟指标

| 指标 | 目标值 | 测量方法 | 优先级 |
|------|--------|---------|--------|
| **通知延迟 P50** | <300ms | 发送 1000 次通知，计算中位数 | P0 |
| **通知延迟 P95** | <500ms | 发送 1000 次通知，计算 P95 | P0 |
| **通知延迟 P99** | <1s | 发送 1000 次通知，计算 P99 | P1 |
| **端到端延迟** | <1s | 从服务器事件触发到前端 UI 更新 | P0 |

### 3.2 吞吐量指标

| 指标 | 目标值 | 测量方法 | 优先级 |
|------|--------|---------|--------|
| **并发连接数** | ≥1000 | 使用压测工具模拟 | P1 |
| **每秒通知数** | ≥100 | 模拟 100 个战斗同时进行 | P1 |
| **通知丢失率** | <0.1% | 对比发送数与接收数 | P0 |

### 3.3 资源占用指标

| 指标 | 目标值 | 测量方法 | 优先级 |
|------|--------|---------|--------|
| **服务器 CPU** | <10%（1000 连接） | 监控服务器 CPU 使用率 | P1 |
| **服务器内存** | <500MB（1000 连接） | 监控服务器内存占用 | P1 |
| **客户端内存** | <20MB（单个连接） | Chrome DevTools Memory Profiler | P1 |
| **网络带宽** | <1KB/s/连接（空闲时） | 抓包分析 | P2 |

### 3.4 稳定性指标

| 指标 | 目标值 | 测量方法 | 优先级 |
|------|--------|---------|--------|
| **重连成功率** | >95% | 断开连接 100 次，统计成功次数 | P0 |
| **24h 稳定性** | 无崩溃 | 连接 24 小时，监控错误日志 | P1 |
| **平均重连时间** | <5s | 统计多次重连的平均耗时 | P1 |

---

## 4. 测试用例

### 4.1 冒烟测试（Smoke Test）

**目的**: 快速验证核心功能是否正常

**执行步骤**:
1. 启动服务器
2. 打开前端页面，检查 SignalR 连接状态
3. 开始一场 Step 战斗
4. 等待怪物死亡，观察是否收到通知
5. 等待玩家死亡，观察进度条是否停止
6. 停止战斗，检查是否正确清理资源

**通过标准**: 所有步骤无错误，通知延迟 <1s

---

### 4.2 功能测试

#### 测试用例 TC-001: 玩家死亡通知

**前置条件**: 已开始 Step 战斗，SignalR 连接正常

**测试步骤**:
1. 调整角色血量为 10 HP
2. 等待怪物攻击导致死亡
3. 观察前端响应

**预期结果**:
- [ ] 收到 `PlayerDeath` 事件，延迟 <1s
- [ ] 攻击进度条立即停止
- [ ] 显示死亡状态（红色背景或骷髅图标）
- [ ] 显示复活倒计时
- [ ] 控制台无错误日志

---

#### 测试用例 TC-002: 怪物击杀与目标切换

**前置条件**: 开始多怪战斗（≥3 个怪物）

**测试步骤**:
1. 等待第一个怪物死亡
2. 观察前端是否收到 `EnemyKilled` 通知
3. 观察是否收到 `TargetSwitched` 通知
4. 检查进度条是否重置到 0%
5. 重复步骤 1-4 直到所有怪物死亡

**预期结果**:
- [ ] 每次击杀都收到 `EnemyKilled` 事件
- [ ] 每次切换目标都收到 `TargetSwitched` 事件
- [ ] 进度条每次都正确重置
- [ ] 新目标信息立即显示
- [ ] 通知延迟 <1s

---

#### 测试用例 TC-003: SignalR 断线重连

**前置条件**: 战斗进行中，SignalR 已连接

**测试步骤**:
1. 打开浏览器开发者工具 → Network → WS
2. 找到 SignalR WebSocket 连接
3. 右键 → "Close frame"（手动断开）
4. 观察 5 秒内的重连行为
5. 检查是否继续收到战斗通知

**预期结果**:
- [ ] 5 秒内自动重连成功
- [ ] 重连后自动重新订阅战斗
- [ ] 继续收到后续通知
- [ ] 控制台显示 "SignalR reconnected" 日志
- [ ] 用户无明显感知（可选显示"重连中"提示）

---

#### 测试用例 TC-004: 降级到轮询

**前置条件**: SignalR 服务不可用

**测试步骤**:
1. 停止 SignalR Hub 服务（注释 `app.MapHub<BattleNotificationHub>()`）
2. 重启服务器
3. 打开前端页面
4. 开始战斗
5. 观察功能是否正常

**预期结果**:
- [ ] 前端显示"SignalR 不可用"提示（可选）
- [ ] 自动降级到纯轮询模式
- [ ] 所有功能完全正常
- [ ] 战斗状态更新仍然及时（通过轮询）
- [ ] 无 JavaScript 错误

---

#### 测试用例 TC-005: 进度条精准同步

**前置条件**: 开始战斗，获取 `NextSignificantEventAt`

**测试步骤**:
1. 记录 `NextSignificantEventAt` 值（例如 10.5s）
2. 使用秒表计时，观察进度条
3. 在 10.5s 时，检查进度条是否到达 100%
4. 等待怪物死亡触发 `TargetSwitched`
5. 观察进度条是否立即重置

**预期结果**:
- [ ] 进度条到达 100% 的时间与 `NextSignificantEventAt` 误差 <0.5s
- [ ] 收到 `TargetSwitched` 后立即重置到 0%
- [ ] 无视觉跳变或闪烁
- [ ] 新进度条基于新的 `NextSignificantEventAt` 推进

---

### 4.3 性能测试

#### 测试用例 PT-001: 通知延迟测试

**工具**: 自定义延迟测量脚本

**测试步骤**:
1. 服务器端记录通知发送时间戳 T1
2. 客户端记录收到通知时间戳 T2
3. 计算延迟 = T2 - T1
4. 重复 1000 次
5. 统计 P50, P95, P99

**通过标准**:
- P50 <300ms
- P95 <500ms
- P99 <1s

---

#### 测试用例 PT-002: 并发连接压测

**工具**: SignalR Stress Test Tool 或自定义脚本

**测试步骤**:
1. 启动 1000 个客户端连接
2. 每个客户端订阅 1 个战斗
3. 服务器同时向所有战斗发送通知
4. 监控服务器 CPU、内存、网络
5. 检查通知丢失率

**通过标准**:
- 所有连接成功建立
- CPU <10%, 内存 <500MB
- 通知丢失率 <0.1%
- 无服务器崩溃

---

#### 测试用例 PT-003: 长时间稳定性测试

**测试步骤**:
1. 启动 100 个客户端连接
2. 模拟正常战斗流程（击杀/死亡/切换）
3. 持续运行 24 小时
4. 每小时记录一次指标快照
5. 检查内存泄漏和错误日志

**通过标准**:
- 24 小时无崩溃
- 客户端内存增长 <50MB
- 服务器内存增长 <100MB
- 错误日志 <10 条

---

### 4.4 兼容性测试

#### 测试用例 CT-001: 浏览器兼容性

**测试浏览器**:
- Chrome 120+
- Firefox 120+
- Edge 120+
- Safari 17+（macOS/iOS）

**测试步骤**:
1. 在每个浏览器打开前端
2. 执行冒烟测试
3. 检查 SignalR 连接状态
4. 验证通知功能

**通过标准**: 所有浏览器功能完全正常

---

#### 测试用例 CT-002: 移动端测试

**测试设备**:
- Android (Chrome)
- iOS (Safari)

**测试步骤**:
1. 在移动设备打开前端
2. 开始战斗
3. 模拟网络不稳定（开关飞行模式）
4. 观察重连行为

**通过标准**:
- 移动端功能正常
- 网络恢复后自动重连
- 降级到轮询时功能不受影响

---

## 5. 验收流程

### 5.1 验收阶段

```
阶段 1: 开发自测（Dev）
├── 单元测试覆盖率 ≥80%
├── 本地集成测试通过
└── 代码审查完成

阶段 2: QA 测试（QA）
├── 功能测试用例全部通过
├── 性能测试达标
├── 兼容性测试通过
└── Bug 修复完成

阶段 3: UAT 测试（User Acceptance Test）
├── 产品负责人验收核心功能
├── 用户体验符合预期
└── 文档完整

阶段 4: 生产验证（Production）
├── 金丝雀发布（10% 用户）
├── 监控指标正常
└── 全量发布
```

### 5.2 验收检查清单

#### ✅ 代码质量

- [ ] 单元测试覆盖率 ≥80%（新增代码）
- [ ] 集成测试覆盖所有核心场景
- [ ] 代码审查通过（至少 2 人）
- [ ] 无严重代码异味（SonarQube 评级 A）
- [ ] 所有公共 API 有 XML 注释
- [ ] 遵循项目代码规范

#### ✅ 功能完整性

- [ ] Phase 1 所有测试用例通过（P0 & P1）
- [ ] Phase 2 核心测试用例通过（P0）
- [ ] 降级到轮询功能正常
- [ ] 错误处理完整
- [ ] 日志记录规范

#### ✅ 性能指标

- [ ] 通知延迟 P99 <1s
- [ ] 并发连接数 ≥1000
- [ ] 24 小时稳定性测试通过
- [ ] 内存无泄漏
- [ ] 通知丢失率 <0.1%

#### ✅ 文档完整性

- [ ] 设计方案文档完整
- [ ] API 文档自动生成（Swagger）
- [ ] 开发者指南编写完成
- [ ] 故障排查手册验证通过
- [ ] 验收文档本身完整

#### ✅ 运维就绪

- [ ] 监控指标已配置
- [ ] 日志可查询
- [ ] 告警规则已设置
- [ ] 回滚方案已测试
- [ ] 备份恢复流程已验证

---

## 6. 缺陷管理

### 6.1 缺陷严重性定义

| 严重性 | 定义 | 示例 | 响应时间 |
|--------|------|------|---------|
| **P0 - 阻塞** | 核心功能完全不可用 | SignalR 连接失败且无法降级 | 立即修复 |
| **P1 - 严重** | 核心功能部分不可用 | 通知延迟 >5s | 24 小时内修复 |
| **P2 - 一般** | 非核心功能异常 | Toast 提示未显示 | 1 周内修复 |
| **P3 - 轻微** | UI 小问题 | 动画不流畅 | 下个版本修复 |

### 6.2 缺陷接受标准

- **P0 缺陷**: 0 个
- **P1 缺陷**: ≤2 个（需有 workaround）
- **P2 缺陷**: ≤5 个
- **P3 缺陷**: 不限

---

## 7. 验收决策

### 7.1 验收通过条件

**必须满足所有以下条件**:
1. ✅ 所有 P0 测试用例通过
2. ✅ P1 测试用例通过率 ≥95%
3. ✅ 性能指标达标（延迟、吞吐量、稳定性）
4. ✅ P0 缺陷 = 0
5. ✅ P1 缺陷 ≤2 个
6. ✅ 文档完整性检查通过
7. ✅ UAT 测试通过

### 7.2 验收拒绝条件

**满足任一条件即拒绝**:
1. ❌ 存在 P0 缺陷
2. ❌ P0 测试用例通过率 <100%
3. ❌ 性能指标严重不达标（延迟 P99 >2s）
4. ❌ 存在数据丢失或安全漏洞
5. ❌ 无法降级到轮询（可用性风险）

### 7.3 条件性通过

**可以有条件通过，但需补充计划**:
- P1 测试用例通过率 90-95%：需在 1 周内修复
- Phase 2 功能不完整：可延期到下个版本，但 Phase 1 必须完整
- 文档部分缺失：可在上线后 2 周内补充

---

## 8. 签字确认

### 8.1 验收参与方

| 角色 | 姓名 | 职责 | 签名 | 日期 |
|------|------|------|------|------|
| **产品负责人** | - | 确认功能符合需求 | - | - |
| **技术负责人** | - | 确认技术方案合理 | - | - |
| **测试负责人** | - | 确认测试完整 | - | - |
| **开发负责人** | - | 确认代码质量 | - | - |

### 8.2 验收结论

- [ ] ✅ **通过**: 所有条件满足，可以发布
- [ ] ⚠️ **条件通过**: 满足基本条件，需后续补充
- [ ] ❌ **拒绝**: 不满足验收标准，需返工

**附加说明**:  
_（验收结论的详细说明，包括未通过的测试项、缺陷列表、补充计划等）_

---

## 9. 附录

### 9.1 测试环境配置

```yaml
服务器:
  - OS: Ubuntu 22.04 LTS
  - Runtime: .NET 8.0
  - SignalR: ASP.NET Core SignalR 8.0
  - Database: PostgreSQL 15

客户端:
  - Blazor WebAssembly
  - SignalR Client 8.0
  - Browsers: Chrome 120, Firefox 120, Edge 120, Safari 17
```

### 9.2 测试工具

- **压测工具**: SignalR Stress Test / Artillery
- **监控工具**: Application Insights / Prometheus + Grafana
- **日志分析**: Serilog + Seq
- **性能分析**: Chrome DevTools / dotnet-trace
- **自动化测试**: xUnit + Playwright

### 9.3 参考文档

- [SignalR 集成优化方案](./SignalR集成优化方案.md)
- [前端UI优化设计方案](./前端UI优化设计方案.md)
- [轮询机制统一实施总结](./POLLING_UNIFICATION_SUMMARY.md)

---

**文档结束**

_本文档将在验收过程中持续更新，最终版本以签字确认的版本为准。_
