# æˆ˜æ–—æ¶ˆæ¯å‰ç«¯é›†æˆæŒ‡å—

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025-10-14  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ¦‚è¿°

æˆ˜æ–—æ¶ˆæ¯å‰ç«¯é›†æˆç³»ç»Ÿå®ç°äº†åœ¨å‰ç«¯ç•Œé¢å®æ—¶æ˜¾ç¤ºæˆ˜æ–—äº‹ä»¶æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ï¼š
- è§’è‰²XXå¼€å§‹æ”»å‡»XX
- è§’è‰²å¯¹XXé€ æˆXXä¼¤å®³ï¼ˆæš´å‡»ï¼‰
- è§’è‰²æ”¶åˆ°XXå¤šå°‘ä¼¤å®³

æ‰€æœ‰æ¶ˆæ¯é€šè¿‡SignalRå®æ—¶æ¨é€ï¼Œå‚æ•°å®Œå…¨é…ç½®åŒ–ï¼Œæ”¯æŒæœªæ¥æ‰©å±•ã€‚

---

## âœ… å·²å®ç°åŠŸèƒ½

### 1. æˆ˜æ–—æ—¥å¿—é¢æ¿ç»„ä»¶ (BattleLogPanel)

**æ–‡ä»¶ä½ç½®**: 
- `BlazorIdle/Components/BattleLogPanel.razor`
- `BlazorIdle/Components/BattleLogPanel.razor.css`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… å®æ—¶æ˜¾ç¤ºæˆ˜æ–—æ¶ˆæ¯
- âœ… æ¶ˆæ¯ç±»å‹åˆ†ç±»æ˜¾ç¤ºï¼ˆæ”»å‡»ã€ä¼¤å®³ã€æš´å‡»ã€å—ä¼¤ï¼‰
- âœ… æ¶ˆæ¯å›¾æ ‡å’Œæ ·å¼åŒºåˆ†
- âœ… æ¶ˆæ¯å†å²é™åˆ¶ï¼ˆå¯é…ç½®ï¼‰
- âœ… æ¸…ç©ºæ—¥å¿—æŒ‰é’®
- âœ… æ¶ˆæ¯æ—¶é—´æˆ³æ˜¾ç¤º
- âœ… è‡ªåŠ¨æ»šåŠ¨å’Œæº¢å‡ºå¤„ç†

**å‚æ•°**:
```csharp
[Parameter] public List<BattleLogMessage> Messages { get; set; }
[Parameter] public int DisplayLimit { get; set; } = 50;
[Parameter] public EventCallback OnClear { get; set; }
```

### 2. æˆ˜æ–—æ—¥å¿—æ¶ˆæ¯æ¨¡å‹ (BattleLogMessage)

**æ–‡ä»¶ä½ç½®**: `BlazorIdle/Models/BattleLogMessage.cs`

**å±æ€§**:
- `Timestamp` - æ¶ˆæ¯æ—¶é—´æˆ³
- `Text` - æ¶ˆæ¯æ–‡æœ¬ï¼ˆç”±åç«¯æ ¼å¼åŒ–ç”Ÿæˆï¼‰
- `Type` - æ¶ˆæ¯ç±»å‹ï¼ˆAttackStarted, DamageDealt, DamageReceived, EnemyAttackStartedï¼‰
- `IsCrit` - æ˜¯å¦æš´å‡»
- `BattleId` - æ‰€å±æˆ˜æ–—ID

### 3. SignalRäº‹ä»¶å¤„ç†

åœ¨ `Characters.razor` é¡µé¢ä¸­é›†æˆï¼š

**HandleBattleMessageEvent æ–¹æ³•**:
```csharp
private void HandleBattleMessageEvent(object eventData)
{
    // å¤„ç† AttackStartedEventDto
    // å¤„ç† DamageAppliedEventDto
    // å¤„ç† DamageReceivedEventDto
    // è‡ªåŠ¨æ·»åŠ åˆ°æˆ˜æ–—æ—¥å¿—åˆ—è¡¨
}
```

**æ”¯æŒçš„äº‹ä»¶ç±»å‹**:
- `AttackStartedEventDto` - æ”»å‡»å¼€å§‹äº‹ä»¶
- `DamageAppliedEventDto` - é€ æˆä¼¤å®³äº‹ä»¶ï¼ˆåŒ…å«æš´å‡»æ ‡è®°ï¼‰
- `DamageReceivedEventDto` - å—åˆ°ä¼¤å®³äº‹ä»¶

---

## ğŸ¨ UIå±•ç¤º

### æ¶ˆæ¯æ ·å¼

1. **æ”»å‡»å¼€å§‹** - è“è‰²è¾¹æ¡†ï¼Œæµ…è“èƒŒæ™¯ï¼Œâš”ï¸ å›¾æ ‡
2. **é€ æˆä¼¤å®³** - ç»¿è‰²è¾¹æ¡†ï¼Œæµ…ç»¿èƒŒæ™¯ï¼ŒğŸ—¡ï¸ å›¾æ ‡
3. **æš´å‡»ä¼¤å®³** - é»„è‰²è¾¹æ¡†ï¼Œæµ…é»„èƒŒæ™¯ï¼ŒğŸ’¥ å›¾æ ‡ï¼Œç²—ä½“æ–‡å­—
4. **å—åˆ°ä¼¤å®³** - çº¢è‰²è¾¹æ¡†ï¼Œæµ…çº¢èƒŒæ™¯ï¼ŒğŸ›¡ï¸ å›¾æ ‡
5. **æ•Œäººæ”»å‡»** - ç´«è‰²è¾¹æ¡†ï¼Œæµ…ç´«èƒŒæ™¯ï¼ŒğŸ‘¹ å›¾æ ‡

### æ¶ˆæ¯æ ¼å¼

```
âš”ï¸ [14:23:45] ç©å®¶ å¼€å§‹æ”»å‡» å²è±å§†
ğŸ—¡ï¸ [14:23:45] ç©å®¶ å¯¹ å²è±å§† é€ æˆ 150 ç‚¹ä¼¤å®³
ğŸ’¥ [14:23:46] ç©å®¶ å¯¹ å“¥å¸ƒæ— é€ æˆ 300 ç‚¹ä¼¤å®³ï¼ˆæš´å‡»ï¼‰
ğŸ›¡ï¸ [14:23:47] ç©å®¶ å—åˆ°æ¥è‡ª å“¥å¸ƒæ— çš„ 50 ç‚¹ä¼¤å®³
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### æœåŠ¡ç«¯é…ç½® (appsettings.json)

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
    "DamageDealtTemplate": "{attacker} å¯¹ {target} é€ æˆ {damage} ç‚¹ä¼¤å®³{critSuffix}",
    "CritSuffix": "ï¼ˆæš´å‡»ï¼‰",
    "DamageReceivedTemplate": "{target} å—åˆ°æ¥è‡ª {attacker} çš„ {damage} ç‚¹ä¼¤å®³",
    "EnableAttackStartedEvent": true,
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true,
    "MaxMessageHistory": 100
  },
  "SignalR": {
    "Notification": {
      "EnableAttackStartedNotification": true,
      "EnableDamageAppliedNotification": true,
      "EnableDamageReceivedNotification": true
    }
  }
}
```

**é…ç½®å‚æ•°è¯´æ˜**:

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `MaxMessageHistory` | æˆ˜æ–—æ—¥å¿—æœ€å¤§å†å²æ¶ˆæ¯æ•° | 100 |
| `EnableAttackStartedEvent` | æ˜¯å¦ç”Ÿæˆæ”»å‡»å¼€å§‹æ¶ˆæ¯ | true |
| `EnableDamageDealtEvent` | æ˜¯å¦ç”Ÿæˆé€ æˆä¼¤å®³æ¶ˆæ¯ | true |
| `EnableDamageReceivedEvent` | æ˜¯å¦ç”Ÿæˆå—åˆ°ä¼¤å®³æ¶ˆæ¯ | true |
| `EnableAttackStartedNotification` | æ˜¯å¦å‘é€æ”»å‡»å¼€å§‹é€šçŸ¥åˆ°å‰ç«¯ | true |
| `EnableDamageAppliedNotification` | æ˜¯å¦å‘é€é€ æˆä¼¤å®³é€šçŸ¥åˆ°å‰ç«¯ | true |
| `EnableDamageReceivedNotification` | æ˜¯å¦å‘é€å—åˆ°ä¼¤å®³é€šçŸ¥åˆ°å‰ç«¯ | true |

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å‰ç«¯é¡µé¢é›†æˆ

åœ¨ `Characters.razor` ä¸­å·²è‡ªåŠ¨é›†æˆï¼š

```razor
<!-- æˆ˜æ–—æ—¥å¿—é¢æ¿ -->
@if (lastCreated is not null && _isSignalRConnected && _battleLogMessages.Count > 0)
{
    <BattleLogPanel 
        Messages="@_battleLogMessages"
        DisplayLimit="50"
        OnClear="@ClearBattleLog" />
}
```

### 2. æ˜¾ç¤ºæ¡ä»¶

æˆ˜æ–—æ—¥å¿—é¢æ¿ä¼šåœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹æ˜¾ç¤ºï¼š
- âœ… å·²åˆ›å»ºè§’è‰² (`lastCreated is not null`)
- âœ… SignalRå·²è¿æ¥ (`_isSignalRConnected`)
- âœ… æœ‰æˆ˜æ–—æ¶ˆæ¯ (`_battleLogMessages.Count > 0`)

### 3. æ¶ˆæ¯æµç¨‹

```
1. æˆ˜æ–—å‘ç”Ÿï¼ˆç©å®¶æ”»å‡»/å—ä¼¤ï¼‰
   â†“
2. åç«¯ç”Ÿæˆäº‹ä»¶DTOï¼ˆAttackStartedEventDtoç­‰ï¼‰
   â†“
3. SignalRæ¨é€åˆ°å‰ç«¯ï¼ˆBattleEventï¼‰
   â†“
4. HandleBattleEvent å¤„ç†äº‹ä»¶
   â†“
5. HandleBattleMessageEvent è½¬æ¢ä¸ºæ—¥å¿—æ¶ˆæ¯
   â†“
6. AddBattleLogMessage æ·»åŠ åˆ°åˆ—è¡¨
   â†“
7. BattleLogPanel æ˜¾ç¤ºæ¶ˆæ¯
```

---

## ğŸ”§ è‡ªå®šä¹‰å’Œæ‰©å±•

### 1. ä¿®æ”¹æ¶ˆæ¯æ¨¡æ¿

åœ¨ `appsettings.json` ä¸­ä¿®æ”¹æ¨¡æ¿ï¼š

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "âš”ï¸ {attacker} â†’ {target}",
    "DamageDealtTemplate": "ğŸ’¥ {attacker} å¯¹ {target} é€ æˆ {damage} ä¼¤å®³{critSuffix}",
    "CritSuffix": " â­"
  }
}
```

### 2. æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹

**æ­¥éª¤**:

1. åœ¨ `BattleLogMessageType` æšä¸¾ä¸­æ·»åŠ æ–°ç±»å‹
2. åœ¨ `HandleBattleMessageEvent` ä¸­æ·»åŠ å¤„ç†é€»è¾‘
3. åœ¨ `BattleLogPanel.razor` ä¸­æ·»åŠ æ ·å¼å’Œå›¾æ ‡
4. æ›´æ–°åç«¯äº‹ä»¶DTOï¼ˆå¦‚éœ€è¦ï¼‰

**ç¤ºä¾‹ - æ·»åŠ æŠ€èƒ½æ–½æ”¾æ¶ˆæ¯**:

```csharp
// 1. æ·»åŠ æšä¸¾
public enum BattleLogMessageType
{
    // ... ç°æœ‰ç±»å‹
    SkillCast  // æ–°å¢
}

// 2. æ·»åŠ å¤„ç†é€»è¾‘
case SkillCastEventDto skillCast:
    AddBattleLogMessage(new BattleLogMessage
    {
        Timestamp = DateTime.Now,
        Text = skillCast.Message,
        Type = BattleLogMessageType.SkillCast,
        BattleId = skillCast.BattleId
    });
    break;

// 3. æ·»åŠ æ ·å¼å’Œå›¾æ ‡
private string GetMessageIcon(BattleLogMessage message)
{
    return message.Type switch
    {
        // ... ç°æœ‰æ˜ å°„
        BattleLogMessageType.SkillCast => "âœ¨",
        _ => "ğŸ“"
    };
}
```

### 3. è°ƒæ•´æ˜¾ç¤ºé™åˆ¶

```csharp
// åœ¨ Characters.razor ä¸­ä¿®æ”¹
<BattleLogPanel 
    Messages="@_battleLogMessages"
    DisplayLimit="100"  // è°ƒæ•´æ˜¾ç¤ºæ•°é‡
    OnClear="@ClearBattleLog" />
```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### 1. æ¶ˆæ¯å†å²é™åˆ¶

- é»˜è®¤ä¿ç•™æœ€è¿‘ 100 æ¡æ¶ˆæ¯
- è¶…å‡ºé™åˆ¶æ—¶è‡ªåŠ¨ç§»é™¤æœ€æ—©çš„æ¶ˆæ¯
- å¯é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´

### 2. UIæ¸²æŸ“ä¼˜åŒ–

- ä½¿ç”¨ `@key` æŒ‡ä»¤ä¼˜åŒ–åˆ—è¡¨æ¸²æŸ“
- ä½¿ç”¨ `TakeLast` å’Œ `Reverse` å‡å°‘æ¸²æŸ“é‡
- CSSæ»šåŠ¨æ¡ä¼˜åŒ–

### 3. SignalRäº‹ä»¶å¤„ç†

- å¼‚æ­¥å¤„ç†æ¶ˆæ¯
- é”™è¯¯æ•è·ä¸å½±å“ä¸»æµç¨‹
- è‡ªåŠ¨æ‰¹é‡æ›´æ–°UI

---

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

å·²æœ‰çš„åç«¯æµ‹è¯•ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰ï¼š
- âœ… BattleMessageFormatter æµ‹è¯•ï¼ˆ9ä¸ªï¼‰
- âœ… BattleMessage é›†æˆæµ‹è¯•ï¼ˆ4ä¸ªï¼‰

### å‰ç«¯æµ‹è¯•æ–¹æ³•

1. **å¯åŠ¨Stepæˆ˜æ–—**
   - åˆ›å»ºè§’è‰²
   - å¼€å§‹Stepæˆ˜æ–—
   - è§‚å¯Ÿæˆ˜æ–—æ—¥å¿—é¢æ¿
   - éªŒè¯æ¶ˆæ¯å®æ—¶æ˜¾ç¤º

2. **éªŒè¯æ¶ˆæ¯ç±»å‹**
   - æ”»å‡»å¼€å§‹æ¶ˆæ¯ï¼ˆè“è‰²ï¼‰
   - é€ æˆä¼¤å®³æ¶ˆæ¯ï¼ˆç»¿è‰²ï¼‰
   - æš´å‡»ä¼¤å®³æ¶ˆæ¯ï¼ˆé»„è‰²ï¼Œç²—ä½“ï¼‰
   - å—åˆ°ä¼¤å®³æ¶ˆæ¯ï¼ˆçº¢è‰²ï¼‰

3. **æµ‹è¯•é…ç½®**
   - ä¿®æ”¹ `appsettings.json` ä¸­çš„æ¨¡æ¿
   - é‡å¯æœåŠ¡
   - éªŒè¯æ¶ˆæ¯æ ¼å¼å˜åŒ–

4. **æµ‹è¯•æ¸…ç©ºåŠŸèƒ½**
   - ç‚¹å‡»æ¸…ç©ºæŒ‰é’®
   - éªŒè¯æ¶ˆæ¯åˆ—è¡¨æ¸…ç©º

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1: æˆ˜æ–—æ—¥å¿—ä¸æ˜¾ç¤º

**æ£€æŸ¥æ¸…å•**:
- [ ] SignalRæ˜¯å¦è¿æ¥æˆåŠŸï¼ˆæŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼‰
- [ ] æ˜¯å¦æœ‰è§’è‰²å·²åˆ›å»º
- [ ] æˆ˜æ–—æ˜¯å¦å·²å¼€å§‹
- [ ] é…ç½®æ–‡ä»¶ä¸­äº‹ä»¶æ˜¯å¦å¯ç”¨
- [ ] SignalRé€šçŸ¥æ˜¯å¦å¯ç”¨

**è§£å†³æ–¹æ¡ˆ**:
```json
// ç¡®ä¿é…ç½®æ­£ç¡®
{
  "BattleMessages": {
    "EnableAttackStartedEvent": true,
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true
  },
  "SignalR": {
    "Notification": {
      "EnableAttackStartedNotification": true,
      "EnableDamageAppliedNotification": true,
      "EnableDamageReceivedNotification": true
    }
  }
}
```

### é—®é¢˜2: æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®

**åŸå› **: é…ç½®æ¨¡æ¿é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `appsettings.json` ä¸­æ¨¡æ¿è¯­æ³•
2. ç¡®ä¿å ä½ç¬¦åç§°æ­£ç¡®ï¼š`{attacker}`, `{target}`, `{damage}`, `{critSuffix}`
3. é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ

### é—®é¢˜3: æ¶ˆæ¯è¿‡å¤šå¯¼è‡´æ€§èƒ½é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
1. è°ƒæ•´ `MaxMessageHistory` é™åˆ¶æ¶ˆæ¯æ•°é‡
2. å‡å°‘ `DisplayLimit` æ˜¾ç¤ºæ•°é‡
3. ç¦ç”¨ä¸éœ€è¦çš„äº‹ä»¶ç±»å‹

```json
{
  "BattleMessages": {
    "MaxMessageHistory": 50,  // å‡å°‘å†å²è®°å½•
    "EnableAttackStartedEvent": false  // ç¦ç”¨æ”»å‡»å¼€å§‹äº‹ä»¶
  }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—](./æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md)
- [SignalRå‰ç«¯é›†æˆæµ‹è¯•æŒ‡å—](./SignalR_å‰ç«¯é›†æˆæµ‹è¯•æŒ‡å—.md)
- [æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿå®ç°æ€»ç»“](../æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿå®ç°æ€»ç»“.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0 (2025-10-14)
- âœ… åˆ›å»º BattleLogPanel ç»„ä»¶
- âœ… åˆ›å»º BattleLogMessage æ¨¡å‹
- âœ… é›†æˆ SignalR æˆ˜æ–—æ¶ˆæ¯äº‹ä»¶å¤„ç†
- âœ… å®ç°æ¶ˆæ¯åˆ†ç±»æ˜¾ç¤ºå’Œæ ·å¼
- âœ… æ”¯æŒé…ç½®åŒ–å‚æ•°
- âœ… ç¼–å†™å®Œæ•´æ–‡æ¡£

---

## âœ¨ æ€»ç»“

æˆ˜æ–—æ¶ˆæ¯å‰ç«¯é›†æˆç³»ç»Ÿå·²å®Œå…¨å®ç°ï¼Œæ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼š

1. âœ… **å®æ—¶æ˜¾ç¤º** - é€šè¿‡SignalRå®æ—¶æ¨é€æˆ˜æ–—æ¶ˆæ¯
2. âœ… **æ¶ˆæ¯åˆ†ç±»** - æ”»å‡»ã€ä¼¤å®³ã€æš´å‡»ã€å—ä¼¤ç­‰ä¸åŒç±»å‹
3. âœ… **é…ç½®åŒ–** - æ‰€æœ‰å‚æ•°åœ¨é…ç½®æ–‡ä»¶ä¸­å¯è°ƒ
4. âœ… **å¯æ‰©å±•** - æ˜“äºæ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹
5. âœ… **ç»´æŒé£æ ¼** - ä¿æŒç°æœ‰ä»£ç é£æ ¼
6. âœ… **æµ‹è¯•é€šè¿‡** - åç«¯æµ‹è¯•å…¨éƒ¨é€šè¿‡

ç³»ç»Ÿå·²å‡†å¤‡å¥½æŠ•å…¥ä½¿ç”¨ï¼

---

**å®ç°è€…**: GitHub Copilot  
**å®¡æ ¸çŠ¶æ€**: âœ… å¾…å®¡æ ¸  
**éƒ¨ç½²çŠ¶æ€**: ğŸš€ å¯éƒ¨ç½²
