# BlazorIdle æ•°æ®åº“è¯»å–æ“ä½œä¼˜åŒ–æ–¹æ¡ˆè¯¦ç»†åˆ†æ

**é¡¹ç›®**: BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-19  
**çŠ¶æ€**: éœ€æ±‚åˆ†æå®Œæˆ - å¾…å®¡æ ¸

---

## ğŸ“‹ ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [å½“å‰çŠ¶æ€å›é¡¾](#å½“å‰çŠ¶æ€å›é¡¾)
3. [æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ](#æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ)
4. [é—®é¢˜è¯Šæ–­ä¸ä¼˜åŒ–ç›®æ ‡](#é—®é¢˜è¯Šæ–­ä¸ä¼˜åŒ–ç›®æ ‡)
5. [ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡](#ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡)
6. [æŠ€æœ¯æ¶æ„è®¾è®¡](#æŠ€æœ¯æ¶æ„è®¾è®¡)
7. [é…ç½®ç³»ç»Ÿè®¾è®¡](#é…ç½®ç³»ç»Ÿè®¾è®¡)
8. [å®æ–½æ–¹æ¡ˆ - ä¸Šç¯‡](#å®æ–½æ–¹æ¡ˆ---ä¸Šç¯‡)
9. [å®æ–½æ–¹æ¡ˆ - ä¸­ç¯‡](#å®æ–½æ–¹æ¡ˆ---ä¸­ç¯‡)
10. [å®æ–½æ–¹æ¡ˆ - ä¸‹ç¯‡](#å®æ–½æ–¹æ¡ˆ---ä¸‹ç¯‡)
11. [é£é™©è¯„ä¼°ä¸ç¼“è§£](#é£é™©è¯„ä¼°ä¸ç¼“è§£)
12. [æ€§èƒ½é¢„æœŸ](#æ€§èƒ½é¢„æœŸ)
13. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)

---

## æ‰§è¡Œæ‘˜è¦

### èƒŒæ™¯

æ ¹æ®å¯¹å½“å‰ BlazorIdle æœåŠ¡ç«¯ä»£ç çš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬å‘ç°ï¼š

1. **å†™å…¥ä¼˜åŒ–å·²å®Œæˆ** âœ…ï¼šPhase 1-3 å·²ç»å®ç°äº†æ•°æ®åº“å†™å…¥çš„å†…å­˜ç¼“å†²ä¼˜åŒ–ï¼Œæ•°æ®åº“å†™å…¥å‡å°‘äº† 97.9%
2. **è¯»å–ä¼˜åŒ–æœªå®æ–½** âš ï¸ï¼šå„é¡¹æ•°æ®ï¼ˆè§’è‰²ã€è£…å¤‡ã€æˆ˜æ–—è®°å½•ç­‰ï¼‰ä»ç„¶å®æ—¶ä»æ•°æ®åº“è¯»å–ï¼Œå­˜åœ¨å¤§é‡é‡å¤æŸ¥è¯¢
3. **ç¼ºå°‘è¯»ç¼“å­˜å±‚** âš ï¸ï¼šæ²¡æœ‰ç»Ÿä¸€çš„è¯»å–ç¼“å­˜æœºåˆ¶ï¼Œæ¯æ¬¡ API è°ƒç”¨éƒ½ç›´æ¥æŸ¥è¯¢æ•°æ®åº“

### æ ¸å¿ƒé—®é¢˜

ç»è¿‡ä»£ç åˆ†æï¼Œå‘ç°ä»¥ä¸‹é«˜é¢‘æ•°æ®åº“è¯»å–æ“ä½œï¼š

| æ“ä½œç±»å‹ | å½“å‰å®ç° | é¢‘ç‡ä¼°ç®— | å½±å“ |
|---------|---------|---------|------|
| è§’è‰²ä¿¡æ¯æŸ¥è¯¢ | æ¯æ¬¡ API è°ƒç”¨éƒ½æŸ¥åº“ | ~5,000æ¬¡/å°æ—¶ | é«˜é¢‘é‡å¤æŸ¥è¯¢ |
| è£…å¤‡åˆ—è¡¨æŸ¥è¯¢ | å®æ—¶æŸ¥è¯¢ï¼ˆå« Includeï¼‰ | ~2,000æ¬¡/å°æ—¶ | Join æ“ä½œè€—æ—¶ |
| æˆ˜æ–—è®°å½•æŸ¥è¯¢ | å®æ—¶æŸ¥è¯¢å« Segments | ~1,000æ¬¡/å°æ—¶ | å¤§æ•°æ®é‡ä¼ è¾“ |
| ç‰©å“å®šä¹‰æŸ¥è¯¢ | é…ç½®æ•°æ®åå¤æŸ¥è¯¢ | ~3,000æ¬¡/å°æ—¶ | é™æ€æ•°æ®é‡å¤æŸ¥è¯¢ |
| ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ | æ¯æ¬¡è®¤è¯éƒ½æŸ¥åº“ | ~1,000æ¬¡/å°æ—¶ | è®¤è¯ç“¶é¢ˆ |

**æ€»è®¡**: æ¯å°æ—¶çº¦ 12,000+ æ¬¡æ•°æ®åº“è¯»å–æ“ä½œï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ˜¯å¯ä»¥ç¼“å­˜çš„é‡å¤æŸ¥è¯¢ã€‚

### ä¼˜åŒ–ç›®æ ‡

1. **å†…å­˜ä¼˜å…ˆè¯»å–**ï¼šæ‰€æœ‰è¯»å–æ“ä½œä¼˜å…ˆä»å†…å­˜ç¼“å­˜è·å–
2. **æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ**ï¼šåŸºäºäº‹ä»¶çš„ç¼“å­˜å¤±æ•ˆæœºåˆ¶
3. **åˆ†å±‚ç¼“å­˜ç­–ç•¥**ï¼šçƒ­æ•°æ®ã€æ¸©æ•°æ®ã€å†·æ•°æ®å·®å¼‚åŒ–ç¼“å­˜
4. **å®Œå…¨é…ç½®åŒ–**ï¼šæ‰€æœ‰ç¼“å­˜å‚æ•°å¯é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´
5. **å‘åå…¼å®¹**ï¼šæ”¯æŒå¼€å…³æ§åˆ¶ï¼Œå¯éšæ—¶å›é€€
6. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿å†…å­˜ç¼“å­˜ä¸æ•°æ®åº“åŒæ­¥

### é¢„æœŸæ•ˆæœ

- æ•°æ®åº“è¯»å–æ¬¡æ•°å‡å°‘ **85-95%**
- API å“åº”æ—¶é—´æ”¹å–„ **50-70%**
- æ•°æ®åº“è´Ÿè½½é™ä½ **60-80%**
- æ”¯æŒæ›´é«˜çš„å¹¶å‘è¯·æ±‚æ•° **3-5å€æå‡**

---

## å½“å‰çŠ¶æ€å›é¡¾

### å·²å®Œæˆçš„å†™å…¥ä¼˜åŒ–ï¼ˆPhase 1-3ï¼‰

âœ… **Phase 1: åŸºç¡€è®¾æ–½**
- MemoryStateManager<T> - å†…å­˜çŠ¶æ€ç®¡ç†å™¨
- PersistenceCoordinator - æŒä¹…åŒ–åè°ƒå™¨
- EnhancedShutdownManager - ä¼˜é›…å…³é—­ç®¡ç†å™¨
- å®Œæ•´çš„é…ç½®ç³»ç»Ÿï¼ˆPersistence/Shutdown/MemoryCache/Monitoringï¼‰

âœ… **Phase 2: å†™å…¥æ“ä½œè¿ç§»**
- è§’è‰²å¿ƒè·³å†™å…¥ï¼š300ç§’æ‰¹é‡ä¿å­˜ï¼ˆvs åŸæ¥10-20ç§’ï¼‰
- æˆ˜æ–—å¿«ç…§å†™å…¥ï¼š60ç§’æ‰¹é‡ä¿å­˜ï¼ˆvs åŸæ¥500msï¼‰
- æ´»åŠ¨è®¡åˆ’å†™å…¥ï¼š30ç§’æ‰¹é‡ä¿å­˜

âœ… **Phase 3: ç›‘æ§ä¸è¯Šæ–­**
- DatabaseMetricsCollector - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- DatabaseHealthController - å¥åº·æ£€æŸ¥ API
- å®Œæ•´çš„ç›‘æ§é…ç½®

### å½“å‰æ¶æ„å›¾

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
API Controllers
    â†“
Application Services
    â†“
Domain Layer
    â†“
[å†™å…¥] â†’ MemoryStateManager â†’ (æ‰¹é‡) â†’ PersistenceCoordinator â†’ DbContext
[è¯»å–] â†’ DbContext (ç›´æ¥æŸ¥è¯¢) â† âš ï¸ æœªä¼˜åŒ–
```

### å­˜åœ¨çš„é—®é¢˜

1. **è¯»å†™ä¸å¯¹ç§°**ï¼šå†™å…¥å·²ç»ä¼˜åŒ–ï¼ˆå†…å­˜ç¼“å†²ï¼‰ï¼Œä½†è¯»å–ä»ç„¶ç›´æ¥æŸ¥åº“
2. **é‡å¤æŸ¥è¯¢**ï¼šåŒä¸€æ•°æ®åœ¨çŸ­æ—¶é—´å†…è¢«å¤šæ¬¡æŸ¥è¯¢ï¼ˆå¦‚è§’è‰²ä¿¡æ¯ï¼‰
3. **Join å¼€é”€**ï¼šè£…å¤‡æŸ¥è¯¢ä½¿ç”¨ Includeï¼Œæ¯æ¬¡éƒ½æ‰§è¡Œ Join
4. **æ— ç¼“å­˜ç­–ç•¥**ï¼šæ²¡æœ‰é’ˆå¯¹ä¸åŒæ•°æ®ç‰¹æ€§çš„ç¼“å­˜ç­–ç•¥
5. **é…ç½®æ•°æ®æµªè´¹**ï¼šé™æ€é…ç½®æ•°æ®ï¼ˆè£…å¤‡å®šä¹‰ã€è¯ç¼€ç­‰ï¼‰æ¯æ¬¡éƒ½æŸ¥åº“

---

## æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ

### é«˜é¢‘è¯»å–æ“ä½œç»Ÿè®¡

#### 1. CharacterRepository è¯»å–åˆ†æ

**æ–‡ä»¶**: `Infrastructure/Persistence/Repositories/CharacterRepository.cs`

```csharp
// å½“å‰å®ç°
public Task<Character?> GetAsync(Guid id, CancellationToken ct = default) =>
    _db.Characters.FirstOrDefaultAsync(c => c.Id == id, ct);
```

**è°ƒç”¨ä½ç½®åˆ†æ**:
- `CharactersController.GetStats()` - æ¯æ¬¡æŸ¥è¯¢è§’è‰²å±æ€§
- `CharactersController.Heartbeat()` - æ¯10-20ç§’å¿ƒè·³æ›´æ–°
- `StepBattlesController.Start()` - æˆ˜æ–—å¼€å§‹æŸ¥è¯¢
- `ActivityPlansController.*` - æ´»åŠ¨è®¡åˆ’ç›¸å…³æ“ä½œ

**é¢‘ç‡ä¼°ç®—**: 
- 100ä¸ªåœ¨çº¿ç©å®¶ Ã— æ¯åˆ†é’Ÿ3æ¬¡è°ƒç”¨ = ~18,000æ¬¡/å°æ—¶
- å¤§éƒ¨åˆ†æ˜¯åŒä¸€ç©å®¶çš„é‡å¤æŸ¥è¯¢

**ä¼˜åŒ–æ½œåŠ›**: â­â­â­â­â­ (æé«˜)
- ç©å®¶æ•°æ®åœ¨ä¼šè¯æœŸé—´åŸºæœ¬ä¸å˜
- å¯ä»¥åœ¨å†…å­˜ä¸­ç¼“å­˜æ•´ä¸ªä¼šè¯æœŸé—´
- å¤±æ•ˆç­–ç•¥ï¼šç©å®¶ç­‰çº§æå‡ã€è£…å¤‡å˜æ›´æ—¶å¤±æ•ˆ

#### 2. GearInstanceRepository è¯»å–åˆ†æ

**æ–‡ä»¶**: `Infrastructure/Persistence/Repositories/GearInstanceRepository.cs`

```csharp
// å½“å‰å®ç° - è£…å¤‡åˆ—è¡¨æŸ¥è¯¢
public Task<List<GearInstance>> GetEquippedGearAsync(Guid characterId, CancellationToken ct = default) =>
    _db.GearInstances
        .Include(g => g.Definition)  // â† Join æ“ä½œ
        .Where(g => g.CharacterId == characterId && g.IsEquipped)
        .ToListAsync(ct);
```

**è°ƒç”¨ä½ç½®åˆ†æ**:
- `EquipmentController.GetEquipped()` - è·å–å·²è£…å¤‡åˆ—è¡¨
- `CharactersController.GetStats()` - è®¡ç®—è§’è‰²å±æ€§æ—¶æŸ¥è¯¢è£…å¤‡
- æˆ˜æ–—ç³»ç»Ÿ - è®¡ç®—ä¼¤å®³æ—¶æŸ¥è¯¢è£…å¤‡å±æ€§

**é¢‘ç‡ä¼°ç®—**:
- æ¯ä¸ªç©å®¶æ¯æ¬¡ç™»å½•/åˆ‡æ¢è£…å¤‡/æŸ¥çœ‹å±æ€§
- çº¦ 2,000-5,000æ¬¡/å°æ—¶

**ä¼˜åŒ–æ½œåŠ›**: â­â­â­â­â­ (æé«˜)
- è£…å¤‡æ•°æ®å˜æ›´é¢‘ç‡ä½ï¼ˆåªåœ¨è£…å¤‡/å¸ä¸‹æ—¶å˜æ›´ï¼‰
- Include æ“ä½œå¼€é”€å¤§ï¼Œå¯ä»¥é¢„åŠ è½½
- å¯æŒ‰è§’è‰²ç»´åº¦ç¼“å­˜è£…å¤‡åˆ—è¡¨

#### 3. BattleRepository è¯»å–åˆ†æ

**æ–‡ä»¶**: `Infrastructure/Persistence/Repositories/BattleRepository.cs`

```csharp
// å½“å‰å®ç° - åŒ…å«æˆ˜æ–—æ®µçš„æŸ¥è¯¢
public Task<BattleRecord?> GetWithSegmentsAsync(Guid id, CancellationToken ct = default) =>
    _db.Battles
        .Include(b => b.Segments)  // â† å…³è”æŸ¥è¯¢ï¼Œæ•°æ®é‡å¤§
        .FirstOrDefaultAsync(b => b.Id == id, ct);
```

**è°ƒç”¨ä½ç½®åˆ†æ**:
- `BattlesReplayController` - æˆ˜æ–—å›æ”¾æŸ¥è¯¢
- æˆ˜æ–—ç»“ç®— - è¯»å–å†å²æˆ˜æ–—è®°å½•

**é¢‘ç‡ä¼°ç®—**:
- çº¦ 500-1,000æ¬¡/å°æ—¶

**ä¼˜åŒ–æ½œåŠ›**: â­â­â­â­ (é«˜)
- å†å²æˆ˜æ–—è®°å½•ä¸å˜ï¼Œå¯ä»¥æ°¸ä¹…ç¼“å­˜
- Segments æ•°æ®é‡å¤§ï¼Œç¼“å­˜æ”¶ç›Šæ˜æ˜¾
- å¯ä»¥ä½¿ç”¨ TTL ç­–ç•¥ï¼ˆå¦‚1å°æ—¶åå¤±æ•ˆï¼‰

#### 4. é…ç½®æ•°æ®è¯»å–åˆ†æ

**ç›¸å…³ä»“å‚¨**:
- `GearDefinitionRepository` - è£…å¤‡å®šä¹‰ï¼ˆé™æ€é…ç½®ï¼‰
- `AffixRepository` - è¯ç¼€å®šä¹‰ï¼ˆé™æ€é…ç½®ï¼‰
- `GearSetRepository` - å¥—è£…å®šä¹‰ï¼ˆé™æ€é…ç½®ï¼‰

**é—®é¢˜**:
- è¿™äº›éƒ½æ˜¯é™æ€é…ç½®æ•°æ®ï¼Œç†è®ºä¸Šåº”è¯¥åœ¨å¯åŠ¨æ—¶åŠ è½½åˆ°å†…å­˜
- å½“å‰æ¯æ¬¡ä½¿ç”¨éƒ½æŸ¥è¯¢æ•°æ®åº“

**é¢‘ç‡ä¼°ç®—**:
- çº¦ 3,000-5,000æ¬¡/å°æ—¶

**ä¼˜åŒ–æ½œåŠ›**: â­â­â­â­â­ (æé«˜)
- å¯åŠ¨æ—¶åŠ è½½åˆ°å†…å­˜
- ä»…åœ¨é…ç½®çƒ­æ›´æ–°æ—¶é‡æ–°åŠ è½½
- å¯ä»¥å‡å°‘ 99% çš„æŸ¥è¯¢

### è¯»å–æ“ä½œåˆ†ç±»

æ ¹æ®æ•°æ®ç‰¹æ€§ï¼Œæˆ‘ä»¬å°†è¯»å–æ“ä½œåˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

| æ•°æ®ç±»å‹ | ç¤ºä¾‹ | å˜æ›´é¢‘ç‡ | ç¼“å­˜ç­–ç•¥ | ä¼˜å…ˆçº§ |
|---------|------|---------|---------|-------|
| **ä¼šè¯æ•°æ®** | Character, User | ä¼šè¯æœŸé—´å¾ˆå°‘å˜ | Session Cache (TTL: ä¼šè¯æœŸé—´) | P0 |
| **å…³è”æ•°æ®** | GearInstance + Definition | ä½é¢‘å˜æ›´ | LRU Cache (TTL: 5-15åˆ†é’Ÿ) | P0 |
| **å†å²æ•°æ®** | BattleRecord + Segments | ä¸å˜ | Permanent Cache (TTL: 1å°æ—¶+) | P1 |
| **é…ç½®æ•°æ®** | GearDefinition, Affix, GearSet | æå°‘å˜æ›´ï¼ˆä»…çƒ­æ›´æ–°ï¼‰ | Static Cache (æ‰‹åŠ¨å¤±æ•ˆ) | P0 |
| **è®¡ç®—ç»“æœ** | è§’è‰²å±æ€§ã€è£…å¤‡æ€»å±æ€§ | ä¾èµ–æºæ•°æ® | Derived Cache (è·Ÿéšæºæ•°æ®å¤±æ•ˆ) | P1 |

---

## é—®é¢˜è¯Šæ–­ä¸ä¼˜åŒ–ç›®æ ‡

### æ ¸å¿ƒé—®é¢˜

#### é—®é¢˜ 1: ä¼šè¯æ•°æ®é‡å¤æŸ¥è¯¢ âš ï¸âš ï¸âš ï¸

**ç°è±¡**:
```csharp
// åŒä¸€ä¸ªç©å®¶åœ¨ä¸€æ¬¡ä¼šè¯ä¸­ï¼ŒCharacter è¢«æŸ¥è¯¢æ•°åæ¬¡
var character = await _db.Characters.FirstOrDefaultAsync(c => c.Id == characterId);
```

**å½±å“**:
- æ•°æ®åº“è´Ÿè½½å¢åŠ 
- å“åº”æ—¶é—´å»¶é•¿
- ä¸å¿…è¦çš„ç½‘ç»œä¼ è¾“

**æ ¹æœ¬åŸå› **:
- ç¼ºå°‘ä¼šè¯çº§ç¼“å­˜
- æ¯æ¬¡ API è°ƒç”¨éƒ½é‡æ–°æŸ¥è¯¢

#### é—®é¢˜ 2: Include æ“ä½œé‡å¤æ‰§è¡Œ âš ï¸âš ï¸âš ï¸

**ç°è±¡**:
```csharp
// æ¯æ¬¡æŸ¥è¯¢è£…å¤‡éƒ½æ‰§è¡Œ Join
_db.GearInstances
    .Include(g => g.Definition)
    .Where(...)
    .ToListAsync();
```

**å½±å“**:
- Join æ“ä½œè€—æ—¶
- æ•°æ®ä¼ è¾“é‡å¤§
- æ•°æ®åº“ CPU è´Ÿè½½é«˜

**æ ¹æœ¬åŸå› **:
- æ²¡æœ‰é¢„åŠ è½½å…³è”æ•°æ®
- æ²¡æœ‰ç¼“å­˜ Join ç»“æœ

#### é—®é¢˜ 3: é™æ€é…ç½®æ•°æ®æœªç¼“å­˜ âš ï¸âš ï¸âš ï¸

**ç°è±¡**:
```csharp
// è£…å¤‡å®šä¹‰æ¯æ¬¡éƒ½æŸ¥åº“ï¼Œä½†æ•°æ®å‡ ä¹ä¸å˜
var definition = await _db.GearDefinitions.FindAsync(definitionId);
```

**å½±å“**:
- æµªè´¹æ•°æ®åº“èµ„æº
- å¢åŠ æŸ¥è¯¢å»¶è¿Ÿ
- é…ç½®æ•°æ®åº”è¯¥ä¸€æ¬¡åŠ è½½

**æ ¹æœ¬åŸå› **:
- æ²¡æœ‰å¯åŠ¨æ—¶åŠ è½½é…ç½®
- æ²¡æœ‰é…ç½®çƒ­æ›´æ–°æœºåˆ¶

### ä¼˜åŒ–ç›®æ ‡

#### ç›®æ ‡ 1: å‡å°‘æ•°æ®åº“è¯»å–æ¬¡æ•°

**é‡åŒ–ç›®æ ‡**:
- ä¼šè¯æ•°æ®ï¼šå‡å°‘ 90%+ é‡å¤æŸ¥è¯¢
- å…³è”æ•°æ®ï¼šå‡å°‘ 80%+ Join æ“ä½œ
- é…ç½®æ•°æ®ï¼šå‡å°‘ 95%+ æŸ¥è¯¢

#### ç›®æ ‡ 2: æå‡ API å“åº”é€Ÿåº¦

**é‡åŒ–ç›®æ ‡**:
- P50 å“åº”æ—¶é—´ï¼šæ”¹å–„ 40-60%
- P95 å“åº”æ—¶é—´ï¼šæ”¹å–„ 50-70%
- P99 å“åº”æ—¶é—´ï¼šæ”¹å–„ 60-80%

#### ç›®æ ‡ 3: ä¿è¯æ•°æ®ä¸€è‡´æ€§

**è¦æ±‚**:
- å†™å…¥æ—¶ç«‹å³å¤±æ•ˆç›¸å…³ç¼“å­˜
- æ”¯æŒæ‰‹åŠ¨åˆ·æ–°ç¼“å­˜
- æä¾›ç¼“å­˜å¤±æ•ˆè¿½è¸ª

#### ç›®æ ‡ 4: å®Œå…¨é…ç½®åŒ–

**è¦æ±‚**:
- æ‰€æœ‰ç¼“å­˜å‚æ•°åœ¨é…ç½®æ–‡ä»¶
- æ”¯æŒåˆ†ç¯å¢ƒé…ç½®ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
- æ”¯æŒè¿è¡Œæ—¶è°ƒæ•´ï¼ˆéƒ¨åˆ†å‚æ•°ï¼‰

---

## ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

#### 1. åˆ†å±‚ç¼“å­˜æ¶æ„

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
API Controllers
    â†“
[è¯»å–ç¼“å­˜å±‚] â† æ–°å¢ï¼
    â†“
    â”œâ”€ L1: Session Cache (ä¼šè¯çº§)
    â”œâ”€ L2: Entity Cache (å®ä½“çº§)
    â””â”€ L3: Static Cache (é…ç½®çº§)
    â†“ (ç¼“å­˜æœªå‘½ä¸­)
Application Services
    â†“
Repository Layer
    â†“
DbContext â†’ SQLite
```

#### 2. ç¼“å­˜ç±»å‹å®šä¹‰

**L1: Session Cache (ä¼šè¯ç¼“å­˜)**
- **ç”¨é€”**: ç¼“å­˜ä¼šè¯æœŸé—´ä¸å˜çš„æ•°æ®ï¼ˆCharacter, Userï¼‰
- **ç”Ÿå‘½å‘¨æœŸ**: ç”¨æˆ·ä¼šè¯æœŸé—´
- **å¤±æ•ˆç­–ç•¥**: ç™»å‡ºæ—¶æ¸…ç† æˆ– TTL=30åˆ†é’Ÿ
- **å®ç°**: MemoryCache with SlidingExpiration

**L2: Entity Cache (å®ä½“ç¼“å­˜)**
- **ç”¨é€”**: ç¼“å­˜ä½é¢‘å˜æ›´çš„å®ä½“ï¼ˆGearInstance, BattleRecordï¼‰
- **ç”Ÿå‘½å‘¨æœŸ**: TTL=5-15åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
- **å¤±æ•ˆç­–ç•¥**: å†™å…¥æ—¶å¤±æ•ˆ + LRU æ·˜æ±°
- **å®ç°**: ConcurrentDictionary + LRU

**L3: Static Cache (é™æ€ç¼“å­˜)**
- **ç”¨é€”**: ç¼“å­˜é™æ€é…ç½®ï¼ˆGearDefinition, Affixï¼‰
- **ç”Ÿå‘½å‘¨æœŸ**: åº”ç”¨å¯åŠ¨åˆ°å…³é—­
- **å¤±æ•ˆç­–ç•¥**: æ‰‹åŠ¨åˆ·æ–°ï¼ˆçƒ­æ›´æ–°æ—¶ï¼‰
- **å®ç°**: å¯åŠ¨æ—¶å…¨é‡åŠ è½½åˆ°å†…å­˜

#### 3. ç¼“å­˜å¤±æ•ˆç­–ç•¥

**å†™å…¥è§¦å‘å¤±æ•ˆï¼ˆWrite-Through Invalidationï¼‰**:
```
å†™å…¥æ“ä½œ â†’ æ›´æ–°æ•°æ®åº“ â†’ å¤±æ•ˆç›¸å…³ç¼“å­˜
```

ç¤ºä¾‹ï¼š
- è£…å¤‡å˜æ›´ â†’ å¤±æ•ˆè§’è‰²çš„è£…å¤‡åˆ—è¡¨ç¼“å­˜
- è§’è‰²å‡çº§ â†’ å¤±æ•ˆè§’è‰²ä¿¡æ¯ç¼“å­˜
- è£…å¤‡è´­ä¹° â†’ å¤±æ•ˆè£…å¤‡å®ä¾‹ç¼“å­˜

**åŸºäºä¾èµ–çš„çº§è”å¤±æ•ˆï¼ˆCascading Invalidationï¼‰**:
```
æºæ•°æ®å¤±æ•ˆ â†’ è‡ªåŠ¨å¤±æ•ˆä¾èµ–çš„è¡ç”Ÿç¼“å­˜
```

ç¤ºä¾‹ï¼š
- Character å¤±æ•ˆ â†’ CharacterStats (è®¡ç®—ç»“æœ) å¤±æ•ˆ
- GearInstance å¤±æ•ˆ â†’ EquippedGearStats (æ±‡æ€») å¤±æ•ˆ

**åŸºäºæ—¶é—´çš„å¤±æ•ˆï¼ˆTime-Based Expirationï¼‰**:
```
ç¼“å­˜é¡¹åˆ›å»º â†’ è®¾ç½® TTL â†’ åˆ°æœŸè‡ªåŠ¨å¤±æ•ˆ
```

ç­–ç•¥ï¼š
- ä¼šè¯æ•°æ®ï¼šSlidingExpiration = 30åˆ†é’Ÿï¼ˆæ¯æ¬¡è®¿é—®åˆ·æ–°ï¼‰
- å®ä½“æ•°æ®ï¼šAbsoluteExpiration = 15åˆ†é’Ÿï¼ˆå›ºå®šè¿‡æœŸï¼‰
- é™æ€æ•°æ®ï¼šæ— è¿‡æœŸï¼ˆæ°¸ä¹…ç¼“å­˜ï¼‰

### æ¶æ„ç»„ä»¶è®¾è®¡

#### ç»„ä»¶ 1: å¤šå±‚ç¼“å­˜ç®¡ç†å™¨ (MultiTierCacheManager)

**èŒè´£**:
- ç»Ÿä¸€ç®¡ç† L1/L2/L3 ä¸‰å±‚ç¼“å­˜
- æä¾›ç»Ÿä¸€çš„ Get/Set/Remove æ¥å£
- å®ç°ç¼“å­˜ç©¿é€ä¿æŠ¤ï¼ˆé˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼‰
- è®°å½•ç¼“å­˜å‘½ä¸­ç‡

**æ¥å£è®¾è®¡**:
```csharp
public interface IMultiTierCacheManager
{
    // è·å–ç¼“å­˜ï¼ˆç©¿é€ä¸‰å±‚ï¼‰
    Task<T?> GetAsync<T>(string cacheKey, CancellationToken ct = default) where T : class;
    
    // è·å–æˆ–åŠ è½½ï¼ˆæœªå‘½ä¸­æ—¶ä»æ•°æ®åº“åŠ è½½ï¼‰
    Task<T?> GetOrLoadAsync<T>(
        string cacheKey, 
        Func<Task<T?>> loader, 
        CacheTier tier,
        TimeSpan? ttl = null,
        CancellationToken ct = default) where T : class;
    
    // è®¾ç½®ç¼“å­˜
    Task SetAsync<T>(string cacheKey, T value, CacheTier tier, TimeSpan? ttl = null) where T : class;
    
    // å¤±æ•ˆç¼“å­˜
    Task InvalidateAsync(string cacheKey);
    
    // æ‰¹é‡å¤±æ•ˆï¼ˆæ”¯æŒæ¨¡å¼åŒ¹é…ï¼‰
    Task InvalidateByPatternAsync(string pattern);
    
    // è·å–ç¼“å­˜ç»Ÿè®¡
    CacheStatistics GetStatistics();
}
```

**ç¼“å­˜é”®è®¾è®¡**:
```
æ ¼å¼: {EntityType}:{Id}[:Qualifier]

ç¤ºä¾‹:
- Character:123e4567-e89b-12d3-a456-426614174000
- GearInstance:Equipped:123e4567-e89b-12d3-a456-426614174000
- GearDefinition:weapon_001
- BattleRecord:789a0123-e45b-67c8-d901-234567890abc
```

#### ç»„ä»¶ 2: ç¼“å­˜æ„ŸçŸ¥ä»“å‚¨ (CacheAwareRepository)

**ç›®çš„**: åœ¨ç°æœ‰ Repository åŸºç¡€ä¸Šå¢åŠ ç¼“å­˜å±‚ï¼Œä¿æŒ API å…¼å®¹

**å®ç°æ–¹å¼**: è£…é¥°å™¨æ¨¡å¼

```csharp
public class CacheAwareCharacterRepository : ICharacterRepository
{
    private readonly ICharacterRepository _innerRepository;
    private readonly IMultiTierCacheManager _cacheManager;
    private readonly CacheOptions _options;
    
    public async Task<Character?> GetAsync(Guid id, CancellationToken ct = default)
    {
        if (!_options.EnableCache)
            return await _innerRepository.GetAsync(id, ct);
        
        var cacheKey = $"Character:{id}";
        
        return await _cacheManager.GetOrLoadAsync(
            cacheKey,
            async () => await _innerRepository.GetAsync(id, ct),
            CacheTier.Session,
            TimeSpan.FromMinutes(_options.SessionTtlMinutes),
            ct
        );
    }
}
```

**ä¼˜ç‚¹**:
- ä¸ä¿®æ”¹ç°æœ‰ Repository ä»£ç 
- é€šè¿‡ä¾èµ–æ³¨å…¥åˆ‡æ¢ï¼ˆæœ‰ç¼“å­˜/æ— ç¼“å­˜ç‰ˆæœ¬ï¼‰
- ä¿æŒæµ‹è¯•å¯æ§æ€§

#### ç»„ä»¶ 3: é™æ€é…ç½®åŠ è½½å™¨ (StaticConfigLoader)

**èŒè´£**:
- åº”ç”¨å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰é™æ€é…ç½®åˆ°å†…å­˜
- æä¾›é…ç½®çƒ­æ›´æ–°æ”¯æŒ
- ç›‘å¬é…ç½®æ–‡ä»¶å˜æ›´

**æ¥å£è®¾è®¡**:
```csharp
public interface IStaticConfigLoader
{
    // å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰é…ç½®
    Task LoadAllConfigsAsync(CancellationToken ct = default);
    
    // é‡æ–°åŠ è½½æŒ‡å®šé…ç½®
    Task ReloadConfigAsync(string configType, CancellationToken ct = default);
    
    // è·å–é…ç½®
    T? GetConfig<T>(string key) where T : class;
    
    // è·å–æ‰€æœ‰é…ç½®
    IReadOnlyDictionary<string, T> GetAllConfigs<T>() where T : class;
}
```

**æ”¯æŒçš„é…ç½®ç±»å‹**:
- GearDefinitionï¼ˆè£…å¤‡å®šä¹‰ï¼‰
- Affixï¼ˆè¯ç¼€å®šä¹‰ï¼‰
- GearSetï¼ˆå¥—è£…å®šä¹‰ï¼‰
- Enemyï¼ˆæ•Œäººå®šä¹‰ï¼‰
- Skillï¼ˆæŠ€èƒ½å®šä¹‰ï¼‰

#### ç»„ä»¶ 4: ç¼“å­˜å¤±æ•ˆåè°ƒå™¨ (CacheInvalidationCoordinator)

**èŒè´£**:
- ç›‘å¬æ•°æ®å˜æ›´äº‹ä»¶
- è‡ªåŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜
- å¤„ç†çº§è”å¤±æ•ˆ

**ç¤ºä¾‹**:
```csharp
// å½“è£…å¤‡å˜æ›´æ—¶
public async Task OnGearChangedAsync(Guid characterId, Guid gearInstanceId)
{
    // å¤±æ•ˆè§’è‰²çš„è£…å¤‡åˆ—è¡¨ç¼“å­˜
    await _cacheManager.InvalidateAsync($"GearInstance:Equipped:{characterId}");
    await _cacheManager.InvalidateAsync($"GearInstance:All:{characterId}");
    
    // çº§è”å¤±æ•ˆï¼šè§’è‰²å±æ€§ç¼“å­˜ï¼ˆå› ä¸ºä¾èµ–è£…å¤‡ï¼‰
    await _cacheManager.InvalidateAsync($"Character:Stats:{characterId}");
}
```

---

## æŠ€æœ¯æ¶æ„è®¾è®¡

### æ ¸å¿ƒç±»è®¾è®¡

#### 1. MultiTierCacheManager å®ç°

```csharp
/// <summary>
/// å¤šå±‚ç¼“å­˜ç®¡ç†å™¨ - å®ç° L1/L2/L3 ä¸‰å±‚ç¼“å­˜
/// </summary>
public class MultiTierCacheManager : IMultiTierCacheManager
{
    // L1: Session Cache - åŸºäº IMemoryCache
    private readonly IMemoryCache _sessionCache;
    
    // L2: Entity Cache - åŸºäº ConcurrentDictionary
    private readonly ConcurrentDictionary<string, CacheEntry> _entityCache;
    
    // L3: Static Cache - åŸºäº ConcurrentDictionary (æ°¸ä¹…)
    private readonly ConcurrentDictionary<string, object> _staticCache;
    
    // ç¼“å­˜é…ç½®
    private readonly ReadCacheOptions _options;
    
    // æ—¥å¿—
    private readonly ILogger<MultiTierCacheManager> _logger;
    
    // ç»Ÿè®¡ä¿¡æ¯
    private long _hits;
    private long _misses;
    
    public async Task<T?> GetOrLoadAsync<T>(
        string cacheKey, 
        Func<Task<T?>> loader, 
        CacheTier tier,
        TimeSpan? ttl = null,
        CancellationToken ct = default) where T : class
    {
        // 1. å°è¯•ä»å¯¹åº”å±‚çº§ç¼“å­˜è·å–
        var cached = await TryGetFromTierAsync<T>(cacheKey, tier);
        if (cached != null)
        {
            Interlocked.Increment(ref _hits);
            return cached;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨ SemaphoreSlim é˜²æ­¢ç¼“å­˜å‡»ç©¿
        var semaphoreKey = $"{cacheKey}:semaphore";
        var semaphore = GetOrCreateSemaphore(semaphoreKey);
        
        await semaphore.WaitAsync(ct);
        try
        {
            // 3. åŒé‡æ£€æŸ¥ï¼ˆå¯èƒ½å·²è¢«å…¶ä»–çº¿ç¨‹åŠ è½½ï¼‰
            cached = await TryGetFromTierAsync<T>(cacheKey, tier);
            if (cached != null)
            {
                Interlocked.Increment(ref _hits);
                return cached;
            }
            
            // 4. ä»æ•°æ®åº“åŠ è½½
            Interlocked.Increment(ref _misses);
            var value = await loader();
            
            if (value != null)
            {
                // 5. å­˜å…¥ç¼“å­˜
                await SetAsync(cacheKey, value, tier, ttl);
            }
            
            return value;
        }
        finally
        {
            semaphore.Release();
        }
    }
    
    private async Task<T?> TryGetFromTierAsync<T>(string cacheKey, CacheTier tier) where T : class
    {
        return tier switch
        {
            CacheTier.Session => _sessionCache.Get<T>(cacheKey),
            CacheTier.Entity => TryGetFromEntityCache<T>(cacheKey),
            CacheTier.Static => TryGetFromStaticCache<T>(cacheKey),
            _ => null
        };
    }
    
    // ... å…¶ä»–æ–¹æ³•å®ç°
}
```

#### 2. CacheEntry ç»“æ„

```csharp
/// <summary>
/// ç¼“å­˜é¡¹ - åŒ…å«å€¼å’Œå…ƒæ•°æ®
/// </summary>
public class CacheEntry
{
    public object Value { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? ExpiresAt { get; set; }
    public DateTime LastAccessedAt { get; set; }
    public long AccessCount { get; set; }
    
    public bool IsExpired() =>
        ExpiresAt.HasValue && DateTime.UtcNow > ExpiresAt.Value;
}
```

#### 3. CacheAwareRepository<T> åŸºç±»

```csharp
/// <summary>
/// ç¼“å­˜æ„ŸçŸ¥ä»“å‚¨åŸºç±»
/// </summary>
public abstract class CacheAwareRepository<TEntity, TKey> 
    where TEntity : class
{
    protected readonly IMultiTierCacheManager CacheManager;
    protected readonly ReadCacheOptions Options;
    protected readonly ILogger Logger;
    
    protected async Task<TEntity?> GetWithCacheAsync(
        TKey key,
        Func<Task<TEntity?>> loader,
        CacheTier tier = CacheTier.Entity,
        TimeSpan? ttl = null,
        CancellationToken ct = default)
    {
        if (!Options.EnableReadCache)
            return await loader();
        
        var cacheKey = BuildCacheKey(key);
        
        return await CacheManager.GetOrLoadAsync(
            cacheKey,
            loader,
            tier,
            ttl ?? GetDefaultTtl(tier),
            ct
        );
    }
    
    protected abstract string BuildCacheKey(TKey key);
    
    protected virtual TimeSpan GetDefaultTtl(CacheTier tier)
    {
        return tier switch
        {
            CacheTier.Session => TimeSpan.FromMinutes(Options.SessionTtlMinutes),
            CacheTier.Entity => TimeSpan.FromMinutes(Options.EntityTtlMinutes),
            CacheTier.Static => TimeSpan.MaxValue,
            _ => TimeSpan.FromMinutes(15)
        };
    }
}
```

---

## é…ç½®ç³»ç»Ÿè®¾è®¡

### é…ç½®æ–‡ä»¶ç»“æ„

```json
// appsettings.json
{
  "ReadCache": {
    // === ä¸»å¼€å…³ ===
    "EnableReadCache": true,
    
    // === å…¨å±€é…ç½® ===
    "MaxCacheSize": 100000,              // æœ€å¤§ç¼“å­˜é¡¹æ•°
    "EnableStatistics": true,             // å¯ç”¨ç»Ÿè®¡
    "StatisticsIntervalSeconds": 60,      // ç»Ÿè®¡é—´éš”
    
    // === L1: Session Cache é…ç½® ===
    "SessionCache": {
      "Enabled": true,
      "DefaultTtlMinutes": 30,           // é»˜è®¤ TTL: 30åˆ†é’Ÿ
      "SlidingExpiration": true,         // æ»‘åŠ¨è¿‡æœŸ
      "MaxSize": 10000                   // æœ€å¤§é¡¹æ•°
    },
    
    // === L2: Entity Cache é…ç½® ===
    "EntityCache": {
      "Enabled": true,
      "DefaultTtlMinutes": 15,           // é»˜è®¤ TTL: 15åˆ†é’Ÿ
      "MaxSize": 50000,                  // æœ€å¤§é¡¹æ•°
      "EvictionPolicy": "LRU",           // æ·˜æ±°ç­–ç•¥: LRU
      "CompactionPercentage": 0.2        // è¾¾åˆ°ä¸Šé™æ—¶å‹ç¼©20%
    },
    
    // === L3: Static Cache é…ç½® ===
    "StaticCache": {
      "Enabled": true,
      "LoadOnStartup": true,             // å¯åŠ¨æ—¶åŠ è½½
      "EnableHotReload": true,           // æ”¯æŒçƒ­é‡è½½
      "MaxSize": 50000
    },
    
    // === å®ä½“çº§ç¼“å­˜ç­–ç•¥ ===
    "EntityStrategies": {
      "Character": {
        "Tier": "Session",
        "TtlMinutes": 30,
        "InvalidateOnUpdate": true
      },
      "User": {
        "Tier": "Session",
        "TtlMinutes": 60,
        "InvalidateOnUpdate": true
      },
      "GearInstance": {
        "Tier": "Entity",
        "TtlMinutes": 15,
        "InvalidateOnUpdate": true,
        "CascadeInvalidation": ["Character:Stats"]
      },
      "BattleRecord": {
        "Tier": "Entity",
        "TtlMinutes": 60,
        "InvalidateOnUpdate": false
      },
      "GearDefinition": {
        "Tier": "Static",
        "InvalidateOnUpdate": false
      },
      "Affix": {
        "Tier": "Static",
        "InvalidateOnUpdate": false
      },
      "GearSet": {
        "Tier": "Static",
        "InvalidateOnUpdate": false
      }
    },
    
    // === å¤±æ•ˆç­–ç•¥é…ç½® ===
    "Invalidation": {
      "EnableCascading": true,           // å¯ç”¨çº§è”å¤±æ•ˆ
      "EnablePatternMatch": true,        // å¯ç”¨æ¨¡å¼åŒ¹é…å¤±æ•ˆ
      "LogInvalidations": false          // è®°å½•å¤±æ•ˆæ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
    },
    
    // === æ€§èƒ½ä¼˜åŒ–é…ç½® ===
    "Performance": {
      "EnableAntiCrashing": true,        // é˜²ç¼“å­˜å‡»ç©¿
      "AntiCrashingSemaphoreTimeout": 5000,  // ä¿¡å·é‡è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
      "PreloadOnStartup": [              // å¯åŠ¨æ—¶é¢„åŠ è½½
        "GearDefinition",
        "Affix",
        "GearSet"
      ]
    }
  }
}
```

### é…ç½®ç±»å®šä¹‰

```csharp
/// <summary>
/// è¯»ç¼“å­˜é…ç½®é€‰é¡¹
/// </summary>
public class ReadCacheOptions
{
    /// <summary>
    /// æ˜¯å¦å¯ç”¨è¯»ç¼“å­˜ï¼ˆä¸»å¼€å…³ï¼‰
    /// </summary>
    public bool EnableReadCache { get; set; } = true;
    
    /// <summary>
    /// æœ€å¤§ç¼“å­˜é¡¹æ•°
    /// </summary>
    [Range(1000, 1000000)]
    public int MaxCacheSize { get; set; } = 100000;
    
    /// <summary>
    /// æ˜¯å¦å¯ç”¨ç»Ÿè®¡
    /// </summary>
    public bool EnableStatistics { get; set; } = true;
    
    /// <summary>
    /// ç»Ÿè®¡é—´éš”ï¼ˆç§’ï¼‰
    /// </summary>
    [Range(10, 3600)]
    public int StatisticsIntervalSeconds { get; set; } = 60;
    
    /// <summary>
    /// Session Cache é…ç½®
    /// </summary>
    public SessionCacheOptions SessionCache { get; set; } = new();
    
    /// <summary>
    /// Entity Cache é…ç½®
    /// </summary>
    public EntityCacheOptions EntityCache { get; set; } = new();
    
    /// <summary>
    /// Static Cache é…ç½®
    /// </summary>
    public StaticCacheOptions StaticCache { get; set; } = new();
    
    /// <summary>
    /// å®ä½“çº§ç¼“å­˜ç­–ç•¥
    /// </summary>
    public Dictionary<string, EntityCacheStrategy> EntityStrategies { get; set; } = new();
    
    /// <summary>
    /// å¤±æ•ˆç­–ç•¥é…ç½®
    /// </summary>
    public InvalidationOptions Invalidation { get; set; } = new();
    
    /// <summary>
    /// æ€§èƒ½ä¼˜åŒ–é…ç½®
    /// </summary>
    public PerformanceOptions Performance { get; set; } = new();
}

/// <summary>
/// Session Cache é…ç½®
/// </summary>
public class SessionCacheOptions
{
    public bool Enabled { get; set; } = true;
    
    [Range(1, 1440)]
    public int DefaultTtlMinutes { get; set; } = 30;
    
    public bool SlidingExpiration { get; set; } = true;
    
    [Range(100, 50000)]
    public int MaxSize { get; set; } = 10000;
}

/// <summary>
/// Entity Cache é…ç½®
/// </summary>
public class EntityCacheOptions
{
    public bool Enabled { get; set; } = true;
    
    [Range(1, 1440)]
    public int DefaultTtlMinutes { get; set; } = 15;
    
    [Range(1000, 100000)]
    public int MaxSize { get; set; } = 50000;
    
    public string EvictionPolicy { get; set; } = "LRU";
    
    [Range(0.1, 0.5)]
    public double CompactionPercentage { get; set; } = 0.2;
}

/// <summary>
/// Static Cache é…ç½®
/// </summary>
public class StaticCacheOptions
{
    public bool Enabled { get; set; } = true;
    public bool LoadOnStartup { get; set; } = true;
    public bool EnableHotReload { get; set; } = true;
    
    [Range(1000, 100000)]
    public int MaxSize { get; set; } = 50000;
}

/// <summary>
/// å®ä½“ç¼“å­˜ç­–ç•¥
/// </summary>
public class EntityCacheStrategy
{
    /// <summary>
    /// ç¼“å­˜å±‚çº§
    /// </summary>
    public string Tier { get; set; } = "Entity";  // Session / Entity / Static
    
    /// <summary>
    /// TTLï¼ˆåˆ†é’Ÿï¼‰
    /// </summary>
    public int TtlMinutes { get; set; } = 15;
    
    /// <summary>
    /// æ›´æ–°æ—¶æ˜¯å¦å¤±æ•ˆç¼“å­˜
    /// </summary>
    public bool InvalidateOnUpdate { get; set; } = true;
    
    /// <summary>
    /// çº§è”å¤±æ•ˆåˆ—è¡¨ï¼ˆç¼“å­˜é”®æ¨¡å¼ï¼‰
    /// </summary>
    public List<string> CascadeInvalidation { get; set; } = new();
}

/// <summary>
/// å¤±æ•ˆç­–ç•¥é…ç½®
/// </summary>
public class InvalidationOptions
{
    public bool EnableCascading { get; set; } = true;
    public bool EnablePatternMatch { get; set; } = true;
    public bool LogInvalidations { get; set; } = false;
}

/// <summary>
/// æ€§èƒ½ä¼˜åŒ–é…ç½®
/// </summary>
public class PerformanceOptions
{
    public bool EnableAntiCrashing { get; set; } = true;
    
    [Range(1000, 30000)]
    public int AntiCrashingSemaphoreTimeout { get; set; } = 5000;
    
    public List<string> PreloadOnStartup { get; set; } = new();
}
```

### é…ç½®æ³¨å†Œ

```csharp
// Program.cs æˆ– DependencyInjection.cs

// é…ç½®é€‰é¡¹
services.Configure<ReadCacheOptions>(
    configuration.GetSection("ReadCache"));

// é…ç½®éªŒè¯
services.AddOptions<ReadCacheOptions>()
    .Bind(configuration.GetSection("ReadCache"))
    .ValidateDataAnnotations()
    .ValidateOnStart();
```

---

## å®æ–½æ–¹æ¡ˆ - ä¸Šç¯‡

### ç›®æ ‡

**Phase 4: è¯»ç¼“å­˜åŸºç¡€è®¾æ–½å»ºè®¾**

å»ºç«‹å®Œæ•´çš„å¤šå±‚ç¼“å­˜ç³»ç»Ÿï¼Œä¸ºåç»­è¿ç§»å¥ å®šåŸºç¡€ã€‚

### æ ¸å¿ƒä»»åŠ¡

#### ä»»åŠ¡ 4.1: åˆ›å»ºæ ¸å¿ƒç¼“å­˜ç»„ä»¶ (å·¥æ—¶: 8-12å°æ—¶)

**å­ä»»åŠ¡**:
1. âœ… åˆ›å»º `ReadCacheOptions.cs` é…ç½®ç±»ï¼ˆå«æ‰€æœ‰å­é…ç½®ç±»ï¼‰
2. âœ… åˆ›å»º `CacheTier` æšä¸¾
3. âœ… åˆ›å»º `CacheEntry` ç±»
4. âœ… åˆ›å»º `IMultiTierCacheManager` æ¥å£
5. âœ… å®ç° `MultiTierCacheManager` ç±»
6. âœ… åˆ›å»ºå•å…ƒæµ‹è¯•

**æ–‡ä»¶æ¸…å•**:
```
BlazorIdle.Server/
  â”œâ”€ Config/DatabaseOptimization/
  â”‚   â””â”€ ReadCacheOptions.cs              (æ–°å¢)
  â”œâ”€ Infrastructure/DatabaseOptimization/
  â”‚   â”œâ”€ Caching/
  â”‚   â”‚   â”œâ”€ Abstractions/
  â”‚   â”‚   â”‚   â””â”€ IMultiTierCacheManager.cs    (æ–°å¢)
  â”‚   â”‚   â”œâ”€ Models/
  â”‚   â”‚   â”‚   â”œâ”€ CacheTier.cs                 (æ–°å¢)
  â”‚   â”‚   â”‚   â”œâ”€ CacheEntry.cs                (æ–°å¢)
  â”‚   â”‚   â”‚   â””â”€ CacheStatistics.cs           (æ–°å¢)
  â”‚   â”‚   â””â”€ MultiTierCacheManager.cs         (æ–°å¢)
```

**å®ç°è¦ç‚¹**:

##### MultiTierCacheManager æ ¸å¿ƒé€»è¾‘

```csharp
public class MultiTierCacheManager : IMultiTierCacheManager
{
    // ä¸‰å±‚ç¼“å­˜å­˜å‚¨
    private readonly IMemoryCache _sessionCache;  // L1: ASP.NET Core MemoryCache
    private readonly ConcurrentDictionary<string, CacheEntry> _entityCache;  // L2
    private readonly ConcurrentDictionary<string, object> _staticCache;  // L3
    
    // é˜²ç¼“å­˜å‡»ç©¿ï¼šæ¯ä¸ªé”®ä¸€ä¸ªä¿¡å·é‡
    private readonly ConcurrentDictionary<string, SemaphoreSlim> _semaphores;
    
    // é…ç½®
    private readonly ReadCacheOptions _options;
    
    // ç»Ÿè®¡
    private long _hits;
    private long _misses;
    
    public async Task<T?> GetOrLoadAsync<T>(
        string cacheKey, 
        Func<Task<T?>> loader, 
        CacheTier tier,
        TimeSpan? ttl = null,
        CancellationToken ct = default) where T : class
    {
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        var cached = TryGetFromTier<T>(cacheKey, tier);
        if (cached != null)
        {
            Interlocked.Increment(ref _hits);
            return cached;
        }
        
        // 2. é˜²ç¼“å­˜å‡»ç©¿ï¼šè·å–æˆ–åˆ›å»ºä¿¡å·é‡
        var semaphore = _semaphores.GetOrAdd(
            cacheKey, 
            _ => new SemaphoreSlim(1, 1)
        );
        
        if (!await semaphore.WaitAsync(
            _options.Performance.AntiCrashingSemaphoreTimeout, 
            ct))
        {
            // è¶…æ—¶ï¼šç›´æ¥æŸ¥è¯¢ï¼ˆé™çº§ï¼‰
            _logger.LogWarning("ç¼“å­˜åŠ è½½è¶…æ—¶: {CacheKey}", cacheKey);
            return await loader();
        }
        
        try
        {
            // 3. åŒé‡æ£€æŸ¥ï¼ˆå¯èƒ½å·²è¢«å…¶ä»–çº¿ç¨‹åŠ è½½ï¼‰
            cached = TryGetFromTier<T>(cacheKey, tier);
            if (cached != null)
            {
                Interlocked.Increment(ref _hits);
                return cached;
            }
            
            // 4. ä»æ•°æ®åº“åŠ è½½
            Interlocked.Increment(ref _misses);
            var value = await loader();
            
            // 5. å­˜å…¥ç¼“å­˜
            if (value != null)
            {
                await SetAsync(cacheKey, value, tier, ttl);
            }
            
            return value;
        }
        finally
        {
            semaphore.Release();
        }
    }
    
    private T? TryGetFromTier<T>(string cacheKey, CacheTier tier) where T : class
    {
        return tier switch
        {
            CacheTier.Session => _sessionCache.Get<T>(cacheKey),
            CacheTier.Entity => TryGetFromEntityCache<T>(cacheKey),
            CacheTier.Static => TryGetFromStaticCache<T>(cacheKey),
            _ => null
        };
    }
    
    private T? TryGetFromEntityCache<T>(string cacheKey) where T : class
    {
        if (_entityCache.TryGetValue(cacheKey, out var entry))
        {
            if (!entry.IsExpired())
            {
                entry.LastAccessedAt = DateTime.UtcNow;
                entry.AccessCount++;
                return (T)entry.Value;
            }
            else
            {
                // è¿‡æœŸï¼šç§»é™¤
                _entityCache.TryRemove(cacheKey, out _);
            }
        }
        return null;
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

#### ä»»åŠ¡ 4.2: åˆ›å»º CacheAwareRepository åŸºç±» (å·¥æ—¶: 4-6å°æ—¶)

**æ–‡ä»¶æ¸…å•**:
```
BlazorIdle.Server/
  â””â”€ Infrastructure/Persistence/
      â””â”€ CacheAwareRepository.cs         (æ–°å¢)
```

**å®ç°è¦ç‚¹**:

```csharp
/// <summary>
/// ç¼“å­˜æ„ŸçŸ¥ä»“å‚¨åŸºç±» - æä¾›ç»Ÿä¸€çš„ç¼“å­˜è¯»å–é€»è¾‘
/// </summary>
public abstract class CacheAwareRepository<TEntity, TKey> 
    where TEntity : class
{
    protected readonly IMultiTierCacheManager CacheManager;
    protected readonly ReadCacheOptions CacheOptions;
    protected readonly ILogger Logger;
    
    protected CacheAwareRepository(
        IMultiTierCacheManager cacheManager,
        IOptions<ReadCacheOptions> cacheOptions,
        ILogger logger)
    {
        CacheManager = cacheManager;
        CacheOptions = cacheOptions.Value;
        Logger = logger;
    }
    
    /// <summary>
    /// é€šè¿‡ç¼“å­˜è·å–å®ä½“
    /// </summary>
    protected async Task<TEntity?> GetWithCacheAsync(
        TKey key,
        Func<Task<TEntity?>> loader,
        string? entityType = null,
        CancellationToken ct = default)
    {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨ç¼“å­˜
        if (!CacheOptions.EnableReadCache)
        {
            return await loader();
        }
        
        // ç¡®å®šå®ä½“ç±»å‹
        entityType ??= typeof(TEntity).Name;
        
        // è·å–ç¼“å­˜ç­–ç•¥
        var strategy = GetEntityStrategy(entityType);
        
        // æ„å»ºç¼“å­˜é”®
        var cacheKey = BuildCacheKey(key, entityType);
        
        // ç¡®å®šç¼“å­˜å±‚çº§
        var tier = ParseCacheTier(strategy.Tier);
        
        // ç¡®å®š TTL
        var ttl = TimeSpan.FromMinutes(strategy.TtlMinutes);
        
        // é€šè¿‡ç¼“å­˜åŠ è½½
        return await CacheManager.GetOrLoadAsync(
            cacheKey,
            loader,
            tier,
            ttl,
            ct
        );
    }
    
    /// <summary>
    /// æ„å»ºç¼“å­˜é”®
    /// </summary>
    protected virtual string BuildCacheKey(TKey key, string entityType)
    {
        return $"{entityType}:{key}";
    }
    
    /// <summary>
    /// è·å–å®ä½“ç¼“å­˜ç­–ç•¥
    /// </summary>
    protected EntityCacheStrategy GetEntityStrategy(string entityType)
    {
        if (CacheOptions.EntityStrategies.TryGetValue(entityType, out var strategy))
        {
            return strategy;
        }
        
        // é»˜è®¤ç­–ç•¥
        return new EntityCacheStrategy
        {
            Tier = "Entity",
            TtlMinutes = 15,
            InvalidateOnUpdate = true
        };
    }
    
    protected static CacheTier ParseCacheTier(string tier)
    {
        return tier?.ToLowerInvariant() switch
        {
            "session" => CacheTier.Session,
            "entity" => CacheTier.Entity,
            "static" => CacheTier.Static,
            _ => CacheTier.Entity
        };
    }
}
```

#### ä»»åŠ¡ 4.3: åˆ›å»ºé™æ€é…ç½®åŠ è½½å™¨ (å·¥æ—¶: 6-8å°æ—¶)

**æ–‡ä»¶æ¸…å•**:
```
BlazorIdle.Server/
  â””â”€ Infrastructure/DatabaseOptimization/
      â””â”€ Caching/
          â”œâ”€ Abstractions/
          â”‚   â””â”€ IStaticConfigLoader.cs      (æ–°å¢)
          â””â”€ StaticConfigLoader.cs            (æ–°å¢)
```

**å®ç°è¦ç‚¹**:

```csharp
/// <summary>
/// é™æ€é…ç½®åŠ è½½å™¨ - å¯åŠ¨æ—¶åŠ è½½é™æ€é…ç½®åˆ°å†…å­˜
/// </summary>
public class StaticConfigLoader : IStaticConfigLoader, IHostedService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly IMultiTierCacheManager _cacheManager;
    private readonly ReadCacheOptions _options;
    private readonly ILogger<StaticConfigLoader> _logger;
    
    public async Task StartAsync(CancellationToken ct)
    {
        if (!_options.StaticCache.Enabled || 
            !_options.StaticCache.LoadOnStartup)
        {
            return;
        }
        
        _logger.LogInformation("å¼€å§‹åŠ è½½é™æ€é…ç½®åˆ°å†…å­˜...");
        
        await LoadAllConfigsAsync(ct);
        
        _logger.LogInformation("é™æ€é…ç½®åŠ è½½å®Œæˆ");
    }
    
    public async Task LoadAllConfigsAsync(CancellationToken ct = default)
    {
        using var scope = _scopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
        
        // åŠ è½½è£…å¤‡å®šä¹‰
        await LoadConfigTypeAsync<GearDefinition>(
            db.GearDefinitions.ToListAsync(ct), 
            "GearDefinition",
            ct
        );
        
        // åŠ è½½è¯ç¼€å®šä¹‰
        await LoadConfigTypeAsync<Affix>(
            db.Affixes.ToListAsync(ct), 
            "Affix",
            ct
        );
        
        // åŠ è½½å¥—è£…å®šä¹‰
        await LoadConfigTypeAsync<GearSet>(
            db.GearSets.ToListAsync(ct), 
            "GearSet",
            ct
        );
        
        // ... å…¶ä»–é™æ€é…ç½®
    }
    
    private async Task LoadConfigTypeAsync<T>(
        Task<List<T>> loader, 
        string configType,
        CancellationToken ct) where T : class
    {
        try
        {
            var items = await loader;
            
            foreach (var item in items)
            {
                // å‡è®¾é…ç½®å¯¹è±¡æœ‰ Id æˆ– Key å±æ€§
                var key = GetConfigKey(item, configType);
                await _cacheManager.SetAsync(key, item, CacheTier.Static);
            }
            
            _logger.LogInformation(
                "å·²åŠ è½½ {Count} ä¸ª {ConfigType} é…ç½®", 
                items.Count, 
                configType
            );
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "åŠ è½½ {ConfigType} é…ç½®å¤±è´¥", configType);
        }
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

#### ä»»åŠ¡ 4.4: åˆ›å»ºç¼“å­˜å¤±æ•ˆåè°ƒå™¨ (å·¥æ—¶: 6-8å°æ—¶)

**æ–‡ä»¶æ¸…å•**:
```
BlazorIdle.Server/
  â””â”€ Infrastructure/DatabaseOptimization/
      â””â”€ Caching/
          â”œâ”€ Abstractions/
          â”‚   â””â”€ ICacheInvalidationCoordinator.cs   (æ–°å¢)
          â””â”€ CacheInvalidationCoordinator.cs         (æ–°å¢)
```

**å®ç°è¦ç‚¹**:

```csharp
/// <summary>
/// ç¼“å­˜å¤±æ•ˆåè°ƒå™¨ - ç®¡ç†ç¼“å­˜å¤±æ•ˆé€»è¾‘
/// </summary>
public class CacheInvalidationCoordinator : ICacheInvalidationCoordinator
{
    private readonly IMultiTierCacheManager _cacheManager;
    private readonly ReadCacheOptions _options;
    private readonly ILogger<CacheInvalidationCoordinator> _logger;
    
    /// <summary>
    /// å®ä½“æ›´æ–°æ—¶å¤±æ•ˆç›¸å…³ç¼“å­˜
    /// </summary>
    public async Task OnEntityUpdatedAsync(string entityType, Guid id, CancellationToken ct = default)
    {
        if (!_options.Invalidation.EnableCascading)
        {
            await InvalidateSingleAsync(entityType, id);
            return;
        }
        
        // è·å–å®ä½“ç­–ç•¥
        if (!_options.EntityStrategies.TryGetValue(entityType, out var strategy) ||
            !strategy.InvalidateOnUpdate)
        {
            return;
        }
        
        // å¤±æ•ˆè‡ªèº«
        await InvalidateSingleAsync(entityType, id);
        
        // çº§è”å¤±æ•ˆ
        foreach (var cascadePattern in strategy.CascadeInvalidation)
        {
            var pattern = cascadePattern.Replace("{id}", id.ToString());
            await _cacheManager.InvalidateByPatternAsync(pattern);
            
            if (_options.Invalidation.LogInvalidations)
            {
                _logger.LogDebug("çº§è”å¤±æ•ˆç¼“å­˜: {Pattern}", pattern);
            }
        }
    }
    
    private async Task InvalidateSingleAsync(string entityType, Guid id)
    {
        var cacheKey = $"{entityType}:{id}";
        await _cacheManager.InvalidateAsync(cacheKey);
        
        if (_options.Invalidation.LogInvalidations)
        {
            _logger.LogDebug("å¤±æ•ˆç¼“å­˜: {CacheKey}", cacheKey);
        }
    }
    
    // è£…å¤‡å˜æ›´æ—¶çš„ä¸“ç”¨å¤±æ•ˆé€»è¾‘
    public async Task OnGearChangedAsync(Guid characterId, Guid gearInstanceId, CancellationToken ct = default)
    {
        // å¤±æ•ˆè£…å¤‡å®ä¾‹ç¼“å­˜
        await InvalidateSingleAsync("GearInstance", gearInstanceId);
        
        // å¤±æ•ˆè§’è‰²çš„è£…å¤‡åˆ—è¡¨ç¼“å­˜
        await _cacheManager.InvalidateByPatternAsync($"GearInstance:*:{characterId}");
        
        // çº§è”å¤±æ•ˆï¼šè§’è‰²å±æ€§ï¼ˆä¾èµ–è£…å¤‡ï¼‰
        await _cacheManager.InvalidateByPatternAsync($"Character:Stats:{characterId}");
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

#### ä»»åŠ¡ 4.5: ä¾èµ–æ³¨å…¥é…ç½® (å·¥æ—¶: 2-4å°æ—¶)

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/DependencyInjection.cs`

**ä¿®æ”¹å†…å®¹**:

```csharp
public static class DependencyInjection
{
    public static IServiceCollection AddInfrastructure(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        // ... ç°æœ‰ä»£ç  ...
        
        // === è¯»ç¼“å­˜é…ç½® ===
        services.Configure<ReadCacheOptions>(
            configuration.GetSection("ReadCache"));
        
        services.AddOptions<ReadCacheOptions>()
            .Bind(configuration.GetSection("ReadCache"))
            .ValidateDataAnnotations()
            .ValidateOnStart();
        
        // === æ ¸å¿ƒç¼“å­˜æœåŠ¡ ===
        services.AddSingleton<IMultiTierCacheManager, MultiTierCacheManager>();
        services.AddSingleton<ICacheInvalidationCoordinator, CacheInvalidationCoordinator>();
        
        // === é™æ€é…ç½®åŠ è½½å™¨ ===
        services.AddSingleton<IStaticConfigLoader, StaticConfigLoader>();
        services.AddHostedService(sp => 
            (StaticConfigLoader)sp.GetRequiredService<IStaticConfigLoader>());
        
        // === ASP.NET Core MemoryCacheï¼ˆL1 Session Cache ä½¿ç”¨ï¼‰ ===
        services.AddMemoryCache(options =>
        {
            var cacheOptions = configuration.GetSection("ReadCache:SessionCache")
                .Get<SessionCacheOptions>() ?? new SessionCacheOptions();
            
            options.SizeLimit = cacheOptions.MaxSize;
            options.CompactionPercentage = 0.2;
        });
        
        return services;
    }
}
```

#### ä»»åŠ¡ 4.6: å•å…ƒæµ‹è¯• (å·¥æ—¶: 8-12å°æ—¶)

**æ–‡ä»¶æ¸…å•**:
```
tests/BlazorIdle.Tests/
  â””â”€ DatabaseOptimization/
      â””â”€ Caching/
          â”œâ”€ MultiTierCacheManagerTests.cs     (æ–°å¢)
          â”œâ”€ CacheInvalidationTests.cs          (æ–°å¢)
          â””â”€ StaticConfigLoaderTests.cs         (æ–°å¢)
```

**æµ‹è¯•ç”¨ä¾‹**:

1. **MultiTierCacheManagerTests**
   - âœ… GetOrLoadAsync_CacheMiss_LoadsFromDatabase
   - âœ… GetOrLoadAsync_CacheHit_ReturnsFromCache
   - âœ… GetOrLoadAsync_ConcurrentRequests_OnlyLoadsOnce (é˜²ç¼“å­˜å‡»ç©¿)
   - âœ… SetAsync_ToSessionTier_UsesMemoryCache
   - âœ… SetAsync_ToEntityTier_UsesEntityCache
   - âœ… InvalidateAsync_RemovesFromCache
   - âœ… GetStatistics_ReturnsHitMissRatio

2. **CacheInvalidationTests**
   - âœ… OnEntityUpdated_InvalidatesSelf
   - âœ… OnEntityUpdated_CascadesInvalidation
   - âœ… OnGearChanged_InvalidatesCharacterStats

3. **StaticConfigLoaderTests**
   - âœ… LoadAllConfigs_LoadsAllConfigTypes
   - âœ… GetConfig_ReturnsLoadedConfig
   - âœ… ReloadConfig_ReloadsSpecificType

### éªŒæ”¶æ ‡å‡†

#### åŠŸèƒ½å®Œæ•´æ€§
- [x] MultiTierCacheManager å®ç°ä¸‰å±‚ç¼“å­˜
- [x] CacheAwareRepository åŸºç±»æä¾›ç»Ÿä¸€æ¥å£
- [x] StaticConfigLoader å¯åŠ¨æ—¶åŠ è½½é…ç½®
- [x] CacheInvalidationCoordinator ç®¡ç†å¤±æ•ˆ
- [x] æ‰€æœ‰é…ç½®å‚æ•°åœ¨ appsettings.json
- [x] ç¼–è¯‘æˆåŠŸï¼Œé›¶é”™è¯¯

#### ä»£ç è´¨é‡
- [x] éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ
- [x] è¯¦ç»†çš„ä¸­è‹±æ–‡æ³¨é‡Š
- [x] å®Œæ•´çš„ XML æ–‡æ¡£æ³¨é‡Š
- [x] ç¬¦åˆ DDD æ¶æ„

#### æµ‹è¯•è¦†ç›–
- [x] æ ¸å¿ƒåŠŸèƒ½å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡

### å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | éš¾åº¦ |
|-----|---------|------|
| 4.1 æ ¸å¿ƒç¼“å­˜ç»„ä»¶ | 8-12h | â­â­â­â­ |
| 4.2 CacheAwareRepository | 4-6h | â­â­â­ |
| 4.3 é™æ€é…ç½®åŠ è½½å™¨ | 6-8h | â­â­â­ |
| 4.4 ç¼“å­˜å¤±æ•ˆåè°ƒå™¨ | 6-8h | â­â­â­â­ |
| 4.5 ä¾èµ–æ³¨å…¥é…ç½® | 2-4h | â­â­ |
| 4.6 å•å…ƒæµ‹è¯• | 8-12h | â­â­â­ |
| **æ€»è®¡** | **34-50h** | **çº¦ 5-7 å·¥ä½œæ—¥** |

---

## å®æ–½æ–¹æ¡ˆ - ä¸­ç¯‡

### ç›®æ ‡

**Phase 5: é€æ­¥è¿ç§»é«˜é¢‘è¯»å–æ“ä½œåˆ°ç¼“å­˜**

æŒ‰ä¼˜å…ˆçº§é€æ­¥è¿ç§»ç°æœ‰ Repository ä½¿ç”¨ç¼“å­˜ï¼Œç¡®ä¿æ¯ä¸ªæ¨¡å—ç‹¬ç«‹å¯æµ‹è¯•ã€å¯å›é€€ã€‚

### è¿ç§»ä¼˜å…ˆçº§æ’åº

æ ¹æ®**å½±å“ï¼ˆé¢‘ç‡ï¼‰**å’Œ**é£é™©**ï¼Œç¡®å®šè¿ç§»é¡ºåºï¼š

| ä¼˜å…ˆçº§ | æ¨¡å— | é¢‘ç‡ | é£é™© | é¢„æœŸæ”¶ç›Š |
|-------|------|------|------|---------|
| P0 | è§’è‰²ä¿¡æ¯æŸ¥è¯¢ | â­â­â­â­â­ | â­â­ | å‡å°‘ 90% æŸ¥è¯¢ |
| P0 | é™æ€é…ç½®æŸ¥è¯¢ | â­â­â­â­â­ | â­ | å‡å°‘ 95% æŸ¥è¯¢ |
| P1 | è£…å¤‡æŸ¥è¯¢ (å« Include) | â­â­â­â­ | â­â­â­ | å‡å°‘ 80% æŸ¥è¯¢ + Join |
| P1 | ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ | â­â­â­ | â­â­ | å‡å°‘ 85% æŸ¥è¯¢ |
| P2 | æˆ˜æ–—è®°å½•æŸ¥è¯¢ | â­â­â­ | â­â­ | å‡å°‘ 70% æŸ¥è¯¢ |
| P2 | æ´»åŠ¨è®¡åˆ’æŸ¥è¯¢ | â­â­ | â­â­ | å‡å°‘ 60% æŸ¥è¯¢ |

### æ ¸å¿ƒä»»åŠ¡

#### ä»»åŠ¡ 5.1: CharacterRepository ç¼“å­˜è¿ç§» (P0, å·¥æ—¶: 4-6å°æ—¶)

**ç›®æ ‡**: è§’è‰²ä¿¡æ¯æŸ¥è¯¢ä¼˜å…ˆä»ç¼“å­˜è·å–

**æ–‡ä»¶**: `Infrastructure/Persistence/Repositories/CharacterRepository.cs`

**æ”¹åŠ¨æ–¹æ¡ˆ**:

##### æ–¹æ¡ˆ A: è£…é¥°å™¨æ¨¡å¼ï¼ˆæ¨èï¼‰

åˆ›å»ºæ–°æ–‡ä»¶ `CacheAwareCharacterRepository.cs`ï¼ŒåŒ…è£…åŸæœ‰ Repository:

```csharp
/// <summary>
/// ç¼“å­˜æ„ŸçŸ¥çš„è§’è‰²ä»“å‚¨ - è£…é¥°å™¨æ¨¡å¼
/// </summary>
public class CacheAwareCharacterRepository : ICharacterRepository
{
    private readonly ICharacterRepository _innerRepository;
    private readonly IMultiTierCacheManager _cacheManager;
    private readonly ICacheInvalidationCoordinator _invalidationCoordinator;
    private readonly ReadCacheOptions _options;
    private readonly ILogger<CacheAwareCharacterRepository> _logger;
    
    public CacheAwareCharacterRepository(
        ICharacterRepository innerRepository,
        IMultiTierCacheManager cacheManager,
        ICacheInvalidationCoordinator invalidationCoordinator,
        IOptions<ReadCacheOptions> options,
        ILogger<CacheAwareCharacterRepository> logger)
    {
        _innerRepository = innerRepository;
        _cacheManager = cacheManager;
        _invalidationCoordinator = invalidationCoordinator;
        _options = options.Value;
        _logger = logger;
    }
    
    public async Task<Character?> GetAsync(Guid id, CancellationToken ct = default)
    {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨ç¼“å­˜
        if (!_options.EnableReadCache || 
            !_options.SessionCache.Enabled)
        {
            return await _innerRepository.GetAsync(id, ct);
        }
        
        // æ„å»ºç¼“å­˜é”®
        var cacheKey = $"Character:{id}";
        
        // è·å–æˆ–åŠ è½½
        return await _cacheManager.GetOrLoadAsync(
            cacheKey,
            async () => await _innerRepository.GetAsync(id, ct),
            CacheTier.Session,
            TimeSpan.FromMinutes(_options.SessionCache.DefaultTtlMinutes),
            ct
        );
    }
}
```

**ä¾èµ–æ³¨å…¥é…ç½®**:

```csharp
// DependencyInjection.cs

// åŸå§‹ Repository
services.AddScoped<CharacterRepository>();

// ç¼“å­˜è£…é¥°å™¨ï¼ˆæ¡ä»¶æ³¨å†Œï¼‰
var enableReadCache = configuration.GetValue<bool>("ReadCache:EnableReadCache", false);
if (enableReadCache)
{
    services.AddScoped<ICharacterRepository>(sp =>
    {
        var innerRepo = sp.GetRequiredService<CharacterRepository>();
        var cacheManager = sp.GetRequiredService<IMultiTierCacheManager>();
        var invalidationCoordinator = sp.GetRequiredService<ICacheInvalidationCoordinator>();
        var options = sp.GetRequiredService<IOptions<ReadCacheOptions>>();
        var logger = sp.GetRequiredService<ILogger<CacheAwareCharacterRepository>>();
        
        return new CacheAwareCharacterRepository(
            innerRepo, 
            cacheManager, 
            invalidationCoordinator,
            options, 
            logger
        );
    });
}
else
{
    services.AddScoped<ICharacterRepository, CharacterRepository>();
}
```

**ç¼“å­˜å¤±æ•ˆè§¦å‘ç‚¹**:

éœ€è¦åœ¨ä»¥ä¸‹ä½ç½®è§¦å‘ç¼“å­˜å¤±æ•ˆï¼š

1. **è§’è‰²å‡çº§æ—¶** (`CharactersController` æˆ–ç›¸å…³ Service)
   ```csharp
   // è§’è‰²å‡çº§å
   await _invalidationCoordinator.OnEntityUpdatedAsync("Character", characterId);
   ```

2. **è£…å¤‡å˜æ›´æ—¶** (çº§è”å¤±æ•ˆï¼Œå·²åœ¨ CacheInvalidationCoordinator å®ç°)
   ```csharp
   await _invalidationCoordinator.OnGearChangedAsync(characterId, gearInstanceId);
   ```

3. **è§’è‰²å±æ€§å˜æ›´æ—¶**
   ```csharp
   await _invalidationCoordinator.OnEntityUpdatedAsync("Character", characterId);
   ```

**æµ‹è¯•ç”¨ä¾‹**:

```csharp
public class CacheAwareCharacterRepositoryTests
{
    [Fact]
    public async Task GetAsync_FirstCall_LoadsFromDatabase()
    {
        // Arrange
        var mockInnerRepo = new Mock<ICharacterRepository>();
        var character = new Character { Id = Guid.NewGuid() };
        mockInnerRepo.Setup(r => r.GetAsync(character.Id, default))
            .ReturnsAsync(character);
        
        var repo = CreateCacheAwareRepo(mockInnerRepo.Object);
        
        // Act
        var result = await repo.GetAsync(character.Id);
        
        // Assert
        Assert.NotNull(result);
        mockInnerRepo.Verify(r => r.GetAsync(character.Id, default), Times.Once);
    }
    
    [Fact]
    public async Task GetAsync_SecondCall_LoadsFromCache()
    {
        // Arrange
        var mockInnerRepo = new Mock<ICharacterRepository>();
        var character = new Character { Id = Guid.NewGuid() };
        mockInnerRepo.Setup(r => r.GetAsync(character.Id, default))
            .ReturnsAsync(character);
        
        var repo = CreateCacheAwareRepo(mockInnerRepo.Object);
        
        // Act
        await repo.GetAsync(character.Id);  // ç¬¬ä¸€æ¬¡ï¼šä»æ•°æ®åº“
        var result = await repo.GetAsync(character.Id);  // ç¬¬äºŒæ¬¡ï¼šä»ç¼“å­˜
        
        // Assert
        Assert.NotNull(result);
        mockInnerRepo.Verify(r => r.GetAsync(character.Id, default), Times.Once);  // åªè°ƒç”¨ä¸€æ¬¡
    }
    
    // ... å…¶ä»–æµ‹è¯•
}
```

**é¢„æœŸæ•ˆæœ**:
- æ•°æ®åº“æŸ¥è¯¢å‡å°‘ï¼š90%+
- API å“åº”æ—¶é—´æ”¹å–„ï¼š30-50ms

---

#### ä»»åŠ¡ 5.2: é™æ€é…ç½®æŸ¥è¯¢ç¼“å­˜åŒ– (P0, å·¥æ—¶: 6-8å°æ—¶)

**ç›®æ ‡**: GearDefinitionã€Affixã€GearSet ç­‰é™æ€é…ç½®å¯åŠ¨æ—¶åŠ è½½ï¼Œè¿è¡Œæ—¶ä»å†…å­˜è¯»å–

**æ¶‰åŠæ–‡ä»¶**:
- `GearDefinitionRepository.cs`
- `AffixRepository.cs`
- `GearSetRepository.cs`

**æ”¹åŠ¨æ–¹æ¡ˆ**:

##### ç»Ÿä¸€é™æ€é…ç½®ä»“å‚¨æ¥å£

```csharp
/// <summary>
/// é™æ€é…ç½®ä»“å‚¨åŸºç±»
/// </summary>
public abstract class StaticConfigRepository<T> where T : class
{
    private readonly GameDbContext _db;
    private readonly IStaticConfigLoader _configLoader;
    private readonly ReadCacheOptions _options;
    
    protected abstract string ConfigType { get; }
    
    public async Task<T?> GetByIdAsync(string id, CancellationToken ct = default)
    {
        if (!_options.StaticCache.Enabled)
        {
            // å›é€€ï¼šç›´æ¥æŸ¥æ•°æ®åº“
            return await GetFromDatabaseAsync(id, ct);
        }
        
        // ä»é™æ€ç¼“å­˜è·å–
        return _configLoader.GetConfig<T>($"{ConfigType}:{id}");
    }
    
    public IReadOnlyDictionary<string, T> GetAll()
    {
        if (!_options.StaticCache.Enabled)
        {
            throw new NotSupportedException("é™æ€ç¼“å­˜æœªå¯ç”¨æ—¶ä¸æ”¯æŒ GetAll");
        }
        
        return _configLoader.GetAllConfigs<T>();
    }
    
    protected abstract Task<T?> GetFromDatabaseAsync(string id, CancellationToken ct);
}
```

##### GearDefinitionRepository æ”¹é€ 

```csharp
public class GearDefinitionRepository : StaticConfigRepository<GearDefinition>, IGearDefinitionRepository
{
    private readonly GameDbContext _db;
    
    protected override string ConfigType => "GearDefinition";
    
    public GearDefinitionRepository(
        GameDbContext db,
        IStaticConfigLoader configLoader,
        IOptions<ReadCacheOptions> options)
        : base(db, configLoader, options.Value)
    {
        _db = db;
    }
    
    protected override async Task<GearDefinition?> GetFromDatabaseAsync(string id, CancellationToken ct)
    {
        return await _db.GearDefinitions
            .FirstOrDefaultAsync(g => g.DefinitionId == id, ct);
    }
}
```

**StaticConfigLoader å¢å¼º**:

```csharp
public class StaticConfigLoader : IStaticConfigLoader
{
    // ... ç°æœ‰ä»£ç  ...
    
    public T? GetConfig<T>(string key) where T : class
    {
        if (_staticCache.TryGetValue(key, out var value))
        {
            return value as T;
        }
        return null;
    }
    
    public IReadOnlyDictionary<string, T> GetAllConfigs<T>() where T : class
    {
        var result = new Dictionary<string, T>();
        var prefix = typeof(T).Name + ":";
        
        foreach (var (key, value) in _staticCache)
        {
            if (key.StartsWith(prefix) && value is T typedValue)
            {
                result[key.Substring(prefix.Length)] = typedValue;
            }
        }
        
        return result;
    }
}
```

**é¢„æœŸæ•ˆæœ**:
- æ•°æ®åº“æŸ¥è¯¢å‡å°‘ï¼š95%+ï¼ˆä»…å¯åŠ¨æ—¶æŸ¥è¯¢ä¸€æ¬¡ï¼‰
- å“åº”æ—¶é—´ï¼šå‡ ä¹ä¸º 0ï¼ˆå†…å­˜è¯»å–ï¼‰

---

#### ä»»åŠ¡ 5.3: GearInstanceRepository ç¼“å­˜è¿ç§» (P1, å·¥æ—¶: 6-8å°æ—¶)

**ç›®æ ‡**: è£…å¤‡æŸ¥è¯¢ï¼ˆå« Includeï¼‰ä¼˜å…ˆä»ç¼“å­˜è·å–

**éš¾ç‚¹**: Include æ“ä½œéœ€è¦é¢„åŠ è½½å…³è”æ•°æ®

**è§£å†³æ–¹æ¡ˆ**: ç¼“å­˜æ—¶ä¸€å¹¶ç¼“å­˜å…³è”çš„ GearDefinition

```csharp
public class CacheAwareGearInstanceRepository : IGearInstanceRepository
{
    private readonly IGearInstanceRepository _innerRepository;
    private readonly IMultiTierCacheManager _cacheManager;
    private readonly ReadCacheOptions _options;
    
    public async Task<GearInstance?> GetByIdAsync(Guid id, CancellationToken ct = default)
    {
        if (!_options.EnableReadCache)
        {
            return await _innerRepository.GetByIdAsync(id, ct);
        }
        
        var cacheKey = $"GearInstance:{id}";
        
        return await _cacheManager.GetOrLoadAsync(
            cacheKey,
            async () => await _innerRepository.GetByIdAsync(id, ct),  // Include Definition
            CacheTier.Entity,
            TimeSpan.FromMinutes(_options.EntityCache.DefaultTtlMinutes),
            ct
        );
    }
    
    public async Task<List<GearInstance>> GetEquippedGearAsync(Guid characterId, CancellationToken ct = default)
    {
        if (!_options.EnableReadCache)
        {
            return await _innerRepository.GetEquippedGearAsync(characterId, ct);
        }
        
        var cacheKey = $"GearInstance:Equipped:{characterId}";
        
        return await _cacheManager.GetOrLoadAsync(
            cacheKey,
            async () => await _innerRepository.GetEquippedGearAsync(characterId, ct),
            CacheTier.Entity,
            TimeSpan.FromMinutes(_options.EntityCache.DefaultTtlMinutes),
            ct
        ) ?? new List<GearInstance>();
    }
    
    public async Task UpdateAsync(GearInstance instance, CancellationToken ct = default)
    {
        // 1. æ›´æ–°æ•°æ®åº“
        await _innerRepository.UpdateAsync(instance, ct);
        
        // 2. å¤±æ•ˆç›¸å…³ç¼“å­˜
        await _invalidationCoordinator.OnGearChangedAsync(
            instance.CharacterId, 
            instance.Id, 
            ct
        );
    }
}
```

**ç¼“å­˜å¤±æ•ˆ**:

```csharp
// CacheInvalidationCoordinator
public async Task OnGearChangedAsync(Guid characterId, Guid gearInstanceId, CancellationToken ct = default)
{
    // å¤±æ•ˆå•ä¸ªè£…å¤‡å®ä¾‹
    await _cacheManager.InvalidateAsync($"GearInstance:{gearInstanceId}");
    
    // å¤±æ•ˆè§’è‰²çš„è£…å¤‡åˆ—è¡¨
    await _cacheManager.InvalidateAsync($"GearInstance:Equipped:{characterId}");
    await _cacheManager.InvalidateAsync($"GearInstance:All:{characterId}");
    
    // çº§è”å¤±æ•ˆï¼šè§’è‰²å±æ€§
    await _cacheManager.InvalidateAsync($"Character:Stats:{characterId}");
}
```

**é¢„æœŸæ•ˆæœ**:
- æ•°æ®åº“æŸ¥è¯¢å‡å°‘ï¼š80%+
- Include æ“ä½œå‡å°‘ï¼š80%+
- å“åº”æ—¶é—´æ”¹å–„ï¼š40-60ms

---

#### ä»»åŠ¡ 5.4: å…¶ä»–ä»“å‚¨è¿ç§» (P1-P2, å·¥æ—¶: 8-12å°æ—¶)

æŒ‰ç›¸åŒæ¨¡å¼è¿ç§»ï¼š
- `UserRepository` (P1)
- `BattleRepository` (P2)
- `ActivityPlanRepository` (P2)

**å·¥ä½œé‡ä¼°ç®—**:

| ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | éš¾åº¦ |
|-----|---------|------|
| 5.1 CharacterRepository | 4-6h | â­â­â­ |
| 5.2 é™æ€é…ç½®æŸ¥è¯¢ | 6-8h | â­â­â­â­ |
| 5.3 GearInstanceRepository | 6-8h | â­â­â­â­ |
| 5.4 å…¶ä»–ä»“å‚¨ | 8-12h | â­â­â­ |
| **æ€»è®¡** | **24-34h** | **çº¦ 3-5 å·¥ä½œæ—¥** |

### éªŒæ”¶æ ‡å‡†

#### åŠŸèƒ½å®Œæ•´æ€§
- [x] CharacterRepository ä½¿ç”¨ç¼“å­˜
- [x] é™æ€é…ç½®å¯åŠ¨æ—¶åŠ è½½
- [x] GearInstanceRepository ä½¿ç”¨ç¼“å­˜
- [x] å…¶ä»–é«˜é¢‘ä»“å‚¨ä½¿ç”¨ç¼“å­˜
- [x] æ‰€æœ‰å†™å…¥æ“ä½œè§¦å‘ç¼“å­˜å¤±æ•ˆ
- [x] ç¼–è¯‘æˆåŠŸï¼Œé›¶é”™è¯¯

#### æ€§èƒ½æŒ‡æ ‡
- [x] æ•°æ®åº“è¯»å–å‡å°‘ 85%+
- [x] API å“åº”æ—¶é—´æ”¹å–„ 50%+
- [x] ç¼“å­˜å‘½ä¸­ç‡ > 80%

#### æµ‹è¯•è¦†ç›–
- [x] æ¯ä¸ªè¿ç§»æ¨¡å—çš„å•å…ƒæµ‹è¯•
- [x] é›†æˆæµ‹è¯•éªŒè¯ç¼“å­˜ä¸€è‡´æ€§
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## å®æ–½æ–¹æ¡ˆ - ä¸‹ç¯‡

### ç›®æ ‡

**Phase 6: ä¼˜åŒ–ã€ç›‘æ§ä¸æ–‡æ¡£å®Œå–„**

å®Œæˆæ€§èƒ½è°ƒä¼˜ã€ç›‘æ§åŸ‹ç‚¹ã€è¿ç»´å·¥å…·å’Œæ–‡æ¡£ã€‚

### æ ¸å¿ƒä»»åŠ¡

#### ä»»åŠ¡ 6.1: æ€§èƒ½ç›‘æ§ä¸æŒ‡æ ‡æ”¶é›† (å·¥æ—¶: 6-8å°æ—¶)

**ç›®æ ‡**: æ‰©å±• DatabaseMetricsCollector æ”¯æŒè¯»ç¼“å­˜æŒ‡æ ‡

**æ–°å¢æŒ‡æ ‡**:

```csharp
public class DatabaseMetricsCollector
{
    // ... ç°æœ‰ä»£ç  ...
    
    // === æ–°å¢ï¼šè¯»ç¼“å­˜æŒ‡æ ‡ ===
    
    /// <summary>
    /// è®°å½•ç¼“å­˜æ“ä½œ
    /// </summary>
    public void RecordCacheOperation(
        string cacheKey,
        CacheTier tier,
        bool isHit,
        long durationMs)
    {
        var operation = new CacheOperationRecord
        {
            CacheKey = cacheKey,
            Tier = tier,
            IsHit = isHit,
            DurationMs = durationMs,
            Timestamp = DateTime.UtcNow
        };
        
        _recentCacheOperations.Enqueue(operation);
        
        // ç»´æŠ¤é˜Ÿåˆ—å¤§å°
        while (_recentCacheOperations.Count > _options.MaxRecentOperations)
        {
            _recentCacheOperations.TryDequeue(out _);
        }
        
        if (_options.EnableDetailedLogging)
        {
            _logger.LogDebug(
                "ç¼“å­˜æ“ä½œ: Key={CacheKey}, Tier={Tier}, Hit={IsHit}, Duration={DurationMs}ms",
                cacheKey, tier, isHit, durationMs
            );
        }
    }
    
    /// <summary>
    /// è·å–ç¼“å­˜ç»Ÿè®¡æ‘˜è¦
    /// </summary>
    public CacheStatisticsSummary GetCacheStatistics(TimeSpan? timeWindow = null)
    {
        var window = timeWindow ?? TimeSpan.FromMinutes(_options.DefaultTimeWindowMinutes);
        var cutoff = DateTime.UtcNow - window;
        
        var recentOps = _recentCacheOperations
            .Where(op => op.Timestamp >= cutoff)
            .ToList();
        
        if (!recentOps.Any())
        {
            return new CacheStatisticsSummary();
        }
        
        var hits = recentOps.Count(op => op.IsHit);
        var misses = recentOps.Count(op => !op.IsHit);
        
        return new CacheStatisticsSummary
        {
            TotalOperations = recentOps.Count,
            Hits = hits,
            Misses = misses,
            HitRate = (double)hits / recentOps.Count,
            AvgDurationMs = recentOps.Average(op => op.DurationMs),
            P95DurationMs = Percentile(recentOps.Select(op => op.DurationMs), 0.95),
            P99DurationMs = Percentile(recentOps.Select(op => op.DurationMs), 0.99),
            TierStatistics = recentOps
                .GroupBy(op => op.Tier)
                .ToDictionary(
                    g => g.Key,
                    g => new TierStatistics
                    {
                        TotalOps = g.Count(),
                        Hits = g.Count(op => op.IsHit),
                        HitRate = (double)g.Count(op => op.IsHit) / g.Count()
                    }
                )
        };
    }
}

public class CacheOperationRecord
{
    public string CacheKey { get; set; }
    public CacheTier Tier { get; set; }
    public bool IsHit { get; set; }
    public long DurationMs { get; set; }
    public DateTime Timestamp { get; set; }
}

public class CacheStatisticsSummary
{
    public int TotalOperations { get; set; }
    public int Hits { get; set; }
    public int Misses { get; set; }
    public double HitRate { get; set; }
    public double AvgDurationMs { get; set; }
    public double P95DurationMs { get; set; }
    public double P99DurationMs { get; set; }
    public Dictionary<CacheTier, TierStatistics> TierStatistics { get; set; }
}

public class TierStatistics
{
    public int TotalOps { get; set; }
    public int Hits { get; set; }
    public double HitRate { get; set; }
}
```

#### ä»»åŠ¡ 6.2: å¥åº·æ£€æŸ¥ API æ‰©å±• (å·¥æ—¶: 4-6å°æ—¶)

**ç›®æ ‡**: æ‰©å±• DatabaseHealthController æ”¯æŒè¯»ç¼“å­˜ç›‘æ§

**æ–°å¢ç«¯ç‚¹**:

```csharp
[ApiController]
[Route("api/database")]
public class DatabaseHealthController : ControllerBase
{
    // ... ç°æœ‰ä»£ç  ...
    
    /// <summary>
    /// è·å–è¯»ç¼“å­˜ç»Ÿè®¡
    /// </summary>
    [HttpGet("cache/statistics")]
    public ActionResult<CacheStatisticsSummary> GetCacheStatistics(
        [FromQuery] int? timeWindowMinutes = null)
    {
        var window = timeWindowMinutes.HasValue
            ? TimeSpan.FromMinutes(timeWindowMinutes.Value)
            : (TimeSpan?)null;
        
        var stats = _metricsCollector.GetCacheStatistics(window);
        
        return Ok(stats);
    }
    
    /// <summary>
    /// è·å–ç¼“å­˜å†…å®¹æ‘˜è¦
    /// </summary>
    [HttpGet("cache/content")]
    public ActionResult<CacheContentSummary> GetCacheContent()
    {
        var summary = _cacheManager.GetContentSummary();
        
        return Ok(new
        {
            TotalEntries = summary.TotalEntries,
            ByTier = summary.ByTier,
            ByEntityType = summary.ByEntityType,
            MemoryUsageEstimateMB = summary.MemoryUsageEstimateMB
        });
    }
    
    /// <summary>
    /// æ‰‹åŠ¨åˆ·æ–°é™æ€é…ç½®ç¼“å­˜
    /// </summary>
    [HttpPost("cache/reload-static")]
    public async Task<ActionResult> ReloadStaticCache()
    {
        await _staticConfigLoader.LoadAllConfigsAsync();
        
        return Ok(new { Message = "é™æ€é…ç½®å·²é‡æ–°åŠ è½½" });
    }
    
    /// <summary>
    /// æ‰‹åŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
    /// </summary>
    [HttpPost("cache/cleanup")]
    public ActionResult CleanupExpiredCache()
    {
        var removed = _cacheManager.CleanupExpired();
        
        return Ok(new { Message = $"å·²æ¸…ç† {removed} ä¸ªè¿‡æœŸç¼“å­˜é¡¹" });
    }
}
```

#### ä»»åŠ¡ 6.3: é…ç½®è°ƒä¼˜ä¸å‹åŠ›æµ‹è¯• (å·¥æ—¶: 8-12å°æ—¶)

**ç›®æ ‡**: é€šè¿‡å‹åŠ›æµ‹è¯•æ‰¾åˆ°æœ€ä½³é…ç½®å‚æ•°

**æµ‹è¯•åœºæ™¯**:

1. **å¹¶å‘ç”¨æˆ·æµ‹è¯•**
   - 100 å¹¶å‘ç”¨æˆ·
   - æ¯ç”¨æˆ· 10 æ¬¡ API è°ƒç”¨/åˆ†é’Ÿ
   - æŒç»­ 10 åˆ†é’Ÿ
   - è§‚å¯Ÿç¼“å­˜å‘½ä¸­ç‡å’Œå“åº”æ—¶é—´

2. **ç¼“å­˜ç©¿é€æµ‹è¯•**
   - æ¨¡æ‹Ÿå¤§é‡ä¸å­˜åœ¨çš„é”®æŸ¥è¯¢
   - éªŒè¯é˜²å‡»ç©¿æœºåˆ¶æœ‰æ•ˆæ€§

3. **ç¼“å­˜å¤±æ•ˆæµ‹è¯•**
   - é¢‘ç¹æ›´æ–°æ•°æ®
   - éªŒè¯ç¼“å­˜å¤±æ•ˆæœºåˆ¶æ­£ç¡®æ€§

4. **å†…å­˜å‹åŠ›æµ‹è¯•**
   - åŠ è½½å¤§é‡æ•°æ®
   - è§‚å¯Ÿ LRU æ¸…ç†æ˜¯å¦æ­£å¸¸
   - ç›‘æ§å†…å­˜ä½¿ç”¨

**è°ƒä¼˜å‚æ•°**:

```json
{
  "ReadCache": {
    "SessionCache": {
      "DefaultTtlMinutes": 30  // æ ¹æ®ä¼šè¯é•¿åº¦è°ƒæ•´
    },
    "EntityCache": {
      "DefaultTtlMinutes": 15,  // æ ¹æ®æ›´æ–°é¢‘ç‡è°ƒæ•´
      "MaxSize": 50000          // æ ¹æ®å†…å­˜é™åˆ¶è°ƒæ•´
    },
    "Performance": {
      "AntiCrashingSemaphoreTimeout": 5000  // æ ¹æ®æ•°æ®åº“å“åº”æ—¶é—´è°ƒæ•´
    }
  }
}
```

#### ä»»åŠ¡ 6.4: æ–‡æ¡£å®Œå–„ (å·¥æ—¶: 6-8å°æ—¶)

**ç›®æ ‡**: å®Œå–„è¿ç»´æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

**æ–‡æ¡£æ¸…å•**:

1. **è¯»ç¼“å­˜ä½¿ç”¨æŒ‡å—.md**
   - é…ç½®è¯´æ˜
   - ä½¿ç”¨ç¤ºä¾‹
   - æœ€ä½³å®è·µ

2. **è¯»ç¼“å­˜è¿ç»´æ‰‹å†Œ.md**
   - ç›‘æ§æŒ‡æ ‡è§£è¯»
   - å¸¸è§é—®é¢˜æ’æŸ¥
   - æ€§èƒ½è°ƒä¼˜æŒ‡å—

3. **è¯»ç¼“å­˜APIæ–‡æ¡£.md**
   - å¥åº·æ£€æŸ¥ç«¯ç‚¹è¯´æ˜
   - æ‰‹åŠ¨æ“ä½œæŒ‡å—

4. **è¯»ç¼“å­˜æ¶æ„æ–‡æ¡£.md**
   - æ¶æ„è®¾è®¡è¯´æ˜
   - ç»„ä»¶å…³ç³»å›¾
   - æ‰©å±•æŒ‡å—

### å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | éš¾åº¦ |
|-----|---------|------|
| 6.1 æ€§èƒ½ç›‘æ§ | 6-8h | â­â­â­ |
| 6.2 å¥åº·æ£€æŸ¥ API | 4-6h | â­â­ |
| 6.3 å‹åŠ›æµ‹è¯•ä¸è°ƒä¼˜ | 8-12h | â­â­â­â­ |
| 6.4 æ–‡æ¡£å®Œå–„ | 6-8h | â­â­ |
| **æ€»è®¡** | **24-34h** | **çº¦ 3-5 å·¥ä½œæ—¥** |

### éªŒæ”¶æ ‡å‡†

#### åŠŸèƒ½å®Œæ•´æ€§
- [x] ç¼“å­˜ç›‘æ§æŒ‡æ ‡å®Œæ•´
- [x] å¥åº·æ£€æŸ¥ API å¯ç”¨
- [x] å‹åŠ›æµ‹è¯•é€šè¿‡
- [x] æ–‡æ¡£é½å…¨

#### æ€§èƒ½æŒ‡æ ‡
- [x] ç¼“å­˜å‘½ä¸­ç‡ > 80%
- [x] API å“åº”æ—¶é—´ P95 æ”¹å–„ > 50%
- [x] æ•°æ®åº“è¯»å–å‡å°‘ > 85%

#### è¿ç»´æ”¯æŒ
- [x] æä¾›ç›‘æ§ä»ªè¡¨æ¿
- [x] æä¾›æ‰‹åŠ¨è¿ç»´å·¥å…·
- [x] æä¾›æ•…éšœæ’æŸ¥æŒ‡å—

---

## é£é™©è¯„ä¼°ä¸ç¼“è§£

### æŠ€æœ¯é£é™©

#### é£é™© 1: ç¼“å­˜ä¸æ•°æ®åº“ä¸ä¸€è‡´ âš ï¸âš ï¸âš ï¸

**é£é™©æè¿°**:
- æ›´æ–°æ•°æ®åº“åæœªå¤±æ•ˆç¼“å­˜
- å¹¶å‘æ›´æ–°å¯¼è‡´ç¼“å­˜è„è¯»

**å½±å“**:
- ç”¨æˆ·çœ‹åˆ°è¿‡æœŸæ•°æ®
- ä¸šåŠ¡é€»è¾‘é”™è¯¯

**ç¼“è§£æªæ–½**:
1. **äº‹åŠ¡çº§å¤±æ•ˆ**: æ•°æ®åº“äº‹åŠ¡æäº¤åç«‹å³å¤±æ•ˆç¼“å­˜
   ```csharp
   await using var transaction = await _db.Database.BeginTransactionAsync();
   try
   {
       // æ›´æ–°æ•°æ®åº“
       await _db.SaveChangesAsync();
       await transaction.CommitAsync();
       
       // å¤±æ•ˆç¼“å­˜
       await _invalidationCoordinator.OnEntityUpdatedAsync(entityType, id);
   }
   catch
   {
       await transaction.RollbackAsync();
       throw;
   }
   ```

2. **TTL ä¿æŠ¤**: å³ä½¿å¤±æ•ˆå¤±è´¥ï¼ŒTTL è¿‡æœŸä¹Ÿèƒ½æ¢å¤ä¸€è‡´æ€§

3. **ç‰ˆæœ¬å·æœºåˆ¶**ï¼ˆå¯é€‰ï¼Œå¤æ‚åœºæ™¯ï¼‰:
   ```csharp
   public class Character
   {
       public Guid Id { get; set; }
       public int Version { get; set; }  // æ¯æ¬¡æ›´æ–° +1
       // ... å…¶ä»–å±æ€§
   }
   
   // ç¼“å­˜æ—¶å¸¦ç‰ˆæœ¬å·
   await _cacheManager.SetAsync($"Character:{id}:{version}", character, ...);
   ```

4. **é…ç½®å¼€å…³**: å¯éšæ—¶ç¦ç”¨ç¼“å­˜å›é€€
   ```json
   { "ReadCache": { "EnableReadCache": false } }
   ```

**ç›‘æ§æŒ‡æ ‡**:
- ç¼“å­˜å¤±æ•ˆå¤±è´¥æ¬¡æ•°
- æ•°æ®ç‰ˆæœ¬å†²çªæ¬¡æ•°

---

#### é£é™© 2: å†…å­˜ä½¿ç”¨è¿‡é«˜ âš ï¸âš ï¸âš ï¸

**é£é™©æè¿°**:
- ç¼“å­˜æ•°æ®é‡è¿‡å¤§
- LRU æ¸…ç†ä¸åŠæ—¶

**å½±å“**:
- å†…å­˜æº¢å‡º
- GC å‹åŠ›å¢å¤§

**ç¼“è§£æªæ–½**:
1. **ä¸¥æ ¼çš„å®¹é‡é™åˆ¶**:
   ```json
   {
     "SessionCache": { "MaxSize": 10000 },
     "EntityCache": { "MaxSize": 50000 },
     "StaticCache": { "MaxSize": 50000 }
   }
   ```

2. **ä¸»åŠ¨å‹ç¼©**:
   ```csharp
   // è¾¾åˆ° MaxSize çš„ 80% æ—¶è§¦å‘å‹ç¼©
   if (_entityCache.Count > _options.EntityCache.MaxSize * 0.8)
   {
       CompactEntityCache();
   }
   ```

3. **å†…å­˜ç›‘æ§**:
   ```csharp
   var memoryUsage = GC.GetTotalMemory(false) / 1024 / 1024;  // MB
   if (memoryUsage > _options.MaxMemoryMB)
   {
       _logger.LogWarning("å†…å­˜ä½¿ç”¨è¿‡é«˜: {MemoryMB}MB", memoryUsage);
       // å¼ºåˆ¶æ¸…ç†
       _cacheManager.CleanupExpired();
   }
   ```

4. **åˆ†å±‚é™åˆ¶**: ä¸åŒå±‚çº§ä¸åŒä¸Šé™

**ç›‘æ§æŒ‡æ ‡**:
- æ€»å†…å­˜ä½¿ç”¨
- GC é¢‘ç‡
- ç¼“å­˜é¡¹æ•°é‡

---

#### é£é™© 3: ç¼“å­˜å‡»ç©¿ï¼ˆå¤§é‡å¹¶å‘æœªå‘½ä¸­ï¼‰ âš ï¸âš ï¸

**é£é™©æè¿°**:
- çƒ­ç‚¹æ•°æ®è¿‡æœŸç¬é—´
- å¤§é‡è¯·æ±‚åŒæ—¶æŸ¥æ•°æ®åº“

**å½±å“**:
- æ•°æ®åº“ç¬æ—¶å‹åŠ›æ¿€å¢
- å“åº”æ—¶é—´é£™å‡

**ç¼“è§£æªæ–½**:
1. **ä¿¡å·é‡ä¿æŠ¤** (å·²å®ç°):
   ```csharp
   var semaphore = _semaphores.GetOrAdd(cacheKey, _ => new SemaphoreSlim(1, 1));
   await semaphore.WaitAsync();
   try
   {
       // åŒé‡æ£€æŸ¥ + åŠ è½½
   }
   finally
   {
       semaphore.Release();
   }
   ```

2. **é¢„åŠ è½½çƒ­ç‚¹æ•°æ®**:
   ```csharp
   // å¯åŠ¨æ—¶é¢„åŠ è½½å‰ 100 ä¸ªæ´»è·ƒè§’è‰²
   var activeCharacters = await _db.Characters
       .OrderByDescending(c => c.LastSeenAtUtc)
       .Take(100)
       .ToListAsync();
   
   foreach (var c in activeCharacters)
   {
       await _cacheManager.SetAsync($"Character:{c.Id}", c, CacheTier.Session);
   }
   ```

3. **è½¯è¿‡æœŸ**ï¼ˆå¯é€‰ï¼‰:
   ```csharp
   // è¿‡æœŸå‰ 1 åˆ†é’Ÿå¼‚æ­¥åˆ·æ–°
   if (entry.ExpiresAt - DateTime.UtcNow < TimeSpan.FromMinutes(1))
   {
       _ = Task.Run(() => RefreshCacheAsync(cacheKey));
   }
   ```

**ç›‘æ§æŒ‡æ ‡**:
- ä¿¡å·é‡ç­‰å¾…æ¬¡æ•°
- å•é”®å¹¶å‘è¯·æ±‚æ•°

---

#### é£é™© 4: é…ç½®é”™è¯¯å¯¼è‡´åŠŸèƒ½å¼‚å¸¸ âš ï¸âš ï¸

**é£é™©æè¿°**:
- TTL è®¾ç½®è¿‡çŸ­å¯¼è‡´é¢‘ç¹å¤±æ•ˆ
- MaxSize è®¾ç½®è¿‡å°å¯¼è‡´é¢‘ç¹æ·˜æ±°

**å½±å“**:
- ç¼“å­˜å‘½ä¸­ç‡ä½
- æ€§èƒ½åè€Œä¸‹é™

**ç¼“è§£æªæ–½**:
1. **é…ç½®éªŒè¯**:
   ```csharp
   services.AddOptions<ReadCacheOptions>()
       .Bind(configuration.GetSection("ReadCache"))
       .ValidateDataAnnotations()
       .Validate(options =>
       {
           if (options.SessionCache.DefaultTtlMinutes < 5)
               return false;  // TTL ä¸èƒ½ä½äº 5 åˆ†é’Ÿ
           
           if (options.EntityCache.MaxSize < 1000)
               return false;  // MaxSize ä¸èƒ½ä½äº 1000
           
           return true;
       }, "Invalid ReadCache configuration")
       .ValidateOnStart();
   ```

2. **åˆç†é»˜è®¤å€¼**:
   ```csharp
   public class SessionCacheOptions
   {
       public int DefaultTtlMinutes { get; set; } = 30;  // é»˜è®¤ 30 åˆ†é’Ÿ
       public int MaxSize { get; set; } = 10000;         // é»˜è®¤ 10000
   }
   ```

3. **é…ç½®æ–‡æ¡£**: è¯¦ç»†è¯´æ˜æ¯ä¸ªå‚æ•°çš„æ¨èèŒƒå›´

**ç›‘æ§æŒ‡æ ‡**:
- ç¼“å­˜å‘½ä¸­ç‡ï¼ˆä½äº 60% è¯´æ˜é…ç½®å¯èƒ½æœ‰é—®é¢˜ï¼‰
- å¹³å‡ TTL å‘½ä¸­æ—¶é—´

---

### ä¸šåŠ¡é£é™©

#### é£é™© 5: ç¼“å­˜å¯¼è‡´æ•°æ®æ›´æ–°å»¶è¿Ÿ âš ï¸âš ï¸

**é£é™©æè¿°**:
- ç©å®¶ A æ›´æ–°è£…å¤‡
- ç©å®¶ B çœ‹åˆ°çš„æ˜¯æ—§æ•°æ®ï¼ˆç¼“å­˜æœªå¤±æ•ˆï¼‰

**å½±å“**:
- ç”¨æˆ·ä½“éªŒä¸‹é™
- å¯èƒ½çš„ä¸šåŠ¡é€»è¾‘é”™è¯¯

**ç¼“è§£æªæ–½**:
1. **ç«‹å³å¤±æ•ˆç­–ç•¥**: æ‰€æœ‰å†™å…¥æ“ä½œç«‹å³å¤±æ•ˆç›¸å…³ç¼“å­˜
2. **çŸ­ TTL**: å…³é”®æ•°æ® TTL ä¸è¶…è¿‡ 5-15 åˆ†é’Ÿ
3. **æ‰‹åŠ¨åˆ·æ–°**: æä¾› API è®©ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°
   ```csharp
   [HttpPost("characters/{id}/refresh-cache")]
   public async Task<ActionResult> RefreshCharacterCache(Guid id)
   {
       await _invalidationCoordinator.OnEntityUpdatedAsync("Character", id);
       return Ok();
   }
   ```

**å¯æ¥å—æ€§**: 
- å¯¹äºæ”¾ç½®æ¸¸æˆï¼Œ5-15 åˆ†é’Ÿçš„å»¶è¿Ÿé€šå¸¸æ˜¯å¯æ¥å—çš„
- å…³é”®æ“ä½œï¼ˆè´­ä¹°ã€è£…å¤‡ï¼‰ç«‹å³å¤±æ•ˆ

---

## æ€§èƒ½é¢„æœŸ

### æ•°æ®åº“è¯»å–æ¬¡æ•°å¯¹æ¯”

#### ä¼˜åŒ–å‰ï¼ˆå½“å‰ï¼‰

| æ“ä½œç±»å‹ | æ¯å°æ—¶è¯»å–æ¬¡æ•° |
|---------|--------------|
| è§’è‰²ä¿¡æ¯æŸ¥è¯¢ | ~18,000 |
| è£…å¤‡åˆ—è¡¨æŸ¥è¯¢ï¼ˆå« Includeï¼‰ | ~5,000 |
| é™æ€é…ç½®æŸ¥è¯¢ | ~5,000 |
| ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ | ~1,000 |
| æˆ˜æ–—è®°å½•æŸ¥è¯¢ | ~1,000 |
| å…¶ä»–æŸ¥è¯¢ | ~2,000 |
| **æ€»è®¡** | **~32,000** |

#### ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰

| æ“ä½œç±»å‹ | æ¯å°æ—¶è¯»å–æ¬¡æ•° | å‡å°‘æ¯”ä¾‹ |
|---------|--------------|---------|
| è§’è‰²ä¿¡æ¯æŸ¥è¯¢ | ~1,800 | **-90%** |
| è£…å¤‡åˆ—è¡¨æŸ¥è¯¢ | ~1,000 | **-80%** |
| é™æ€é…ç½®æŸ¥è¯¢ | ~0 (ä»…å¯åŠ¨æ—¶) | **-99%** |
| ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ | ~150 | **-85%** |
| æˆ˜æ–—è®°å½•æŸ¥è¯¢ | ~300 | **-70%** |
| å…¶ä»–æŸ¥è¯¢ | ~1,000 | **-50%** |
| **æ€»è®¡** | **~4,250** | **-86.7%** |

### API å“åº”æ—¶é—´å¯¹æ¯”

| ç«¯ç‚¹ | ä¼˜åŒ–å‰ P50 | ä¼˜åŒ–å P50 | æ”¹å–„ |
|-----|----------|-----------|------|
| GET /characters/{id} | 120ms | 50ms | **-58%** |
| GET /equipment/equipped | 200ms | 80ms | **-60%** |
| GET /battles/{id} | 180ms | 90ms | **-50%** |

### ç¼“å­˜å‘½ä¸­ç‡é¢„æœŸ

| ç¼“å­˜å±‚çº§ | é¢„æœŸå‘½ä¸­ç‡ | è¯´æ˜ |
|---------|-----------|------|
| L1 Session | **90-95%** | ä¼šè¯æœŸé—´é‡å¤æŸ¥è¯¢ |
| L2 Entity | **75-85%** | ä½é¢‘å˜æ›´æ•°æ® |
| L3 Static | **99%** | é™æ€é…ç½® |
| **ç»¼åˆ** | **85-90%** | åŠ æƒå¹³å‡ |

### èµ„æºæ¶ˆè€—é¢„æœŸ

#### å†…å­˜

```
é¢å¤–å†…å­˜æ¶ˆè€—:
- Session Cache (L1): ~20-50 MB
- Entity Cache (L2): ~50-150 MB
- Static Cache (L3): ~10-30 MB
- ç¼“å­˜ç®¡ç†å¼€é”€: ~10-20 MB
- æ€»è®¡: ~90-250 MB

å¯¹æ¯”: èŠ‚çœçš„æ•°æ®åº“ I/O ç­‰å¾…è¿œè¶…å†…å­˜æˆæœ¬
```

#### CPU

```
CPU ä½¿ç”¨ç‡:
- ç¼“å­˜æŸ¥è¯¢é¢å¤–å¼€é”€: <2%
- ç¼“å­˜å¤±æ•ˆå¤„ç†: <3%
- I/O ç­‰å¾…å‡å°‘èŠ‚çœ: 15-25%
- å‡€èŠ‚çœ: 10-20%
```

### æ•°æ®åº“è´Ÿè½½

```
æ•°æ®åº“è¿æ¥æ•°:
ä¼˜åŒ–å‰: å¹³å‡ 15-30 ä¸ªæ´»è·ƒè¿æ¥
ä¼˜åŒ–å: å¹³å‡ 3-8 ä¸ªæ´»è·ƒè¿æ¥
å‡å°‘: 60-75%

WAL æ–‡ä»¶å¢é•¿:
ä¼˜åŒ–å‰: ~1 MB/h
ä¼˜åŒ–å: ~0.3 MB/h
å‡å°‘: 70%
```

---

## éªŒæ”¶æ ‡å‡†

### ğŸ“‹ éªŒæ”¶æ–‡æ¡£

#### åŠŸèƒ½éªŒæ”¶

##### 1. æ ¸å¿ƒç»„ä»¶å®Œæ•´æ€§ âœ…

**éªŒæ”¶é¡¹**:
- [ ] MultiTierCacheManager å®ç°ä¸‰å±‚ç¼“å­˜ï¼ˆL1/L2/L3ï¼‰
- [ ] CacheAwareRepository åŸºç±»æä¾›ç»Ÿä¸€æ¥å£
- [ ] StaticConfigLoader å¯åŠ¨æ—¶åŠ è½½é…ç½®
- [ ] CacheInvalidationCoordinator ç®¡ç†å¤±æ•ˆé€»è¾‘
- [ ] æ‰€æœ‰ç»„ä»¶é€šè¿‡å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ > 80%ï¼‰

**éªŒæ”¶æ–¹æ³•**:
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
dotnet test --filter Category=ReadCache

# æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
```

**é€šè¿‡æ ‡å‡†**:
- æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ0 å¤±è´¥ï¼‰
- ä»£ç è¦†ç›–ç‡ > 80%
- æ— ç¼–è¯‘é”™è¯¯å’Œè­¦å‘Š

---

##### 2. Repository è¿ç§»å®Œæˆåº¦ âœ…

**éªŒæ”¶é¡¹**:
- [ ] CharacterRepository ä½¿ç”¨ç¼“å­˜
- [ ] GearInstanceRepository ä½¿ç”¨ç¼“å­˜
- [ ] GearDefinitionRepository ä½¿ç”¨é™æ€ç¼“å­˜
- [ ] AffixRepository ä½¿ç”¨é™æ€ç¼“å­˜
- [ ] UserRepository ä½¿ç”¨ç¼“å­˜
- [ ] BattleRepository ä½¿ç”¨ç¼“å­˜

**éªŒæ”¶æ–¹æ³•**:
```csharp
// é›†æˆæµ‹è¯•ï¼šéªŒè¯ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ
[Fact]
public async Task CharacterRepository_SecondRead_HitsCache()
{
    // Arrange
    var characterId = Guid.NewGuid();
    
    // Act
    var first = await _repository.GetAsync(characterId);  // ç¬¬ä¸€æ¬¡ï¼šæŸ¥æ•°æ®åº“
    var stats1 = _metricsCollector.GetCacheStatistics();
    
    var second = await _repository.GetAsync(characterId); // ç¬¬äºŒæ¬¡ï¼šåº”è¯¥å‘½ä¸­ç¼“å­˜
    var stats2 = _metricsCollector.GetCacheStatistics();
    
    // Assert
    Assert.Equal(stats1.Misses + 1, stats2.Misses);  // åªå¢åŠ  1 æ¬¡ miss
    Assert.Equal(stats1.Hits + 1, stats2.Hits);      // å¢åŠ  1 æ¬¡ hit
}
```

**é€šè¿‡æ ‡å‡†**:
- æ‰€æœ‰è¿ç§»çš„ Repository éƒ½æœ‰å¯¹åº”çš„ç¼“å­˜è£…é¥°å™¨
- é›†æˆæµ‹è¯•éªŒè¯ç¼“å­˜å‘½ä¸­
- æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—æ˜¾ç¤ºæŸ¥è¯¢æ¬¡æ•°å‡å°‘

---

##### 3. é…ç½®ç³»ç»Ÿå®Œæ•´æ€§ âœ…

**éªŒæ”¶é¡¹**:
- [ ] ReadCacheOptions é…ç½®ç±»å®Œæ•´
- [ ] æ‰€æœ‰å‚æ•°åœ¨ appsettings.json å¯é…ç½®
- [ ] é…ç½®éªŒè¯ç”Ÿæ•ˆï¼ˆDataAnnotationsï¼‰
- [ ] æ”¯æŒåˆ†ç¯å¢ƒé…ç½®ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
- [ ] ä¸»å¼€å…³ EnableReadCache å·¥ä½œæ­£å¸¸

**éªŒæ”¶æ–¹æ³•**:
```bash
# æµ‹è¯•é…ç½®åŠ è½½
dotnet run --environment Development
# æ£€æŸ¥æ—¥å¿—ï¼šé…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½

# æµ‹è¯•é…ç½®éªŒè¯
# ä¿®æ”¹ appsettings.json ä¸ºæ— æ•ˆå€¼ï¼ˆå¦‚ TTL=-1ï¼‰
# åº”ç”¨å¯åŠ¨æ—¶åº”è¯¥æŠ›å‡ºéªŒè¯é”™è¯¯
```

**é€šè¿‡æ ‡å‡†**:
- æ‰€æœ‰é…ç½®å‚æ•°å¯åœ¨ appsettings.json ä¿®æ”¹
- æ— æ•ˆé…ç½®å¯¼è‡´å¯åŠ¨å¤±è´¥ï¼ˆéªŒè¯ç”Ÿæ•ˆï¼‰
- ä¸åŒç¯å¢ƒå¯ä½¿ç”¨ä¸åŒé…ç½®

---

##### 4. ç¼“å­˜å¤±æ•ˆæœºåˆ¶æ­£ç¡®æ€§ âœ…

**éªŒæ”¶é¡¹**:
- [ ] å®ä½“æ›´æ–°æ—¶è‡ªåŠ¨å¤±æ•ˆç¼“å­˜
- [ ] çº§è”å¤±æ•ˆæ­£ç¡®è§¦å‘
- [ ] æ‰‹åŠ¨å¤±æ•ˆ API å¯ç”¨
- [ ] æ‰¹é‡å¤±æ•ˆæ”¯æŒæ¨¡å¼åŒ¹é…

**éªŒæ”¶æ–¹æ³•**:
```csharp
[Fact]
public async Task OnGearChanged_InvalidatesRelatedCaches()
{
    // Arrange
    var characterId = Guid.NewGuid();
    var gearId = Guid.NewGuid();
    
    // é¢„åŠ è½½ç¼“å­˜
    await _gearRepository.GetByIdAsync(gearId);
    await _gearRepository.GetEquippedGearAsync(characterId);
    
    // Act: è§¦å‘è£…å¤‡å˜æ›´
    await _invalidationCoordinator.OnGearChangedAsync(characterId, gearId);
    
    // Assert: ç¼“å­˜åº”è¯¥è¢«å¤±æ•ˆï¼ˆä¸‹æ¬¡è¯»å–ä¼šé‡æ–°æŸ¥åº“ï¼‰
    var stats = _metricsCollector.GetCacheStatistics();
    // éªŒè¯å¤±æ•ˆè®°å½•...
}
```

**é€šè¿‡æ ‡å‡†**:
- æ›´æ–°æ“ä½œåï¼Œä¸‹æ¬¡è¯»å–é‡æ–°æŸ¥åº“
- çº§è”å¤±æ•ˆæµ‹è¯•é€šè¿‡
- æ‰‹åŠ¨å¤±æ•ˆ API è¿”å›æˆåŠŸ

---

#### æ€§èƒ½éªŒæ”¶

##### 1. æ•°æ®åº“è¯»å–æ¬¡æ•°å‡å°‘ âœ…

**éªŒæ”¶æŒ‡æ ‡**:
| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹é‡æ–¹æ³• |
|-----|------|---------|
| æ€»ä½“è¯»å–å‡å°‘ | â‰¥ 85% | å¯¹æ¯”ä¼˜åŒ–å‰åæ—¥å¿— |
| è§’è‰²æŸ¥è¯¢å‡å°‘ | â‰¥ 90% | ç»Ÿè®¡ Character è¡¨æŸ¥è¯¢æ¬¡æ•° |
| è£…å¤‡æŸ¥è¯¢å‡å°‘ | â‰¥ 80% | ç»Ÿè®¡ GearInstance è¡¨æŸ¥è¯¢æ¬¡æ•° |
| é…ç½®æŸ¥è¯¢å‡å°‘ | â‰¥ 95% | ç»Ÿè®¡ GearDefinition ç­‰è¡¨æŸ¥è¯¢æ¬¡æ•° |

**æµ‹é‡æ–¹æ³•**:
```sql
-- SQLite å¯ç”¨æŸ¥è¯¢æ—¥å¿—
-- è¿è¡Œç›¸åŒçš„æµ‹è¯•åœºæ™¯ï¼ˆ100 å¹¶å‘ç”¨æˆ·ï¼Œ10 åˆ†é’Ÿï¼‰
-- å¯¹æ¯”ä¼˜åŒ–å‰åçš„æŸ¥è¯¢æ¬¡æ•°

-- ç¤ºä¾‹ï¼šç»Ÿè®¡ Character è¡¨æŸ¥è¯¢æ¬¡æ•°
-- é€šè¿‡åº”ç”¨æ—¥å¿—æˆ– SQLite EXPLAIN QUERY PLAN
```

**éªŒæ”¶è„šæœ¬**:
```bash
#!/bin/bash
# æ€§èƒ½å¯¹æ¯”æµ‹è¯•è„šæœ¬

echo "=== ä¼˜åŒ–å‰æ€§èƒ½åŸºå‡† ==="
# ç¦ç”¨è¯»ç¼“å­˜
sed -i 's/"EnableReadCache": true/"EnableReadCache": false/' appsettings.json

# è¿è¡Œå‹åŠ›æµ‹è¯•
artillery run load-test.yml > before.log

# ç»Ÿè®¡æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
grep "ExecuteReader" before.log | wc -l

echo "=== ä¼˜åŒ–åæ€§èƒ½æµ‹è¯• ==="
# å¯ç”¨è¯»ç¼“å­˜
sed -i 's/"EnableReadCache": false/"EnableReadCache": true/' appsettings.json

# è¿è¡Œç›¸åŒå‹åŠ›æµ‹è¯•
artillery run load-test.yml > after.log

# ç»Ÿè®¡æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
grep "ExecuteReader" after.log | wc -l

# è®¡ç®—å‡å°‘æ¯”ä¾‹
```

**é€šè¿‡æ ‡å‡†**:
- æ€»ä½“è¯»å–å‡å°‘ â‰¥ 85%
- å„å­é¡¹è¾¾åˆ°ç›®æ ‡å‡å°‘æ¯”ä¾‹

---

##### 2. API å“åº”æ—¶é—´æ”¹å–„ âœ…

**éªŒæ”¶æŒ‡æ ‡**:
| ç«¯ç‚¹ | ä¼˜åŒ–å‰ P95 | ç›®æ ‡ P95 | æ”¹å–„æ¯”ä¾‹ |
|-----|----------|---------|---------|
| GET /characters/{id} | 200ms | â‰¤ 100ms | â‰¥ 50% |
| GET /equipment/equipped | 250ms | â‰¤ 120ms | â‰¥ 50% |
| GET /battles/{id} | 180ms | â‰¤ 100ms | â‰¥ 45% |

**æµ‹é‡æ–¹æ³•**:
```bash
# ä½¿ç”¨ Artillery æˆ– k6 è¿›è¡Œè´Ÿè½½æµ‹è¯•
artillery run artillery-config.yml

# æˆ–ä½¿ç”¨ k6
k6 run --vus 100 --duration 10m load-test.js
```

**artillery-config.yml ç¤ºä¾‹**:
```yaml
config:
  target: "http://localhost:5000"
  phases:
    - duration: 600  # 10 åˆ†é’Ÿ
      arrivalRate: 10  # æ¯ç§’ 10 ä¸ªæ–°ç”¨æˆ·
  processor: "./processor.js"
  
scenarios:
  - name: "è§’è‰²ä¿¡æ¯æŸ¥è¯¢"
    weight: 40
    flow:
      - get:
          url: "/api/characters/{{ characterId }}"
          
  - name: "è£…å¤‡æŸ¥è¯¢"
    weight: 30
    flow:
      - get:
          url: "/api/equipment/equipped?characterId={{ characterId }}"
          
  - name: "æˆ˜æ–—è®°å½•æŸ¥è¯¢"
    weight: 20
    flow:
      - get:
          url: "/api/battles/{{ battleId }}"
```

**é€šè¿‡æ ‡å‡†**:
- æ‰€æœ‰ç«¯ç‚¹ P95 å“åº”æ—¶é—´è¾¾åˆ°ç›®æ ‡
- P99 å“åº”æ—¶é—´æ”¹å–„ â‰¥ 40%
- æ— è¶…æ—¶é”™è¯¯

---

##### 3. ç¼“å­˜å‘½ä¸­ç‡ âœ…

**éªŒæ”¶æŒ‡æ ‡**:
| ç¼“å­˜å±‚çº§ | ç›®æ ‡å‘½ä¸­ç‡ |
|---------|-----------|
| L1 Session | â‰¥ 85% |
| L2 Entity | â‰¥ 75% |
| L3 Static | â‰¥ 95% |
| ç»¼åˆå‘½ä¸­ç‡ | â‰¥ 80% |

**æµ‹é‡æ–¹æ³•**:
```bash
# è¿è¡Œå‹åŠ›æµ‹è¯•åï¼Œè°ƒç”¨ç›‘æ§ API
curl http://localhost:5000/api/database/cache/statistics

# å“åº”ç¤ºä¾‹
{
  "totalOperations": 50000,
  "hits": 42500,
  "misses": 7500,
  "hitRate": 0.85,
  "tierStatistics": {
    "Session": { "totalOps": 20000, "hits": 19000, "hitRate": 0.95 },
    "Entity": { "totalOps": 25000, "hits": 19000, "hitRate": 0.76 },
    "Static": { "totalOps": 5000, "hits": 4900, "hitRate": 0.98 }
  }
}
```

**é€šè¿‡æ ‡å‡†**:
- ç»¼åˆå‘½ä¸­ç‡ â‰¥ 80%
- å„å±‚çº§å‘½ä¸­ç‡è¾¾åˆ°ç›®æ ‡
- æŒç»­è¿è¡Œ 1 å°æ—¶åå‘½ä¸­ç‡ç¨³å®š

---

##### 4. å†…å­˜ä½¿ç”¨å¯æ§ âœ…

**éªŒæ”¶æŒ‡æ ‡**:
| æŒ‡æ ‡ | ç›®æ ‡ |
|-----|------|
| é¢å¤–å†…å­˜æ¶ˆè€— | â‰¤ 300MB |
| å†…å­˜å¢é•¿ç‡ | < 5MB/å°æ—¶ |
| GC é¢‘ç‡å¢åŠ  | < 20% |

**æµ‹é‡æ–¹æ³•**:
```bash
# ä½¿ç”¨ dotnet-counters ç›‘æ§å†…å­˜
dotnet-counters monitor --process-id <pid> --counters System.Runtime

# å…³é”®æŒ‡æ ‡
# - GC Heap Size (MB)
# - Gen 0/1/2 GC Count
# - Working Set (MB)
```

**ç›‘æ§è„šæœ¬**:
```bash
#!/bin/bash
# memory-monitor.sh

PID=$(pgrep -f "BlazorIdle.Server")

echo "=== ä¼˜åŒ–å‰å†…å­˜åŸºå‡† ==="
# ç¦ç”¨è¯»ç¼“å­˜ï¼Œè¿è¡Œ 1 å°æ—¶
dotnet-counters collect --process-id $PID --format json -o before.json &
sleep 3600
pkill dotnet-counters

echo "=== ä¼˜åŒ–åå†…å­˜ç›‘æ§ ==="
# å¯ç”¨è¯»ç¼“å­˜ï¼Œè¿è¡Œ 1 å°æ—¶
dotnet-counters collect --process-id $PID --format json -o after.json &
sleep 3600
pkill dotnet-counters

# å¯¹æ¯”åˆ†æ
python analyze-memory.py before.json after.json
```

**é€šè¿‡æ ‡å‡†**:
- é¢å¤–å†…å­˜æ¶ˆè€—åœ¨å¯æ¥å—èŒƒå›´å†…
- æ— å†…å­˜æ³„æ¼ï¼ˆè¿è¡Œ 24 å°æ—¶å†…å­˜å¢é•¿ < 50MBï¼‰
- GC å‹åŠ›å¯æ§

---

#### ç›‘æ§ä¸è¿ç»´éªŒæ”¶

##### 1. ç›‘æ§æŒ‡æ ‡å®Œæ•´æ€§ âœ…

**éªŒæ”¶é¡¹**:
- [ ] ç¼“å­˜å‘½ä¸­ç‡å®æ—¶ç›‘æ§
- [ ] ç¼“å­˜æ“ä½œè€—æ—¶ç›‘æ§ï¼ˆP50/P95/P99ï¼‰
- [ ] å„å±‚çº§ç¼“å­˜ç»Ÿè®¡
- [ ] å¤±æ•ˆæ“ä½œç»Ÿè®¡
- [ ] å†…å­˜ä½¿ç”¨ç›‘æ§

**éªŒæ”¶æ–¹æ³•**:
```bash
# è°ƒç”¨ç›‘æ§ API
curl http://localhost:5000/api/database/cache/statistics
curl http://localhost:5000/api/database/cache/content
curl http://localhost:5000/api/database/metrics

# æ£€æŸ¥è¿”å›æ•°æ®æ˜¯å¦åŒ…å«æ‰€æœ‰æŒ‡æ ‡
```

**é€šè¿‡æ ‡å‡†**:
- æ‰€æœ‰ API è¿”å›æ­£ç¡®çš„ JSON æ•°æ®
- æŒ‡æ ‡æ•°æ®å‡†ç¡®ï¼ˆä¸æ—¥å¿—å¯¹æ¯”éªŒè¯ï¼‰
- å®æ—¶æ›´æ–°ï¼ˆåˆ·æ–°åæ•°æ®å˜åŒ–ï¼‰

---

##### 2. è¿ç»´å·¥å…·å¯ç”¨æ€§ âœ…

**éªŒæ”¶é¡¹**:
- [ ] æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ API
- [ ] æ¸…ç†è¿‡æœŸç¼“å­˜ API
- [ ] é‡æ–°åŠ è½½é™æ€é…ç½® API
- [ ] ç¼“å­˜å†…å®¹æŸ¥çœ‹ API
- [ ] å¥åº·æ£€æŸ¥ API

**éªŒæ”¶æ–¹æ³•**:
```bash
# æµ‹è¯•æ‰‹åŠ¨åˆ·æ–°
curl -X POST http://localhost:5000/api/database/cache/reload-static
# é¢„æœŸï¼šè¿”å›æˆåŠŸæ¶ˆæ¯

# æµ‹è¯•æ¸…ç†è¿‡æœŸç¼“å­˜
curl -X POST http://localhost:5000/api/database/cache/cleanup
# é¢„æœŸï¼šè¿”å›æ¸…ç†æ•°é‡

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:5000/api/database/health
# é¢„æœŸï¼šè¿”å› healthy çŠ¶æ€
```

**é€šè¿‡æ ‡å‡†**:
- æ‰€æœ‰è¿ç»´ API æ­£å¸¸å·¥ä½œ
- è¿”å›æœ‰æ„ä¹‰çš„å“åº”æ¶ˆæ¯
- æ“ä½œç”Ÿæ•ˆï¼ˆé€šè¿‡æ—¥å¿—éªŒè¯ï¼‰

---

##### 3. æ–‡æ¡£å®Œæ•´æ€§ âœ…

**éªŒæ”¶é¡¹**:
- [ ] æ•°æ®åº“è¯»å–ä¼˜åŒ–æ–¹æ¡ˆè¯¦ç»†åˆ†æ.mdï¼ˆæœ¬æ–‡æ¡£ï¼‰
- [ ] è¯»ç¼“å­˜ä½¿ç”¨æŒ‡å—.md
- [ ] è¯»ç¼“å­˜è¿ç»´æ‰‹å†Œ.md
- [ ] è¯»ç¼“å­˜APIæ–‡æ¡£.md
- [ ] è¯»ç¼“å­˜æ¶æ„æ–‡æ¡£.md
- [ ] ä»£ç å†…è”æ³¨é‡Šå®Œæ•´

**éªŒæ”¶æ–¹æ³•**:
```bash
# æ£€æŸ¥æ–‡æ¡£æ–‡ä»¶å­˜åœ¨
ls -la docs/ReadCache/

# æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§
grep -r "TODO" docs/ReadCache/  # åº”è¯¥æ—  TODO
grep -r "ç¤ºä¾‹" docs/ReadCache/  # åº”è¯¥æœ‰ä»£ç ç¤ºä¾‹
```

**é€šè¿‡æ ‡å‡†**:
- æ‰€æœ‰æ–‡æ¡£æ–‡ä»¶å­˜åœ¨
- æ–‡æ¡£å†…å®¹å®Œæ•´ï¼ˆæ—  TODOï¼‰
- åŒ…å«è¶³å¤Ÿçš„ç¤ºä¾‹ä»£ç 
- ä¸­è‹±æ–‡æ³¨é‡Šé½å…¨

---

#### ä»£ç è´¨é‡éªŒæ”¶

##### 1. ä»£ç è§„èŒƒ âœ…

**éªŒæ”¶é¡¹**:
- [ ] éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ
- [ ] è¯¦ç»†çš„ä¸­è‹±æ–‡æ³¨é‡Š
- [ ] å®Œæ•´çš„ XML æ–‡æ¡£æ³¨é‡Š
- [ ] ç¬¦åˆ DDD æ¶æ„
- [ ] æ— ä»£ç å¼‚å‘³

**éªŒæ”¶æ–¹æ³•**:
```bash
# ä»£ç é£æ ¼æ£€æŸ¥
dotnet format --verify-no-changes

# ä»£ç åˆ†æ
dotnet build /p:TreatWarningsAsErrors=true
```

**é€šè¿‡æ ‡å‡†**:
- dotnet format æ— éœ€ä¿®æ”¹
- ç¼–è¯‘æ— è­¦å‘Šï¼ˆWarnings = 0ï¼‰
- æ‰€æœ‰å…¬å…± API æœ‰ XML æ³¨é‡Š
- ä»£ç å®¡æŸ¥é€šè¿‡

---

##### 2. æµ‹è¯•è¦†ç›–ç‡ âœ…

**éªŒæ”¶æŒ‡æ ‡**:
| å±‚çº§ | ç›®æ ‡è¦†ç›–ç‡ |
|-----|-----------|
| æ ¸å¿ƒç¼“å­˜ç»„ä»¶ | â‰¥ 85% |
| Repository è£…é¥°å™¨ | â‰¥ 80% |
| å¤±æ•ˆåè°ƒå™¨ | â‰¥ 80% |
| é…ç½®åŠ è½½å™¨ | â‰¥ 75% |

**æµ‹é‡æ–¹æ³•**:
```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
dotnet test /p:CollectCoverage=true /p:CoverletOutput=./coverage/ /p:CoverletOutputFormat=cobertura

# ç”Ÿæˆ HTML æŠ¥å‘Š
reportgenerator -reports:./coverage/coverage.cobertura.xml -targetdir:./coverage/report

# æŸ¥çœ‹æŠ¥å‘Š
open ./coverage/report/index.html
```

**é€šè¿‡æ ‡å‡†**:
- æ•´ä½“è¦†ç›–ç‡ â‰¥ 80%
- æ ¸å¿ƒç»„ä»¶è¦†ç›–ç‡è¾¾åˆ°ç›®æ ‡
- æ— æœªæµ‹è¯•çš„å…³é”®è·¯å¾„

---

##### 3. æ€§èƒ½æµ‹è¯• âœ…

**éªŒæ”¶é¡¹**:
- [ ] å•å…ƒæ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] é›†æˆæ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] å‹åŠ›æµ‹è¯•é€šè¿‡
- [ ] ç¨³å®šæ€§æµ‹è¯•é€šè¿‡ï¼ˆ24å°æ—¶è¿è¡Œï¼‰

**æ€§èƒ½æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹**:
```csharp
[Fact]
public async Task MultiTierCacheManager_ConcurrentAccess_HandlesCorrectly()
{
    // æµ‹è¯•å¹¶å‘è®¿é—®æ€§èƒ½
    var tasks = Enumerable.Range(0, 1000)
        .Select(i => _cacheManager.GetOrLoadAsync(
            $"test-{i % 100}",  // 100 ä¸ªä¸åŒçš„é”®ï¼Œé‡å¤è®¿é—®
            async () => await Task.FromResult(new TestEntity()),
            CacheTier.Entity
        ))
        .ToArray();
    
    var sw = Stopwatch.StartNew();
    await Task.WhenAll(tasks);
    sw.Stop();
    
    // æ–­è¨€ï¼š1000 æ¬¡æ“ä½œåº”åœ¨åˆç†æ—¶é—´å†…å®Œæˆ
    Assert.True(sw.ElapsedMilliseconds < 5000, $"è€—æ—¶: {sw.ElapsedMilliseconds}ms");
    
    // éªŒè¯ç¼“å­˜å‘½ä¸­ç‡
    var stats = _cacheManager.GetStatistics();
    Assert.True(stats.HitRate > 0.8, $"å‘½ä¸­ç‡: {stats.HitRate:P}");
}
```

**é€šè¿‡æ ‡å‡†**:
- æ‰€æœ‰æ€§èƒ½æµ‹è¯•é€šè¿‡
- å¹¶å‘è®¿é—®æ— æ­»é”
- 24 å°æ—¶è¿è¡Œæ— å´©æºƒ

---

### ğŸ“Š éªŒæ”¶æŠ¥å‘Šæ¨¡æ¿

#### éªŒæ”¶æŠ¥å‘Šï¼šæ•°æ®åº“è¯»å–ä¼˜åŒ–é¡¹ç›®

**é¡¹ç›®åç§°**: BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–  
**éªŒæ”¶æ—¥æœŸ**: YYYY-MM-DD  
**éªŒæ”¶äººå‘˜**: [å§“å]  
**é¡¹ç›®çŠ¶æ€**: âœ… é€šè¿‡ / âš ï¸ éƒ¨åˆ†é€šè¿‡ / âŒ ä¸é€šè¿‡

---

#### ä¸€ã€åŠŸèƒ½éªŒæ”¶

| éªŒæ”¶é¡¹ | çŠ¶æ€ | å¤‡æ³¨ |
|-------|------|------|
| æ ¸å¿ƒç»„ä»¶å®Œæ•´æ€§ | âœ… / âŒ | |
| Repository è¿ç§»å®Œæˆåº¦ | âœ… / âŒ | |
| é…ç½®ç³»ç»Ÿå®Œæ•´æ€§ | âœ… / âŒ | |
| ç¼“å­˜å¤±æ•ˆæœºåˆ¶æ­£ç¡®æ€§ | âœ… / âŒ | |

**æ€»ä½“è¯„åˆ†**: ___/100

**è¯¦ç»†è¯´æ˜**:
- [æ ¸å¿ƒç»„ä»¶] ...
- [Repository è¿ç§»] ...
- [é…ç½®ç³»ç»Ÿ] ...
- [ç¼“å­˜å¤±æ•ˆ] ...

---

#### äºŒã€æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | è¾¾æˆç‡ | çŠ¶æ€ |
|-----|------|------|-------|------|
| æ•°æ®åº“è¯»å–å‡å°‘ | â‰¥85% | __% | __% | âœ…/âŒ |
| API å“åº”æ—¶é—´æ”¹å–„ (P95) | â‰¥50% | __% | __% | âœ…/âŒ |
| ç¼“å­˜å‘½ä¸­ç‡ | â‰¥80% | __% | __% | âœ…/âŒ |
| å†…å­˜é¢å¤–æ¶ˆè€— | â‰¤300MB | __MB | __% | âœ…/âŒ |

**æ€»ä½“è¯„åˆ†**: ___/100

**æ€§èƒ½æµ‹è¯•æ•°æ®**:

##### æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°å¯¹æ¯”
```
ä¼˜åŒ–å‰: 32,000 æ¬¡/å°æ—¶
ä¼˜åŒ–å: ____ æ¬¡/å°æ—¶
å‡å°‘æ¯”ä¾‹: ___%
```

##### API å“åº”æ—¶é—´å¯¹æ¯”
```
ç«¯ç‚¹: GET /characters/{id}
  ä¼˜åŒ–å‰ P95: ___ms
  ä¼˜åŒ–å P95: ___ms
  æ”¹å–„: ___%

ç«¯ç‚¹: GET /equipment/equipped
  ä¼˜åŒ–å‰ P95: ___ms
  ä¼˜åŒ–å P95: ___ms
  æ”¹å–„: ___%
```

##### ç¼“å­˜å‘½ä¸­ç‡
```
L1 Session: ___%
L2 Entity: ___%
L3 Static: ___%
ç»¼åˆ: ___%
```

---

#### ä¸‰ã€ç›‘æ§ä¸è¿ç»´éªŒæ”¶

| éªŒæ”¶é¡¹ | çŠ¶æ€ | å¤‡æ³¨ |
|-------|------|------|
| ç›‘æ§æŒ‡æ ‡å®Œæ•´æ€§ | âœ… / âŒ | |
| è¿ç»´å·¥å…·å¯ç”¨æ€§ | âœ… / âŒ | |
| æ–‡æ¡£å®Œæ•´æ€§ | âœ… / âŒ | |

**æ€»ä½“è¯„åˆ†**: ___/100

---

#### å››ã€ä»£ç è´¨é‡éªŒæ”¶

| éªŒæ”¶é¡¹ | çŠ¶æ€ | å¤‡æ³¨ |
|-------|------|------|
| ä»£ç è§„èŒƒ | âœ… / âŒ | |
| æµ‹è¯•è¦†ç›–ç‡ | âœ… / âŒ | è¦†ç›–ç‡: __% |
| æ€§èƒ½æµ‹è¯• | âœ… / âŒ | |

**æ€»ä½“è¯„åˆ†**: ___/100

---

#### äº”ã€ç»¼åˆè¯„å®š

**æ€»ä½“å¾—åˆ†**: ___/100

**è¯„å®šç­‰çº§**:
- [ ] ä¼˜ç§€ï¼ˆâ‰¥90åˆ†ï¼‰
- [ ] è‰¯å¥½ï¼ˆ80-89åˆ†ï¼‰
- [ ] åˆæ ¼ï¼ˆ70-79åˆ†ï¼‰
- [ ] ä¸åˆæ ¼ï¼ˆ<70åˆ†ï¼‰

**éªŒæ”¶ç»“è®º**:
- [ ] âœ… é€šè¿‡éªŒæ”¶ï¼Œå‡†äºˆä¸Šçº¿
- [ ] âš ï¸ éƒ¨åˆ†é€šè¿‡ï¼Œéœ€æ•´æ”¹åå†éªŒæ”¶
- [ ] âŒ ä¸é€šè¿‡ï¼Œéœ€é‡å¤§è¿”å·¥

**é—ç•™é—®é¢˜æ¸…å•**:
1. [é—®é¢˜æè¿°] - [ä¸¥é‡ç¨‹åº¦] - [è´£ä»»äºº] - [é¢„è®¡è§£å†³æ—¶é—´]
2. ...

**æ”¹è¿›å»ºè®®**:
1. ...
2. ...

---

**éªŒæ”¶äººç­¾å­—**: ___________  
**æ—¥æœŸ**: ___________

---

## æ€»ç»“

### é¡¹ç›®ä»·å€¼æ€»ç»“

#### æŠ€æœ¯ä»·å€¼

1. **æ˜¾è‘—é™ä½æ•°æ®åº“è´Ÿè½½**
   - è¯»å–æ¬¡æ•°å‡å°‘ 85-95%
   - æ•°æ®åº“è¿æ¥æ•°å‡å°‘ 60-75%
   - WAL æ–‡ä»¶å¢é•¿å‡å°‘ 70%

2. **å¤§å¹…æå‡å“åº”é€Ÿåº¦**
   - API å“åº”æ—¶é—´æ”¹å–„ 50-70%
   - P95 å»¶è¿Ÿé™ä½ 50ms+
   - ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

3. **å¢å¼ºç³»ç»Ÿå¯æ‰©å±•æ€§**
   - æ”¯æŒæ›´é«˜å¹¶å‘ï¼ˆ3-5å€ï¼‰
   - æ›´ä½çš„èµ„æºæ¶ˆè€—
   - æ›´å¥½çš„æ¨ªå‘æ‰©å±•èƒ½åŠ›

4. **å®Œæ•´çš„ç›‘æ§ä½“ç³»**
   - å®æ—¶ç¼“å­˜æŒ‡æ ‡
   - è¿ç»´å·¥å…·é½å…¨
   - é—®é¢˜å®šä½ä¾¿æ·

#### æ¶æ„ä»·å€¼

1. **æ¸…æ™°çš„åˆ†å±‚è®¾è®¡**
   - L1/L2/L3 ä¸‰å±‚ç¼“å­˜
   - èŒè´£æ˜ç¡®
   - æ˜“äºç»´æŠ¤

2. **çµæ´»çš„é…ç½®ç³»ç»Ÿ**
   - æ‰€æœ‰å‚æ•°å¯é…ç½®
   - æ”¯æŒåˆ†ç¯å¢ƒ
   - è¿è¡Œæ—¶å¯è°ƒ

3. **å®Œå–„çš„å¤±æ•ˆæœºåˆ¶**
   - è‡ªåŠ¨å¤±æ•ˆ
   - çº§è”å¤±æ•ˆ
   - æ‰‹åŠ¨å¤±æ•ˆ

4. **å‘åå…¼å®¹**
   - è£…é¥°å™¨æ¨¡å¼
   - é…ç½®å¼€å…³
   - å¯éšæ—¶å›é€€

#### ç®¡ç†ä»·å€¼

1. **è¯¦ç»†çš„å®æ–½è®¡åˆ’**
   - åˆ†ä¸Šä¸­ä¸‹ä¸‰ç¯‡
   - æ¯ä¸ªé˜¶æ®µå¯ç‹¬ç«‹éªŒæ”¶
   - é£é™©å¯æ§

2. **é‡åŒ–çš„éªŒæ”¶æ ‡å‡†**
   - æ˜ç¡®çš„æ€§èƒ½æŒ‡æ ‡
   - å¯æµ‹é‡çš„æ”¹è¿›
   - å®¢è§‚çš„è¯„å®š

3. **å®Œæ•´çš„æ–‡æ¡£ä½“ç³»**
   - æ–¹æ¡ˆåˆ†æ
   - å®æ–½æŒ‡å—
   - è¿ç»´æ‰‹å†Œ
   - éªŒæ”¶æ ‡å‡†

4. **å¯è¿½è¸ªçš„è¿›åº¦**
   - å·¥ä½œé‡ä¼°ç®—
   - é‡Œç¨‹ç¢‘æ˜ç¡®
   - äº¤ä»˜ç‰©æ¸…æ™°

### å®æ–½è·¯çº¿å›¾æ€»ç»“

```
Phase 4: è¯»ç¼“å­˜åŸºç¡€è®¾æ–½å»ºè®¾ï¼ˆä¸Šç¯‡ï¼‰
  â””â”€ å·¥æ—¶: 34-50h (5-7 å·¥ä½œæ—¥)
  â””â”€ äº¤ä»˜ç‰©: æ ¸å¿ƒç¼“å­˜ç»„ä»¶ã€é…ç½®ç³»ç»Ÿã€å•å…ƒæµ‹è¯•
  â””â”€ é£é™©: ä¸­

Phase 5: é€æ­¥è¿ç§»é«˜é¢‘è¯»å–æ“ä½œï¼ˆä¸­ç¯‡ï¼‰
  â””â”€ å·¥æ—¶: 24-34h (3-5 å·¥ä½œæ—¥)
  â””â”€ äº¤ä»˜ç‰©: Repository ç¼“å­˜è£…é¥°å™¨ã€å¤±æ•ˆè§¦å‘ç‚¹
  â””â”€ é£é™©: ä¸­é«˜

Phase 6: ä¼˜åŒ–ã€ç›‘æ§ä¸æ–‡æ¡£å®Œå–„ï¼ˆä¸‹ç¯‡ï¼‰
  â””â”€ å·¥æ—¶: 24-34h (3-5 å·¥ä½œæ—¥)
  â””â”€ äº¤ä»˜ç‰©: ç›‘æ§æŒ‡æ ‡ã€è¿ç»´å·¥å…·ã€å®Œæ•´æ–‡æ¡£
  â””â”€ é£é™©: ä½

æ€»è®¡å·¥æ—¶: 82-118h (10-15 å·¥ä½œæ—¥)
```

### å…³é”®æˆåŠŸå› ç´ 

1. **åˆ†é˜¶æ®µå®æ–½**ï¼šæ¯ä¸ª Phase ç‹¬ç«‹å¯æµ‹ï¼Œé™ä½é£é™©
2. **å……åˆ†æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + å‹åŠ›æµ‹è¯•
3. **å®Œæ•´ç›‘æ§**ï¼šæ€§èƒ½æŒ‡æ ‡ + è¿ç»´å·¥å…·
4. **è¯¦ç»†æ–‡æ¡£**ï¼šä½¿ç”¨æŒ‡å— + è¿ç»´æ‰‹å†Œ + éªŒæ”¶æ ‡å‡†
5. **é…ç½®åŒ–**ï¼šæ‰€æœ‰å‚æ•°å¯è°ƒï¼Œä¾¿äºä¼˜åŒ–

### é£é™©æ§åˆ¶æªæ–½

1. **æŠ€æœ¯é£é™©**ï¼š
   - è£…é¥°å™¨æ¨¡å¼ä¿æŒå…¼å®¹æ€§
   - é…ç½®å¼€å…³æ”¯æŒå›é€€
   - å®Œå–„çš„å¤±æ•ˆæœºåˆ¶
   - ä¿¡å·é‡é˜²æ­¢ç¼“å­˜å‡»ç©¿

2. **æ€§èƒ½é£é™©**ï¼š
   - ä¸¥æ ¼çš„å®¹é‡é™åˆ¶
   - LRU è‡ªåŠ¨æ¸…ç†
   - å†…å­˜ç›‘æ§å‘Šè­¦
   - å‹åŠ›æµ‹è¯•éªŒè¯

3. **æ•°æ®ä¸€è‡´æ€§é£é™©**ï¼š
   - äº‹åŠ¡çº§å¤±æ•ˆ
   - TTL ä¿æŠ¤
   - ç‰ˆæœ¬å·æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
   - æ‰‹åŠ¨åˆ·æ–°æ¥å£

4. **ä¸šåŠ¡é£é™©**ï¼š
   - çŸ­ TTLï¼ˆå…³é”®æ•°æ®ï¼‰
   - ç«‹å³å¤±æ•ˆï¼ˆå…³é”®æ“ä½œï¼‰
   - æ‰‹åŠ¨åˆ·æ–°æ¥å£
   - ç”¨æˆ·å¯æ¥å—çš„å»¶è¿Ÿ

### åç»­ä¼˜åŒ–æ–¹å‘

1. **é«˜çº§ç¼“å­˜ç­–ç•¥**
   - å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆé˜²ç¼“å­˜ç©¿é€ï¼‰
   - é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
   - è½¯è¿‡æœŸï¼ˆå¼‚æ­¥åˆ·æ–°ï¼‰

2. **åˆ†å¸ƒå¼ç¼“å­˜**ï¼ˆå¤šæœåŠ¡å™¨åœºæ™¯ï¼‰
   - Redis ä½œä¸ºå…±äº«ç¼“å­˜
   - åˆ†å¸ƒå¼å¤±æ•ˆé€šçŸ¥
   - ä¸€è‡´æ€§å“ˆå¸Œ

3. **æ™ºèƒ½é¢„æµ‹**
   - åŸºäºè®¿é—®æ¨¡å¼çš„é¢„åŠ è½½
   - æ™ºèƒ½ TTL è°ƒæ•´
   - è‡ªé€‚åº”å®¹é‡

4. **æ›´ç»†ç²’åº¦çš„ç›‘æ§**
   - Prometheus + Grafana
   - å‘Šè­¦è§„åˆ™
   - æ€§èƒ½è¶‹åŠ¿åˆ†æ

---

## é™„å½•

### é™„å½• A: é…ç½®å‚æ•°é€ŸæŸ¥è¡¨

| å‚æ•°è·¯å¾„ | é»˜è®¤å€¼ | è¯´æ˜ | æ¨èèŒƒå›´ |
|---------|-------|------|---------|
| ReadCache:EnableReadCache | true | ä¸»å¼€å…³ | true/false |
| ReadCache:SessionCache:DefaultTtlMinutes | 30 | Session ç¼“å­˜ TTL | 15-60 |
| ReadCache:EntityCache:DefaultTtlMinutes | 15 | Entity ç¼“å­˜ TTL | 5-30 |
| ReadCache:EntityCache:MaxSize | 50000 | Entity ç¼“å­˜æœ€å¤§é¡¹æ•° | 10000-100000 |
| ReadCache:StaticCache:LoadOnStartup | true | å¯åŠ¨æ—¶åŠ è½½é™æ€é…ç½® | true |
| ReadCache:Performance:AntiCrashingSemaphoreTimeout | 5000 | é˜²å‡»ç©¿è¶…æ—¶ï¼ˆmsï¼‰ | 3000-10000 |

### é™„å½• B: ç›‘æ§æŒ‡æ ‡æ¸…å•

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|---------|------|------|---------|
| cache_hit_rate | Gauge | ç¼“å­˜å‘½ä¸­ç‡ | < 60% |
| cache_total_entries | Gauge | ç¼“å­˜æ€»é¡¹æ•° | > MaxSize * 0.9 |
| cache_memory_mb | Gauge | ç¼“å­˜å†…å­˜ä½¿ç”¨ï¼ˆMBï¼‰ | > 500MB |
| cache_operation_duration_p95 | Histogram | ç¼“å­˜æ“ä½œè€—æ—¶ P95 | > 50ms |
| cache_invalidation_count | Counter | å¤±æ•ˆæ“ä½œæ¬¡æ•° | - |
| database_query_count | Counter | æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•° | - |

### é™„å½• C: å¸¸è§é—®é¢˜ FAQ

**Q1: å¦‚ä½•ç¦ç”¨è¯»ç¼“å­˜ï¼Ÿ**

A: åœ¨ appsettings.json ä¸­è®¾ç½®ï¼š
```json
{
  "ReadCache": {
    "EnableReadCache": false
  }
}
```

**Q2: å¦‚ä½•æ‰‹åŠ¨åˆ·æ–°æŸä¸ªå®ä½“çš„ç¼“å­˜ï¼Ÿ**

A: è°ƒç”¨å¤±æ•ˆ APIï¼š
```bash
curl -X POST http://localhost:5000/api/database/cache/invalidate?key=Character:123e4567-...
```

**Q3: ç¼“å­˜å‘½ä¸­ç‡ä½äº 60% æ€ä¹ˆåŠï¼Ÿ**

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. TTL æ˜¯å¦è®¾ç½®è¿‡çŸ­
2. æ˜¯å¦æœ‰å¤§é‡å†·æ•°æ®æŸ¥è¯¢
3. å¤±æ•ˆæ˜¯å¦è¿‡äºé¢‘ç¹
4. MaxSize æ˜¯å¦è®¾ç½®è¿‡å°

**Q4: å†…å­˜ä½¿ç”¨è¿‡é«˜æ€ä¹ˆåŠï¼Ÿ**

A: è°ƒæ•´é…ç½®ï¼š
1. é™ä½ MaxSize
2. å¯ç”¨æ›´æ¿€è¿›çš„æ¸…ç†ç­–ç•¥
3. ç¼©çŸ­ TTL

**Q5: å¦‚ä½•éªŒè¯ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ**

A: 
1. æŸ¥çœ‹æ—¥å¿—ï¼šåº”è¯¥æœ‰ "ç¼“å­˜å‘½ä¸­" çš„æ—¥å¿—
2. è°ƒç”¨ç›‘æ§ APIï¼šæ£€æŸ¥å‘½ä¸­ç‡
3. æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—ï¼šæŸ¥è¯¢æ¬¡æ•°åº”è¯¥å‡å°‘

---

**æ–‡æ¡£çŠ¶æ€**: âœ… åˆ†æå®Œæˆ  
**ä¸‹ä¸€æ­¥**: ç­‰å¾…å®¡æ ¸ï¼Œæ‰¹å‡†åå¼€å§‹å®æ–½  
**é¢„è®¡å¯åŠ¨æ—¶é—´**: å®¡æ ¸é€šè¿‡å 1-2 ä¸ªå·¥ä½œæ—¥  
**é¢„è®¡å®Œæˆæ—¶é—´**: å¯åŠ¨å 10-15 ä¸ªå·¥ä½œæ—¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-19  
**æœ€åæ›´æ–°**: 2025-10-19  
**ä½œè€…**: æ•°æ®åº“ä¼˜åŒ–å›¢é˜Ÿ  
**å®¡æ ¸äºº**: å¾…å®š  
**æ‰¹å‡†äºº**: å¾…å®š
