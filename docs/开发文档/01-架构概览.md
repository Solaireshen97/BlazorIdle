# BlazorIdle 架构概览

**文档版本**: 1.0  
**创建日期**: 2025-10-15  
**维护者**: 开发团队  
**状态**: Phase 9 开发文档

---

## 📋 目录

1. [系统概述](#系统概述)
2. [技术栈](#技术栈)
3. [项目结构](#项目结构)
4. [架构设计](#架构设计)
5. [模块关系](#模块关系)
6. [数据流](#数据流)
7. [核心设计原则](#核心设计原则)

---

## 系统概述

BlazorIdle 是一款基于 Blazor WebAssembly 和 ASP.NET Core 的放置类 Web RPG 游戏。

### 核心特性

- **服务端权威**: 所有核心逻辑（战斗、掉落、经济）在服务端执行
- **实时通信**: 基于 SignalR 的实时双向通信
- **离线收益**: 支持离线时间补算，保证在线/离线体验一致性
- **事件驱动**: 基于事件时间跳跃的统一时间推进机制
- **数据驱动**: 配置化的游戏内容（技能、装备、商店等）
- **可扩展**: 模块化设计，便于功能扩展

### 游戏核心循环

| 循环类型 | 时间尺度 | 主要内容 |
|---------|---------|---------|
| 短循环 | 秒-分钟 | 战斗事件、技能释放、掉落获取 |
| 中循环 | 0.5-5小时 | 活动计划、装备获取、离线收益 |
| 长循环 | 天/周 | 任务完成、装备优化、系统解锁 |

---

## 技术栈

### 前端技术

- **Blazor WebAssembly** (.NET 8.0)
  - 组件化 UI 开发
  - C# 编写客户端逻辑
  - 与 .NET 生态无缝集成

- **SignalR Client**
  - 实时双向通信
  - 自动重连机制
  - 连接状态管理

- **CSS3 & Responsive Design**
  - 响应式布局
  - 组件隔离样式
  - 支持移动端和桌面端

### 后端技术

- **ASP.NET Core 9.0**
  - RESTful API
  - SignalR Hub
  - 依赖注入 (DI)
  - 中间件管道

- **Entity Framework Core 9.0**
  - Code-First 数据建模
  - SQLite 数据库
  - 迁移管理
  - 仓储模式

- **JWT 认证**
  - 无状态认证
  - Token 刷新
  - 角色权限管理

### 数据库

- **SQLite**
  - 轻量级嵌入式数据库
  - 文件存储 (gamedata.db)
  - 支持迁移和回滚

### 第三方库

- **BCrypt.Net-Next**: 密码哈希
- **Swashbuckle (Swagger)**: API 文档生成

---

## 项目结构

```
BlazorIdle/
├── BlazorIdle/                      # 前端 Blazor WebAssembly 项目
│   ├── Pages/                       # 页面组件
│   │   ├── Characters.razor         # 角色管理页面
│   │   ├── Index.razor              # 首页
│   │   └── ...
│   ├── Services/                    # 前端服务
│   ├── wwwroot/                     # 静态资源
│   └── Program.cs                   # 前端入口
│
├── BlazorIdle.Server/               # 后端 ASP.NET Core 项目
│   ├── Api/                         # API 控制器 (13个)
│   │   ├── CharactersController.cs
│   │   ├── BattlesController.cs
│   │   ├── EquipmentController.cs
│   │   ├── ShopController.cs
│   │   └── ...
│   │
│   ├── Application/                 # 应用层服务
│   │   ├── Activities/              # 活动计划服务
│   │   ├── Auth/                    # 认证服务
│   │   ├── Battles/                 # 战斗服务
│   │   │   ├── Offline/             # 离线战斗
│   │   │   ├── Simulation/          # 战斗模拟
│   │   │   └── Step/                # 步进战斗
│   │   ├── Economy/                 # 经济服务
│   │   ├── Inventory/               # 背包服务
│   │   └── Shop/                    # 商店服务
│   │
│   ├── Domain/                      # 领域层
│   │   ├── Activities/              # 活动计划领域模型
│   │   ├── Characters/              # 角色领域模型
│   │   ├── Combat/                  # 战斗系统 (核心模块)
│   │   │   ├── Engine/              # 战斗引擎
│   │   │   ├── Buffs/               # Buff系统
│   │   │   ├── Skills/              # 技能系统
│   │   │   ├── Damage/              # 伤害计算
│   │   │   ├── Professions/         # 职业系统
│   │   │   ├── Resources/           # 资源管理
│   │   │   └── ...
│   │   ├── Equipment/               # 装备系统
│   │   │   ├── Models/              # 装备模型
│   │   │   ├── Services/            # 装备服务
│   │   │   ├── Configuration/       # 装备配置
│   │   │   └── ...
│   │   ├── Shop/                    # 商店领域模型
│   │   └── Records/                 # 经济记录
│   │
│   ├── Infrastructure/              # 基础设施层
│   │   ├── Configuration/           # 配置选项类
│   │   ├── DependencyInjection/     # DI 注册
│   │   ├── Persistence/             # 数据持久化
│   │   │   ├── Configurations/      # EF配置
│   │   │   ├── Repositories/        # 仓储实现
│   │   │   └── Migrations/          # 数据库迁移
│   │   └── Startup/                 # 启动配置
│   │
│   ├── Hubs/                        # SignalR Hubs
│   │   └── BattleHub.cs             # 战斗消息推送
│   │
│   ├── Services/                    # 跨层服务
│   │   └── Filters/                 # 过滤器
│   │
│   ├── Config/                      # 配置文件目录
│   │   ├── Shop/                    # 商店配置
│   │   └── SignalR/                 # SignalR配置
│   │
│   ├── Program.cs                   # 后端入口
│   └── appsettings.json             # 应用配置
│
├── BlazorIdle.Shared/               # 共享项目
│   ├── Dtos/                        # 数据传输对象
│   └── Models/                      # 共享模型
│
├── tests/
│   └── BlazorIdle.Tests/            # 单元测试和集成测试
│
└── docs/                            # 项目文档
    ├── 开发文档/                     # 开发文档 (本目录)
    └── ...                          # 其他文档
```

---

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                   Blazor WebAssembly Client                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Pages/       │  │ Services/    │  │ SignalR      │      │
│  │ Components   │  │ HTTP Client  │  │ Client       │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
            │                    │                    │
            │ HTTP/REST          │                    │ WebSocket
            ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│                   ASP.NET Core Server                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ API          │  │ SignalR      │  │ Middleware   │      │
│  │ Controllers  │  │ Hubs         │  │ (Auth/CORS)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│            │                 │                               │
│            ▼                 ▼                               │
│  ┌────────────────────────────────────────────────┐         │
│  │         Application Services Layer             │         │
│  │  (Battles, Activities, Shop, Economy, etc.)    │         │
│  └────────────────────────────────────────────────┘         │
│                          │                                   │
│                          ▼                                   │
│  ┌────────────────────────────────────────────────┐         │
│  │           Domain Layer (Core Logic)            │         │
│  │  (Combat Engine, Equipment, Characters, etc.)  │         │
│  └────────────────────────────────────────────────┘         │
│                          │                                   │
│                          ▼                                   │
│  ┌────────────────────────────────────────────────┐         │
│  │      Infrastructure Layer (EF Core + Repos)    │         │
│  └────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
            ┌──────────────────────────┐
            │   SQLite Database        │
            │   (gamedata.db)          │
            └──────────────────────────┘
```

### 分层架构

#### 1. 表现层 (Presentation Layer)

- **职责**: 用户界面、交互逻辑、状态管理
- **技术**: Blazor Components, Razor Pages, CSS
- **特点**: 
  - 组件化开发
  - 响应式设计
  - 实时UI更新 (SignalR)

#### 2. API 层 (API Layer)

- **职责**: HTTP 端点、请求验证、响应格式化
- **技术**: ASP.NET Core Controllers
- **特点**:
  - RESTful 风格
  - JWT 认证授权
  - Swagger 文档

#### 3. 应用层 (Application Layer)

- **职责**: 用例编排、事务管理、DTO 转换
- **技术**: Application Services
- **特点**:
  - 协调领域对象
  - 无业务逻辑
  - 依赖注入

#### 4. 领域层 (Domain Layer)

- **职责**: 核心业务逻辑、领域模型、业务规则
- **技术**: Domain Models, Domain Services
- **特点**:
  - 独立于基础设施
  - 纯粹的业务逻辑
  - 高内聚低耦合

#### 5. 基础设施层 (Infrastructure Layer)

- **职责**: 数据访问、外部服务、配置管理
- **技术**: EF Core, Repositories
- **特点**:
  - 数据持久化
  - 配置加载
  - 依赖实现

---

## 模块关系

### 核心模块依赖图

```
┌──────────────┐
│   Combat     │◄─────┐
│   Engine     │      │
└──────────────┘      │
      │               │
      ▼               │
┌──────────────┐      │
│  Skills &    │      │
│  Buffs       │      │
└──────────────┘      │
                      │
┌──────────────┐      │
│  Equipment   │──────┤
│  System      │      │
└──────────────┘      │
      │               │
      ▼               │
┌──────────────┐      │
│  Character   │──────┘
│  Stats       │
└──────────────┘
      │
      ▼
┌──────────────┐
│  Activities  │
│  & Offline   │
└──────────────┘
      │
      ▼
┌──────────────┐
│  Economy &   │
│  Rewards     │
└──────────────┘
```

### 模块职责矩阵

| 模块 | 核心职责 | 主要类/文件 |
|------|---------|-----------|
| **Combat** | 战斗循环、事件调度、伤害计算 | BattleEngine, EventScheduler, DamageCalculator |
| **Skills** | 技能定义、释放逻辑、冷却管理 | SkillRegistry, SkillExecutor, CooldownTracker |
| **Buffs** | Buff效果、持续时间、刷新机制 | BuffSystem, BuffInstance, BuffTickEvent |
| **Equipment** | 装备属性、词条生成、套装效果 | EquipmentService, AffixGenerator, StatsAggregation |
| **Characters** | 角色状态、属性计算、职业系统 | Character, CharacterStats, Profession |
| **Activities** | 活动计划、槽位管理、限制条件 | ActivityPlan, ActivitySlot, LimitSpec |
| **Offline** | 离线补算、快进模拟、收益计算 | OfflineEngine, FastForward, SegmentGenerator |
| **Economy** | 货币管理、奖励发放、经济记录 | RewardService, EconomyEvent, CurrencyManager |
| **Shop** | 商店系统、刷新机制、购买限制 | ShopService, ShopDefinition, PurchaseValidator |
| **Inventory** | 背包管理、物品堆叠、容量限制 | InventoryService, InventorySlot, ItemStack |
| **Auth** | 用户认证、JWT生成、权限管理 | AuthService, JwtTokenGenerator, UserManager |

---

## 数据流

### 1. 战斗数据流

```
用户操作 (开始战斗)
    │
    ▼
API Controller (BattlesController)
    │
    ▼
Application Service (BattleService)
    │
    ▼
Domain: BattleEngine.StartBattle()
    │
    ├──► EventScheduler (调度攻击事件)
    │
    ├──► DamageCalculator (计算伤害)
    │
    ├──► BuffSystem (应用Buff效果)
    │
    ├──► RewardService (发放奖励)
    │
    ▼
Repository (保存战斗状态)
    │
    ▼
SignalR Hub (推送实时消息)
    │
    ▼
Client (更新UI)
```

### 2. 装备获取流程

```
战斗掉落
    │
    ▼
EquipmentGenerator
    │
    ├──► 确定品级 (Quality)
    │
    ├──► 生成词条 (Affixes)
    │
    ├──► 计算属性 (Stats)
    │
    ▼
Inventory Service
    │
    ├──► 检查容量
    │
    ├──► 添加到背包
    │
    ▼
保存到数据库
    │
    ▼
通知客户端
```

### 3. 离线补算流程

```
用户重新登录
    │
    ▼
检测离线时长
    │
    ▼
OfflineEngine.Simulate()
    │
    ├──► FastForward (快进战斗)
    │
    ├──► SegmentGenerator (生成收益段)
    │
    ├──► RewardAggregation (聚合奖励)
    │
    ▼
应用收益到角色
    │
    ▼
返回离线报告
```

---

## 核心设计原则

### 1. 服务端权威 (Server Authoritative)

- **原则**: 所有关键逻辑在服务端执行
- **原因**: 防止作弊、保证公平性、数据一致性
- **实现**: 
  - 战斗计算在服务端
  - 掉落由服务端随机
  - 客户端仅负责展示

### 2. 事件驱动 (Event-Driven)

- **原则**: 使用事件进行模块间通信
- **原因**: 降低耦合、提高可测试性
- **实现**:
  - EventScheduler (事件调度器)
  - Domain Events (领域事件)
  - SignalR Events (实时事件)

### 3. 数据驱动 (Data-Driven)

- **原则**: 游戏内容通过配置定义
- **原因**: 降低维护成本、快速调整平衡
- **实现**:
  - appsettings.json (系统配置)
  - Config/ 目录 (内容配置)
  - 热重载支持

### 4. 配置化优先 (Configuration First)

- **原则**: 避免硬编码，使用配置文件
- **原因**: 灵活调整、环境区分、快速迭代
- **实现**:
  - Options 模式 (IOptions\<T>)
  - 环境特定配置 (Development/Production)
  - 配置验证

**Phase 8 已完成**: 16个硬编码常量全部迁移到配置文件 ✅

### 5. 可测试性 (Testability)

- **原则**: 设计支持单元测试和集成测试
- **原因**: 保证代码质量、防止回归
- **实现**:
  - 依赖注入
  - 接口抽象
  - Mock/Fake 对象
  - 330+ 测试用例

### 6. 渐进式演进 (Progressive Evolution)

- **原则**: 分阶段实施，小步快跑
- **原因**: 降低风险、快速反馈、持续交付
- **实现**:
  - Phase 1-8 已完成
  - Phase 9 正在进行
  - 后续 Phase 10+ 规划中

---

## 相关文档

- [02-领域模型.md](./02-领域模型.md) - 领域模型详解
- [03-战斗系统.md](./03-战斗系统.md) - 战斗系统架构
- [04-装备系统.md](./04-装备系统.md) - 装备系统设计
- [07-配置指南.md](./07-配置指南.md) - 配置参数说明
- [09-开发规范.md](./09-开发规范.md) - 代码规范和最佳实践

---

**文档维护**:  
本文档作为 Phase 9 开发文档的一部分，应随项目演进持续更新。如有架构变更，请及时同步修改本文档。
