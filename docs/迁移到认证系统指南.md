# 迁移到认证系统指南

## 面向对象
本指南面向使用 BlazorIdle 旧版本（无认证系统）的开发者和用户，说明如何迁移到新的 JWT 认证系统。

## 好消息：完全向后兼容！

**你不需要做任何修改！**

新的认证系统完全向后兼容，所有现有功能继续正常工作。你可以选择何时启用认证功能。

## 现有功能不受影响

### ✅ 继续正常工作的功能

以下功能**不需要认证**，和之前一样使用：

- 创建角色（`POST /api/characters`）
- 获取角色信息（`GET /api/characters/{id}`）
- 战斗系统（`/api/battles/*`）
- 背包系统（`/api/inventory/*`）
- 活动计划（`/api/activity-plans/*`）
- 所有其他现有 API 端点

### 📊 数据库兼容

- 现有角色数据完全兼容（UserId 字段可空）
- 不需要迁移数据
- 不需要删除或修改现有角色

## 可选升级路径

如果你想使用新的认证功能，可以按需启用：

### 选项 1: 继续不使用认证（推荐用于测试/开发）

**什么都不用做！**继续按原来的方式使用 API。

```bash
# 像以前一样创建角色
curl -X POST http://localhost:5000/api/characters \
  -H "Content-Type: application/json" \
  -d '{"name":"TestChar","profession":0}'
```

### 选项 2: 开始使用认证（推荐用于生产环境）

#### 步骤 1: 注册用户

```bash
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "myuser",
    "email": "user@example.com",
    "password": "SecurePass123"
  }'
```

保存返回的 `token`。

#### 步骤 2: 使用 Token 创建角色

```bash
curl -X POST http://localhost:5000/api/characters \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {你的token}" \
  -d '{"name":"MyWarrior","profession":0}'
```

角色会自动绑定到你的账号！

#### 步骤 3: 查看你的角色

```bash
curl -X GET http://localhost:5000/api/users/me \
  -H "Authorization: Bearer {你的token}"
```

### 选项 3: 绑定现有角色到账号

如果你已经有角色，想绑定到新创建的账号：

```bash
# 1. 注册/登录获取 token
# 2. 绑定现有角色
curl -X PUT http://localhost:5000/api/characters/{角色ID}/bind-user \
  -H "Authorization: Bearer {你的token}"
```

## 客户端代码迁移

### 不使用认证（无需修改）

```javascript
// 旧代码继续工作
const response = await fetch('http://localhost:5000/api/characters', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ name: 'MyChar', profession: 0 })
});
```

### 使用认证（可选增强）

```javascript
// 1. 登录获取 token
async function login(username, password) {
  const response = await fetch('http://localhost:5000/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ usernameOrEmail: username, password })
  });
  const data = await response.json();
  localStorage.setItem('token', data.token);
  return data;
}

// 2. 创建角色时携带 token
async function createCharacter(name, profession) {
  const token = localStorage.getItem('token');
  const response = await fetch('http://localhost:5000/api/characters', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}` // 添加这一行
    },
    body: JSON.stringify({ name, profession })
  });
  return await response.json();
}
```

## 配置文件变更

### appsettings.json 新增配置

```json
{
  "Jwt": {
    "SecretKey": "YourSecretKeyHere-ChangeThisInProduction-MustBeAtLeast32CharactersLong!",
    "Issuer": "BlazorIdle.Server",
    "Audience": "BlazorIdle.Client",
    "ExpirationMinutes": 1440
  }
}
```

⚠️ **重要**: 如果部署到生产环境，必须修改 `SecretKey`！

### 不需要修改的配置

- 数据库连接字符串保持不变
- CORS 配置保持不变
- 其他现有配置保持不变

## 渐进式迁移策略

### 阶段 1: 测试阶段（推荐先在开发环境测试）

1. ✅ 更新代码到新版本
2. ✅ 运行现有功能测试（应该全部通过）
3. ✅ 测试新的认证 API
4. ✅ 验证向后兼容性

### 阶段 2: 可选启用阶段

1. 根据需求决定是否启用认证
2. 如果启用，更新客户端代码添加登录界面
3. 逐步迁移功能使用认证

### 阶段 3: 生产部署

1. 修改 `appsettings.json` 中的 JWT SecretKey
2. 启用 HTTPS（生产环境必须）
3. 部署更新

## FAQ

### Q: 我必须使用认证系统吗？
**A**: 不必须！认证是可选的。现有功能不受影响。

### Q: 已有的角色会怎样？
**A**: 完全不受影响。它们的 UserId 为 NULL，可以随时绑定到账号。

### Q: 我的客户端代码需要改吗？
**A**: 如果不使用认证功能，不需要改。如果要使用认证，只需添加 Authorization header。

### Q: 性能会受影响吗？
**A**: 不会。未认证的请求处理流程和以前完全一样。

### Q: 我可以混合使用吗（一部分角色绑定用户，一部分不绑定）？
**A**: 可以！系统完全支持这种混合模式。

### Q: 如何知道是否需要认证？
**A**: API 文档中标注了 `[Authorize]` 的端点需要认证。创建角色等操作不需要认证，但提供 token 后会自动绑定。

### Q: Token 过期了怎么办？
**A**: API 会返回 401 错误。重新登录获取新 token 即可。

## 回滚方案

如果遇到问题需要回滚：

### 数据库回滚
**不需要！**数据库架构向后兼容，无需回滚。

### 代码回滚
```bash
# 如果需要，可以回退到之前的提交
git checkout {之前的commit}
```

但通常不需要，因为新代码完全兼容旧用法。

## 获取帮助

如果在迁移过程中遇到问题：

1. 查看 [JWT认证系统文档](./JWT认证系统文档.md)
2. 查看 [API认证示例](./API认证示例.md)
3. 查看 [认证系统快速参考](./认证系统快速参考.md)
4. 提交 GitHub Issue

## 总结

- ✅ **零破坏性更新** - 现有功能完全不受影响
- ✅ **可选启用** - 根据需求决定是否使用认证
- ✅ **渐进式迁移** - 可以慢慢迁移功能
- ✅ **无数据迁移** - 数据库完全兼容
- ✅ **快速回滚** - 如有问题可立即回退

**建议**: 先在开发/测试环境验证，确认无问题后再部署生产环境。

---
更新时间: 2024-10-07
版本: v1.0
