# BlazorIdle æ•°æ®åº“ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸‹ç¯‡ï¼šä¼˜åŒ–å’Œå®Œå–„

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**é˜¶æ®µ**: Phase 3 - ä¼˜åŒ–å®Œå–„  
**é¢„è®¡å·¥æ—¶**: 32-48 å°æ—¶ï¼ˆ4-6 ä¸ªå·¥ä½œæ—¥ï¼‰  
**ä¼˜å…ˆçº§**: P2ï¼ˆè´¨é‡æå‡ï¼‰  
**ä¾èµ–**: ä¸­ç¯‡ï¼ˆåŠŸèƒ½è¿ç§»ï¼‰å®Œæˆ  

---

## ğŸ“‹ ç›®å½•

1. [é˜¶æ®µç›®æ ‡](#é˜¶æ®µç›®æ ‡)
2. [æ€§èƒ½è°ƒä¼˜](#æ€§èƒ½è°ƒä¼˜)
3. [ç›‘æ§å’Œè¯Šæ–­](#ç›‘æ§å’Œè¯Šæ–­)
4. [æ–‡æ¡£å®Œå–„](#æ–‡æ¡£å®Œå–„)
5. [è¿ç»´å·¥å…·](#è¿ç»´å·¥å…·)
6. [é•¿æœŸç»´æŠ¤è®¡åˆ’](#é•¿æœŸç»´æŠ¤è®¡åˆ’)

---

## é˜¶æ®µç›®æ ‡

### ä¸»è¦ç›®æ ‡

âœ… **æ€§èƒ½è°ƒä¼˜**
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- ä¼˜åŒ–æ‰¹é‡ä¿å­˜ç­–ç•¥
- å‡å°‘ GC å‹åŠ›

âœ… **ç›‘æ§å®Œå–„**
- æ·»åŠ å…³é”®æŒ‡æ ‡
- æ„å»ºç›‘æ§é¢æ¿
- è®¾ç½®å‘Šè­¦è§„åˆ™

âœ… **æ–‡æ¡£å®Œå–„**
- API æ–‡æ¡£æ›´æ–°
- è¿ç»´æ‰‹å†Œ
- æ•…éšœæ’æŸ¥æŒ‡å—

âœ… **è¿ç»´å·¥å…·**
- æ‰‹åŠ¨è§¦å‘ä¿å­˜å·¥å…·
- å†…å­˜çŠ¶æ€æŸ¥çœ‹å·¥å…·
- å¥åº·æ£€æŸ¥å·¥å…·

---

## æ€§èƒ½è°ƒä¼˜

### Task 3.1: å†…å­˜ä½¿ç”¨ä¼˜åŒ– â±ï¸ 8-12h

#### é—®é¢˜åˆ†æ

å†…å­˜ç¼“å†²å¯èƒ½å¯¼è‡´çš„é—®é¢˜ï¼š
1. é•¿æ—¶é—´è¿è¡Œç´¯ç§¯å¤§é‡å®ä½“
2. GC é¢‘ç¹è§¦å‘å½±å“æ€§èƒ½
3. å¤§å¯¹è±¡å †ï¼ˆLOHï¼‰ç¢ç‰‡åŒ–

#### ä¼˜åŒ–æªæ–½

**1. å®æ–½ LRU ç¼“å­˜æ¸…ç†** â±ï¸ 4-6h

```csharp
public class MemoryStateManager<T> where T : class, IEntity
{
    private readonly ConcurrentDictionary<Guid, T> _store;
    private readonly ConcurrentDictionary<Guid, DateTime> _accessTimes;
    private readonly MemoryCacheOptions _options;
    
    /// <summary>
    /// LRU æ¸…ç†ï¼šå½“å®ä½“æ•°è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œç§»é™¤æœ€ä¹…æœªè®¿é—®çš„å®ä½“
    /// </summary>
    private void EvictIfNeeded()
    {
        if (_store.Count <= _options.MaxCachedEntities)
            return;
            
        var evictCount = _store.Count - _options.MaxCachedEntities;
        
        var toEvict = _accessTimes
            .OrderBy(kv => kv.Value) // æœ€æ—©è®¿é—®çš„åœ¨å‰
            .Take(evictCount)
            .Select(kv => kv.Key)
            .ToList();
        
        foreach (var id in toEvict)
        {
            // å¦‚æœå®ä½“æ˜¯ Dirty çŠ¶æ€ï¼Œå…ˆä¿å­˜å†ç§»é™¤
            if (_dirtyEntities.ContainsKey(id))
            {
                _logger.LogWarning(
                    "æ­£åœ¨æ¸…ç† Dirty å®ä½“ {Id}ï¼Œå…ˆè§¦å‘ä¿å­˜",
                    id
                );
                // è§¦å‘ç«‹å³ä¿å­˜
                TriggerImmediateSaveAsync(id).Wait();
            }
            
            _store.TryRemove(id, out _);
            _accessTimes.TryRemove(id, out _);
            _dirtyEntities.TryRemove(id, out _);
        }
        
        _logger.LogInformation(
            "LRU æ¸…ç†å®Œæˆï¼šç§»é™¤ {Count} ä¸ªå®ä½“ï¼Œå½“å‰ç¼“å­˜ {Current} ä¸ª",
            toEvict.Count, _store.Count
        );
    }
    
    /// <summary>
    /// æ›´æ–°è®¿é—®æ—¶é—´ï¼ˆç”¨äº LRUï¼‰
    /// </summary>
    private void UpdateAccessTime(Guid id)
    {
        _accessTimes.AddOrUpdate(id, DateTime.UtcNow, (_, __) => DateTime.UtcNow);
    }
}
```

**2. å¯¹è±¡æ± åŒ–** â±ï¸ 2-3h

å¯¹é¢‘ç¹åˆ›å»ºé”€æ¯çš„å¯¹è±¡ä½¿ç”¨å¯¹è±¡æ± ï¼š

```csharp
public class BattleSnapshotPool
{
    private readonly ObjectPool<RunningBattleSnapshotRecord> _pool;
    
    public BattleSnapshotPool()
    {
        _pool = ObjectPool.Create<RunningBattleSnapshotRecord>();
    }
    
    public RunningBattleSnapshotRecord Rent()
    {
        var snapshot = _pool.Get();
        // é‡ç½®çŠ¶æ€
        snapshot.Reset();
        return snapshot;
    }
    
    public void Return(RunningBattleSnapshotRecord snapshot)
    {
        _pool.Return(snapshot);
    }
}
```

**3. å®šæœŸå†…å­˜å‹ç¼©** â±ï¸ 2-3h

```csharp
public class MemoryCompactionService : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            // æ¯å°æ—¶å‹ç¼©ä¸€æ¬¡
            await Task.Delay(TimeSpan.FromHours(1), stoppingToken);
            
            _logger.LogInformation("å¼€å§‹å†…å­˜å‹ç¼©...");
            
            // å¼ºåˆ¶ Gen2 GC
            GCSettings.LargeObjectHeapCompactionMode = GCLargeObjectHeapCompactionMode.CompactOnce;
            GC.Collect(2, GCCollectionMode.Forced, blocking: true, compacting: true);
            
            _logger.LogInformation("å†…å­˜å‹ç¼©å®Œæˆ");
        }
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] å†…å­˜å¢é•¿æ›²çº¿å¹³ç¨³ï¼ˆæ— æŒç»­å¢é•¿ï¼‰
- [ ] GC é¢‘ç‡åˆç†ï¼ˆ< 10 æ¬¡/åˆ†é’Ÿï¼‰
- [ ] å†…å­˜å³°å€¼ < 500MBï¼ˆ100 åœ¨çº¿ç©å®¶ï¼‰

---

### Task 3.2: æ‰¹é‡ä¿å­˜ç­–ç•¥ä¼˜åŒ– â±ï¸ 6-8h

#### é—®é¢˜åˆ†æ

å½“å‰æ‰¹é‡ä¿å­˜å¯èƒ½çš„é—®é¢˜ï¼š
1. å›ºå®šé—´éš”å¯èƒ½ä¸é€‚åº”åŠ¨æ€è´Ÿè½½
2. å¤§æ‰¹é‡ä¿å­˜å¯èƒ½å¯¼è‡´ç¬æ—¶å‹åŠ›
3. ä¸åŒå®ä½“ç±»å‹æ··åˆä¿å­˜æ•ˆç‡ä½

#### ä¼˜åŒ–æªæ–½

**1. åŠ¨æ€è°ƒæ•´ä¿å­˜é—´éš”** â±ï¸ 3-4h

```csharp
public class AdaptiveSaveIntervalCalculator
{
    private int _currentIntervalMs;
    private readonly int _minIntervalMs = 10000;  // æœ€å° 10 ç§’
    private readonly int _maxIntervalMs = 300000; // æœ€å¤§ 5 åˆ†é’Ÿ
    
    /// <summary>
    /// æ ¹æ® Dirty å®ä½“æ•°é‡åŠ¨æ€è°ƒæ•´ä¿å­˜é—´éš”
    /// ç­–ç•¥ï¼šå®ä½“è¶Šå¤šï¼Œé—´éš”è¶ŠçŸ­ï¼ˆæ›´é¢‘ç¹ä¿å­˜é¿å…ç§¯å‹ï¼‰
    /// </summary>
    public int CalculateNextInterval(int dirtyCount)
    {
        if (dirtyCount < 100)
        {
            // å°‘é‡å®ä½“ï¼Œå¯ä»¥ç­‰ä¹…ä¸€ç‚¹
            return _maxIntervalMs;
        }
        else if (dirtyCount < 1000)
        {
            // ä¸­ç­‰æ•°é‡ï¼Œé€‚ä¸­é—´éš”
            return 60000; // 1 åˆ†é’Ÿ
        }
        else if (dirtyCount < 5000)
        {
            // è¾ƒå¤šå®ä½“ï¼Œç¼©çŸ­é—´éš”
            return 30000; // 30 ç§’
        }
        else
        {
            // å¤§é‡å®ä½“ï¼Œé¢‘ç¹ä¿å­˜
            return _minIntervalMs; // 10 ç§’
        }
    }
}
```

**2. åˆ†æ‰¹æ¬¡ä¿å­˜ï¼ˆé¿å…ç¬æ—¶å‹åŠ›ï¼‰** â±ï¸ 2-3h

```csharp
private async Task SaveInBatchesAsync<T>(
    IEnumerable<(Guid, T)> entities,
    DbSet<T> dbSet,
    CancellationToken ct) where T : class, IEntity
{
    var batchSize = _options.MaxBatchSize;
    var batches = entities.Chunk(batchSize);
    
    foreach (var batch in batches)
    {
        // æ¯ä¸ªæ‰¹æ¬¡ä¹‹é—´ç¨å¾®å»¶è¿Ÿï¼Œé¿å…ç¬æ—¶å‹åŠ›
        await Task.Delay(50, ct);
        
        foreach (var (id, entity) in batch)
        {
            dbSet.Update(entity);
        }
        
        await DatabaseRetryPolicy.SaveChangesWithRetryAsync(
            dbSet.Context as GameDbContext, 
            ct, 
            _logger
        );
        
        _logger.LogDebug("å·²ä¿å­˜æ‰¹æ¬¡ï¼š{Count} ä¸ªå®ä½“", batch.Length);
    }
}
```

**3. ä¼˜å…ˆçº§ä¿å­˜é˜Ÿåˆ—** â±ï¸ 1-2h

```csharp
public enum SavePriority
{
    Low = 0,     // ç»Ÿè®¡æ•°æ®
    Normal = 1,  // å¸¸è§„æ•°æ®
    High = 2,    // è§’è‰²æ•°æ®
    Critical = 3 // å…³é”®æ“ä½œï¼ˆè´­ä¹°ã€äº¤æ˜“ï¼‰
}

public class PriorityQueue<T>
{
    private readonly SortedList<(SavePriority, DateTime), T> _queue;
    
    public void Enqueue(T item, SavePriority priority)
    {
        _queue.Add((priority, DateTime.UtcNow), item);
    }
    
    public IEnumerable<T> DequeueByPriority(int count)
    {
        return _queue
            .OrderByDescending(kv => kv.Key.Item1) // ä¼˜å…ˆçº§é«˜çš„å…ˆ
            .ThenBy(kv => kv.Key.Item2)             // åŒä¼˜å…ˆçº§æŒ‰æ—¶é—´
            .Take(count)
            .Select(kv => kv.Value);
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] ä¿å­˜é—´éš”åŠ¨æ€è°ƒæ•´æ­£å¸¸
- [ ] æ‰¹æ¬¡ä¿å­˜æ— ç¬æ—¶å‹åŠ›å³°å€¼
- [ ] é«˜ä¼˜å…ˆçº§å®ä½“ä¼˜å…ˆä¿å­˜

---

### Task 3.3: æ•°æ®åº“è¿æ¥ä¼˜åŒ– â±ï¸ 4-6h

#### ä¼˜åŒ–æªæ–½

**1. è¿æ¥æ± é…ç½®ä¼˜åŒ–**

```csharp
var connectionStringBuilder = new SqliteConnectionStringBuilder(conn)
{
    Mode = SqliteOpenMode.ReadWriteCreate,
    Cache = SqliteCacheMode.Shared,
    DefaultTimeout = 30,
    Pooling = true,              // å¯ç”¨è¿æ¥æ± 
    MaxPoolSize = 20,            // å¢åŠ è¿æ¥æ± å¤§å°
    ConnectionString = "..."
};
```

**2. æ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡**

```csharp
private async Task BatchSaveWithTransactionAsync<T>(
    IEnumerable<T> entities,
    GameDbContext db,
    CancellationToken ct) where T : class
{
    using var transaction = await db.Database.BeginTransactionAsync(ct);
    
    try
    {
        foreach (var entity in entities)
        {
            db.Set<T>().Update(entity);
        }
        
        await db.SaveChangesAsync(ct);
        await transaction.CommitAsync(ct);
        
        _logger.LogDebug("äº‹åŠ¡æäº¤æˆåŠŸï¼š{Count} ä¸ªå®ä½“", entities.Count());
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "äº‹åŠ¡ä¿å­˜å¤±è´¥ï¼Œå›æ»š");
        await transaction.RollbackAsync(ct);
        throw;
    }
}
```

**3. WAL æ¨¡å¼ä¼˜åŒ–**

```sql
-- ä¼˜åŒ– WAL é…ç½®
PRAGMA journal_mode = WAL;
PRAGMA wal_autocheckpoint = 1000;  -- æ¯ 1000 é¡µè‡ªåŠ¨æ£€æŸ¥ç‚¹
PRAGMA synchronous = NORMAL;        -- å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨
```

#### éªŒæ”¶æ ‡å‡†

- [ ] è¿æ¥æ± ä½¿ç”¨ç‡ < 80%
- [ ] æ•°æ®åº“é”ç­‰å¾…æ—¶é—´ < 10ms
- [ ] äº‹åŠ¡æˆåŠŸç‡ > 99.9%

---

## ç›‘æ§å’Œè¯Šæ–­

### Task 3.4: ç›‘æ§æŒ‡æ ‡ä½“ç³» â±ï¸ 8-12h

#### æ ¸å¿ƒç›‘æ§æŒ‡æ ‡

**1. æ•°æ®åº“æŒ‡æ ‡** â±ï¸ 2-3h

```csharp
public class DatabaseMetrics
{
    // å†™å…¥æŒ‡æ ‡
    public long SavesPerMinute { get; set; }
    public long TotalSavesCount { get; set; }
    public double AverageSaveDurationMs { get; set; }
    public long SaveFailureCount { get; set; }
    
    // è¯»å–æŒ‡æ ‡
    public long QueriesPerMinute { get; set; }
    public double AverageQueryDurationMs { get; set; }
    
    // è¿æ¥æŒ‡æ ‡
    public int ActiveConnections { get; set; }
    public int PooledConnections { get; set; }
    
    // WAL æŒ‡æ ‡
    public long WalFileSizeBytes { get; set; }
    public int WalCheckpointsCount { get; set; }
}
```

**2. å†…å­˜ç¼“å­˜æŒ‡æ ‡** â±ï¸ 2-3h

```csharp
public class MemoryCacheMetrics
{
    // ç¼“å­˜å¤§å°
    public int CachedCharactersCount { get; set; }
    public int CachedBattleSnapshotsCount { get; set; }
    public int CachedActivityPlansCount { get; set; }
    
    // Dirty è¿½è¸ª
    public int DirtyCharactersCount { get; set; }
    public int DirtyBattleSnapshotsCount { get; set; }
    public int DirtyActivityPlansCount { get; set; }
    
    // ç¼“å­˜æ•ˆç‡
    public long CacheHitCount { get; set; }
    public long CacheMissCount { get; set; }
    public double CacheHitRate => 
        CacheHitCount + CacheMissCount > 0 
            ? (double)CacheHitCount / (CacheHitCount + CacheMissCount) 
            : 0;
    
    // æ¸…ç†ç»Ÿè®¡
    public long EvictedEntitiesCount { get; set; }
    public DateTime LastEvictionTime { get; set; }
}
```

**3. æŒä¹…åŒ–åè°ƒå™¨æŒ‡æ ‡** â±ï¸ 2-3h

```csharp
public class PersistenceCoordinatorMetrics
{
    // ä¿å­˜ç»Ÿè®¡
    public long PeriodicSavesCount { get; set; }
    public long ForcedSavesCount { get; set; }
    public double AverageBatchSize { get; set; }
    public double AverageBatchDurationMs { get; set; }
    
    // æ€§èƒ½æŒ‡æ ‡
    public int CurrentSaveIntervalMs { get; set; }
    public DateTime LastSaveTime { get; set; }
    public DateTime NextScheduledSaveTime { get; set; }
    
    // é”™è¯¯ç»Ÿè®¡
    public long SaveErrorsCount { get; set; }
    public long RetryCount { get; set; }
}
```

**4. ç³»ç»Ÿèµ„æºæŒ‡æ ‡** â±ï¸ 2-3h

```csharp
public class SystemMetrics
{
    // å†…å­˜
    public long UsedMemoryMB { get; set; }
    public long Gen0CollectionCount { get; set; }
    public long Gen1CollectionCount { get; set; }
    public long Gen2CollectionCount { get; set; }
    
    // CPU
    public double CpuUsagePercent { get; set; }
    
    // çº¿ç¨‹
    public int ThreadCount { get; set; }
    public int ThreadPoolQueueLength { get; set; }
}
```

#### æŒ‡æ ‡æ”¶é›†æœåŠ¡

```csharp
public class MetricsCollectionService : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<MetricsCollectionService> _logger;
    private readonly ConcurrentDictionary<string, object> _metrics = new();
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            await Task.Delay(TimeSpan.FromSeconds(60), stoppingToken);
            
            await CollectMetricsAsync();
        }
    }
    
    private async Task CollectMetricsAsync()
    {
        using var scope = _scopeFactory.CreateScope();
        
        // æ”¶é›†å„ç±»æŒ‡æ ‡
        var dbMetrics = await CollectDatabaseMetricsAsync(scope);
        var cacheMetrics = CollectCacheMetrics(scope);
        var persistenceMetrics = CollectPersistenceMetrics(scope);
        var systemMetrics = CollectSystemMetrics();
        
        // å­˜å‚¨åˆ°å†…å­˜
        _metrics["database"] = dbMetrics;
        _metrics["cache"] = cacheMetrics;
        _metrics["persistence"] = persistenceMetrics;
        _metrics["system"] = systemMetrics;
        
        // è®°å½•åˆ°æ—¥å¿—
        _logger.LogInformation(
            "æŒ‡æ ‡æ”¶é›†å®Œæˆ - DBä¿å­˜: {Saves}/min, ç¼“å­˜å¤§å°: {CacheSize}, å†…å­˜: {Memory}MB",
            dbMetrics.SavesPerMinute,
            cacheMetrics.CachedCharactersCount,
            systemMetrics.UsedMemoryMB
        );
    }
    
    public T? GetMetrics<T>(string category) where T : class
    {
        return _metrics.TryGetValue(category, out var value) ? value as T : null;
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] æ‰€æœ‰æŒ‡æ ‡æ­£å¸¸æ”¶é›†
- [ ] æŒ‡æ ‡è®°å½•åˆ°æ—¥å¿—
- [ ] æŒ‡æ ‡å¯é€šè¿‡ API æŸ¥è¯¢

---

### Task 3.5: ç›‘æ§é¢æ¿å’Œå‘Šè­¦ â±ï¸ 6-8h

#### ç›‘æ§ API ç«¯ç‚¹

```csharp
[ApiController]
[Route("api/[controller]")]
public class MonitoringController : ControllerBase
{
    private readonly MetricsCollectionService _metricsService;
    
    /// <summary>
    /// è·å–æ‰€æœ‰ç›‘æ§æŒ‡æ ‡
    /// </summary>
    [HttpGet("metrics")]
    public IActionResult GetAllMetrics()
    {
        var metrics = new
        {
            Database = _metricsService.GetMetrics<DatabaseMetrics>("database"),
            Cache = _metricsService.GetMetrics<MemoryCacheMetrics>("cache"),
            Persistence = _metricsService.GetMetrics<PersistenceCoordinatorMetrics>("persistence"),
            System = _metricsService.GetMetrics<SystemMetrics>("system"),
            Timestamp = DateTime.UtcNow
        };
        
        return Ok(metrics);
    }
    
    /// <summary>
    /// è·å–å¥åº·çŠ¶æ€
    /// </summary>
    [HttpGet("health")]
    public IActionResult GetHealth()
    {
        var cacheMetrics = _metricsService.GetMetrics<MemoryCacheMetrics>("cache");
        var dbMetrics = _metricsService.GetMetrics<DatabaseMetrics>("database");
        
        var isHealthy = 
            cacheMetrics.CacheHitRate > 0.8 &&           // ç¼“å­˜å‘½ä¸­ç‡ > 80%
            dbMetrics.SavesPerMinute < 1000 &&           // æ•°æ®åº“å†™å…¥ < 1000/min
            dbMetrics.SaveFailureCount < 10;             // ä¿å­˜å¤±è´¥ < 10æ¬¡
        
        return Ok(new
        {
            Status = isHealthy ? "Healthy" : "Unhealthy",
            CacheHitRate = cacheMetrics.CacheHitRate,
            DatabaseSavesPerMinute = dbMetrics.SavesPerMinute,
            SaveFailures = dbMetrics.SaveFailureCount
        });
    }
}
```

#### å‘Šè­¦è§„åˆ™

```csharp
public class AlertingService : BackgroundService
{
    private readonly MetricsCollectionService _metricsService;
    private readonly ILogger<AlertingService> _logger;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
            
            await CheckAlertsAsync();
        }
    }
    
    private async Task CheckAlertsAsync()
    {
        var cacheMetrics = _metricsService.GetMetrics<MemoryCacheMetrics>("cache");
        var dbMetrics = _metricsService.GetMetrics<DatabaseMetrics>("database");
        var systemMetrics = _metricsService.GetMetrics<SystemMetrics>("system");
        
        // Alert 1: ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½
        if (cacheMetrics.CacheHitRate < 0.6)
        {
            _logger.LogWarning(
                "ã€å‘Šè­¦ã€‘ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½: {Rate:P}",
                cacheMetrics.CacheHitRate
            );
        }
        
        // Alert 2: æ•°æ®åº“ä¿å­˜é¢‘ç‡è¿‡é«˜
        if (dbMetrics.SavesPerMinute > 2000)
        {
            _logger.LogWarning(
                "ã€å‘Šè­¦ã€‘æ•°æ®åº“ä¿å­˜é¢‘ç‡è¿‡é«˜: {Count}/min",
                dbMetrics.SavesPerMinute
            );
        }
        
        // Alert 3: å†…å­˜ä½¿ç”¨è¿‡é«˜
        if (systemMetrics.UsedMemoryMB > 1000)
        {
            _logger.LogWarning(
                "ã€å‘Šè­¦ã€‘å†…å­˜ä½¿ç”¨è¿‡é«˜: {Memory}MB",
                systemMetrics.UsedMemoryMB
            );
        }
        
        // Alert 4: Dirty å®ä½“ç§¯å‹è¿‡å¤š
        var totalDirty = cacheMetrics.DirtyCharactersCount 
                       + cacheMetrics.DirtyBattleSnapshotsCount 
                       + cacheMetrics.DirtyActivityPlansCount;
        if (totalDirty > 10000)
        {
            _logger.LogWarning(
                "ã€å‘Šè­¦ã€‘Dirty å®ä½“ç§¯å‹è¿‡å¤š: {Count}",
                totalDirty
            );
        }
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] ç›‘æ§é¢æ¿å¯è®¿é—®
- [ ] æ‰€æœ‰æŒ‡æ ‡æ­£ç¡®æ˜¾ç¤º
- [ ] å‘Šè­¦è§„åˆ™æ­£å¸¸è§¦å‘

---

## æ–‡æ¡£å®Œå–„

### Task 3.6: æ–‡æ¡£æ›´æ–° â±ï¸ 6-8h

#### æ–‡æ¡£æ¸…å•

**1. API æ–‡æ¡£æ›´æ–°** â±ï¸ 2-3h

æ–‡ä»¶ï¼š`docs/APIæ–‡æ¡£.md`

å†…å®¹ï¼š
- æ–°å¢ç›‘æ§ API æ–‡æ¡£
- æ›´æ–°ç°æœ‰ API è¯´æ˜ï¼ˆè¡Œä¸ºå˜æ›´ï¼‰
- æ·»åŠ æ€§èƒ½æ³¨æ„äº‹é¡¹

**2. è¿ç»´æ‰‹å†Œ** â±ï¸ 2-3h

æ–‡ä»¶ï¼š`docs/æ•°æ®åº“ä¼˜åŒ–è¿ç»´æ‰‹å†Œ.md`

å†…å®¹ï¼š
```markdown
# æ•°æ®åº“ä¼˜åŒ–ç³»ç»Ÿè¿ç»´æ‰‹å†Œ

## ç³»ç»Ÿæ¶æ„

### å†…å­˜ç¼“å†²å±‚
- MemoryStateManagerï¼šå®ä½“å†…å­˜ç®¡ç†
- PersistenceCoordinatorï¼šå®šæœŸæ‰¹é‡ä¿å­˜
- EnhancedShutdownManagerï¼šä¼˜é›…å…³é—­

### é…ç½®è¯´æ˜

#### æŒä¹…åŒ–é…ç½®
...

#### ç›‘æ§é…ç½®
...

## æ—¥å¸¸è¿ç»´

### å¯åŠ¨æ£€æŸ¥æ¸…å•
- [ ] æ£€æŸ¥é…ç½®æ–‡ä»¶
- [ ] éªŒè¯æ•°æ®åº“è¿æ¥
- [ ] ç¡®è®¤å†…å­˜é™åˆ¶
- [ ] æŸ¥çœ‹å¯åŠ¨æ—¥å¿—

### ç›‘æ§æŒ‡æ ‡

#### æ­£å¸¸å€¼èŒƒå›´
- æ•°æ®åº“ä¿å­˜é¢‘ç‡: < 1000/min
- ç¼“å­˜å‘½ä¸­ç‡: > 80%
- å†…å­˜ä½¿ç”¨: < 500MB
- Dirty å®ä½“æ•°: < 5000

#### å¼‚å¸¸å¤„ç†
...

## æ•…éšœæ’æŸ¥

### åœºæ™¯ 1: å†…å­˜æŒç»­å¢é•¿
...

### åœºæ™¯ 2: æ•°æ®ä¿å­˜å¤±è´¥
...

### åœºæ™¯ 3: æ€§èƒ½ä¸‹é™
...

## å¤‡ä»½å’Œæ¢å¤

### å¤‡ä»½ç­–ç•¥
...

### æ¢å¤æµç¨‹
...
```

**3. é…ç½®æŒ‡å—** â±ï¸ 1-2h

æ–‡ä»¶ï¼š`docs/é…ç½®æŒ‡å—.md`

å†…å®¹ï¼š
- æ‰€æœ‰é…ç½®é¡¹è¯¦ç»†è¯´æ˜
- å…¸å‹åœºæ™¯é…ç½®ç¤ºä¾‹
- æ€§èƒ½è°ƒä¼˜å»ºè®®

**4. æ•…éšœæ’æŸ¥æŒ‡å—** â±ï¸ 1-2h

æ–‡ä»¶ï¼š`docs/æ•…éšœæ’æŸ¥æŒ‡å—.md`

å†…å®¹ï¼š
- å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- æ—¥å¿—åˆ†ææ–¹æ³•
- æ€§èƒ½è¯Šæ–­å·¥å…·ä½¿ç”¨

#### éªŒæ”¶æ ‡å‡†

- [ ] æ‰€æœ‰æ–‡æ¡£å®Œæ•´å‡†ç¡®
- [ ] æ–‡æ¡£æ ¼å¼ç»Ÿä¸€
- [ ] ç¤ºä¾‹ä»£ç å¯è¿è¡Œ

---

## è¿ç»´å·¥å…·

### Task 3.7: ç®¡ç†å·¥å…·å¼€å‘ â±ï¸ 6-8h

#### å·¥å…· 1: æ‰‹åŠ¨è§¦å‘ä¿å­˜

```csharp
[ApiController]
[Route("api/admin")]
[Authorize(Roles = "Admin")]
public class AdminController : ControllerBase
{
    private readonly PersistenceCoordinator _coordinator;
    
    /// <summary>
    /// æ‰‹åŠ¨è§¦å‘ä¿å­˜ï¼ˆç®¡ç†å‘˜å·¥å…·ï¼‰
    /// </summary>
    [HttpPost("trigger-save")]
    public async Task<IActionResult> TriggerSave()
    {
        _logger.LogInformation("ç®¡ç†å‘˜è§¦å‘æ‰‹åŠ¨ä¿å­˜");
        
        await _coordinator.TriggerImmediateSaveAsync();
        
        return Ok(new { message = "ä¿å­˜å·²è§¦å‘" });
    }
}
```

#### å·¥å…· 2: æŸ¥çœ‹å†…å­˜çŠ¶æ€

```csharp
[HttpGet("cache-status")]
[Authorize(Roles = "Admin")]
public IActionResult GetCacheStatus()
{
    var characterManager = GetService<MemoryStateManager<Character>>();
    var snapshotManager = GetService<MemoryStateManager<RunningBattleSnapshotRecord>>();
    var planManager = GetService<MemoryStateManager<ActivityPlan>>();
    
    var status = new
    {
        Characters = new
        {
            Total = characterManager.GetSnapshot().Count,
            Dirty = characterManager.GetDirtyEntities().Count()
        },
        BattleSnapshots = new
        {
            Total = snapshotManager.GetSnapshot().Count,
            Dirty = snapshotManager.GetDirtyEntities().Count()
        },
        ActivityPlans = new
        {
            Total = planManager.GetSnapshot().Count,
            Dirty = planManager.GetDirtyEntities().Count()
        }
    };
    
    return Ok(status);
}
```

#### å·¥å…· 3: æ¸…ç†ç¼“å­˜

```csharp
[HttpPost("clear-cache")]
[Authorize(Roles = "Admin")]
public async Task<IActionResult> ClearCache(
    [FromQuery] string entityType,
    [FromQuery] bool saveFirst = true)
{
    if (saveFirst)
    {
        _logger.LogInformation("æ¸…ç†ç¼“å­˜å‰å…ˆä¿å­˜æ•°æ®");
        await _coordinator.TriggerImmediateSaveAsync();
    }
    
    // æ¸…ç†æŒ‡å®šç±»å‹çš„ç¼“å­˜
    switch (entityType.ToLower())
    {
        case "characters":
            ClearCacheInternal<Character>();
            break;
        case "snapshots":
            ClearCacheInternal<RunningBattleSnapshotRecord>();
            break;
        case "plans":
            ClearCacheInternal<ActivityPlan>();
            break;
        default:
            return BadRequest("æœªçŸ¥çš„å®ä½“ç±»å‹");
    }
    
    return Ok(new { message = $"{entityType} ç¼“å­˜å·²æ¸…ç†" });
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] æ‰€æœ‰å·¥å…·æ­£å¸¸å·¥ä½œ
- [ ] å·¥å…·æœ‰æƒé™ä¿æŠ¤
- [ ] æ“ä½œæœ‰æ—¥å¿—è®°å½•

---

## é•¿æœŸç»´æŠ¤è®¡åˆ’

### å®šæœŸç»´æŠ¤ä»»åŠ¡

#### æ¯æ—¥
- [ ] æ£€æŸ¥ç›‘æ§æŒ‡æ ‡
- [ ] æŸ¥çœ‹é”™è¯¯æ—¥å¿—
- [ ] éªŒè¯å¤‡ä»½å®Œæ•´æ€§

#### æ¯å‘¨
- [ ] æ€§èƒ½æŠ¥å‘Šåˆ†æ
- [ ] æ•°æ®åº“å¤§å°æ£€æŸ¥
- [ ] WAL æ–‡ä»¶å¤§å°æ£€æŸ¥

#### æ¯æœˆ
- [ ] é…ç½®ä¼˜åŒ–è¯„å®¡
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] æ–‡æ¡£æ›´æ–°

### ä¼˜åŒ–è¿­ä»£è®¡åˆ’

**Q1 ä¼˜åŒ–é‡ç‚¹**ï¼š
- ç¨³å®šæ€§æå‡
- ç›‘æ§å®Œå–„
- æ–‡æ¡£å®Œå–„

**Q2 ä¼˜åŒ–é‡ç‚¹**ï¼š
- æ€§èƒ½è¿›ä¸€æ­¥è°ƒä¼˜
- æ‰©å±•æ€§æå‡
- æ–°åŠŸèƒ½æ”¯æŒ

**Q3 ä¼˜åŒ–é‡ç‚¹**ï¼š
- æ¶æ„æ¼”è¿›
- äº‘åŸç”Ÿæ”¹é€ 
- è‡ªåŠ¨åŒ–è¿ç»´

---

## éªŒæ”¶æ ‡å‡†

### æ€§èƒ½è¾¾æ ‡

- [ ] æ•°æ®åº“å†™å…¥å‡å°‘ > 95%
- [ ] API å“åº”æ—¶é—´æ”¹å–„ > 50%
- [ ] å†…å­˜ä½¿ç”¨ < 500MB
- [ ] CPU ä½¿ç”¨ç‡ < 40%

### ç›‘æ§å®Œå–„

- [ ] æ‰€æœ‰æ ¸å¿ƒæŒ‡æ ‡è¦†ç›–
- [ ] ç›‘æ§é¢æ¿å¯ç”¨
- [ ] å‘Šè­¦è§„åˆ™ç”Ÿæ•ˆ

### æ–‡æ¡£å®Œæ•´

- [ ] è¿ç»´æ‰‹å†Œå®Œæ•´
- [ ] æ•…éšœæ’æŸ¥æŒ‡å—å®Œæ•´
- [ ] é…ç½®æ–‡æ¡£å®Œæ•´

### å·¥å…·å¯ç”¨

- [ ] ç®¡ç†å·¥å…·æ­£å¸¸å·¥ä½œ
- [ ] æœ‰æƒé™ä¿æŠ¤
- [ ] æ“ä½œæœ‰æ—¥å¿—

---

## é¡¹ç›®æ€»ç»“

### æ•´ä½“æˆæœ

ç»è¿‡ä¸‰ä¸ªé˜¶æ®µçš„å®æ–½ï¼š

**ä¸Šç¯‡ï¼ˆåŸºç¡€è®¾æ–½ï¼‰**ï¼š
- âœ… å»ºç«‹å†…å­˜ç¼“å†²å±‚
- âœ… å®ç°æŒä¹…åŒ–åè°ƒå™¨
- âœ… å¢å¼ºä¼˜é›…å…³é—­

**ä¸­ç¯‡ï¼ˆåŠŸèƒ½è¿ç§»ï¼‰**ï¼š
- âœ… è¿ç§»é«˜é¢‘æ“ä½œåˆ°å†…å­˜
- âœ… æ•°æ®åº“å†™å…¥å‡å°‘ 97%+
- âœ… å“åº”æ—¶é—´æ”¹å–„ 50%+

**ä¸‹ç¯‡ï¼ˆä¼˜åŒ–å®Œå–„ï¼‰**ï¼š
- âœ… æ€§èƒ½è°ƒä¼˜
- âœ… ç›‘æ§ä½“ç³»
- âœ… æ–‡æ¡£å®Œå–„
- âœ… è¿ç»´å·¥å…·

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|-----|-------|-------|------|
| æ•°æ®åº“å†™å…¥/å°æ—¶ | ~100,000 | <3,000 | 97% â†“ |
| API å“åº”æ—¶é—´ P95 | 300ms | <100ms | 67% â†“ |
| å†…å­˜ä½¿ç”¨ | 200MB | ~350MB | +75% |
| å¹¶å‘æˆ˜æ–—æ•° | 15 | >50 | 3x â†‘ |
| ç³»ç»Ÿç¨³å®šæ€§ | è‰¯å¥½ | ä¼˜ç§€ | - |

### ç»éªŒæ€»ç»“

**æˆåŠŸç»éªŒ**ï¼š
1. æ¸è¿›å¼è¿ç§»é™ä½é£é™©
2. å……åˆ†æµ‹è¯•ä¿è¯è´¨é‡
3. é…ç½®åŒ–ä¾¿äºè°ƒä¼˜
4. å®Œå–„ç›‘æ§åŠæ—¶å‘ç°é—®é¢˜

**æ”¹è¿›å»ºè®®**ï¼š
1. æ›´æ—©å¼•å…¥æ€§èƒ½æµ‹è¯•
2. åŠ å¼ºæ–‡æ¡£å…ˆè¡Œ
3. é¢„ç•™æ›´å¤šç¼“å†²æ—¶é—´

### åç»­è§„åˆ’

1. **çŸ­æœŸï¼ˆ1-3 ä¸ªæœˆï¼‰**
   - æŒç»­ç›‘æ§å’Œä¼˜åŒ–
   - æ”¶é›†ç”¨æˆ·åé¦ˆ
   - å¾®è°ƒé…ç½®å‚æ•°

2. **ä¸­æœŸï¼ˆ3-6 ä¸ªæœˆï¼‰**
   - æ”¯æŒæ›´å¤šå®ä½“ç±»å‹
   - åˆ†å¸ƒå¼ç¼“å­˜æ–¹æ¡ˆæ¢ç´¢
   - äº‘åŸç”Ÿæ”¹é€ å‡†å¤‡

3. **é•¿æœŸï¼ˆ6-12 ä¸ªæœˆï¼‰**
   - æ¶æ„å‡çº§ï¼ˆå¾®æœåŠ¡åŒ–ï¼‰
   - æ°´å¹³æ‰©å±•æ”¯æŒ
   - å¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å¾…å®æ–½  
**ä¾èµ–**: ä¸­ç¯‡å®Œæˆ  
**é¢„è®¡å¼€å§‹**: ä¸­ç¯‡å®Œæˆå 1-2 å¤©  
**é¢„è®¡å®Œæˆ**: 4-6 ä¸ªå·¥ä½œæ—¥

---

**æ•´ä¸ªé¡¹ç›®å®Œæˆåï¼Œæ­å–œï¼ğŸ‰**  
æ‚¨çš„ BlazorIdle æœåŠ¡ç«¯æ•°æ®åº“æ“ä½œå°†å®ç°è´¨çš„é£è·ƒï¼
