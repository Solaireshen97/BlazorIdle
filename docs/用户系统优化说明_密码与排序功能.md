# 用户系统优化说明 - 密码与角色排序功能

## 更新日期
2025年10月7日

## 概述

本次更新对用户系统进行了两项重要增强，添加了密码功能和角色排序功能，同时保持了与现有代码的兼容性和一致性。

## 新增功能

### 1. 密码功能 (Password Feature)

#### 实现细节

**User 类新增字段**：
```csharp
/// <summary>
/// 密码哈希（使用 BCrypt 等安全哈希算法存储）
/// </summary>
public string PasswordHash { get; set; } = "";
```

**数据库字段**：
- 字段名：`PasswordHash`
- 类型：`VARCHAR(256)`
- 约束：`NOT NULL`
- 说明：使用 BCrypt 算法哈希存储，BCrypt 自动处理盐值（salt）

**EF Core 配置**：
```csharp
// 密码哈希：必填，最大长度 256（BCrypt 哈希通常为 60 字符，预留空间）
builder.Property(u => u.PasswordHash)
    .IsRequired()
    .HasMaxLength(256);
```

#### 使用方法

**1. 安装 BCrypt 包**：
```bash
dotnet add package BCrypt.Net-Next
```

**2. 注册用户时哈希密码**：
```csharp
var user = new User
{
    Id = Guid.NewGuid(),
    Username = "player123",
    Email = "player123@example.com",
    PasswordHash = BCrypt.Net.BCrypt.HashPassword("securePassword123"),
    CreatedAt = DateTime.UtcNow,
    UpdatedAt = DateTime.UtcNow
};

_db.Users.Add(user);
await _db.SaveChangesAsync();
```

**3. 登录时验证密码**：
```csharp
var user = await _db.Users
    .FirstOrDefaultAsync(u => u.Username == username);

if (user != null && BCrypt.Net.BCrypt.Verify(inputPassword, user.PasswordHash))
{
    // 密码正确，更新最后登录时间
    user.LastLoginAt = DateTime.UtcNow;
    await _db.SaveChangesAsync();
    
    // 登录成功逻辑...
}
```

#### 安全最佳实践

1. **永远不要存储明文密码**
2. **使用 BCrypt 算法**：
   - 自动生成和管理盐值
   - 每次哈希结果都不同（即使密码相同）
   - 计算成本可调节，防暴力破解
3. **密码强度要求**（建议）：
   - 最小长度：8 字符
   - 包含大小写字母、数字和特殊字符
   - 不使用常见密码
4. **添加登录失败次数限制**，防暴力破解

---

### 2. 角色排序功能 (Character Ordering)

#### 实现细节

**Character 类新增字段**：
```csharp
/// <summary>
/// 角色在用户 Roster 中的显示顺序（用于多角色管理）
/// </summary>
public int RosterOrder { get; set; } = 0;
```

**数据库字段**：
- 字段名：`RosterOrder`
- 类型：`INTEGER`
- 约束：`NOT NULL, DEFAULT 0`
- 说明：用于在 Roster 系统中管理角色显示顺序

**EF Core 配置**：
```csharp
// 角色在用户 Roster 中的显示顺序（默认为 0）
b.Property(x => x.RosterOrder)
    .HasDefaultValue(0);
    
// 复合索引，提升按用户和顺序查询的性能
b.HasIndex(x => new { x.UserId, x.RosterOrder });
```

#### 使用方法

**1. 创建角色时指定顺序**：
```csharp
// 获取用户下一个可用的顺序号
var nextOrder = await _db.Characters
    .Where(c => c.UserId == userId)
    .MaxAsync(c => (int?)c.RosterOrder) ?? -1;

var character = new Character
{
    Id = Guid.NewGuid(),
    UserId = userId,
    RosterOrder = nextOrder + 1,  // 自动递增
    Name = "勇者小明",
    Profession = Profession.Warrior,
    Level = 1
};

_db.Characters.Add(character);
await _db.SaveChangesAsync();
```

**2. 按顺序查询角色**：
```csharp
// 查询用户的所有角色，按 RosterOrder 排序
var characters = await _db.Characters
    .Where(c => c.UserId == userId)
    .OrderBy(c => c.RosterOrder)
    .ToListAsync();
```

**3. 调整角色顺序**：
```csharp
var characters = await _db.Characters
    .Where(c => c.UserId == userId)
    .OrderBy(c => c.RosterOrder)
    .ToListAsync();

// 将第三个角色移动到第一位
if (characters.Count >= 3)
{
    var characterToMove = characters[2];
    
    // 将其他角色向后移
    foreach (var c in characters.Take(2))
    {
        c.RosterOrder++;
    }
    
    // 将目标角色移到最前
    characterToMove.RosterOrder = 0;
    
    await _db.SaveChangesAsync();
}
```

#### 设计优势

1. **性能优化**：复合索引 `(UserId, RosterOrder)` 提升查询效率
2. **灵活性**：支持自由调整角色顺序
3. **可扩展性**：为 Roster 槽位系统预留基础
4. **向后兼容**：默认值为 0，不影响现有角色

---

## 数据库迁移

### 迁移名称
`20251007073221_AddPasswordAndRosterOrder`

### 迁移内容

```sql
-- 添加密码哈希字段到 users 表
ALTER TABLE users ADD COLUMN PasswordHash VARCHAR(256) NOT NULL DEFAULT '';

-- 添加角色顺序字段到 Characters 表
ALTER TABLE Characters ADD COLUMN RosterOrder INTEGER NOT NULL DEFAULT 0;

-- 创建复合索引
CREATE INDEX IX_Characters_UserId_RosterOrder ON Characters (UserId, RosterOrder);
```

### 应用迁移

```bash
cd BlazorIdle.Server
dotnet ef database update
```

---

## 建议的 API 端点

### 认证相关

- `POST /api/auth/register` - 用户注册（包含密码哈希）
- `POST /api/auth/login` - 用户登录（验证密码）
- `POST /api/auth/change-password` - 修改密码
- `POST /api/auth/reset-password` - 重置密码（需要邮箱验证）

### 角色管理相关

- `GET /api/users/{userId}/characters` - 获取用户角色（按 RosterOrder 排序）
- `POST /api/characters` - 创建角色（自动分配 RosterOrder）
- `PUT /api/characters/{id}/reorder` - 调整角色顺序
- `PUT /api/characters/batch-reorder` - 批量调整角色顺序

---

## 向后兼容性

### 现有数据处理

1. **密码字段**：
   - 现有用户的 `PasswordHash` 字段将被设置为空字符串
   - 建议添加"首次登录设置密码"功能
   - 或通过管理员为现有用户设置初始密码

2. **角色顺序字段**：
   - 现有角色的 `RosterOrder` 将被设置为 0
   - 不影响角色的功能性
   - 可以后续手动调整顺序

### 兼容性保证

- ✅ 不修改现有字段
- ✅ 不删除任何现有功能
- ✅ 新字段都有默认值
- ✅ 保持现有查询逻辑兼容
- ✅ 遵循项目现有代码风格

---

## 相关文件

### 领域模型
- `BlazorIdle.Server/Domain/Characters/User.cs` - 添加 PasswordHash 字段
- `BlazorIdle.Server/Domain/Characters/Character.cs` - 添加 RosterOrder 字段

### EF Core 配置
- `BlazorIdle.Server/Infrastructure/Persistence/Configurations/UserConfiguration.cs` - 密码字段配置
- `BlazorIdle.Server/Infrastructure/Persistence/Configurations/CharacterConfiguration.cs` - 顺序字段和索引配置

### 数据库迁移
- `BlazorIdle.Server/Migrations/20251007073221_AddPasswordAndRosterOrder.cs` - 迁移文件
- `BlazorIdle.Server/Migrations/20251007073221_AddPasswordAndRosterOrder.Designer.cs` - 迁移设计文件
- `BlazorIdle.Server/Migrations/GameDbContextModelSnapshot.cs` - 更新的模型快照

### 文档
- `docs/用户系统文档.md` - 完整的用户系统文档（已更新）
- `docs/用户系统优化说明_密码与排序功能.md` - 本文档

---

## 后续计划

### 短期（建议实现）

1. **密码功能完善**：
   - [ ] 实现用户注册 API（包含密码强度验证）
   - [ ] 实现用户登录 API（JWT 或 Cookie 认证）
   - [ ] 添加密码修改功能
   - [ ] 添加密码重置功能（邮箱验证）
   - [ ] 添加登录失败次数限制

2. **角色排序功能完善**：
   - [ ] 实现角色重新排序 API
   - [ ] 添加批量排序功能
   - [ ] 前端界面支持拖拽排序

### 中期（可选增强）

3. **安全增强**：
   - [ ] 实现两步验证（2FA）
   - [ ] 添加登录历史记录
   - [ ] 实现会话管理
   - [ ] 添加账号安全设置

4. **Roster 系统**：
   - [ ] 实现槽位解锁逻辑
   - [ ] 添加槽位上限配置
   - [ ] 实现角色切换功能
   - [ ] 添加账号级共享资源

---

## 总结

本次更新实现了两个核心功能：

1. **密码功能**：提供了安全的用户认证基础，使用 BCrypt 算法保证密码安全
2. **角色排序功能**：为多角色 Roster 系统提供了基础支持，支持灵活的角色管理

所有更新都遵循以下原则：
- ✅ 最小化变更
- ✅ 保持代码风格一致
- ✅ 向后兼容
- ✅ 性能优化（索引）
- ✅ 文档完整

代码已通过构建测试，可以安全部署。
