# 数据库读取优化 - 配置调优指南

**项目**: BlazorIdle 数据库读取优化  
**文档类型**: 运维配置指南  
**版本**: 1.0  
**最后更新**: 2025-10-19

---

## 📋 目录

1. [配置文件概览](#配置文件概览)
2. [缓存策略配置](#缓存策略配置)
3. [监控配置](#监控配置)
4. [性能调优](#性能调优)
5. [故障排查](#故障排查)
6. [最佳实践](#最佳实践)

---

## 配置文件概览

### 配置文件位置

```
BlazorIdle.Server/
├── appsettings.json                      # 基础配置（开发环境）
├── appsettings.Development.json          # 开发环境覆盖配置
├── appsettings.Production.json           # 生产环境覆盖配置
└── appsettings.Production.example.json   # 生产环境配置模板
```

### 配置节说明

| 配置节 | 用途 | 核心参数 |
|--------|------|----------|
| CacheConfiguration | 缓存策略配置 | EntityStrategies, GlobalSettings |
| Monitoring | 监控配置 | CacheMonitoring, MaxRecentOperations |
| Persistence | 持久化配置 | SaveIntervalMs, MaxBatchSize |
| MemoryCache | 内存缓存配置 | MaxCachedEntities, EvictionPolicy |

---

## 缓存策略配置

### 缓存策略类型

#### 1. Permanent（永久缓存）

**适用场景**: 静态配置数据，很少或从不改变
- GearDefinition（装备定义）
- Affix（词缀定义）
- GearSet（装备套装）

**配置示例**:
```json
{
  "GearDefinition": {
    "Strategy": "Permanent",
    "PreloadOnStartup": true,
    "PreloadBatchSize": 500,
    "MaxCachedCount": 10000,
    "TtlSeconds": 86400
  }
}
```

**参数说明**:
- `Strategy`: "Permanent" - 永久缓存策略
- `PreloadOnStartup`: true - 服务启动时预加载
- `PreloadBatchSize`: 500 - 每批预加载数量
- `MaxCachedCount`: 10000 - 最大缓存数量
- `TtlSeconds`: 86400 - 手动刷新的 TTL（24小时）

**调优建议**:
- 数据量小（<1000条）：PreloadBatchSize = 全部数量
- 数据量中（1000-5000条）：PreloadBatchSize = 500-1000
- 数据量大（>5000条）：PreloadBatchSize = 1000-2000，分批加载

#### 2. Temporary（临时缓存）

**适用场景**: 用户运行时数据，会被修改或过期
- Character（角色）
- GearInstance（装备实例）
- ActivityPlan（活动计划）
- RunningBattleSnapshot（战斗快照）

**配置示例**:
```json
{
  "Character": {
    "Strategy": "Temporary",
    "TtlSeconds": 3600,
    "MaxCachedCount": 10000,
    "PreloadOnStartup": false
  }
}
```

**参数说明**:
- `Strategy`: "Temporary" - 临时缓存策略
- `TtlSeconds`: 3600 - 缓存过期时间（秒）
- `MaxCachedCount`: 10000 - 最大缓存数量
- `PreloadOnStartup`: false - 按需加载（懒加载）

**TTL 调优建议**:

| 实体类型 | 推荐 TTL | 考虑因素 |
|----------|----------|----------|
| Character | 3600s (1小时) | 用户登录后长时间在线，访问频繁 |
| GearInstance | 1800s (30分钟) | 装备可能被交易或升级，中等频率访问 |
| ActivityPlan | 900s (15分钟) | 活动状态更新频繁，但活动持续时间长 |
| RunningBattleSnapshot | 600s (10分钟) | 战斗过程中高频访问，战斗结束后不再需要 |

**MaxCachedCount 调优建议**:
- 根据在线用户数量：MaxCachedCount ≥ 在线用户数 × 1.5
- Character: 1000（100用户）到 10000（1000用户）
- GearInstance: 5000（小量装备）到 50000（大量装备）
- ActivityPlan: 2000（少量活动）到 20000（大量活动）
- RunningBattleSnapshot: 500（少量战斗）到 5000（大量战斗）

#### 3. None（不缓存）

**适用场景**: 实时性要求极高，不适合缓存的数据
- 交易记录（强一致性要求）
- 实时排行榜（变化极快）

**配置示例**:
```json
{
  "Transaction": {
    "Strategy": "None"
  }
}
```

### 全局缓存设置

```json
{
  "GlobalSettings": {
    "EnableReadCaching": true,
    "CleanupIntervalMinutes": 5,
    "TrackCacheHitRate": true,
    "HitRateLogIntervalMinutes": 10
  }
}
```

**参数说明**:
| 参数 | 默认值 | 说明 | 调优建议 |
|------|--------|------|----------|
| EnableReadCaching | true | 总开关 | 生产环境建议 true |
| CleanupIntervalMinutes | 5 | 清理间隔 | 内存充裕：5-10分钟；内存紧张：2-3分钟 |
| TrackCacheHitRate | true | 跟踪命中率 | 生产环境建议 true |
| HitRateLogIntervalMinutes | 10 | 统计输出间隔 | 开发环境：5分钟；生产环境：10-15分钟 |

---

## 监控配置

### 基础监控配置

```json
{
  "Monitoring": {
    "MaxRecentOperations": 100,
    "EnableDetailedLogging": false,
    "DefaultTimeWindowMinutes": 10,
    "MemoryStateSnapshotIntervalSeconds": 0
  }
}
```

**参数说明**:
| 参数 | 默认值 | 说明 | 调优建议 |
|------|--------|------|----------|
| MaxRecentOperations | 100 | 保留的最近操作记录数 | 开发环境：200-500；生产环境：50-100 |
| EnableDetailedLogging | false | 详细日志 | 仅调试时启用，生产环境建议 false |
| DefaultTimeWindowMinutes | 10 | 统计时间窗口 | 根据业务需求调整，5-30分钟 |
| MemoryStateSnapshotIntervalSeconds | 0 | 快照间隔 | 0 = 每次保存记录 |

### 缓存监控配置

```json
{
  "CacheMonitoring": {
    "EnableCacheMetrics": true,
    "TrackPerEntityMetrics": true,
    "CacheMetricsIntervalSeconds": 60,
    "LogCacheAccess": false,
    "CacheHitRateThreshold": 70.0
  }
}
```

**参数说明**:
| 参数 | 默认值 | 说明 | 调优建议 |
|------|--------|------|----------|
| EnableCacheMetrics | true | 启用缓存指标收集 | 生产环境建议 true |
| TrackPerEntityMetrics | true | 跟踪每个实体类型 | 生产环境建议 true |
| CacheMetricsIntervalSeconds | 60 | 指标记录间隔 | 30-120秒 |
| LogCacheAccess | false | 记录详细访问日志 | 仅调试时启用 |
| CacheHitRateThreshold | 70.0 | 命中率告警阈值 | 根据实际情况调整，60-80% |

**CacheHitRateThreshold 调优**:
- 静态数据（GearDefinition等）：建议 85-95%
- 用户数据（Character等）：建议 70-85%
- 临时数据（RunningBattleSnapshot）：建议 60-75%

---

## 性能调优

### 场景 1: 高并发场景（大量用户）

**特征**:
- 在线用户 > 500
- 并发请求 > 50 req/s
- 缓存命中率 > 80%

**推荐配置**:
```json
{
  "CacheConfiguration": {
    "EntityStrategies": {
      "Character": {
        "TtlSeconds": 7200,
        "MaxCachedCount": 20000
      },
      "GearInstance": {
        "TtlSeconds": 3600,
        "MaxCachedCount": 100000
      },
      "ActivityPlan": {
        "TtlSeconds": 1800,
        "MaxCachedCount": 40000
      }
    },
    "GlobalSettings": {
      "CleanupIntervalMinutes": 10,
      "HitRateLogIntervalMinutes": 15
    }
  }
}
```

**调优要点**:
1. 增大 TTL，减少缓存过期
2. 增大 MaxCachedCount，容纳更多用户数据
3. 增大清理间隔，减少清理频率

### 场景 2: 内存受限场景

**特征**:
- 可用内存 < 2GB
- 服务器资源紧张
- 需要控制内存占用

**推荐配置**:
```json
{
  "CacheConfiguration": {
    "EntityStrategies": {
      "Character": {
        "TtlSeconds": 1800,
        "MaxCachedCount": 5000
      },
      "GearInstance": {
        "TtlSeconds": 900,
        "MaxCachedCount": 25000
      },
      "ActivityPlan": {
        "TtlSeconds": 600,
        "MaxCachedCount": 10000
      },
      "RunningBattleSnapshot": {
        "TtlSeconds": 300,
        "MaxCachedCount": 2500
      }
    },
    "GlobalSettings": {
      "CleanupIntervalMinutes": 3,
      "TrackCacheHitRate": true
    }
  },
  "MemoryCache": {
    "MaxCachedEntities": 50000,
    "EvictionPolicy": "LRU"
  }
}
```

**调优要点**:
1. 减小 TTL，加快缓存过期
2. 减小 MaxCachedCount，控制内存占用
3. 减小清理间隔，及时释放内存
4. 启用 LRU 清理策略

### 场景 3: 开发测试场景

**特征**:
- 快速迭代开发
- 需要详细日志
- 频繁重启服务

**推荐配置**:
```json
{
  "CacheConfiguration": {
    "EntityStrategies": {
      "Character": {
        "TtlSeconds": 600,
        "MaxCachedCount": 1000
      },
      "GearInstance": {
        "TtlSeconds": 300,
        "MaxCachedCount": 5000
      }
    },
    "GlobalSettings": {
      "CleanupIntervalMinutes": 2,
      "TrackCacheHitRate": true,
      "HitRateLogIntervalMinutes": 5
    }
  },
  "Monitoring": {
    "EnableDetailedLogging": true,
    "CacheMonitoring": {
      "LogCacheAccess": true,
      "CacheHitRateThreshold": 50.0
    }
  }
}
```

**调优要点**:
1. 短 TTL，快速反映数据变化
2. 小缓存容量，减少内存占用
3. 详细日志，便于调试
4. 较低的告警阈值，及时发现问题

---

## 故障排查

### 问题 1: 缓存命中率过低

**症状**:
```log
⚠️  Character: 缓存命中率过低 (45.50% < 70.00%), 
缓存 150 个, Dirty 5 个, 命中 455 次, 未命中 545 次
```

**可能原因**:
1. TTL 设置过短，缓存频繁过期
2. MaxCachedCount 过小，缓存容量不足
3. 访问模式分散，数据访问随机性强
4. 缓存清理过于频繁

**排查步骤**:
```bash
# 1. 检查缓存统计
curl http://localhost:5000/api/database/cache-stats | jq

# 2. 检查内存状态
curl http://localhost:5000/api/database/memory-state | jq

# 3. 查看日志中的缓存清理记录
grep "过期缓存清理" logs/app.log
```

**解决方案**:
1. **增加 TTL**:
   ```json
   {
     "Character": {
       "TtlSeconds": 3600  // 从 1800 增加到 3600
     }
   }
   ```

2. **增大缓存容量**:
   ```json
   {
     "Character": {
       "MaxCachedCount": 20000  // 从 10000 增加到 20000
     }
   }
   ```

3. **调整清理间隔**:
   ```json
   {
     "GlobalSettings": {
       "CleanupIntervalMinutes": 10  // 从 5 增加到 10
     }
   }
   ```

### 问题 2: 内存占用过高

**症状**:
- 内存使用率 > 80%
- 频繁 GC
- 系统响应变慢

**可能原因**:
1. MaxCachedCount 设置过大
2. TTL 设置过长，缓存累积
3. 清理间隔过长，过期数据未及时清理
4. 大量 Dirty 实体未保存

**排查步骤**:
```bash
# 1. 检查内存状态
curl http://localhost:5000/api/database/status | jq '.systemInfo.memory'

# 2. 检查缓存大小
curl http://localhost:5000/api/database/memory-state | jq '.memoryState'

# 3. 检查 Dirty 实体数量
curl http://localhost:5000/api/database/memory-state | jq '.memoryState[].dirtyCount'
```

**解决方案**:
1. **减小缓存容量**:
   ```json
   {
     "Character": {
       "MaxCachedCount": 5000  // 从 10000 减少到 5000
     }
   }
   ```

2. **缩短 TTL**:
   ```json
   {
     "Character": {
       "TtlSeconds": 1800  // 从 3600 减少到 1800
     }
   }
   ```

3. **增加清理频率**:
   ```json
   {
     "GlobalSettings": {
       "CleanupIntervalMinutes": 3  // 从 5 减少到 3
     }
   }
   ```

4. **手动触发清理**:
   ```bash
   # 触发立即保存（清理 Dirty 实体）
   curl -X POST http://localhost:5000/api/database/trigger-save
   ```

### 问题 3: 频繁告警

**症状**:
```log
⚠️  ActivityPlan: 缓存命中率过低 (68.50% < 70.00%)
⚠️  ActivityPlan: 缓存命中率过低 (69.20% < 70.00%)
⚠️  ActivityPlan: 缓存命中率过低 (67.80% < 70.00%)
```

**可能原因**:
1. 阈值设置过高
2. 正常的业务波动
3. 缓存策略配置不合理

**解决方案**:
1. **调整阈值**:
   ```json
   {
     "CacheMonitoring": {
       "CacheHitRateThreshold": 60.0  // 从 70.0 降低到 60.0
     }
   }
   ```

2. **针对不同实体设置不同预期**:
   - 静态数据：85-95%
   - 用户核心数据：70-85%
   - 临时数据：60-75%

3. **增加统计样本量判断**（代码层面已实现）:
   - 只有访问次数 > 100 时才告警
   - 避免启动初期误报

---

## 最佳实践

### 1. 分环境配置

**开发环境** (appsettings.Development.json):
```json
{
  "CacheConfiguration": {
    "GlobalSettings": {
      "EnableReadCaching": true,
      "CleanupIntervalMinutes": 2,
      "HitRateLogIntervalMinutes": 5
    }
  },
  "Monitoring": {
    "EnableDetailedLogging": true,
    "CacheMonitoring": {
      "LogCacheAccess": true,
      "CacheHitRateThreshold": 50.0
    }
  }
}
```

**生产环境** (appsettings.Production.json):
```json
{
  "CacheConfiguration": {
    "GlobalSettings": {
      "EnableReadCaching": true,
      "CleanupIntervalMinutes": 5,
      "HitRateLogIntervalMinutes": 15
    }
  },
  "Monitoring": {
    "EnableDetailedLogging": false,
    "CacheMonitoring": {
      "LogCacheAccess": false,
      "CacheHitRateThreshold": 70.0
    }
  }
}
```

### 2. 渐进式优化

**第一周**: 使用默认配置，收集监控数据
```bash
# 定期检查缓存统计
curl http://localhost:5000/api/database/cache-stats | jq > stats_day1.json
```

**第二周**: 根据监控数据调整 TTL
- 命中率低的实体：增加 TTL
- 内存占用高的实体：减少 TTL

**第三周**: 调整缓存容量
- 频繁被 LRU 清理：增加 MaxCachedCount
- 内存压力大：减少 MaxCachedCount

**第四周**: 微调监控参数
- 告警过多：降低阈值或增加清理间隔
- 告警过少：提高阈值

### 3. 监控指标观察

**每日检查**:
1. 缓存命中率（目标 > 70%）
2. 内存使用率（目标 < 70%）
3. 告警频率（目标 < 5次/天）

**每周检查**:
1. 缓存策略有效性
2. TTL 合理性
3. 容量配置合理性

**每月检查**:
1. 长期趋势分析
2. 配置优化空间
3. 性能改进机会

### 4. 配置备份

定期备份配置文件:
```bash
# 备份当前生产环境配置
cp appsettings.Production.json appsettings.Production.backup.$(date +%Y%m%d).json

# 版本控制
git add appsettings.Production.json
git commit -m "Update cache configuration for performance tuning"
```

### 5. A/B 测试

对于关键配置变更，使用 A/B 测试验证效果:
1. 保持 50% 服务器使用旧配置
2. 另外 50% 使用新配置
3. 对比 1-2 周的监控数据
4. 选择效果更好的配置全量应用

---

## 配置参考速查表

### 缓存策略快速参考

| 数据类型 | 策略 | TTL | MaxCached | 预加载 |
|----------|------|-----|-----------|--------|
| 装备定义 | Permanent | 86400s | 10000 | 是 |
| 词缀定义 | Permanent | 86400s | 10000 | 是 |
| 装备套装 | Permanent | 86400s | 1000 | 是 |
| 角色 | Temporary | 3600s | 10000 | 否 |
| 装备实例 | Temporary | 1800s | 50000 | 否 |
| 活动计划 | Temporary | 900s | 20000 | 否 |
| 战斗快照 | Temporary | 600s | 5000 | 否 |

### 监控参数快速参考

| 参数 | 开发环境 | 生产环境 | 低内存环境 |
|------|----------|----------|------------|
| CleanupIntervalMinutes | 2 | 5 | 3 |
| HitRateLogIntervalMinutes | 5 | 10 | 10 |
| MaxRecentOperations | 200 | 100 | 50 |
| EnableDetailedLogging | true | false | false |
| LogCacheAccess | true | false | false |
| CacheHitRateThreshold | 50% | 70% | 60% |

---

## 附录

### A. 配置模板

完整的生产环境配置模板：`appsettings.Production.example.json`

### B. 监控脚本

**cache_monitor.sh** - 缓存监控脚本
```bash
#!/bin/bash
# 缓存监控脚本
API_URL="http://localhost:5000"

# 获取缓存统计
echo "=== Cache Statistics ==="
curl -s ${API_URL}/api/database/cache-stats | jq '.entityMetrics'

# 检查命中率
HIT_RATE=$(curl -s ${API_URL}/api/database/cache-stats | jq '.overallStatistics.overallHitRate')
echo "Overall Hit Rate: ${HIT_RATE}%"

if (( $(echo "$HIT_RATE < 70" | bc -l) )); then
    echo "⚠️  WARNING: Cache hit rate is below threshold!"
fi
```

### C. 性能基准

**预期性能指标**:
- 数据库读取减少：85%
- 缓存命中率（静态数据）：95%+
- 缓存命中率（用户数据）：80%+
- API 响应时间改善：30%+

---

**文档版本**: 1.0  
**最后更新**: 2025-10-19  
**维护人**: Database Optimization Team  
**反馈**: 如有配置问题或优化建议，请联系运维团队
