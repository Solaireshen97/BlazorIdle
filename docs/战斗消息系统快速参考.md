# æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿå¿«é€Ÿå‚è€ƒ

**ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-14

---

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹

### 1. æŸ¥çœ‹å½“å‰é…ç½®

```bash
# é…ç½®æ–‡ä»¶ä½ç½®
BlazorIdle.Server/appsettings.json

# å…³é”®é…ç½®èŠ‚
"BattleMessages": {
  "AttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
  "EnableAttackStartedEvent": true,
  "PlayerName": "ç©å®¶"
}
```

### 2. ä¿®æ”¹æ¶ˆæ¯æ¨¡æ¿

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "âš”ï¸ {attacker} â†’ {target}",
    "DamageDealtTemplate": "ğŸ’¥ {attacker} å¯¹ {target} é€ æˆ {damage} ä¼¤å®³{critSuffix}",
    "CritSuffix": " â­"
  }
}
```

### 3. å¯ç”¨/ç¦ç”¨äº‹ä»¶

```json
{
  "BattleMessages": {
    "EnableAttackStartedEvent": true,    // å¯ç”¨æ”»å‡»å¼€å§‹äº‹ä»¶
    "EnableDamageDealtEvent": true,      // å¯ç”¨ä¼¤å®³é€ æˆäº‹ä»¶
    "EnableDamageReceivedEvent": false,  // ç¦ç”¨ä¼¤å®³æ¥æ”¶äº‹ä»¶
    "EnableEnemyAttackStartedEvent": true // å¯ç”¨æ•Œäººæ”»å‡»äº‹ä»¶
  }
}
```

### 4. è¿è¡Œæµ‹è¯•

```bash
# æµ‹è¯•æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿ
dotnet test --filter "FullyQualifiedName~BattleMessage"

# é¢„æœŸç»“æœï¼š13 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
```

---

## ğŸ“‹ æ¶ˆæ¯æ¨¡æ¿é€ŸæŸ¥è¡¨

| æ¨¡æ¿ç±»å‹ | é…ç½®é”® | å ä½ç¬¦ | ç¤ºä¾‹è¾“å‡º |
|---------|--------|--------|---------|
| æ”»å‡»å¼€å§‹ | `AttackStartedTemplate` | `{attacker}`, `{target}` | "ç©å®¶ å¼€å§‹æ”»å‡» å²è±å§†" |
| é€ æˆä¼¤å®³ | `DamageDealtTemplate` | `{attacker}`, `{target}`, `{damage}`, `{critSuffix}` | "ç©å®¶ å¯¹ å“¥å¸ƒæ— é€ æˆ 150 ç‚¹ä¼¤å®³ï¼ˆæš´å‡»ï¼‰" |
| å—åˆ°ä¼¤å®³ | `DamageReceivedTemplate` | `{target}`, `{attacker}`, `{damage}` | "ç©å®¶ å—åˆ°æ¥è‡ª å“¥å¸ƒæ— çš„ 50 ç‚¹ä¼¤å®³" |
| æ•Œäººæ”»å‡» | `EnemyAttackStartedTemplate` | `{attacker}`, `{target}` | "å“¥å¸ƒæ— å¼€å§‹æ”»å‡» ç©å®¶" |

---

## ğŸ”§ æ ¸å¿ƒæ–‡ä»¶ä½ç½®

```
ğŸ“ é…ç½®
   â””â”€ BlazorIdle.Server/appsettings.json
   â””â”€ BlazorIdle.Server/Config/BattleMessageOptions.cs

ğŸ“ æœåŠ¡
   â””â”€ BlazorIdle.Server/Services/BattleMessageFormatter.cs

ğŸ“ äº‹ä»¶DTO
   â””â”€ BlazorIdle.Shared/Models/BattleNotifications.cs

ğŸ“ æµ‹è¯•
   â”œâ”€ tests/BlazorIdle.Tests/BattleMessageTests.cs
   â””â”€ tests/BlazorIdle.Tests/BattleMessageIntegrationTests.cs

ğŸ“ æ–‡æ¡£
   â”œâ”€ docs/æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md
   â”œâ”€ docs/æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿæ¶æ„å›¾.md
   â””â”€ æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿå®ç°æ€»ç»“.md
```

---

## ğŸ’¡ å¸¸è§ä»»åŠ¡

### æ›´æ”¹ç©å®¶åç§°

```json
{
  "BattleMessages": {
    "PlayerName": "å‹‡å£«"  // é»˜è®¤æ˜¯ "ç©å®¶"
  }
}
```

### è‡ªå®šä¹‰æš´å‡»æç¤º

```json
{
  "BattleMessages": {
    "CritSuffix": "ï¼ï¼ï¼CRITï¼ï¼ï¼"
  }
}
```

### æ·»åŠ è¡¨æƒ…ç¬¦å·

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "âš”ï¸ {attacker} å¼€å§‹æ”»å‡» {target}",
    "DamageDealtTemplate": "ğŸ’¥ {attacker} å¯¹ {target} é€ æˆ {damage} ç‚¹ä¼¤å®³{critSuffix}",
    "CritSuffix": " ğŸ”¥"
  }
}
```

### å›½é™…åŒ–æ”¯æŒ

**appsettings.zh-CN.json** (ä¸­æ–‡)
```json
{
  "BattleMessages": {
    "PlayerName": "ç©å®¶",
    "AttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}"
  }
}
```

**appsettings.en.json** (è‹±æ–‡)
```json
{
  "BattleMessages": {
    "PlayerName": "Player",
    "AttackStartedTemplate": "{attacker} attacks {target}"
  }
}
```

---

## ğŸ¯ äº‹ä»¶ç±»å‹ä»£ç 

### AttackStartedEventDto

```csharp
public sealed class AttackStartedEventDto : BattleEventDto
{
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public string Message { get; set; }
}
```

### DamageAppliedEventDto

```csharp
public sealed class DamageAppliedEventDto : BattleEventDto
{
    public string Source { get; set; }
    public int Damage { get; set; }
    public bool IsCrit { get; set; }
    public int TargetCurrentHp { get; set; }
    public int TargetMaxHp { get; set; }
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public string Message { get; set; }
}
```

### DamageReceivedEventDto

```csharp
public sealed class DamageReceivedEventDto : BattleEventDto
{
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public int Damage { get; set; }
    public int TargetCurrentHp { get; set; }
    public int TargetMaxHp { get; set; }
    public string Message { get; set; }
}
```

---

## ğŸŒ å‰ç«¯é›†æˆä»£ç 

### è®¢é˜…äº‹ä»¶

```csharp
@inject BattleSignalRService SignalRService

protected override async Task OnInitializedAsync()
{
    // è®¢é˜…æˆ˜æ–—äº‹ä»¶
    SignalRService.OnBattleEvent((battleId, eventData) =>
    {
        HandleBattleEvent(eventData);
    });
}

private void HandleBattleEvent(object eventData)
{
    switch (eventData)
    {
        case AttackStartedEventDto attack:
            ShowMessage(attack.Message);
            break;
            
        case DamageAppliedEventDto damage:
            ShowMessage(damage.Message);
            UpdateEnemyHealth(damage.TargetCurrentHp, damage.TargetMaxHp);
            break;
            
        case DamageReceivedEventDto received:
            ShowMessage(received.Message);
            UpdatePlayerHealth(received.TargetCurrentHp, received.TargetMaxHp);
            break;
    }
}
```

### æ˜¾ç¤ºæˆ˜æ–—æ—¥å¿—

```csharp
private List<string> _battleLog = new();

private void ShowMessage(string message)
{
    _battleLog.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
    
    // é™åˆ¶æ—¥å¿—æ•°é‡
    if (_battleLog.Count > 100)
    {
        _battleLog.RemoveAt(0);
    }
    
    StateHasChanged();
}
```

### UIç»„ä»¶

```razor
<div class="battle-log">
    <h4>æˆ˜æ–—æ—¥å¿—</h4>
    <div class="log-content">
        @foreach (var log in _battleLog.TakeLast(20).Reverse())
        {
            <div class="log-entry">@log</div>
        }
    </div>
</div>

<style>
    .battle-log {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
    }
    
    .log-entry {
        padding: 2px 0;
        font-family: monospace;
    }
</style>
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æ£€æŸ¥é…ç½®æ˜¯å¦åŠ è½½

```csharp
// åœ¨ Program.cs æˆ– Startup.cs ä¸­
var options = builder.Services
    .BuildServiceProvider()
    .GetRequiredService<IOptions<BattleMessageOptions>>()
    .Value;

Console.WriteLine($"Attack template: {options.AttackStartedTemplate}");
Console.WriteLine($"Attack enabled: {options.EnableAttackStartedEvent}");
```

### æµ‹è¯•æ¶ˆæ¯æ ¼å¼åŒ–

```csharp
var formatter = new BattleMessageFormatter(
    Options.Create(new BattleMessageOptions
    {
        AttackStartedTemplate = "{attacker} å¼€å§‹æ”»å‡» {target}"
    })
);

var message = formatter.FormatAttackStarted("ç©å®¶", "å²è±å§†");
Console.WriteLine(message); // è¾“å‡º: "ç©å®¶ å¼€å§‹æ”»å‡» å²è±å§†"
```

### æŸ¥çœ‹äº‹ä»¶è§¦å‘

åœ¨ `BattleEngine` æˆ–ç›¸å…³æˆ˜æ–—é€»è¾‘ä¸­æ·»åŠ æ—¥å¿—ï¼š

```csharp
if (formatter?.IsAttackStartedEnabled == true)
{
    Console.WriteLine($"Sending AttackStarted event: {attackerName} -> {targetName}");
    // ... å‘é€äº‹ä»¶
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å¯ç”¨èŠ‚æµ

```json
{
  "SignalR": {
    "Performance": {
      "EnableThrottling": true,
      "ThrottleWindowMs": 1000
    }
  }
}
```

### ç¦ç”¨ä¸éœ€è¦çš„äº‹ä»¶

```json
{
  "BattleMessages": {
    "EnableAttackStartedEvent": false,  // å…³é—­é«˜é¢‘äº‹ä»¶
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true,
    "EnableEnemyAttackStartedEvent": false
  }
}
```

### é™åˆ¶å†å²è®°å½•

```json
{
  "BattleMessages": {
    "MaxMessageHistory": 50  // å‡å°‘åˆ°50æ¡
  }
}
```

---

## ğŸ› æ•…éšœæ’æŸ¥

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|---------|
| æ¶ˆæ¯ä¸æ˜¾ç¤º | äº‹ä»¶å¼€å…³æœªå¯ç”¨ | æ£€æŸ¥ `Enable*Event` é…ç½® |
| æ¶ˆæ¯æ ¼å¼é”™è¯¯ | å ä½ç¬¦åç§°é”™è¯¯ | æ£€æŸ¥æ¨¡æ¿ä¸­çš„å ä½ç¬¦æ‹¼å†™ |
| é…ç½®ä¸ç”Ÿæ•ˆ | JSONæ ¼å¼é”™è¯¯ | éªŒè¯ JSON è¯­æ³• |
| å‰ç«¯æœªæ¥æ”¶ | SignalRè¿æ¥é—®é¢˜ | æ£€æŸ¥ SignalR è¿æ¥çŠ¶æ€ |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£é“¾æ¥

- [è¯¦ç»†ä½¿ç”¨æŒ‡å—](./æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md)
- [æ¶æ„å›¾](./æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿæ¶æ„å›¾.md)
- [å®ç°æ€»ç»“](../æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿå®ç°æ€»ç»“.md)
- [SignalRæ‰©å±•å¼€å‘æŒ‡å—](./SignalRæ‰©å±•å¼€å‘æŒ‡å—.md)

---

## ğŸ“Š æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æˆ˜æ–—æ¶ˆæ¯æµ‹è¯•
dotnet test --filter "FullyQualifiedName~BattleMessage"

# åªè¿è¡Œå•å…ƒæµ‹è¯•
dotnet test --filter "FullyQualifiedName~BattleMessageTests"

# åªè¿è¡Œé›†æˆæµ‹è¯•
dotnet test --filter "FullyQualifiedName~BattleMessageIntegrationTests"

# è¯¦ç»†è¾“å‡º
dotnet test --filter "FullyQualifiedName~BattleMessage" --verbosity detailed
```

---

## âœ¨ å¿«é€Ÿç¤ºä¾‹

### å®Œæ•´é…ç½®ç¤ºä¾‹

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "âš”ï¸ {attacker} å¼€å§‹æ”»å‡» {target}",
    "DamageDealtTemplate": "ğŸ’¥ {attacker} å¯¹ {target} é€ æˆ {damage} ç‚¹ä¼¤å®³{critSuffix}",
    "CritSuffix": " ğŸ”¥",
    "DamageReceivedTemplate": "ğŸ›¡ï¸ {target} å—åˆ°æ¥è‡ª {attacker} çš„ {damage} ç‚¹ä¼¤å®³",
    "EnemyAttackStartedTemplate": "ğŸ‘¹ {attacker} å‘èµ·æ”»å‡» â†’ {target}",
    "EnableAttackStartedEvent": true,
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true,
    "EnableEnemyAttackStartedEvent": true,
    "PlayerName": "å‹‡å£«",
    "MaxMessageHistory": 100
  },
  "SignalR": {
    "Notification": {
      "EnableAttackStartedNotification": true,
      "EnableEnemyAttackStartedNotification": true,
      "EnableDamageReceivedNotification": true
    },
    "Performance": {
      "EnableThrottling": false,
      "ThrottleWindowMs": 1000
    }
  }
}
```

### å‰ç«¯å®Œæ•´ç¤ºä¾‹

```csharp
@page "/battle"
@inject BattleSignalRService SignalRService

<div class="battle-container">
    <h3>æˆ˜æ–—ç³»ç»Ÿ</h3>
    
    <!-- æˆ˜æ–—æ—¥å¿— -->
    <div class="battle-log">
        <h4>æˆ˜æ–—æ—¥å¿—</h4>
        @foreach (var log in _battleLog.TakeLast(20).Reverse())
        {
            <div class="log-entry">@log</div>
        }
    </div>
</div>

@code {
    private List<string> _battleLog = new();
    
    protected override async Task OnInitializedAsync()
    {
        SignalRService.OnBattleEvent((battleId, eventData) =>
        {
            if (eventData is AttackStartedEventDto attack)
            {
                AddLog(attack.Message);
            }
            else if (eventData is DamageAppliedEventDto damage)
            {
                AddLog(damage.Message);
            }
            else if (eventData is DamageReceivedEventDto received)
            {
                AddLog(received.Message);
            }
        });
    }
    
    private void AddLog(string message)
    {
        _battleLog.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
        if (_battleLog.Count > 100)
        {
            _battleLog.RemoveAt(0);
        }
        StateHasChanged();
    }
}
```

---

**æç¤º**: ä¿®æ”¹é…ç½®åéœ€è¦é‡å¯æœåŠ¡å™¨æ‰èƒ½ç”Ÿæ•ˆï¼
