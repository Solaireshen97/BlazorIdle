# 战斗消息系统快速参考

**版本**: 1.0  
**最后更新**: 2025-10-14

---

## 🚀 5分钟快速开始

### 1. 查看当前配置

```bash
# 配置文件位置
BlazorIdle.Server/appsettings.json

# 关键配置节
"BattleMessages": {
  "AttackStartedTemplate": "{attacker} 开始攻击 {target}",
  "EnableAttackStartedEvent": true,
  "PlayerName": "玩家"
}
```

### 2. 修改消息模板

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "⚔️ {attacker} → {target}",
    "DamageDealtTemplate": "💥 {attacker} 对 {target} 造成 {damage} 伤害{critSuffix}",
    "CritSuffix": " ⭐"
  }
}
```

### 3. 启用/禁用事件

```json
{
  "BattleMessages": {
    "EnableAttackStartedEvent": true,    // 启用攻击开始事件
    "EnableDamageDealtEvent": true,      // 启用伤害造成事件
    "EnableDamageReceivedEvent": false,  // 禁用伤害接收事件
    "EnableEnemyAttackStartedEvent": true // 启用敌人攻击事件
  }
}
```

### 4. 运行测试

```bash
# 测试战斗消息系统
dotnet test --filter "FullyQualifiedName~BattleMessage"

# 预期结果：13 个测试全部通过
```

---

## 📋 消息模板速查表

| 模板类型 | 配置键 | 占位符 | 示例输出 |
|---------|--------|--------|---------|
| 攻击开始 | `AttackStartedTemplate` | `{attacker}`, `{target}` | "玩家 开始攻击 史莱姆" |
| 造成伤害 | `DamageDealtTemplate` | `{attacker}`, `{target}`, `{damage}`, `{critSuffix}` | "玩家 对 哥布林 造成 150 点伤害（暴击）" |
| 受到伤害 | `DamageReceivedTemplate` | `{target}`, `{attacker}`, `{damage}` | "玩家 受到来自 哥布林 的 50 点伤害" |
| 敌人攻击 | `EnemyAttackStartedTemplate` | `{attacker}`, `{target}` | "哥布林 开始攻击 玩家" |

---

## 🔧 核心文件位置

```
📁 配置
   └─ BlazorIdle.Server/appsettings.json
   └─ BlazorIdle.Server/Config/BattleMessageOptions.cs

📁 服务
   └─ BlazorIdle.Server/Services/BattleMessageFormatter.cs

📁 事件DTO
   └─ BlazorIdle.Shared/Models/BattleNotifications.cs

📁 测试
   ├─ tests/BlazorIdle.Tests/BattleMessageTests.cs
   └─ tests/BlazorIdle.Tests/BattleMessageIntegrationTests.cs

📁 文档
   ├─ docs/战斗消息系统使用指南.md
   ├─ docs/战斗消息系统架构图.md
   └─ 战斗消息系统实现总结.md
```

---

## 💡 常见任务

### 更改玩家名称

```json
{
  "BattleMessages": {
    "PlayerName": "勇士"  // 默认是 "玩家"
  }
}
```

### 自定义暴击提示

```json
{
  "BattleMessages": {
    "CritSuffix": "！！！CRIT！！！"
  }
}
```

### 添加表情符号

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "⚔️ {attacker} 开始攻击 {target}",
    "DamageDealtTemplate": "💥 {attacker} 对 {target} 造成 {damage} 点伤害{critSuffix}",
    "CritSuffix": " 🔥"
  }
}
```

### 国际化支持

**appsettings.zh-CN.json** (中文)
```json
{
  "BattleMessages": {
    "PlayerName": "玩家",
    "AttackStartedTemplate": "{attacker} 开始攻击 {target}"
  }
}
```

**appsettings.en.json** (英文)
```json
{
  "BattleMessages": {
    "PlayerName": "Player",
    "AttackStartedTemplate": "{attacker} attacks {target}"
  }
}
```

---

## 🎯 事件类型代码

### AttackStartedEventDto

```csharp
public sealed class AttackStartedEventDto : BattleEventDto
{
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public string Message { get; set; }
}
```

### DamageAppliedEventDto

```csharp
public sealed class DamageAppliedEventDto : BattleEventDto
{
    public string Source { get; set; }
    public int Damage { get; set; }
    public bool IsCrit { get; set; }
    public int TargetCurrentHp { get; set; }
    public int TargetMaxHp { get; set; }
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public string Message { get; set; }
}
```

### DamageReceivedEventDto

```csharp
public sealed class DamageReceivedEventDto : BattleEventDto
{
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public int Damage { get; set; }
    public int TargetCurrentHp { get; set; }
    public int TargetMaxHp { get; set; }
    public string Message { get; set; }
}
```

---

## 🌐 前端集成代码

### 订阅事件

```csharp
@inject BattleSignalRService SignalRService

protected override async Task OnInitializedAsync()
{
    // 订阅战斗事件
    SignalRService.OnBattleEvent((battleId, eventData) =>
    {
        HandleBattleEvent(eventData);
    });
}

private void HandleBattleEvent(object eventData)
{
    switch (eventData)
    {
        case AttackStartedEventDto attack:
            ShowMessage(attack.Message);
            break;
            
        case DamageAppliedEventDto damage:
            ShowMessage(damage.Message);
            UpdateEnemyHealth(damage.TargetCurrentHp, damage.TargetMaxHp);
            break;
            
        case DamageReceivedEventDto received:
            ShowMessage(received.Message);
            UpdatePlayerHealth(received.TargetCurrentHp, received.TargetMaxHp);
            break;
    }
}
```

### 显示战斗日志

```csharp
private List<string> _battleLog = new();

private void ShowMessage(string message)
{
    _battleLog.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
    
    // 限制日志数量
    if (_battleLog.Count > 100)
    {
        _battleLog.RemoveAt(0);
    }
    
    StateHasChanged();
}
```

### UI组件

```razor
<div class="battle-log">
    <h4>战斗日志</h4>
    <div class="log-content">
        @foreach (var log in _battleLog.TakeLast(20).Reverse())
        {
            <div class="log-entry">@log</div>
        }
    </div>
</div>

<style>
    .battle-log {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
    }
    
    .log-entry {
        padding: 2px 0;
        font-family: monospace;
    }
</style>
```

---

## 🔍 调试技巧

### 检查配置是否加载

```csharp
// 在 Program.cs 或 Startup.cs 中
var options = builder.Services
    .BuildServiceProvider()
    .GetRequiredService<IOptions<BattleMessageOptions>>()
    .Value;

Console.WriteLine($"Attack template: {options.AttackStartedTemplate}");
Console.WriteLine($"Attack enabled: {options.EnableAttackStartedEvent}");
```

### 测试消息格式化

```csharp
var formatter = new BattleMessageFormatter(
    Options.Create(new BattleMessageOptions
    {
        AttackStartedTemplate = "{attacker} 开始攻击 {target}"
    })
);

var message = formatter.FormatAttackStarted("玩家", "史莱姆");
Console.WriteLine(message); // 输出: "玩家 开始攻击 史莱姆"
```

### 查看事件触发

在 `BattleEngine` 或相关战斗逻辑中添加日志：

```csharp
if (formatter?.IsAttackStartedEnabled == true)
{
    Console.WriteLine($"Sending AttackStarted event: {attackerName} -> {targetName}");
    // ... 发送事件
}
```

---

## ⚡ 性能优化

### 启用节流

```json
{
  "SignalR": {
    "Performance": {
      "EnableThrottling": true,
      "ThrottleWindowMs": 1000
    }
  }
}
```

### 禁用不需要的事件

```json
{
  "BattleMessages": {
    "EnableAttackStartedEvent": false,  // 关闭高频事件
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true,
    "EnableEnemyAttackStartedEvent": false
  }
}
```

### 限制历史记录

```json
{
  "BattleMessages": {
    "MaxMessageHistory": 50  // 减少到50条
  }
}
```

---

## 🐛 故障排查

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 消息不显示 | 事件开关未启用 | 检查 `Enable*Event` 配置 |
| 消息格式错误 | 占位符名称错误 | 检查模板中的占位符拼写 |
| 配置不生效 | JSON格式错误 | 验证 JSON 语法 |
| 前端未接收 | SignalR连接问题 | 检查 SignalR 连接状态 |

---

## 📚 相关文档链接

- [详细使用指南](./战斗消息系统使用指南.md)
- [架构图](./战斗消息系统架构图.md)
- [实现总结](../战斗消息系统实现总结.md)
- [SignalR扩展开发指南](./SignalR扩展开发指南.md)

---

## 📊 测试命令

```bash
# 运行所有战斗消息测试
dotnet test --filter "FullyQualifiedName~BattleMessage"

# 只运行单元测试
dotnet test --filter "FullyQualifiedName~BattleMessageTests"

# 只运行集成测试
dotnet test --filter "FullyQualifiedName~BattleMessageIntegrationTests"

# 详细输出
dotnet test --filter "FullyQualifiedName~BattleMessage" --verbosity detailed
```

---

## ✨ 快速示例

### 完整配置示例

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "⚔️ {attacker} 开始攻击 {target}",
    "DamageDealtTemplate": "💥 {attacker} 对 {target} 造成 {damage} 点伤害{critSuffix}",
    "CritSuffix": " 🔥",
    "DamageReceivedTemplate": "🛡️ {target} 受到来自 {attacker} 的 {damage} 点伤害",
    "EnemyAttackStartedTemplate": "👹 {attacker} 发起攻击 → {target}",
    "EnableAttackStartedEvent": true,
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true,
    "EnableEnemyAttackStartedEvent": true,
    "PlayerName": "勇士",
    "MaxMessageHistory": 100
  },
  "SignalR": {
    "Notification": {
      "EnableAttackStartedNotification": true,
      "EnableEnemyAttackStartedNotification": true,
      "EnableDamageReceivedNotification": true
    },
    "Performance": {
      "EnableThrottling": false,
      "ThrottleWindowMs": 1000
    }
  }
}
```

### 前端完整示例

```csharp
@page "/battle"
@inject BattleSignalRService SignalRService

<div class="battle-container">
    <h3>战斗系统</h3>
    
    <!-- 战斗日志 -->
    <div class="battle-log">
        <h4>战斗日志</h4>
        @foreach (var log in _battleLog.TakeLast(20).Reverse())
        {
            <div class="log-entry">@log</div>
        }
    </div>
</div>

@code {
    private List<string> _battleLog = new();
    
    protected override async Task OnInitializedAsync()
    {
        SignalRService.OnBattleEvent((battleId, eventData) =>
        {
            if (eventData is AttackStartedEventDto attack)
            {
                AddLog(attack.Message);
            }
            else if (eventData is DamageAppliedEventDto damage)
            {
                AddLog(damage.Message);
            }
            else if (eventData is DamageReceivedEventDto received)
            {
                AddLog(received.Message);
            }
        });
    }
    
    private void AddLog(string message)
    {
        _battleLog.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
        if (_battleLog.Count > 100)
        {
            _battleLog.RemoveAt(0);
        }
        StateHasChanged();
    }
}
```

---

**提示**: 修改配置后需要重启服务器才能生效！
