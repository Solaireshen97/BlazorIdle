# 离线战斗系统流程图

## 1️⃣ 用户上线时完整流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户登录游戏                              │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │    前端加载Characters页面           │
         │  调用: OnInitializedAsync()         │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 1: 更新角色心跳               │
         │  POST /api/characters/{id}/heartbeat│
         │  更新 LastSeenAtUtc = Now           │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 2: 检查离线收益               │
         │  GET /api/offline/check?characterId │
         └────────────────┬───────────────────┘
                          │
                          ▼
               ┌──────────┴──────────┐
               │                     │
        [有离线时间?]           [无离线时间]
               │                     │
               YES                   NO
               │                     │
               ▼                     ▼
    ┌────────────────────┐   ┌─────────────┐
    │ 后端计算离线收益     │   │  正常进入游戏 │
    │ (见流程2详细)       │   └─────────────┘
    └──────────┬─────────┘
               │
               ▼
    ┌────────────────────────────┐
    │ 返回 OfflineCheckResult:    │
    │ - HasOfflineTime: true      │
    │ - OfflineSeconds: 3600      │
    │ - Settlement: {...}         │
    │ - PlanCompleted: true/false │
    │ - NextPlanStarted: ?        │
    └──────────┬─────────────────┘
               │
               ▼
    ┌────────────────────────────┐
    │ Step 3: 前端显示离线弹窗    │
    │ <OfflineSettlementDialog>  │
    │ - 离线时长                  │
    │ - 金币/经验收益             │
    │ - 物品掉落                  │
    │ - [确认领取]按钮            │
    └──────────┬─────────────────┘
               │
               ▼
        [用户点击领取]
               │
               ▼
    ┌────────────────────────────┐
    │ Step 4: 应用离线结算        │
    │ POST /api/offline/apply     │
    │ - 更新角色Gold              │
    │ - 更新角色Experience        │
    │ - 发放物品到背包             │
    └──────────┬─────────────────┘
               │
               ▼
    ┌────────────────────────────┐
    │ Step 5: 刷新角色数据        │
    │ 关闭弹窗，进入游戏           │
    └────────────────────────────┘
```

---

## 2️⃣ 后端离线收益计算详细流程

```
┌─────────────────────────────────────────────────────────────────┐
│        GET /api/offline/check?characterId=xxx                   │
│        OfflineSettlementService.CheckAndSettleAsync()           │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  获取角色数据                       │
         │  character = await GetAsync(id)     │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  计算离线时长                       │
         │  offlineSeconds =                   │
         │    Now - character.LastSeenAtUtc    │
         └────────────────┬───────────────────┘
                          │
                          ▼
               ┌──────────┴──────────┐
               │                     │
         [离线时长 > 0?]        [离线时长 <= 0]
               │                     │
               YES                   NO
               │                     │
               ▼                     ▼
    ┌──────────────────┐   ┌──────────────────┐
    │ 查找运行计划      │   │ 返回无离线结果    │
    │ GetRunningPlan()  │   │ HasOfflineTime=F  │
    └──────┬───────────┘   └──────────────────┘
           │
           ▼
    ┌──────┴──────┐
    │             │
[有运行计划?]  [无运行计划]
    │             │
    YES           NO
    │             │
    ▼             ▼
┌──────────┐  ┌──────────────┐
│ 执行快进  │  │ 仅更新心跳    │
│ (见流程3) │  │ 返回结果      │
└──────────┘  └──────────────┘
```

---

## 3️⃣ OfflineFastForwardEngine 快进流程

```
┌─────────────────────────────────────────────────────────────────┐
│         OfflineFastForwardEngine.FastForward()                  │
│         输入: Character, ActivityPlan, OfflineSeconds           │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 1: 应用离线时长上限           │
         │  cappedSeconds =                    │
         │    Min(offlineSeconds, 12h)         │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 2: 计算计划剩余时长           │
         │  remainingSeconds =                 │
         │    CalculateRemaining(plan, capped) │
         └────────────────┬───────────────────┘
                          │
                          ▼
               ┌──────────┴──────────┐
               │                     │
      [plan.LimitType?]              │
               │                     │
          ┌────┴────┐                │
          │         │                │
       Duration  Infinite            │
          │         │                │
          ▼         ▼                │
    ┌─────────┐ ┌────────┐           │
    │remaining│ │remaining│           │
    │= Limit  │ │= capped │           │
    │- Executed│ │         │           │
    └────┬────┘ └────┬───┘           │
         │           │                │
         └───────┬───┘                │
                 ▼                    │
      ┌──────────────────────┐       │
      │ Min(remaining, capped)│       │
      └──────────┬────────────┘       │
                 │                    │
                 └────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 3: 构建战斗配置               │
         │  config = BuildBattleConfig(plan)   │
         │  - Combat: enemyId, enemyCount      │
         │  - Dungeon: dungeonId, loop         │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 4: 快进模拟                   │
         │  rb = simulator.CreateRunningBattle │
         │  rb.FastForwardTo(remainingSeconds) │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 5: 聚合结果                   │
         │  - 统计总伤害、击杀数                │
         │  - 计算经济收益（金币、经验）         │
         │  - 收集掉落物品                      │
         │  - 生成CombatSegment列表             │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 6: 更新计划状态               │
         │  plan.ExecutedSeconds += simulated  │
         │  if (plan.IsLimitReached())         │
         │    plan.State = Completed           │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Step 7: 返回结果                   │
         │  return OfflineFastForwardResult    │
         │  {                                  │
         │    SimulatedSeconds,                │
         │    PlanCompleted,                   │
         │    Gold, Exp, Loot,                 │
         │    UpdatedExecutedSeconds           │
         │  }                                  │
         └─────────────────────────────────────┘
```

---

## 4️⃣ 活动计划自动衔接流程

```
┌─────────────────────────────────────────────────────────────────┐
│                当前计划完成 (PlanCompleted = true)               │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  查找角色的所有计划                 │
         │  plans = GetByCharacterId(charId)   │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  筛选Pending状态的计划              │
         │  pendingPlans = plans               │
         │    .Where(p => State == Pending)    │
         └────────────────┬───────────────────┘
                          │
                          ▼
               ┌──────────┴──────────┐
               │                     │
      [有Pending计划?]         [无Pending计划]
               │                     │
               YES                   NO
               │                     │
               ▼                     ▼
    ┌──────────────────┐   ┌──────────────────┐
    │ 选择下一个计划    │   │ 角色进入Idle状态  │
    │ 优先级:           │   │ 无自动任务        │
    │ 1. SlotIndex低的  │   └──────────────────┘
    │ 2. CreatedAt早的  │
    └──────┬───────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ 启动计划                  │
    │ ActivityPlanService       │
    │   .StartPlanAsync(nextId) │
    └──────┬───────────────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ 更新计划状态为Running     │
    │ 创建新的Battle            │
    │ 关联BattleId到计划        │
    └──────┬───────────────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ 返回NextPlanStarted=true  │
    │ NextPlanId = nextPlan.Id  │
    └───────────────────────────┘
```

---

## 5️⃣ 前端用户交互流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     用户打开Characters页面                      │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  OnInitializedAsync()               │
         │  1. 加载用户信息                    │
         │  2. 加载角色列表                    │
         │  3. 选择/切换角色                   │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  选中角色后:                        │
         │  await CheckOfflineRewardsAsync()   │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  调用后端API:                       │
         │  1. POST /api/characters/{id}/      │
         │     heartbeat                       │
         │  2. GET /api/offline/check          │
         └────────────────┬───────────────────┘
                          │
                          ▼
               ┌──────────┴──────────┐
               │                     │
      [HasOfflineTime?]         [无离线收益]
               │                     │
               YES                   NO
               │                     │
               ▼                     ▼
    ┌──────────────────┐   ┌──────────────────┐
    │ 显示离线弹窗      │   │ 正常显示游戏界面  │
    │ showOfflineDialog│   └──────────────────┘
    │ = true           │
    └──────┬───────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ <OfflineSettlementDialog> │
    │ 显示:                     │
    │ - 离线时长                │
    │ - 金币: +XXX              │
    │ - 经验: +XXX              │
    │ - 击杀: XXX               │
    │ - 物品掉落列表             │
    │                           │
    │ 按钮:                     │
    │ [确认领取]                │
    └──────┬───────────────────┘
           │
           ▼
    [用户点击"确认领取"]
           │
           ▼
    ┌──────────────────────────┐
    │ ApplyOfflineSettlement()  │
    │ POST /api/offline/apply   │
    └──────┬───────────────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ 后端更新角色数据:         │
    │ - Gold += settlement.Gold │
    │ - Exp += settlement.Exp   │
    │ - 发放物品                │
    └──────┬───────────────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ 前端刷新角色数据          │
    │ await RefreshCharacter()  │
    └──────┬───────────────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ 关闭弹窗                  │
    │ showOfflineDialog = false │
    └──────┬───────────────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ 用户正常进入游戏          │
    └───────────────────────────┘
```

---

## 6️⃣ 时间轴示例

### 场景: 用户创建2小时战斗计划，离线1小时后回来

```
时间线:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

10:00  │  用户在线，创建2小时战斗计划
       │  ├─ ActivityPlan: {
       │  │    Type: Combat,
       │  │    LimitType: Duration,
       │  │    LimitValue: 7200 (2小时),
       │  │    State: Pending,
       │  │    ExecutedSeconds: 0
       │  │  }
       │
10:01  │  计划自动启动
       │  ├─ State: Pending → Running
       │  ├─ StartedAt: 10:01
       │  ├─ BattleId: xxx
       │  ├─ LastSeenAtUtc: 10:01
       │
10:15  │  用户下线（关闭浏览器）
       │  ├─ ExecutedSeconds: 840 (14分钟)
       │  ├─ LastSeenAtUtc: 10:15 (保持)
       │  ├─ 战斗计划继续在内存中运行（服务器端）
       │
       │  [离线期间]
       │  ├─ 服务器内存中的Battle继续运行
       │  ├─ 但LastSeenAtUtc没有更新
       │
11:15  │  用户上线（打开浏览器）
       │  ├─ Now: 11:15
       │  ├─ LastSeenAtUtc: 10:15
       │  ├─ 离线时长: 11:15 - 10:15 = 1小时 = 3600秒
       │
       │  前端调用: GET /api/offline/check
       │
       │  后端计算:
       │  ├─ 离线时长: 3600秒
       │  ├─ 计划剩余时长: 7200 - 840 = 6360秒
       │  ├─ 实际模拟: Min(3600, 6360) = 3600秒
       │  ├─ 快进模拟3600秒战斗
       │  ├─ 更新ExecutedSeconds: 840 + 3600 = 4440秒
       │  ├─ 计划状态: 4440 < 7200, 仍在Running
       │  ├─ 计算收益: Gold=+2500, Exp=+4000
       │
       │  返回给前端:
       │  ├─ HasOfflineTime: true
       │  ├─ OfflineSeconds: 3600
       │  ├─ Settlement: {
       │  │    SimulatedSeconds: 3600,
       │  │    PlanCompleted: false,
       │  │    Gold: 2500,
       │  │    Exp: 4000
       │  │  }
       │
       │  前端显示弹窗:
       │  ┌─────────────────────────┐
       │  │   欢迎回来！            │
       │  │   离线时长: 1小时0分钟   │
       │  │                         │
       │  │   金币: +2500           │
       │  │   经验: +4000           │
       │  │   击杀: 60              │
       │  │                         │
       │  │   [确认领取]            │
       │  └─────────────────────────┘
       │
11:16  │  用户点击"确认领取"
       │  ├─ 前端调用: POST /api/offline/apply
       │  ├─ 后端更新:
       │  │    character.Gold += 2500
       │  │    character.Exp += 4000
       │  ├─ 前端刷新角色数据
       │  ├─ 关闭弹窗
       │
       │  战斗计划继续运行（剩余32分钟）
       │  ├─ ExecutedSeconds: 4440
       │  ├─ 剩余: 7200 - 4440 = 2760秒 (46分钟)
       │
12:01  │  计划到达时间限制
       │  ├─ ExecutedSeconds: 7200
       │  ├─ State: Running → Completed
       │  ├─ CompletedAt: 12:01
       │
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 7️⃣ 边界情况处理

### 情况1: 离线时间超过12小时

```
用户离线15小时:
┌──────────────────────┐
│ offlineSeconds = 54000│ (15小时)
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ cappedSeconds =       │
│   Min(54000, 43200)   │
│   = 43200 (12小时)    │
└──────────┬───────────┘
           │
           ▼
只计算12小时的收益
```

### 情况2: 离线时间不足以完成计划

```
计划剩余3小时，离线1小时:
┌──────────────────────┐
│ remainingSeconds =    │
│   7200 - 0 = 7200     │ (2小时剩余)
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ simulatedSeconds =    │
│   Min(3600, 7200)     │
│   = 3600              │
└──────────┬───────────┘
           │
           ▼
只模拟1小时，计划继续Running
```

### 情况3: 离线期间计划完成

```
计划剩余30分钟，离线2小时:
┌──────────────────────┐
│ remainingSeconds =    │
│   7200 - 5400 = 1800  │ (30分钟)
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ simulatedSeconds =    │
│   Min(7200, 1800)     │
│   = 1800              │
└──────────┬───────────┘
           │
           ▼
模拟30分钟后计划完成
PlanCompleted = true
尝试启动下一个计划
```

---

**文档结束**
