# 前端用户认证功能说明

## 概述

本文档说明 BlazorIdle 前端的用户认证系统实现。该系统在用户访问应用时强制进行登录认证，确保只有已认证用户才能访问游戏功能。

## 功能特性

1. **强制登录**: 用户打开应用后，首先进入登录页面，必须登录成功后才能访问游戏功能
2. **用户注册**: 支持新用户注册账号
3. **用户登录**: 支持用户名或邮箱登录
4. **Token 管理**: 使用 JWT Token 进行身份验证，Token 存储在浏览器 localStorage 中
5. **自动认证**: 页面刷新后自动从 localStorage 加载 Token，无需重新登录
6. **用户登出**: 支持退出登录，清除 Token 并返回登录页
7. **用户信息显示**: 在主界面显示当前登录用户名

## 技术实现

### 1. 认证服务 (AuthService)

位置: `BlazorIdle/Services/AuthService.cs`

核心功能:
- `InitializeAsync()`: 从 localStorage 初始化 Token
- `RegisterAsync()`: 用户注册
- `LoginAsync()`: 用户登录
- `LogoutAsync()`: 用户登出
- `GetToken()`: 获取当前 Token
- `IsAuthenticated`: 检查是否已认证
- `Username`: 获取当前用户名

### 2. API 客户端改造 (ApiClient)

位置: `BlazorIdle/Services/ApiClient.cs`

改动:
- 注入 `AuthService` 依赖
- 添加 `SetAuthHeader()` 方法，在每个 API 请求前自动设置 Authorization header
- 所有 API 方法调用前自动添加 JWT Token

### 3. 登录页面组件 (Login.razor)

位置: `BlazorIdle/Pages/Login.razor`

路由: `/login`

功能:
- 登录表单（用户名/邮箱 + 密码）
- 注册表单（用户名 + 邮箱 + 密码 + 确认密码）
- 表单验证和错误提示
- 登录/注册切换

### 4. 主页面改造 (Characters.razor)

位置: `BlazorIdle/Pages/Characters.razor`

改动:
- 在 `OnInitializedAsync()` 中检查认证状态
- 未认证用户自动重定向到登录页
- 只有认证用户才能看到游戏功能

### 5. 布局改造 (MainLayout.razor)

位置: `BlazorIdle/Layout/MainLayout.razor`

改动:
- 在顶部显示当前登录用户名
- 添加"登出"按钮
- 点击登出清除 Token 并返回登录页

### 6. CSS 样式

位置: `BlazorIdle/wwwroot/css/app-extra.css`

新增样式:
- `.login-container`: 登录页面容器
- `.login-box`: 登录表单盒子
- `.form-group`: 表单组
- `.form-control`: 表单输入框
- `.alert`: 警告提示框
- `.btn`: 按钮样式
- `.user-info`: 用户信息显示

## 使用流程

### 用户注册流程

1. 打开应用，自动进入登录页 (`/login`)
2. 点击"没有账号？去注册"切换到注册表单
3. 填写用户名、邮箱、密码、确认密码
4. 点击"注册"按钮
5. 注册成功后自动登录并跳转到主页

### 用户登录流程

1. 打开应用，自动进入登录页 (`/login`)
2. 输入用户名或邮箱和密码
3. 点击"登录"按钮
4. 登录成功后自动跳转到主页 (`/`)
5. 页面顶部显示"欢迎, {用户名}"和"登出"按钮

### 用户登出流程

1. 在已登录状态下，点击页面顶部的"登出"按钮
2. 自动清除 Token 和用户信息
3. 返回登录页

### 自动认证流程

1. 用户登录后，Token 存储在 localStorage 中
2. 刷新页面时，系统自动从 localStorage 加载 Token
3. 如果 Token 有效，用户保持登录状态
4. 如果 Token 无效或不存在，自动跳转到登录页

## API 端点

### 注册
```
POST /api/auth/register
Content-Type: application/json

{
  "username": "用户名",
  "email": "邮箱",
  "password": "密码"
}
```

响应:
```json
{
  "token": "JWT Token 字符串",
  "userId": "用户ID",
  "username": "用户名",
  "email": "邮箱"
}
```

### 登录
```
POST /api/auth/login
Content-Type: application/json

{
  "usernameOrEmail": "用户名或邮箱",
  "password": "密码"
}
```

响应:
```json
{
  "token": "JWT Token 字符串",
  "userId": "用户ID",
  "username": "用户名",
  "email": "邮箱"
}
```

## Token 存储

Token 相关信息存储在浏览器的 localStorage 中:
- `jwt_token`: JWT Token 字符串
- `user_id`: 用户 ID
- `username`: 用户名

## 安全考虑

1. **密码安全**: 密码通过 HTTPS 传输到后端，后端使用 BCrypt 加密存储
2. **Token 有效期**: JWT Token 有有效期限制（默认 24 小时）
3. **HTTPS**: 生产环境必须使用 HTTPS 传输
4. **XSS 防护**: Token 存储在 localStorage，需注意 XSS 攻击防护
5. **Token 刷新**: 当前实现为简化版本，未来可实现 Refresh Token 机制

## 兼容性

1. **向后兼容**: 后端 API 保持可选认证，支持未认证访问（用于测试）
2. **最小化修改**: 仅在必要的地方添加认证检查，不影响现有业务逻辑
3. **代码风格一致**: 遵循现有代码风格和命名规范

## 用户界面截图

### 登录页面
![登录页面](https://github.com/user-attachments/assets/e4aa69d4-0af3-4ae0-8413-ea782fc0eb53)

### 注册页面
![注册页面](https://github.com/user-attachments/assets/053b225b-e02d-425a-a28e-c79927d31f59)

### 已认证主页
![已认证主页](https://github.com/user-attachments/assets/c96ae655-65cf-4229-b7af-7a3ebe9b8409)

### 登出后返回登录页
![登出后](https://github.com/user-attachments/assets/05e2c55e-8fbe-447f-8302-ec176a935e18)

## 测试验证

### 手动测试步骤

1. **测试注册**:
   - 访问 http://localhost:5000
   - 自动重定向到 `/login`
   - 点击"没有账号？去注册"
   - 填写注册信息并提交
   - 验证注册成功并自动登录

2. **测试登录**:
   - 访问 http://localhost:5000
   - 输入用户名和密码
   - 点击"登录"
   - 验证登录成功并进入主页

3. **测试 Token 持久化**:
   - 登录成功后
   - 刷新页面 (F5)
   - 验证保持登录状态

4. **测试登出**:
   - 在已登录状态
   - 点击"登出"按钮
   - 验证返回登录页

5. **测试 API 认证**:
   - 登录后创建角色
   - 验证 API 请求包含 Authorization header
   - 验证功能正常工作

### API 测试

使用 curl 测试 API：

```bash
# 注册
curl -X POST http://localhost:5056/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"TestPass123"}'

# 登录
curl -X POST http://localhost:5056/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"usernameOrEmail":"testuser","password":"TestPass123"}'

# 使用 Token 访问 API
TOKEN="your_jwt_token_here"
curl -X POST http://localhost:5056/api/characters \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"name":"TestWarrior","profession":0}'
```

## 未来增强

1. **Token 刷新**: 实现 Refresh Token 机制，避免频繁重新登录
2. **记住我**: 添加"记住我"选项，延长 Token 有效期
3. **忘记密码**: 实现密码重置功能
4. **OAuth2**: 支持第三方登录（Google、GitHub 等）
5. **多因素认证**: 增强账号安全性
6. **会话管理**: 查看和管理活跃会话

## 相关文档

- [JWT 认证系统文档](./JWT认证系统文档.md)
- [API 认证示例](./API认证示例.md)
- [用户系统文档](./用户系统文档.md)
- [用户系统快速开始](./用户系统快速开始.md)

## 问题排查

### Token 无效错误

如果遇到 401 Unauthorized 错误：
1. 检查 Token 是否过期
2. 检查后端配置的 JWT 密钥是否一致
3. 清除 localStorage 重新登录

### 无法登录

1. 检查后端服务是否正常运行
2. 检查前端配置的 API 地址是否正确
3. 查看浏览器控制台的错误信息

### 页面无限重定向

1. 检查 AuthService 初始化是否正常
2. 检查 localStorage 是否可用
3. 清除浏览器缓存和 localStorage

## 总结

前端用户认证系统已完整实现，提供了从注册、登录到登出的完整用户体验。系统采用 JWT Token 进行身份验证，与后端 API 无缝集成，确保所有 API 调用都包含正确的认证信息。实现遵循了最小化修改原则，保持了代码风格的一致性，不影响现有功能的正常运行。
