# BlazorIdle è£…å¤‡ç³»ç»Ÿä¼˜åŒ–æ€»ä½“æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰
## æ‰§è¡Œè®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒ

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç‰ˆæœ¬**: 2.0 æ•´åˆç‰ˆ  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-11  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ - æ•´åˆå®Œæˆ  
**ä½œè€…**: ç³»ç»Ÿæ¶æ„è®¾è®¡å›¢é˜Ÿ  

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£ä¸ºã€Šè£…å¤‡ç³»ç»Ÿä¼˜åŒ–æ€»ä½“æ–¹æ¡ˆã€‹çš„ä¸­ç¯‡ï¼Œä¸“æ³¨äºè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’å’ŒæŠ€æœ¯å®ç°è§„èŒƒã€‚

### ä¸ä¸Šä¸‹ç¯‡çš„å…³ç³»

- **ä¸Šç¯‡**: ç³»ç»Ÿåˆ†æä¸æ¶æ„è®¾è®¡ â† å½“å‰åŸºç¡€
- **ä¸­ç¯‡**ï¼ˆæœ¬æ–‡æ¡£ï¼‰: æ‰§è¡Œè®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒ â† å¦‚ä½•å®æ–½
- **ä¸‹ç¯‡**: æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡ â† è´¨é‡ä¿è¯

---

## ç›®å½•

1. [æ•´åˆæ‰§è¡Œè®¡åˆ’æ¦‚è§ˆ](#1-æ•´åˆæ‰§è¡Œè®¡åˆ’æ¦‚è§ˆ)
2. [Phase 1: æ•°æ®åŸºç¡€ä¸æ ¸å¿ƒæ¨¡å‹](#phase-1-æ•°æ®åŸºç¡€ä¸æ ¸å¿ƒæ¨¡å‹ç¬¬1-2å‘¨)
3. [Phase 2: è£…å¤‡ç”Ÿæˆä¸æ‰è½](#phase-2-è£…å¤‡ç”Ÿæˆä¸æ‰è½ç¬¬3-4å‘¨)
4. [Phase 3: è£…å¤‡ç®¡ç†ä¸å±æ€§è®¡ç®—](#phase-3-è£…å¤‡ç®¡ç†ä¸å±æ€§è®¡ç®—ç¬¬5-6å‘¨)
5. [Phase 4: 17æ§½ä½ä¸æŠ¤ç”²ç³»ç»Ÿ](#phase-4-17æ§½ä½ä¸æŠ¤ç”²ç³»ç»Ÿç¬¬7-8å‘¨)
6. [Phase 5: æ­¦å™¨ç±»å‹ä¸æˆ˜æ–—æœºåˆ¶](#phase-5-æ­¦å™¨ç±»å‹ä¸æˆ˜æ–—æœºåˆ¶ç¬¬9-11å‘¨)
7. [Phase 6: èŒä¸šé™åˆ¶ä¸å‰ç«¯å®ç°](#phase-6-èŒä¸šé™åˆ¶ä¸å‰ç«¯å®ç°ç¬¬12-14å‘¨)
8. [Phase 7: è£…å¤‡å¢å¼ºç³»ç»Ÿ](#phase-7-è£…å¤‡å¢å¼ºç³»ç»Ÿç¬¬15-16å‘¨)
9. [Phase 8: æµ‹è¯•ä¼˜åŒ–ä¸ä¸Šçº¿](#phase-8-æµ‹è¯•ä¼˜åŒ–ä¸ä¸Šçº¿ç¬¬17-18å‘¨)
10. [é…ç½®åŒ–è®¾è®¡å®ç°æ–¹æ¡ˆ](#10-é…ç½®åŒ–è®¾è®¡å®ç°æ–¹æ¡ˆ)
11. [ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆç»†èŠ‚](#11-ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆç»†èŠ‚)
12. [æŠ€æœ¯å®ç°è§„èŒƒ](#12-æŠ€æœ¯å®ç°è§„èŒƒ)

---

## 1. æ•´åˆæ‰§è¡Œè®¡åˆ’æ¦‚è§ˆ

### 1.1 Phaseæ¦‚è§ˆ

æœ¬æ€»ä½“æ–¹æ¡ˆå°†ä¸¤å¥—åŸæœ‰æ–¹æ¡ˆï¼ˆ8-Phaseå’Œ5-Phaseï¼‰æ•´åˆä¼˜åŒ–ä¸º **8ä¸ªPhase**ï¼Œæ¶µç›–ä»åŸºç¡€åˆ°é«˜çº§çš„å®Œæ•´å®æ–½è·¯å¾„ã€‚

| Phase | å‘¨æœŸ | æ ¸å¿ƒç›®æ ‡ | å‰ç½®ä¾èµ– | éªŒè¯æ ‡å‡† |
|-------|------|---------|---------|---------|
| **Phase 1** | 1-2å‘¨ | æ•°æ®åŸºç¡€ä¸æ ¸å¿ƒæ¨¡å‹ | æ—  | æ•°æ®åº“è¿ç§»æˆåŠŸ |
| **Phase 2** | 3-4å‘¨ | è£…å¤‡ç”Ÿæˆä¸æ‰è½ | Phase 1 | è£…å¤‡å¯ç”Ÿæˆå¹¶æ‰è½ |
| **Phase 3** | 5-6å‘¨ | è£…å¤‡ç®¡ç†ä¸å±æ€§è®¡ç®— | Phase 2 | è£…å¤‡å¯è£…å¤‡å¹¶å½±å“æˆ˜æ–— |
| **Phase 4** | 7-8å‘¨ | 17æ§½ä½ä¸æŠ¤ç”²ç³»ç»Ÿ | Phase 3 | 17æ§½ä½å¯ç”¨ï¼ŒæŠ¤ç”²å‡ä¼¤ç”Ÿæ•ˆ |
| **Phase 5** | 9-11å‘¨ | æ­¦å™¨ç±»å‹ä¸æˆ˜æ–—æœºåˆ¶ | Phase 4 | æ­¦å™¨ç±»å‹å½±å“æˆ˜æ–— |
| **Phase 6** | 12-14å‘¨ | èŒä¸šé™åˆ¶ä¸å‰ç«¯å®ç° | Phase 5 | å‰ç«¯17æ§½ä½å®Œæ•´å¯ç”¨ |
| **Phase 7** | 15-16å‘¨ | è£…å¤‡å¢å¼ºç³»ç»Ÿ | Phase 6 | åˆ†è§£/é‡é“¸/é‡ç½®å¯ç”¨ |
| **Phase 8** | 17-18å‘¨ | æµ‹è¯•ä¼˜åŒ–ä¸ä¸Šçº¿ | Phase 7 | å…¨ç³»ç»Ÿæµ‹è¯•é€šè¿‡ |

### 1.2 æ•´åˆä¼˜åŒ–ç‚¹

ç›¸æ¯”åŸæœ‰ä¸¤å¥—æ–¹æ¡ˆï¼Œæ•´åˆæ–¹æ¡ˆçš„æ”¹è¿›ï¼š

1. **Phase 1-2**: æ•´åˆäº†åŸºç¡€æ•°æ®æ¨¡å‹å’Œè£…å¤‡ç”Ÿæˆï¼ˆåŸæ–¹æ¡ˆä¸€çš„Phase 1-2ï¼‰
2. **Phase 3**: ç»Ÿä¸€äº†è£…å¤‡ç®¡ç†å’Œå±æ€§è®¡ç®—ï¼ˆåŸæ–¹æ¡ˆä¸€çš„Phase 3ï¼‰
3. **Phase 4**: å¼•å…¥17æ§½ä½å’ŒæŠ¤ç”²ç³»ç»Ÿï¼ˆåŸæ–¹æ¡ˆäºŒçš„æ ¸å¿ƒï¼‰
4. **Phase 5**: å¼•å…¥æ­¦å™¨ç±»å‹å’Œæˆ˜æ–—æœºåˆ¶ï¼ˆåŸæ–¹æ¡ˆäºŒçš„æ ¸å¿ƒï¼‰
5. **Phase 6**: æ•´åˆèŒä¸šé™åˆ¶å’Œå‰ç«¯å®ç°ï¼ˆä¸¤å¥—æ–¹æ¡ˆçš„UIéƒ¨åˆ†åˆå¹¶ï¼‰
6. **Phase 7**: ä¿ç•™è£…å¤‡å¢å¼ºç³»ç»Ÿï¼ˆåŸæ–¹æ¡ˆä¸€çš„Phase 5ï¼‰
7. **Phase 8**: æ–°å¢ç»¼åˆæµ‹è¯•å’Œä¸Šçº¿å‡†å¤‡ï¼ˆåŸæ–¹æ¡ˆçš„æµ‹è¯•éƒ¨åˆ†æ•´åˆï¼‰

### 1.3 å…³é”®é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ç‚¹ | æˆæœ | å‰ç«¯å¯éªŒè¯å†…å®¹ |
|--------|--------|------|---------------|
| **M1: åŸºç¡€å¯ç”¨** | ç¬¬4å‘¨æœ« | è£…å¤‡å¯ç”Ÿæˆå¹¶æ‰è½ | æˆ˜æ–—åè·å¾—è£…å¤‡ï¼Œæ˜¾ç¤ºåœ¨èƒŒåŒ… |
| **M2: è£…å¤‡å¯ç”¨** | ç¬¬6å‘¨æœ« | è£…å¤‡å¯è£…å¤‡å¹¶å½±å“æˆ˜æ–— | è£…å¤‡é¢æ¿å¯æ“ä½œï¼Œæˆ˜æ–—å±æ€§å˜åŒ– |
| **M3: ç³»ç»Ÿå®Œæ•´** | ç¬¬11å‘¨æœ« | 17æ§½ä½ã€æŠ¤ç”²ã€æ­¦å™¨ç±»å‹å…¨éƒ¨å¯ç”¨ | å®Œæ•´è£…å¤‡UIï¼Œæˆ˜æ–—æœºåˆ¶ä½“ç° |
| **M4: åŠŸèƒ½å®Œå–„** | ç¬¬14å‘¨æœ« | èŒä¸šé™åˆ¶ã€å‰ç«¯ä¼˜åŒ–å®Œæˆ | èŒä¸šé™åˆ¶ç”Ÿæ•ˆï¼ŒUIæµç•…ç¾è§‚ |
| **M5: ä¸Šçº¿å‡†å¤‡** | ç¬¬18å‘¨æœ« | å…¨ç³»ç»Ÿæµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡ä¸Šçº¿ | å®Œæ•´åŠŸèƒ½éªŒè¯é€šè¿‡ |

---

## Phase 1: æ•°æ®åŸºç¡€ä¸æ ¸å¿ƒæ¨¡å‹ï¼ˆç¬¬1-2å‘¨ï¼‰

### ç›®æ ‡
å»ºç«‹è£…å¤‡ç³»ç»Ÿçš„æ•°æ®åŸºç¡€ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¡¨ã€é¢†åŸŸæ¨¡å‹ã€æšä¸¾å®šä¹‰å’Œé…ç½®åŠ è½½æœºåˆ¶ã€‚

---

### ä»»åŠ¡æ¸…å•

#### Task 1.1: åˆ›å»ºæšä¸¾å’ŒåŸºç¡€ç±»å‹

**ä¼˜å…ˆçº§**: â­â­â­â­â­  
**é¢„è®¡å·¥æ—¶**: 4å°æ—¶

```csharp
// Models/EquipmentSlot.cs
public enum EquipmentSlot
{
    Head, Neck, Shoulder, Back, Chest,
    Wrist, Hands, Waist, Legs, Feet,
    Finger1, Finger2, Trinket1, Trinket2,
    MainHand, OffHand, TwoHand
}

// Models/ArmorType.cs
public enum ArmorType
{
    None, Cloth, Leather, Mail, Plate
}

// Models/WeaponType.cs
public enum WeaponType
{
    None,
    // å•æ‰‹æ­¦å™¨
    Sword, Dagger, Axe, Mace, Fist, Wand,
    // åŒæ‰‹æ­¦å™¨
    TwoHandSword, TwoHandAxe, TwoHandMace,
    Staff, Polearm,
    // è¿œç¨‹æ­¦å™¨
    Bow, Crossbow, Gun,
    // å‰¯æ‰‹ä¸“ç”¨
    Shield
}

// Models/Rarity.cs
public enum Rarity
{
    Common, Rare, Epic, Legendary
}

// Models/ModifierType.cs
public enum ModifierType
{
    Flat, Percent, Proc
}

// Models/SlotCategory.cs
public enum SlotCategory
{
    Armor, Jewelry, Weapon
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰æšä¸¾å®šä¹‰å®Œæ•´
- âœ… XMLæ–‡æ¡£æ³¨é‡Šå®Œæ•´
- âœ… æšä¸¾å€¼ä¸è®¾è®¡æ–‡æ¡£ä¸€è‡´

#### Task 1.2: åˆ›å»ºé¢†åŸŸæ¨¡å‹å®ä½“

**ä¼˜å…ˆçº§**: â­â­â­â­â­  
**é¢„è®¡å·¥æ—¶**: 8å°æ—¶

```csharp
// Models/GearDefinition.cs
public class GearDefinition
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Icon { get; set; }
    public EquipmentSlot Slot { get; set; }
    public ArmorType ArmorType { get; set; }
    public WeaponType WeaponType { get; set; }
    public int RequiredLevel { get; set; }
    public Dictionary<StatType, StatRange> BaseStats { get; set; }
    public List<string> AllowedAffixPool { get; set; }
    public Dictionary<Rarity, double> RarityWeights { get; set; }
    public string? SetId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// Models/GearInstance.cs
public class GearInstance
{
    public Guid Id { get; set; }
    public string DefinitionId { get; set; }
    public Guid? CharacterId { get; set; }
    public EquipmentSlot? SlotType { get; set; }
    public Rarity Rarity { get; set; }
    public int TierLevel { get; set; }
    public int ItemLevel { get; set; }
    public Dictionary<StatType, double> RolledStats { get; set; }
    public List<AffixInstance> Affixes { get; set; }
    public int QualityScore { get; set; }
    public bool IsEquipped { get; set; }
    public bool IsBound { get; set; }
    public int RerollCount { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // å¯¼èˆªå±æ€§
    public Character? Character { get; set; }
    public GearDefinition Definition { get; set; }
}

// Models/Affix.cs
public class Affix
{
    public string Id { get; set; }
    public string Name { get; set; }
    public StatType StatType { get; set; }
    public ModifierType ModifierType { get; set; }
    public double ValueMin { get; set; }
    public double ValueMax { get; set; }
    public double RarityWeight { get; set; }
    public List<EquipmentSlot>? AllowedSlots { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// ValueObjects/AffixInstance.cs
public class AffixInstance
{
    public string AffixId { get; set; }
    public StatType StatType { get; set; }
    public ModifierType ModifierType { get; set; }
    public double RolledValue { get; set; }
    public string DisplayText { get; set; }
}

// Models/GearSet.cs
public class GearSet
{
    public string Id { get; set; }
    public string Name { get; set; }
    public List<string> Pieces { get; set; }
    public Dictionary<int, List<StatModifier>> Bonuses { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// ValueObjects/StatRange.cs
public class StatRange
{
    public double Min { get; set; }
    public double Max { get; set; }
}

// ValueObjects/StatModifier.cs
public class StatModifier
{
    public StatType StatType { get; set; }
    public ModifierType ModifierType { get; set; }
    public double Value { get; set; }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰å®ä½“å’Œå€¼å¯¹è±¡å®šä¹‰å®Œæ•´
- âœ… å±æ€§ä¸æ•°æ®åº“è®¾è®¡ä¸€è‡´
- âœ… å¯¼èˆªå±æ€§æ­£ç¡®é…ç½®

#### Task 1.3: EF Coreé…ç½®

**ä¼˜å…ˆçº§**: â­â­â­â­â­  
**é¢„è®¡å·¥æ—¶**: 6å°æ—¶

```csharp
// Infrastructure/Persistence/Configurations/GearDefinitionConfiguration.cs
public class GearDefinitionConfiguration : IEntityTypeConfiguration<GearDefinition>
{
    public void Configure(EntityTypeBuilder<GearDefinition> builder)
    {
        builder.ToTable("GearDefinitions");
        builder.HasKey(g => g.Id);
        
        builder.Property(g => g.Id).HasMaxLength(100);
        builder.Property(g => g.Name).HasMaxLength(200).IsRequired();
        builder.Property(g => g.Icon).HasMaxLength(50);
        builder.Property(g => g.Slot).HasConversion<string>().HasMaxLength(50);
        builder.Property(g => g.ArmorType).HasConversion<string>().HasMaxLength(20);
        builder.Property(g => g.WeaponType).HasConversion<string>().HasMaxLength(30);
        
        // JSONå­—æ®µå­˜å‚¨
        builder.Property(g => g.BaseStats)
            .HasColumnName("BaseStatsJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<Dictionary<StatType, StatRange>>(v, (JsonSerializerOptions)null));
        
        builder.Property(g => g.AllowedAffixPool)
            .HasColumnName("AllowedAffixPoolJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<List<string>>(v, (JsonSerializerOptions)null));
        
        builder.Property(g => g.RarityWeights)
            .HasColumnName("RarityWeightsJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<Dictionary<Rarity, double>>(v, (JsonSerializerOptions)null));
        
        builder.HasIndex(g => g.Slot);
        builder.HasIndex(g => g.SetId);
    }
}

// Infrastructure/Persistence/Configurations/GearInstanceConfiguration.cs
public class GearInstanceConfiguration : IEntityTypeConfiguration<GearInstance>
{
    public void Configure(EntityTypeBuilder<GearInstance> builder)
    {
        builder.ToTable("GearInstances");
        builder.HasKey(g => g.Id);
        
        builder.Property(g => g.DefinitionId).HasMaxLength(100).IsRequired();
        builder.Property(g => g.SlotType).HasConversion<string>().HasMaxLength(50);
        builder.Property(g => g.Rarity).HasConversion<string>().HasMaxLength(50).IsRequired();
        
        // JSONå­—æ®µå­˜å‚¨
        builder.Property(g => g.RolledStats)
            .HasColumnName("RolledStatsJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<Dictionary<StatType, double>>(v, (JsonSerializerOptions)null))
            .IsRequired();
        
        builder.Property(g => g.Affixes)
            .HasColumnName("AffixesJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<List<AffixInstance>>(v, (JsonSerializerOptions)null))
            .IsRequired();
        
        // å¤–é”®å…³ç³»
        builder.HasOne(g => g.Character)
            .WithMany()
            .HasForeignKey(g => g.CharacterId)
            .OnDelete(DeleteBehavior.Cascade);
        
        builder.HasOne(g => g.Definition)
            .WithMany()
            .HasForeignKey(g => g.DefinitionId)
            .OnDelete(DeleteBehavior.Restrict);
        
        // ç´¢å¼•
        builder.HasIndex(g => g.CharacterId);
        builder.HasIndex(g => g.IsEquipped);
        builder.HasIndex(g => g.Rarity);
        builder.HasIndex(g => g.DefinitionId);
    }
}

// ç±»ä¼¼é…ç½®: AffixConfiguration, GearSetConfiguration
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰å®ä½“é…ç½®å®Œæ•´
- âœ… JSONåºåˆ—åŒ–/ååºåˆ—åŒ–æ­£ç¡®
- âœ… å¤–é”®å…³ç³»æ­£ç¡®
- âœ… ç´¢å¼•é…ç½®åˆç†

#### Task 1.4: æ•°æ®åº“è¿ç§»

**ä¼˜å…ˆçº§**: â­â­â­â­â­  
**é¢„è®¡å·¥æ—¶**: 4å°æ—¶

```bash
# åˆ›å»ºè¿ç§»
dotnet ef migrations add AddEquipmentSystem

# åº”ç”¨è¿ç§»
dotnet ef database update
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿ç§»æ–‡ä»¶ç”ŸæˆæˆåŠŸ
- âœ… æ•°æ®åº“æ›´æ–°æˆåŠŸ
- âœ… æ‰€æœ‰è¡¨å’Œç´¢å¼•åˆ›å»ºæ­£ç¡®

#### Task 1.5: åˆ›å»ºä»“å‚¨æ¥å£å’Œå®ç°

**ä¼˜å…ˆçº§**: â­â­â­â­  
**é¢„è®¡å·¥æ—¶**: 8å°æ—¶

```csharp
// Repositories/IGearDefinitionRepository.cs
public interface IGearDefinitionRepository
{
    Task<GearDefinition?> GetByIdAsync(string id);
    Task<List<GearDefinition>> GetBySlotAsync(EquipmentSlot slot);
    Task<List<GearDefinition>> GetAllAsync();
    Task CreateAsync(GearDefinition definition);
    Task UpdateAsync(GearDefinition definition);
    Task DeleteAsync(string id);
}

// Repositories/IGearInstanceRepository.cs
public interface IGearInstanceRepository
{
    Task<GearInstance?> GetByIdAsync(Guid id);
    Task<List<GearInstance>> GetEquippedGearAsync(Guid characterId);
    Task<List<GearInstance>> GetGearByCharacterAsync(Guid characterId);
    Task<GearInstance?> GetEquippedGearBySlotAsync(Guid characterId, EquipmentSlot slot);
    Task CreateAsync(GearInstance instance);
    Task UpdateAsync(GearInstance instance);
    Task DeleteAsync(Guid id);
}

// å®ç°ç±»åœ¨ Infrastructure/Persistence/Repositories/
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰ä»“å‚¨æ¥å£å®šä¹‰å®Œæ•´
- âœ… ä»“å‚¨å®ç°æ­£ç¡®ä½¿ç”¨EF Core
- âœ… å¼‚æ­¥æ“ä½œæ­£ç¡®å®ç°

#### Task 1.6: åˆ›å»ºé…ç½®ç±»

**ä¼˜å…ˆçº§**: â­â­â­â­  
**é¢„è®¡å·¥æ—¶**: 6å°æ—¶

```csharp
// Configuration/ArmorTypeConfig.cs
public class ArmorTypeConfig
{
    public ArmorType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    public double BaseArmorMultiplier { get; set; }
    public double StaminaMultiplier { get; set; }
    public Dictionary<string, double> SecondaryStatWeights { get; set; }
    public List<EquipmentSlot> ApplicableSlots { get; set; }
}

// Configuration/WeaponTypeConfig.cs
public class WeaponTypeConfig
{
    public WeaponType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    public double BaseAttackSpeed { get; set; }
    public double AttackPowerMultiplier { get; set; }
    public List<EquipmentSlot> AllowedSlots { get; set; }
    public DamageType PrimaryDamageType { get; set; }
    public bool AllowsDualWield { get; set; }
    public bool IsRangedWeapon { get; set; }
    public bool IsTwoHanded { get; set; }
}

// Configuration/EquipmentSystemConfiguration.cs
public class EquipmentSystemConfiguration
{
    public string Version { get; set; }
    public List<ArmorTypeConfig> ArmorTypes { get; set; }
    public List<WeaponTypeConfig> WeaponTypes { get; set; }
    public List<ProfessionEquipmentConfig> ProfessionRestrictions { get; set; }
    public CombatMechanicsConfig CombatMechanics { get; set; }
    
    // å•ä¾‹æ¨¡å¼
    private static EquipmentSystemConfiguration? _instance;
    public static EquipmentSystemConfiguration Instance => 
        _instance ??= LoadFromJson("EquipmentSystemConfig.json");
    
    private static EquipmentSystemConfiguration LoadFromJson(string path)
    {
        var json = File.ReadAllText(path);
        return JsonSerializer.Deserialize<EquipmentSystemConfiguration>(json)
            ?? throw new InvalidOperationException("Failed to load configuration");
    }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰é…ç½®ç±»å®šä¹‰å®Œæ•´
- âœ… JSONåŠ è½½æœºåˆ¶æ­£ç¡®
- âœ… å•ä¾‹æ¨¡å¼å®ç°æ­£ç¡®

#### Task 1.7: åˆ›å»ºé…ç½®JSONæ–‡ä»¶

**ä¼˜å…ˆçº§**: â­â­â­â­  
**é¢„è®¡å·¥æ—¶**: 4å°æ—¶

```json
// EquipmentSystemConfig.json
{
  "Version": "1.0",
  "ArmorTypes": [
    {
      "TypeId": "cloth",
      "DisplayName": "å¸ƒç”²",
      "Type": "Cloth",
      "BaseArmorMultiplier": 0.5,
      "StaminaMultiplier": 1.0,
      "SecondaryStatWeights": {
        "Intellect": 1.5,
        "SpellPower": 1.3
      },
      "ApplicableSlots": ["Head", "Shoulder", "Chest", "Wrist", "Hands", "Waist", "Legs", "Feet"]
    },
    {
      "TypeId": "plate",
      "DisplayName": "æ¿ç”²",
      "Type": "Plate",
      "BaseArmorMultiplier": 2.0,
      "StaminaMultiplier": 1.5,
      "SecondaryStatWeights": {
        "Strength": 1.5,
        "Stamina": 1.4
      },
      "ApplicableSlots": ["Head", "Shoulder", "Chest", "Wrist", "Hands", "Waist", "Legs", "Feet"]
    }
  ],
  "WeaponTypes": [
    {
      "TypeId": "sword",
      "DisplayName": "å‰‘",
      "Type": "Sword",
      "BaseAttackSpeed": 2.5,
      "AttackPowerMultiplier": 1.0,
      "AllowedSlots": ["MainHand", "OffHand"],
      "PrimaryDamageType": "Physical",
      "AllowsDualWield": true,
      "IsRangedWeapon": false,
      "IsTwoHanded": false
    }
  ],
  "CombatMechanics": {
    "Armor": {
      "ReductionConstant": 400,
      "MaxReduction": 0.75
    },
    "Block": {
      "BaseBlockChance": 0.05,
      "BlockDamageReduction": 0.30,
      "BlockChancePerStrength": 0.001,
      "BlockChancePerItemLevel": 0.002,
      "MaxBlockChance": 0.50
    }
  }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… JSONæ ¼å¼æ­£ç¡®
- âœ… æ‰€æœ‰é…ç½®å‚æ•°å®Œæ•´
- âœ… é…ç½®å¯æ­£å¸¸åŠ è½½

#### Task 1.8: ç§å­æ•°æ®

**ä¼˜å…ˆçº§**: â­â­â­  
**é¢„è®¡å·¥æ—¶**: 8å°æ—¶

åˆ›å»ºåˆå§‹è£…å¤‡å®šä¹‰ã€è¯æ¡å®šä¹‰ã€å¥—è£…å®šä¹‰çš„ç§å­æ•°æ®ã€‚

**éªŒæ”¶æ ‡å‡†**:
- âœ… è‡³å°‘10ä¸ªè£…å¤‡å®šä¹‰
- âœ… è‡³å°‘20ä¸ªè¯æ¡å®šä¹‰
- âœ… è‡³å°‘1ä¸ªå¥—è£…å®šä¹‰

#### Task 1.9: å•å…ƒæµ‹è¯•

**ä¼˜å…ˆçº§**: â­â­â­â­  
**é¢„è®¡å·¥æ—¶**: 8å°æ—¶

```csharp
// Tests/Equipment/Models/GearInstanceTests.cs
public class GearInstanceTests
{
    [Fact]
    public void GearInstance_Should_Initialize_Correctly()
    {
        // Arrange & Act
        var gear = new GearInstance
        {
            Id = Guid.NewGuid(),
            DefinitionId = "sword_iron",
            Rarity = Rarity.Common,
            TierLevel = 1
        };
        
        // Assert
        gear.Should().NotBeNull();
        gear.Id.Should().NotBeEmpty();
        gear.TierLevel.Should().Be(1);
    }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### Phase 1 éªŒæ”¶æ ‡å‡†

| éªŒæ”¶é¡¹ | æ ‡å‡† | éªŒè¯æ–¹å¼ |
|--------|------|---------|
| æ•°æ®åº“è¿ç§» | æˆåŠŸæ‰§è¡Œï¼Œæ‰€æœ‰è¡¨åˆ›å»º | æŸ¥è¯¢æ•°æ®åº“ |
| å®ä½“å®šä¹‰ | å®Œæ•´ä¸”ç¬¦åˆè®¾è®¡ | Code Review |
| ä»“å‚¨å®ç° | CRUDæ“ä½œæ­£å¸¸ | å•å…ƒæµ‹è¯• |
| é…ç½®åŠ è½½ | JSONé…ç½®å¯æ­£å¸¸åŠ è½½ | é›†æˆæµ‹è¯• |
| ç§å­æ•°æ® | åˆå§‹æ•°æ®æ­£ç¡®æ’å…¥ | æŸ¥è¯¢æ•°æ®åº“ |
| å•å…ƒæµ‹è¯• | è¦†ç›–ç‡â‰¥90%ï¼Œå…¨éƒ¨é€šè¿‡ | æµ‹è¯•æŠ¥å‘Š |

---

(ç”±äºç¯‡å¹…é™åˆ¶ï¼Œåç»­Phaseå°†ç®€è¦åˆ—å‡ºå…³é”®ä»»åŠ¡ï¼Œè¯¦ç»†å®ç°å‚è€ƒç±»ä¼¼ç»“æ„)

---

## Phase 2: è£…å¤‡ç”Ÿæˆä¸æ‰è½ï¼ˆç¬¬3-4å‘¨ï¼‰

### ç›®æ ‡
å®ç°è£…å¤‡ç”Ÿæˆé€»è¾‘å’Œæ‰è½ç³»ç»Ÿé›†æˆ

### å…³é”®ä»»åŠ¡

1. **GearGenerationService** (8h)
   - å®ç°ç¨€æœ‰åº¦éšæœº
   - å®ç°åŸºç¡€å±æ€§Roll
   - å®ç°è¯æ¡ç”Ÿæˆ
   - å®ç°è£…å¤‡è¯„åˆ†è®¡ç®—

2. **ç»æµç³»ç»Ÿé›†æˆ** (6h)
   - æ‰©å±•EconomyRegistryæ”¯æŒè£…å¤‡
   - é…ç½®è£…å¤‡æ‰è½è¡¨
   - é›†æˆåˆ°RewardGrantService

3. **RNGæ§åˆ¶** (4h)
   - ä½¿ç”¨RNGContextä¿è¯å¯å›æ”¾
   - è®°å½•è£…å¤‡ç”Ÿæˆç§å­

4. **å•å…ƒæµ‹è¯•** (8h)

### éªŒæ”¶æ ‡å‡†
- âœ… è£…å¤‡å¯ç”Ÿæˆï¼Œå„ç¨€æœ‰åº¦è£…å¤‡æ­£å¸¸
- âœ… è£…å¤‡æ‰è½é›†æˆåˆ°æˆ˜æ–—å¥–åŠ±
- âœ… RNGå¯å›æ”¾éªŒè¯

---

## Phase 3: è£…å¤‡ç®¡ç†ä¸å±æ€§è®¡ç®—ï¼ˆç¬¬5-6å‘¨ï¼‰

### ç›®æ ‡
å®ç°è£…å¤‡/å¸ä¸‹æ“ä½œå’Œå±æ€§èšåˆè®¡ç®—

### å…³é”®ä»»åŠ¡

1. **EquipmentService** (12h)
   - EquipItemæ–¹æ³•
   - UnequipItemæ–¹æ³•
   - SwapGearæ–¹æ³•
   - è£…å¤‡éªŒè¯é€»è¾‘

2. **StatsAggregationService** (10h)
   - å±æ€§èšåˆç®—æ³•
   - æ•°å€¼ç®¡çº¿å®ç°
   - ç¼“å­˜æœºåˆ¶

3. **æˆ˜æ–—ç³»ç»Ÿé›†æˆ** (8h)
   - æ‰©å±•StatsBuilderæ³¨å…¥è£…å¤‡å±æ€§
   - éªŒè¯æˆ˜æ–—ä¸­è£…å¤‡å±æ€§ç”Ÿæ•ˆ

4. **APIå®ç°** (6h)
   - æ›´æ–°EquipmentController

5. **å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•** (10h)

### éªŒæ”¶æ ‡å‡†
- âœ… è£…å¤‡/å¸ä¸‹æ“ä½œæ­£å¸¸
- âœ… è£…å¤‡å±æ€§æ­£ç¡®å½±å“æˆ˜æ–—
- âœ… APIæ­£å¸¸å·¥ä½œ

---

## Phase 4: 17æ§½ä½ä¸æŠ¤ç”²ç³»ç»Ÿï¼ˆç¬¬7-8å‘¨ï¼‰

### ç›®æ ‡
æ‰©å±•åˆ°17ä¸ªè£…å¤‡æ§½ä½å¹¶å®ç°æŠ¤ç”²ç±»å‹ç³»ç»Ÿ

### å…³é”®ä»»åŠ¡

1. **æ§½ä½æ‰©å±•** (8h)
   - æ›´æ–°EquipmentSlotæšä¸¾ï¼ˆå·²åœ¨Phase 1å®Œæˆï¼‰
   - æ‰©å±•å‰ç«¯DTOæ”¯æŒ17æ§½ä½
   - æ›´æ–°APIè¿”å›17æ§½ä½

2. **æŠ¤ç”²è®¡ç®—** (10h)
   - ArmorCalculatorå®ç°
   - æŠ¤ç”²å‡ä¼¤é›†æˆåˆ°æˆ˜æ–—
   - æŠ¤ç”²å€¼èšåˆ

3. **è£…å¤‡ç”Ÿæˆå¢å¼º** (6h)
   - æ ¹æ®æŠ¤ç”²ç±»å‹ç”Ÿæˆå±æ€§
   - åº”ç”¨æŠ¤ç”²ç±»å‹ç³»æ•°

4. **æ•°æ®åº“è¿ç§»** (4h)
   - æ·»åŠ ArmorTypeå­—æ®µ
   - æ·»åŠ BaseArmorå­—æ®µ

5. **æµ‹è¯•** (10h)

### éªŒæ”¶æ ‡å‡†
- âœ… 17æ§½ä½å¯ç”¨
- âœ… æŠ¤ç”²å‡ä¼¤åœ¨æˆ˜æ–—ä¸­ç”Ÿæ•ˆ
- âœ… ä¸åŒæŠ¤ç”²ç±»å‹æœ‰æ˜æ˜¾å·®å¼‚

---

## Phase 5: æ­¦å™¨ç±»å‹ä¸æˆ˜æ–—æœºåˆ¶ï¼ˆç¬¬9-11å‘¨ï¼‰

### ç›®æ ‡
å®ç°æ­¦å™¨ç±»å‹ç³»ç»Ÿã€æ”»å‡»é€Ÿåº¦ã€æ ¼æŒ¡æœºåˆ¶

### å…³é”®ä»»åŠ¡

1. **æ­¦å™¨ç±»å‹å®ç°** (8h)
   - æ‰©å±•GearInstanceæ·»åŠ æ­¦å™¨å±æ€§
   - æ­¦å™¨ç±»å‹é…ç½®åŠ è½½

2. **æ”»å‡»é€Ÿåº¦è®¡ç®—** (8h)
   - AttackSpeedCalculator
   - é›†æˆåˆ°æˆ˜æ–—ç³»ç»Ÿ
   - åŒæŒé€Ÿåº¦è®¡ç®—

3. **ä¼¤å®³è®¡ç®—é‡æ„** (10h)
   - é›†æˆæ­¦å™¨å€ç‡
   - åŒæŒä¼¤å®³è®¡ç®—

4. **æ ¼æŒ¡æœºåˆ¶** (10h)
   - BlockCalculator
   - æ ¼æŒ¡åˆ¤å®šé›†æˆåˆ°æˆ˜æ–—
   - æ ¼æŒ¡äº‹ä»¶è®°å½•

5. **åŒæ‰‹æ­¦å™¨æœºåˆ¶** (6h)
   - è£…å¤‡åŒæ‰‹æ­¦å™¨å ç”¨é€»è¾‘
   - UIæç¤º

6. **æµ‹è¯•** (12h)

### éªŒæ”¶æ ‡å‡†
- âœ… ä¸åŒæ­¦å™¨ç±»å‹æœ‰ä¸åŒæ”»å‡»é€Ÿåº¦å’Œä¼¤å®³
- âœ… åŒæŒè®¡ç®—æ­£ç¡®
- âœ… æ ¼æŒ¡æœºåˆ¶æ­£å¸¸å·¥ä½œ
- âœ… åŒæ‰‹æ­¦å™¨æ­£ç¡®å ç”¨ä¸»å‰¯æ‰‹

---

## Phase 6: èŒä¸šé™åˆ¶ä¸å‰ç«¯å®ç°ï¼ˆç¬¬12-14å‘¨ï¼‰

### ç›®æ ‡
å®ç°èŒä¸šè£…å¤‡é™åˆ¶å¹¶å®Œå–„å‰ç«¯17æ§½ä½UI

### å…³é”®ä»»åŠ¡

1. **è£…å¤‡é™åˆ¶éªŒè¯** (8h)
   - EquipmentValidator
   - èŒä¸š-æŠ¤ç”²ç±»å‹éªŒè¯
   - èŒä¸š-æ­¦å™¨ç±»å‹éªŒè¯

2. **è£…å¤‡APIé›†æˆ** (6h)
   - æ·»åŠ è£…å¤‡å‰éªŒè¯
   - è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯

3. **å‰ç«¯è£…å¤‡é¢æ¿é‡æ„** (16h)
   - æ‰©å±•EquipmentPanel.razoræ”¯æŒ17æ§½ä½
   - æ–°å¸ƒå±€è®¾è®¡
   - æ§½ä½å›¾æ ‡å’Œåç§°æ›´æ–°

4. **è£…å¤‡è¯¦æƒ…å¢å¼º** (12h)
   - æ˜¾ç¤ºæŠ¤ç”²ç±»å‹å’Œæ•°å€¼
   - æ˜¾ç¤ºæ­¦å™¨ç±»å‹å’Œæ”»å‡»é€Ÿåº¦
   - æ˜¾ç¤ºæ ¼æŒ¡æ¦‚ç‡
   - èŒä¸šé™åˆ¶æç¤º

5. **è£…å¤‡å¯¹æ¯”åŠŸèƒ½** (8h)
   - Tooltipæ˜¾ç¤ºå¯¹æ¯”ä¿¡æ¯
   - é«˜äº®å±æ€§å˜åŒ–

6. **æµ‹è¯•** (12h)

### éªŒæ”¶æ ‡å‡†
- âœ… æ‰€æœ‰èŒä¸šè£…å¤‡é™åˆ¶æ­£ç¡®ç”Ÿæ•ˆ
- âœ… å‰ç«¯17æ§½ä½å®Œæ•´å¯ç”¨
- âœ… è£…å¤‡å¯¹æ¯”åŠŸèƒ½æ­£å¸¸

---

## Phase 7: è£…å¤‡å¢å¼ºç³»ç»Ÿï¼ˆç¬¬15-16å‘¨ï¼‰

### ç›®æ ‡
å®ç°è£…å¤‡åˆ†è§£ã€é‡é“¸ã€è¯æ¡é‡ç½®

### å…³é”®ä»»åŠ¡

1. **DisenchantService** (8h)
   - åˆ†è§£ç®—æ³•
   - ææ–™äº§å‡ºè®¡ç®—
   - ç»æµäº‹ä»¶è®°å½•

2. **ReforgeService** (10h)
   - å“çº§é‡é“¸
   - è¯æ¡é‡ç½®
   - æˆæœ¬è®¡ç®—

3. **APIå®ç°** (6h)
   - åˆ†è§£ã€é‡é“¸ã€é‡ç½®API

4. **å‰ç«¯å¢å¼ºç•Œé¢** (12h)
   - GearEnhancementDialogç»„ä»¶
   - åˆ†è§£/é‡é“¸/é‡ç½®UI

5. **æµ‹è¯•** (10h)

### éªŒæ”¶æ ‡å‡†
- âœ… åˆ†è§£åŠŸèƒ½æ­£å¸¸ï¼Œäº§å‡ºæ­£ç¡®
- âœ… å“çº§é‡é“¸æ­£ç¡®æå‡è£…å¤‡
- âœ… è¯æ¡é‡ç½®æ­£ç¡®é‡æ–°ç”Ÿæˆè¯æ¡

---

## Phase 8: æµ‹è¯•ä¼˜åŒ–ä¸ä¸Šçº¿ï¼ˆç¬¬17-18å‘¨ï¼‰

### ç›®æ ‡
å…¨ç³»ç»Ÿæµ‹è¯•ã€æ€§èƒ½ä¼˜åŒ–ã€ä¸Šçº¿å‡†å¤‡

### å…³é”®ä»»åŠ¡

1. **å…¨ç³»ç»Ÿæµ‹è¯•** (16h)
   - E2Eæµ‹è¯•å®Œæ•´è£…å¤‡æµç¨‹
   - æ€§èƒ½æµ‹è¯•
   - å‹åŠ›æµ‹è¯•
   - å…¼å®¹æ€§æµ‹è¯•

2. **æ€§èƒ½ä¼˜åŒ–** (10h)
   - è£…å¤‡å±æ€§è®¡ç®—ä¼˜åŒ–
   - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
   - å‰ç«¯æ¸²æŸ“ä¼˜åŒ–

3. **æ–‡æ¡£å®Œå–„** (8h)
   - APIæ–‡æ¡£
   - ç”¨æˆ·æ‰‹å†Œ
   - è¿ç»´æ–‡æ¡£

4. **ä¸Šçº¿å‡†å¤‡** (8h)
   - ç°åº¦å‘å¸ƒè®¡åˆ’
   - ç›‘æ§æŒ‡æ ‡é…ç½®
   - å›æ»šæ–¹æ¡ˆ

### éªŒæ”¶æ ‡å‡†
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… æ€§èƒ½æ»¡è¶³æŒ‡æ ‡
- âœ… æ–‡æ¡£å®Œæ•´
- âœ… ä¸Šçº¿å‡†å¤‡å°±ç»ª

---

## 10. é…ç½®åŒ–è®¾è®¡å®ç°æ–¹æ¡ˆ

### 10.1 é…ç½®æ–‡ä»¶ç»„ç»‡

```
BlazorIdle.Server/Configuration/
â”œâ”€â”€ EquipmentSystemConfig.json       # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ GearDefinitions.json             # è£…å¤‡å®šä¹‰ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯å­˜æ•°æ®åº“ï¼‰
â”œâ”€â”€ AffixDefinitions.json            # è¯æ¡å®šä¹‰ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ GearSets.json                    # å¥—è£…å®šä¹‰ï¼ˆå¯é€‰ï¼‰
```

### 10.2 é…ç½®åŠ è½½æœºåˆ¶

```csharp
public class ConfigurationService
{
    private readonly ILogger<ConfigurationService> _logger;
    private readonly IConfiguration _configuration;
    
    public ConfigurationService(
        ILogger<ConfigurationService> logger,
        IConfiguration configuration)
    {
        _logger = logger;
        _configuration = configuration;
    }
    
    public EquipmentSystemConfiguration LoadEquipmentConfig()
    {
        var path = Path.Combine(AppContext.BaseDirectory, "Configuration", "EquipmentSystemConfig.json");
        var json = File.ReadAllText(path);
        var config = JsonSerializer.Deserialize<EquipmentSystemConfiguration>(json);
        
        // éªŒè¯é…ç½®
        ValidateConfiguration(config);
        
        _logger.LogInformation("Equipment configuration loaded successfully");
        return config;
    }
    
    private void ValidateConfiguration(EquipmentSystemConfiguration config)
    {
        if (config == null)
            throw new InvalidOperationException("Configuration is null");
            
        if (config.ArmorTypes == null || config.ArmorTypes.Count == 0)
            throw new InvalidOperationException("ArmorTypes not configured");
            
        // æ›´å¤šéªŒè¯...
    }
}
```

### 10.3 é…ç½®çƒ­é‡è½½ï¼ˆå¯é€‰ï¼‰

```csharp
public class ConfigurationWatcher
{
    private FileSystemWatcher _watcher;
    private EquipmentSystemConfiguration _currentConfig;
    
    public event EventHandler<ConfigurationChangedEventArgs> ConfigurationChanged;
    
    public void StartWatching(string configPath)
    {
        _watcher = new FileSystemWatcher
        {
            Path = Path.GetDirectoryName(configPath),
            Filter = Path.GetFileName(configPath),
            NotifyFilter = NotifyFilters.LastWrite
        };
        
        _watcher.Changed += OnConfigChanged;
        _watcher.EnableRaisingEvents = true;
    }
    
    private void OnConfigChanged(object sender, FileSystemEventArgs e)
    {
        // é‡æ–°åŠ è½½é…ç½®
        var newConfig = LoadConfiguration(e.FullPath);
        ConfigurationChanged?.Invoke(this, new ConfigurationChangedEventArgs(newConfig));
    }
}
```

---

## 11. ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆç»†èŠ‚

### 11.1 æˆ˜æ–—ç³»ç»Ÿé›†æˆ

```csharp
// æ‰©å±• StatsBuilder
public class StatsBuilder
{
    private readonly IStatsAggregationService _equipmentStatsService;
    
    public CharacterStats BuildStats(Character character)
    {
        // 1. ä¸»å±æ€§ -> åŸºç¡€å±æ€§è½¬æ¢
        var baseStats = ConvertPrimaryToBase(character.PrimaryAttributes);
        
        // 2. èŒä¸šåŸºç¡€å±æ€§åŠ æˆ
        var professionStats = ApplyProfessionModifiers(baseStats, character.Profession);
        
        // 3. ã€æ–°å¢ã€‘è£…å¤‡å±æ€§æ³¨å…¥
        var equipmentStats = _equipmentStatsService.CalculateEquipmentStats(character.Id);
        var withEquipment = MergeStats(professionStats, equipmentStats);
        
        // 4. Buffå±æ€§åŠ æˆ
        var finalStats = ApplyBuffModifiers(withEquipment, character.Buffs);
        
        return finalStats;
    }
}
```

### 11.2 ç»æµç³»ç»Ÿé›†æˆ

```csharp
// æ‰©å±• EconomyCalculator
public class EconomyCalculator
{
    private readonly IGearGenerationService _gearGenerator;
    
    public List<RewardItem> ComputeSampled(
        Dictionary<string, int> killCounts,
        RNGContext rng)
    {
        var rewards = new List<RewardItem>();
        
        foreach (var (monsterId, count) in killCounts)
        {
            var lootTable = GetLootTable(monsterId);
            
            foreach (var entry in lootTable.Entries)
            {
                // ã€æ–°å¢ã€‘è£…å¤‡æ‰è½å¤„ç†
                if (entry.ItemType == "gear")
                {
                    if (rng.NextDouble() < entry.DropChance)
                    {
                        var gear = _gearGenerator.Generate(
                            entry.ItemId,
                            characterLevel,
                            rng);
                        
                        rewards.Add(new RewardItem
                        {
                            Type = "gear",
                            ItemId = gear.Id.ToString(),
                            Quantity = 1
                        });
                    }
                }
                else
                {
                    // æ™®é€šç‰©å“æ‰è½ï¼ˆç°æœ‰é€»è¾‘ï¼‰
                }
            }
        }
        
        return rewards;
    }
}
```

---

## 12. æŠ€æœ¯å®ç°è§„èŒƒ

### 12.1 ä»£ç è§„èŒƒ

#### å‘½åè§„èŒƒ
- æšä¸¾ä½¿ç”¨ PascalCase
- é…ç½®ç±»åç¼€ Config
- æœåŠ¡ç±»åç¼€ Service
- è®¡ç®—å™¨ç±»åç¼€ Calculator
- éªŒè¯å™¨ç±»åç¼€ Validator

#### æ³¨é‡Šè§„èŒƒ
```csharp
/// <summary>
/// è£…å¤‡ç”ŸæˆæœåŠ¡
/// è´Ÿè´£æ ¹æ®è£…å¤‡å®šä¹‰ç”Ÿæˆè£…å¤‡å®ä¾‹
/// </summary>
public class GearGenerationService
{
    /// <summary>
    /// ç”Ÿæˆè£…å¤‡å®ä¾‹
    /// </summary>
    /// <param name="gearDefId">è£…å¤‡å®šä¹‰ID</param>
    /// <param name="characterLevel">è§’è‰²ç­‰çº§</param>
    /// <param name="rng">éšæœºæ•°ä¸Šä¸‹æ–‡</param>
    /// <returns>ç”Ÿæˆçš„è£…å¤‡å®ä¾‹</returns>
    public GearInstance Generate(
        string gearDefId,
        int characterLevel,
        RNGContext rng)
    {
        // å®ç°...
    }
}
```

### 12.2 é”™è¯¯å¤„ç†

```csharp
// è‡ªå®šä¹‰å¼‚å¸¸
public class EquipmentException : Exception
{
    public string ErrorCode { get; }
    
    public EquipmentException(string message, string errorCode) 
        : base(message)
    {
        ErrorCode = errorCode;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public void EquipItem(Guid characterId, Guid gearId, EquipmentSlot slot)
{
    var gear = _repository.GetById(gearId)
        ?? throw new EquipmentException(
            $"Gear {gearId} not found",
            "GEAR_NOT_FOUND");
    
    if (!CanEquip(characterId, gear))
    {
        throw new EquipmentException(
            "Cannot equip this item",
            "INVALID_EQUIPMENT");
    }
}
```

### 12.3 æ—¥å¿—è§„èŒƒ

```csharp
public class GearGenerationService
{
    private readonly ILogger<GearGenerationService> _logger;
    
    public GearInstance Generate(string gearDefId, int level, RNGContext rng)
    {
        _logger.LogInformation(
            "Generating gear: defId={DefId}, level={Level}, seed={Seed}",
            gearDefId, level, rng.CurrentSeed);
        
        try
        {
            var gear = InternalGenerate(gearDefId, level, rng);
            
            _logger.LogInformation(
                "Gear generated: id={Id}, rarity={Rarity}, score={Score}",
                gear.Id, gear.Rarity, gear.QualityScore);
            
            return gear;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex,
                "Failed to generate gear: defId={DefId}", gearDefId);
            throw;
        }
    }
}
```

### 12.4 æ€§èƒ½ä¼˜åŒ–

#### ç¼“å­˜ç­–ç•¥
```csharp
public class EquipmentStatsCache
{
    private readonly IMemoryCache _cache;
    private const int CacheTTLSeconds = 300; // 5åˆ†é’Ÿ
    
    public Dictionary<StatType, double> GetOrCalculate(
        Guid characterId,
        Func<Dictionary<StatType, double>> calculator)
    {
        var cacheKey = $"equipment_stats_{characterId}";
        
        if (_cache.TryGetValue(cacheKey, out Dictionary<StatType, double> cached))
        {
            return cached;
        }
        
        var stats = calculator();
        _cache.Set(cacheKey, stats, TimeSpan.FromSeconds(CacheTTLSeconds));
        
        return stats;
    }
    
    public void Invalidate(Guid characterId)
    {
        var cacheKey = $"equipment_stats_{characterId}";
        _cache.Remove(cacheKey);
    }
}
```

#### æ‰¹é‡æ“ä½œ
```csharp
public async Task<List<ValidationResult>> ValidateBatchAsync(
    List<(Guid characterId, Guid gearId, EquipmentSlot slot)> operations)
{
    // æ‰¹é‡åŠ è½½æ•°æ®ï¼Œé¿å…N+1æŸ¥è¯¢
    var characterIds = operations.Select(o => o.characterId).Distinct().ToList();
    var gearIds = operations.Select(o => o.gearId).Distinct().ToList();
    
    var characters = await _characterRepo.GetByIdsAsync(characterIds);
    var gears = await _gearRepo.GetByIdsAsync(gearIds);
    
    // æ‰¹é‡éªŒè¯
    var results = new List<ValidationResult>();
    foreach (var op in operations)
    {
        var character = characters.First(c => c.Id == op.characterId);
        var gear = gears.First(g => g.Id == op.gearId);
        
        results.Add(Validate(character, gear, op.slot));
    }
    
    return results;
}
```

---

## æ€»ç»“

æœ¬æ–‡æ¡£ï¼ˆä¸­ç¯‡ï¼‰å®Œæˆäº†è£…å¤‡ç³»ç»Ÿçš„è¯¦ç»†æ‰§è¡Œè®¡åˆ’å’ŒæŠ€æœ¯è§„èŒƒï¼ŒåŒ…æ‹¬ï¼š

1. âœ… **8ä¸ªPhaseæ‰§è¡Œè®¡åˆ’**: ä»åŸºç¡€åˆ°é«˜çº§çš„å®Œæ•´å®æ–½è·¯å¾„
2. âœ… **è¯¦ç»†ä»»åŠ¡æ¸…å•**: æ¯ä¸ªPhaseçš„å…·ä½“ä»»åŠ¡å’ŒéªŒæ”¶æ ‡å‡†
3. âœ… **é…ç½®åŒ–è®¾è®¡å®ç°**: é…ç½®æ–‡ä»¶ç»„ç»‡ã€åŠ è½½æœºåˆ¶ã€çƒ­é‡è½½
4. âœ… **ç³»ç»Ÿé›†æˆç»†èŠ‚**: æˆ˜æ–—ç³»ç»Ÿã€ç»æµç³»ç»Ÿé›†æˆæ–¹æ¡ˆ
5. âœ… **æŠ€æœ¯å®ç°è§„èŒƒ**: ä»£ç è§„èŒƒã€é”™è¯¯å¤„ç†ã€æ—¥å¿—ã€æ€§èƒ½ä¼˜åŒ–

---

## ä¸‹ä¸€æ­¥

è¯·å‚é˜…ï¼š
- **ã€Šè£…å¤‡ç³»ç»Ÿä¼˜åŒ–æ€»ä½“æ–¹æ¡ˆï¼ˆä¸‹ï¼‰ã€‹**: å®Œæ•´çš„æµ‹è¯•ç­–ç•¥ã€æ•°å€¼å¹³è¡¡è®¾è®¡ã€å‰ç«¯éªŒè¯æ–¹æ¡ˆã€æ‰©å±•æ€§è®¾è®¡

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0 æ•´åˆç‰ˆ  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-11  
**ç»´æŠ¤è´Ÿè´£**: å¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
