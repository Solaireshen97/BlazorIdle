# BlazorIdle 装备系统优化总体方案（中篇）
## 执行计划与技术规范

**项目**: BlazorIdle  
**文档版本**: 2.0 整合版  
**创建日期**: 2025-10-11  
**状态**: 设计阶段 - 整合完成  
**作者**: 系统架构设计团队  

---

## 📋 文档说明

本文档为《装备系统优化总体方案》的中篇，专注于详细的执行计划和技术实现规范。

### 与上下篇的关系

- **上篇**: 系统分析与架构设计 ← 当前基础
- **中篇**（本文档）: 执行计划与技术规范 ← 如何实施
- **下篇**: 测试验证与扩展设计 ← 质量保证

---

## 目录

1. [整合执行计划概览](#1-整合执行计划概览)
2. [Phase 1: 数据基础与核心模型](#phase-1-数据基础与核心模型第1-2周)
3. [Phase 2: 装备生成与掉落](#phase-2-装备生成与掉落第3-4周)
4. [Phase 3: 装备管理与属性计算](#phase-3-装备管理与属性计算第5-6周)
5. [Phase 4: 17槽位与护甲系统](#phase-4-17槽位与护甲系统第7-8周)
6. [Phase 5: 武器类型与战斗机制](#phase-5-武器类型与战斗机制第9-11周)
7. [Phase 6: 职业限制与前端实现](#phase-6-职业限制与前端实现第12-14周)
8. [Phase 7: 装备增强系统](#phase-7-装备增强系统第15-16周)
9. [Phase 8: 测试优化与上线](#phase-8-测试优化与上线第17-18周)
10. [配置化设计实现方案](#10-配置化设计实现方案)
11. [与现有系统的集成细节](#11-与现有系统的集成细节)
12. [技术实现规范](#12-技术实现规范)

---

## 1. 整合执行计划概览

### 1.1 Phase概览

本总体方案将两套原有方案（8-Phase和5-Phase）整合优化为 **8个Phase**，涵盖从基础到高级的完整实施路径。

| Phase | 周期 | 核心目标 | 前置依赖 | 验证标准 |
|-------|------|---------|---------|---------|
| **Phase 1** | 1-2周 | 数据基础与核心模型 | 无 | 数据库迁移成功 |
| **Phase 2** | 3-4周 | 装备生成与掉落 | Phase 1 | 装备可生成并掉落 |
| **Phase 3** | 5-6周 | 装备管理与属性计算 | Phase 2 | 装备可装备并影响战斗 |
| **Phase 4** | 7-8周 | 17槽位与护甲系统 | Phase 3 | 17槽位可用，护甲减伤生效 |
| **Phase 5** | 9-11周 | 武器类型与战斗机制 | Phase 4 | 武器类型影响战斗 |
| **Phase 6** | 12-14周 | 职业限制与前端实现 | Phase 5 | 前端17槽位完整可用 |
| **Phase 7** | 15-16周 | 装备增强系统 | Phase 6 | 分解/重铸/重置可用 |
| **Phase 8** | 17-18周 | 测试优化与上线 | Phase 7 | 全系统测试通过 |

### 1.2 整合优化点

相比原有两套方案，整合方案的改进：

1. **Phase 1-2**: 整合了基础数据模型和装备生成（原方案一的Phase 1-2）
2. **Phase 3**: 统一了装备管理和属性计算（原方案一的Phase 3）
3. **Phase 4**: 引入17槽位和护甲系统（原方案二的核心）
4. **Phase 5**: 引入武器类型和战斗机制（原方案二的核心）
5. **Phase 6**: 整合职业限制和前端实现（两套方案的UI部分合并）
6. **Phase 7**: 保留装备增强系统（原方案一的Phase 5）
7. **Phase 8**: 新增综合测试和上线准备（原方案的测试部分整合）

### 1.3 关键里程碑

| 里程碑 | 时间点 | 成果 | 前端可验证内容 |
|--------|--------|------|---------------|
| **M1: 基础可用** | 第4周末 | 装备可生成并掉落 | 战斗后获得装备，显示在背包 |
| **M2: 装备可用** | 第6周末 | 装备可装备并影响战斗 | 装备面板可操作，战斗属性变化 |
| **M3: 系统完整** | 第11周末 | 17槽位、护甲、武器类型全部可用 | 完整装备UI，战斗机制体现 |
| **M4: 功能完善** | 第14周末 | 职业限制、前端优化完成 | 职业限制生效，UI流畅美观 |
| **M5: 上线准备** | 第18周末 | 全系统测试通过，准备上线 | 完整功能验证通过 |

---

## Phase 1: 数据基础与核心模型（第1-2周）

### 目标
建立装备系统的数据基础，包括数据库表、领域模型、枚举定义和配置加载机制。

---

### 任务清单

#### Task 1.1: 创建枚举和基础类型

**优先级**: ⭐⭐⭐⭐⭐  
**预计工时**: 4小时

```csharp
// Models/EquipmentSlot.cs
public enum EquipmentSlot
{
    Head, Neck, Shoulder, Back, Chest,
    Wrist, Hands, Waist, Legs, Feet,
    Finger1, Finger2, Trinket1, Trinket2,
    MainHand, OffHand, TwoHand
}

// Models/ArmorType.cs
public enum ArmorType
{
    None, Cloth, Leather, Mail, Plate
}

// Models/WeaponType.cs
public enum WeaponType
{
    None,
    // 单手武器
    Sword, Dagger, Axe, Mace, Fist, Wand,
    // 双手武器
    TwoHandSword, TwoHandAxe, TwoHandMace,
    Staff, Polearm,
    // 远程武器
    Bow, Crossbow, Gun,
    // 副手专用
    Shield
}

// Models/Rarity.cs
public enum Rarity
{
    Common, Rare, Epic, Legendary
}

// Models/ModifierType.cs
public enum ModifierType
{
    Flat, Percent, Proc
}

// Models/SlotCategory.cs
public enum SlotCategory
{
    Armor, Jewelry, Weapon
}
```

**验收标准**:
- ✅ 所有枚举定义完整
- ✅ XML文档注释完整
- ✅ 枚举值与设计文档一致

#### Task 1.2: 创建领域模型实体

**优先级**: ⭐⭐⭐⭐⭐  
**预计工时**: 8小时

```csharp
// Models/GearDefinition.cs
public class GearDefinition
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Icon { get; set; }
    public EquipmentSlot Slot { get; set; }
    public ArmorType ArmorType { get; set; }
    public WeaponType WeaponType { get; set; }
    public int RequiredLevel { get; set; }
    public Dictionary<StatType, StatRange> BaseStats { get; set; }
    public List<string> AllowedAffixPool { get; set; }
    public Dictionary<Rarity, double> RarityWeights { get; set; }
    public string? SetId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// Models/GearInstance.cs
public class GearInstance
{
    public Guid Id { get; set; }
    public string DefinitionId { get; set; }
    public Guid? CharacterId { get; set; }
    public EquipmentSlot? SlotType { get; set; }
    public Rarity Rarity { get; set; }
    public int TierLevel { get; set; }
    public int ItemLevel { get; set; }
    public Dictionary<StatType, double> RolledStats { get; set; }
    public List<AffixInstance> Affixes { get; set; }
    public int QualityScore { get; set; }
    public bool IsEquipped { get; set; }
    public bool IsBound { get; set; }
    public int RerollCount { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // 导航属性
    public Character? Character { get; set; }
    public GearDefinition Definition { get; set; }
}

// Models/Affix.cs
public class Affix
{
    public string Id { get; set; }
    public string Name { get; set; }
    public StatType StatType { get; set; }
    public ModifierType ModifierType { get; set; }
    public double ValueMin { get; set; }
    public double ValueMax { get; set; }
    public double RarityWeight { get; set; }
    public List<EquipmentSlot>? AllowedSlots { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// ValueObjects/AffixInstance.cs
public class AffixInstance
{
    public string AffixId { get; set; }
    public StatType StatType { get; set; }
    public ModifierType ModifierType { get; set; }
    public double RolledValue { get; set; }
    public string DisplayText { get; set; }
}

// Models/GearSet.cs
public class GearSet
{
    public string Id { get; set; }
    public string Name { get; set; }
    public List<string> Pieces { get; set; }
    public Dictionary<int, List<StatModifier>> Bonuses { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// ValueObjects/StatRange.cs
public class StatRange
{
    public double Min { get; set; }
    public double Max { get; set; }
}

// ValueObjects/StatModifier.cs
public class StatModifier
{
    public StatType StatType { get; set; }
    public ModifierType ModifierType { get; set; }
    public double Value { get; set; }
}
```

**验收标准**:
- ✅ 所有实体和值对象定义完整
- ✅ 属性与数据库设计一致
- ✅ 导航属性正确配置

#### Task 1.3: EF Core配置

**优先级**: ⭐⭐⭐⭐⭐  
**预计工时**: 6小时

```csharp
// Infrastructure/Persistence/Configurations/GearDefinitionConfiguration.cs
public class GearDefinitionConfiguration : IEntityTypeConfiguration<GearDefinition>
{
    public void Configure(EntityTypeBuilder<GearDefinition> builder)
    {
        builder.ToTable("GearDefinitions");
        builder.HasKey(g => g.Id);
        
        builder.Property(g => g.Id).HasMaxLength(100);
        builder.Property(g => g.Name).HasMaxLength(200).IsRequired();
        builder.Property(g => g.Icon).HasMaxLength(50);
        builder.Property(g => g.Slot).HasConversion<string>().HasMaxLength(50);
        builder.Property(g => g.ArmorType).HasConversion<string>().HasMaxLength(20);
        builder.Property(g => g.WeaponType).HasConversion<string>().HasMaxLength(30);
        
        // JSON字段存储
        builder.Property(g => g.BaseStats)
            .HasColumnName("BaseStatsJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<Dictionary<StatType, StatRange>>(v, (JsonSerializerOptions)null));
        
        builder.Property(g => g.AllowedAffixPool)
            .HasColumnName("AllowedAffixPoolJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<List<string>>(v, (JsonSerializerOptions)null));
        
        builder.Property(g => g.RarityWeights)
            .HasColumnName("RarityWeightsJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<Dictionary<Rarity, double>>(v, (JsonSerializerOptions)null));
        
        builder.HasIndex(g => g.Slot);
        builder.HasIndex(g => g.SetId);
    }
}

// Infrastructure/Persistence/Configurations/GearInstanceConfiguration.cs
public class GearInstanceConfiguration : IEntityTypeConfiguration<GearInstance>
{
    public void Configure(EntityTypeBuilder<GearInstance> builder)
    {
        builder.ToTable("GearInstances");
        builder.HasKey(g => g.Id);
        
        builder.Property(g => g.DefinitionId).HasMaxLength(100).IsRequired();
        builder.Property(g => g.SlotType).HasConversion<string>().HasMaxLength(50);
        builder.Property(g => g.Rarity).HasConversion<string>().HasMaxLength(50).IsRequired();
        
        // JSON字段存储
        builder.Property(g => g.RolledStats)
            .HasColumnName("RolledStatsJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<Dictionary<StatType, double>>(v, (JsonSerializerOptions)null))
            .IsRequired();
        
        builder.Property(g => g.Affixes)
            .HasColumnName("AffixesJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<List<AffixInstance>>(v, (JsonSerializerOptions)null))
            .IsRequired();
        
        // 外键关系
        builder.HasOne(g => g.Character)
            .WithMany()
            .HasForeignKey(g => g.CharacterId)
            .OnDelete(DeleteBehavior.Cascade);
        
        builder.HasOne(g => g.Definition)
            .WithMany()
            .HasForeignKey(g => g.DefinitionId)
            .OnDelete(DeleteBehavior.Restrict);
        
        // 索引
        builder.HasIndex(g => g.CharacterId);
        builder.HasIndex(g => g.IsEquipped);
        builder.HasIndex(g => g.Rarity);
        builder.HasIndex(g => g.DefinitionId);
    }
}

// 类似配置: AffixConfiguration, GearSetConfiguration
```

**验收标准**:
- ✅ 所有实体配置完整
- ✅ JSON序列化/反序列化正确
- ✅ 外键关系正确
- ✅ 索引配置合理

#### Task 1.4: 数据库迁移

**优先级**: ⭐⭐⭐⭐⭐  
**预计工时**: 4小时

```bash
# 创建迁移
dotnet ef migrations add AddEquipmentSystem

# 应用迁移
dotnet ef database update
```

**验收标准**:
- ✅ 迁移文件生成成功
- ✅ 数据库更新成功
- ✅ 所有表和索引创建正确

#### Task 1.5: 创建仓储接口和实现

**优先级**: ⭐⭐⭐⭐  
**预计工时**: 8小时

```csharp
// Repositories/IGearDefinitionRepository.cs
public interface IGearDefinitionRepository
{
    Task<GearDefinition?> GetByIdAsync(string id);
    Task<List<GearDefinition>> GetBySlotAsync(EquipmentSlot slot);
    Task<List<GearDefinition>> GetAllAsync();
    Task CreateAsync(GearDefinition definition);
    Task UpdateAsync(GearDefinition definition);
    Task DeleteAsync(string id);
}

// Repositories/IGearInstanceRepository.cs
public interface IGearInstanceRepository
{
    Task<GearInstance?> GetByIdAsync(Guid id);
    Task<List<GearInstance>> GetEquippedGearAsync(Guid characterId);
    Task<List<GearInstance>> GetGearByCharacterAsync(Guid characterId);
    Task<GearInstance?> GetEquippedGearBySlotAsync(Guid characterId, EquipmentSlot slot);
    Task CreateAsync(GearInstance instance);
    Task UpdateAsync(GearInstance instance);
    Task DeleteAsync(Guid id);
}

// 实现类在 Infrastructure/Persistence/Repositories/
```

**验收标准**:
- ✅ 所有仓储接口定义完整
- ✅ 仓储实现正确使用EF Core
- ✅ 异步操作正确实现

#### Task 1.6: 创建配置类

**优先级**: ⭐⭐⭐⭐  
**预计工时**: 6小时

```csharp
// Configuration/ArmorTypeConfig.cs
public class ArmorTypeConfig
{
    public ArmorType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    public double BaseArmorMultiplier { get; set; }
    public double StaminaMultiplier { get; set; }
    public Dictionary<string, double> SecondaryStatWeights { get; set; }
    public List<EquipmentSlot> ApplicableSlots { get; set; }
}

// Configuration/WeaponTypeConfig.cs
public class WeaponTypeConfig
{
    public WeaponType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    public double BaseAttackSpeed { get; set; }
    public double AttackPowerMultiplier { get; set; }
    public List<EquipmentSlot> AllowedSlots { get; set; }
    public DamageType PrimaryDamageType { get; set; }
    public bool AllowsDualWield { get; set; }
    public bool IsRangedWeapon { get; set; }
    public bool IsTwoHanded { get; set; }
}

// Configuration/EquipmentSystemConfiguration.cs
public class EquipmentSystemConfiguration
{
    public string Version { get; set; }
    public List<ArmorTypeConfig> ArmorTypes { get; set; }
    public List<WeaponTypeConfig> WeaponTypes { get; set; }
    public List<ProfessionEquipmentConfig> ProfessionRestrictions { get; set; }
    public CombatMechanicsConfig CombatMechanics { get; set; }
    
    // 单例模式
    private static EquipmentSystemConfiguration? _instance;
    public static EquipmentSystemConfiguration Instance => 
        _instance ??= LoadFromJson("EquipmentSystemConfig.json");
    
    private static EquipmentSystemConfiguration LoadFromJson(string path)
    {
        var json = File.ReadAllText(path);
        return JsonSerializer.Deserialize<EquipmentSystemConfiguration>(json)
            ?? throw new InvalidOperationException("Failed to load configuration");
    }
}
```

**验收标准**:
- ✅ 所有配置类定义完整
- ✅ JSON加载机制正确
- ✅ 单例模式实现正确

#### Task 1.7: 创建配置JSON文件

**优先级**: ⭐⭐⭐⭐  
**预计工时**: 4小时

```json
// EquipmentSystemConfig.json
{
  "Version": "1.0",
  "ArmorTypes": [
    {
      "TypeId": "cloth",
      "DisplayName": "布甲",
      "Type": "Cloth",
      "BaseArmorMultiplier": 0.5,
      "StaminaMultiplier": 1.0,
      "SecondaryStatWeights": {
        "Intellect": 1.5,
        "SpellPower": 1.3
      },
      "ApplicableSlots": ["Head", "Shoulder", "Chest", "Wrist", "Hands", "Waist", "Legs", "Feet"]
    },
    {
      "TypeId": "plate",
      "DisplayName": "板甲",
      "Type": "Plate",
      "BaseArmorMultiplier": 2.0,
      "StaminaMultiplier": 1.5,
      "SecondaryStatWeights": {
        "Strength": 1.5,
        "Stamina": 1.4
      },
      "ApplicableSlots": ["Head", "Shoulder", "Chest", "Wrist", "Hands", "Waist", "Legs", "Feet"]
    }
  ],
  "WeaponTypes": [
    {
      "TypeId": "sword",
      "DisplayName": "剑",
      "Type": "Sword",
      "BaseAttackSpeed": 2.5,
      "AttackPowerMultiplier": 1.0,
      "AllowedSlots": ["MainHand", "OffHand"],
      "PrimaryDamageType": "Physical",
      "AllowsDualWield": true,
      "IsRangedWeapon": false,
      "IsTwoHanded": false
    }
  ],
  "CombatMechanics": {
    "Armor": {
      "ReductionConstant": 400,
      "MaxReduction": 0.75
    },
    "Block": {
      "BaseBlockChance": 0.05,
      "BlockDamageReduction": 0.30,
      "BlockChancePerStrength": 0.001,
      "BlockChancePerItemLevel": 0.002,
      "MaxBlockChance": 0.50
    }
  }
}
```

**验收标准**:
- ✅ JSON格式正确
- ✅ 所有配置参数完整
- ✅ 配置可正常加载

#### Task 1.8: 种子数据

**优先级**: ⭐⭐⭐  
**预计工时**: 8小时

创建初始装备定义、词条定义、套装定义的种子数据。

**验收标准**:
- ✅ 至少10个装备定义
- ✅ 至少20个词条定义
- ✅ 至少1个套装定义

#### Task 1.9: 单元测试

**优先级**: ⭐⭐⭐⭐  
**预计工时**: 8小时

```csharp
// Tests/Equipment/Models/GearInstanceTests.cs
public class GearInstanceTests
{
    [Fact]
    public void GearInstance_Should_Initialize_Correctly()
    {
        // Arrange & Act
        var gear = new GearInstance
        {
            Id = Guid.NewGuid(),
            DefinitionId = "sword_iron",
            Rarity = Rarity.Common,
            TierLevel = 1
        };
        
        // Assert
        gear.Should().NotBeNull();
        gear.Id.Should().NotBeEmpty();
        gear.TierLevel.Should().Be(1);
    }
}
```

**验收标准**:
- ✅ 单元测试覆盖率 ≥ 90%
- ✅ 所有测试通过

---

### Phase 1 验收标准

| 验收项 | 标准 | 验证方式 |
|--------|------|---------|
| 数据库迁移 | 成功执行，所有表创建 | 查询数据库 |
| 实体定义 | 完整且符合设计 | Code Review |
| 仓储实现 | CRUD操作正常 | 单元测试 |
| 配置加载 | JSON配置可正常加载 | 集成测试 |
| 种子数据 | 初始数据正确插入 | 查询数据库 |
| 单元测试 | 覆盖率≥90%，全部通过 | 测试报告 |

---

(由于篇幅限制，后续Phase将简要列出关键任务，详细实现参考类似结构)

---

## Phase 2: 装备生成与掉落（第3-4周）

### 目标
实现装备生成逻辑和掉落系统集成

### 关键任务

1. **GearGenerationService** (8h)
   - 实现稀有度随机
   - 实现基础属性Roll
   - 实现词条生成
   - 实现装备评分计算

2. **经济系统集成** (6h)
   - 扩展EconomyRegistry支持装备
   - 配置装备掉落表
   - 集成到RewardGrantService

3. **RNG控制** (4h)
   - 使用RNGContext保证可回放
   - 记录装备生成种子

4. **单元测试** (8h)

### 验收标准
- ✅ 装备可生成，各稀有度装备正常
- ✅ 装备掉落集成到战斗奖励
- ✅ RNG可回放验证

---

## Phase 3: 装备管理与属性计算（第5-6周）

### 目标
实现装备/卸下操作和属性聚合计算

### 关键任务

1. **EquipmentService** (12h)
   - EquipItem方法
   - UnequipItem方法
   - SwapGear方法
   - 装备验证逻辑

2. **StatsAggregationService** (10h)
   - 属性聚合算法
   - 数值管线实现
   - 缓存机制

3. **战斗系统集成** (8h)
   - 扩展StatsBuilder注入装备属性
   - 验证战斗中装备属性生效

4. **API实现** (6h)
   - 更新EquipmentController

5. **单元测试与集成测试** (10h)

### 验收标准
- ✅ 装备/卸下操作正常
- ✅ 装备属性正确影响战斗
- ✅ API正常工作

---

## Phase 4: 17槽位与护甲系统（第7-8周）

### 目标
扩展到17个装备槽位并实现护甲类型系统

### 关键任务

1. **槽位扩展** (8h)
   - 更新EquipmentSlot枚举（已在Phase 1完成）
   - 扩展前端DTO支持17槽位
   - 更新API返回17槽位

2. **护甲计算** (10h)
   - ArmorCalculator实现
   - 护甲减伤集成到战斗
   - 护甲值聚合

3. **装备生成增强** (6h)
   - 根据护甲类型生成属性
   - 应用护甲类型系数

4. **数据库迁移** (4h)
   - 添加ArmorType字段
   - 添加BaseArmor字段

5. **测试** (10h)

### 验收标准
- ✅ 17槽位可用
- ✅ 护甲减伤在战斗中生效
- ✅ 不同护甲类型有明显差异

---

## Phase 5: 武器类型与战斗机制（第9-11周）

### 目标
实现武器类型系统、攻击速度、格挡机制

### 关键任务

1. **武器类型实现** (8h)
   - 扩展GearInstance添加武器属性
   - 武器类型配置加载

2. **攻击速度计算** (8h)
   - AttackSpeedCalculator
   - 集成到战斗系统
   - 双持速度计算

3. **伤害计算重构** (10h)
   - 集成武器倍率
   - 双持伤害计算

4. **格挡机制** (10h)
   - BlockCalculator
   - 格挡判定集成到战斗
   - 格挡事件记录

5. **双手武器机制** (6h)
   - 装备双手武器占用逻辑
   - UI提示

6. **测试** (12h)

### 验收标准
- ✅ 不同武器类型有不同攻击速度和伤害
- ✅ 双持计算正确
- ✅ 格挡机制正常工作
- ✅ 双手武器正确占用主副手

---

## Phase 6: 职业限制与前端实现（第12-14周）

### 目标
实现职业装备限制并完善前端17槽位UI

### 关键任务

1. **装备限制验证** (8h)
   - EquipmentValidator
   - 职业-护甲类型验证
   - 职业-武器类型验证

2. **装备API集成** (6h)
   - 添加装备前验证
   - 返回友好错误信息

3. **前端装备面板重构** (16h)
   - 扩展EquipmentPanel.razor支持17槽位
   - 新布局设计
   - 槽位图标和名称更新

4. **装备详情增强** (12h)
   - 显示护甲类型和数值
   - 显示武器类型和攻击速度
   - 显示格挡概率
   - 职业限制提示

5. **装备对比功能** (8h)
   - Tooltip显示对比信息
   - 高亮属性变化

6. **测试** (12h)

### 验收标准
- ✅ 所有职业装备限制正确生效
- ✅ 前端17槽位完整可用
- ✅ 装备对比功能正常

---

## Phase 7: 装备增强系统（第15-16周）

### 目标
实现装备分解、重铸、词条重置

### 关键任务

1. **DisenchantService** (8h)
   - 分解算法
   - 材料产出计算
   - 经济事件记录

2. **ReforgeService** (10h)
   - 品级重铸
   - 词条重置
   - 成本计算

3. **API实现** (6h)
   - 分解、重铸、重置API

4. **前端增强界面** (12h)
   - GearEnhancementDialog组件
   - 分解/重铸/重置UI

5. **测试** (10h)

### 验收标准
- ✅ 分解功能正常，产出正确
- ✅ 品级重铸正确提升装备
- ✅ 词条重置正确重新生成词条

---

## Phase 8: 测试优化与上线（第17-18周）

### 目标
全系统测试、性能优化、上线准备

### 关键任务

1. **全系统测试** (16h)
   - E2E测试完整装备流程
   - 性能测试
   - 压力测试
   - 兼容性测试

2. **性能优化** (10h)
   - 装备属性计算优化
   - 数据库查询优化
   - 前端渲染优化

3. **文档完善** (8h)
   - API文档
   - 用户手册
   - 运维文档

4. **上线准备** (8h)
   - 灰度发布计划
   - 监控指标配置
   - 回滚方案

### 验收标准
- ✅ 所有测试通过
- ✅ 性能满足指标
- ✅ 文档完整
- ✅ 上线准备就绪

---

## 10. 配置化设计实现方案

### 10.1 配置文件组织

```
BlazorIdle.Server/Configuration/
├── EquipmentSystemConfig.json       # 主配置文件
├── GearDefinitions.json             # 装备定义（可选，也可存数据库）
├── AffixDefinitions.json            # 词条定义（可选）
└── GearSets.json                    # 套装定义（可选）
```

### 10.2 配置加载机制

```csharp
public class ConfigurationService
{
    private readonly ILogger<ConfigurationService> _logger;
    private readonly IConfiguration _configuration;
    
    public ConfigurationService(
        ILogger<ConfigurationService> logger,
        IConfiguration configuration)
    {
        _logger = logger;
        _configuration = configuration;
    }
    
    public EquipmentSystemConfiguration LoadEquipmentConfig()
    {
        var path = Path.Combine(AppContext.BaseDirectory, "Configuration", "EquipmentSystemConfig.json");
        var json = File.ReadAllText(path);
        var config = JsonSerializer.Deserialize<EquipmentSystemConfiguration>(json);
        
        // 验证配置
        ValidateConfiguration(config);
        
        _logger.LogInformation("Equipment configuration loaded successfully");
        return config;
    }
    
    private void ValidateConfiguration(EquipmentSystemConfiguration config)
    {
        if (config == null)
            throw new InvalidOperationException("Configuration is null");
            
        if (config.ArmorTypes == null || config.ArmorTypes.Count == 0)
            throw new InvalidOperationException("ArmorTypes not configured");
            
        // 更多验证...
    }
}
```

### 10.3 配置热重载（可选）

```csharp
public class ConfigurationWatcher
{
    private FileSystemWatcher _watcher;
    private EquipmentSystemConfiguration _currentConfig;
    
    public event EventHandler<ConfigurationChangedEventArgs> ConfigurationChanged;
    
    public void StartWatching(string configPath)
    {
        _watcher = new FileSystemWatcher
        {
            Path = Path.GetDirectoryName(configPath),
            Filter = Path.GetFileName(configPath),
            NotifyFilter = NotifyFilters.LastWrite
        };
        
        _watcher.Changed += OnConfigChanged;
        _watcher.EnableRaisingEvents = true;
    }
    
    private void OnConfigChanged(object sender, FileSystemEventArgs e)
    {
        // 重新加载配置
        var newConfig = LoadConfiguration(e.FullPath);
        ConfigurationChanged?.Invoke(this, new ConfigurationChangedEventArgs(newConfig));
    }
}
```

---

## 11. 与现有系统的集成细节

### 11.1 战斗系统集成

```csharp
// 扩展 StatsBuilder
public class StatsBuilder
{
    private readonly IStatsAggregationService _equipmentStatsService;
    
    public CharacterStats BuildStats(Character character)
    {
        // 1. 主属性 -> 基础属性转换
        var baseStats = ConvertPrimaryToBase(character.PrimaryAttributes);
        
        // 2. 职业基础属性加成
        var professionStats = ApplyProfessionModifiers(baseStats, character.Profession);
        
        // 3. 【新增】装备属性注入
        var equipmentStats = _equipmentStatsService.CalculateEquipmentStats(character.Id);
        var withEquipment = MergeStats(professionStats, equipmentStats);
        
        // 4. Buff属性加成
        var finalStats = ApplyBuffModifiers(withEquipment, character.Buffs);
        
        return finalStats;
    }
}
```

### 11.2 经济系统集成

```csharp
// 扩展 EconomyCalculator
public class EconomyCalculator
{
    private readonly IGearGenerationService _gearGenerator;
    
    public List<RewardItem> ComputeSampled(
        Dictionary<string, int> killCounts,
        RNGContext rng)
    {
        var rewards = new List<RewardItem>();
        
        foreach (var (monsterId, count) in killCounts)
        {
            var lootTable = GetLootTable(monsterId);
            
            foreach (var entry in lootTable.Entries)
            {
                // 【新增】装备掉落处理
                if (entry.ItemType == "gear")
                {
                    if (rng.NextDouble() < entry.DropChance)
                    {
                        var gear = _gearGenerator.Generate(
                            entry.ItemId,
                            characterLevel,
                            rng);
                        
                        rewards.Add(new RewardItem
                        {
                            Type = "gear",
                            ItemId = gear.Id.ToString(),
                            Quantity = 1
                        });
                    }
                }
                else
                {
                    // 普通物品掉落（现有逻辑）
                }
            }
        }
        
        return rewards;
    }
}
```

---

## 12. 技术实现规范

### 12.1 代码规范

#### 命名规范
- 枚举使用 PascalCase
- 配置类后缀 Config
- 服务类后缀 Service
- 计算器类后缀 Calculator
- 验证器类后缀 Validator

#### 注释规范
```csharp
/// <summary>
/// 装备生成服务
/// 负责根据装备定义生成装备实例
/// </summary>
public class GearGenerationService
{
    /// <summary>
    /// 生成装备实例
    /// </summary>
    /// <param name="gearDefId">装备定义ID</param>
    /// <param name="characterLevel">角色等级</param>
    /// <param name="rng">随机数上下文</param>
    /// <returns>生成的装备实例</returns>
    public GearInstance Generate(
        string gearDefId,
        int characterLevel,
        RNGContext rng)
    {
        // 实现...
    }
}
```

### 12.2 错误处理

```csharp
// 自定义异常
public class EquipmentException : Exception
{
    public string ErrorCode { get; }
    
    public EquipmentException(string message, string errorCode) 
        : base(message)
    {
        ErrorCode = errorCode;
    }
}

// 使用示例
public void EquipItem(Guid characterId, Guid gearId, EquipmentSlot slot)
{
    var gear = _repository.GetById(gearId)
        ?? throw new EquipmentException(
            $"Gear {gearId} not found",
            "GEAR_NOT_FOUND");
    
    if (!CanEquip(characterId, gear))
    {
        throw new EquipmentException(
            "Cannot equip this item",
            "INVALID_EQUIPMENT");
    }
}
```

### 12.3 日志规范

```csharp
public class GearGenerationService
{
    private readonly ILogger<GearGenerationService> _logger;
    
    public GearInstance Generate(string gearDefId, int level, RNGContext rng)
    {
        _logger.LogInformation(
            "Generating gear: defId={DefId}, level={Level}, seed={Seed}",
            gearDefId, level, rng.CurrentSeed);
        
        try
        {
            var gear = InternalGenerate(gearDefId, level, rng);
            
            _logger.LogInformation(
                "Gear generated: id={Id}, rarity={Rarity}, score={Score}",
                gear.Id, gear.Rarity, gear.QualityScore);
            
            return gear;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex,
                "Failed to generate gear: defId={DefId}", gearDefId);
            throw;
        }
    }
}
```

### 12.4 性能优化

#### 缓存策略
```csharp
public class EquipmentStatsCache
{
    private readonly IMemoryCache _cache;
    private const int CacheTTLSeconds = 300; // 5分钟
    
    public Dictionary<StatType, double> GetOrCalculate(
        Guid characterId,
        Func<Dictionary<StatType, double>> calculator)
    {
        var cacheKey = $"equipment_stats_{characterId}";
        
        if (_cache.TryGetValue(cacheKey, out Dictionary<StatType, double> cached))
        {
            return cached;
        }
        
        var stats = calculator();
        _cache.Set(cacheKey, stats, TimeSpan.FromSeconds(CacheTTLSeconds));
        
        return stats;
    }
    
    public void Invalidate(Guid characterId)
    {
        var cacheKey = $"equipment_stats_{characterId}";
        _cache.Remove(cacheKey);
    }
}
```

#### 批量操作
```csharp
public async Task<List<ValidationResult>> ValidateBatchAsync(
    List<(Guid characterId, Guid gearId, EquipmentSlot slot)> operations)
{
    // 批量加载数据，避免N+1查询
    var characterIds = operations.Select(o => o.characterId).Distinct().ToList();
    var gearIds = operations.Select(o => o.gearId).Distinct().ToList();
    
    var characters = await _characterRepo.GetByIdsAsync(characterIds);
    var gears = await _gearRepo.GetByIdsAsync(gearIds);
    
    // 批量验证
    var results = new List<ValidationResult>();
    foreach (var op in operations)
    {
        var character = characters.First(c => c.Id == op.characterId);
        var gear = gears.First(g => g.Id == op.gearId);
        
        results.Add(Validate(character, gear, op.slot));
    }
    
    return results;
}
```

---

## 总结

本文档（中篇）完成了装备系统的详细执行计划和技术规范，包括：

1. ✅ **8个Phase执行计划**: 从基础到高级的完整实施路径
2. ✅ **详细任务清单**: 每个Phase的具体任务和验收标准
3. ✅ **配置化设计实现**: 配置文件组织、加载机制、热重载
4. ✅ **系统集成细节**: 战斗系统、经济系统集成方案
5. ✅ **技术实现规范**: 代码规范、错误处理、日志、性能优化

---

## 下一步

请参阅：
- **《装备系统优化总体方案（下）》**: 完整的测试策略、数值平衡设计、前端验证方案、扩展性设计

---

**文档版本**: 2.0 整合版  
**创建日期**: 2025-10-11  
**维护负责**: 开发团队  
**状态**: ✅ 已完成
