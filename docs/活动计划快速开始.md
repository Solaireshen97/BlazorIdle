# æ´»åŠ¨è®¡åˆ’ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ç®€ä»‹

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ å¿«é€Ÿäº†è§£å’Œä½¿ç”¨æ´»åŠ¨è®¡åˆ’ç³»ç»Ÿã€‚

## âœ¨ æ–°ç‰¹æ€§ï¼šè‡ªåŠ¨æ‰§è¡Œ

**æ´»åŠ¨è®¡åˆ’ç°åœ¨æ”¯æŒè‡ªåŠ¨æ‰§è¡Œï¼**

- åˆ›å»ºè®¡åˆ’æ—¶ï¼Œå¦‚æœè§’è‰²æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œä¼š**è‡ªåŠ¨å¯åŠ¨**
- ä»»åŠ¡å®Œæˆåï¼Œä¼š**è‡ªåŠ¨å¯åŠ¨**ä¸‹ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
- ä½ åªéœ€è¦åˆ›å»ºè®¡åˆ’ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ä»»åŠ¡çš„æ‰§è¡Œå’Œé˜Ÿåˆ—ç®¡ç†

è¯¦ç»†äº†è§£è¯·æŸ¥çœ‹ [è‡ªåŠ¨æ‰§è¡Œæ–‡æ¡£](./activity-plan-auto-execution.md)

## 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹

### æ­¥éª¤ 1ï¼šåˆ›å»ºä¸€ä¸ªæˆ˜æ–—è®¡åˆ’

ä½¿ç”¨ Postmanã€curl æˆ–å…¶ä»– HTTP å®¢æˆ·ç«¯ï¼š

```bash
POST http://localhost:5000/api/activity-plans/combat?characterId=ä½ çš„è§’è‰²ID&limitType=duration&limitValue=600&enemyId=dummy
```

å‚æ•°è¯´æ˜ï¼š
- `characterId`: ä½ çš„è§’è‰²IDï¼ˆä»è§’è‰²åˆ›å»ºæˆ–æŸ¥è¯¢æ¥å£è·å–ï¼‰
- `limitType=duration`: ä½¿ç”¨æ—¶é•¿é™åˆ¶æ¨¡å¼
- `limitValue=600`: æˆ˜æ–—æŒç»­10åˆ†é’Ÿï¼ˆ600ç§’ï¼‰
- `enemyId=dummy`: å¯¹æŠ—dummyæ•Œäºº

è¿”å›ç»“æœç¤ºä¾‹ï¼š
```json
{
  "id": "abc123...",
  "characterId": "xyz789...",
  "type": 1,
  "state": 1,
  "limitType": 1,
  "limitValue": 600,
  "slotIndex": 0,
  "executedSeconds": 0,
  "createdAt": "2024-10-07T12:00:00Z",
  "payloadJson": "{\"EnemyId\":\"dummy\",\"EnemyCount\":1}",
  "battleId": "def456..."
}
```

**ğŸ‰ æ–°ç‰¹æ€§ï¼šè‡ªåŠ¨æ‰§è¡Œï¼** 
å¦‚æœä½ çš„è§’è‰²å½“å‰æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œæ–°åˆ›å»ºçš„è®¡åˆ’ä¼š**è‡ªåŠ¨å¯åŠ¨**ï¼ˆ`state=1` è¡¨ç¤º Runningï¼‰ï¼ä½ ä¸å†éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `/start` æ¥å£ã€‚

è®°ä½è¿”å›çš„ `id` å’Œ `battleId` å€¼ã€‚

### æ­¥éª¤ 2ï¼šæŸ¥çœ‹æˆ˜æ–—çŠ¶æ€

```bash
GET http://localhost:5000/api/battles/step/def456.../status
```

è¿”å›ç»“æœåŒ…å«ï¼š
- æ¨¡æ‹Ÿæ—¶é•¿
- é€ æˆçš„æ€»ä¼¤å®³
- DPSï¼ˆæ¯ç§’ä¼¤å®³ï¼‰
- å‡»æ€æ¬¡æ•°
- è·å¾—çš„é‡‘å¸å’Œç»éªŒ

### æ­¥éª¤ 3ï¼šåœæ­¢è®¡åˆ’ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ æƒ³åœ¨è®¡åˆ’è‡ªåŠ¨å®Œæˆå‰åœæ­¢å®ƒï¼š

```bash
POST http://localhost:5000/api/activity-plans/abc123.../stop
```

**ğŸ’¡ æç¤ºï¼š** å½“ä¸€ä¸ªè®¡åˆ’åœæ­¢åï¼Œå¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰å¾…æ‰§è¡Œçš„è®¡åˆ’ï¼Œç³»ç»Ÿä¼š**è‡ªåŠ¨å¯åŠ¨**ä¸‹ä¸€ä¸ªè®¡åˆ’ï¼

### æ­¥éª¤ 4ï¼šæŸ¥çœ‹è®¡åˆ’ç»“æœ

```bash
GET http://localhost:5000/api/activity-plans/abc123...
```

æŸ¥çœ‹ `state`ã€`executedSeconds`ã€`completedAt` ç­‰å­—æ®µäº†è§£è®¡åˆ’æ‰§è¡Œæƒ…å†µã€‚

## å¸¸ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ— é™æ—¶é•¿çš„æŒ‚æœºæˆ˜æ–—

æƒ³è¦ä¸€ç›´æˆ˜æ–—ç›´åˆ°æ‰‹åŠ¨åœæ­¢ï¼Ÿ

```bash
# åˆ›å»ºæ— é™è®¡åˆ’ï¼ˆè‡ªåŠ¨å¯åŠ¨ï¼‰
POST http://localhost:5000/api/activity-plans/combat?characterId=xxx&limitType=infinite&enemyId=orc

# ... æˆ˜æ–—ä¼šç«‹å³å¼€å§‹å¹¶ä¸€ç›´æŒç»­ ...

# æƒ³åœæ­¢æ—¶è°ƒç”¨
POST http://localhost:5000/api/activity-plans/{planId}/stop
```

### åœºæ™¯ 2ï¼šæŒ‘æˆ˜åœ°ä¸‹åŸ

```bash
# åˆ›å»ºåœ°ä¸‹åŸè®¡åˆ’ï¼ˆ2å°æ—¶ï¼Œå¾ªç¯æ¨¡å¼ï¼Œè‡ªåŠ¨å¯åŠ¨ï¼‰
POST http://localhost:5000/api/activity-plans/dungeon?characterId=xxx&limitType=duration&limitValue=7200&dungeonId=intro_cave&loop=true

# æˆ˜æ–—ä¼šç«‹å³å¼€å§‹ï¼Œ2å°æ—¶åè‡ªåŠ¨å®Œæˆ
```

### åœºæ™¯ 3ï¼šä»»åŠ¡é˜Ÿåˆ— - è¿ç»­æ‰§è¡Œå¤šä¸ªä»»åŠ¡

```bash
# åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆè‡ªåŠ¨å¯åŠ¨ï¼‰
POST http://localhost:5000/api/activity-plans/combat?characterId=xxx&limitType=duration&limitValue=600&enemyId=goblin

# åˆ›å»ºç¬¬äºŒä¸ªä»»åŠ¡ï¼ˆè¿›å…¥é˜Ÿåˆ—ï¼‰
POST http://localhost:5000/api/activity-plans/combat?characterId=xxx&limitType=duration&limitValue=600&enemyId=orc

# åˆ›å»ºç¬¬ä¸‰ä¸ªä»»åŠ¡ï¼ˆè¿›å…¥é˜Ÿåˆ—ï¼‰
POST http://localhost:5000/api/activity-plans/dungeon?characterId=xxx&limitType=duration&limitValue=1200&dungeonId=intro_cave

# ä»»åŠ¡ä¼šæŒ‰é¡ºåºè‡ªåŠ¨æ‰§è¡Œï¼šgoblin â†’ orc â†’ intro_cave
```

### åœºæ™¯ 4ï¼šæŸ¥çœ‹è§’è‰²çš„æ‰€æœ‰è®¡åˆ’

```bash
GET http://localhost:5000/api/activity-plans/character/{characterId}
```

è¿”å›è¯¥è§’è‰²çš„æ‰€æœ‰è®¡åˆ’åˆ—è¡¨ï¼ˆåŒ…æ‹¬å¾…æ‰§è¡Œã€è¿è¡Œä¸­ã€å·²å®Œæˆçš„ï¼‰ã€‚

## ä½¿ç”¨ .NET SDK è°ƒç”¨ç¤ºä¾‹

å¦‚æœä½ åœ¨ C# ä»£ç ä¸­ä½¿ç”¨ï¼š

```csharp
using System.Net.Http;
using System.Text.Json;

// åˆ›å»º HTTP å®¢æˆ·ç«¯
var client = new HttpClient { BaseAddress = new Uri("http://localhost:5000") };

// åˆ›å»ºæˆ˜æ–—è®¡åˆ’ï¼ˆè‡ªåŠ¨å¯åŠ¨ï¼‰
var createUrl = $"/api/activity-plans/combat?characterId={characterId}&limitType=duration&limitValue=600&enemyId=dummy";
var createResponse = await client.PostAsync(createUrl, null);
var plan = await JsonSerializer.DeserializeAsync<ActivityPlan>(
    await createResponse.Content.ReadAsStreamAsync());

// è®¡åˆ’å·²è‡ªåŠ¨å¯åŠ¨ï¼æ£€æŸ¥ battleId
Console.WriteLine($"Battle auto-started with ID: {plan.BattleId}");

// æŸ¥è¯¢æˆ˜æ–—çŠ¶æ€
var statusUrl = $"/api/battles/step/{plan.BattleId}/status";
var statusResponse = await client.GetAsync(statusUrl);
var status = await JsonSerializer.DeserializeAsync<BattleStatus>(
    await statusResponse.Content.ReadAsStreamAsync());

Console.WriteLine($"DPS: {status.Dps}, Gold: {status.Gold}");
```

## ä½¿ç”¨ JavaScript/TypeScript è°ƒç”¨ç¤ºä¾‹

åœ¨å‰ç«¯ä»£ç ä¸­ï¼š

```javascript
// åˆ›å»ºæˆ˜æ–—è®¡åˆ’ï¼ˆè‡ªåŠ¨å¯åŠ¨ï¼‰
const createResponse = await fetch(
  `/api/activity-plans/combat?characterId=${characterId}&limitType=duration&limitValue=600&enemyId=dummy`,
  { method: 'POST' }
);
const plan = await createResponse.json();

// è®¡åˆ’å·²è‡ªåŠ¨å¯åŠ¨ï¼æ£€æŸ¥ battleId
console.log(`Battle auto-started with ID: ${plan.battleId}`);

// å®šæœŸæŸ¥è¯¢æˆ˜æ–—çŠ¶æ€
setInterval(async () => {
  const statusResponse = await fetch(
    `/api/battles/step/${plan.battleId}/status`
  );
  const status = await statusResponse.json();
  
  console.log(`Progress: ${status.simulatedSeconds}/${status.targetSeconds}s`);
  console.log(`DPS: ${status.dps}, Gold: ${status.gold}`);
}, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
```

## å‚æ•°è¯´æ˜

### æˆ˜æ–—è®¡åˆ’å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| characterId | Guid | æ˜¯ | - | è§’è‰²ID |
| slotIndex | int | å¦ | 0 | æ§½ä½ç´¢å¼•ï¼ˆ0-4ï¼‰ |
| limitType | string | å¦ | "duration" | "duration" æˆ– "infinite" |
| limitValue | double? | è§†æƒ…å†µ | - | ç§’æ•°ï¼ˆdurationæ—¶å¿…éœ€ï¼‰ |
| enemyId | string? | å¦ | null | æ•ŒäººID |
| enemyCount | int | å¦ | 1 | æ•Œäººæ•°é‡ |
| respawnDelay | double? | å¦ | null | é‡ç”Ÿå»¶è¿Ÿï¼ˆç§’ï¼‰ |
| seed | ulong? | å¦ | null | éšæœºç§å­ |

### åœ°ä¸‹åŸè®¡åˆ’å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| characterId | Guid | æ˜¯ | - | è§’è‰²ID |
| slotIndex | int | å¦ | 0 | æ§½ä½ç´¢å¼•ï¼ˆ0-4ï¼‰ |
| limitType | string | å¦ | "duration" | "duration" æˆ– "infinite" |
| limitValue | double? | è§†æƒ…å†µ | - | ç§’æ•°ï¼ˆdurationæ—¶å¿…éœ€ï¼‰ |
| dungeonId | string | å¦ | "intro_cave" | åœ°ä¸‹åŸID |
| loop | bool | å¦ | false | æ˜¯å¦å¾ªç¯ |
| waveDelay | double? | å¦ | null | æ³¢æ¬¡å»¶è¿Ÿï¼ˆç§’ï¼‰ |
| runDelay | double? | å¦ | null | è½®æ¬¡å»¶è¿Ÿï¼ˆç§’ï¼‰ |
| seed | ulong? | å¦ | null | éšæœºç§å­ |

## æ•…éšœæ’é™¤

### é—®é¢˜ï¼šåˆ›å»ºè®¡åˆ’æ—¶è¿”å› "Character not found"

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿æä¾›çš„ `characterId` æ˜¯æœ‰æ•ˆçš„ã€‚å…ˆè°ƒç”¨è§’è‰²æŸ¥è¯¢æ¥å£ç¡®è®¤è§’è‰²å­˜åœ¨ã€‚

### é—®é¢˜ï¼šåˆ›å»ºè®¡åˆ’æ—¶è§’è‰²å·²æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡

**ç°è±¡**ï¼šæ–°åˆ›å»ºçš„è®¡åˆ’ `state=0` (Pending)ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨å¯åŠ¨ã€‚

**åŸå› **ï¼šæ¯ä¸ªè§’è‰²åªèƒ½åŒæ—¶è¿è¡Œä¸€ä¸ªè®¡åˆ’ã€‚å¦‚æœå·²æœ‰è¿è¡Œä¸­çš„è®¡åˆ’ï¼Œæ–°è®¡åˆ’ä¼šè¿›å…¥é˜Ÿåˆ—ç­‰å¾…ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç­‰å¾…å½“å‰ä»»åŠ¡è‡ªåŠ¨å®Œæˆï¼Œæ–°ä»»åŠ¡ä¼šè‡ªåŠ¨å¯åŠ¨
2. æˆ–æ‰‹åŠ¨åœæ­¢å½“å‰ä»»åŠ¡ï¼š

æŸ¥è¯¢æ­£åœ¨è¿è¡Œçš„è®¡åˆ’ï¼š
```bash
GET /api/activity-plans/character/{characterId}
# æŸ¥æ‰¾ state=1 çš„è®¡åˆ’
```

åœæ­¢æ­£åœ¨è¿è¡Œçš„è®¡åˆ’ï¼ˆä¼šè‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªï¼‰ï¼š
```bash
POST /api/activity-plans/{runningPlanId}/stop
```

### é—®é¢˜ï¼šåˆ é™¤è®¡åˆ’æ—¶è¿”å› "Cannot delete a running plan"

**è§£å†³æ–¹æ¡ˆ**ï¼šå¿…é¡»å…ˆåœæ­¢æ­£åœ¨è¿è¡Œçš„è®¡åˆ’ï¼Œæ‰èƒ½åˆ é™¤å®ƒï¼š

```bash
# å…ˆåœæ­¢
POST /api/activity-plans/{planId}/stop

# å†åˆ é™¤
DELETE /api/activity-plans/{planId}
```

## ä¸‹ä¸€æ­¥

- é˜…è¯»[å®Œæ•´æ–‡æ¡£](./æ´»åŠ¨è®¡åˆ’ç³»ç»Ÿæ–‡æ¡£.md)äº†è§£æ›´å¤šç»†èŠ‚
- æŸ¥çœ‹[APIå‚è€ƒ](./æ´»åŠ¨è®¡åˆ’ç³»ç»Ÿæ–‡æ¡£.md#api-æ¥å£)äº†è§£æ‰€æœ‰å¯ç”¨ç«¯ç‚¹
- äº†è§£[æ¶æ„è®¾è®¡](./æ´»åŠ¨è®¡åˆ’ç³»ç»Ÿæ–‡æ¡£.md#æ¶æ„è®¾è®¡)æ·±å…¥ç†è§£ç³»ç»Ÿå®ç°

## è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜æˆ–æœ‰ç–‘é—®ï¼š
1. æ£€æŸ¥æœ¬æŒ‡å—çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. é˜…è¯»å®Œæ•´æ–‡æ¡£
3. åœ¨é¡¹ç›® Issues ä¸­æé—®
