# 活动计划系统 - 快速开始指南

## 简介

本指南将帮助你快速了解和使用活动计划系统。

## 5分钟快速上手

### 步骤 1：创建一个战斗计划

使用 Postman、curl 或其他 HTTP 客户端：

```bash
POST http://localhost:5000/api/activity-plans/combat?characterId=你的角色ID&limitType=duration&limitValue=600&enemyId=dummy
```

参数说明：
- `characterId`: 你的角色ID（从角色创建或查询接口获取）
- `limitType=duration`: 使用时长限制模式
- `limitValue=600`: 战斗持续10分钟（600秒）
- `enemyId=dummy`: 对抗dummy敌人

返回结果示例：
```json
{
  "id": "abc123...",
  "characterId": "xyz789...",
  "type": 1,
  "state": 0,
  "limitType": 1,
  "limitValue": 600,
  "slotIndex": 0,
  "executedSeconds": 0,
  "createdAt": "2024-10-07T12:00:00Z",
  "payloadJson": "{\"EnemyId\":\"dummy\",\"EnemyCount\":1}"
}
```

记住返回的 `id` 值，这是你的计划ID。

### 步骤 2：启动计划

```bash
POST http://localhost:5000/api/activity-plans/abc123.../start
```

返回结果：
```json
{
  "planId": "abc123...",
  "battleId": "def456..."
}
```

现在战斗已经开始了！记住 `battleId`，你可以用它查询战斗状态。

### 步骤 3：查看战斗状态

```bash
GET http://localhost:5000/api/battles/step/def456.../status
```

返回结果包含：
- 模拟时长
- 造成的总伤害
- DPS（每秒伤害）
- 击杀次数
- 获得的金币和经验

### 步骤 4：停止计划（可选）

如果你想在计划自动完成前停止它：

```bash
POST http://localhost:5000/api/activity-plans/abc123.../stop
```

### 步骤 5：查看计划结果

```bash
GET http://localhost:5000/api/activity-plans/abc123...
```

查看 `state`、`executedSeconds`、`completedAt` 等字段了解计划执行情况。

## 常用场景

### 场景 1：无限时长的挂机战斗

想要一直战斗直到手动停止？

```bash
# 创建无限计划
POST http://localhost:5000/api/activity-plans/combat?characterId=xxx&limitType=infinite&enemyId=orc

# 启动计划
POST http://localhost:5000/api/activity-plans/{planId}/start

# ... 战斗会一直持续 ...

# 想停止时调用
POST http://localhost:5000/api/activity-plans/{planId}/stop
```

### 场景 2：挑战地下城

```bash
# 创建地下城计划（2小时，循环模式）
POST http://localhost:5000/api/activity-plans/dungeon?characterId=xxx&limitType=duration&limitValue=7200&dungeonId=intro_cave&loop=true

# 启动计划
POST http://localhost:5000/api/activity-plans/{planId}/start

# 2小时后自动完成
```

### 场景 3：查看角色的所有计划

```bash
GET http://localhost:5000/api/activity-plans/character/{characterId}
```

返回该角色的所有计划列表（包括待执行、运行中、已完成的）。

## 使用 .NET SDK 调用示例

如果你在 C# 代码中使用：

```csharp
using System.Net.Http;
using System.Text.Json;

// 创建 HTTP 客户端
var client = new HttpClient { BaseAddress = new Uri("http://localhost:5000") };

// 创建战斗计划
var createUrl = $"/api/activity-plans/combat?characterId={characterId}&limitType=duration&limitValue=600&enemyId=dummy";
var createResponse = await client.PostAsync(createUrl, null);
var plan = await JsonSerializer.DeserializeAsync<ActivityPlan>(
    await createResponse.Content.ReadAsStreamAsync());

// 启动计划
var startUrl = $"/api/activity-plans/{plan.Id}/start";
var startResponse = await client.PostAsync(startUrl, null);
var startResult = await JsonSerializer.DeserializeAsync<StartResult>(
    await startResponse.Content.ReadAsStreamAsync());

Console.WriteLine($"Battle started with ID: {startResult.BattleId}");

// 查询战斗状态
var statusUrl = $"/api/battles/step/{startResult.BattleId}/status";
var statusResponse = await client.GetAsync(statusUrl);
var status = await JsonSerializer.DeserializeAsync<BattleStatus>(
    await statusResponse.Content.ReadAsStreamAsync());

Console.WriteLine($"DPS: {status.Dps}, Gold: {status.Gold}");
```

## 使用 JavaScript/TypeScript 调用示例

在前端代码中：

```javascript
// 创建战斗计划
const createResponse = await fetch(
  `/api/activity-plans/combat?characterId=${characterId}&limitType=duration&limitValue=600&enemyId=dummy`,
  { method: 'POST' }
);
const plan = await createResponse.json();

// 启动计划
const startResponse = await fetch(
  `/api/activity-plans/${plan.id}/start`,
  { method: 'POST' }
);
const startResult = await startResponse.json();

console.log(`Battle started with ID: ${startResult.battleId}`);

// 定期查询战斗状态
setInterval(async () => {
  const statusResponse = await fetch(
    `/api/battles/step/${startResult.battleId}/status`
  );
  const status = await statusResponse.json();
  
  console.log(`Progress: ${status.simulatedSeconds}/${status.targetSeconds}s`);
  console.log(`DPS: ${status.dps}, Gold: ${status.gold}`);
}, 5000); // 每5秒更新一次
```

## 参数说明

### 战斗计划参数

| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| characterId | Guid | 是 | - | 角色ID |
| slotIndex | int | 否 | 0 | 槽位索引（0-4） |
| limitType | string | 否 | "duration" | "duration" 或 "infinite" |
| limitValue | double? | 视情况 | - | 秒数（duration时必需） |
| enemyId | string? | 否 | null | 敌人ID |
| enemyCount | int | 否 | 1 | 敌人数量 |
| respawnDelay | double? | 否 | null | 重生延迟（秒） |
| seed | ulong? | 否 | null | 随机种子 |

### 地下城计划参数

| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| characterId | Guid | 是 | - | 角色ID |
| slotIndex | int | 否 | 0 | 槽位索引（0-4） |
| limitType | string | 否 | "duration" | "duration" 或 "infinite" |
| limitValue | double? | 视情况 | - | 秒数（duration时必需） |
| dungeonId | string | 否 | "intro_cave" | 地下城ID |
| loop | bool | 否 | false | 是否循环 |
| waveDelay | double? | 否 | null | 波次延迟（秒） |
| runDelay | double? | 否 | null | 轮次延迟（秒） |
| seed | ulong? | 否 | null | 随机种子 |

## 故障排除

### 问题：创建计划时返回 "Character not found"

**解决方案**：确保提供的 `characterId` 是有效的。先调用角色查询接口确认角色存在。

### 问题：启动计划时返回 "Another plan is already running"

**解决方案**：当前每个角色只能同时运行一个计划。先停止正在运行的计划，或等待其自动完成。

查询正在运行的计划：
```bash
GET /api/activity-plans/character/{characterId}
# 查找 state=1 的计划
```

停止正在运行的计划：
```bash
POST /api/activity-plans/{runningPlanId}/stop
```

### 问题：启动计划时返回 "Cannot start plan in state Running"

**解决方案**：该计划已经在运行中，不能重复启动。如果需要重新启动，先停止它。

### 问题：删除计划时返回 "Cannot delete a running plan"

**解决方案**：必须先停止正在运行的计划，才能删除它：

```bash
# 先停止
POST /api/activity-plans/{planId}/stop

# 再删除
DELETE /api/activity-plans/{planId}
```

## 下一步

- 阅读[完整文档](./活动计划系统文档.md)了解更多细节
- 查看[API参考](./活动计划系统文档.md#api-接口)了解所有可用端点
- 了解[架构设计](./活动计划系统文档.md#架构设计)深入理解系统实现

## 获取帮助

如果遇到问题或有疑问：
1. 检查本指南的故障排除部分
2. 阅读完整文档
3. 在项目 Issues 中提问
