# BlazorIdle ä¾èµ–å…³ç³»å›¾
**åŸºäºæ­¥éª¤ 0.1 ä»£ç å®¡è®¡ç»“æœ**

**ç”Ÿæˆæ—¥æœŸ**: 2025å¹´10æœˆ21æ—¥  
**åˆ†æèŒƒå›´**: BlazorIdle.Server å…¨éƒ¨ä»£ç   
**å›¾è¡¨ç±»å‹**: æ¨¡å—ä¾èµ–ã€ç±»ä¾èµ–ã€æ•°æ®æµ

---

## ğŸ“Š 1. åˆ†å±‚æ¶æ„æ€»è§ˆ

### 1.1 ç†æƒ³åˆ†å±‚æ¶æ„ï¼ˆç›®æ ‡ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Presentation Layer             â”‚
â”‚         (BlazorIdle Client - WebAssembly)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP/REST API
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API Layer                      â”‚
â”‚         (Controllers, DTOs)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Application Services
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application Layer                  â”‚
â”‚    (Services, Coordinators, Commands)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Domain Logic
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Domain Layer                    â”‚
â”‚  (Entities, Value Objects, Domain Services) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Persistence Abstraction
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Infrastructure Layer                â”‚
â”‚   (Repositories, DbContext, Caching, etc)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å½“å‰å®é™…æ¶æ„ï¼ˆå­˜åœ¨é—®é¢˜ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API Layer                      â”‚
â”‚                                             â”‚
â”‚  CharactersController                       â”‚
â”‚         â”‚                                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ âŒ ç›´æ¥ä¾èµ– DbContext
                     â”‚    (åº”è¯¥é€šè¿‡ Repository)
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Infrastructure Layer                â”‚
â”‚                                             â”‚
â”‚         GameDbContext                       â”‚
â”‚              â”‚                              â”‚
â”‚              â–¼                              â”‚
â”‚         SQLite Database                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application Layer                  â”‚
â”‚                                             â”‚
â”‚  StepBattleCoordinator                      â”‚
â”‚         â”‚                                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â–º IServiceScopeFactory        â”‚
â”‚                     â”‚                       â”‚
â”‚                     â””â”€â”€â”€â”€â”€â–º StepBattleFinalizer
â”‚                                 â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ âœ… é€šè¿‡æ¥å£
                                  â”‚    (è‰¯å¥½æŠ½è±¡)
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Infrastructure Layer                â”‚
â”‚                                             â”‚
â”‚         IBattleRepository                   â”‚
â”‚              â”‚                              â”‚
â”‚              â–¼                              â”‚
â”‚         BattleRepository                    â”‚
â”‚              â”‚                              â”‚
â”‚              â–¼                              â”‚
â”‚         GameDbContext                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— 2. æ¨¡å—ä¾èµ–å…³ç³»å›¾

### 2.1 å®Œæ•´ä¾èµ–å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Api Layer                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  CharactersController â”€â”€â”€â”€âŒâ”€â”€â”€â”€â”                           â”‚
â”‚  BattlesController                                           â”‚
â”‚  StepBattlesController                                       â”‚
â”‚  OfflineController                                           â”‚
â”‚  SimulationController                                        â”‚
â”‚  EnemiesController                                           â”‚
â”‚  BattlesReplayController                                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                       â”‚
           â”‚ âœ… æ­£å¸¸ä¾èµ–           â”‚ âŒ è·¨å±‚ç›´æ¥ä¾èµ–
           â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Application Layer  â”‚  â”‚   Infrastructure.Persistence   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚  â”‚                                â”‚
â”‚ StepBattleCoord.â”€â”€â”€â”€â”â”‚  â”‚      GameDbContext             â”‚
â”‚ StepBattleFinalizer â”‚â”‚  â”‚                                â”‚
â”‚ StepBattleSnapshot  â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ BatchSimulator      â”‚â”‚
â”‚ OfflineSettlement   â”‚â”‚
â”‚ StartBattleService  â”‚â”‚
â”‚ BattleRunner        â”‚â”‚
â”‚                     â”‚â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”˜
     â”‚                â”‚
     â”‚ âœ… é€šè¿‡æ¥å£    â”‚ âš ï¸ é€šè¿‡ ServiceScope
     â”‚                â”‚    ä¸´æ—¶è§£æ DbContext
     â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Infrastructure.Persistence           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Abstractions/                           â”‚
â”‚  â”œâ”€â”€ IBattleRepository                   â”‚
â”‚  â””â”€â”€ ICharacterRepository                â”‚
â”‚                                          â”‚
â”‚  Repositories/                           â”‚
â”‚  â”œâ”€â”€ BattleRepository â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â””â”€â”€ CharacterRepository â”€â”€â”€â”¤           â”‚
â”‚                              â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ âœ… æ­£å¸¸ä¾èµ–
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        GameDbContext                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  DbSet<Character>                        â”‚
â”‚  DbSet<BattleRecord>                     â”‚
â”‚  DbSet<RunningBattleSnapshotRecord>      â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          SQLite Database                 â”‚
â”‚           (gamedata.db)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Domain å±‚ä¾èµ–ï¼ˆç‹¬ç«‹æ€§å¥½ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Domain Layer                   â”‚
â”‚         (å®Œå…¨ç‹¬ç«‹ï¼Œæ— å¤–éƒ¨ä¾èµ–)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  Combat/                                    â”‚
â”‚  â”œâ”€â”€ Engine/                                â”‚
â”‚  â”‚   â””â”€â”€ BattleEngine â”€â”€â”€â”                 â”‚
â”‚  â”‚                        â”‚                 â”‚
â”‚  â”œâ”€â”€ Skills/               â”‚                 â”‚
â”‚  â”‚   â”œâ”€â”€ SkillDefinition  â”‚                 â”‚
â”‚  â”‚   â”œâ”€â”€ SkillRuntime     â”‚                 â”‚
â”‚  â”‚   â””â”€â”€ AutoCastEngine â”€â”€â”¤                 â”‚
â”‚  â”‚                        â”‚                 â”‚
â”‚  â”œâ”€â”€ Buffs/                â”‚                 â”‚
â”‚  â”‚   â”œâ”€â”€ BuffDefinition   â”‚                 â”‚
â”‚  â”‚   â”œâ”€â”€ BuffInstance     â”‚                 â”‚
â”‚  â”‚   â””â”€â”€ BuffManager â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚                        â”‚                 â”‚
â”‚  â”œâ”€â”€ Resources/            â”‚                 â”‚
â”‚  â”‚   â”œâ”€â”€ ResourceBucket   â”‚                 â”‚
â”‚  â”‚   â””â”€â”€ ResourceSet â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚                        â”‚                 â”‚
â”‚  â”œâ”€â”€ Professions/          â”‚                 â”‚
â”‚  â”‚   â”œâ”€â”€ IProfessionModuleâ”‚                 â”‚
â”‚  â”‚   â”œâ”€â”€ WarriorProf.     â”‚                 â”‚
â”‚  â”‚   â””â”€â”€ RangerProf. â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚                        â”‚                 â”‚
â”‚  â”œâ”€â”€ EventScheduler â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”œâ”€â”€ GameClock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”œâ”€â”€ TrackState â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚                        â”‚                 â”‚
â”‚  â”‚  å…±åŒç»„æˆ              â”‚                 â”‚
â”‚  â–¼                        â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚    BattleAggregate       â”‚              â”‚
â”‚  â”‚   (æ ¸å¿ƒæˆ˜æ–—èšåˆæ ¹)       â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                             â”‚
â”‚  Characters/                                â”‚
â”‚  â”œâ”€â”€ Character                              â”‚
â”‚  â”œâ”€â”€ CharacterStats                         â”‚
â”‚  â”œâ”€â”€ PrimaryAttributes                      â”‚
â”‚  â””â”€â”€ StatsBuilder                           â”‚
â”‚                                             â”‚
â”‚  Records/                                   â”‚
â”‚  â”œâ”€â”€ BattleRecord â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â””â”€â”€ BattleSegmentRecord â”€â”˜                â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ âœ… æ— ä¾èµ–å¤–éƒ¨å±‚
         â”‚    (çº¯é¢†åŸŸé€»è¾‘)
         â–¼
    (æ‰€æœ‰å…¶ä»–å±‚ä¾èµ– Domain)
```

---

## ğŸ” 3. å…³é”®ç±»ä¾èµ–è¯¦å›¾

### 3.1 CharactersController ä¾èµ–é“¾ï¼ˆé—®é¢˜ï¼‰

```
CharactersController.cs
â”œâ”€â”€ æ³¨å…¥ä¾èµ–
â”‚   â””â”€â”€ GameDbContext _db â”€â”€â”€â”€â”€â”€â”€â”€âŒ åº”è¯¥æ³¨å…¥ ICharacterRepository
â”‚
â”œâ”€â”€ Create() æ–¹æ³•
â”‚   â”œâ”€â”€ _db.Characters.Add(c) â”€â”€â”€â”€âŒ åº”è¯¥ _repo.AddAsync(c)
â”‚   â””â”€â”€ _db.SaveChangesAsync() â”€â”€â”€âŒ åº”è¯¥åœ¨ Repository å†…éƒ¨
â”‚
â””â”€â”€ Get() æ–¹æ³•
    â””â”€â”€ _db.Characters.FirstOrDefaultAsync() â”€âŒ åº”è¯¥ _repo.GetByIdAsync()
```

**é‡æ„ç›®æ ‡**:
```
CharactersController.cs
â”œâ”€â”€ æ³¨å…¥ä¾èµ–
â”‚   â””â”€â”€ ICharacterRepository _characterRepo â”€â”€âœ… é€šè¿‡æ¥å£
â”‚
â”œâ”€â”€ Create() æ–¹æ³•
â”‚   â””â”€â”€ _characterRepo.AddAsync(c) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ… ä½¿ç”¨ä»“å‚¨
â”‚
â””â”€â”€ Get() æ–¹æ³•
    â””â”€â”€ _characterRepo.GetByIdAsync(id) â”€â”€â”€â”€â”€â”€âœ… ä½¿ç”¨ä»“å‚¨
```

### 3.2 StepBattleCoordinator ä¾èµ–é“¾ï¼ˆå¯æ”¹è¿›ï¼‰

```
StepBattleCoordinator
â”œâ”€â”€ æ³¨å…¥ä¾èµ–
â”‚   â””â”€â”€ IServiceScopeFactory _scopeFactory â”€â”€â”€âš ï¸ è¿è¡Œæ—¶ä¾èµ–è§£æ
â”‚
â”œâ”€â”€ AdvanceAll() æ–¹æ³•
â”‚   â””â”€â”€ å¯¹æ¯ä¸ª RunningBattle
â”‚       â””â”€â”€ å¦‚æœå®Œæˆä¸”æœªæŒä¹…åŒ–
â”‚           â”œâ”€â”€ using var scope = _scopeFactory.CreateScope()
â”‚           â”œâ”€â”€ var finalizer = scope.GetRequiredService<StepBattleFinalizer>()
â”‚           â””â”€â”€ finalizer.FinalizeAsync(rb) â”€â”€â”
â”‚                                             â”‚
â””â”€â”€ StopAndFinalizeAsync() æ–¹æ³•              â”‚
    â””â”€â”€ åŒæ ·æ¨¡å¼                             â”‚
                                             â”‚
                                             â–¼
                            StepBattleFinalizer
                            â”œâ”€â”€ æ³¨å…¥ä¾èµ–
                            â”‚   â””â”€â”€ IBattleRepository _repo â”€â”€â”€âœ… é€šè¿‡æ¥å£
                            â”‚
                            â””â”€â”€ FinalizeAsync()
                                â””â”€â”€ _repo.AddAsync(record) â”€â”€âœ… ä½¿ç”¨ä»“å‚¨
```

**æ”¹è¿›å»ºè®®**:
```
StepBattleCoordinator
â”œâ”€â”€ æ³¨å…¥ä¾èµ–
â”‚   â””â”€â”€ IStepBattleFinalizerFactory _finalizerFactory â”€â”€âœ… é€šè¿‡å·¥å‚
â”‚
â””â”€â”€ AdvanceAll() æ–¹æ³•
    â””â”€â”€ å¯¹æ¯ä¸ª RunningBattle
        â””â”€â”€ å¦‚æœå®Œæˆä¸”æœªæŒä¹…åŒ–
            â”œâ”€â”€ var finalizer = _finalizerFactory.Create() â”€â”€âœ… å·¥å‚åˆ›å»º
            â””â”€â”€ finalizer.FinalizeAsync(rb)
```

### 3.3 StepBattleSnapshotService ä¾èµ–é“¾ï¼ˆéœ€é‡æ„ï¼‰

```
StepBattleSnapshotService
â”œâ”€â”€ æ³¨å…¥ä¾èµ–
â”‚   â””â”€â”€ IServiceScopeFactory _scopeFactory â”€â”€â”€âš ï¸ è¿è¡Œæ—¶è§£æ
â”‚
â”œâ”€â”€ SaveAsync() æ–¹æ³•
â”‚   â”œâ”€â”€ using var scope = _scopeFactory.CreateScope()
â”‚   â”œâ”€â”€ var db = scope.GetRequiredService<GameDbContext>() â”€â”€â”€âŒ ç›´æ¥ä½¿ç”¨ DbContext
â”‚   â”œâ”€â”€ var row = await db.Set<RunningBattleSnapshotRecord>()...
â”‚   â””â”€â”€ await db.SaveChangesAsync() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŒ ç»•è¿‡ Repository
â”‚
â”œâ”€â”€ DeleteAsync() æ–¹æ³•
â”‚   â””â”€â”€ åŒæ ·æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŒ
â”‚
â””â”€â”€ RecoverAllAsync() æ–¹æ³•
    â””â”€â”€ åŒæ ·æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŒ
```

**é‡æ„ç›®æ ‡**:
```
StepBattleSnapshotService
â”œâ”€â”€ æ³¨å…¥ä¾èµ–
â”‚   â””â”€â”€ IRunningBattleSnapshotRepository _snapshotRepo â”€â”€âœ… é€šè¿‡æ¥å£
â”‚
â”œâ”€â”€ SaveAsync() æ–¹æ³•
â”‚   â””â”€â”€ _snapshotRepo.SaveAsync(snapshot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ… ä½¿ç”¨ä»“å‚¨
â”‚
â”œâ”€â”€ DeleteAsync() æ–¹æ³•
â”‚   â””â”€â”€ _snapshotRepo.DeleteAsync(stepBattleId) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ… ä½¿ç”¨ä»“å‚¨
â”‚
â””â”€â”€ RecoverAllAsync() æ–¹æ³•
    â””â”€â”€ var rows = await _snapshotRepo.GetAllAsync() â”€â”€â”€â”€â”€âœ… ä½¿ç”¨ä»“å‚¨
```

### 3.4 Repository å±‚ä¾èµ–é“¾ï¼ˆè‰¯å¥½ï¼‰

```
Application Services
        â”‚
        â”‚ âœ… ä¾èµ–æ¥å£æŠ½è±¡
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IBattleRepository   â”‚
â”‚ ICharacterRepositoryâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ âœ… æ¥å£å®ç°
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BattleRepository    â”‚
â”‚ CharacterRepository â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ âœ… æ³¨å…¥ DbContext
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GameDbContext     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DbSet<Character>    â”‚
â”‚ DbSet<BattleRecord> â”‚
â”‚ DbSet<...>          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ âœ… EF Core ç®¡ç†
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLite Database    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ 4. æ•°æ®æµåˆ†æ

### 4.1 åˆ›å»ºè§’è‰²æµç¨‹

**å½“å‰æµç¨‹ï¼ˆæœ‰é—®é¢˜ï¼‰**:
```
Client (Blazor)
    â”‚ POST /api/characters
    â–¼
CharactersController.Create()
    â”‚ new Character { ... }
    â–¼
âŒ _db.Characters.Add(c)
    â”‚
    â–¼
âŒ _db.SaveChangesAsync()
    â”‚
    â–¼
SQLite Database
    â”‚
    â–¼
Response { id, name }
    â”‚
    â–¼
Client (Blazor)
```

**ç›®æ ‡æµç¨‹ï¼ˆé‡æ„åï¼‰**:
```
Client (Blazor)
    â”‚ POST /api/characters
    â–¼
CharactersController.Create()
    â”‚ new Character { ... }
    â–¼
âœ… _characterRepo.AddAsync(c)
    â”‚
    â–¼
CharacterRepository
    â”‚ _db.Characters.Add(c)
    â”‚ _db.SaveChangesAsync()
    â–¼
SQLite Database
    â”‚
    â–¼
Response { id, name }
    â”‚
    â–¼
Client (Blazor)
```

### 4.2 æˆ˜æ–—æ‰§è¡Œæµç¨‹

```
Client (Blazor)
    â”‚ POST /api/stepbattles/start
    â–¼
StepBattlesController.Start()
    â”‚
    â–¼
StepBattleCoordinator.Start()
    â”‚ åˆ›å»º RunningBattle
    â”‚ åŠ å…¥å†…å­˜å­—å…¸
    â–¼
StepBattleHostedService
    â”‚ åå°çº¿ç¨‹å®šæœŸè°ƒç”¨
    â–¼
StepBattleCoordinator.AdvanceAll()
    â”‚ å¯¹æ¯ä¸ª RunningBattle
    â–¼
RunningBattle.Advance()
    â”‚ æ¨è¿›æˆ˜æ–—æ¨¡æ‹Ÿ
    â”‚ ç”Ÿæˆ CombatSegment
    â–¼
å¦‚æœå®Œæˆ
    â”‚
    â–¼
StepBattleFinalizer.FinalizeAsync()
    â”‚ èšåˆæ•°æ®
    â”‚ è®¡ç®—å¥–åŠ±
    â–¼
âœ… IBattleRepository.AddAsync(record)
    â”‚
    â–¼
BattleRepository
    â”‚ _db.Battles.Add(record)
    â”‚ _db.SaveChangesAsync()
    â–¼
SQLite Database (æŒä¹…åŒ–)
    â”‚
    â–¼
Client è½®è¯¢ GET /api/stepbattles/{id}
    â”‚
    â–¼
StepBattleCoordinator.GetStatus(id)
    â”‚ ä»å†…å­˜è¿”å›çŠ¶æ€
    â–¼
Response { status, segments, rewards }
```

### 4.3 å¿«ç…§ä¿å­˜æµç¨‹ï¼ˆéœ€é‡æ„ï¼‰

**å½“å‰æµç¨‹**:
```
StepBattleHostedService
    â”‚ å®šæœŸè§¦å‘
    â–¼
StepBattleSnapshotService.SaveAsync(rb)
    â”‚
    â–¼
âŒ var db = scope.GetService<GameDbContext>()
    â”‚
    â–¼
âŒ db.Set<RunningBattleSnapshotRecord>().FirstOrDefault(...)
    â”‚
    â–¼
âŒ db.Add() æˆ– Update()
    â”‚
    â–¼
âŒ db.SaveChangesAsync()
    â”‚
    â–¼
SQLite Database
```

**ç›®æ ‡æµç¨‹**:
```
StepBattleHostedService
    â”‚ å®šæœŸè§¦å‘
    â–¼
StepBattleSnapshotService.SaveAsync(rb)
    â”‚
    â–¼
âœ… _snapshotRepo.SaveAsync(snapshot)
    â”‚
    â–¼
RunningBattleSnapshotRepository
    â”‚ _db.Set<...>().FirstOrDefault(...)
    â”‚ _db.Add() æˆ– Update()
    â”‚ _db.SaveChangesAsync()
    â–¼
SQLite Database
```

---

## ğŸ¯ 5. é‡æ„å‰åå¯¹æ¯”

### 5.1 CharactersController é‡æ„å¯¹æ¯”

**é‡æ„å‰**:
```csharp
public class CharactersController : ControllerBase
{
    private readonly GameDbContext _db; // âŒ ç›´æ¥ä¾èµ– DbContext

    public CharactersController(GameDbContext db) => _db = db;

    [HttpPost]
    public async Task<ActionResult<object>> Create([FromBody] CreateCharacterDto dto)
    {
        var c = new Character { ... };
        _db.Characters.Add(c);           // âŒ ç›´æ¥æ“ä½œ DbSet
        await _db.SaveChangesAsync();    // âŒ ç›´æ¥è°ƒç”¨ SaveChanges
        return Ok(new { c.Id, c.Name });
    }

    [HttpGet("{id:guid}")]
    public async Task<ActionResult<object>> Get(Guid id)
    {
        var c = await _db.Characters.FirstOrDefaultAsync(x => x.Id == id); // âŒ ç›´æ¥æŸ¥è¯¢
        return c is null ? NotFound() : Ok(...);
    }
}
```

**é‡æ„å**:
```csharp
public class CharactersController : ControllerBase
{
    private readonly ICharacterRepository _characterRepo; // âœ… ä¾èµ–æ¥å£

    public CharactersController(ICharacterRepository characterRepo) 
        => _characterRepo = characterRepo;

    [HttpPost]
    public async Task<ActionResult<object>> Create([FromBody] CreateCharacterDto dto)
    {
        var c = new Character { ... };
        await _characterRepo.AddAsync(c);  // âœ… ä½¿ç”¨ä»“å‚¨
        return Ok(new { c.Id, c.Name });
    }

    [HttpGet("{id:guid}")]
    public async Task<ActionResult<object>> Get(Guid id)
    {
        var c = await _characterRepo.GetByIdAsync(id); // âœ… ä½¿ç”¨ä»“å‚¨
        return c is null ? NotFound() : Ok(...);
    }
}
```

### 5.2 ä¾èµ–å›¾å¯¹æ¯”

**é‡æ„å‰**:
```
CharactersController â”€â”€â”€â”€âŒâ”€â”€â”€â”€â–º GameDbContext â”€â”€â”€â”€â–º SQLite
                                      â–²
                                      â”‚ 
BattleRepository â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ…â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡æ„å**:
```
CharactersController â”€â”€â”€â”€âœ…â”€â”€â”€â”€â–º ICharacterRepository
                                      â”‚
                                      â–¼
                              CharacterRepository
                                      â”‚
                                      â–¼
                                 GameDbContext â”€â”€â”€â”€â–º SQLite
                                      â–²
                                      â”‚
BattleRepository â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ…â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ 6. é‡æ„è·¯å¾„

### 6.1 Phase 2 é‡æ„è·¯å¾„å›¾

```
æ­¥éª¤ 1: æ‰©å±• ICharacterRepository
    â”‚
    â”œâ”€â–º æ·»åŠ  GetByIdAsync()
    â”œâ”€â–º æ·»åŠ  AddAsync()
    â””â”€â–º æ·»åŠ  UpdateAsync()
        â”‚
        â–¼
æ­¥éª¤ 2: å®ç° CharacterRepository æ–°æ–¹æ³•
    â”‚
    â””â”€â–º åœ¨ Repository ä¸­å®ç°æ¥å£æ–¹æ³•
        â”‚
        â–¼
æ­¥éª¤ 3: é‡æ„ CharactersController
    â”‚
    â”œâ”€â–º ç§»é™¤ GameDbContext ä¾èµ–
    â”œâ”€â–º æ³¨å…¥ ICharacterRepository
    â””â”€â–º æ›´æ–°æ–¹æ³•è°ƒç”¨
        â”‚
        â–¼
æ­¥éª¤ 4: åˆ›å»º IRunningBattleSnapshotRepository
    â”‚
    â”œâ”€â–º å®šä¹‰æ¥å£
    â”œâ”€â–º å®ç° Repository
    â””â”€â–º æ³¨å†Œåˆ° DI
        â”‚
        â–¼
æ­¥éª¤ 5: é‡æ„ StepBattleSnapshotService
    â”‚
    â”œâ”€â–º ç§»é™¤ IServiceScopeFactory
    â”œâ”€â–º æ³¨å…¥ IRunningBattleSnapshotRepository
    â””â”€â–º æ›´æ–°æ‰€æœ‰æ–¹æ³•
        â”‚
        â–¼
æ­¥éª¤ 6: å®ç° GenericRepository<T>
    â”‚
    â””â”€â–º ä¸ºæœªæ¥æ‰©å±•åšå‡†å¤‡
        â”‚
        â–¼
æ­¥éª¤ 7: å®ç° IUnitOfWork
    â”‚
    â””â”€â–º ç»Ÿä¸€äº‹åŠ¡ç®¡ç†
        â”‚
        â–¼
âœ… Phase 2 å®Œæˆ
```

---

## ğŸ“Š 7. ä¾èµ–å¥åº·åº¦è¯„åˆ†

| æ¨¡å—/ç±» | ä¾èµ–å¥åº·åº¦ | è¯„åˆ† | è¯´æ˜ |
|--------|-----------|------|------|
| **Domain.Combat** | â­â­â­â­â­ | 100% | æ— å¤–éƒ¨ä¾èµ–ï¼Œçº¯é¢†åŸŸé€»è¾‘ |
| **Domain.Characters** | â­â­â­â­â­ | 100% | æ— å¤–éƒ¨ä¾èµ– |
| **BattleRepository** | â­â­â­â­ | 90% | è‰¯å¥½æŠ½è±¡ï¼Œé€šè¿‡æ¥å£ |
| **CharacterRepository** | â­â­â­â­ | 90% | è‰¯å¥½æŠ½è±¡ï¼Œé€šè¿‡æ¥å£ |
| **StepBattleCoordinator** | â­â­â­ | 60% | ä½¿ç”¨ ServiceScope è¿è¡Œæ—¶è§£æ |
| **StepBattleFinalizer** | â­â­â­â­ | 85% | é€šè¿‡æ¥å£ä¾èµ– Repository |
| **CharactersController** | â­ | 20% | ç›´æ¥ä¾èµ– DbContextï¼Œéœ€é‡æ„ |
| **StepBattleSnapshotService** | â­â­ | 40% | ç»•è¿‡ Repositoryï¼Œç›´æ¥ä½¿ç”¨ DbContext |

### 7.1 å¥åº·åº¦è¶‹åŠ¿ï¼ˆé‡æ„åé¢„æœŸï¼‰

```
å¥åº·åº¦ (%)
100 â”‚              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Domain (ä¿æŒ)
    â”‚              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 90 â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Repository (ä¿æŒ)
    â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 80 â”‚              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Controller (é‡æ„åæå‡è‡³ 90%)
    â”‚              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 60 â”‚                       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Coordinator (æ”¹è¿›åæå‡è‡³ 80%)
    â”‚                       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 40 â”‚                                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ SnapshotService (é‡æ„åæå‡è‡³ 90%)
    â”‚                                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 20 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    é‡æ„å‰                                            é‡æ„å
```

---

## ğŸ“ æ€»ç»“

### å…³é”®å‘ç°

1. **âœ… Domain å±‚è®¾è®¡ä¼˜ç§€**
   - å®Œå…¨ç‹¬ç«‹ï¼Œæ— å¤–éƒ¨ä¾èµ–
   - èŒè´£æ¸…æ™°ï¼Œé«˜å†…èšä½è€¦åˆ
   - æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

2. **âš ï¸ Infrastructure å±‚æŠ½è±¡ä¸è¶³**
   - ä»… 2 ä¸ª Repositoryï¼Œè¦†ç›–ä¸å…¨
   - CharactersController ç»•è¿‡æŠ½è±¡
   - StepBattleSnapshotService ç»•è¿‡æŠ½è±¡

3. **ğŸ”´ éœ€è¦é‡æ„çš„çƒ­ç‚¹**
   - CharactersController â†’ GameDbContextï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
   - StepBattleSnapshotService â†’ GameDbContextï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
   - StepBattleCoordinator â†’ IServiceScopeFactoryï¼ˆä½ä¼˜å…ˆçº§ï¼‰

### é‡æ„ä¼˜å…ˆçº§

```
ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨ï¼‰
â”œâ”€â”€ CharactersController ä½¿ç”¨ Repository
â””â”€â”€ åˆ›å»º IRunningBattleSnapshotRepository

ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆ2-3å‘¨ï¼‰
â”œâ”€â”€ å®ç° GenericRepository<T>
â”œâ”€â”€ å®ç° IUnitOfWork
â””â”€â”€ æ‰©å±• Repository è¦†ç›–èŒƒå›´

ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆ1ä¸ªæœˆå†…ï¼‰
â””â”€â”€ æ”¹è¿› StepBattleCoordinator ä¾èµ–æ³¨å…¥
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ21æ—¥  
**ç»´æŠ¤äºº**: GitHub Copilot Agent

