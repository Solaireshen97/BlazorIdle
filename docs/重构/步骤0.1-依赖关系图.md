# BlazorIdle 依赖关系图
**基于步骤 0.1 代码审计结果**

**生成日期**: 2025年10月21日  
**分析范围**: BlazorIdle.Server 全部代码  
**图表类型**: 模块依赖、类依赖、数据流

---

## 📊 1. 分层架构总览

### 1.1 理想分层架构（目标）

```
┌─────────────────────────────────────────────┐
│              Presentation Layer             │
│         (BlazorIdle Client - WebAssembly)   │
└──────────────────┬──────────────────────────┘
                   │ HTTP/REST API
                   ▼
┌─────────────────────────────────────────────┐
│              API Layer                      │
│         (Controllers, DTOs)                 │
└──────────────────┬──────────────────────────┘
                   │ Application Services
                   ▼
┌─────────────────────────────────────────────┐
│          Application Layer                  │
│    (Services, Coordinators, Commands)       │
└──────────────────┬──────────────────────────┘
                   │ Domain Logic
                   ▼
┌─────────────────────────────────────────────┐
│             Domain Layer                    │
│  (Entities, Value Objects, Domain Services) │
└──────────────────┬──────────────────────────┘
                   │ Persistence Abstraction
                   ▼
┌─────────────────────────────────────────────┐
│         Infrastructure Layer                │
│   (Repositories, DbContext, Caching, etc)   │
└─────────────────────────────────────────────┘
```

### 1.2 当前实际架构（存在问题）

```
┌─────────────────────────────────────────────┐
│              API Layer                      │
│                                             │
│  CharactersController                       │
│         │                                   │
│         └──────────┐                        │
│                    │                        │
└────────────────────┼────────────────────────┘
                     │
                     │ ❌ 直接依赖 DbContext
                     │    (应该通过 Repository)
                     ▼
┌─────────────────────────────────────────────┐
│         Infrastructure Layer                │
│                                             │
│         GameDbContext                       │
│              │                              │
│              ▼                              │
│         SQLite Database                     │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│          Application Layer                  │
│                                             │
│  StepBattleCoordinator                      │
│         │                                   │
│         └─────► IServiceScopeFactory        │
│                     │                       │
│                     └─────► StepBattleFinalizer
│                                 │           │
└─────────────────────────────────┼───────────┘
                                  │
                                  │ ✅ 通过接口
                                  │    (良好抽象)
                                  ▼
┌─────────────────────────────────────────────┐
│         Infrastructure Layer                │
│                                             │
│         IBattleRepository                   │
│              │                              │
│              ▼                              │
│         BattleRepository                    │
│              │                              │
│              ▼                              │
│         GameDbContext                       │
└─────────────────────────────────────────────┘
```

---

## 🔗 2. 模块依赖关系图

### 2.1 完整依赖图

```
┌──────────────────────────────────────────────────────────────┐
│                         Api Layer                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  CharactersController ────❌────┐                           │
│  BattlesController                                           │
│  StepBattlesController                                       │
│  OfflineController                                           │
│  SimulationController                                        │
│  EnemiesController                                           │
│  BattlesReplayController                                     │
│                                                              │
└──────────┬───────────────────────┬───────────────────────────┘
           │                       │
           │ ✅ 正常依赖           │ ❌ 跨层直接依赖
           ▼                       ▼
┌──────────────────────┐  ┌────────────────────────────────┐
│   Application Layer  │  │   Infrastructure.Persistence   │
├──────────────────────┤  ├────────────────────────────────┤
│                      │  │                                │
│ StepBattleCoord.────┐│  │      GameDbContext             │
│ StepBattleFinalizer ││  │                                │
│ StepBattleSnapshot  ││  └────────────────────────────────┘
│ BatchSimulator      ││
│ OfflineSettlement   ││
│ StartBattleService  ││
│ BattleRunner        ││
│                     ││
└────┬────────────────┼┘
     │                │
     │ ✅ 通过接口    │ ⚠️ 通过 ServiceScope
     │                │    临时解析 DbContext
     ▼                ▼
┌──────────────────────────────────────────┐
│     Infrastructure.Persistence           │
├──────────────────────────────────────────┤
│                                          │
│  Abstractions/                           │
│  ├── IBattleRepository                   │
│  └── ICharacterRepository                │
│                                          │
│  Repositories/                           │
│  ├── BattleRepository ──────┐           │
│  └── CharacterRepository ───┤           │
│                              │           │
└──────────────────────────────┼───────────┘
                               │
                               │ ✅ 正常依赖
                               ▼
┌──────────────────────────────────────────┐
│        GameDbContext                     │
├──────────────────────────────────────────┤
│                                          │
│  DbSet<Character>                        │
│  DbSet<BattleRecord>                     │
│  DbSet<RunningBattleSnapshotRecord>      │
│                                          │
└──────────────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────┐
│          SQLite Database                 │
│           (gamedata.db)                  │
└──────────────────────────────────────────┘
```

### 2.2 Domain 层依赖（独立性好）

```
┌─────────────────────────────────────────────┐
│              Domain Layer                   │
│         (完全独立，无外部依赖)              │
├─────────────────────────────────────────────┤
│                                             │
│  Combat/                                    │
│  ├── Engine/                                │
│  │   └── BattleEngine ───┐                 │
│  │                        │                 │
│  ├── Skills/               │                 │
│  │   ├── SkillDefinition  │                 │
│  │   ├── SkillRuntime     │                 │
│  │   └── AutoCastEngine ──┤                 │
│  │                        │                 │
│  ├── Buffs/                │                 │
│  │   ├── BuffDefinition   │                 │
│  │   ├── BuffInstance     │                 │
│  │   └── BuffManager ─────┤                 │
│  │                        │                 │
│  ├── Resources/            │                 │
│  │   ├── ResourceBucket   │                 │
│  │   └── ResourceSet ─────┤                 │
│  │                        │                 │
│  ├── Professions/          │                 │
│  │   ├── IProfessionModule│                 │
│  │   ├── WarriorProf.     │                 │
│  │   └── RangerProf. ─────┤                 │
│  │                        │                 │
│  ├── EventScheduler ───────┤                 │
│  ├── GameClock ────────────┤                 │
│  ├── TrackState ───────────┤                 │
│  │                        │                 │
│  │  共同组成              │                 │
│  ▼                        ▼                 │
│  ┌──────────────────────────┐              │
│  │    BattleAggregate       │              │
│  │   (核心战斗聚合根)       │              │
│  └──────────────────────────┘              │
│                                             │
│  Characters/                                │
│  ├── Character                              │
│  ├── CharacterStats                         │
│  ├── PrimaryAttributes                      │
│  └── StatsBuilder                           │
│                                             │
│  Records/                                   │
│  ├── BattleRecord ────────┐                │
│  └── BattleSegmentRecord ─┘                │
│                                             │
└─────────────────────────────────────────────┘
         │
         │ ✅ 无依赖外部层
         │    (纯领域逻辑)
         ▼
    (所有其他层依赖 Domain)
```

---

## 🔍 3. 关键类依赖详图

### 3.1 CharactersController 依赖链（问题）

```
CharactersController.cs
├── 注入依赖
│   └── GameDbContext _db ────────❌ 应该注入 ICharacterRepository
│
├── Create() 方法
│   ├── _db.Characters.Add(c) ────❌ 应该 _repo.AddAsync(c)
│   └── _db.SaveChangesAsync() ───❌ 应该在 Repository 内部
│
└── Get() 方法
    └── _db.Characters.FirstOrDefaultAsync() ─❌ 应该 _repo.GetByIdAsync()
```

**重构目标**:
```
CharactersController.cs
├── 注入依赖
│   └── ICharacterRepository _characterRepo ──✅ 通过接口
│
├── Create() 方法
│   └── _characterRepo.AddAsync(c) ───────────✅ 使用仓储
│
└── Get() 方法
    └── _characterRepo.GetByIdAsync(id) ──────✅ 使用仓储
```

### 3.2 StepBattleCoordinator 依赖链（可改进）

```
StepBattleCoordinator
├── 注入依赖
│   └── IServiceScopeFactory _scopeFactory ───⚠️ 运行时依赖解析
│
├── AdvanceAll() 方法
│   └── 对每个 RunningBattle
│       └── 如果完成且未持久化
│           ├── using var scope = _scopeFactory.CreateScope()
│           ├── var finalizer = scope.GetRequiredService<StepBattleFinalizer>()
│           └── finalizer.FinalizeAsync(rb) ──┐
│                                             │
└── StopAndFinalizeAsync() 方法              │
    └── 同样模式                             │
                                             │
                                             ▼
                            StepBattleFinalizer
                            ├── 注入依赖
                            │   └── IBattleRepository _repo ───✅ 通过接口
                            │
                            └── FinalizeAsync()
                                └── _repo.AddAsync(record) ──✅ 使用仓储
```

**改进建议**:
```
StepBattleCoordinator
├── 注入依赖
│   └── IStepBattleFinalizerFactory _finalizerFactory ──✅ 通过工厂
│
└── AdvanceAll() 方法
    └── 对每个 RunningBattle
        └── 如果完成且未持久化
            ├── var finalizer = _finalizerFactory.Create() ──✅ 工厂创建
            └── finalizer.FinalizeAsync(rb)
```

### 3.3 StepBattleSnapshotService 依赖链（需重构）

```
StepBattleSnapshotService
├── 注入依赖
│   └── IServiceScopeFactory _scopeFactory ───⚠️ 运行时解析
│
├── SaveAsync() 方法
│   ├── using var scope = _scopeFactory.CreateScope()
│   ├── var db = scope.GetRequiredService<GameDbContext>() ───❌ 直接使用 DbContext
│   ├── var row = await db.Set<RunningBattleSnapshotRecord>()...
│   └── await db.SaveChangesAsync() ─────────────────────────❌ 绕过 Repository
│
├── DeleteAsync() 方法
│   └── 同样模式 ────────────────────────────────────────────❌
│
└── RecoverAllAsync() 方法
    └── 同样模式 ────────────────────────────────────────────❌
```

**重构目标**:
```
StepBattleSnapshotService
├── 注入依赖
│   └── IRunningBattleSnapshotRepository _snapshotRepo ──✅ 通过接口
│
├── SaveAsync() 方法
│   └── _snapshotRepo.SaveAsync(snapshot) ────────────────✅ 使用仓储
│
├── DeleteAsync() 方法
│   └── _snapshotRepo.DeleteAsync(stepBattleId) ──────────✅ 使用仓储
│
└── RecoverAllAsync() 方法
    └── var rows = await _snapshotRepo.GetAllAsync() ─────✅ 使用仓储
```

### 3.4 Repository 层依赖链（良好）

```
Application Services
        │
        │ ✅ 依赖接口抽象
        ▼
┌─────────────────────┐
│ IBattleRepository   │
│ ICharacterRepository│
└──────────┬──────────┘
           │
           │ ✅ 接口实现
           ▼
┌─────────────────────┐
│ BattleRepository    │
│ CharacterRepository │
└──────────┬──────────┘
           │
           │ ✅ 注入 DbContext
           ▼
┌─────────────────────┐
│   GameDbContext     │
├─────────────────────┤
│ DbSet<Character>    │
│ DbSet<BattleRecord> │
│ DbSet<...>          │
└──────────┬──────────┘
           │
           │ ✅ EF Core 管理
           ▼
┌─────────────────────┐
│  SQLite Database    │
└─────────────────────┘
```

---

## 📈 4. 数据流分析

### 4.1 创建角色流程

**当前流程（有问题）**:
```
Client (Blazor)
    │ POST /api/characters
    ▼
CharactersController.Create()
    │ new Character { ... }
    ▼
❌ _db.Characters.Add(c)
    │
    ▼
❌ _db.SaveChangesAsync()
    │
    ▼
SQLite Database
    │
    ▼
Response { id, name }
    │
    ▼
Client (Blazor)
```

**目标流程（重构后）**:
```
Client (Blazor)
    │ POST /api/characters
    ▼
CharactersController.Create()
    │ new Character { ... }
    ▼
✅ _characterRepo.AddAsync(c)
    │
    ▼
CharacterRepository
    │ _db.Characters.Add(c)
    │ _db.SaveChangesAsync()
    ▼
SQLite Database
    │
    ▼
Response { id, name }
    │
    ▼
Client (Blazor)
```

### 4.2 战斗执行流程

```
Client (Blazor)
    │ POST /api/stepbattles/start
    ▼
StepBattlesController.Start()
    │
    ▼
StepBattleCoordinator.Start()
    │ 创建 RunningBattle
    │ 加入内存字典
    ▼
StepBattleHostedService
    │ 后台线程定期调用
    ▼
StepBattleCoordinator.AdvanceAll()
    │ 对每个 RunningBattle
    ▼
RunningBattle.Advance()
    │ 推进战斗模拟
    │ 生成 CombatSegment
    ▼
如果完成
    │
    ▼
StepBattleFinalizer.FinalizeAsync()
    │ 聚合数据
    │ 计算奖励
    ▼
✅ IBattleRepository.AddAsync(record)
    │
    ▼
BattleRepository
    │ _db.Battles.Add(record)
    │ _db.SaveChangesAsync()
    ▼
SQLite Database (持久化)
    │
    ▼
Client 轮询 GET /api/stepbattles/{id}
    │
    ▼
StepBattleCoordinator.GetStatus(id)
    │ 从内存返回状态
    ▼
Response { status, segments, rewards }
```

### 4.3 快照保存流程（需重构）

**当前流程**:
```
StepBattleHostedService
    │ 定期触发
    ▼
StepBattleSnapshotService.SaveAsync(rb)
    │
    ▼
❌ var db = scope.GetService<GameDbContext>()
    │
    ▼
❌ db.Set<RunningBattleSnapshotRecord>().FirstOrDefault(...)
    │
    ▼
❌ db.Add() 或 Update()
    │
    ▼
❌ db.SaveChangesAsync()
    │
    ▼
SQLite Database
```

**目标流程**:
```
StepBattleHostedService
    │ 定期触发
    ▼
StepBattleSnapshotService.SaveAsync(rb)
    │
    ▼
✅ _snapshotRepo.SaveAsync(snapshot)
    │
    ▼
RunningBattleSnapshotRepository
    │ _db.Set<...>().FirstOrDefault(...)
    │ _db.Add() 或 Update()
    │ _db.SaveChangesAsync()
    ▼
SQLite Database
```

---

## 🎯 5. 重构前后对比

### 5.1 CharactersController 重构对比

**重构前**:
```csharp
public class CharactersController : ControllerBase
{
    private readonly GameDbContext _db; // ❌ 直接依赖 DbContext

    public CharactersController(GameDbContext db) => _db = db;

    [HttpPost]
    public async Task<ActionResult<object>> Create([FromBody] CreateCharacterDto dto)
    {
        var c = new Character { ... };
        _db.Characters.Add(c);           // ❌ 直接操作 DbSet
        await _db.SaveChangesAsync();    // ❌ 直接调用 SaveChanges
        return Ok(new { c.Id, c.Name });
    }

    [HttpGet("{id:guid}")]
    public async Task<ActionResult<object>> Get(Guid id)
    {
        var c = await _db.Characters.FirstOrDefaultAsync(x => x.Id == id); // ❌ 直接查询
        return c is null ? NotFound() : Ok(...);
    }
}
```

**重构后**:
```csharp
public class CharactersController : ControllerBase
{
    private readonly ICharacterRepository _characterRepo; // ✅ 依赖接口

    public CharactersController(ICharacterRepository characterRepo) 
        => _characterRepo = characterRepo;

    [HttpPost]
    public async Task<ActionResult<object>> Create([FromBody] CreateCharacterDto dto)
    {
        var c = new Character { ... };
        await _characterRepo.AddAsync(c);  // ✅ 使用仓储
        return Ok(new { c.Id, c.Name });
    }

    [HttpGet("{id:guid}")]
    public async Task<ActionResult<object>> Get(Guid id)
    {
        var c = await _characterRepo.GetByIdAsync(id); // ✅ 使用仓储
        return c is null ? NotFound() : Ok(...);
    }
}
```

### 5.2 依赖图对比

**重构前**:
```
CharactersController ────❌────► GameDbContext ────► SQLite
                                      ▲
                                      │ 
BattleRepository ───────────✅────────┘
```

**重构后**:
```
CharactersController ────✅────► ICharacterRepository
                                      │
                                      ▼
                              CharacterRepository
                                      │
                                      ▼
                                 GameDbContext ────► SQLite
                                      ▲
                                      │
BattleRepository ───────────✅────────┘
```

---

## 🚀 6. 重构路径

### 6.1 Phase 2 重构路径图

```
步骤 1: 扩展 ICharacterRepository
    │
    ├─► 添加 GetByIdAsync()
    ├─► 添加 AddAsync()
    └─► 添加 UpdateAsync()
        │
        ▼
步骤 2: 实现 CharacterRepository 新方法
    │
    └─► 在 Repository 中实现接口方法
        │
        ▼
步骤 3: 重构 CharactersController
    │
    ├─► 移除 GameDbContext 依赖
    ├─► 注入 ICharacterRepository
    └─► 更新方法调用
        │
        ▼
步骤 4: 创建 IRunningBattleSnapshotRepository
    │
    ├─► 定义接口
    ├─► 实现 Repository
    └─► 注册到 DI
        │
        ▼
步骤 5: 重构 StepBattleSnapshotService
    │
    ├─► 移除 IServiceScopeFactory
    ├─► 注入 IRunningBattleSnapshotRepository
    └─► 更新所有方法
        │
        ▼
步骤 6: 实现 GenericRepository<T>
    │
    └─► 为未来扩展做准备
        │
        ▼
步骤 7: 实现 IUnitOfWork
    │
    └─► 统一事务管理
        │
        ▼
✅ Phase 2 完成
```

---

## 📊 7. 依赖健康度评分

| 模块/类 | 依赖健康度 | 评分 | 说明 |
|--------|-----------|------|------|
| **Domain.Combat** | ⭐⭐⭐⭐⭐ | 100% | 无外部依赖，纯领域逻辑 |
| **Domain.Characters** | ⭐⭐⭐⭐⭐ | 100% | 无外部依赖 |
| **BattleRepository** | ⭐⭐⭐⭐ | 90% | 良好抽象，通过接口 |
| **CharacterRepository** | ⭐⭐⭐⭐ | 90% | 良好抽象，通过接口 |
| **StepBattleCoordinator** | ⭐⭐⭐ | 60% | 使用 ServiceScope 运行时解析 |
| **StepBattleFinalizer** | ⭐⭐⭐⭐ | 85% | 通过接口依赖 Repository |
| **CharactersController** | ⭐ | 20% | 直接依赖 DbContext，需重构 |
| **StepBattleSnapshotService** | ⭐⭐ | 40% | 绕过 Repository，直接使用 DbContext |

### 7.1 健康度趋势（重构后预期）

```
健康度 (%)
100 │              ████████ Domain (保持)
    │              ████████
 90 │     ████████ Repository (保持)
    │     ████████
 80 │              ████████ Controller (重构后提升至 90%)
    │              ████████
 60 │                       ████████ Coordinator (改进后提升至 80%)
    │                       ████████
 40 │                                ████████ SnapshotService (重构后提升至 90%)
    │                                ████████
 20 │
    └─────────────────────────────────────────────────────►
    重构前                                            重构后
```

---

## 📝 总结

### 关键发现

1. **✅ Domain 层设计优秀**
   - 完全独立，无外部依赖
   - 职责清晰，高内聚低耦合
   - 易于测试和维护

2. **⚠️ Infrastructure 层抽象不足**
   - 仅 2 个 Repository，覆盖不全
   - CharactersController 绕过抽象
   - StepBattleSnapshotService 绕过抽象

3. **🔴 需要重构的热点**
   - CharactersController → GameDbContext（高优先级）
   - StepBattleSnapshotService → GameDbContext（中优先级）
   - StepBattleCoordinator → IServiceScopeFactory（低优先级）

### 重构优先级

```
🔴 高优先级（本周）
├── CharactersController 使用 Repository
└── 创建 IRunningBattleSnapshotRepository

🟡 中优先级（2-3周）
├── 实现 GenericRepository<T>
├── 实现 IUnitOfWork
└── 扩展 Repository 覆盖范围

🟢 低优先级（1个月内）
└── 改进 StepBattleCoordinator 依赖注入
```

---

**文档版本**: 1.0  
**最后更新**: 2025年10月21日  
**维护人**: GitHub Copilot Agent

