# BlazorIdle 重构检查清单
**基于步骤 0.1 代码审计结果**

**生成日期**: 2025年10月21日  
**适用阶段**: Phase 0 - Phase 5  
**使用说明**: 每完成一项，标记为 [x]

---

## 📋 Phase 0: 准备阶段

### 步骤 0.1: 代码审计与标记 ✅
- [x] 扫描所有直接使用 GameDbContext 的位置
- [x] 标记 CharactersController 直接使用 DbContext（3处）
- [x] 标记 StepBattleSnapshotService 通过 ServiceScope 使用 DbContext（3处）
- [x] 扫描 SignalR 推送逻辑（结论：无）
- [x] 扫描缓存使用点（结论：无）
- [x] 检查循环依赖（结论：无）
- [x] 识别耦合热点（StepBattleCoordinator, StepBattleSnapshotService）
- [x] 输出代码审计报告

### 步骤 0.2: 创建新目录结构
- [ ] 创建 `Infrastructure/Messaging/` 目录
  - [ ] 创建子目录结构（见下方详情）
- [ ] 创建 `Infrastructure/Caching/` 目录
  - [ ] 创建 `CacheStrategies/` 子目录
- [ ] 创建 `Infrastructure/Configuration/` 目录
  - [ ] 创建 `Validators/` 子目录
- [ ] 创建 `Infrastructure/EventSourcing/` 目录
- [ ] 更新 `.gitignore`（如需要）

**详细目录结构**:
```
Infrastructure/
├── Messaging/                  # 新增
│   ├── IEventBus.cs
│   ├── InMemoryEventBus.cs
│   ├── IDomainEvent.cs
│   └── SignalRDispatcher.cs
│
├── Persistence/                # 扩展
│   ├── Abstractions/           # 新增
│   │   ├── IRepository.cs
│   │   ├── IUnitOfWork.cs
│   │   └── IReadOnlyRepository.cs
│   ├── Repositories/           # 已有，扩展
│   │   ├── GenericRepository.cs        # 新增
│   │   ├── CharacterRepository.cs      # 已有
│   │   ├── BattleRepository.cs         # 已有
│   │   └── RunningBattleSnapshotRepository.cs  # 新增
│   ├── GameDbContext.cs        # 已有
│   └── UnitOfWork.cs           # 新增
│
├── Caching/                    # 新增
│   ├── IMultiTierCache.cs
│   ├── MultiTierCacheManager.cs
│   ├── CacheInvalidationCoordinator.cs
│   └── CacheStrategies/
│       ├── CharacterCacheStrategy.cs
│       └── ConfigCacheStrategy.cs
│
├── Configuration/              # 新增
│   ├── IConfigProvider.cs
│   ├── JsonConfigProvider.cs
│   ├── ConfigVersionManager.cs
│   └── Validators/
│       ├── SkillConfigValidator.cs
│       └── EquipmentConfigValidator.cs
│
└── EventSourcing/              # 新增
    ├── IEventStore.cs
    ├── EventStore.cs
    ├── ISnapshotStore.cs
    └── SnapshotStore.cs
```

### 步骤 0.3: 引入依赖包
- [ ] 安装 MediatR
  ```bash
  dotnet add BlazorIdle.Server package MediatR --version 12.2.0
  ```
- [ ] 安装 FluentValidation
  ```bash
  dotnet add BlazorIdle.Server package FluentValidation --version 11.9.0
  ```
- [ ] 验证包安装成功
  - [ ] 检查 `BlazorIdle.Server.csproj` 包含新依赖
  - [ ] 运行 `dotnet restore` 确认无错误

### 步骤 0.4: 建立测试基础设施
- [ ] 创建或定位测试项目
  - [ ] 如不存在，创建 `BlazorIdle.Tests` 项目
  ```bash
  dotnet new xunit -n BlazorIdle.Tests
  dotnet sln add BlazorIdle.Tests
  ```
- [ ] 创建测试目录结构
  ```
  BlazorIdle.Tests/
  ├── Infrastructure/
  │   ├── Messaging/
  │   │   └── EventBusTests.cs
  │   ├── Persistence/
  │   │   ├── RepositoryTests.cs
  │   │   └── UnitOfWorkTests.cs
  │   ├── Caching/
  │   │   └── MultiTierCacheTests.cs
  │   └── Configuration/
  │       └── ConfigProviderTests.cs
  └── Fixtures/
      ├── InMemoryDbContextFixture.cs
      └── TestDataBuilder.cs
  ```
- [ ] 安装测试依赖包
  ```bash
  dotnet add BlazorIdle.Tests package Microsoft.EntityFrameworkCore.InMemory
  dotnet add BlazorIdle.Tests package Moq
  dotnet add BlazorIdle.Tests package FluentAssertions
  ```

### 步骤 0.5: 创建接口定义
- [ ] 定义消息总线接口
  - [ ] `IDomainEvent.cs`
  - [ ] `IEventBus.cs`
- [ ] 定义持久化接口
  - [ ] `IRepository<T>.cs`
  - [ ] `IUnitOfWork.cs`
  - [ ] `IReadOnlyRepository<T>.cs`（可选）
- [ ] 定义缓存接口
  - [ ] `IMultiTierCache.cs`
  - [ ] `CacheStatistics.cs`
- [ ] 定义配置接口
  - [ ] `IConfigProvider.cs`
  - [ ] `ConfigChangedEventArgs.cs`
- [ ] 编译验证
  - [ ] 运行 `dotnet build` 确认无错误

---

## 🔧 Phase 1: SignalR 重构（简化版）

**注意**: 由于当前无 SignalR 代码，本阶段重点是事件总线基础设施

### 步骤 1.1: 实现 InMemoryEventBus
- [ ] 创建 `InMemoryEventBus.cs`
- [ ] 实现 `PublishAsync<TEvent>()` 方法
- [ ] 实现 `Subscribe<TEvent>()` 方法
- [ ] 添加日志记录
- [ ] 编写单元测试
  - [ ] 测试事件发布
  - [ ] 测试多订阅者
  - [ ] 测试异常处理

### 步骤 1.2: 定义核心领域事件
- [ ] 创建战斗事件
  - [ ] `BattleStartedEvent.cs`
  - [ ] `BattleSegmentCompletedEvent.cs`
  - [ ] `BattleCompletedEvent.cs`
- [ ] 创建角色事件（可选）
  - [ ] `CharacterCreatedEvent.cs`
  - [ ] `CharacterLevelUpEvent.cs`

### 步骤 1.3: 注册事件总线到 DI
- [ ] 在 `DependencyInjection.cs` 注册 `IEventBus`
- [ ] 配置为 Singleton 生命周期
- [ ] 验证依赖注入工作正常

### 步骤 1.4: 预留 SignalR 集成（占位）
- [ ] 创建 `ISignalRDispatcher.cs` 接口
- [ ] 创建 `SignalRDispatcher.cs` 空实现
- [ ] 在事件总线中添加 SignalR 订阅占位代码（注释）

---

## 💾 Phase 2: 持久化层重构

### 🔴 紧急任务（第1周）

#### 任务 2.1: 重构 CharactersController
- [ ] 创建 `ICharacterRepository` 扩展方法
  - [ ] `Task<Character?> GetByIdAsync(Guid id, ...)`
  - [ ] `Task AddAsync(Character character, ...)`
  - [ ] `Task UpdateAsync(Character character, ...)`
- [ ] 更新 `CharacterRepository` 实现新方法
- [ ] 重构 `CharactersController`
  - [ ] 移除 `GameDbContext _db` 字段
  - [ ] 注入 `ICharacterRepository _characterRepo`
  - [ ] 更新 `Create()` 方法使用仓储
  - [ ] 更新 `Get()` 方法使用仓储
- [ ] 编写单元测试
- [ ] 运行集成测试验证

#### 任务 2.2: 创建 IRunningBattleSnapshotRepository
- [ ] 定义接口
  ```csharp
  public interface IRunningBattleSnapshotRepository
  {
      Task SaveAsync(RunningBattleSnapshot snapshot, CancellationToken ct = default);
      Task DeleteAsync(Guid stepBattleId, CancellationToken ct = default);
      Task<List<RunningBattleSnapshotRecord>> GetAllAsync(CancellationToken ct = default);
  }
  ```
- [ ] 实现 `RunningBattleSnapshotRepository`
- [ ] 重构 `StepBattleSnapshotService`
  - [ ] 移除直接使用 `GameDbContext`
  - [ ] 注入 `IRunningBattleSnapshotRepository`
  - [ ] 更新所有方法
- [ ] 注册到 DI 容器
- [ ] 编写单元测试

### 🟡 重要任务（第2-3周）

#### 任务 2.3: 实现 GenericRepository<T>
- [ ] 创建 `GenericRepository<T>` 基类
- [ ] 实现 `IRepository<T>` 接口
  - [ ] `GetByIdAsync()`
  - [ ] `GetAllAsync()`
  - [ ] `AddAsync()`
  - [ ] `UpdateAsync()`
  - [ ] `DeleteAsync()`
  - [ ] `FindAsync()` (Expression<Func<T, bool>>)
- [ ] 添加批量操作（可选）
  - [ ] `AddRangeAsync()`
  - [ ] `UpdateRangeAsync()`
- [ ] 编写单元测试

#### 任务 2.4: 实现 UnitOfWork
- [ ] 创建 `UnitOfWork.cs`
- [ ] 实现 `IUnitOfWork` 接口
  - [ ] `Repository<T>()` 方法
  - [ ] `SaveChangesAsync()`
  - [ ] `BeginTransactionAsync()`
  - [ ] `CommitAsync()`
  - [ ] `RollbackAsync()`
- [ ] 管理 Repository 实例缓存
- [ ] 实现 `IDisposable`
- [ ] 注册到 DI（Scoped）
- [ ] 编写单元测试

#### 任务 2.5: 扩展 CharacterRepository
- [ ] 继承 `GenericRepository<Character>`
- [ ] 实现自定义方法
  - [ ] `GetByUserIdAsync()`（如需要）
  - [ ] `GetByUserWithStatsAsync()`（如需要）
  - [ ] `SearchByNameAsync()`（如需要）

#### 任务 2.6: 扩展 BattleRepository
- [ ] 继承 `GenericRepository<BattleRecord>`
- [ ] 保留现有自定义方法
  - [ ] `GetWithSegmentsAsync()`
  - [ ] `ExistsAsync()`
  - [ ] `UpdateRewardsAsync()`

#### 任务 2.7: 迁移现有代码
- [ ] 扫描所有直接使用 `_db` 的地方
- [ ] 逐一重构为使用 Repository
- [ ] 运行回归测试

---

## 🗄️ Phase 3: 缓存系统完善

### 步骤 3.1: 实现 IMultiTierCache
- [ ] 创建 `MultiTierCacheManager.cs`
- [ ] 实现基础操作
  - [ ] `GetAsync<T>()`
  - [ ] `SetAsync<T>()`
  - [ ] `RemoveAsync()`
- [ ] 实现批量操作
  - [ ] `GetManyAsync<T>()`
  - [ ] `SetManyAsync<T>()`
- [ ] 实现失效机制
  - [ ] `InvalidateByTagAsync()`
  - [ ] `InvalidateByPatternAsync()`
- [ ] 实现统计
  - [ ] `GetStatistics()`
- [ ] 编写单元测试

### 步骤 3.2: 创建缓存策略
- [ ] 创建 `CharacterCacheStrategy.cs`
  - [ ] 定义缓存键格式：`character:{id}`
  - [ ] 设置过期时间：30分钟
  - [ ] 实现 Get/Set/Invalidate
- [ ] 创建 `ConfigCacheStrategy.cs`
  - [ ] 定义缓存键格式：`config:{type}`
  - [ ] 设置过期时间：60分钟
  - [ ] 实现 Get/Set/Invalidate

### 步骤 3.3: 集成缓存到 Repository
- [ ] 创建 `CacheAwareRepository<T>` 装饰器模式
- [ ] 或：在 Repository 中直接集成缓存
- [ ] 更新 `CharacterRepository` 使用缓存
  - [ ] `GetByIdAsync()` 先查缓存
  - [ ] `UpdateAsync()` 后失效缓存
  - [ ] `DeleteAsync()` 后失效缓存
- [ ] 编写单元测试
- [ ] 性能测试验证缓存效果

### 步骤 3.4: 配置缓存层次
- [ ] 更新 `appsettings.json` 添加缓存配置
- [ ] 实现 L1 缓存（MemoryCache）
- [ ] 预留 L2 缓存接口（Redis，未来）
- [ ] 配置缓存策略参数

---

## ⚙️ Phase 4: 配置管理系统

### 步骤 4.1: 实现 JsonConfigProvider
- [ ] 创建 `JsonConfigProvider.cs`
- [ ] 实现 `IConfigProvider` 接口
  - [ ] `Get<T>(string key)`
  - [ ] `GetAll<T>()`
  - [ ] `ReloadAsync()`
  - [ ] `CurrentVersion` 属性
- [ ] 添加配置变更事件 `OnConfigChanged`
- [ ] 编写单元测试

### 步骤 4.2: 创建配置文件结构
- [ ] 创建 `GameData/Config/` 目录
- [ ] 创建配置文件
  - [ ] `version.json`
  - [ ] `Skills.json`（如已有）
  - [ ] `Gears.json`（如已有）
  - [ ] `Enemies.json`（如已有）
  - [ ] `Professions.json`（如已有）
- [ ] 定义配置文件格式规范

### 步骤 4.3: 配置验证器
- [ ] 创建 `SkillConfigValidator.cs`
- [ ] 创建 `EquipmentConfigValidator.cs`
- [ ] 集成 FluentValidation
- [ ] 在配置加载时自动验证
- [ ] 编写验证测试

### 步骤 4.4: 配置热更新
- [ ] 创建 `ConfigAdminController.cs`
- [ ] 实现 `/api/admin/config/reload` 端点
- [ ] 实现 `/api/admin/config/version` 端点
- [ ] 添加权限验证（可选）
- [ ] 测试热更新流程

---

## 📜 Phase 5: 事件溯源与快照

### 步骤 5.1: 定义事件存储接口
- [ ] 创建 `IEventStore.cs`
- [ ] 创建 `ISnapshotStore.cs`
- [ ] 定义 `EventRecord` 实体
- [ ] 定义 `SnapshotRecord` 实体

### 步骤 5.2: 实现事件存储
- [ ] 创建 `EventStore.cs`
- [ ] 实现 `AppendAsync()`
- [ ] 实现 `AppendBatchAsync()`
- [ ] 实现 `GetEventsAsync()`
- [ ] 实现 `GetEventsSinceAsync()`
- [ ] 添加序列化/反序列化逻辑
- [ ] 编写单元测试

### 步骤 5.3: 实现快照存储
- [ ] 创建 `SnapshotStore.cs`
- [ ] 实现 `SaveSnapshotAsync<T>()`
- [ ] 实现 `GetLatestSnapshotAsync<T>()`
- [ ] 添加序列化/反序列化逻辑
- [ ] 编写单元测试

### 步骤 5.4: 集成到战斗系统
- [ ] 在 `BattleEngine` 中发布事件
- [ ] 订阅事件并存储
- [ ] 定期创建快照
- [ ] 测试事件重放功能

---

## ✅ 验收标准

### Phase 0 完成标志
- [ ] 所有接口定义完成且编译通过
- [ ] 目录结构创建完整
- [ ] 依赖包安装成功
- [ ] 测试基础设施就绪

### Phase 1 完成标志
- [ ] EventBus 实现并通过测试
- [ ] 至少定义 3 个领域事件
- [ ] DI 注册正确
- [ ] SignalR 接口预留完成

### Phase 2 完成标志
- [ ] CharactersController 不再直接使用 DbContext
- [ ] StepBattleSnapshotService 使用 Repository
- [ ] UnitOfWork 实现完成
- [ ] 至少 3 个 Repository 实现
- [ ] 所有单元测试通过
- [ ] 性能无退化（对比基准）

### Phase 3 完成标志
- [ ] MultiTierCache 实现完成
- [ ] 至少 2 个缓存策略实现
- [ ] 缓存集成到 Repository
- [ ] 缓存命中率监控可见
- [ ] 性能提升可测量

### Phase 4 完成标志
- [ ] JsonConfigProvider 实现完成
- [ ] 至少 3 种配置文件创建
- [ ] 配置验证器实现
- [ ] 热更新 API 测试通过
- [ ] 配置版本管理可用

### Phase 5 完成标志
- [ ] EventStore 实现完成
- [ ] SnapshotStore 实现完成
- [ ] 战斗事件可持久化
- [ ] 快照创建与恢复测试通过
- [ ] 事件重放验证通过

---

## 📊 进度跟踪

### 总体进度

```
Phase 0: 准备阶段          [█░░░░] 20%  (步骤 0.1 已完成)
Phase 1: SignalR 重构      [░░░░░]  0%
Phase 2: 持久化层重构      [░░░░░]  0%
Phase 3: 缓存系统完善      [░░░░░]  0%
Phase 4: 配置管理系统      [░░░░░]  0%
Phase 5: 事件溯源与快照    [░░░░░]  0%

总计进度: [█░░░░░░░░░] 3%
```

### 关键里程碑

- [ ] **里程碑 1**: Phase 0 完成（预计：本周）
- [ ] **里程碑 2**: Phase 1-2 完成（预计：3周）
- [ ] **里程碑 3**: Phase 3-4 完成（预计：6周）
- [ ] **里程碑 4**: Phase 5 完成（预计：8周）
- [ ] **里程碑 5**: 全部基础设施重构完成（预计：11周）

---

## 📝 使用说明

### 如何使用本检查清单

1. **按顺序执行**: 必须按 Phase 0 → Phase 1 → ... 顺序执行
2. **完成标记**: 完成一项后，将 `[ ]` 改为 `[x]`
3. **记录问题**: 遇到问题在下方"问题跟踪"记录
4. **定期复审**: 每周复审进度，更新百分比
5. **版本控制**: 每次更新后提交到 Git

### 问题跟踪

在此记录执行过程中遇到的问题：

```
日期       | Phase | 问题描述                | 状态    | 负责人
---------- | ----- | ----------------------- | ------- | ------
2025-10-21 | 0.1   | 代码审计完成            | 已解决  | Copilot
           |       |                         |         |
           |       |                         |         |
```

---

**检查清单版本**: 1.0  
**最后更新**: 2025年10月21日  
**维护人**: GitHub Copilot Agent

