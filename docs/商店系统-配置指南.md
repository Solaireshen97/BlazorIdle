# 商店系统配置指南

**版本**: 1.0  
**最后更新**: 2025-10-13  
**目标读者**: 系统管理员、运维工程师

---

## 📋 目录

1. [配置概述](#配置概述)
2. [配置文件结构](#配置文件结构)
3. [环境配置](#环境配置)
4. [参数详解](#参数详解)
5. [配置最佳实践](#配置最佳实践)
6. [配置验证](#配置验证)
7. [常见配置场景](#常见配置场景)
8. [故障排除](#故障排除)

---

## 配置概述

### 配置层次结构

商店系统采用分层配置策略：

```
基础配置 (appsettings.json)
    ↓
环境配置 (appsettings.{Environment}.json)
    ↓
运行时配置 (可选)
```

### 配置优先级

1. 运行时设置（最高优先级）
2. 环境特定配置文件
3. 基础配置文件
4. 代码中的默认值（最低优先级）

### 配置项总览

商店系统共有 **23 个配置参数**，分为 7 大类：

| 类别 | 参数数量 | 说明 |
|------|----------|------|
| 缓存配置 | 3 | 控制缓存行为 |
| 文件路径配置 | 3 | 配置文件位置 |
| 商店配置 | 3 | 商店基础设置 |
| 商品配置 | 3 | 商品相关设置 |
| 购买限制配置 | 4 | 限购规则 |
| 价格配置 | 2 | 价格范围 |
| 验证配置 | 4 | 购买验证规则 |
| 查询配置 | 3 | 查询和分页 |

---

## 配置文件结构

### 主配置文件 (appsettings.json)

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=gamedata.db"
  },
  "Shop": {
    // === 缓存配置 ===
    "EnableCaching": true,
    "ShopDefinitionCacheMinutes": 60,
    "ShopItemsCacheMinutes": 30,
    
    // === 文件路径配置 ===
    "ConfigPath": "Config/Shop",
    "ShopDefinitionsFile": "ShopDefinitions.json",
    "ShopItemsFile": "ShopItems.json",
    
    // === 商店配置 ===
    "DefaultRefreshIntervalSeconds": 3600,
    "MaxShopNameLength": 50,
    "MaxShopDescriptionLength": 200,
    
    // === 商品配置 ===
    "MaxItemNameLength": 100,
    "MaxItemDescriptionLength": 500,
    "UnlimitedStock": -1,
    
    // === 购买限制配置 ===
    "DailyResetSeconds": 86400,
    "WeeklyResetSeconds": 604800,
    "DefaultDailyLimit": 10,
    "DefaultWeeklyLimit": 5,
    
    // === 价格配置 ===
    "MinPriceAmount": 1,
    "MaxPriceAmount": 1000000,
    
    // === 验证配置 ===
    "MinLevelRequirement": 1,
    "MaxLevelRequirement": 100,
    "MinPurchaseQuantity": 1,
    "MaxPurchaseQuantity": 999,
    
    // === 查询配置 ===
    "DefaultPageSize": 20,
    "MaxPageSize": 100,
    "PurchaseHistoryDefaultDays": 30
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

### 商店数据配置文件

#### Config/Shop/ShopDefinitions.json

```json
{
  "shops": [
    {
      "id": "general_shop",
      "name": "杂货铺",
      "description": "售卖基础消耗品和材料",
      "type": "General",
      "isEnabled": true,
      "sortOrder": 1,
      "unlockCondition": null
    },
    {
      "id": "weapon_shop",
      "name": "武器店",
      "description": "出售各类武器装备",
      "type": "Weapon",
      "isEnabled": true,
      "sortOrder": 2,
      "unlockCondition": {
        "minLevel": 5
      }
    }
  ]
}
```

#### Config/Shop/ShopItems.json

```json
{
  "items": [
    {
      "id": "item_health_potion_small",
      "shopId": "general_shop",
      "name": "小型生命药水",
      "description": "恢复 50 点生命值",
      "itemDefinitionId": "consumable_health_potion_small",
      "price": {
        "currencyType": "Gold",
        "amount": 10
      },
      "minLevel": 1,
      "stockQuantity": -1,
      "purchaseLimit": {
        "type": "Daily",
        "maxPurchases": 10
      },
      "isEnabled": true,
      "sortOrder": 1,
      "itemCategory": "Consumable",
      "rarity": "Common"
    }
  ]
}
```

---

## 环境配置

### 开发环境 (Development)

**文件**: `appsettings.Development.json`

**特点**:
- 禁用缓存或使用短缓存时间
- 启用详细日志
- 较小的分页大小便于测试
- 宽松的限制便于开发

```json
{
  "Shop": {
    "EnableCaching": false,
    "ShopDefinitionCacheMinutes": 1,
    "ShopItemsCacheMinutes": 1,
    "DefaultPageSize": 10,
    "MaxPageSize": 50,
    "DefaultDailyLimit": 100,
    "DefaultWeeklyLimit": 50
  },
  "Logging": {
    "LogLevel": {
      "BlazorIdle.Server.Application.Shop": "Debug",
      "BlazorIdle.Server.Domain.Shop": "Debug"
    }
  }
}
```

### 测试环境 (Testing)

**文件**: `appsettings.Testing.json`

**特点**:
- 短缓存时间
- 适中的日志级别
- 标准的限制设置

```json
{
  "Shop": {
    "EnableCaching": true,
    "ShopDefinitionCacheMinutes": 5,
    "ShopItemsCacheMinutes": 5,
    "DefaultPageSize": 20,
    "MaxPageSize": 100
  },
  "Logging": {
    "LogLevel": {
      "BlazorIdle.Server.Application.Shop": "Information",
      "BlazorIdle.Server.Domain.Shop": "Information"
    }
  }
}
```

### 生产环境 (Production)

**文件**: `appsettings.Production.json`

**特点**:
- 启用长缓存
- 仅记录警告和错误
- 严格的限制设置
- 优化的性能参数

```json
{
  "Shop": {
    "EnableCaching": true,
    "ShopDefinitionCacheMinutes": 60,
    "ShopItemsCacheMinutes": 30,
    "DefaultPageSize": 20,
    "MaxPageSize": 100,
    "DefaultDailyLimit": 10,
    "DefaultWeeklyLimit": 5
  },
  "Logging": {
    "LogLevel": {
      "BlazorIdle.Server.Application.Shop": "Information",
      "BlazorIdle.Server.Domain.Shop": "Warning"
    }
  }
}
```

---

## 参数详解

### 1. 缓存配置

#### EnableCaching

- **类型**: `boolean`
- **默认值**: `true`
- **说明**: 是否启用商店系统缓存
- **影响**: 
  - `true`: 启用缓存，提升查询性能
  - `false`: 禁用缓存，每次都从数据库查询

**使用建议**:
- 开发环境: `false` (便于调试)
- 生产环境: `true` (提升性能)

#### ShopDefinitionCacheMinutes

- **类型**: `integer`
- **默认值**: `60`
- **范围**: `1 - 1440` (1分钟 - 24小时)
- **说明**: 商店定义缓存过期时间（分钟）

**使用建议**:
- 开发环境: `1` (快速看到变更)
- 生产环境: `60` (商店定义不常变化)

#### ShopItemsCacheMinutes

- **类型**: `integer`
- **默认值**: `30`
- **范围**: `1 - 1440`
- **说明**: 商品列表缓存过期时间（分钟）

**使用建议**:
- 开发环境: `1`
- 生产环境: `30` (商品可能更新，相对较短)

---

### 2. 文件路径配置

#### ConfigPath

- **类型**: `string`
- **默认值**: `"Config/Shop"`
- **说明**: 商店配置文件所在目录（相对于应用根目录）

**注意事项**:
- 路径使用正斜杠 `/` (跨平台兼容)
- 不要以 `/` 开头或结尾
- 确保目录存在且可读

#### ShopDefinitionsFile

- **类型**: `string`
- **默认值**: `"ShopDefinitions.json"`
- **说明**: 商店定义配置文件名

#### ShopItemsFile

- **类型**: `string`
- **默认值**: `"ShopItems.json"`
- **说明**: 商品配置文件名

---

### 3. 商店配置

#### DefaultRefreshIntervalSeconds

- **类型**: `integer`
- **默认值**: `3600` (1小时)
- **范围**: `60 - 86400` (1分钟 - 24小时)
- **说明**: 商店默认刷新间隔（秒）
- **用途**: 未来商店自动刷新功能使用

#### MaxShopNameLength

- **类型**: `integer`
- **默认值**: `50`
- **范围**: `10 - 200`
- **说明**: 商店名称最大长度

#### MaxShopDescriptionLength

- **类型**: `integer`
- **默认值**: `200`
- **范围**: `50 - 1000`
- **说明**: 商店描述最大长度

---

### 4. 商品配置

#### MaxItemNameLength

- **类型**: `integer`
- **默认值**: `100`
- **范围**: `10 - 200`
- **说明**: 商品名称最大长度

#### MaxItemDescriptionLength

- **类型**: `integer`
- **默认值**: `500`
- **范围**: `100 - 2000`
- **说明**: 商品描述最大长度

#### UnlimitedStock

- **类型**: `integer`
- **默认值**: `-1`
- **说明**: 表示无限库存的特殊值
- **注意**: 不建议修改此值，除非有特殊需求

---

### 5. 购买限制配置

#### DailyResetSeconds

- **类型**: `integer`
- **默认值**: `86400` (24小时)
- **说明**: 每日购买限制重置周期（秒）

**计算方式**:
```
1 小时 = 3600 秒
1 天 = 86400 秒
```

**使用场景**:
- 标准每日重置: `86400`
- 12小时重置: `43200`
- 测试用: `60` (1分钟)

#### WeeklyResetSeconds

- **类型**: `integer`
- **默认值**: `604800` (7天)
- **说明**: 每周购买限制重置周期（秒）

**计算方式**:
```
1 周 = 604800 秒
```

#### DefaultDailyLimit

- **类型**: `integer`
- **默认值**: `10`
- **范围**: `1 - 999`
- **说明**: 默认每日限购数量

**使用建议**:
- 常用消耗品: `10 - 20`
- 稀有物品: `1 - 5`
- 开发测试: `100+`

#### DefaultWeeklyLimit

- **类型**: `integer`
- **默认值**: `5`
- **范围**: `1 - 999`
- **说明**: 默认每周限购数量

**使用建议**:
- 通常设置为每日限购的 1/2 或更少
- 用于控制稀有资源获取速度

---

### 6. 价格配置

#### MinPriceAmount

- **类型**: `integer`
- **默认值**: `1`
- **说明**: 最小价格金额

**使用建议**:
- 避免设置为 `0`（免费物品应使用特殊处理）
- 通常保持默认值 `1`

#### MaxPriceAmount

- **类型**: `integer`
- **默认值**: `1000000` (100万)
- **说明**: 最大价格金额

**使用建议**:
- 根据游戏经济系统调整
- 考虑玩家收入水平
- 避免通货膨胀

---

### 7. 验证配置

#### MinLevelRequirement

- **类型**: `integer`
- **默认值**: `1`
- **范围**: `1 - 100`
- **说明**: 最小等级要求

#### MaxLevelRequirement

- **类型**: `integer`
- **默认值**: `100`
- **范围**: `1 - 1000`
- **说明**: 最大等级要求

**注意**: 确保 `MaxLevelRequirement >= MinLevelRequirement`

#### MinPurchaseQuantity

- **类型**: `integer`
- **默认值**: `1`
- **说明**: 最小购买数量

**使用建议**:
- 通常保持为 `1`
- 允许玩家灵活购买

#### MaxPurchaseQuantity

- **类型**: `integer`
- **默认值**: `999`
- **范围**: `1 - 9999`
- **说明**: 单次最大购买数量

**使用建议**:
- 防止异常大量购买
- 考虑背包容量限制
- 控制经济流动

---

### 8. 查询配置

#### DefaultPageSize

- **类型**: `integer`
- **默认值**: `20`
- **范围**: `5 - 100`
- **说明**: 默认分页大小

**使用建议**:
- 桌面端: `20 - 50`
- 移动端: `10 - 20`
- 开发环境: `10` (便于测试)

#### MaxPageSize

- **类型**: `integer`
- **默认值**: `100`
- **范围**: `10 - 500`
- **说明**: 最大分页大小

**使用建议**:
- 限制单次查询数据量
- 保护数据库性能
- 通常 `50 - 100` 之间

#### PurchaseHistoryDefaultDays

- **类型**: `integer`
- **默认值**: `30`
- **范围**: `7 - 365`
- **说明**: 购买历史默认查询天数

**使用建议**:
- 平衡查询性能和数据完整性
- 考虑数据保留策略

---

## 配置最佳实践

### 1. 安全性

✅ **推荐做法**:
- 不要将敏感配置提交到版本控制
- 使用环境变量存储密钥
- 生产环境使用强随机密钥
- 定期审查和更新配置

❌ **避免**:
- 在代码中硬编码敏感信息
- 使用默认密钥部署生产环境
- 共享生产环境配置

### 2. 性能优化

✅ **推荐做法**:
- 生产环境启用缓存
- 合理设置缓存过期时间
- 监控缓存命中率
- 定期评估性能指标

❌ **避免**:
- 生产环境禁用缓存
- 缓存时间过长或过短
- 忽视性能监控

### 3. 配置管理

✅ **推荐做法**:
- 为每个环境创建独立配置
- 使用配置文件版本控制
- 文档化配置变更
- 测试配置变更影响

❌ **避免**:
- 直接修改生产配置
- 不测试就应用新配置
- 配置变更缺乏记录

### 4. 可维护性

✅ **推荐做法**:
- 添加清晰的配置注释
- 使用有意义的配置值
- 保持配置结构清晰
- 定期清理无用配置

❌ **避免**:
- 配置缺乏文档
- 使用魔法数字
- 配置结构混乱

---

## 配置验证

### 启动时验证

系统启动时会自动验证配置：

1. **配置文件存在性**
   - 检查 appsettings.json
   - 检查环境特定配置文件

2. **配置值有效性**
   - 数值范围检查
   - 必填字段检查
   - 类型匹配检查

3. **依赖关系检查**
   - 数据库连接字符串
   - 配置文件路径

### 手动验证

```bash
# 检查配置文件语法
cat appsettings.json | jq .

# 验证配置完整性
dotnet run --environment=Development --no-build
```

### 常见验证错误

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| JSON 解析失败 | 语法错误 | 检查 JSON 格式 |
| 配置文件未找到 | 路径错误 | 确认文件位置 |
| 类型不匹配 | 配置值类型错误 | 检查数据类型 |
| 值超出范围 | 配置值不合理 | 调整到合理范围 |

---

## 常见配置场景

### 场景 1: 调试商店问题

```json
{
  "Shop": {
    "EnableCaching": false
  },
  "Logging": {
    "LogLevel": {
      "BlazorIdle.Server.Application.Shop": "Debug"
    }
  }
}
```

### 场景 2: 限时活动配置

```json
{
  "Shop": {
    "DefaultDailyLimit": 20,
    "ShopItemsCacheMinutes": 5
  }
}
```

### 场景 3: 性能优化

```json
{
  "Shop": {
    "EnableCaching": true,
    "ShopDefinitionCacheMinutes": 120,
    "ShopItemsCacheMinutes": 60,
    "DefaultPageSize": 50
  }
}
```

### 场景 4: 新手友好配置

```json
{
  "Shop": {
    "DefaultDailyLimit": 50,
    "DefaultWeeklyLimit": 20,
    "MinPriceAmount": 1,
    "MinLevelRequirement": 1
  }
}
```

### 场景 5: 测试配置

```json
{
  "Shop": {
    "EnableCaching": false,
    "DefaultDailyLimit": 1000,
    "DefaultWeeklyLimit": 500,
    "DailyResetSeconds": 60,
    "WeeklyResetSeconds": 300
  }
}
```

---

## 故障排除

### 问题: 配置未生效

**症状**: 修改配置后未看到变化

**检查清单**:
- [ ] 确认修改了正确的配置文件
- [ ] 确认环境变量设置正确
- [ ] 重启应用程序
- [ ] 检查缓存是否影响
- [ ] 查看应用日志

**解决步骤**:
1. 停止应用
2. 清除缓存（如适用）
3. 验证配置文件语法
4. 重新启动应用
5. 验证配置加载日志

### 问题: 性能下降

**症状**: 查询变慢

**检查清单**:
- [ ] 检查缓存是否启用
- [ ] 检查缓存过期时间
- [ ] 检查分页大小设置
- [ ] 查看数据库查询日志
- [ ] 检查数据量增长

**解决步骤**:
1. 启用缓存
2. 优化缓存时间
3. 调整分页大小
4. 检查数据库索引
5. 清理历史数据

### 问题: 限购未生效

**症状**: 玩家超限购买

**检查清单**:
- [ ] 检查 `DailyResetSeconds` 配置
- [ ] 检查 `WeeklyResetSeconds` 配置
- [ ] 检查商品 `PurchaseLimit` 配置
- [ ] 查看 `PurchaseCounters` 表数据
- [ ] 检查时区设置

**解决步骤**:
1. 验证时间配置
2. 检查数据库计数器
3. 确认重置逻辑
4. 测试重置功能
5. 查看应用日志

---

## 配置变更日志

建议维护配置变更日志：

| 日期 | 变更项 | 旧值 | 新值 | 原因 | 操作人 |
|------|--------|------|------|------|--------|
| 2025-10-13 | DefaultDailyLimit | 10 | 20 | 限时活动 | Admin |
| 2025-10-13 | EnableCaching | false | true | 性能优化 | DevOps |

---

## 相关文档

- [商店系统-README.md](./商店系统-README.md) - 系统使用指南
- [商店系统设计方案（上）](./商店系统设计方案（上）.md) - 系统架构
- [商店系统配置化总结](./商店系统配置化总结.md) - 配置化详解
- [边打边发-Configuration-Guide.md](./边打边发-Configuration-Guide.md) - 其他系统配置参考

---

**文档版本**: 1.0  
**最后更新**: 2025-10-13  
**维护团队**: BlazorIdle 开发团队
