# 战斗功能分析与下阶段工作规划

## 一、物品掉落逻辑分析

### 1.1 当前实现概览

项目已经实现了完整的物品掉落逻辑，具有良好的设计和可扩展性：

#### 核心组件

**1. 掉落表系统 (`Domain/Economy/`)**
- `LootEntry`: 定义单个掉落项
  - `DropChance`: 掉落概率 (0.0-1.0)
  - `ItemId`: 物品ID
  - `QuantityMin/Max`: 数量范围
  - `Rolls`: 每次击杀的抽取次数（支持多次roll）
  - `Note`: 备注信息

- `LootTable`: 掉落表
  - 包含多个 `LootEntry`
  - 通过ID引用

- `EconomyRegistry`: 中央注册表
  - 管理物品定义 (`ItemDefinition`)
  - 管理掉落表 (`LootTable`)
  - 管理敌人经济配置 (`EnemyEconomy`)
  - 示例数据：
    - 物品: mat_scrap, mat_core, gem_small
    - 掉落表: loot_common, loot_elite
    - 敌人经济: paper, dummy, tank

**2. 经济计算器 (`EconomyCalculator`)**

提供两种掉落计算模式：

- **期望值模式 (`ComputeExpected`)**
  - 计算数学期望，不实际抽样
  - 公式：`期望 = rolls × dropChance × avgQuantity × killCount`
  - 不消耗RNG，速度快
  - 适合展示预期收益

- **抽样模式 (`ComputeSampled`)**
  - 实际随机抽取，结果有波动
  - 使用独立的经济RNG（通过 `battleSeed ^ salt` 派生）
  - 不影响战斗RNG的可回放性
  - 考虑所有 rolls 次数
  - 适合实际掉落结算

- **上下文增强版本**
  - `ComputeExpectedWithContext`: 支持倍率（金币/经验/掉落概率）
  - `ComputeSampledWithContext`: 支持倍率 + 整轮奖励
  - 支持地城完成奖励

**3. 数据持久化**

- `InventoryItem`: 背包物品表
  ```sql
  - Id: GUID (主键)
  - CharacterId: GUID (外键)
  - ItemId: string (物品ID)
  - Quantity: int (数量)
  - CreatedAt/UpdatedAt: DateTime
  ```

- `EconomyEventRecord`: 经济事件记录
  ```sql
  - Id: GUID
  - CharacterId: GUID
  - BattleId: GUID (可选)
  - EventType: string (事件类型)
  - IdempotencyKey: string (幂等键，防止重复发放)
  - Gold/Exp: long
  - ItemsJson: string (JSON格式)
  ```

- `Character`: 角色表新增字段
  - `Gold`: long
  - `Experience`: long

**4. 奖励发放服务 (`RewardGrantService`)**

- 实现 `IRewardGrantService` 接口
- 功能：
  - 幂等性检查（基于 IdempotencyKey）
  - 事务性更新角色金币/经验
  - 合并或创建背包物品
  - 记录经济事件
- 目前已实现但"边打边发"未启用（见项目状态第6节）

### 1.2 掉落流程

#### 同步战斗
```
StartBattleAsync → BattleRunner → 
收集 killCounts → 
EconomyCalculator.Compute{Expected|Sampled} → 
BattleRecord.{Gold, Exp, LootJson, RewardType}
```

#### Step战斗
```
StepBattleCoordinator.GetStatus(dropMode) →
1) 若 dropMode="expected": 计算期望值
2) 若 dropMode="sampled": 使用 RNG 抽样
3) 返回 StepBattleStatusDto {Gold, Exp, Loot{Expected|Sampled}}
```

#### 持久化（可选）
```
StepBattleFinalizer.FinalizeAsync →
计算奖励（若 sampled 且启用边打边发）→
RewardGrantService.GrantRewardsAsync →
更新 Character.{Gold, Experience} →
更新 InventoryItem（合并或新增）→
记录 EconomyEventRecord
```

### 1.3 优势与特点

✅ **双模式支持**: 期望值用于预览，抽样用于实际结算
✅ **RNG独立性**: 经济RNG不影响战斗回放
✅ **多次roll支持**: 每个LootEntry可配置rolls次数
✅ **幂等性保证**: 防止重复发放奖励
✅ **倍率系统**: 支持金币/经验/掉落倍率
✅ **地城奖励**: 支持整轮完成额外奖励
✅ **数据驱动**: 掉落表可配置，易于扩展

### 1.4 当前限制

⚠️ **边打边发未启用**: 仅在 sampled 模式下持久化到库，需要显式调用
⚠️ **前端未自动刷新背包**: 需要手动刷新查看物品变化
⚠️ **物品定义简单**: 仅有ID和名称，无详细属性（图标、描述、品质等）
⚠️ **无物品分类**: 所有物品平铺显示
⚠️ **无使用/合成系统**: 物品仅作为收藏

---

## 二、战斗功能完成度分析

### 2.1 已实现功能（对比设计总结）

| 设计项 | 当前状态 | 完成度 | 备注 |
|--------|----------|--------|------|
| **事件驱动战斗** | ✅ 已实现 | 100% | 使用事件时间跳跃，优先队列调度 |
| **双轨系统** | ✅ 已实现 | 100% | Attack Track + Special Track，支持独立节奏 |
| **RNG可回放** | ✅ 已实现 | 100% | 段级RngIndexStart/End，支持回放验证 |
| **Buff/DoT系统** | ✅ 已实现 | 90% | Haste快照、叠层、Pandemic刷新；缺失溢出转换 |
| **技能系统** | ✅ 部分实现 | 70% | 单槽队列、Off-GCD编织；缺失优先级队列 |
| **Proc系统** | ✅ 已实现 | 100% | On-Hit/Crit/RPPM、ICD、来源过滤 |
| **AoE/多目标** | ✅ 已实现 | 100% | EncounterGroup、主目标重选、分摊策略 |
| **Stats系统** | ✅ Phase 1 | 80% | AP/SP、暴击、急速、穿透；缺失高级属性 |
| **同步/异步/回放** | ✅ 已实现 | 100% | 支持一次性、Step、回放、批量模拟 |
| **经济系统** | ✅ 已实现 | 80% | 掉落逻辑完整；缺失边打边发、监控 |
| **EventScheduler** | ❌ 未实现 | 0% | 使用简单时间推进，无独立调度器 |
| **ResourceBucket** | ❌ 未实现 | 0% | 当前仅 Health/Mana，无溢出策略 |
| **活动计划系统** | ❌ 未实现 | 0% | 无多槽ActivitySlot |
| **离线快进** | ❌ 未实现 | 10% | 有占位逻辑，无实际实现 |
| **CombatSegment** | ✅ 部分实现 | 60% | 有段数据，但未聚合事件 |
| **条件DSL** | ❌ 未实现 | 0% | 无 |
| **地图区域** | ❌ 未实现 | 0% | 无 MapRegion |
| **装备词条** | ❌ 未实现 | 5% | 固定 EquipmentStats，无动态生成 |
| **分解/重铸** | ❌ 未实现 | 0% | 无 |
| **经济监控** | ❌ 未实现 | 0% | 无 MetricsCollector |
| **调试面板** | ✅ 已实现 | 100% | Step Debug API 完整 |
| **Config版本化** | ❌ 未实现 | 0% | 无 VersionPin |
| **多角色Roster** | ❌ 未实现 | 5% | 有账号角色列表，无槽位逻辑 |

### 2.2 功能亮点

🌟 **战斗核心扎实**
- 双轨系统实现完整，职业差异化明显
- RNG可回放，支持测试和验证
- Proc系统灵活，支持复杂技能效果

🌟 **异步战斗框架良好**
- Step模式支持持续战斗、地城循环
- 快照恢复机制完善
- 幂等Finalizer设计优秀

🌟 **经济系统基础牢固**
- 双模式掉落计算设计合理
- 独立经济RNG不影响战斗
- 幂等性保证数据安全

### 2.3 主要缺失

#### 高优先级（影响核心玩法）

1. **EventScheduler 独立化**
   - 当前时间推进混杂在BattleRunner中
   - 应抽取为独立组件，支持离线复用

2. **ResourceBucket + 溢出策略**
   - 当前资源仅Health/Mana
   - 需要支持怒气、碎片等职业资源
   - 需要Clamp/Convert溢出策略

3. **活动计划系统**
   - 当前仅支持单一战斗活动
   - 需要ActivitySlot多槽调度
   - 需要限制类型（Count/Duration/Infinite）

4. **离线快进引擎**
   - 当前有OfflineController但未实现
   - 需要复用战斗引擎，快速推进

#### 中优先级（增强体验）

5. **CombatSegment 聚合优化**
   - 当前段数据分散
   - 需要aggregates字段（damageBySource/resourceFlow/buffUptime）
   - 减少存储和查询成本

6. **装备系统扩展**
   - 需要GearInstance、Tier、Affix
   - 需要分解/重铸/词条重置
   - 需要SetBonus套装

7. **条件DSL**
   - 用于地图解锁、任务门槛
   - 需要ConditionExpr + Cache

8. **地图/区域系统**
   - MapRegion定义怪池/掉落
   - 区域解锁链
   - 区域挂机

#### 低优先级（后期扩展）

9. **经济监控**
   - MetricsCollector
   - 产出/消耗比率
   - 通胀预警

10. **Config版本化**
    - ConfigBundle + VersionPin
    - 热更新
    - 迁移脚本

11. **多角色Roster**
    - 槽位管理
    - 解锁条件
    - 共享限额

---

## 三、下阶段工作计划

### Phase 1: 完善核心战斗循环（1-2周）

**目标**: 将战斗引擎重构为可复用架构

#### 任务列表
- [ ] 1.1 抽取 `EventScheduler` 独立组件
  - 优先队列（min-heap）
  - 事件接口 `IGameEvent { Time, Execute() }`
  - 与 `BattleRunner` 解耦

- [ ] 1.2 实现 `ResourceBucket`
  - 支持多种资源类型（怒气、碎片、能量等）
  - 溢出策略：Clamp / Convert
  - 与职业绑定

- [ ] 1.3 重构 Buff 运行态
  - `BuffInstance` 替代当前 `ActiveBuff`
  - 支持溢出转换（如怒气溢出→战意层数）
  - 完善层数管理

- [ ] 1.4 技能槽优先级重构
  - 将 `List<string>` 改为 `SkillSlot[]`
  - 支持1→4顺序优先释放
  - AutoCastEngine 独立

#### 验收标准
- 战士/法师职业差异化明显（资源机制不同）
- EventScheduler可独立测试
- Buff溢出转换正常工作

---

### Phase 2: 离线系统与活动计划（2-3周）

**目标**: 支持挂机与离线收益

#### 任务列表
- [ ] 2.1 设计并实现 `ActivityPlan` 模型
  - ActivitySlot（3-5槽）
  - 限制类型：CountLimit / DurationLimit / Infinite
  - 状态机：Pending → Running → Completed

- [ ] 2.2 实现 `OfflineFastForwardEngine`
  - 复用EventScheduler
  - 快速推进（无需逐事件详细记录）
  - 生成 CombatSegment 聚合数据

- [ ] 2.3 CombatSegment 聚合优化
  - 新增字段：damageBySource, resourceFlow, buffUptime
  - 减少原子事件存储
  - RNG seedRange 记录

- [ ] 2.4 前端离线结算界面
  - 展示离线时长
  - 展示总收益（金币/经验/物品）
  - 支持快速查看段摘要

#### 验收标准
- 角色可配置多个活动计划并顺序执行
- 离线登录时自动结算最多12小时收益
- CombatSegment 查询速度提升 >50%

---

### Phase 3: 装备与物品生态（3-4周）

**目标**: 丰富经济循环，增加深度

#### 任务列表
- [ ] 3.1 装备系统扩展
  - `GearDefinition` / `GearInstance`
  - Tier（T1/T2/T3）系数
  - Affix 词条池（Flat/Percent/Proc）
  - SetBonus 套装

- [ ] 3.2 装备操作服务
  - `DisenchantService`（分解→材料）
  - `ReforgeTierService`（品级提升）
  - `RerollService`（词条重置）

- [ ] 3.3 物品系统完善
  - 物品详细定义（图标、描述、品质、分类）
  - 物品使用/合成（可选）
  - 前端物品详情弹窗

- [ ] 3.4 经济监控初版
  - `MetricsCollector`
  - 监控金币流入/流出
  - 材料产出/消耗比率
  - 简单报表API

#### 验收标准
- 装备可随机生成词条
- 装备可分解获得材料
- 装备可重铸提升品级或重置词条
- 经济流向可监控

---

### Phase 4: 地图与解锁系统（2-3周）

**目标**: 引入进程感和内容引导

#### 任务列表
- [ ] 4.1 设计并实现 `MapRegion`
  - 怪物池（权重）
  - 采集节点（未来）
  - 地城列表
  - NPC/任务挂钩

- [ ] 4.2 条件DSL引擎
  - `ConditionExpr` 解析
  - 依赖键（level, reputation, quest, etc.）
  - Cache层（ParseCache / ResultCache）
  - 失效机制

- [ ] 4.3 区域解锁链
  - RegionGraph（邻接/前置条件）
  - 前端地图界面（可视化）
  - 解锁提示

- [ ] 4.4 区域挂机
  - 从 monsterPool 随机敌人
  - 支持持续挂机
  - 区域特殊加成（可选）

#### 验收标准
- 角色从新手区域逐步解锁新区域
- 条件表达式支持复杂逻辑（AND/OR/NOT）
- 前端地图可视化清晰

---

### Phase 5: 多角色与高级功能（3-4周）

**目标**: 支持多角色管理，引入高级玩法

#### 任务列表
- [ ] 5.1 Roster系统
  - `Roster` / `RosterSlot` 模型
  - 槽位解锁条件
  - 角色切换不影响后台活动

- [ ] 5.2 任务与声望
  - QuestDef / ReputationRecord
  - 日常/周常重置
  - 声望解锁商店/区域

- [ ] 5.3 Config版本化
  - `ConfigBundle` / `VersionPin`
  - 热更新流程
  - 迁移脚本

- [ ] 5.4 调试与诊断完善
  - DebugSnapshotBuilder
  - 实时监控面板
  - 性能指标

#### 验收标准
- 账号可管理多个角色（最多5个）
- 任务和声望系统可用
- 配置可热更新，不影响进行中战斗

---

## 四、优先级总结

### 必须完成（P0）
1. **边打边发落地**：当前已有基础，需前后端打通
2. **EventScheduler重构**：为离线系统做准备
3. **ResourceBucket**：职业差异化核心
4. **离线快进引擎**：放置游戏必备

### 应该完成（P1）
5. **活动计划系统**：多活动调度
6. **CombatSegment优化**：性能和存储
7. **装备生态初版**：经济消耗槽位
8. **条件DSL + 地图**：进程引导

### 可以考虑（P2）
9. **经济监控**：运营数据
10. **多角色Roster**：深度体验
11. **Config版本化**：运维便利
12. **高级战斗特性**（消耗品、套装、特殊区域事件等）

---

## 五、风险与建议

### 风险
⚠️ **重构风险**：EventScheduler和ResourceBucket重构可能影响现有战斗逻辑
⚠️ **时间估算**：Phase 1-2 可能需要3-5周而非计划的3-4周
⚠️ **数据迁移**：装备系统扩展需要数据库迁移和历史数据处理

### 建议
✅ **增量开发**：每个Phase独立可测试，不影响现有功能
✅ **保持向后兼容**：新字段可选，旧数据兼容
✅ **自动化测试**：重构时增加单元测试和集成测试
✅ **文档同步**：代码变更同步更新设计文档

---

## 六、总结

当前项目在战斗核心和经济基础方面已经非常扎实，物品掉落逻辑设计优秀。下阶段重点应该是：

1. **完善战斗引擎架构**（EventScheduler + ResourceBucket）
2. **实现离线系统**（OfflineFastForwardEngine + ActivityPlan）
3. **丰富装备与物品**（GearInstance + 分解/重铸）
4. **引入地图与解锁**（MapRegion + ConditionDSL）

按此路线演进，项目将从"战斗原型"升级为"可玩的放置RPG"，并为后续社交、赛季等高级功能打下坚实基础。
