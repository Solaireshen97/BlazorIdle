# 商店系统配置指南

**项目**: BlazorIdle  
**文档版本**: 1.0  
**创建日期**: 2025-10-12  
**状态**: Phase 2 配置化完成  

---

## 📋 概述

本文档说明如何配置和调优商店系统。商店系统的配置参数已从代码中分离到配置文件中，便于运维和调整。

---

## 配置文件

### appsettings.json

商店系统的配置位于 `Shop` 节点下：

```json
{
  "Shop": {
    "EnablePurchaseLimit": true,
    "DailyResetSeconds": 86400,
    "WeeklyResetSeconds": 604800,
    "DefaultCacheMinutes": 5,
    "CleanupSchedule": "0 0 * * *",
    "DefaultHistoryPageSize": 20,
    "MaxHistoryPageSize": 100
  }
}
```

---

## 配置项详解

### 1. EnablePurchaseLimit

- **类型**: `bool`
- **默认值**: `true`
- **说明**: 是否启用购买限制功能
- **用途**: 控制是否启用商品的购买次数限制（每日限购、终生限购等）

**示例**:
```json
"EnablePurchaseLimit": true  // 启用购买限制
```

### 2. DailyResetSeconds

- **类型**: `int`
- **默认值**: `86400` (24小时)
- **说明**: 每日限购的重置周期（秒）
- **用途**: 控制每日限购商品的重置时间间隔

**示例**:
```json
"DailyResetSeconds": 86400  // 每24小时重置一次
```

**建议值**:
- 标准每日重置: `86400` (24小时)
- 测试环境快速重置: `300` (5分钟)
- 自定义重置周期: 按需设置

### 3. WeeklyResetSeconds

- **类型**: `int`
- **默认值**: `604800` (7天)
- **说明**: 每周限购的重置周期（秒）
- **用途**: 控制每周限购商品的重置时间间隔

**示例**:
```json
"WeeklyResetSeconds": 604800  // 每7天重置一次
```

**建议值**:
- 标准每周重置: `604800` (7天)
- 测试环境: `3600` (1小时)

### 4. DefaultCacheMinutes

- **类型**: `int`
- **默认值**: `5`
- **说明**: 默认缓存时间（分钟）
- **用途**: 预留用于未来的商店数据缓存优化

**示例**:
```json
"DefaultCacheMinutes": 5  // 缓存5分钟
```

### 5. CleanupSchedule

- **类型**: `string`
- **默认值**: `"0 0 * * *"`
- **说明**: 清理过期购买计数器的计划任务 Cron 表达式
- **用途**: 定期清理过期的购买限制计数器，释放存储空间

**Cron 表达式格式**: `分 时 日 月 周`

**示例**:
```json
"CleanupSchedule": "0 0 * * *"  // 每天凌晨0点执行清理
```

**常用 Cron 表达式**:
- 每天凌晨: `"0 0 * * *"`
- 每天凌晨3点: `"0 3 * * *"`
- 每周日凌晨: `"0 0 * * 0"`
- 每小时: `"0 * * * *"`

### 6. DefaultHistoryPageSize

- **类型**: `int`
- **默认值**: `20`
- **说明**: 购买历史查询的默认页大小
- **用途**: 当客户端未指定页大小时使用的默认值

**示例**:
```json
"DefaultHistoryPageSize": 20  // 默认每页20条记录
```

### 7. MaxHistoryPageSize

- **类型**: `int`
- **默认值**: `100`
- **说明**: 购买历史查询的最大页大小
- **用途**: 限制单次查询的最大记录数，防止性能问题

**示例**:
```json
"MaxHistoryPageSize": 100  // 最多一次查询100条记录
```

---

## 环境特定配置

### 开发环境 (appsettings.Development.json)

```json
{
  "Shop": {
    "EnablePurchaseLimit": true,
    "DailyResetSeconds": 300,      // 5分钟，方便测试
    "WeeklyResetSeconds": 600,     // 10分钟，方便测试
    "DefaultCacheMinutes": 1,      // 1分钟缓存
    "CleanupSchedule": "*/5 * * * *",  // 每5分钟清理一次
    "DefaultHistoryPageSize": 10,
    "MaxHistoryPageSize": 50
  }
}
```

### 生产环境 (appsettings.Production.json)

```json
{
  "Shop": {
    "EnablePurchaseLimit": true,
    "DailyResetSeconds": 86400,
    "WeeklyResetSeconds": 604800,
    "DefaultCacheMinutes": 5,
    "CleanupSchedule": "0 2 * * *",  // 每天凌晨2点清理
    "DefaultHistoryPageSize": 20,
    "MaxHistoryPageSize": 100
  }
}
```

---

## 配置验证

### 自动验证

系统在启动时会自动验证配置的有效性：

- `DailyResetSeconds` 必须大于 0
- `WeeklyResetSeconds` 必须大于 0
- `DefaultCacheMinutes` 必须大于等于 0
- `DefaultHistoryPageSize` 必须大于 0
- `MaxHistoryPageSize` 必须大于等于 `DefaultHistoryPageSize`

### 手动验证

可以通过以下代码手动验证配置：

```csharp
var options = new ShopOptions
{
    // ... 设置配置值
};

if (!options.IsValid())
{
    throw new InvalidOperationException("商店系统配置无效");
}
```

---

## 最佳实践

### 1. 生产部署前检查清单

- [ ] 确认 `EnablePurchaseLimit` 已正确设置
- [ ] 验证 `DailyResetSeconds` 和 `WeeklyResetSeconds` 符合业务需求
- [ ] 检查 `CleanupSchedule` 设置在低峰时段
- [ ] 确认 `MaxHistoryPageSize` 不会导致性能问题
- [ ] 测试配置在各个环境中的表现

### 2. 性能建议

根据玩家数量和服务器性能调整配置：

| 玩家数量 | DefaultHistoryPageSize | MaxHistoryPageSize | DefaultCacheMinutes |
|---------|------------------------|-------------------|-------------------|
| < 100   | 20                     | 50                | 5                 |
| 100-500 | 20                     | 100               | 10                |
| 500-1000| 15                     | 100               | 15                |
| > 1000  | 10                     | 50                | 20                |

### 3. 监控指标

建议监控以下指标：

- 购买历史查询平均响应时间
- 购买计数器重置频率
- 清理任务执行时间
- 配置热更新成功率

### 4. 故障排查

#### 问题：购买限制未生效

**可能原因**:
- `EnablePurchaseLimit` 设置为 `false`
- `DailyResetSeconds` 或 `WeeklyResetSeconds` 设置不正确

**解决方案**:
1. 检查配置文件中的 `EnablePurchaseLimit` 值
2. 验证重置周期是否符合预期
3. 检查购买计数器表中的数据

#### 问题：清理任务未执行

**可能原因**:
- Cron 表达式格式错误
- 清理服务未启动

**解决方案**:
1. 验证 `CleanupSchedule` 的 Cron 表达式格式
2. 检查后台服务日志
3. 手动触发清理任务测试

---

## 配置更新流程

### 1. 修改配置文件

编辑 `appsettings.json` 或对应环境的配置文件。

### 2. 重启应用

配置更改需要重启应用才能生效。未来可能支持热更新。

### 3. 验证配置

通过 API 或日志验证新配置是否生效。

---

## 相关文档

- [商店系统设计方案（上）](./商店系统设计方案（上）.md)
- [商店系统设计方案（下）](./商店系统设计方案（下）.md)
- [商店系统实施进度](./商店系统实施进度.md)
- [商店系统Phase1完成报告](./商店系统Phase1完成报告.md)

---

## 变更历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 1.0  | 2025-10-12 | 初始版本，完成配置化改造 |

---

**维护**: 开发团队  
**最后更新**: 2025-10-12
