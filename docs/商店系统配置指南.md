# 商店系统配置指南

**项目**: BlazorIdle  
**版本**: 1.0  
**更新日期**: 2025-10-13

---

## 📋 目录

1. [概述](#概述)
2. [配置文件位置](#配置文件位置)
3. [appsettings.json 配置](#appsettingsjson-配置)
4. [商店定义配置](#商店定义配置)
5. [商品配置](#商品配置)
6. [配置验证规则](#配置验证规则)
7. [常见配置场景](#常见配置场景)
8. [故障排除](#故障排除)

---

## 概述

商店系统采用配置驱动架构，所有参数都可以通过配置文件进行调整，无需修改代码。配置分为三个层次：

1. **系统参数配置**：`appsettings.json` 中的 `Shop` 节
2. **商店定义配置**：`Config/Shop/ShopDefinitions.json`
3. **商品配置**：`Config/Shop/ShopItems.json`

---

## 配置文件位置

```
BlazorIdle.Server/
├── appsettings.json              # 系统参数配置
├── appsettings.Development.json  # 开发环境配置（可选）
├── appsettings.Production.json   # 生产环境配置（可选）
└── Config/Shop/
    ├── ShopDefinitions.json      # 商店定义
    └── ShopItems.json            # 商品数据
```

---

## appsettings.json 配置

### 完整配置示例

```json
{
  "Shop": {
    // 缓存配置
    "EnableCaching": true,
    "ShopDefinitionCacheMinutes": 60,
    "ShopItemsCacheMinutes": 30,
    
    // 文件路径配置
    "ConfigPath": "Config/Shop",
    "ShopDefinitionsFile": "ShopDefinitions.json",
    "ShopItemsFile": "ShopItems.json",
    
    // 商店配置
    "DefaultRefreshIntervalSeconds": 3600,
    "MaxShopNameLength": 50,
    "MaxShopDescriptionLength": 200,
    
    // 商品配置
    "MaxItemNameLength": 100,
    "MaxItemDescriptionLength": 500,
    "UnlimitedStock": -1,
    
    // 购买限制配置
    "DailyResetSeconds": 86400,
    "WeeklyResetSeconds": 604800,
    "DefaultDailyLimit": 10,
    "DefaultWeeklyLimit": 5,
    
    // 价格配置
    "MinPriceAmount": 1,
    "MaxPriceAmount": 1000000,
    
    // 验证配置
    "MinLevelRequirement": 1,
    "MaxLevelRequirement": 100,
    "MinPurchaseQuantity": 1,
    "MaxPurchaseQuantity": 999,
    
    // 查询配置
    "DefaultPageSize": 20,
    "MaxPageSize": 100,
    "PurchaseHistoryDefaultDays": 30
  }
}
```

### 配置参数说明

#### 缓存配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| EnableCaching | bool | true | 是否启用缓存功能 |
| ShopDefinitionCacheMinutes | int | 60 | 商店定义缓存时间（分钟） |
| ShopItemsCacheMinutes | int | 30 | 商品列表缓存时间（分钟） |

**使用建议**：
- 开发环境：可设置较短缓存时间或禁用缓存
- 生产环境：启用缓存以提升性能

#### 文件路径配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| ConfigPath | string | "Config/Shop" | 配置文件目录路径 |
| ShopDefinitionsFile | string | "ShopDefinitions.json" | 商店定义文件名 |
| ShopItemsFile | string | "ShopItems.json" | 商品配置文件名 |

**注意事项**：
- 路径相对于应用程序根目录
- 文件必须存在，否则使用空配置

#### 商店配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| DefaultRefreshIntervalSeconds | int | 3600 | 默认刷新间隔（秒） |
| MaxShopNameLength | int | 50 | 商店名称最大长度 |
| MaxShopDescriptionLength | int | 200 | 商店描述最大长度 |

#### 商品配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| MaxItemNameLength | int | 100 | 商品名称最大长度 |
| MaxItemDescriptionLength | int | 500 | 商品描述最大长度 |
| UnlimitedStock | int | -1 | 无限库存标识值 |

#### 购买限制配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| DailyResetSeconds | int | 86400 | 每日重置周期（秒，24小时） |
| WeeklyResetSeconds | int | 604800 | 每周重置周期（秒，7天） |
| DefaultDailyLimit | int | 10 | 默认每日购买限制 |
| DefaultWeeklyLimit | int | 5 | 默认每周购买限制 |

#### 价格配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| MinPriceAmount | int | 1 | 最小价格金额 |
| MaxPriceAmount | int | 1000000 | 最大价格金额 |

#### 验证配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| MinLevelRequirement | int | 1 | 最小等级要求 |
| MaxLevelRequirement | int | 100 | 最大等级要求 |
| MinPurchaseQuantity | int | 1 | 最小购买数量 |
| MaxPurchaseQuantity | int | 999 | 最大购买数量（单次） |

#### 查询配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| DefaultPageSize | int | 20 | 默认分页大小 |
| MaxPageSize | int | 100 | 最大分页大小 |
| PurchaseHistoryDefaultDays | int | 30 | 购买历史默认查询天数 |

---

## 商店定义配置

### 文件位置
`Config/Shop/ShopDefinitions.json`

### 配置格式

```json
{
  "shops": [
    {
      "id": "general_shop",
      "name": "杂货铺",
      "type": "General",
      "icon": "🏪",
      "description": "出售各类日常消耗品和基础装备",
      "unlockCondition": null,
      "isEnabled": true,
      "sortOrder": 1
    }
  ]
}
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | 是 | 商店唯一标识符 |
| name | string | 是 | 商店显示名称 |
| type | string | 是 | 商店类型（General, Special, Event） |
| icon | string | 否 | 商店图标（支持 emoji） |
| description | string | 否 | 商店描述 |
| unlockCondition | string | 否 | 解锁条件表达式（如 "level>=10"） |
| isEnabled | bool | 是 | 是否启用 |
| sortOrder | int | 是 | 排序顺序 |

### 商店类型说明

- **General**：普通商店，面向所有玩家
- **Special**：特殊商店，通常有解锁条件
- **Event**：活动商店，限时开放

---

## 商品配置

### 文件位置
`Config/Shop/ShopItems.json`

### 配置格式

```json
{
  "items": [
    {
      "id": "health_potion",
      "shopId": "general_shop",
      "itemDefinitionId": "health_potion_def",
      "itemName": "生命药水",
      "itemIcon": "🧪",
      "itemDescription": "恢复 100 点生命值",
      "category": "Consumable",
      "rarity": "Common",
      "price": {
        "currencyType": "Gold",
        "amount": 50
      },
      "purchaseLimit": {
        "type": "Daily",
        "maxPurchases": 10,
        "resetPeriodSeconds": null
      },
      "stockQuantity": -1,
      "minLevel": 1,
      "isEnabled": true,
      "sortOrder": 1
    }
  ]
}
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | 是 | 商品唯一标识符 |
| shopId | string | 是 | 所属商店 ID |
| itemDefinitionId | string | 是 | 物品定义 ID |
| itemName | string | 是 | 商品显示名称 |
| itemIcon | string | 否 | 商品图标 |
| itemDescription | string | 否 | 商品描述 |
| category | string | 否 | 商品类别 |
| rarity | string | 否 | 稀有度 |
| price | object | 是 | 价格信息 |
| purchaseLimit | object | 否 | 购买限制 |
| stockQuantity | int | 是 | 库存数量（-1 为无限） |
| minLevel | int | 是 | 最低等级要求 |
| isEnabled | bool | 是 | 是否启用 |
| sortOrder | int | 是 | 排序顺序 |

### 商品类别

- **Consumable**：消耗品（药水、食物等）
- **Equipment**：装备
- **Material**：材料
- **Special**：特殊物品

### 稀有度等级

- **Common**：普通（白色）
- **Uncommon**：非凡（绿色）
- **Rare**：稀有（蓝色）
- **Epic**：史诗（紫色）
- **Legendary**：传说（橙色）

### 价格配置

```json
"price": {
  "currencyType": "Gold",  // 货币类型：Gold 或 Item
  "amount": 100            // 价格数量
}
```

### 购买限制配置

```json
"purchaseLimit": {
  "type": "Daily",              // 限制类型：Unlimited, Daily, Weekly, CustomPeriod
  "maxPurchases": 10,           // 最大购买次数
  "resetPeriodSeconds": null    // 自定义重置周期（仅 CustomPeriod 类型需要）
}
```

限制类型说明：
- **Unlimited**：无限制
- **Daily**：每日限制
- **Weekly**：每周限制
- **CustomPeriod**：自定义周期

---

## 配置验证规则

系统启动时会自动验证配置的有效性，确保所有参数符合要求。

### 验证规则列表

1. ✅ 缓存时间至少 1 分钟
2. ✅ 配置路径不能为空
3. ✅ 文件名不能为空
4. ✅ 刷新间隔至少 60 秒
5. ✅ 名称长度限制在 1-1000 之间
6. ✅ 每日重置时间至少 1 小时
7. ✅ 每周重置时间至少 1 天
8. ✅ 价格最大值必须大于最小值
9. ✅ 等级要求至少为 1
10. ✅ 最大等级必须大于最小等级
11. ✅ 购买数量至少为 1
12. ✅ 最大购买数量必须大于最小购买数量
13. ✅ 分页大小在合理范围
14. ✅ 最大分页大小不超过 1000
15. ✅ 历史查询天数至少 1 天

### 验证失败处理

如果配置验证失败，应用程序将：
1. 记录详细的错误日志
2. 抛出 `InvalidOperationException` 异常
3. 阻止应用程序启动

**建议**：在开发环境中及早验证配置，避免生产环境部署失败。

---

## 常见配置场景

### 场景 1：开发环境配置

**目标**：快速测试，禁用缓存

`appsettings.Development.json`:
```json
{
  "Shop": {
    "EnableCaching": false,
    "ShopDefinitionCacheMinutes": 1,
    "ShopItemsCacheMinutes": 1
  }
}
```

### 场景 2：生产环境配置

**目标**：高性能，长缓存时间

`appsettings.Production.json`:
```json
{
  "Shop": {
    "EnableCaching": true,
    "ShopDefinitionCacheMinutes": 120,
    "ShopItemsCacheMinutes": 60
  }
}
```

### 场景 3：活动商店配置

**目标**：限时活动商店

`ShopDefinitions.json`:
```json
{
  "id": "event_shop",
  "name": "限时活动商店",
  "type": "Event",
  "icon": "🎉",
  "description": "活动期间专属商店",
  "unlockCondition": null,
  "isEnabled": true,
  "sortOrder": 1
}
```

### 场景 4：限购商品配置

**目标**：每日限购 5 次的稀有物品

`ShopItems.json`:
```json
{
  "id": "rare_item",
  "itemName": "稀有材料",
  "rarity": "Rare",
  "purchaseLimit": {
    "type": "Daily",
    "maxPurchases": 5,
    "resetPeriodSeconds": null
  },
  "stockQuantity": -1
}
```

### 场景 5：高等级解锁商店

**目标**：20 级解锁的高级商店

`ShopDefinitions.json`:
```json
{
  "id": "advanced_shop",
  "name": "高级商店",
  "type": "Special",
  "unlockCondition": "level>=20",
  "isEnabled": true
}
```

---

## 故障排除

### 问题 1：配置文件未找到

**错误信息**：
```
Shop definitions file not found at {FilePath}, returning empty config
```

**解决方案**：
1. 检查文件是否存在于 `Config/Shop` 目录
2. 确认 `.csproj` 文件中有文件复制规则：
   ```xml
   <ItemGroup>
     <None Update="Config\Shop\*.json">
       <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
     </None>
   </ItemGroup>
   ```
3. 重新构建项目

### 问题 2：JSON 解析错误

**错误信息**：
```
JSON parsing error in shop definitions file. Check for syntax errors at line X, position Y
```

**解决方案**：
1. 使用 JSON 验证工具检查语法
2. 检查是否有多余的逗号
3. 确认所有字符串都用双引号
4. 验证 JSON 结构完整

### 问题 3：配置验证失败

**错误信息**：
```
Shop configuration validation failed: MaxPriceAmount must be greater than MinPriceAmount
```

**解决方案**：
1. 检查 `appsettings.json` 中的配置值
2. 确保所有参数符合验证规则
3. 参考本文档的[配置验证规则](#配置验证规则)章节

### 问题 4：缓存未生效

**症状**：每次查询都访问数据库

**检查项**：
1. 确认 `EnableCaching` 为 `true`
2. 检查缓存时间配置是否合理
3. 查看日志确认缓存是否正常工作

### 问题 5：商品不显示

**检查项**：
1. 确认商品的 `isEnabled` 为 `true`
2. 确认商店的 `isEnabled` 为 `true`
3. 检查商品的 `shopId` 是否与商店的 `id` 匹配
4. 验证角色等级是否满足 `minLevel` 要求
5. 检查商店的 `unlockCondition` 是否满足

---

## 最佳实践

### 1. 配置管理

- ✅ 使用版本控制管理配置文件
- ✅ 为不同环境准备不同的配置文件
- ✅ 在部署前验证配置文件的 JSON 语法
- ✅ 定期备份配置文件

### 2. 性能优化

- ✅ 生产环境启用缓存
- ✅ 根据数据更新频率调整缓存时间
- ✅ 使用合理的分页大小
- ✅ 避免设置过大的查询限制

### 3. 安全考虑

- ✅ 设置合理的价格上限
- ✅ 限制单次购买数量
- ✅ 使用购买限制防止刷商店
- ✅ 定期审计配置变更

### 4. 维护建议

- ✅ 保持配置文件结构清晰
- ✅ 为复杂配置添加注释（JSON5 格式）
- ✅ 测试配置变更后再部署
- ✅ 监控系统日志发现配置问题

---

## 附录

### A. 配置模板

完整的配置模板可以在以下位置找到：
- `Config/Shop/ShopDefinitions.json`
- `Config/Shop/ShopItems.json`

### B. 相关文档

- [商店系统Phase2优化进度.md](./商店系统Phase2优化进度.md) - 实施进度
- [商店系统Phase3优化完成报告.md](./商店系统Phase3优化完成报告.md) - 代码质量优化
- [商店系统设计方案（上）.md](./商店系统设计方案（上）.md) - 系统设计

### C. 支持与反馈

如有配置相关问题，请：
1. 查看系统日志获取详细错误信息
2. 参考本文档的故障排除章节
3. 查阅相关设计文档
4. 联系开发团队获取支持

---

**文档版本**: 1.0  
**最后更新**: 2025-10-13  
**维护者**: 开发团队
