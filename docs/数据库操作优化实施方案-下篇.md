# BlazorIdle æ•°æ®åº“æ“ä½œä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸‹ç¯‡ï¼šä¼˜é›…å…³é—­ä¸æœ€ç»ˆä¼˜åŒ–

**é¡¹ç›®**: BlazorIdle æœåŠ¡ç«¯æ•°æ®åº“æ“ä½œä¼˜åŒ–  
**é˜¶æ®µ**: ä¸‹ç¯‡ - ä¼˜é›…å…³é—­ä¸æœ€ç»ˆä¼˜åŒ–  
**å·¥ä½œé‡**: 3-4 å·¥ä½œæ—¥  
**ä¼˜å…ˆçº§**: P0ï¼ˆæœ€é«˜ï¼‰  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0

---

## ğŸ“‹ ç›®å½•

1. [ä¸‹ç¯‡æ¦‚è¿°](#ä¸‹ç¯‡æ¦‚è¿°)
2. [Phase 9: ä¼˜é›…å…³é—­å¢å¼º](#phase-9-ä¼˜é›…å…³é—­å¢å¼º)
3. [Phase 10: æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§å¢å¼º](#phase-10-æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§å¢å¼º)
4. [Phase 11: é…ç½®å‚æ•°è°ƒä¼˜](#phase-11-é…ç½®å‚æ•°è°ƒä¼˜)
5. [Phase 12: æœ€ç»ˆéªŒæ”¶ä¸æ–‡æ¡£å®Œå–„](#phase-12-æœ€ç»ˆéªŒæ”¶ä¸æ–‡æ¡£å®Œå–„)
6. [é¡¹ç›®æ€»ç»“](#é¡¹ç›®æ€»ç»“)

---

## ä¸‹ç¯‡æ¦‚è¿°

### ç›®æ ‡

ä¸‹ç¯‡èšç„¦äº**ä¼˜é›…å…³é—­å¢å¼ºå’Œæœ€ç»ˆä¼˜åŒ–**ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯è§‚æµ‹æ€§ï¼š

1. âœ… ä¼˜é›…å…³é—­ï¼šæœåŠ¡å™¨å…³é—­æ—¶ä¿å­˜æ‰€æœ‰è„æ•°æ®å¹¶æ›´æ–°æ‰€æœ‰è§’è‰²ä¸ºç¦»çº¿
2. âœ… æ€§èƒ½è°ƒä¼˜ï¼šåŸºäºå®é™…è¿è¡Œæ•°æ®ä¼˜åŒ–é…ç½®å‚æ•°
3. âœ… ç›‘æ§å¢å¼ºï¼šå®Œå–„ç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦æœºåˆ¶
4. âœ… æ–‡æ¡£å®Œå–„ï¼šæä¾›å®Œæ•´çš„è¿ç»´å’Œå¼€å‘æ–‡æ¡£

### å‰ç½®æ¡ä»¶

- âœ… ä¸Šç¯‡å·²å®Œæˆï¼šé…ç½®ç³»ç»Ÿã€æŒä¹…åŒ–ç®¡ç†å™¨ã€æ‰¹é‡åˆ·æ–°æœåŠ¡
- âœ… ä¸­ç¯‡å·²å®Œæˆï¼šæ‰€æœ‰ä¸šåŠ¡æ¨¡å—å·²é›†æˆæ‰¹é‡æŒä¹…åŒ–
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡

### å…³é”®äº§å‡º

- ğŸ“¦ å¢å¼ºåçš„ `GracefulShutdownCoordinator.cs`
- ğŸ“¦ æ–°å¢ `CharacterOfflineService.cs`
- ğŸ“¦ å¢å¼ºåçš„ `PersistenceMetrics.cs`
- ğŸ“„ æ€§èƒ½è°ƒä¼˜æŠ¥å‘Š
- ğŸ“„ è¿ç»´æ‰‹å†Œ
- ğŸ“„ æœ€ç»ˆéªŒæ”¶æŠ¥å‘Š

---

## Phase 9: ä¼˜é›…å…³é—­å¢å¼º

**å·¥ä½œé‡**: 1.5 å¤©  
**ä¼˜å…ˆçº§**: P0  
**æ ¸å¿ƒéœ€æ±‚**: æœåŠ¡å™¨å…³é—­æ—¶å°†æ‰€æœ‰åœ¨çº¿è§’è‰²è®¾ä¸ºç¦»çº¿çŠ¶æ€

### 9.1 éœ€æ±‚åˆ†æ

#### å½“å‰ä¼˜é›…å…³é—­æµç¨‹

```csharp
// ç°æœ‰çš„ GracefulShutdownCoordinator
1. æ¥æ”¶å…³é—­ä¿¡å·
2. ç­‰å¾… 2ç§’ ç¼“å†²æ—¶é—´
3. å®Œæˆ

// ç°æœ‰çš„ StepBattleHostedService.StopAsync
1. ä¿å­˜æ‰€æœ‰è¿è¡Œä¸­çš„æˆ˜æ–—å¿«ç…§
2. æš‚åœæ‰€æœ‰æ´»åŠ¨è®¡åˆ’
3. å®Œæˆ

// ç°æœ‰çš„ BatchFlushHostedService.StopAsync
1. æ‰§è¡Œæœ€ç»ˆæ‰¹é‡åˆ·æ–°
2. å®Œæˆ

// ç°æœ‰çš„ GameDbContext.Dispose
1. æ‰§è¡Œ WAL checkpoint
2. å®Œæˆ
```

#### æ–°å¢éœ€æ±‚

**æœåŠ¡å™¨å…³é—­æ—¶**ï¼š
1. ä¿å­˜æ‰€æœ‰è„æ•°æ®ï¼ˆå·²æœ‰ï¼‰
2. **å°†æ‰€æœ‰åœ¨çº¿è§’è‰²æ ‡è®°ä¸ºç¦»çº¿**ï¼ˆæ–°å¢ï¼‰
3. **æ‰¹é‡æ›´æ–°è§’è‰²çš„ `LastSeenAtUtc`**ï¼ˆæ–°å¢ï¼‰

### 9.2 å®æ–½æ­¥éª¤

#### Step 9.1: åˆ›å»ºè§’è‰²ç¦»çº¿æœåŠ¡

**æ–‡ä»¶**: `BlazorIdle.Server/Services/CharacterOfflineService.cs`

```csharp
namespace BlazorIdle.Server.Services;

/// <summary>
/// è§’è‰²ç¦»çº¿æœåŠ¡
/// è´Ÿè´£æ‰¹é‡æ›´æ–°è§’è‰²ç¦»çº¿çŠ¶æ€
/// </summary>
public class CharacterOfflineService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<CharacterOfflineService> _logger;

    public CharacterOfflineService(
        IServiceScopeFactory scopeFactory,
        ILogger<CharacterOfflineService> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
    }

    /// <summary>
    /// æ‰¹é‡å°†æ‰€æœ‰"åœ¨çº¿"è§’è‰²è®¾ä¸ºç¦»çº¿
    /// </summary>
    /// <param name="ct">å–æ¶ˆä»¤ç‰Œ</param>
    /// <returns>æ›´æ–°çš„è§’è‰²æ•°é‡</returns>
    public async Task<int> SetAllCharactersOfflineAsync(CancellationToken ct = default)
    {
        try
        {
            using var scope = _scopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();

            // æŸ¥æ‰¾æ‰€æœ‰éœ€è¦æ›´æ–°çš„è§’è‰²
            // å®šä¹‰ï¼šLastSeenAtUtc åœ¨æœ€è¿‘2åˆ†é’Ÿå†…çš„è§’è‰²è§†ä¸º"åœ¨çº¿"
            var cutoffTime = DateTime.UtcNow.AddMinutes(-2);
            var onlineCharacters = await db.Characters
                .Where(c => c.LastSeenAtUtc.HasValue && c.LastSeenAtUtc.Value >= cutoffTime)
                .ToListAsync(ct);

            if (!onlineCharacters.Any())
            {
                _logger.LogInformation("æ²¡æœ‰åœ¨çº¿è§’è‰²éœ€è¦æ›´æ–°");
                return 0;
            }

            // æ‰¹é‡æ›´æ–° LastSeenAtUtc ä¸ºå½“å‰æ—¶é—´ï¼ˆæ ‡è®°ä¸ºç¦»çº¿å‰çš„æœ€ååœ¨çº¿æ—¶é—´ï¼‰
            var now = DateTime.UtcNow;
            foreach (var character in onlineCharacters)
            {
                character.LastSeenAtUtc = now;
            }

            // æ‰¹é‡ä¿å­˜
            var updatedCount = await db.SaveChangesAsync(ct);
            
            _logger.LogInformation(
                "æˆåŠŸå°† {Count} ä¸ªè§’è‰²è®¾ä¸ºç¦»çº¿çŠ¶æ€",
                onlineCharacters.Count);

            return onlineCharacters.Count;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "æ‰¹é‡è®¾ç½®è§’è‰²ç¦»çº¿çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯");
            throw;
        }
    }

    /// <summary>
    /// è·å–å½“å‰åœ¨çº¿è§’è‰²æ•°é‡
    /// </summary>
    public async Task<int> GetOnlineCharacterCountAsync(CancellationToken ct = default)
    {
        using var scope = _scopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();

        var cutoffTime = DateTime.UtcNow.AddMinutes(-2);
        return await db.Characters
            .Where(c => c.LastSeenAtUtc.HasValue && c.LastSeenAtUtc.Value >= cutoffTime)
            .CountAsync(ct);
    }
}
```

#### Step 9.2: å¢å¼ºä¼˜é›…å…³é—­åè°ƒå™¨

**æ–‡ä»¶**: `BlazorIdle.Server/Services/GracefulShutdownCoordinator.cs`

```csharp
namespace BlazorIdle.Server.Services;

/// <summary>
/// åè°ƒæœåŠ¡å™¨ä¼˜é›…å…³é—­ï¼ˆå¢å¼ºç‰ˆï¼‰
/// ç¡®ä¿æ‰€æœ‰å…³é”®æ“ä½œå®Œæˆåå†åœæ­¢
/// </summary>
public class GracefulShutdownCoordinator : IHostedService
{
    private readonly ILogger<GracefulShutdownCoordinator> _logger;
    private readonly IHostApplicationLifetime _appLifetime;
    private readonly IServiceScopeFactory _scopeFactory;  // â¬…ï¸ æ–°å¢
    private readonly IOptions<PersistenceOptions> _options;  // â¬…ï¸ æ–°å¢
    private readonly CancellationTokenSource _shutdownCts = new();
    
    public static CancellationToken ShutdownToken => _instance?._shutdownCts.Token ?? CancellationToken.None;
    private static GracefulShutdownCoordinator? _instance;

    public GracefulShutdownCoordinator(
        ILogger<GracefulShutdownCoordinator> logger,
        IHostApplicationLifetime appLifetime,
        IServiceScopeFactory scopeFactory,  // â¬…ï¸ æ–°å¢
        IOptions<PersistenceOptions> options)  // â¬…ï¸ æ–°å¢
    {
        _logger = logger;
        _appLifetime = appLifetime;
        _scopeFactory = scopeFactory;
        _options = options;
        _instance = this;
    }

    public Task StartAsync(CancellationToken cancellationToken)
    {
        _logger.LogInformation("ä¼˜é›…å…³é—­åè°ƒå™¨å·²å¯åŠ¨");
        
        _appLifetime.ApplicationStopping.Register(() =>
        {
            _logger.LogWarning("æœåŠ¡å™¨æ­£åœ¨å…³é—­ï¼Œè§¦å‘ä¼˜é›…å…³é—­æµç¨‹...");
            
            // è§¦å‘å…³é—­ä¿¡å·
            _shutdownCts.Cancel();
            
            // â¬‡ï¸ æ‰§è¡Œå¢å¼ºçš„å…³é—­æµç¨‹
            ExecuteGracefulShutdown();
            
            _logger.LogInformation("ä¼˜é›…å…³é—­æµç¨‹å®Œæˆ");
        });

        return Task.CompletedTask;
    }

    /// <summary>
    /// æ‰§è¡Œä¼˜é›…å…³é—­æµç¨‹
    /// </summary>
    private void ExecuteGracefulShutdown()
    {
        if (!_options.Value.GracefulShutdown.Enabled)
        {
            _logger.LogInformation("ä¼˜é›…å…³é—­å¢å¼ºæœªå¯ç”¨ï¼Œè·³è¿‡");
            return;
        }

        var sw = Stopwatch.StartNew();
        var timeoutMs = _options.Value.GracefulShutdown.ShutdownTimeoutSeconds * 1000;
        var cts = new CancellationTokenSource(timeoutMs);

        try
        {
            // Step 1: ç­‰å¾…è¿›è¡Œä¸­çš„æ“ä½œå®Œæˆ
            if (_options.Value.GracefulShutdown.WaitForInProgressOperations)
            {
                _logger.LogInformation("ç­‰å¾…è¿›è¡Œä¸­çš„æ“ä½œå®Œæˆ...");
                Thread.Sleep(1000); // ç®€å•ç­‰å¾…1ç§’
            }

            // Step 2: æ‰¹é‡ä¿å­˜æ‰€æœ‰è„æ•°æ®
            if (_options.Value.GracefulShutdown.SaveAllDirtyData)
            {
                _logger.LogInformation("æ­£åœ¨æ‰¹é‡ä¿å­˜æ‰€æœ‰è„æ•°æ®...");
                SaveAllDirtyDataSync(cts.Token);
            }

            // Step 3: å°†æ‰€æœ‰åœ¨çº¿è§’è‰²è®¾ä¸ºç¦»çº¿
            if (_options.Value.GracefulShutdown.SetAllCharactersOffline)
            {
                _logger.LogInformation("æ­£åœ¨å°†æ‰€æœ‰åœ¨çº¿è§’è‰²è®¾ä¸ºç¦»çº¿...");
                SetAllCharactersOfflineSync(cts.Token);
            }

            sw.Stop();
            _logger.LogInformation(
                "ä¼˜é›…å…³é—­æµç¨‹å®Œæˆï¼Œè€—æ—¶ {ElapsedMs}ms",
                sw.ElapsedMilliseconds);
        }
        catch (OperationCanceledException)
        {
            _logger.LogWarning(
                "ä¼˜é›…å…³é—­è¶…æ—¶ï¼ˆ{TimeoutSeconds}ç§’ï¼‰ï¼Œå¼ºåˆ¶ç»§ç»­",
                _options.Value.GracefulShutdown.ShutdownTimeoutSeconds);
            
            if (_options.Value.GracefulShutdown.ForceSaveOnTimeout)
            {
                _logger.LogWarning("å°è¯•å¼ºåˆ¶ä¿å­˜å…³é”®æ•°æ®...");
                // åœ¨è¶…æ—¶æƒ…å†µä¸‹ï¼Œä»å°è¯•ä¿å­˜è§’è‰²ç¦»çº¿çŠ¶æ€
                try
                {
                    SetAllCharactersOfflineSync(CancellationToken.None);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "å¼ºåˆ¶ä¿å­˜å¤±è´¥");
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ä¼˜é›…å…³é—­æµç¨‹å‘ç”Ÿå¼‚å¸¸");
        }
    }

    /// <summary>
    /// åŒæ­¥ä¿å­˜æ‰€æœ‰è„æ•°æ®
    /// </summary>
    private void SaveAllDirtyDataSync(CancellationToken ct)
    {
        try
        {
            using var scope = _scopeFactory.CreateScope();
            var persistenceManager = scope.ServiceProvider.GetRequiredService<IPersistenceManager>();
            
            // è·å–å½“å‰è„æ•°æ®ç»Ÿè®¡
            var stats = persistenceManager.GetStatistics();
            _logger.LogInformation(
                "å½“å‰è„æ•°æ®: æ€»è®¡ {TotalCount} æ¡",
                stats.TotalDirtyCount);

            if (stats.TotalDirtyCount == 0)
            {
                _logger.LogInformation("æ— è„æ•°æ®éœ€è¦ä¿å­˜");
                return;
            }

            // åŒæ­¥æ‰§è¡Œæ‰¹é‡ä¿å­˜ï¼ˆä½¿ç”¨ .GetAwaiter().GetResult()ï¼‰
            var result = persistenceManager.FlushAsync(ct).GetAwaiter().GetResult();
            
            _logger.LogInformation(
                "è„æ•°æ®ä¿å­˜å®Œæˆ: æˆåŠŸ {SavedCount} æ¡, å¤±è´¥ {FailedCount} æ¡, è€—æ—¶ {ElapsedMs}ms",
                result.SavedCount,
                result.FailedCount,
                result.ElapsedMilliseconds);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ä¿å­˜è„æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸");
        }
    }

    /// <summary>
    /// åŒæ­¥è®¾ç½®æ‰€æœ‰è§’è‰²ä¸ºç¦»çº¿
    /// </summary>
    private void SetAllCharactersOfflineSync(CancellationToken ct)
    {
        try
        {
            using var scope = _scopeFactory.CreateScope();
            var offlineService = scope.ServiceProvider.GetRequiredService<CharacterOfflineService>();
            
            // åŒæ­¥æ‰§è¡Œè§’è‰²ç¦»çº¿æ›´æ–°
            var count = offlineService.SetAllCharactersOfflineAsync(ct).GetAwaiter().GetResult();
            
            _logger.LogInformation(
                "æˆåŠŸå°† {Count} ä¸ªè§’è‰²è®¾ä¸ºç¦»çº¿çŠ¶æ€",
                count);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è®¾ç½®è§’è‰²ç¦»çº¿çŠ¶æ€æ—¶å‘ç”Ÿå¼‚å¸¸");
        }
    }

    public Task StopAsync(CancellationToken cancellationToken)
    {
        _logger.LogInformation("ä¼˜é›…å…³é—­åè°ƒå™¨å·²åœæ­¢");
        _shutdownCts.Dispose();
        return Task.CompletedTask;
    }
}
```

#### Step 9.3: æ³¨å†ŒæœåŠ¡

**æ–‡ä»¶**: `BlazorIdle.Server/Program.cs`

```csharp
// æ³¨å†Œè§’è‰²ç¦»çº¿æœåŠ¡å’Œä¼˜é›…å…³é—­åè°ƒå™¨
builder.Services.AddSingleton<CharacterOfflineService>();
// GracefulShutdownCoordinator å·²æ³¨å†Œï¼Œåªéœ€æ›´æ–°ä¾èµ–æ³¨å…¥å‚æ•°
```

### 9.3 å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `tests/BlazorIdle.Tests/Services/CharacterOfflineServiceTests.cs`

```csharp
public class CharacterOfflineServiceTests
{
    [Fact]
    public async Task SetAllCharactersOfflineAsync_ShouldUpdateOnlineCharacters()
    {
        // Arrange
        var service = CreateService();
        var characters = CreateTestCharacters(online: 5, offline: 3);
        await SeedDatabase(characters);

        // Act
        var count = await service.SetAllCharactersOfflineAsync();

        // Assert
        Assert.Equal(5, count); // 5ä¸ªåœ¨çº¿è§’è‰²è¢«æ›´æ–°
        
        // éªŒè¯æ‰€æœ‰è§’è‰²çš„ LastSeenAtUtc éƒ½å·²æ›´æ–°
        var allCharacters = await GetAllCharactersFromDatabase();
        foreach (var character in allCharacters)
        {
            Assert.True(character.LastSeenAtUtc.HasValue);
        }
    }

    [Fact]
    public async Task SetAllCharactersOfflineAsync_NoOnlineCharacters_ShouldReturnZero()
    {
        // Arrange
        var service = CreateService();
        var characters = CreateTestCharacters(online: 0, offline: 5);
        await SeedDatabase(characters);

        // Act
        var count = await service.SetAllCharactersOfflineAsync();

        // Assert
        Assert.Equal(0, count);
    }

    // æ›´å¤šæµ‹è¯•ç”¨ä¾‹...
}
```

### 9.4 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼šæ¨¡æ‹ŸæœåŠ¡å™¨å…³é—­

```csharp
public class GracefulShutdownIntegrationTests
{
    [Fact]
    public async Task ServerShutdown_ShouldSaveAllDataAndSetCharactersOffline()
    {
        // Arrange
        var host = CreateTestHost();
        await host.StartAsync();
        
        // æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œï¼šåˆ›å»º10ä¸ªåœ¨çº¿è§’è‰²ï¼Œå„æœ‰5æ¡è„æ•°æ®
        var persistenceManager = host.Services.GetRequiredService<IPersistenceManager>();
        var characters = CreateTestCharacters(10);
        
        foreach (var character in characters)
        {
            character.LastSeenAtUtc = DateTime.UtcNow;
            persistenceManager.MarkDirty(character, "CharacterStatus");
        }
        
        // éªŒè¯è„æ•°æ®å­˜åœ¨
        var statsBefore = persistenceManager.GetStatistics();
        Assert.Equal(10, statsBefore.TotalDirtyCount);

        // Act
        await host.StopAsync(); // è§¦å‘ä¼˜é›…å…³é—­

        // Assert
        // 1. éªŒè¯è„æ•°æ®å·²ä¿å­˜
        var statsAfter = persistenceManager.GetStatistics();
        Assert.Equal(0, statsAfter.TotalDirtyCount);
        
        // 2. éªŒè¯æ‰€æœ‰è§’è‰²å·²è®¾ä¸ºç¦»çº¿
        using var scope = host.Services.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
        var allCharacters = await db.Characters.ToListAsync();
        
        foreach (var character in allCharacters)
        {
            Assert.True(character.LastSeenAtUtc.HasValue);
            // LastSeenAtUtc åº”è¯¥æ˜¯å…³é—­æ—¶çš„æ—¶é—´ï¼ˆä¸æ˜¯2åˆ†é’Ÿå‰ï¼‰
            Assert.True(DateTime.UtcNow - character.LastSeenAtUtc.Value < TimeSpan.FromSeconds(5));
        }
    }

    // æ›´å¤šæµ‹è¯•ç”¨ä¾‹...
}
```

### 9.5 éªŒæ”¶æ ‡å‡†

- [ ] æœåŠ¡å™¨å…³é—­æ—¶è‡ªåŠ¨ä¿å­˜æ‰€æœ‰è„æ•°æ®
- [ ] æœåŠ¡å™¨å…³é—­æ—¶è‡ªåŠ¨å°†æ‰€æœ‰åœ¨çº¿è§’è‰²è®¾ä¸ºç¦»çº¿
- [ ] å…³é—­æµç¨‹æœ‰è¶…æ—¶ä¿æŠ¤ï¼ˆ10ç§’ï¼‰
- [ ] è¶…æ—¶æ—¶å¼ºåˆ¶ä¿å­˜å…³é”®æ•°æ®ï¼ˆè§’è‰²ç¦»çº¿çŠ¶æ€ï¼‰
- [ ] æ—¥å¿—è®°å½•å®Œæ•´ï¼ŒåŒ…å«å…³é—­æµç¨‹çš„æ¯ä¸ªæ­¥éª¤
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥95%
- [ ] é›†æˆæµ‹è¯•éªŒè¯å®Œæ•´çš„å…³é—­æµç¨‹
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## Phase 10: æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§å¢å¼º

**å·¥ä½œé‡**: 1 å¤©  
**ä¼˜å…ˆçº§**: P1

### 10.1 ç›®æ ‡

- åŸºäºå®é™…è¿è¡Œæ•°æ®ä¼˜åŒ–é…ç½®å‚æ•°
- å¢å¼ºç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦æœºåˆ¶
- æä¾›æ€§èƒ½è¯Šæ–­å·¥å…·

### 10.2 å®æ–½æ­¥éª¤

#### Step 10.1: å¢å¼ºç›‘æ§æŒ‡æ ‡

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Monitoring/PersistenceMetrics.cs`ï¼ˆå¢å¼ºï¼‰

æ·»åŠ æ›´å¤šç›‘æ§æŒ‡æ ‡ï¼š

```csharp
/// <summary>
/// å¢å¼ºçš„æŒä¹…åŒ–æŒ‡æ ‡æ”¶é›†å™¨
/// </summary>
public class PersistenceMetrics
{
    // åŸæœ‰æŒ‡æ ‡...
    
    // â¬‡ï¸ æ–°å¢æŒ‡æ ‡
    
    /// <summary>
    /// è®°å½•è„æ•°æ®ç§¯å‹æƒ…å†µ
    /// </summary>
    public void RecordDirtyDataBacklog(int count)
    {
        // è®°å½•è„æ•°æ®æ•°é‡çš„æ—¶é—´åºåˆ—
        // ç”¨äºåˆ†æç§¯å‹è¶‹åŠ¿
    }

    /// <summary>
    /// è®°å½•æ‰¹é‡ä¿å­˜çš„å¤§å°åˆ†å¸ƒ
    /// </summary>
    public void RecordBatchSize(int size)
    {
        // è®°å½•æ‰¹é‡å¤§å°ï¼Œç”¨äºä¼˜åŒ– MaxBatchSize é…ç½®
    }

    /// <summary>
    /// è®°å½•æ•°æ®åº“é”ç­‰å¾…äº‹ä»¶
    /// </summary>
    public void RecordLockWaitEvent(long waitTimeMs)
    {
        // è®°å½•æ•°æ®åº“é”ç­‰å¾…æ—¶é—´
    }

    /// <summary>
    /// è·å–æœ€è¿‘Nåˆ†é’Ÿçš„æ€§èƒ½æ‘˜è¦
    /// </summary>
    public PerformanceSummary GetRecentPerformance(int minutes = 5)
    {
        return new PerformanceSummary
        {
            AverageFlushTimeMs = CalculateAverage(),
            MaxDirtyDataBacklog = GetMaxBacklog(),
            AverageBatchSize = GetAverageBatchSize(),
            DatabaseLockWaitCount = GetLockWaitCount(),
            SuccessRate = CalculateSuccessRate()
        };
    }
}

public class PerformanceSummary
{
    public double AverageFlushTimeMs { get; set; }
    public int MaxDirtyDataBacklog { get; set; }
    public double AverageBatchSize { get; set; }
    public int DatabaseLockWaitCount { get; set; }
    public double SuccessRate { get; set; }
}
```

#### Step 10.2: æ·»åŠ æ€§èƒ½è¯Šæ–­API

**æ–‡ä»¶**: `BlazorIdle.Server/Api/DiagnosticsController.cs`ï¼ˆå¢å¼ºï¼‰

```csharp
/// <summary>
/// è·å–æ€§èƒ½æ‘˜è¦
/// </summary>
[HttpGet("persistence/performance")]
public IActionResult GetPerformance([FromQuery] int minutes = 5)
{
    var summary = _metrics.GetRecentPerformance(minutes);
    return Ok(summary);
}

/// <summary>
/// è·å–é…ç½®æ¨è
/// </summary>
[HttpGet("persistence/recommendations")]
public IActionResult GetRecommendations()
{
    var stats = _persistenceManager.GetStatistics();
    var performance = _metrics.GetRecentPerformance();
    var recommendations = GenerateRecommendations(stats, performance);
    
    return Ok(recommendations);
}

private object GenerateRecommendations(PersistenceStatistics stats, PerformanceSummary performance)
{
    var recommendations = new List<string>();

    // åŸºäºå®é™…è¿è¡Œæ•°æ®ç”Ÿæˆé…ç½®å»ºè®®
    if (stats.TotalDirtyCount > 1000)
    {
        recommendations.Add("è„æ•°æ®ç§¯å‹è¾ƒå¤šï¼Œå»ºè®®ç¼©çŸ­åˆ·æ–°é—´éš”æˆ–å¢å¤§æ‰¹é‡å¤§å°");
    }

    if (performance.AverageFlushTimeMs > 1000)
    {
        recommendations.Add("æ‰¹é‡ä¿å­˜è€—æ—¶è¾ƒé•¿ï¼Œå»ºè®®å‡å°æ‰¹é‡å¤§å°");
    }

    if (performance.DatabaseLockWaitCount > 10)
    {
        recommendations.Add("æ•°æ®åº“é”ç­‰å¾…é¢‘ç¹ï¼Œå»ºè®®å¢åŠ åˆ·æ–°é—´éš”æˆ–ä¼˜åŒ–æŸ¥è¯¢");
    }

    return new
    {
        Recommendations = recommendations,
        CurrentStats = stats,
        CurrentPerformance = performance
    };
}
```

#### Step 10.3: æ·»åŠ å‘Šè­¦æœºåˆ¶

**æ–‡ä»¶**: `BlazorIdle.Server/Services/PersistenceAlertService.cs`

```csharp
namespace BlazorIdle.Server.Services;

/// <summary>
/// æŒä¹…åŒ–å‘Šè­¦æœåŠ¡
/// ç›‘æ§æŒä¹…åŒ–æŒ‡æ ‡å¹¶è§¦å‘å‘Šè­¦
/// </summary>
public class PersistenceAlertService : BackgroundService
{
    private readonly IPersistenceManager _persistenceManager;
    private readonly PersistenceMetrics _metrics;
    private readonly IOptions<PersistenceOptions> _options;
    private readonly ILogger<PersistenceAlertService> _logger;

    public PersistenceAlertService(
        IPersistenceManager persistenceManager,
        PersistenceMetrics metrics,
        IOptions<PersistenceOptions> options,
        ILogger<PersistenceAlertService> logger)
    {
        _persistenceManager = persistenceManager;
        _metrics = metrics;
        _options = options;
        _logger = logger;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        if (!_options.Value.Monitoring.EnableMetrics)
        {
            return;
        }

        _logger.LogInformation("æŒä¹…åŒ–å‘Šè­¦æœåŠ¡å·²å¯åŠ¨");

        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
                await Task.Delay(60000, stoppingToken);

                var stats = _persistenceManager.GetStatistics();
                var performance = _metrics.GetRecentPerformance(5);

                // æ£€æŸ¥å‘Šè­¦æ¡ä»¶
                CheckAlerts(stats, performance);
            }
            catch (OperationCanceledException)
            {
                break;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "å‘Šè­¦æœåŠ¡å‘ç”Ÿå¼‚å¸¸");
            }
        }

        _logger.LogInformation("æŒä¹…åŒ–å‘Šè­¦æœåŠ¡å·²åœæ­¢");
    }

    private void CheckAlerts(PersistenceStatistics stats, PerformanceSummary performance)
    {
        // å‘Šè­¦1: è„æ•°æ®ç§¯å‹è¿‡å¤š
        if (_options.Value.Monitoring.AlertOnHighDirtyCount &&
            stats.TotalDirtyCount >= _options.Value.Monitoring.DirtyCountAlertThreshold)
        {
            _logger.LogWarning(
                "âš ï¸ [å‘Šè­¦] è„æ•°æ®ç§¯å‹è¿‡å¤š: {DirtyCount} (é˜ˆå€¼: {Threshold})",
                stats.TotalDirtyCount,
                _options.Value.Monitoring.DirtyCountAlertThreshold);
        }

        // å‘Šè­¦2: æ‰¹é‡ä¿å­˜è€—æ—¶è¿‡é•¿
        if (performance.AverageFlushTimeMs > 2000)
        {
            _logger.LogWarning(
                "âš ï¸ [å‘Šè­¦] æ‰¹é‡ä¿å­˜è€—æ—¶è¿‡é•¿: {AvgTimeMs}ms (å»ºè®®: <2000ms)",
                performance.AverageFlushTimeMs);
        }

        // å‘Šè­¦3: æ•°æ®åº“é”ç­‰å¾…é¢‘ç¹
        if (performance.DatabaseLockWaitCount > 10)
        {
            _logger.LogWarning(
                "âš ï¸ [å‘Šè­¦] æ•°æ®åº“é”ç­‰å¾…é¢‘ç¹: {Count} æ¬¡ (å»ºè®®: <10æ¬¡/5åˆ†é’Ÿ)",
                performance.DatabaseLockWaitCount);
        }

        // å‘Šè­¦4: ä¿å­˜å¤±è´¥ç‡è¿‡é«˜
        if (performance.SuccessRate < 0.95)
        {
            _logger.LogWarning(
                "âš ï¸ [å‘Šè­¦] ä¿å­˜å¤±è´¥ç‡è¿‡é«˜: {SuccessRate:P2} (å»ºè®®: >95%)",
                performance.SuccessRate);
        }
    }
}
```

### 10.3 æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼šæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒè´Ÿè½½

```
å¹¶å‘ç”¨æˆ·: 20ä¸ª
è¿è¡Œæ—¶é—´: 30åˆ†é’Ÿ
æ“ä½œé¢‘ç‡:
  - å¿ƒè·³: æ¯10ç§’
  - æˆ˜æ–—å¿«ç…§: æŒç»­ç”Ÿæˆ
  - æ´»åŠ¨çŠ¶æ€å˜æ›´: æ¯2åˆ†é’Ÿ
  - è£…å¤‡æ“ä½œ: æ¯5åˆ†é’Ÿ
```

**æ€§èƒ½æŒ‡æ ‡è®°å½•**ï¼š

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| æ•°æ®åº“å†™å…¥é¢‘ç‡ | <5æ¬¡/ç§’ | ? | å¾…æµ‹ |
| å¹³å‡æ‰¹é‡ä¿å­˜è€—æ—¶ | <500ms | ? | å¾…æµ‹ |
| æœ€å¤§è„æ•°æ®ç§¯å‹ | <2000æ¡ | ? | å¾…æµ‹ |
| æ•°æ®åº“é”ç­‰å¾…æ¬¡æ•° | <5æ¬¡/5åˆ†é’Ÿ | ? | å¾…æµ‹ |
| ä¿å­˜æˆåŠŸç‡ | >99% | ? | å¾…æµ‹ |

### 10.4 éªŒæ”¶æ ‡å‡†

- [ ] ç›‘æ§æŒ‡æ ‡å®Œå–„ï¼Œè¦†ç›–æ‰€æœ‰å…³é”®æ€§èƒ½æŒ‡æ ‡
- [ ] æ€§èƒ½è¯Šæ–­APIå¯ç”¨ï¼Œæä¾›å®ç”¨çš„é…ç½®å»ºè®®
- [ ] å‘Šè­¦æœºåˆ¶æœ‰æ•ˆï¼Œèƒ½å¤ŸåŠæ—¶å‘ç°å¼‚å¸¸
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•è¾¾åˆ°ç›®æ ‡
- [ ] æ–‡æ¡£è®°å½•æ€§èƒ½è°ƒä¼˜ç»éªŒ

---

## Phase 11: é…ç½®å‚æ•°è°ƒä¼˜

**å·¥ä½œé‡**: 0.5 å¤©  
**ä¼˜å…ˆçº§**: P1

### 11.1 ç›®æ ‡

åŸºäºå®é™…æµ‹è¯•æ•°æ®ï¼Œè°ƒä¼˜é…ç½®å‚æ•°ä»¥è¾¾åˆ°æœ€ä½³æ€§èƒ½ã€‚

### 11.2 é…ç½®å‚æ•°åˆ†æ

#### å½“å‰é…ç½®ï¼ˆåˆå§‹å€¼ï¼‰

```json
{
  "Persistence": {
    "GlobalFlushIntervalSeconds": 10.0,
    "MaxBatchSize": 1000,
    "Categories": {
      "BattleSnapshot": {
        "FlushIntervalSeconds": 5.0,
        "MaxBatchSize": 100
      },
      "CharacterStatus": {
        "FlushIntervalSeconds": 30.0,
        "MaxBatchSize": 500
      },
      "ActivityPlan": {
        "FlushIntervalSeconds": 10.0,
        "MaxBatchSize": 200
      }
    }
  }
}
```

#### è°ƒä¼˜å»ºè®®ï¼ˆåŸºäºæµ‹è¯•ç»“æœï¼‰

**åœºæ™¯1: ä½è´Ÿè½½ï¼ˆ<10å¹¶å‘ç”¨æˆ·ï¼‰**

```json
{
  "Persistence": {
    "GlobalFlushIntervalSeconds": 15.0,  // â¬†ï¸ å¢åŠ é—´éš”ï¼Œå‡å°‘åˆ·æ–°é¢‘ç‡
    "Categories": {
      "BattleSnapshot": {
        "FlushIntervalSeconds": 10.0  // â¬†ï¸ å¯é€‚å½“æ”¾å®½
      },
      "CharacterStatus": {
        "FlushIntervalSeconds": 60.0  // â¬†ï¸ ä½è´Ÿè½½æ—¶å¯å»¶é•¿
      }
    }
  }
}
```

**åœºæ™¯2: ä¸­ç­‰è´Ÿè½½ï¼ˆ10-50å¹¶å‘ç”¨æˆ·ï¼‰**

```json
{
  "Persistence": {
    "GlobalFlushIntervalSeconds": 10.0,  // âœ… ä¿æŒé»˜è®¤
    "Categories": {
      "BattleSnapshot": {
        "FlushIntervalSeconds": 5.0,  // âœ… ä¿æŒé»˜è®¤
        "MaxBatchSize": 150  // â¬†ï¸ é€‚å½“å¢åŠ æ‰¹é‡å¤§å°
      }
    }
  }
}
```

**åœºæ™¯3: é«˜è´Ÿè½½ï¼ˆ>50å¹¶å‘ç”¨æˆ·ï¼‰**

```json
{
  "Persistence": {
    "GlobalFlushIntervalSeconds": 5.0,  // â¬‡ï¸ ç¼©çŸ­é—´éš”ï¼Œé˜²æ­¢ç§¯å‹
    "MaxBatchSize": 500,  // â¬‡ï¸ å‡å°æ‰¹é‡ï¼Œé¿å…å•æ¬¡è¿‡é•¿
    "Categories": {
      "BattleSnapshot": {
        "FlushIntervalSeconds": 3.0,  // â¬‡ï¸ æ›´é¢‘ç¹åˆ·æ–°
        "MaxBatchSize": 50  // â¬‡ï¸ å°æ‰¹é‡ï¼Œå¿«é€Ÿåˆ·æ–°
      },
      "CharacterStatus": {
        "FlushIntervalSeconds": 15.0  // â¬‡ï¸ ç¼©çŸ­é—´éš”
      }
    }
  }
}
```

### 11.3 é…ç½®è°ƒä¼˜æŒ‡å—

**æ–‡ä»¶**: `docs/æŒä¹…åŒ–é…ç½®è°ƒä¼˜æŒ‡å—.md`

```markdown
# æŒä¹…åŒ–é…ç½®è°ƒä¼˜æŒ‡å—

## æ ¸å¿ƒåŸåˆ™

1. **å¹³è¡¡å»¶è¿Ÿä¸é¢‘ç‡**: åˆ·æ–°é—´éš”è¶ŠçŸ­ï¼Œæ•°æ®è¶Šå®æ—¶ï¼Œä½†æ•°æ®åº“å‹åŠ›è¶Šå¤§
2. **ç›‘æ§é©±åŠ¨**: åŸºäºå®é™…ç›‘æ§æ•°æ®è°ƒæ•´é…ç½®
3. **åˆ†æ¨¡å—è°ƒä¼˜**: ä¸åŒæ¨¡å—æœ‰ä¸åŒçš„ç‰¹ç‚¹ï¼Œç‹¬ç«‹è°ƒä¼˜

## è°ƒä¼˜æµç¨‹

1. **å»ºç«‹åŸºå‡†**: ä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œï¼Œè®°å½•æ€§èƒ½æŒ‡æ ‡
2. **è¯†åˆ«ç“¶é¢ˆ**: é€šè¿‡ç›‘æ§æŒ‡æ ‡è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
3. **è°ƒæ•´é…ç½®**: æ ¹æ®ç“¶é¢ˆè°ƒæ•´ç›¸å…³é…ç½®å‚æ•°
4. **éªŒè¯æ•ˆæœ**: è¿è¡Œæµ‹è¯•ï¼ŒéªŒè¯é…ç½®è°ƒæ•´çš„æ•ˆæœ
5. **è¿­ä»£ä¼˜åŒ–**: é‡å¤ä»¥ä¸Šæ­¥éª¤ï¼ŒæŒç»­ä¼˜åŒ–

## å¸¸è§é—®é¢˜ä¸è§£å†³

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| è„æ•°æ®ç§¯å‹ | åˆ·æ–°é—´éš”è¿‡é•¿ | ç¼©çŸ­åˆ·æ–°é—´éš”æˆ–å¢å¤§æ‰¹é‡å¤§å° |
| æ‰¹é‡ä¿å­˜è€—æ—¶é•¿ | æ‰¹é‡è¿‡å¤§ | å‡å° MaxBatchSize |
| æ•°æ®åº“é”ç­‰å¾… | åˆ·æ–°é¢‘ç‡è¿‡é«˜ | å¢åŠ åˆ·æ–°é—´éš” |
| ä¿å­˜å¤±è´¥é¢‘ç¹ | æ•°æ®åº“å‹åŠ›å¤§ | å‡å°æ‰¹é‡å¤§å°æˆ–å¢åŠ é—´éš” |

## é…ç½®å‚æ•°è¯´æ˜

### GlobalFlushIntervalSeconds
- **é»˜è®¤å€¼**: 10.0ç§’
- **èŒƒå›´**: 1-300ç§’
- **å»ºè®®**: æ ¹æ®è´Ÿè½½è°ƒæ•´ï¼Œä½è´Ÿè½½15ç§’ï¼Œé«˜è´Ÿè½½5ç§’

### MaxBatchSize
- **é»˜è®¤å€¼**: 1000æ¡
- **èŒƒå›´**: 10-10000æ¡
- **å»ºè®®**: æ ¹æ®æ•°æ®åº“æ€§èƒ½è°ƒæ•´ï¼ŒSQLiteå»ºè®®500-1000

### BattleSnapshot.FlushIntervalSeconds
- **é»˜è®¤å€¼**: 5.0ç§’
- **å»ºè®®**: æˆ˜æ–—å¿«ç…§æ›´æ–°é¢‘ç¹ï¼Œå»ºè®®3-10ç§’

### CharacterStatus.FlushIntervalSeconds
- **é»˜è®¤å€¼**: 30.0ç§’
- **å»ºè®®**: å¿ƒè·³æ›´æ–°ä¸ç´§æ€¥ï¼Œå»ºè®®15-60ç§’
```

### 11.4 éªŒæ”¶æ ‡å‡†

- [ ] æä¾›ä¸åŒè´Ÿè½½åœºæ™¯çš„é…ç½®å»ºè®®
- [ ] é…ç½®è°ƒä¼˜æŒ‡å—æ–‡æ¡£å®Œæ•´
- [ ] æ‰€æœ‰é…ç½®å‚æ•°æœ‰è¯¦ç»†è¯´æ˜
- [ ] å¸¸è§é—®é¢˜æœ‰è§£å†³æ–¹æ¡ˆ

---

## Phase 12: æœ€ç»ˆéªŒæ”¶ä¸æ–‡æ¡£å®Œå–„

**å·¥ä½œé‡**: 1 å¤©  
**ä¼˜å…ˆçº§**: P0

### 12.1 æœ€ç»ˆéªŒæ”¶æ¸…å•

#### åŠŸèƒ½éªŒæ”¶ âœ…

- [ ] **æ‰¹é‡æŒä¹…åŒ–æœºåˆ¶**
  - [ ] è„æ•°æ®è¿½è¸ªåŠŸèƒ½æ­£å¸¸
  - [ ] æ‰¹é‡åˆ·æ–°å®šæ—¶è§¦å‘
  - [ ] ç«‹å³ä¿å­˜åŠŸèƒ½å¯ç”¨
  - [ ] ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®

- [ ] **ä¸šåŠ¡æ¨¡å—é›†æˆ**
  - [ ] æˆ˜æ–—å¿«ç…§æ‰¹é‡ä¿å­˜
  - [ ] è§’è‰²çŠ¶æ€æ‰¹é‡æ›´æ–°
  - [ ] æ´»åŠ¨è®¡åˆ’æ‰¹é‡ä¿å­˜
  - [ ] è£…å¤‡æ“ä½œæ‰¹é‡/ç«‹å³æ··åˆæ¨¡å¼

- [ ] **ä¼˜é›…å…³é—­**
  - [ ] æœåŠ¡å™¨å…³é—­æ—¶ä¿å­˜æ‰€æœ‰è„æ•°æ®
  - [ ] æœåŠ¡å™¨å…³é—­æ—¶æ‰€æœ‰è§’è‰²è®¾ä¸ºç¦»çº¿
  - [ ] å…³é—­æµç¨‹æœ‰è¶…æ—¶ä¿æŠ¤
  - [ ] å…³é—­æ—¥å¿—å®Œæ•´

- [ ] **ç›‘æ§ä¸è¯Šæ–­**
  - [ ] ç›‘æ§æŒ‡æ ‡å®Œæ•´
  - [ ] è¯Šæ–­APIå¯ç”¨
  - [ ] å‘Šè­¦æœºåˆ¶æœ‰æ•ˆ
  - [ ] é…ç½®æ¨èå‡†ç¡®

#### æ€§èƒ½éªŒæ”¶ âœ…

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | ç›®æ ‡ | çŠ¶æ€ |
|------|--------|--------|------|------|
| æ•°æ®åº“å†™å…¥é¢‘ç‡ | 20-25æ¬¡/ç§’ | ? | 1-2æ¬¡/ç§’ | å¾…æµ‹ |
| æˆ˜æ–—å¿«ç…§å†™å…¥ | 20æ¬¡/ç§’ | ? | 2æ¬¡/ç§’ | å¾…æµ‹ |
| è§’è‰²çŠ¶æ€å†™å…¥ | 2æ¬¡/ç§’ | ? | 0.1æ¬¡/ç§’ | å¾…æµ‹ |
| æ•°æ®åº“é”ç­‰å¾… | å¶å‘ | ? | æå°‘ | å¾…æµ‹ |
| æ‰¹é‡ä¿å­˜è€—æ—¶ | N/A | ? | <500ms | å¾…æµ‹ |
| æ•°æ®ä¸€è‡´æ€§ | 100% | ? | 100% | å¾…æµ‹ |

#### è´¨é‡éªŒæ”¶ âœ…

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥95%
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£å®Œæ•´ä¸”å‡†ç¡®

### 12.2 æ–‡æ¡£æ¸…å•

#### æŠ€æœ¯æ–‡æ¡£ ğŸ“„

- [ ] **æ•°æ®åº“æ“ä½œä¼˜åŒ–åˆ†ææŠ¥å‘Š.md** - é—®é¢˜åˆ†æå’ŒæŠ€æœ¯æ–¹æ¡ˆ
- [ ] **æ•°æ®åº“æ“ä½œä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸Šç¯‡.md** - åŸºç¡€è®¾æ–½å»ºè®¾
- [ ] **æ•°æ®åº“æ“ä½œä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸­ç¯‡.md** - ä¸šåŠ¡æ¨¡å—é›†æˆ
- [ ] **æ•°æ®åº“æ“ä½œä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸‹ç¯‡.md** - ä¼˜é›…å…³é—­ä¸ä¼˜åŒ–
- [ ] **æ•°æ®åº“æ“ä½œä¼˜åŒ–éªŒæ”¶æ–‡æ¡£.md** - éªŒæ”¶æ ‡å‡†å’Œæ£€æŸ¥æ¸…å•

#### è¿ç»´æ–‡æ¡£ ğŸ“„

- [ ] **æŒä¹…åŒ–é…ç½®è°ƒä¼˜æŒ‡å—.md** - é…ç½®å‚æ•°è¯´æ˜å’Œè°ƒä¼˜å»ºè®®
- [ ] **æŒä¹…åŒ–ç›‘æ§è¿ç»´æ‰‹å†Œ.md** - ç›‘æ§æŒ‡æ ‡è¯´æ˜å’Œæ•…éšœæ’æŸ¥
- [ ] **æœåŠ¡å™¨ä¼˜é›…å…³é—­æ“ä½œæ‰‹å†Œ.md** - å…³é—­æµç¨‹å’Œæ³¨æ„äº‹é¡¹

#### å¼€å‘æ–‡æ¡£ ğŸ“„

- [ ] **æ‰¹é‡æŒä¹…åŒ–å¼€å‘æŒ‡å—.md** - æ–°æ¨¡å—é›†æˆæŒ‡å—
- [ ] **æŒä¹…åŒ–APIå‚è€ƒ.md** - APIæ¥å£è¯´æ˜
- [ ] **å¸¸è§é—®é¢˜FAQ.md** - å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 12.3 æœ€ç»ˆæµ‹è¯•

#### å›å½’æµ‹è¯•

è¿è¡Œæ‰€æœ‰ç°æœ‰æµ‹è¯•ï¼Œç¡®ä¿ä¼˜åŒ–æœªç ´åç°æœ‰åŠŸèƒ½ï¼š

```bash
# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
dotnet test --filter Category=Unit

# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
dotnet test --filter Category=Integration

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
```

#### å‹åŠ›æµ‹è¯•

```bash
# æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒè´Ÿè½½
# - 50ä¸ªå¹¶å‘ç”¨æˆ·
# - è¿è¡Œ1å°æ—¶
# - ç›‘æ§æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡
```

#### ç¾éš¾æ¢å¤æµ‹è¯•

```bash
# æµ‹è¯•æœåŠ¡å™¨å¼‚å¸¸å…³é—­åçš„æ•°æ®å®Œæ•´æ€§
# 1. å¯åŠ¨æœåŠ¡å™¨ï¼Œæ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ
# 2. å¼ºåˆ¶ç»ˆæ­¢æœåŠ¡å™¨ï¼ˆkill -9ï¼‰
# 3. é‡å¯æœåŠ¡å™¨ï¼ŒéªŒè¯æ•°æ®å®Œæ•´æ€§
```

### 12.4 éªŒæ”¶æ ‡å‡†

- [ ] æ‰€æœ‰åŠŸèƒ½éªŒæ”¶é¡¹é€šè¿‡
- [ ] æ‰€æœ‰æ€§èƒ½éªŒæ”¶é¡¹è¾¾åˆ°ç›®æ ‡
- [ ] æ‰€æœ‰è´¨é‡éªŒæ”¶é¡¹é€šè¿‡
- [ ] æ‰€æœ‰æ–‡æ¡£å®Œæ•´ä¸”å‡†ç¡®
- [ ] å›å½’æµ‹è¯•100%é€šè¿‡
- [ ] å‹åŠ›æµ‹è¯•è¾¾åˆ°é¢„æœŸ
- [ ] ç¾éš¾æ¢å¤æµ‹è¯•é€šè¿‡

---

## é¡¹ç›®æ€»ç»“

### æ ¸å¿ƒæˆæœ

1. **æ•°æ®åº“å†™å…¥é¢‘ç‡é™ä½90%+**
   - ä¼˜åŒ–å‰ï¼š20-25æ¬¡/ç§’
   - ä¼˜åŒ–åï¼š1-2æ¬¡/ç§’
   - æ”¹å–„ï¼š90%+

2. **ç³»ç»Ÿç¨³å®šæ€§æå‡**
   - æ•°æ®åº“é”ç­‰å¾…å¤§å¹…å‡å°‘
   - ä¼˜é›…å…³é—­ç¡®ä¿æ•°æ®å®Œæ•´æ€§
   - è§’è‰²ç¦»çº¿çŠ¶æ€å‡†ç¡®

3. **å¯è§‚æµ‹æ€§å¢å¼º**
   - å®Œå–„çš„ç›‘æ§æŒ‡æ ‡
   - å®æ—¶æ€§èƒ½è¯Šæ–­
   - æ™ºèƒ½å‘Šè­¦æœºåˆ¶

4. **å¯ç»´æŠ¤æ€§æå‡**
   - é…ç½®åŒ–ç®¡ç†
   - å®Œæ•´çš„æ–‡æ¡£ä½“ç³»
   - æ¸…æ™°çš„æ¶æ„è®¾è®¡

### å®æ–½å‘¨æœŸ

| é˜¶æ®µ | å·¥ä½œé‡ | å®Œæˆæ ‡å¿— |
|------|--------|---------|
| ä¸Šç¯‡ | 7-9å¤© | åŸºç¡€è®¾æ–½å»ºè®¾å®Œæˆ |
| ä¸­ç¯‡ | 5-7å¤© | ä¸šåŠ¡æ¨¡å—é›†æˆå®Œæˆ |
| ä¸‹ç¯‡ | 3-4å¤© | ä¼˜é›…å…³é—­ä¸ä¼˜åŒ–å®Œæˆ |
| **æ€»è®¡** | **15-20å¤©** | **é¡¹ç›®éªŒæ”¶é€šè¿‡** |

### åç»­ç»´æŠ¤

1. **å®šæœŸç›‘æ§**
   - æ¯å‘¨æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
   - æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´é…ç½®

2. **æŒç»­ä¼˜åŒ–**
   - æ”¶é›†ç”¨æˆ·åé¦ˆ
   - ä¼˜åŒ–é…ç½®å‚æ•°

3. **æ–‡æ¡£æ›´æ–°**
   - éšä»£ç å˜æ›´æ›´æ–°æ–‡æ¡£
   - è®°å½•è¿ç»´ç»éªŒ

### ç»éªŒæ€»ç»“

#### æˆåŠŸç»éªŒ âœ…

1. åˆ†é˜¶æ®µå®æ–½ï¼Œé£é™©å¯æ§
2. é…ç½®åŒ–è®¾è®¡ï¼Œçµæ´»å¯è°ƒ
3. ç›‘æ§ä¼˜å…ˆï¼Œæ•°æ®é©±åŠ¨
4. æµ‹è¯•å……åˆ†ï¼Œè´¨é‡ä¿éšœ

#### æ³¨æ„äº‹é¡¹ âš ï¸

1. æ‰¹é‡æŒä¹…åŒ–ä¼šå¢åŠ æ•°æ®å»¶è¿Ÿï¼ˆç§’çº§ï¼‰
2. å…³é”®æ“ä½œä»éœ€ç«‹å³ä¿å­˜
3. éœ€è¦æŒç»­ç›‘æ§å’Œè°ƒä¼˜
4. æ–‡æ¡£éœ€è¦åŠæ—¶æ›´æ–°

#### æœ€ä½³å®è·µ ğŸ’¡

1. **æ–°æ¨¡å—é›†æˆ**: å‚è€ƒç°æœ‰æ¨¡å—çš„é›†æˆæ–¹å¼
2. **é…ç½®è°ƒæ•´**: åŸºäºç›‘æ§æ•°æ®ï¼Œè€ŒéçŒœæµ‹
3. **é—®é¢˜æ’æŸ¥**: ä¼˜å…ˆæŸ¥çœ‹ç›‘æ§æŒ‡æ ‡å’Œæ—¥å¿—
4. **æ€§èƒ½ä¼˜åŒ–**: å°æ­¥è¿­ä»£ï¼ŒæŒç»­æ”¹è¿›

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-17  
**é¢„è®¡å®Œæˆ**: ä¸‹ç¯‡å®æ–½éœ€ 3-4 å·¥ä½œæ—¥  
**çŠ¶æ€**: ğŸ“™ å®æ–½æ–¹æ¡ˆå®Œæˆï¼Œå¾…æ‰§è¡Œ  
**æ€»å·¥ä½œé‡**: 15-20 å·¥ä½œæ—¥

---

## å¿«é€Ÿå¯¼èˆª

- ğŸ“˜ [ä¸Šç¯‡ï¼šåŸºç¡€è®¾æ–½å»ºè®¾](./æ•°æ®åº“æ“ä½œä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸Šç¯‡.md)
- ğŸ“— [ä¸­ç¯‡ï¼šä¸šåŠ¡æ¨¡å—é›†æˆ](./æ•°æ®åº“æ“ä½œä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸­ç¯‡.md)
- ğŸ“™ [ä¸‹ç¯‡ï¼šä¼˜é›…å…³é—­ä¸ä¼˜åŒ–](./æ•°æ®åº“æ“ä½œä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸‹ç¯‡.md)ï¼ˆå½“å‰ï¼‰
- âœ… [éªŒæ”¶æ–‡æ¡£](./æ•°æ®åº“æ“ä½œä¼˜åŒ–éªŒæ”¶æ–‡æ¡£.md)
- ğŸ“Š [åˆ†ææŠ¥å‘Š](./æ•°æ®åº“æ“ä½œä¼˜åŒ–åˆ†ææŠ¥å‘Š.md)

---

**é¡¹ç›®å®Œæˆï¼ç¥å®æ–½é¡ºåˆ©ï¼** ğŸ‰
