# 前端用户角色集成文档

## 概述

本文档说明前端如何集成用户认证和角色管理功能，实现登录用户与角色的绑定、角色列表显示和角色选择切换。

## 已实现功能

### 用户功能
✅ **用户注册和登录**: 通过登录页面完成用户认证  
✅ **自动加载用户信息**: 登录后自动获取当前用户信息  
✅ **显示用户状态**: 显示用户名和角色数量  
✅ **Token 管理**: 自动在请求中携带 JWT Token  

### 角色功能
✅ **角色自动绑定**: 创建角色时自动绑定到当前登录用户  
✅ **角色数量限制**: 每个用户最多创建5个角色  
✅ **角色列表显示**: 按 RosterOrder 排序显示所有角色  
✅ **角色选择切换**: 点击角色卡片切换当前使用的角色  
✅ **角色状态同步**: 创建角色后自动刷新列表  

## 实现细节

### 1. 认证流程

#### 登录检查
```csharp
protected override async Task OnInitializedAsync()
{
    // 检查登录状态
    await AuthService.InitializeAsync();
    if (!AuthService.IsAuthenticated)
    {
        Navigation.NavigateTo("/login", replace: true);
        return;
    }
    
    isAuthenticated = true;
    await LoadUserDataAsync();
}
```

#### 用户数据加载
```csharp
async Task LoadUserDataAsync()
{
    currentUser = await Api.GetCurrentUserAsync();
    if (currentUser is not null)
    {
        userCharacters = currentUser.Characters.OrderBy(c => c.RosterOrder).ToList();
        
        // 默认选中第一个角色
        if (userCharacters.Count > 0 && selectedCharacter is null)
        {
            selectedCharacter = userCharacters[0];
            lastCreated = new CharacterCreated(selectedCharacter.Id, selectedCharacter.Name);
        }
    }
}
```

### 2. 角色管理

#### 角色列表显示

角色列表以卡片形式展示，按 RosterOrder 排序：

```razor
@foreach (var character in userCharacters)
{
    var isSelected = selectedCharacter?.Id == character.Id;
    <div class="character-card @(isSelected ? "selected" : "")" 
         @onclick="() => SelectCharacter(character)">
        <h5>@character.Name @(isSelected ? "✓" : "")</h5>
        <div><b>职业:</b> @character.Profession</div>
        <div><b>等级:</b> @character.Level</div>
        <div><b>顺序:</b> #@(character.RosterOrder + 1)</div>
    </div>
}
```

#### 角色创建限制

创建角色前检查数量限制：

```csharp
async Task CreateCharacter()
{
    // 检查是否已达上限
    if (userCharacters.Count >= 5)
    {
        userMessage = "已达到角色数量上限（最多5个角色）";
        return;
    }
    
    lastCreated = await Api.CreateCharacterAsync(newName, selectedProfession);
    await LoadUserDataAsync();  // 重新加载角色列表
}
```

#### 角色选择切换

点击角色卡片切换当前角色：

```csharp
void SelectCharacter(UserCharacterDto character)
{
    selectedCharacter = character;
    lastCreated = new CharacterCreated(character.Id, character.Name);
    ResetBattleState();  // 重置战斗状态
    StateHasChanged();
}
```

### 3. API 调用

#### ApiClient 新增方法

```csharp
// 获取当前用户信息（包含角色列表）
public async Task<UserInfoDto?> GetCurrentUserAsync(CancellationToken ct = default)
{
    SetAuthHeader();
    return await _http.GetFromJsonAsync<UserInfoDto>("/api/users/me", ct);
}

// 获取用户的所有角色
public async Task<List<UserCharacterDto>> GetUserCharactersAsync(Guid userId, CancellationToken ct = default)
{
    SetAuthHeader();
    return (await _http.GetFromJsonAsync<List<UserCharacterDto>>($"/api/users/{userId}/characters", ct)) ?? new();
}
```

#### DTOs 定义

```csharp
public sealed class UserInfoDto
{
    public Guid Id { get; set; }
    public string Username { get; set; } = "";
    public string Email { get; set; } = "";
    public DateTime CreatedAt { get; set; }
    public DateTime? LastLoginAt { get; set; }
    public List<UserCharacterDto> Characters { get; set; } = new();
}

public sealed class UserCharacterDto
{
    public Guid Id { get; set; }
    public string Name { get; set; } = "";
    public int Level { get; set; }
    public Profession Profession { get; set; }
    public int RosterOrder { get; set; }
    public DateTime CreatedAt { get; set; }
}
```

## UI 组件说明

### 用户信息面板

显示当前登录用户的基本信息：

- 用户名
- 角色数量（X / 5）
- 提示信息

### 角色列表

卡片式布局展示所有角色：

- 角色名称
- 职业
- 等级
- 排序编号
- 选中状态（✓标记）
- 点击切换功能

### 创建角色表单

- 角色名输入框
- 职业下拉选择
- 创建按钮（达到上限时禁用）
- 数量限制提示

## 使用流程

### 1. 用户注册/登录

1. 访问应用，自动跳转到登录页
2. 选择"注册"或"登录"
3. 输入用户名、邮箱、密码
4. 提交后获得 JWT Token

### 2. 查看角色列表

1. 登录成功后自动加载用户角色
2. 角色按 RosterOrder 排序显示
3. 第一个角色默认被选中

### 3. 创建新角色

1. 输入角色名称
2. 选择职业（Warrior/Ranger）
3. 点击"创建"按钮
4. 角色自动绑定到当前用户
5. 列表自动刷新显示新角色

### 4. 切换角色

1. 点击角色列表中的任意角色卡片
2. 选中的角色用于所有后续操作（战斗、背包等）
3. 战斗状态自动重置

## 错误处理

### 未登录
- 自动跳转到登录页
- 显示"正在检查登录状态..."

### Token 过期
- API 返回 401
- AuthService 检测到错误
- 提示用户重新登录

### 角色创建失败
- 达到数量上限：显示提示信息，禁用创建按钮
- 网络错误：显示错误信息
- 其他错误：显示具体错误消息

## 后端 API 变更

### CharactersController

**变更**: 创建角色现在要求认证

```csharp
[HttpPost]
[Authorize]  // 新增：要求登录
public async Task<ActionResult<object>> Create([FromBody] CreateCharacterDto dto)
{
    // 检查角色数量限制（最多5个）
    var characterCount = await _db.Characters.CountAsync(ch => ch.UserId == userId.Value);
    if (characterCount >= 5)
    {
        return BadRequest(new { message = "已达到角色数量上限（最多5个角色）" });
    }
    
    // 自动绑定到当前用户
    c.UserId = userId.Value;
    c.RosterOrder = characterCount;
    
    // ...
}
```

### UsersController

**变更**: 返回角色时按 RosterOrder 排序

```csharp
Characters = user.Characters
    .OrderBy(c => c.RosterOrder)  // 新增：按顺序排序
    .Select(c => new
    {
        c.Id,
        c.Name,
        c.Level,
        c.Profession,
        c.RosterOrder  // 新增：返回顺序字段
    })
```

## 安全考虑

1. **Token 验证**: 所有角色操作都需要有效的 JWT Token
2. **用户隔离**: 用户只能访问自己的角色
3. **数量限制**: 服务端强制执行5个角色上限
4. **自动绑定**: 角色创建时自动绑定，无法绑定到其他用户

## 测试要点

### 功能测试
- [ ] 登录后能看到用户信息和角色列表
- [ ] 角色列表按 RosterOrder 正确排序
- [ ] 能成功创建新角色
- [ ] 创建5个角色后无法继续创建
- [ ] 能切换选中的角色
- [ ] 未登录时自动跳转到登录页

### 集成测试
- [ ] 登录 → 创建角色 → 刷新页面 → 角色仍然存在
- [ ] 创建角色 → 选择角色 → 开始战斗 → 战斗使用正确的角色
- [ ] 达到上限 → 创建按钮禁用 → 显示提示信息

### 边界测试
- [ ] 刚注册的用户（0个角色）
- [ ] 已有5个角色的用户
- [ ] Token 过期的处理
- [ ] 网络错误的处理

## 相关文档

- [用户系统文档](./用户系统文档.md)
- [JWT认证系统文档](./JWT认证系统文档.md)
- [API认证示例](./API认证示例.md)
- [前端用户认证功能说明](./前端用户认证功能说明.md)

## 总结

前端用户角色集成系统已完整实现，提供了完整的用户认证和角色管理体验。系统采用最小化修改原则，保持了代码风格的一致性，不影响现有功能的正常运行。用户可以方便地管理自己的多个角色，并在它们之间自由切换。
