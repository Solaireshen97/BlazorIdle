# BlazorIdle å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰
## æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**ä½œè€…**: ç³»ç»Ÿæ¶æ„è®¾è®¡å›¢é˜Ÿ  

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£ä¸ºã€Šå•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆã€‹çš„ä¸‹ç¯‡ï¼Œä¸“æ³¨äºæµ‹è¯•éªŒè¯ã€å‰ç«¯UIè®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œæ‰©å±•æ€§è§„åˆ’ã€‚

### ä¸ä¸Šä¸­ç¯‡çš„å…³ç³»

- **ä¸Šç¯‡**: ç³»ç»Ÿåˆ†æä¸æ¶æ„è®¾è®¡ â† è®¾è®¡åŸºç¡€
- **ä¸­ç¯‡**: å®æ–½è®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒ â† å¦‚ä½•å®æ–½
- **ä¸‹ç¯‡**ï¼ˆæœ¬æ–‡æ¡£ï¼‰: æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡ â† è´¨é‡ä¿è¯

---

## 1. æµ‹è¯•ç­–ç•¥

### 1.1 æµ‹è¯•å±‚æ¬¡åˆ’åˆ†

| æµ‹è¯•å±‚æ¬¡ | è¦†ç›–èŒƒå›´ | å·¥å…· | ç›®æ ‡è¦†ç›–ç‡ |
|---------|---------|------|-----------|
| **å•å…ƒæµ‹è¯•** | é¢†åŸŸæ¨¡å‹ã€æœåŠ¡ç±» | xUnit | 80% |
| **é›†æˆæµ‹è¯•** | æ•°æ®åº“æ“ä½œã€æœåŠ¡ç»„åˆ | xUnit + InMemory DB | 70% |
| **APIæµ‹è¯•** | Controllerç«¯ç‚¹ | xUnit + WebApplicationFactory | 60% |
| **å‰ç«¯æµ‹è¯•** | Blazorç»„ä»¶ | bUnit | 50% |
| **E2Eæµ‹è¯•** | å®Œæ•´è´­ä¹°æµç¨‹ | Playwright/Selenium | å…³é”®åœºæ™¯ |

### 1.2 å•å…ƒæµ‹è¯•

#### 1.2.1 è´§å¸æœåŠ¡æµ‹è¯•

**æ–‡ä»¶**: `tests/BlazorIdle.Tests/Shop/CurrencyServiceTests.cs`

```csharp
public class CurrencyServiceTests : IDisposable
{
    private readonly GameDbContext _context;
    private readonly CurrencyService _service;
    
    public CurrencyServiceTests()
    {
        var options = new DbContextOptionsBuilder<GameDbContext>()
            .UseInMemoryDatabase(Guid.NewGuid().ToString())
            .Options;
        _context = new GameDbContext(options);
        _service = new CurrencyService(_context);
    }
    
    [Fact]
    public async Task DeductCurrency_SufficientBalance_Success()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        await SeedCharacterWithGold(characterId, 1000);
        
        var amounts = new Dictionary<CurrencyType, long>
        {
            { CurrencyType.Gold, 500 }
        };
        
        // Act
        var result = await _service.DeductCurrencyAsync(characterId, amounts);
        
        // Assert
        Assert.True(result);
        var character = await _context.Characters.FindAsync(characterId);
        Assert.Equal(500, character.Gold);
    }
    
    [Fact]
    public async Task DeductCurrency_InsufficientBalance_Failure()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        await SeedCharacterWithGold(characterId, 100);
        
        var amounts = new Dictionary<CurrencyType, long>
        {
            { CurrencyType.Gold, 500 }
        };
        
        // Act
        var result = await _service.DeductCurrencyAsync(characterId, amounts);
        
        // Assert
        Assert.False(result);
        var character = await _context.Characters.FindAsync(characterId);
        Assert.Equal(100, character.Gold); // é‡‘é¢æœªå˜
    }
    
    // ... æ›´å¤šæµ‹è¯•ç”¨ä¾‹
}
```

#### 1.2.2 æ¡ä»¶è¯„ä¼°å™¨æµ‹è¯•

**æ–‡ä»¶**: `tests/BlazorIdle.Tests/Shop/ConditionEvaluatorTests.cs`

```csharp
public class ConditionEvaluatorTests
{
    [Theory]
    [InlineData("level >= 20", 20, true)]
    [InlineData("level >= 20", 19, false)]
    [InlineData("level >= 20", 30, true)]
    public async Task Evaluate_LevelCondition_ReturnsCorrectResult(
        string condition, int characterLevel, bool expected)
    {
        // Arrange
        var character = new Character { Level = characterLevel };
        var evaluator = CreateEvaluator();
        
        // Act
        var result = await evaluator.EvaluateAsync(condition, character.Id);
        
        // Assert
        Assert.Equal(expected, result);
    }
    
    [Fact]
    public async Task Evaluate_AndCondition_AllMustBeTrue()
    {
        // Arrange
        var character = new Character { Level = 30, Profession = Profession.Warrior };
        var condition = "AND(level >= 20, profession == 'Warrior')";
        var evaluator = CreateEvaluator();
        
        // Act
        var result = await evaluator.EvaluateAsync(condition, character.Id);
        
        // Assert
        Assert.True(result);
    }
    
    // ... æ›´å¤šæµ‹è¯•ç”¨ä¾‹
}
```

#### 1.2.3 ä»·æ ¼è®¡ç®—å™¨æµ‹è¯•

```csharp
public class PriceCalculatorTests
{
    [Fact]
    public async Task CalculatePrice_WithDiscount_ReturnsReducedPrice()
    {
        // Arrange
        var item = new ShopItemDefinition
        {
            Price = new ShopItemPrice
            {
                BasePrices = new Dictionary<CurrencyType, long>
                {
                    { CurrencyType.Gold, 100 }
                },
                DiscountPercent = 20
            }
        };
        
        var calculator = CreateCalculator();
        
        // Act
        var priceInfo = await calculator.CalculatePriceAsync(item, Guid.NewGuid(), 1, 0);
        
        // Assert
        Assert.Equal(80, priceInfo.UnitPrices[CurrencyType.Gold]);
        Assert.Equal(20, priceInfo.DiscountPercent);
    }
    
    [Fact]
    public async Task CalculatePrice_WithPriceIncrease_IncreasesPrice()
    {
        // Arrange
        var item = new ShopItemDefinition
        {
            Price = new ShopItemPrice
            {
                BasePrices = new Dictionary<CurrencyType, long>
                {
                    { CurrencyType.Gold, 100 }
                },
                PriceIncreasePercent = 10,  // æ¯æ¬¡è´­ä¹°å¢åŠ 10%
                MaxPriceMultiplier = 2.0m
            }
        };
        
        var calculator = CreateCalculator();
        
        // Act - ç¬¬äºŒæ¬¡è´­ä¹°
        var priceInfo = await calculator.CalculatePriceAsync(item, Guid.NewGuid(), 1, 1);
        
        // Assert
        Assert.Equal(110, priceInfo.UnitPrices[CurrencyType.Gold]);
    }
}
```

### 1.3 é›†æˆæµ‹è¯•

#### 1.3.1 è´­ä¹°æµç¨‹é›†æˆæµ‹è¯•

**æ–‡ä»¶**: `tests/BlazorIdle.Tests/Shop/PurchaseIntegrationTests.cs`

```csharp
public class PurchaseIntegrationTests : IDisposable
{
    private readonly GameDbContext _context;
    private readonly PurchaseService _purchaseService;
    
    [Fact]
    public async Task PurchaseItem_CompleteFlow_Success()
    {
        // Arrange
        var character = await SeedCharacter(level: 10, gold: 1000);
        var shop = await SeedShop();
        var item = await SeedItem(minLevel: 5, price: 100);
        
        var request = new PurchaseRequest
        {
            CharacterId = character.Id,
            ShopId = shop.Id,
            ItemId = item.Id,
            Quantity = 2
        };
        
        // Act
        var result = await _purchaseService.PurchaseItemAsync(request);
        
        // Assert
        Assert.True(result.Success);
        
        // éªŒè¯é‡‘å¸æ‰£é™¤
        var updatedChar = await _context.Characters.FindAsync(character.Id);
        Assert.Equal(800, updatedChar.Gold);
        
        // éªŒè¯ç‰©å“å‘æ”¾
        var inventory = await _context.InventoryItems
            .FirstOrDefaultAsync(x => x.CharacterId == character.Id && x.ItemId == item.TargetItemId);
        Assert.NotNull(inventory);
        Assert.Equal(2, inventory.Quantity);
        
        // éªŒè¯è´­ä¹°è®°å½•
        var record = await _context.PurchaseRecords
            .FirstOrDefaultAsync(x => x.CharacterId == character.Id && x.ItemId == item.Id);
        Assert.NotNull(record);
        Assert.Equal(2, record.Quantity);
    }
    
    [Fact]
    public async Task PurchaseItem_InsufficientGold_Failure()
    {
        // Arrange
        var character = await SeedCharacter(level: 10, gold: 50);
        var item = await SeedItem(price: 100);
        
        var request = new PurchaseRequest
        {
            CharacterId = character.Id,
            ItemId = item.Id,
            Quantity = 1
        };
        
        // Act
        var result = await _purchaseService.PurchaseItemAsync(request);
        
        // Assert
        Assert.False(result.Success);
        Assert.Contains("è´§å¸ä¸è¶³", result.ErrorMessage);
        
        // éªŒè¯é‡‘å¸æœªå˜
        var updatedChar = await _context.Characters.FindAsync(character.Id);
        Assert.Equal(50, updatedChar.Gold);
    }
    
    [Fact]
    public async Task PurchaseItem_ExceedsDailyLimit_Failure()
    {
        // Arrange
        var character = await SeedCharacter(level: 10, gold: 1000);
        var item = await SeedItem(price: 10, dailyLimit: 5);
        
        // å·²è´­ä¹°5æ¬¡
        await SeedPurchaseCounter(character.Id, item.Id, dailyCount: 5);
        
        var request = new PurchaseRequest
        {
            CharacterId = character.Id,
            ItemId = item.Id,
            Quantity = 1
        };
        
        // Act
        var result = await _purchaseService.PurchaseItemAsync(request);
        
        // Assert
        Assert.False(result.Success);
        Assert.Contains("è¶…è¿‡è´­ä¹°é™åˆ¶", result.ErrorMessage);
    }
}
```

### 1.4 APIæµ‹è¯•

```csharp
public class ShopControllerTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;
    
    [Fact]
    public async Task GetShop_ValidShopId_ReturnsShop()
    {
        // Arrange
        var shopId = "shop_general_merchant";
        var characterId = Guid.NewGuid();
        
        // Act
        var response = await _client.GetAsync($"/api/shops/{shopId}?characterId={characterId}");
        
        // Assert
        response.EnsureSuccessStatusCode();
        var shop = await response.Content.ReadFromJsonAsync<ShopDTO>();
        Assert.NotNull(shop);
        Assert.Equal(shopId, shop.Id);
    }
    
    [Fact]
    public async Task PurchaseItem_ValidRequest_ReturnsSuccess()
    {
        // Arrange
        var request = new PurchaseRequest
        {
            CharacterId = Guid.NewGuid(),
            ShopId = "shop_general_merchant",
            ItemId = "item_health_potion_small",
            Quantity = 5
        };
        
        // Act
        var response = await _client.PostAsJsonAsync("/api/shop/purchase", request);
        
        // Assert
        response.EnsureSuccessStatusCode();
        var result = await response.Content.ReadFromJsonAsync<PurchaseResult>();
        Assert.NotNull(result);
        Assert.True(result.Success);
    }
}
```

---

## 2. å‰ç«¯UIè®¾è®¡

### 2.1 é¡µé¢ç»“æ„

```
Shops.razor (å•†åº—åˆ—è¡¨é¡µé¢)
â”œâ”€â”€ ShopList.razor (å•†åº—åˆ—è¡¨ç»„ä»¶)
â”‚   â””â”€â”€ ShopCard.razor (å•ä¸ªå•†åº—å¡ç‰‡)
â”‚
â”œâ”€â”€ ShopDetail.razor (å•†åº—è¯¦æƒ…é¡µé¢)
â”‚   â”œâ”€â”€ ShopHeader.razor (å•†åº—æ ‡é¢˜å’Œä¿¡æ¯)
â”‚   â”œâ”€â”€ ShopItemList.razor (å•†å“åˆ—è¡¨)
â”‚   â”‚   â””â”€â”€ ShopItemCard.razor (å•ä¸ªå•†å“å¡ç‰‡)
â”‚   â””â”€â”€ PurchaseDialog.razor (è´­ä¹°ç¡®è®¤å¯¹è¯æ¡†)
â”‚
â””â”€â”€ CurrencyDisplay.razor (è´§å¸æ˜¾ç¤ºç»„ä»¶)
```

### 2.2 å…³é”®ç»„ä»¶è®¾è®¡

#### 2.2.1 å•†åº—åˆ—è¡¨ (ShopList.razor)

```razor
@inject IShopService ShopService
@inject NavigationManager Navigation

<div class="shop-list">
    <h2>å•†åº—</h2>
    
    @if (shops == null)
    {
        <p>åŠ è½½ä¸­...</p>
    }
    else if (!shops.Any())
    {
        <p>æš‚æ— å¯ç”¨å•†åº—</p>
    }
    else
    {
        <div class="shop-grid">
            @foreach (var shop in shops)
            {
                <ShopCard Shop="@shop" OnClick="@(() => NavigateToShop(shop.Id))" />
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid CharacterId { get; set; }
    
    private List<ShopDefinition>? shops;
    
    protected override async Task OnInitializedAsync()
    {
        shops = await ShopService.GetAvailableShopsAsync(CharacterId);
    }
    
    private void NavigateToShop(string shopId)
    {
        Navigation.NavigateTo($"/shops/{shopId}");
    }
}
```

#### 2.2.2 å•†åº—è¯¦æƒ… (ShopDetail.razor)

```razor
@inject IShopService ShopService
@inject IPurchaseService PurchaseService
@inject IToastService ToastService

<div class="shop-detail">
    @if (shop == null)
    {
        <p>åŠ è½½ä¸­...</p>
    }
    else
    {
        <ShopHeader Shop="@shop" />
        
        <CurrencyDisplay CharacterId="@CharacterId" />
        
        <div class="shop-items">
            <h3>å•†å“åˆ—è¡¨</h3>
            
            @if (items == null || !items.Any())
            {
                <p>æš‚æ— å•†å“</p>
            }
            else
            {
                <div class="item-grid">
                    @foreach (var item in items)
                    {
                        <ShopItemCard 
                            Item="@item" 
                            IsLocked="@(!unlockedItems.Contains(item.Id))"
                            OnPurchase="@(() => ShowPurchaseDialog(item))" />
                    }
                </div>
            }
        </div>
    }
</div>

@if (showPurchaseDialog)
{
    <PurchaseDialog 
        Item="@selectedItem"
        CharacterId="@CharacterId"
        OnConfirm="@HandlePurchase"
        OnCancel="@(() => showPurchaseDialog = false)" />
}

@code {
    [Parameter]
    public string ShopId { get; set; } = "";
    
    [Parameter]
    public Guid CharacterId { get; set; }
    
    private ShopInstance? shop;
    private List<ShopItemDefinition>? items;
    private HashSet<string> unlockedItems = new();
    
    private bool showPurchaseDialog = false;
    private ShopItemDefinition? selectedItem;
    
    protected override async Task OnInitializedAsync()
    {
        shop = await ShopService.GetShopAsync(ShopId, CharacterId);
        if (shop != null)
        {
            items = await ShopService.GetShopItemsAsync(ShopId, CharacterId);
            
            // æ£€æŸ¥æ¯ä¸ªå•†å“çš„è§£é”çŠ¶æ€
            foreach (var item in items)
            {
                if (await ShopService.IsItemUnlockedAsync(item.Id, CharacterId))
                {
                    unlockedItems.Add(item.Id);
                }
            }
        }
    }
    
    private void ShowPurchaseDialog(ShopItemDefinition item)
    {
        selectedItem = item;
        showPurchaseDialog = true;
    }
    
    private async Task HandlePurchase(PurchaseRequest request)
    {
        var result = await PurchaseService.PurchaseItemAsync(request);
        
        if (result.Success)
        {
            ToastService.ShowSuccess("è´­ä¹°æˆåŠŸï¼");
            showPurchaseDialog = false;
            await OnInitializedAsync(); // åˆ·æ–°é¡µé¢
        }
        else
        {
            ToastService.ShowError(result.ErrorMessage ?? "è´­ä¹°å¤±è´¥");
        }
    }
}
```

#### 2.2.3 å•†å“å¡ç‰‡ (ShopItemCard.razor)

```razor
<div class="shop-item-card @(IsLocked ? "locked" : "")">
    <div class="item-icon">@Item.Icon</div>
    <div class="item-info">
        <h4 class="item-name">@Item.DisplayName</h4>
        <p class="item-description">@Item.Description</p>
        
        <div class="item-price">
            @foreach (var (currency, amount) in Item.Price.BasePrices)
            {
                <span class="currency">
                    <span class="currency-icon">@GetCurrencyIcon(currency)</span>
                    <span class="currency-amount">@amount</span>
                </span>
            }
            
            @if (Item.Price.DiscountPercent > 0)
            {
                <span class="discount-badge">-@Item.Price.DiscountPercent%</span>
            }
        </div>
        
        @if (IsLocked)
        {
            <div class="locked-info">
                <span>ğŸ”’ æœªè§£é”</span>
            </div>
        }
        else
        {
            <button class="btn-purchase" @onclick="OnPurchase">è´­ä¹°</button>
        }
    </div>
</div>

@code {
    [Parameter]
    public ShopItemDefinition Item { get; set; } = null!;
    
    [Parameter]
    public bool IsLocked { get; set; }
    
    [Parameter]
    public EventCallback OnPurchase { get; set; }
    
    private string GetCurrencyIcon(CurrencyType currency)
    {
        return currency switch
        {
            CurrencyType.Gold => "ğŸ’°",
            CurrencyType.Gems => "ğŸ’",
            CurrencyType.Honor => "âš”ï¸",
            CurrencyType.Justice => "âš–ï¸",
            _ => "ğŸª™"
        };
    }
}
```

#### 2.2.4 è´­ä¹°å¯¹è¯æ¡† (PurchaseDialog.razor)

```razor
<div class="modal-overlay" @onclick="OnCancel">
    <div class="modal-content" @onclick:stopPropagation="true">
        <h3>è´­ä¹°ç¡®è®¤</h3>
        
        <div class="purchase-summary">
            <p>å•†å“ï¼š@Item.DisplayName</p>
            <p>æ•°é‡ï¼š
                <input type="number" min="1" max="@maxQuantity" @bind="quantity" />
            </p>
            
            <div class="total-price">
                <p>æ€»ä»·ï¼š</p>
                @foreach (var (currency, unitPrice) in Item.Price.BasePrices)
                {
                    var total = unitPrice * quantity;
                    <p>@GetCurrencyIcon(currency) @total</p>
                }
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn-confirm" @onclick="HandleConfirm">ç¡®è®¤è´­ä¹°</button>
            <button class="btn-cancel" @onclick="OnCancel">å–æ¶ˆ</button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public ShopItemDefinition Item { get; set; } = null!;
    
    [Parameter]
    public Guid CharacterId { get; set; }
    
    [Parameter]
    public EventCallback<PurchaseRequest> OnConfirm { get; set; }
    
    [Parameter]
    public EventCallback OnCancel { get; set; }
    
    private int quantity = 1;
    private int maxQuantity = 99;
    
    protected override void OnInitialized()
    {
        maxQuantity = Item.Limit.MaxPurchasePerTransaction;
    }
    
    private async Task HandleConfirm()
    {
        var request = new PurchaseRequest
        {
            CharacterId = CharacterId,
            ItemId = Item.Id,
            Quantity = quantity
        };
        
        await OnConfirm.InvokeAsync(request);
    }
}
```

### 2.3 CSSæ ·å¼ç¤ºä¾‹

```css
.shop-list {
    padding: 20px;
}

.shop-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.shop-item-card {
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background: white;
    transition: transform 0.2s;
}

.shop-item-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.shop-item-card.locked {
    opacity: 0.6;
    background: #f5f5f5;
}

.item-icon {
    font-size: 48px;
    text-align: center;
    margin-bottom: 10px;
}

.item-price {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.discount-badge {
    background: #e74c3c;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.btn-purchase {
    width: 100%;
    padding: 10px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-purchase:hover {
    background: #2980b9;
}
```

---

## 3. æ€§èƒ½ä¼˜åŒ–

### 3.1 ç¼“å­˜ç­–ç•¥

#### 3.1.1 å•†åº—æ•°æ®ç¼“å­˜

```csharp
public class ShopService : IShopService
{
    private readonly IMemoryCache _cache;
    
    public async Task<ShopDefinition?> GetShopDefinitionAsync(string shopId)
    {
        var cacheKey = $"shop_def:{shopId}";
        
        return await _cache.GetOrCreateAsync(cacheKey, async entry =>
        {
            entry.SetAbsoluteExpiration(TimeSpan.FromMinutes(30));
            return await _context.ShopDefinitions.FindAsync(shopId);
        });
    }
}
```

#### 3.1.2 æ¡ä»¶è¯„ä¼°ç»“æœç¼“å­˜

```csharp
public class ConditionEvaluator : IConditionEvaluator
{
    public async Task<bool> EvaluateAsync(string conditionExpr, Guid characterId)
    {
        var cacheKey = $"condition:{characterId}:{conditionExpr}";
        
        return await _cache.GetOrCreateAsync(cacheKey, async entry =>
        {
            entry.SetAbsoluteExpiration(TimeSpan.FromMinutes(5));
            return await EvaluateExpression(conditionExpr, characterId);
        });
    }
    
    public void InvalidateCache(Guid characterId)
    {
        // è§’è‰²æ•°æ®å˜æ›´æ—¶å¤±æ•ˆç¼“å­˜
        var prefix = $"condition:{characterId}:";
        // ä½¿ç”¨ç¼“å­˜é”®å‰ç¼€å¤±æ•ˆç­–ç•¥
    }
}
```

### 3.2 æ‰¹é‡æ“ä½œä¼˜åŒ–

```csharp
// æ‰¹é‡è·å–å•†å“è§£é”çŠ¶æ€
public async Task<Dictionary<string, bool>> GetItemUnlockStatusBatchAsync(
    List<string> itemIds, Guid characterId)
{
    var result = new Dictionary<string, bool>();
    var character = await _context.Characters.FindAsync(characterId);
    
    foreach (var itemId in itemIds)
    {
        result[itemId] = await IsItemUnlockedAsync(itemId, characterId);
    }
    
    return result;
}
```

### 3.3 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```csharp
// ä½¿ç”¨æŠ•å½±é¿å…åŠ è½½ä¸å¿…è¦çš„æ•°æ®
public async Task<List<ShopListItemDTO>> GetShopListAsync(Guid characterId)
{
    return await _context.ShopDefinitions
        .Where(x => x.IsEnabled)
        .OrderBy(x => x.SortOrder)
        .Select(x => new ShopListItemDTO
        {
            Id = x.Id,
            Name = x.Name,
            Icon = x.Icon,
            Type = x.Type
        })
        .ToListAsync();
}
```

---

## 4. æ‰©å±•æ€§è®¾è®¡

### 4.1 æ‹å–è¡Œç³»ç»Ÿé¢„ç•™

```csharp
public interface IAuctionService
{
    Task<Auction> CreateAuctionAsync(AuctionRequest request);
    Task<List<Auction>> SearchAuctionsAsync(AuctionSearchCriteria criteria);
    Task<BidResult> PlaceBidAsync(Guid auctionId, Guid characterId, long bidAmount);
    Task<bool> BuyoutAsync(Guid auctionId, Guid characterId);
}
```

### 4.2 ç©å®¶äº¤æ˜“ç³»ç»Ÿé¢„ç•™

```csharp
public interface IPlayerTradeService
{
    Task<Trade> InitiateTradeAsync(Guid fromCharId, Guid toCharId);
    Task<bool> AddTradeItemAsync(Guid tradeId, TradeItemOffer offer);
    Task<bool> ConfirmTradeAsync(Guid tradeId, Guid characterId);
    Task<TradeResult> ExecuteTradeAsync(Guid tradeId);
}
```

### 4.3 é™æ—¶æ´»åŠ¨å•†åº—

```csharp
public class EventShopService : ShopService
{
    public async Task<bool> IsEventActiveAsync(string eventId)
    {
        var eventShop = await _context.ShopDefinitions
            .FirstOrDefaultAsync(x => x.Tags.Contains($"event:{eventId}"));
        
        if (eventShop == null)
            return false;
        
        // æ£€æŸ¥æ´»åŠ¨æ—¶é—´
        // ...
        
        return true;
    }
}
```

---

## 5. é£é™©è¯„ä¼°ä¸åº”å¯¹

### 5.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹ç­–ç•¥ |
|------|------|------|---------|
| **æ¡ä»¶DSLæœªå®ç°** | é«˜ | ä¸­ | å…ˆå®ç°ç®€åŒ–ç‰ˆï¼Œé¢„ç•™æ¥å£ |
| **å£°æœ›ç³»ç»Ÿæœªå®ç°** | ä¸­ | é«˜ | ä¸æ¡ä»¶ç³»ç»Ÿä¸€èµ·å®ç° |
| **æ€§èƒ½ç“¶é¢ˆ** | ä¸­ | ä½ | ç¼“å­˜+æ‰¹é‡æ“ä½œ+ç´¢å¼•ä¼˜åŒ– |
| **å¹¶å‘é—®é¢˜** | é«˜ | ä¸­ | æ•°æ®åº“äº‹åŠ¡+ä¹è§‚é” |
| **æ•°æ®è¿ç§»é£é™©** | ä¸­ | ä½ | å®Œæ•´çš„å›æ»šè®¡åˆ’ |

### 5.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹ç­–ç•¥ |
|------|------|------|---------|
| **å®šä»·ä¸å¹³è¡¡** | ä¸­ | é«˜ | å¯é…ç½®åŒ–+ç°åº¦æµ‹è¯• |
| **é€šè´§è†¨èƒ€** | é«˜ | ä¸­ | è´§å¸å›æ”¶æœºåˆ¶ |
| **åˆ·é‡‘è¡Œä¸º** | é«˜ | ä¸­ | è´­ä¹°é™åˆ¶+ç›‘æ§ |
| **BUGå¯¼è‡´æŸå¤±** | é«˜ | ä½ | å®Œæ•´æµ‹è¯•+å›æ»šèƒ½åŠ› |

---

## 6. äº¤ä»˜æ¸…å•

### 6.1 ä»£ç äº¤ä»˜ç‰©

- [ ] é¢†åŸŸæ¨¡å‹ï¼ˆ11ä¸ªç±»æ–‡ä»¶ï¼‰
- [ ] æœåŠ¡å±‚ï¼ˆ5ä¸ªæœåŠ¡æ¥å£å’Œå®ç°ï¼‰
- [ ] æ•°æ®åº“è¿ç§»ï¼ˆ1ä¸ªè¿ç§»æ–‡ä»¶ï¼‰
- [ ] EF Coreé…ç½®ï¼ˆ6ä¸ªé…ç½®ç±»ï¼‰
- [ ] API Controllersï¼ˆ2ä¸ªæ§åˆ¶å™¨ï¼‰
- [ ] å‰ç«¯ç»„ä»¶ï¼ˆ8ä¸ªBlazorç»„ä»¶ï¼‰
- [ ] å•å…ƒæµ‹è¯•ï¼ˆ30+ä¸ªæµ‹è¯•ç±»ï¼‰
- [ ] é›†æˆæµ‹è¯•ï¼ˆ10+ä¸ªæµ‹è¯•åœºæ™¯ï¼‰
- [ ] ç§å­æ•°æ®ï¼ˆåˆå§‹å•†åº—å’Œå•†å“é…ç½®ï¼‰

### 6.2 æ–‡æ¡£äº¤ä»˜ç‰©

- [x] å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸Šï¼‰- ç³»ç»Ÿåˆ†æä¸æ¶æ„è®¾è®¡
- [x] å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ï¼‰- å®æ–½è®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒ
- [x] å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ï¼‰- æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡
- [ ] APIæ–‡æ¡£ï¼ˆSwaggerï¼‰
- [ ] æ•°æ®åº“è®¾è®¡æ–‡æ¡£
- [ ] ç”¨æˆ·æ‰‹å†Œï¼ˆå•†åº—ä½¿ç”¨è¯´æ˜ï¼‰
- [ ] è¿ç»´æ‰‹å†Œï¼ˆé…ç½®å’Œç›‘æ§ï¼‰

### 6.3 é…ç½®äº¤ä»˜ç‰©

- [ ] å•†åº—é…ç½®JSONç¤ºä¾‹
- [ ] å•†å“é…ç½®JSONç¤ºä¾‹
- [ ] ç¯å¢ƒé…ç½®è¯´æ˜
- [ ] æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

---

## 7. åç»­ä¼˜åŒ–æ–¹å‘

### 7.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ3ä¸ªæœˆå†…ï¼‰

1. **UI/UXä¼˜åŒ–**
   - å•†å“ç­›é€‰å’Œæ’åº
   - å•†å“é¢„è§ˆåŠŸèƒ½
   - è´­ä¹°å†å²æŸ¥çœ‹
   - æ”¶è—å¤¹åŠŸèƒ½

2. **åŠŸèƒ½å¢å¼º**
   - å•†å“æœç´¢
   - æ‰¹é‡è´­ä¹°
   - è´­ç‰©è½¦åŠŸèƒ½
   - æ‰“æŠ˜ä¿ƒé”€æ´»åŠ¨

### 7.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ6ä¸ªæœˆå†…ï¼‰

1. **é«˜çº§åŠŸèƒ½**
   - æ‹å–è¡Œç³»ç»Ÿ
   - ç©å®¶äº¤æ˜“
   - å•†åº—å£°æœ›ç³»ç»Ÿ
   - VIPä¼šå‘˜æŠ˜æ‰£

2. **åˆ†æä¸ç›‘æ§**
   - é”€å”®æ•°æ®ç»Ÿè®¡
   - çƒ­é—¨å•†å“åˆ†æ
   - è´§å¸æµå‘è¿½è¸ª
   - å¼‚å¸¸äº¤æ˜“æ£€æµ‹

### 7.3 é•¿æœŸä¼˜åŒ–ï¼ˆ1å¹´å†…ï¼‰

1. **ç¤¾äº¤åŠŸèƒ½**
   - èµ é€ç‰©å“
   - äº¤æ˜“å¸‚åœº
   - å•†åº—è¯„ä»·ç³»ç»Ÿ
   - å•†äººNPCäº’åŠ¨

2. **æ·±åº¦æ•´åˆ**
   - ä¸ä»»åŠ¡ç³»ç»Ÿæ·±åº¦æ•´åˆ
   - ä¸æˆå°±ç³»ç»Ÿæ•´åˆ
   - ä¸èµ›å­£ç³»ç»Ÿæ•´åˆ
   - è·¨æœäº¤æ˜“ï¼ˆå¦‚é€‚ç”¨ï¼‰

---

## æ€»ç»“

æœ¬æ–‡æ¡£ï¼ˆä¸‹ç¯‡ï¼‰å®Œæˆäº†å•†åº—ç³»ç»Ÿçš„æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… å®Œæ•´çš„æµ‹è¯•ç­–ç•¥ï¼ˆå•å…ƒ/é›†æˆ/API/å‰ç«¯/E2Eï¼‰
2. âœ… è¯¦ç»†çš„å‰ç«¯UIè®¾è®¡æ–¹æ¡ˆ
3. âœ… æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
4. âœ… æ‰©å±•æ€§è®¾è®¡æ–¹æ¡ˆ
5. âœ… é£é™©è¯„ä¼°ä¸åº”å¯¹
6. âœ… å®Œæ•´çš„äº¤ä»˜æ¸…å•
7. âœ… åç»­ä¼˜åŒ–æ–¹å‘

### ä¸‰ç¯‡æ–‡æ¡£æ€»ç»“

**ä¸Šç¯‡**æä¾›äº†ç³»ç»Ÿåˆ†æå’Œæ¶æ„è®¾è®¡åŸºç¡€  
**ä¸­ç¯‡**æä¾›äº†è¯¦ç»†çš„å®æ–½è®¡åˆ’å’ŒæŠ€æœ¯è§„èŒƒ  
**ä¸‹ç¯‡**æä¾›äº†è´¨é‡ä¿è¯å’Œæ‰©å±•æ€§æ–¹æ¡ˆ

ä¸‰ç¯‡æ–‡æ¡£å…±åŒæ„æˆäº†å•†åº—ç³»ç»Ÿçš„å®Œæ•´è®¾è®¡æ–¹æ¡ˆï¼Œè¦†ç›–äº†ä»éœ€æ±‚åˆ†æåˆ°å®æ–½è½åœ°çš„å…¨è¿‡ç¨‹ã€‚

---

**æ–‡æ¡£çŠ¶æ€**: å·²å®Œæˆ  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸  
**ç‰ˆæœ¬**: 1.0
