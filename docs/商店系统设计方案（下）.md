# å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰- å®æ–½æ–¹æ¡ˆä¸äº¤ä»˜

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**è´Ÿè´£**: å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [é˜¶æ®µæ€§å®æ–½æ–¹æ¡ˆ](#é˜¶æ®µæ€§å®æ–½æ–¹æ¡ˆ)
2. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
3. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
4. [ç›‘æ§ä¸è¿ç»´](#ç›‘æ§ä¸è¿ç»´)
5. [é£é™©ç®¡ç†](#é£é™©ç®¡ç†)
6. [äº¤ä»˜æ¸…å•](#äº¤ä»˜æ¸…å•)

---

## é˜¶æ®µæ€§å®æ–½æ–¹æ¡ˆ

### 1.1 Phase 1: åŸºç¡€æ¡†æ¶ï¼ˆWeek 1-2ï¼Œ10-12 å·¥ä½œæ—¥ï¼‰

#### 1.1.1 ç›®æ ‡

å»ºç«‹å•†åº—ç³»ç»Ÿçš„æ ¸å¿ƒéª¨æ¶ï¼Œå®ç°æœ€å°å¯ç”¨ç‰ˆæœ¬ï¼ˆMVPï¼‰ã€‚

#### 1.1.2 å·¥ä½œå†…å®¹

**é¢†åŸŸæ¨¡å‹å®ç°**ï¼ˆ3 å¤©ï¼‰

- [ ] åˆ›å»º `Domain/Shop` ç›®å½•
- [ ] å®ç° `ShopDefinition` å®ä½“
- [ ] å®ç° `ShopItem` å®ä½“
- [ ] å®ç° `PurchaseRecord` å®ä½“
- [ ] å®ç° `PurchaseCounter` å®ä½“
- [ ] å®ç° `Price` å€¼å¯¹è±¡
- [ ] å®ç° `PurchaseLimit` å€¼å¯¹è±¡
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆæ¨¡å‹éªŒè¯ï¼‰

**æ•°æ®åº“è¿ç§»**ï¼ˆ2 å¤©ï¼‰

- [ ] åˆ›å»º EF Core é…ç½®ç±»
  - `ShopDefinitionConfiguration.cs`
  - `ShopItemConfiguration.cs`
  - `PurchaseRecordConfiguration.cs`
  - `PurchaseCounterConfiguration.cs`
- [ ] åˆ›å»ºæ•°æ®åº“è¿ç§»
  ```bash
  dotnet ef migrations add AddShopSystem
  ```
- [ ] éªŒè¯è¿ç§» SQL
- [ ] åº”ç”¨è¿ç§»åˆ°å¼€å‘æ•°æ®åº“
  ```bash
  dotnet ef database update
  ```

**ç§å­æ•°æ®**ï¼ˆ2 å¤©ï¼‰

- [ ] å®ç° `ShopSeedData.cs`
- [ ] åˆ›å»ºåˆå§‹å•†åº—å®šä¹‰
  - æ‚è´§é“ºï¼ˆgeneral_shopï¼‰
  - æ­¦å™¨åº—ï¼ˆweapon_shopï¼‰
  - ç‚¼é‡‘æœ¯å£«ï¼ˆalchemist_shopï¼‰
- [ ] åˆ›å»ºåˆå§‹å•†å“æ•°æ®ï¼ˆè‡³å°‘ 10 ä¸ªï¼‰
- [ ] é›†æˆåˆ° `GameDbContext.OnModelCreating`

**æœåŠ¡æ¥å£**ï¼ˆ3 å¤©ï¼‰

- [ ] åˆ›å»º `IShopService` æ¥å£
- [ ] åˆ›å»º `IPurchaseValidator` æ¥å£
- [ ] å®ç° `ShopService` éª¨æ¶
- [ ] å®ç° `PurchaseValidator` éª¨æ¶
- [ ] åœ¨ `DependencyInjection.cs` ä¸­æ³¨å†ŒæœåŠ¡

**API æ§åˆ¶å™¨**ï¼ˆ2 å¤©ï¼‰

- [ ] åˆ›å»º `ShopController.cs`
- [ ] å®ç° `GET /api/shop/list` ç«¯ç‚¹ï¼ˆéª¨æ¶ï¼‰
- [ ] å®ç° `GET /api/shop/{id}/items` ç«¯ç‚¹ï¼ˆéª¨æ¶ï¼‰
- [ ] å®ç° `POST /api/shop/purchase` ç«¯ç‚¹ï¼ˆéª¨æ¶ï¼‰
- [ ] é…ç½®è·¯ç”±å’Œè®¤è¯

#### 1.1.3 éªŒæ”¶æ ‡å‡†

- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸï¼Œè¡¨ç»“æ„æ­£ç¡®
- [ ] ç§å­æ•°æ®æ­£ç¡®æ’å…¥
- [ ] API ç«¯ç‚¹å¯è®¿é—®ï¼ˆè¿”å›ç©ºæ•°æ®æˆ–å ä½å“åº”ï¼‰
- [ ] ç¼–è¯‘æ— é”™è¯¯ï¼Œæ— è­¦å‘Š
- [ ] ä»£ç é€šè¿‡ Code Review

#### 1.1.4 æ–‡ä»¶æ¸…å•

```
æ–°å¢æ–‡ä»¶ï¼ˆçº¦ 15 ä¸ªï¼‰ï¼š
BlazorIdle.Server/
â”œâ”€â”€ Domain/Shop/
â”‚   â”œâ”€â”€ ShopDefinition.cs
â”‚   â”œâ”€â”€ ShopItem.cs
â”‚   â”œâ”€â”€ PurchaseRecord.cs
â”‚   â”œâ”€â”€ PurchaseCounter.cs
â”‚   â””â”€â”€ ValueObjects/
â”‚       â”œâ”€â”€ Price.cs
â”‚       â””â”€â”€ PurchaseLimit.cs
â”œâ”€â”€ Application/
â”‚   â”œâ”€â”€ Abstractions/
â”‚   â”‚   â”œâ”€â”€ IShopService.cs
â”‚   â”‚   â””â”€â”€ IPurchaseValidator.cs
â”‚   â””â”€â”€ Shop/
â”‚       â”œâ”€â”€ ShopService.cs
â”‚       â””â”€â”€ PurchaseValidator.cs
â”œâ”€â”€ Infrastructure/Persistence/
â”‚   â”œâ”€â”€ Configurations/
â”‚   â”‚   â””â”€â”€ ShopConfiguration.cs
â”‚   â””â”€â”€ ShopSeedData.cs
â””â”€â”€ Api/
    â””â”€â”€ ShopController.cs

BlazorIdle.Shared/
â””â”€â”€ Dtos/Shop/
    â”œâ”€â”€ ShopDto.cs
    â”œâ”€â”€ ShopItemDto.cs
    â”œâ”€â”€ PurchaseRequest.cs
    â””â”€â”€ PurchaseResponse.cs
```

---

### 1.2 Phase 2: æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ˆWeek 3-4ï¼Œ10-12 å·¥ä½œæ—¥ï¼‰

#### 1.2.1 ç›®æ ‡

å®ç°å®Œæ•´çš„è´­ä¹°æµç¨‹å’ŒéªŒè¯é€»è¾‘ã€‚

#### 1.2.2 å·¥ä½œå†…å®¹

**å•†åº—åˆ—è¡¨æŸ¥è¯¢**ï¼ˆ2 å¤©ï¼‰

- [ ] å®ç° `ShopService.ListShopsAsync`
  - æŸ¥è¯¢å¯ç”¨çš„å•†åº—
  - è¿‡æ»¤è§£é”æ¡ä»¶ï¼ˆåŸºç¡€å®ç°ï¼šç­‰çº§æ£€æŸ¥ï¼‰
  - è®¡ç®—å•†å“æ•°é‡
  - æ˜ å°„åˆ° DTO
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**å•†å“åˆ—è¡¨æŸ¥è¯¢**ï¼ˆ3 å¤©ï¼‰

- [ ] å®ç° `ShopService.ListShopItemsAsync`
  - æŸ¥è¯¢æŒ‡å®šå•†åº—çš„å•†å“
  - è¿‡æ»¤è§’è‰²ç­‰çº§
  - è®¡ç®—è´­ä¹°çŠ¶æ€ï¼ˆå·²è´­æ¬¡æ•°ã€å‰©ä½™æ¬¡æ•°ï¼‰
  - é™„åŠ ä»·æ ¼æ˜¾ç¤ºæ–‡æœ¬
  - åˆ†é¡µæ”¯æŒ
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**è´­ä¹°éªŒè¯å™¨**ï¼ˆ4 å¤©ï¼‰

- [ ] å®ç° `PurchaseValidator.ValidatePurchaseAsync`
  - å•†åº—å’Œå•†å“å¯ç”¨æ€§æ£€æŸ¥
  - ç­‰çº§è¦æ±‚æ£€æŸ¥
  - é‡‘å¸æ£€æŸ¥ï¼ˆ`CheckCurrencyAsync`ï¼‰
  - ç‰©å“å…‘æ¢æ£€æŸ¥
  - åº“å­˜é™åˆ¶æ£€æŸ¥
  - è´­ä¹°é™åˆ¶æ£€æŸ¥ï¼ˆ`CheckPurchaseLimitAsync`ï¼‰
- [ ] å®ç°å‘¨æœŸé”®ç”Ÿæˆé€»è¾‘ï¼ˆDaily/Weekly/Totalï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆè¾¹ç•Œæ¡ä»¶ï¼‰
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**è´­ä¹°æµç¨‹**ï¼ˆ3 å¤©ï¼‰

- [ ] å®ç° `ShopService.PurchaseItemAsync`
  - äº‹åŠ¡ç®¡ç†
  - è°ƒç”¨éªŒè¯å™¨
  - æ‰£é™¤è´§å¸ï¼ˆé‡‘å¸ï¼‰
  - æ·»åŠ ç‰©å“åˆ°èƒŒåŒ…ï¼ˆè°ƒç”¨ `InventoryService`ï¼‰
  - è®°å½•è´­ä¹°å†å²
  - æ›´æ–°è´­ä¹°è®¡æ•°å™¨
  - æ›´æ–°å•†å“åº“å­˜ï¼ˆå¦‚æœæœ‰é™åˆ¶ï¼‰
  - é”™è¯¯å¤„ç†å’Œå›æ»š
- [ ] å®ç° `DeductCurrencyAsync` è¾…åŠ©æ–¹æ³•
- [ ] å®ç° `AddItemToInventoryAsync` è¾…åŠ©æ–¹æ³•
- [ ] å®ç° `UpdatePurchaseCounterAsync` è¾…åŠ©æ–¹æ³•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

#### 1.2.3 éªŒæ”¶æ ‡å‡†

- [ ] å¯ä»¥æˆåŠŸæŸ¥è¯¢å•†åº—åˆ—è¡¨
- [ ] å¯ä»¥æˆåŠŸæŸ¥è¯¢å•†å“åˆ—è¡¨ï¼ˆåŒ…å«è´­ä¹°çŠ¶æ€ï¼‰
- [ ] å¯ä»¥æˆåŠŸè´­ä¹°å•†å“ï¼ˆé‡‘å¸äº¤æ˜“ï¼‰
- [ ] éªŒè¯è§„åˆ™å…¨éƒ¨ç”Ÿæ•ˆ
- [ ] äº‹åŠ¡æ­£ç¡®å›æ»šï¼ˆæµ‹è¯•å¤±è´¥åœºæ™¯ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡

---

### 1.3 Phase 3: é«˜çº§åŠŸèƒ½ï¼ˆWeek 5-6ï¼Œ8-10 å·¥ä½œæ—¥ï¼‰

#### 1.3.1 ç›®æ ‡

å®ç°è´­ä¹°å†å²ã€ç‰©å“å…‘æ¢ã€åº“å­˜ç®¡ç†ç­‰é«˜çº§åŠŸèƒ½ã€‚

#### 1.3.2 å·¥ä½œå†…å®¹

**è´­ä¹°å†å²æŸ¥è¯¢**ï¼ˆ2 å¤©ï¼‰

- [ ] å®ç° `ShopService.GetPurchaseHistoryAsync`
  - æŒ‰è§’è‰² ID æŸ¥è¯¢
  - æŒ‰å•†åº— ID ç­›é€‰ï¼ˆå¯é€‰ï¼‰
  - æŒ‰æ—¶é—´èŒƒå›´ç­›é€‰
  - åˆ†é¡µæ”¯æŒ
  - æ˜ å°„åˆ° DTO
- [ ] å®ç° `GET /api/shop/purchase-history` ç«¯ç‚¹
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**ç‰©å“å…‘æ¢æ”¯æŒ**ï¼ˆ3 å¤©ï¼‰

- [ ] æ‰©å±• `CheckCurrencyAsync` æ”¯æŒç‰©å“å…‘æ¢
- [ ] å®ç°ç‰©å“æ‰£å‡é€»è¾‘
- [ ] åˆ›å»ºç‰©å“å…‘æ¢çš„æµ‹è¯•åœºæ™¯
- [ ] æ·»åŠ å¤šè´§å¸äº¤æ˜“çš„ç§å­æ•°æ®
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**åº“å­˜é™åˆ¶ç®¡ç†**ï¼ˆ2 å¤©ï¼‰

- [ ] å®ç°åº“å­˜æ‰£å‡é€»è¾‘
- [ ] å®ç°åº“å­˜è¡¥å……æ¥å£ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
- [ ] å¹¶å‘è´­ä¹°çš„åº“å­˜æ§åˆ¶ï¼ˆä¹è§‚é”ï¼‰
- [ ] ç¼–å†™å‹åŠ›æµ‹è¯•

**è´­ä¹°è®¡æ•°å™¨æ¸…ç†**ï¼ˆ2 å¤©ï¼‰

- [ ] å®ç°è¿‡æœŸè®¡æ•°å™¨æ¸…ç†æœåŠ¡
  ```csharp
  public class PurchaseCounterCleanupService : BackgroundService
  {
      // å®šæœŸæ¸…ç†è¿‡æœŸçš„ Daily/Weekly è®¡æ•°å™¨
  }
  ```
- [ ] é…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨æ‰§è¡Œï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**å¹‚ç­‰æ€§æ”¯æŒ**ï¼ˆ1 å¤©ï¼‰

- [ ] å®ç°å¹‚ç­‰æ€§é”®æ£€æŸ¥
- [ ] é˜²æ­¢é‡å¤è´­ä¹°
- [ ] ç¼–å†™æµ‹è¯•

#### 1.3.3 éªŒæ”¶æ ‡å‡†

- [ ] å¯ä»¥æŸ¥è¯¢è´­ä¹°å†å²
- [ ] æ”¯æŒç‰©å“å…‘æ¢äº¤æ˜“
- [ ] åº“å­˜é™åˆ¶æ­£ç¡®ç”Ÿæ•ˆ
- [ ] å¹¶å‘è´­ä¹°ä¸ä¼šè¶…å–ï¼ˆå‹åŠ›æµ‹è¯•ï¼‰
- [ ] è´­ä¹°è®¡æ•°å™¨å®šæœŸæ¸…ç†
- [ ] å¹‚ç­‰æ€§ä¿æŠ¤ç”Ÿæ•ˆ

---

### 1.4 Phase 4: å‰ç«¯é›†æˆï¼ˆWeek 7ï¼Œ5-7 å·¥ä½œæ—¥ï¼‰

#### 1.4.1 ç›®æ ‡

å®ç°å‰ç«¯å•†åº— UI å’Œäº¤äº’é€»è¾‘ï¼ˆå¯é€‰ï¼Œå–å†³äºæ˜¯å¦æœ‰å‰ç«¯éœ€æ±‚ï¼‰ã€‚

#### 1.4.2 å·¥ä½œå†…å®¹

**API å®¢æˆ·ç«¯æ‰©å±•**ï¼ˆ1 å¤©ï¼‰

- [ ] åœ¨ `ApiClient.cs` ä¸­æ·»åŠ å•†åº— API æ–¹æ³•
  ```csharp
  public async Task<ListShopsResponse> ListShopsAsync(Guid characterId);
  public async Task<ListShopItemsResponse> ListShopItemsAsync(string shopId, Guid characterId);
  public async Task<PurchaseResponse> PurchaseItemAsync(PurchaseRequest request);
  ```

**å•†åº—åˆ—è¡¨é¡µé¢**ï¼ˆ2 å¤©ï¼‰

- [ ] åˆ›å»º `ShopList.razor` ç»„ä»¶
- [ ] æ˜¾ç¤ºå•†åº—å¡ç‰‡
- [ ] å¤„ç†è§£é”çŠ¶æ€æ˜¾ç¤º
- [ ] å¯¼èˆªåˆ°å•†å“é¡µé¢

**å•†å“åˆ—è¡¨é¡µé¢**ï¼ˆ2 å¤©ï¼‰

- [ ] åˆ›å»º `ShopItems.razor` ç»„ä»¶
- [ ] æ˜¾ç¤ºå•†å“åˆ—è¡¨
- [ ] æ˜¾ç¤ºä»·æ ¼å’Œåº“å­˜
- [ ] æ˜¾ç¤ºè´­ä¹°é™åˆ¶çŠ¶æ€
- [ ] è´­ä¹°æŒ‰é’®å’Œæ•°é‡é€‰æ‹©

**è´­ä¹°ç¡®è®¤å¯¹è¯æ¡†**ï¼ˆ1 å¤©ï¼‰

- [ ] åˆ›å»º `PurchaseConfirmDialog.razor` ç»„ä»¶
- [ ] æ˜¾ç¤ºå•†å“è¯¦æƒ…å’Œä»·æ ¼
- [ ] ç¡®è®¤è´­ä¹°æ“ä½œ
- [ ] å¤„ç†è´­ä¹°ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥æç¤ºï¼‰

#### 1.4.3 éªŒæ”¶æ ‡å‡†

- [ ] å‰ç«¯å¯ä»¥æ˜¾ç¤ºå•†åº—åˆ—è¡¨
- [ ] å‰ç«¯å¯ä»¥æ˜¾ç¤ºå•†å“åˆ—è¡¨
- [ ] å‰ç«¯å¯ä»¥æ‰§è¡Œè´­ä¹°æ“ä½œ
- [ ] é”™è¯¯æç¤ºå‹å¥½

---

### 1.5 Phase 5: æ¡ä»¶è§£é”é€‚é…ï¼ˆWeek 8+ï¼ŒæŒ‰éœ€å®æ–½ï¼‰

#### 1.5.1 ç›®æ ‡

ä¸ºæœªæ¥çš„æ¡ä»¶è§£é”ç³»ç»Ÿé¢„ç•™æ¥å£ï¼Œå®ç°åŸºç¡€çš„æ¡ä»¶æ£€æŸ¥ã€‚

#### 1.5.2 å·¥ä½œå†…å®¹

**æ¡ä»¶æ£€æŸ¥å™¨æ¥å£**ï¼ˆé¢„ç•™ï¼‰

```csharp
public interface IConditionChecker
{
    Task<bool> EvaluateAsync(string expression, Character character, CancellationToken ct);
    Task<string?> GetUnlockHintAsync(string expression, Character character, CancellationToken ct);
}

// åˆæ­¥å®ç°ï¼ˆä»…æ”¯æŒç®€å•æ¡ä»¶ï¼‰
public class BasicConditionChecker : IConditionChecker
{
    public Task<bool> EvaluateAsync(string expression, Character character, CancellationToken ct)
    {
        // æ”¯æŒç®€å•çš„ç­‰çº§æ£€æŸ¥ï¼šlevel>=10
        // æ”¯æŒç®€å•çš„é‡‘å¸æ£€æŸ¥ï¼šgold>=1000
        // å…¶ä»–æ¡ä»¶è¿”å› trueï¼ˆæš‚ä¸é™åˆ¶ï¼‰
    }
}
```

**å•†åº—è§£é”æ£€æŸ¥**

- [ ] åœ¨ `ListShopsAsync` ä¸­é›†æˆ `IConditionChecker`
- [ ] åœ¨ `ListShopItemsAsync` ä¸­é›†æˆ `IConditionChecker`

#### 1.5.3 éªŒæ”¶æ ‡å‡†

- [ ] åŸºç¡€æ¡ä»¶æ£€æŸ¥ç”Ÿæ•ˆï¼ˆç­‰çº§ã€é‡‘å¸ï¼‰
- [ ] æ¥å£ä¸º DSL å¼•æ“é¢„ç•™æ‰©å±•ç©ºé—´

---

## æµ‹è¯•ç­–ç•¥

### 2.1 å•å…ƒæµ‹è¯•

#### 2.1.1 æµ‹è¯•èŒƒå›´

**é¢†åŸŸæ¨¡å‹æµ‹è¯•**

```csharp
// BlazorIdle.Tests/Domain/Shop/ShopItemTests.cs
public class ShopItemTests
{
    [Fact]
    public void GetPrice_ShouldDeserializeCorrectly()
    {
        var item = new ShopItem
        {
            PriceJson = "{\"currencyType\":0,\"amount\":100}"
        };
        
        var price = item.GetPrice();
        
        Assert.Equal(CurrencyType.Gold, price.CurrencyType);
        Assert.Equal(100, price.Amount);
    }
    
    [Fact]
    public void GetPurchaseLimit_ShouldReturnNullWhenEmpty()
    {
        var item = new ShopItem { PurchaseLimitJson = null };
        
        var limit = item.GetPurchaseLimit();
        
        Assert.Null(limit);
    }
}
```

**éªŒè¯å™¨æµ‹è¯•**

```csharp
// BlazorIdle.Tests/Application/Shop/PurchaseValidatorTests.cs
public class PurchaseValidatorTests
{
    [Fact]
    public async Task ValidatePurchase_ShouldFailWhenInsufficientGold()
    {
        // Arrange
        var character = new Character { Gold = 50, Level = 10 };
        var item = new ShopItem
        {
            PriceJson = "{\"currencyType\":0,\"amount\":100}",
            RequiredLevel = 1,
            IsEnabled = true
        };
        item.Shop = new ShopDefinition { IsEnabled = true };
        
        var validator = new PurchaseValidator(_mockContext.Object);
        
        // Act
        var result = await validator.ValidatePurchaseAsync(character, item, 1);
        
        // Assert
        Assert.False(result.IsValid);
        Assert.Contains("é‡‘å¸ä¸è¶³", result.ErrorMessage);
    }
    
    [Fact]
    public async Task ValidatePurchase_ShouldFailWhenLevelTooLow()
    {
        // Arrange
        var character = new Character { Gold = 1000, Level = 5 };
        var item = new ShopItem
        {
            PriceJson = "{\"currencyType\":0,\"amount\":100}",
            RequiredLevel = 10,
            IsEnabled = true
        };
        item.Shop = new ShopDefinition { IsEnabled = true };
        
        var validator = new PurchaseValidator(_mockContext.Object);
        
        // Act
        var result = await validator.ValidatePurchaseAsync(character, item, 1);
        
        // Assert
        Assert.False(result.IsValid);
        Assert.Contains("ç­‰çº§ä¸è¶³", result.ErrorMessage);
    }
    
    [Theory]
    [InlineData(PurchaseLimitType.Daily, 3, 5, true)]   // å‰©ä½™ 2 æ¬¡ï¼Œè´­ä¹° 5 æ¬¡ï¼Œå¤±è´¥
    [InlineData(PurchaseLimitType.Daily, 3, 2, false)]  // å‰©ä½™ 2 æ¬¡ï¼Œè´­ä¹° 2 æ¬¡ï¼ŒæˆåŠŸ
    public async Task ValidatePurchase_ShouldCheckPurchaseLimit(
        PurchaseLimitType limitType,
        int currentCount,
        int quantity,
        bool shouldFail)
    {
        // æµ‹è¯•è´­ä¹°é™åˆ¶é€»è¾‘
    }
}
```

**æœåŠ¡å±‚æµ‹è¯•**

```csharp
// BlazorIdle.Tests/Application/Shop/ShopServiceTests.cs
public class ShopServiceTests
{
    [Fact]
    public async Task PurchaseItem_ShouldSucceed_WhenValidationPasses()
    {
        // Arrange
        var request = new PurchaseRequest
        {
            CharacterId = Guid.NewGuid(),
            ShopId = "general_shop",
            ItemId = Guid.NewGuid(),
            Quantity = 1
        };
        
        // Mock éªŒè¯å™¨è¿”å›æˆåŠŸ
        _mockValidator.Setup(v => v.ValidatePurchaseAsync(It.IsAny<Character>(), 
            It.IsAny<ShopItem>(), It.IsAny<int>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(ValidationResult.Success());
        
        var service = new ShopService(_context, _mockValidator.Object, _logger.Object);
        
        // Act
        var result = await service.PurchaseItemAsync(request);
        
        // Assert
        Assert.True(result.Success);
        Assert.NotNull(result.Result);
    }
    
    [Fact]
    public async Task PurchaseItem_ShouldRollback_WhenExceptionOccurs()
    {
        // æµ‹è¯•äº‹åŠ¡å›æ»š
    }
}
```

#### 2.1.2 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ |
|------|-----------|
| Domain Models | 90%+ |
| Validators | 85%+ |
| Service Layer | 80%+ |
| Controllers | 70%+ |

### 2.2 é›†æˆæµ‹è¯•

#### 2.2.1 æµ‹è¯•åœºæ™¯

**å®Œæ•´è´­ä¹°æµç¨‹æµ‹è¯•**

```csharp
// BlazorIdle.Tests/Integration/ShopIntegrationTests.cs
public class ShopIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
{
    [Fact]
    public async Task PurchaseFlow_EndToEnd_ShouldSucceed()
    {
        // Arrange
        var client = _factory.CreateClient();
        var character = await CreateTestCharacter(gold: 1000);
        
        // Act 1: è·å–å•†åº—åˆ—è¡¨
        var shopsResponse = await client.GetAsync($"/api/shop/list?characterId={character.Id}");
        shopsResponse.EnsureSuccessStatusCode();
        var shops = await shopsResponse.Content.ReadFromJsonAsync<ListShopsResponse>();
        
        Assert.NotEmpty(shops.Shops);
        
        // Act 2: è·å–å•†å“åˆ—è¡¨
        var itemsResponse = await client.GetAsync(
            $"/api/shop/{shops.Shops[0].Id}/items?characterId={character.Id}");
        itemsResponse.EnsureSuccessStatusCode();
        var items = await itemsResponse.Content.ReadFromJsonAsync<ListShopItemsResponse>();
        
        Assert.NotEmpty(items.Items);
        var item = items.Items[0];
        
        // Act 3: è´­ä¹°å•†å“
        var purchaseRequest = new PurchaseRequest
        {
            CharacterId = character.Id,
            ShopId = shops.Shops[0].Id,
            ItemId = item.ItemId,
            Quantity = 1
        };
        
        var purchaseResponse = await client.PostAsJsonAsync("/api/shop/purchase", purchaseRequest);
        purchaseResponse.EnsureSuccessStatusCode();
        var purchaseResult = await purchaseResponse.Content.ReadFromJsonAsync<PurchaseResponse>();
        
        // Assert
        Assert.True(purchaseResult.Success);
        Assert.True(purchaseResult.Result.RemainingGold < 1000);
        
        // Verify database state
        var updatedCharacter = await GetCharacter(character.Id);
        Assert.True(updatedCharacter.Gold < 1000);
        
        var inventoryItem = await GetInventoryItem(character.Id, item.ItemDefinitionId);
        Assert.NotNull(inventoryItem);
        Assert.Equal(1, inventoryItem.Quantity);
    }
    
    [Fact]
    public async Task PurchaseFlow_ShouldFailWhenInsufficientGold()
    {
        // æµ‹è¯•é‡‘å¸ä¸è¶³åœºæ™¯
    }
    
    [Fact]
    public async Task PurchaseFlow_ShouldRespectDailyLimit()
    {
        // æµ‹è¯•æ¯æ—¥é™åˆ¶
    }
}
```

### 2.3 æ€§èƒ½æµ‹è¯•

#### 2.3.1 æµ‹è¯•åœºæ™¯

**å¹¶å‘è´­ä¹°æµ‹è¯•**

```csharp
[Fact]
public async Task ConcurrentPurchase_LimitedStock_ShouldNotOversell()
{
    // åœºæ™¯ï¼š10 ä¸ªç”¨æˆ·åŒæ—¶è´­ä¹°åº“å­˜ä»… 5 çš„å•†å“
    // é¢„æœŸï¼šåªæœ‰ 5 ä¸ªè´­ä¹°æˆåŠŸï¼Œå…¶ä½™å¤±è´¥
    
    var item = await CreateItemWithStock(stockLimit: 5, currentStock: 5);
    var tasks = new List<Task<PurchaseResponse>>();
    
    for (int i = 0; i < 10; i++)
    {
        var character = await CreateTestCharacter();
        tasks.Add(PurchaseItemAsync(character, item));
    }
    
    var results = await Task.WhenAll(tasks);
    
    var successCount = results.Count(r => r.Success);
    Assert.Equal(5, successCount);
    
    var finalStock = await GetItemStock(item.Id);
    Assert.Equal(0, finalStock);
}
```

**æŸ¥è¯¢æ€§èƒ½æµ‹è¯•**

```csharp
[Fact]
public async Task ListShopItems_With1000Items_ShouldCompleteInUnder100ms()
{
    // åˆ›å»º 1000 ä¸ªå•†å“
    await SeedItemsAsync(count: 1000);
    
    var stopwatch = Stopwatch.StartNew();
    var result = await _service.ListShopItemsAsync("test_shop", characterId, 1, 50);
    stopwatch.Stop();
    
    Assert.True(stopwatch.ElapsedMilliseconds < 100);
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### 3.1 æ•°æ®åº“ä¼˜åŒ–

#### 3.1.1 ç´¢å¼•ç­–ç•¥

```sql
-- å·²åˆ›å»ºçš„ç´¢å¼•ï¼ˆè§ä¸­ç¯‡ï¼‰
CREATE INDEX IX_ShopItems_ShopId ON shop_items (ShopId);
CREATE INDEX IX_PurchaseRecords_CharacterId ON purchase_records (CharacterId);
CREATE INDEX IX_PurchaseCounters_CharacterId_ShopItemId ON purchase_counters (CharacterId, ShopItemId, PeriodKey);

-- å¯èƒ½éœ€è¦çš„å¤åˆç´¢å¼•
CREATE INDEX IX_ShopItems_ShopId_IsEnabled_SortOrder 
ON shop_items (ShopId, IsEnabled, SortOrder);

CREATE INDEX IX_PurchaseRecords_CharacterId_PurchasedAt 
ON purchase_records (CharacterId, PurchasedAt DESC);
```

#### 3.1.2 æŸ¥è¯¢ä¼˜åŒ–

**ä½¿ç”¨ AsNoTracking**

```csharp
// æŸ¥è¯¢å•†å“åˆ—è¡¨ï¼ˆåªè¯»æ“ä½œï¼‰
var items = await _context.ShopItems
    .AsNoTracking()
    .Where(i => i.ShopId == shopId && i.IsEnabled)
    .OrderBy(i => i.SortOrder)
    .ToListAsync(ct);
```

**æ‰¹é‡åŠ è½½**

```csharp
// é¢„åŠ è½½å…³è”æ•°æ®
var items = await _context.ShopItems
    .Include(i => i.Shop)
    .Where(i => i.ShopId == shopId)
    .ToListAsync(ct);
```

### 3.2 ç¼“å­˜ç­–ç•¥

#### 3.2.1 å•†åº—å®šä¹‰ç¼“å­˜

```csharp
public class CachedShopService : IShopService
{
    private readonly IShopService _innerService;
    private readonly IMemoryCache _cache;
    
    public async Task<ListShopsResponse> ListShopsAsync(
        Guid characterId,
        bool includeDisabled,
        CancellationToken ct = default)
    {
        // å•†åº—å®šä¹‰å˜åŒ–ä¸é¢‘ç¹ï¼Œå¯ä»¥ç¼“å­˜ 5 åˆ†é’Ÿ
        var cacheKey = $"shops_{characterId}_{includeDisabled}";
        
        if (_cache.TryGetValue(cacheKey, out ListShopsResponse cached))
            return cached;
        
        var result = await _innerService.ListShopsAsync(characterId, includeDisabled, ct);
        
        _cache.Set(cacheKey, result, TimeSpan.FromMinutes(5));
        
        return result;
    }
}
```

#### 3.2.2 å•†å“åˆ—è¡¨ç¼“å­˜

```csharp
// å•†å“åˆ—è¡¨å¯ä»¥ç¼“å­˜ 1-2 åˆ†é’Ÿ
var cacheKey = $"shop_items_{shopId}_{characterId}_{page}_{pageSize}";
var options = new MemoryCacheEntryOptions()
    .SetAbsoluteExpiration(TimeSpan.FromMinutes(2));

_cache.Set(cacheKey, result, options);
```

### 3.3 å¹¶å‘æ§åˆ¶

#### 3.3.1 ä¹è§‚é”ï¼ˆåº“å­˜æ‰£å‡ï¼‰

```csharp
public class ShopItem
{
    // æ·»åŠ  RowVersion å­—æ®µ
    [Timestamp]
    public byte[]? RowVersion { get; set; }
}

// è´­ä¹°æ—¶æ£€æŸ¥å¹¶å‘å†²çª
try
{
    await _context.SaveChangesAsync(ct);
}
catch (DbUpdateConcurrencyException)
{
    // åº“å­˜å·²è¢«å…¶ä»–è¯·æ±‚ä¿®æ”¹ï¼Œè´­ä¹°å¤±è´¥
    return CreateErrorResponse("å•†å“åº“å­˜ä¸è¶³æˆ–å·²è¢«æŠ¢è´­");
}
```

---

## ç›‘æ§ä¸è¿ç»´

### 4.1 æ—¥å¿—è®°å½•

#### 4.1.1 å…³é”®æ—¥å¿—ç‚¹

```csharp
// è´­ä¹°æˆåŠŸ
_logger.LogInformation(
    "Character {CharacterId} purchased {Quantity}x {ItemId} from shop {ShopId} for {Price}",
    characterId, quantity, itemId, shopId, totalPrice);

// è´­ä¹°å¤±è´¥ï¼ˆéªŒè¯ï¼‰
_logger.LogWarning(
    "Purchase validation failed for character {CharacterId}, item {ItemId}: {Reason}",
    characterId, itemId, validationResult.ErrorMessage);

// è´­ä¹°å¤±è´¥ï¼ˆå¼‚å¸¸ï¼‰
_logger.LogError(ex,
    "Failed to purchase item {ItemId} for character {CharacterId}",
    itemId, characterId);

// åº“å­˜è€—å°½
_logger.LogWarning(
    "Item {ItemId} in shop {ShopId} is out of stock",
    itemId, shopId);
```

### 4.2 æŒ‡æ ‡æ”¶é›†

#### 4.2.1 å…³é”®æŒ‡æ ‡

```csharp
public class ShopMetrics
{
    public static readonly Counter<long> PurchaseTotal = 
        Meter.CreateCounter<long>("shop.purchase.total");
    
    public static readonly Counter<long> PurchaseSuccess = 
        Meter.CreateCounter<long>("shop.purchase.success");
    
    public static readonly Counter<long> PurchaseFailed = 
        Meter.CreateCounter<long>("shop.purchase.failed");
    
    public static readonly Histogram<double> PurchaseDuration = 
        Meter.CreateHistogram<double>("shop.purchase.duration", "ms");
    
    public static readonly Gauge<int> LowStockItems = 
        Meter.CreateGauge<int>("shop.low_stock_items");
}

// ä½¿ç”¨
ShopMetrics.PurchaseTotal.Add(1, new KeyValuePair<string, object>("shop_id", shopId));
ShopMetrics.PurchaseSuccess.Add(1);
ShopMetrics.PurchaseDuration.Record(stopwatch.ElapsedMilliseconds);
```

### 4.3 å¥åº·æ£€æŸ¥

```csharp
public class ShopHealthCheck : IHealthCheck
{
    private readonly GameDbContext _context;
    
    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context,
        CancellationToken cancellationToken = default)
    {
        try
        {
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥æŸ¥è¯¢å•†åº—
            var shopCount = await _context.ShopDefinitions.CountAsync(cancellationToken);
            
            if (shopCount == 0)
                return HealthCheckResult.Degraded("No shops available");
            
            return HealthCheckResult.Healthy($"{shopCount} shops available");
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy("Shop system is unavailable", ex);
        }
    }
}

// æ³¨å†Œ
builder.Services.AddHealthChecks()
    .AddCheck<ShopHealthCheck>("shop_system");
```

---

## é£é™©ç®¡ç†

### 5.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ | é«˜ | ä½ | åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯ï¼›ä¿ç•™å›æ»šè„šæœ¬ |
| å¹¶å‘è´­ä¹°è¶…å– | é«˜ | ä¸­ | ä½¿ç”¨ä¹è§‚é”ï¼›ç¼–å†™å‹åŠ›æµ‹è¯• |
| æ€§èƒ½ä¸è¾¾æ ‡ | ä¸­ | ä¸­ | æå‰æ€§èƒ½æµ‹è¯•ï¼›ä½¿ç”¨ç¼“å­˜ |
| äº‹åŠ¡æ­»é” | ä¸­ | ä½ | æ§åˆ¶äº‹åŠ¡èŒƒå›´ï¼›è®¾ç½®è¶…æ—¶ |

### 5.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| æ¸¸æˆç»æµå¤±è¡¡ | é«˜ | ä¸­ | ç›‘æ§è´§å¸æµå…¥æµå‡ºï¼›å¯è°ƒæ•´ä»·æ ¼ |
| ç©å®¶åˆ·é‡‘ | é«˜ | ä¸­ | è´­ä¹°é™åˆ¶ï¼›å¼‚å¸¸æ£€æµ‹ |
| åº“å­˜é…ç½®é”™è¯¯ | ä¸­ | ä½ | ç§å­æ•°æ®æ ¡éªŒï¼›ç®¡ç†åå° |

### 5.3 åº”æ€¥é¢„æ¡ˆ

**æ•°æ®å›æ»š**

```bash
# å¦‚æœè¿ç§»å‡ºç°é—®é¢˜ï¼Œå›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
dotnet ef database update <PreviousMigrationName>
```

**ä¸´æ—¶ç¦ç”¨å•†åº—**

```sql
-- ç´§æ€¥æƒ…å†µä¸‹ç¦ç”¨æ‰€æœ‰å•†åº—
UPDATE shop_definitions SET IsEnabled = 0;

-- ç¦ç”¨ç‰¹å®šå•†å“
UPDATE shop_items SET IsEnabled = 0 WHERE ItemId = 'problematic_item';
```

---

## äº¤ä»˜æ¸…å•

### 6.1 ä»£ç äº¤ä»˜

#### 6.1.1 æ–°å¢æ–‡ä»¶

**åç«¯ä»£ç **ï¼ˆçº¦ 20 ä¸ªæ–‡ä»¶ï¼‰

```
BlazorIdle.Server/
â”œâ”€â”€ Domain/Shop/                          [æ–°å¢ç›®å½•]
â”‚   â”œâ”€â”€ ShopDefinition.cs                 [æ–°å¢]
â”‚   â”œâ”€â”€ ShopItem.cs                       [æ–°å¢]
â”‚   â”œâ”€â”€ PurchaseRecord.cs                 [æ–°å¢]
â”‚   â”œâ”€â”€ PurchaseCounter.cs                [æ–°å¢]
â”‚   â””â”€â”€ ValueObjects/                     [æ–°å¢ç›®å½•]
â”‚       â”œâ”€â”€ Price.cs                      [æ–°å¢]
â”‚       â””â”€â”€ PurchaseLimit.cs              [æ–°å¢]
â”œâ”€â”€ Application/
â”‚   â”œâ”€â”€ Abstractions/
â”‚   â”‚   â”œâ”€â”€ IShopService.cs               [æ–°å¢]
â”‚   â”‚   â””â”€â”€ IPurchaseValidator.cs         [æ–°å¢]
â”‚   â””â”€â”€ Shop/                             [æ–°å¢ç›®å½•]
â”‚       â”œâ”€â”€ ShopService.cs                [æ–°å¢]
â”‚       â”œâ”€â”€ PurchaseValidator.cs          [æ–°å¢]
â”‚       â””â”€â”€ PurchaseCounterCleanupService.cs [æ–°å¢]
â”œâ”€â”€ Infrastructure/Persistence/
â”‚   â”œâ”€â”€ Configurations/
â”‚   â”‚   â””â”€â”€ ShopConfiguration.cs          [æ–°å¢]
â”‚   â””â”€â”€ ShopSeedData.cs                   [æ–°å¢]
â”œâ”€â”€ Infrastructure/Persistence/Migrations/
â”‚   â””â”€â”€ <timestamp>_AddShopSystem.cs      [ç”Ÿæˆ]
â””â”€â”€ Api/
    â””â”€â”€ ShopController.cs                 [æ–°å¢]
```

**å…±äº« DTO**ï¼ˆçº¦ 8 ä¸ªæ–‡ä»¶ï¼‰

```
BlazorIdle.Shared/
â””â”€â”€ Dtos/Shop/                            [æ–°å¢ç›®å½•]
    â”œâ”€â”€ ShopDto.cs                        [æ–°å¢]
    â”œâ”€â”€ ShopItemDto.cs                    [æ–°å¢]
    â”œâ”€â”€ PriceDto.cs                       [æ–°å¢]
    â”œâ”€â”€ PurchaseLimitDto.cs               [æ–°å¢]
    â”œâ”€â”€ PurchaseRequest.cs                [æ–°å¢]
    â”œâ”€â”€ PurchaseResponse.cs               [æ–°å¢]
    â”œâ”€â”€ ListShopsResponse.cs              [æ–°å¢]
    â””â”€â”€ PurchaseHistoryResponse.cs        [æ–°å¢]
```

**æµ‹è¯•ä»£ç **ï¼ˆçº¦ 10 ä¸ªæ–‡ä»¶ï¼‰

```
BlazorIdle.Tests/
â”œâ”€â”€ Domain/Shop/
â”‚   â””â”€â”€ ShopItemTests.cs                  [æ–°å¢]
â”œâ”€â”€ Application/Shop/
â”‚   â”œâ”€â”€ ShopServiceTests.cs               [æ–°å¢]
â”‚   â””â”€â”€ PurchaseValidatorTests.cs         [æ–°å¢]
â””â”€â”€ Integration/
    â””â”€â”€ ShopIntegrationTests.cs           [æ–°å¢]
```

#### 6.1.2 ä¿®æ”¹æ–‡ä»¶

```
BlazorIdle.Server/
â”œâ”€â”€ Infrastructure/Persistence/
â”‚   â””â”€â”€ GameDbContext.cs                  [ä¿®æ”¹ï¼šæ·»åŠ  DbSet]
â””â”€â”€ Application/
    â””â”€â”€ DependencyInjection.cs            [ä¿®æ”¹ï¼šæ³¨å†ŒæœåŠ¡]
```

### 6.2 æ–‡æ¡£äº¤ä»˜

#### 6.2.1 è®¾è®¡æ–‡æ¡£

- [x] å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸Šç¯‡ï¼‰- ç³»ç»Ÿåˆ†æä¸æ€»ä½“æ¶æ„
- [x] å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰- è¯¦ç»†è®¾è®¡ä¸å®ç°è§„èŒƒ
- [x] å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰- å®æ–½æ–¹æ¡ˆä¸äº¤ä»˜

#### 6.2.2 API æ–‡æ¡£

**ä½ç½®**ï¼š`docs/å•†åº—ç³»ç»ŸAPIæ–‡æ¡£.md`

```markdown
# å•†åº—ç³»ç»Ÿ API æ–‡æ¡£

## ç«¯ç‚¹æ¦‚è§ˆ

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/shop/list` | GET | è·å–å•†åº—åˆ—è¡¨ |
| `/api/shop/{id}/items` | GET | è·å–å•†å“åˆ—è¡¨ |
| `/api/shop/purchase` | POST | è´­ä¹°å•†å“ |
| `/api/shop/purchase-history` | GET | è·å–è´­ä¹°å†å² |

## è¯¦ç»†è¯´æ˜

### GET /api/shop/list
...

### POST /api/shop/purchase
...
```

#### 6.2.3 ç”¨æˆ·æ‰‹å†Œ

**ä½ç½®**ï¼š`docs/å•†åº—ç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ.md`

```markdown
# å•†åº—ç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ

## ç©å®¶æŒ‡å—

### å¦‚ä½•æµè§ˆå•†åº—
1. æ‰“å¼€å•†åº—åˆ—è¡¨é¡µé¢
2. é€‰æ‹©ä¸€ä¸ªå•†åº—è¿›å…¥
3. æµè§ˆå•†å“åˆ—è¡¨

### å¦‚ä½•è´­ä¹°å•†å“
1. é€‰æ‹©å•†å“
2. è¾“å…¥è´­ä¹°æ•°é‡
3. ç‚¹å‡»"è´­ä¹°"æŒ‰é’®
4. ç¡®è®¤è´­ä¹°ä¿¡æ¯
5. ç­‰å¾…è´­ä¹°å®Œæˆ

## ç®¡ç†å‘˜æŒ‡å—

### å¦‚ä½•æ·»åŠ æ–°å•†åº—
...

### å¦‚ä½•æ·»åŠ æ–°å•†å“
...
```

### 6.3 æ•°æ®åº“äº¤ä»˜

#### 6.3.1 è¿ç§»è„šæœ¬

```bash
# ç”Ÿæˆè¿ç§»
dotnet ef migrations add AddShopSystem

# åº”ç”¨è¿ç§»
dotnet ef database update
```

#### 6.3.2 ç§å­æ•°æ®

- [x] 3 ä¸ªåˆå§‹å•†åº—å®šä¹‰
- [x] è‡³å°‘ 20 ä¸ªåˆå§‹å•†å“
- [x] è¦†ç›–å„ç§å•†å“ç±»å‹å’Œä»·æ ¼ç­–ç•¥

### 6.4 æµ‹è¯•äº¤ä»˜

#### 6.4.1 æµ‹è¯•æŠ¥å‘Š

**ä½ç½®**ï¼š`tests/å•†åº—ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š.md`

```markdown
# å•†åº—ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ¦‚è§ˆ

- å•å…ƒæµ‹è¯•æ•°é‡ï¼š45
- å•å…ƒæµ‹è¯•é€šè¿‡ç‡ï¼š100%
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼š82%

- é›†æˆæµ‹è¯•æ•°é‡ï¼š15
- é›†æˆæµ‹è¯•é€šè¿‡ç‡ï¼š100%

- æ€§èƒ½æµ‹è¯•æ•°é‡ï¼š5
- æ€§èƒ½æµ‹è¯•é€šè¿‡ç‡ï¼š100%

## è¯¦ç»†æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•
...

### é›†æˆæµ‹è¯•
...

### æ€§èƒ½æµ‹è¯•
...
```

#### 6.4.2 æµ‹è¯•ç”¨ä¾‹

| ç±»åˆ« | ç”¨ä¾‹æ•° | çŠ¶æ€ |
|------|--------|------|
| é¢†åŸŸæ¨¡å‹æµ‹è¯• | 10 | âœ… |
| éªŒè¯å™¨æµ‹è¯• | 15 | âœ… |
| æœåŠ¡å±‚æµ‹è¯• | 20 | âœ… |
| API æµ‹è¯• | 10 | âœ… |
| é›†æˆæµ‹è¯• | 15 | âœ… |
| æ€§èƒ½æµ‹è¯• | 5 | âœ… |

### 6.5 éƒ¨ç½²äº¤ä»˜

#### 6.5.1 éƒ¨ç½²æ¸…å•

- [ ] æ•°æ®åº“è¿ç§»å·²åº”ç”¨
- [ ] ç§å­æ•°æ®å·²æ’å…¥
- [ ] API ç«¯ç‚¹å·²éƒ¨ç½²
- [ ] å¥åº·æ£€æŸ¥å·²é…ç½®
- [ ] æ—¥å¿—è®°å½•å·²é…ç½®
- [ ] ç›‘æ§æŒ‡æ ‡å·²é…ç½®

#### 6.5.2 é…ç½®æ–‡ä»¶

**appsettings.json** æ–°å¢é…ç½®ï¼ˆå¯é€‰ï¼‰

```json
{
  "Shop": {
    "EnablePurchaseLimit": true,
    "DefaultCacheMinutes": 5,
    "CleanupSchedule": "0 0 * * *"  // æ¯å¤©å‡Œæ™¨æ¸…ç†
  }
}
```

---

## éªŒæ”¶æ ‡å‡†

### 7.1 åŠŸèƒ½éªŒæ”¶

- [ ] **å•†åº—åˆ—è¡¨æŸ¥è¯¢**
  - [ ] å¯ä»¥æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„å•†åº—
  - [ ] å•†åº—è§£é”çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
  - [ ] å“åº”æ—¶é—´ < 100ms

- [ ] **å•†å“åˆ—è¡¨æŸ¥è¯¢**
  - [ ] å¯ä»¥æŸ¥è¯¢æŒ‡å®šå•†åº—çš„å•†å“
  - [ ] å•†å“è¿‡æ»¤æ­£ç¡®ï¼ˆç­‰çº§ã€è§£é”æ¡ä»¶ï¼‰
  - [ ] è´­ä¹°çŠ¶æ€æ­£ç¡®æ˜¾ç¤ºï¼ˆå·²è´­æ¬¡æ•°ã€å‰©ä½™æ¬¡æ•°ï¼‰
  - [ ] æ”¯æŒåˆ†é¡µ
  - [ ] å“åº”æ—¶é—´ < 100ms

- [ ] **è´­ä¹°åŠŸèƒ½**
  - [ ] é‡‘å¸äº¤æ˜“æˆåŠŸ
  - [ ] ç‰©å“å…‘æ¢æˆåŠŸ
  - [ ] åº“å­˜æ­£ç¡®æ‰£å‡
  - [ ] è´­ä¹°è®°å½•æ­£ç¡®åˆ›å»º
  - [ ] è´­ä¹°è®¡æ•°å™¨æ­£ç¡®æ›´æ–°
  - [ ] å“åº”æ—¶é—´ < 200ms

- [ ] **è´­ä¹°éªŒè¯**
  - [ ] ç­‰çº§é™åˆ¶ç”Ÿæ•ˆ
  - [ ] é‡‘å¸ä¸è¶³æ‹’ç»
  - [ ] ç‰©å“ä¸è¶³æ‹’ç»
  - [ ] è´­ä¹°é™åˆ¶ç”Ÿæ•ˆï¼ˆDaily/Weekly/Totalï¼‰
  - [ ] åº“å­˜é™åˆ¶ç”Ÿæ•ˆ

- [ ] **è´­ä¹°å†å²**
  - [ ] å¯ä»¥æŸ¥è¯¢å†å²è®°å½•
  - [ ] æ”¯æŒæŒ‰å•†åº—ç­›é€‰
  - [ ] æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ç­›é€‰
  - [ ] æ”¯æŒåˆ†é¡µ

### 7.2 è´¨é‡éªŒæ”¶

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡
- [ ] æ—  P0/P1 Bug
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£å®Œæ•´

### 7.3 å®‰å…¨éªŒæ”¶

- [ ] æ‰€æœ‰ API éœ€è¦è®¤è¯
- [ ] è¾“å…¥éªŒè¯å®Œæ•´
- [ ] SQL æ³¨å…¥é˜²æŠ¤
- [ ] å¹¶å‘æ§åˆ¶æ­£ç¡®
- [ ] äº‹åŠ¡å›æ»šæ­£ç¡®

---

## åç»­æ‰©å±•è§„åˆ’

### 8.1 çŸ­æœŸæ‰©å±•ï¼ˆPhase 6-7ï¼‰

1. **ç‰¹æ®Šè´§å¸ç³»ç»Ÿ**
   - å®ç°å¤šç§ç‰¹æ®Šè´§å¸ï¼ˆè£èª‰ç‚¹ã€ç«æŠ€åœºå¸ç­‰ï¼‰
   - è´§å¸è½¬æ¢æœºåˆ¶

2. **é™æ—¶å•†åº—**
   - å®šæ—¶å¼€æ”¾å•†åº—
   - å•†å“è½®æ¢æœºåˆ¶
   - é™æ—¶æŠ˜æ‰£

3. **æ‰¹é‡è´­ä¹°ä¼˜æƒ **
   - æ‰¹é‡è´­ä¹°ä»·æ ¼æŠ˜æ‰£
   - æ‰¹é‡è´­ä¹°é™åˆ¶

### 8.2 ä¸­æœŸæ‰©å±•ï¼ˆPhase 8-10ï¼‰

4. **å£°æœ›å•†åº—**
   - ä¸å£°æœ›ç³»ç»Ÿé›†æˆ
   - å£°æœ›ç­‰çº§è§£é”

5. **åŠ¨æ€å®šä»·**
   - æ ¹æ®ä¾›éœ€è°ƒæ•´ä»·æ ¼
   - å­£èŠ‚æ€§ä»·æ ¼å˜åŒ–

6. **å›è´­ç³»ç»Ÿ**
   - ç©å®¶å¯å›è´­è¯¯å–ç‰©å“
   - å›è´­ä»·æ ¼æŠ˜æ‰£

### 8.3 é•¿æœŸæ‰©å±•ï¼ˆPhase 11+ï¼‰

7. **æ‹å–è¡Œ**
   - ç©å®¶é—´äº¤æ˜“
   - æ‹å–æœºåˆ¶
   - ç¨æ”¶ç³»ç»Ÿ

8. **å•†äºº NPC**
   - ç§»åŠ¨å•†äºº
   - éšæœºå•†å“åˆ·æ–°
   - è®¨ä»·è¿˜ä»·æœºåˆ¶

---

## æ€»ç»“

### é¡¹ç›®è¯„ä¼°

**å®æ–½å‘¨æœŸ**ï¼š6-8 å‘¨

**å·¥ä½œé‡ä¼°ç®—**ï¼š
- Phase 1ï¼ˆåŸºç¡€æ¡†æ¶ï¼‰ï¼š10-12 å·¥ä½œæ—¥
- Phase 2ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ï¼š10-12 å·¥ä½œæ—¥
- Phase 3ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰ï¼š8-10 å·¥ä½œæ—¥
- Phase 4ï¼ˆå‰ç«¯é›†æˆï¼‰ï¼š5-7 å·¥ä½œæ—¥ï¼ˆå¯é€‰ï¼‰
- Phase 5ï¼ˆæ¡ä»¶é€‚é…ï¼‰ï¼šæŒ‰éœ€

**æ€»è®¡**ï¼šçº¦ **35-45 å·¥ä½œæ—¥**ï¼ˆå•äººï¼‰

### äº¤ä»˜ä»·å€¼

1. **ç»æµç³»ç»Ÿå®Œå–„**ï¼šä¸ºæ¸¸æˆæä¾›é‡è¦çš„è´§å¸æ¶ˆè€—æ¸ é“
2. **ç©æ³•æ·±åº¦æå‡**ï¼šé€šè¿‡è´­ä¹°é™åˆ¶ã€é™æ—¶å•†å“å¢åŠ ç­–ç•¥æ€§
3. **å¯æ‰©å±•æ€§**ï¼šä¸ºæœªæ¥æ¡ä»¶è§£é”ã€å£°æœ›ç³»ç»Ÿç­‰åŠŸèƒ½é¢„ç•™æ¥å£
4. **ä»£ç è´¨é‡**ï¼šç»´æŒç°æœ‰ä»£ç é£æ ¼ï¼Œæµ‹è¯•è¦†ç›–å……åˆ†

### æˆåŠŸè¦ç´ 

- âœ… **æ¸…æ™°çš„æ¶æ„è®¾è®¡**ï¼šåˆ†å±‚æ¶æ„ï¼ŒèŒè´£æ˜ç¡®
- âœ… **å®Œå–„çš„æµ‹è¯•ç­–ç•¥**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
- âœ… **è¯¦ç»†çš„å®æ–½æ–¹æ¡ˆ**ï¼šåˆ†é˜¶æ®µå®æ–½ï¼Œé£é™©å¯æ§
- âœ… **å®Œæ•´çš„æ–‡æ¡£äº¤ä»˜**ï¼šè®¾è®¡æ–‡æ¡£ã€API æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… ä¸‹ç¯‡å®Œæˆ  
**æ•´ä½“æ–‡æ¡£çŠ¶æ€**ï¼šâœ… ä¸‰ç¯‡å®Œæˆ  
**å‡†å¤‡è¿›å…¥å®æ–½é˜¶æ®µ**
