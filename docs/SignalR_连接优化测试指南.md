# SignalR 连接优化测试指南

**创建日期**: 2025-10-14  
**版本**: 1.0  
**状态**: 待测试

---

## 📋 概述

本文档提供了 SignalR 连接时机优化后的测试指南，用于验证 SignalR 连接在登录后自动建立并保持的功能。

---

## 🎯 测试目标

1. **验证连接时机**: SignalR 应在登录成功后立即连接
2. **验证连接保持**: 连接应在整个会话期间保持
3. **验证事件推送**: 战斗事件应能正确推送到前端
4. **验证断线重连**: 网络中断后应能自动重连
5. **验证登出清理**: 登出时应正确断开连接

---

## 🧪 测试场景

### 场景 1: 登录后自动连接

**测试步骤**:
1. 打开浏览器开发者工具（F12）→ Console 标签
2. 访问应用登录页面 `/login`
3. 输入用户名和密码
4. 点击"登录"按钮
5. 观察控制台输出

**预期结果**:
```
[SignalR] 认证成功，正在连接...
[SignalR] 连接成功，实时通知已启用
```

**通知显示**:
- 应显示绿色 Toast 通知："✅ 实时通知已启用"

**验证方法**:
- 在 Network 标签中应看到 WebSocket 连接到 `/hubs/battle`
- 连接状态应为 "101 Switching Protocols"

---

### 场景 2: 战斗事件推送

**测试步骤**:
1. 登录后确保 SignalR 已连接
2. 创建一个角色（如果没有）
3. 开始一场 Step 战斗（选择敌人，设置战斗时间）
4. 观察控制台和通知

**预期结果**:

当玩家死亡时:
```
[SignalR] 收到事件: PlayerDeath, BattleId: {guid}
```
- 显示警告通知："💀 角色死亡 - 5秒后复活"

当玩家复活时:
```
[SignalR] 收到事件: PlayerRevive, BattleId: {guid}
```
- 显示成功通知："✨ 角色已复活"

当击杀敌人时:
```
[SignalR] 收到事件: EnemyKilled, BattleId: {guid}
```
- 显示成功通知："⚔️ 击杀敌人"

当目标切换时:
```
[SignalR] 收到事件: TargetSwitched, BattleId: {guid}
```
- 显示信息通知："🎯 目标切换"

**验证方法**:
- 事件应实时到达（延迟 <1s）
- 战斗状态应立即更新（不等待轮询周期）

---

### 场景 3: 连接保持

**测试步骤**:
1. 登录并确保 SignalR 已连接
2. 在页面停留 5 分钟（不进行任何操作）
3. 开始一场战斗
4. 观察是否仍能收到事件

**预期结果**:
- WebSocket 连接应保持活跃
- 战斗事件应能正常推送
- 不应出现重新连接的日志

**验证方法**:
- 在 Network 标签中检查 WebSocket 连接仍处于打开状态
- Frame 标签应看到周期性的 ping/pong 消息

---

### 场景 4: 断线重连

**测试步骤**:
1. 登录并确保 SignalR 已连接
2. 在开发者工具 Network 标签中：
   - 找到 `/hubs/battle` 的 WebSocket 连接
   - 右键 → "Close"（模拟断线）
3. 观察控制台输出
4. 等待重连完成
5. 开始战斗验证事件推送

**预期结果**:
```
[SignalR] SignalR reconnecting...
[SignalR] SignalR reconnected: {connectionId}
```

**重连策略**:
- 第1次重连: 1秒后
- 第2次重连: 2秒后
- 第3次重连: 4秒后
- 第4次重连: 8秒后
- 第5次重连: 16秒后
- 最多重连 5 次

**验证方法**:
- 重连应自动进行
- 重连成功后事件推送应恢复正常

---

### 场景 5: 登出清理

**测试步骤**:
1. 登录并确保 SignalR 已连接
2. 点击右上角的"登出"按钮
3. 观察控制台输出
4. 在 Network 标签中检查 WebSocket 状态

**预期结果**:
```
[SignalR] 登出，断开连接
```

**验证方法**:
- WebSocket 连接应被关闭
- 不应有重连尝试
- 页面应重定向到登录页

---

### 场景 6: 降级策略（SignalR 不可用）

**测试步骤**:
1. 修改 `wwwroot/appsettings.json`:
   ```json
   "SignalR": {
     "EnableSignalR": false,
     ...
   }
   ```
2. 刷新页面并登录
3. 观察控制台和通知
4. 开始战斗

**预期结果**:
```
[SignalR] SignalR is disabled in configuration
```
- 显示信息通知："ℹ️ 使用轮询模式"

**验证方法**:
- 不应尝试建立 WebSocket 连接
- 战斗功能应正常工作（使用轮询）
- 战斗状态应通过轮询更新（延迟略高）

---

### 场景 7: 多次登录/登出

**测试步骤**:
1. 登录 → 确认 SignalR 连接
2. 登出 → 确认断开
3. 重复步骤 1-2 共 3 次
4. 每次都验证连接状态

**预期结果**:
- 每次登录都应成功连接
- 每次登出都应正确断开
- 不应有内存泄漏或连接泄漏

**验证方法**:
- 检查浏览器内存使用（不应持续增长）
- 检查 Network 标签中的连接数量

---

## 🔍 调试技巧

### 1. 控制台日志过滤

在 Console 标签中输入过滤器：
```
[SignalR]
```

这样只显示 SignalR 相关的日志。

### 2. 查看 WebSocket 消息

1. 打开 Network 标签
2. 过滤器选择 "WS"（WebSocket）
3. 点击 `/hubs/battle` 连接
4. 切换到 "Messages" 标签
5. 可以看到所有发送和接收的消息

### 3. 启用详细日志

修改 `wwwroot/appsettings.json`:
```json
"SignalR": {
  "EnableDetailedLogging": true,
  ...
}
```

这会在控制台显示更详细的 SignalR 调试信息。

---

## ✅ 验收标准

### 功能验收

- [ ] 登录后 SignalR 自动连接（场景 1）
- [ ] 战斗事件能正确推送（场景 2）
- [ ] 连接能保持 5 分钟以上（场景 3）
- [ ] 断线后能自动重连（场景 4）
- [ ] 登出时正确断开连接（场景 5）
- [ ] SignalR 禁用时能降级到轮询（场景 6）
- [ ] 多次登录登出无异常（场景 7）

### 性能验收

- [ ] 事件通知延迟 <1s (P99)
- [ ] 重连成功率 >95%
- [ ] 无内存泄漏
- [ ] 无连接泄漏

### 用户体验验收

- [ ] 登录成功显示友好通知
- [ ] 战斗事件有清晰的图标和文字
- [ ] SignalR 不可用时不影响核心功能
- [ ] 错误信息清晰易懂

---

## 🐛 已知问题和限制

### 当前限制

1. **配置更新**: 修改 `appsettings.json` 后需要刷新页面才能生效
2. **浏览器支持**: 需要支持 WebSocket 的现代浏览器
3. **网络环境**: 某些企业网络可能阻止 WebSocket 连接

### 预期行为

1. **首次连接失败**: 如果服务器未启动，会显示警告但不影响登录
2. **重连上限**: 最多重连 5 次后停止，需要刷新页面重新连接
3. **心跳超时**: 30 秒无活动会关闭连接，但会自动重连

---

## 📝 测试报告模板

### 测试信息

- **测试日期**: 
- **测试人员**: 
- **浏览器**: 
- **操作系统**: 
- **服务器版本**: 

### 测试结果

| 场景 | 测试结果 | 备注 |
|------|---------|------|
| 场景 1: 登录后自动连接 | ☐ 通过 ☐ 失败 | |
| 场景 2: 战斗事件推送 | ☐ 通过 ☐ 失败 | |
| 场景 3: 连接保持 | ☐ 通过 ☐ 失败 | |
| 场景 4: 断线重连 | ☐ 通过 ☐ 失败 | |
| 场景 5: 登出清理 | ☐ 通过 ☐ 失败 | |
| 场景 6: 降级策略 | ☐ 通过 ☐ 失败 | |
| 场景 7: 多次登录登出 | ☐ 通过 ☐ 失败 | |

### 性能指标

- **平均事件延迟**: ___ ms
- **P99 事件延迟**: ___ ms
- **重连成功率**: ___%
- **内存使用（5分钟后）**: ___ MB

### 问题和建议

（在此记录测试中发现的问题和改进建议）

---

## 🔗 相关文档

- [SignalR优化进度更新.md](./SignalR优化进度更新.md) - 进度跟踪
- [SignalR前端集成方案.md](./SignalR前端集成方案.md) - 集成设计
- [SignalR配置优化指南.md](./SignalR配置优化指南.md) - 配置说明

---

**创建人**: GitHub Copilot Agent  
**创建日期**: 2025-10-14  
**下次更新**: 测试完成后
