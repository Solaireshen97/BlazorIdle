# ç¦»çº¿æˆ˜æ–—å‰ç«¯é›†æˆå®æ–½è¯´æ˜

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ç¦»çº¿æˆ˜æ–—ç³»ç»Ÿç¬¬å››æ­¥ï¼ˆå‰ç«¯é›†æˆï¼‰çš„å®æ–½è¿‡ç¨‹å’ŒæŠ€æœ¯ç»†èŠ‚ã€‚

## å®æ–½å†…å®¹

### 1. APIå®¢æˆ·ç«¯æ‰©å±• (ApiClient.cs)

#### æ–°å¢æ–¹æ³•

```csharp
// æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
public Task<OfflineCheckResult?> CheckOfflineAsync(Guid characterId, CancellationToken ct = default)

// åº”ç”¨ç¦»çº¿ç»“ç®—
public async Task ApplyOfflineSettlementAsync(Guid characterId, OfflineFastForwardResult settlement, CancellationToken ct = default)

// æ›´æ–°å¿ƒè·³
public async Task UpdateHeartbeatAsync(Guid characterId, CancellationToken ct = default)
```

#### æ–°å¢DTOç±»å‹

```csharp
// ç¦»çº¿æ£€æŸ¥ç»“æœ
public sealed class OfflineCheckResult
{
    public bool HasOfflineTime { get; set; }
    public double OfflineSeconds { get; set; }
    public bool HasRunningPlan { get; set; }
    public OfflineFastForwardResult? Settlement { get; set; }
    public bool PlanCompleted { get; set; }
    public bool NextPlanStarted { get; set; }
    public Guid? NextPlanId { get; set; }
}

// ç¦»çº¿æˆ˜æ–—ç»“æœ
public sealed class OfflineFastForwardResult
{
    public Guid CharacterId { get; set; }
    public Guid PlanId { get; set; }
    public double SimulatedSeconds { get; set; }
    public bool PlanCompleted { get; set; }
    public long TotalDamage { get; set; }
    public int TotalKills { get; set; }
    public long Gold { get; set; }
    public long Exp { get; set; }
    public Dictionary<string, double> LootExpected { get; set; } = new();
    public Dictionary<string, int> LootSampled { get; set; } = new();
    public double UpdatedExecutedSeconds { get; set; }
    public string DropMode { get; set; } = "expected";
}

// åº”ç”¨ç¦»çº¿ç»“ç®—è¯·æ±‚
public record ApplyOfflineSettlementRequest(
    Guid CharacterId,
    OfflineFastForwardResult Settlement
);
```

### 2. ç¦»çº¿ç»“ç®—å¼¹çª—ç»„ä»¶ (OfflineSettlementDialog.razor)

#### åŠŸèƒ½ç‰¹æ€§

- **è‡ªåŠ¨å¼¹å‡ºæ˜¾ç¤º**ï¼šå½“æ£€æµ‹åˆ°ç¦»çº¿æ”¶ç›Šæ—¶è‡ªåŠ¨æ˜¾ç¤º
- **ç¾è§‚çš„UIè®¾è®¡**ï¼šä½¿ç”¨æ¸å˜è‰²èƒŒæ™¯å’Œå¡ç‰‡å¼å¸ƒå±€
- **å®Œæ•´çš„ä¿¡æ¯å±•ç¤º**ï¼š
  - ç¦»çº¿æ—¶é•¿ï¼ˆæ ¼å¼åŒ–ä¸ºå°æ—¶/åˆ†é’Ÿ/ç§’ï¼‰
  - é‡‘å¸æ”¶ç›Šï¼ˆç»¿è‰²é«˜äº®æ˜¾ç¤ºï¼‰
  - ç»éªŒæ”¶ç›Šï¼ˆç»¿è‰²é«˜äº®æ˜¾ç¤ºï¼‰
  - å‡»æ€æ•°é‡
  - ç‰©å“æ‰è½åˆ—è¡¨ï¼ˆæ”¯æŒexpectedå’Œsampledæ¨¡å¼ï¼‰
  - è®¡åˆ’çŠ¶æ€ï¼ˆå®Œæˆ/ç»§ç»­æ‰§è¡Œï¼‰
  - è‡ªåŠ¨è¡”æ¥æç¤º
- **ç”¨æˆ·äº¤äº’**ï¼š
  - å¿…é¡»ç‚¹å‡»"ç¡®è®¤é¢†å–"æŒ‰é’®æ‰èƒ½å…³é—­
  - ç‚¹å‡»é®ç½©å±‚ä¸ä¼šå…³é—­å¯¹è¯æ¡†ï¼ˆç¡®ä¿ç”¨æˆ·çœ‹åˆ°æ”¶ç›Šï¼‰
  - å¤„ç†ä¸­çŠ¶æ€æç¤ºï¼ˆé˜²æ­¢é‡å¤æäº¤ï¼‰

#### æ ¸å¿ƒä»£ç 

```csharp
@if (Result?.HasOfflineTime == true && Result.Settlement != null)
{
    <div class="offline-dialog-overlay" @onclick="OnOverlayClick">
        <div class="offline-dialog" @onclick:stopPropagation="true">
            <!-- å¯¹è¯æ¡†å†…å®¹ -->
        </div>
    </div>
}

@code {
    [Parameter]
    public OfflineCheckResult? Result { get; set; }

    [Parameter]
    public EventCallback OnClaim { get; set; }

    private async Task OnClaimClicked()
    {
        if (IsProcessing) return;
        IsProcessing = true;
        try
        {
            await OnClaim.InvokeAsync();
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private string FormatDuration(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.TotalHours >= 1)
            return $"{(int)ts.TotalHours}å°æ—¶{ts.Minutes}åˆ†é’Ÿ";
        else if (ts.TotalMinutes >= 1)
            return $"{(int)ts.TotalMinutes}åˆ†é’Ÿ{ts.Seconds}ç§’";
        else
            return $"{(int)ts.TotalSeconds}ç§’";
    }
}
```

### 3. Charactersé¡µé¢é›†æˆ (Characters.razor)

#### æ–°å¢çŠ¶æ€ç®¡ç†

```csharp
// ç¦»çº¿æˆ˜æ–—çŠ¶æ€
private OfflineCheckResult? offlineCheckResult;
private DateTime lastHeartbeatUpdate = DateTime.MinValue;
```

#### ç™»å½•æ—¶ç¦»çº¿æ£€æŸ¥

```csharp
async Task LoadUserDataAsync()
{
    // ... ç°æœ‰ä»£ç  ...
    
    // å¦‚æœæœ‰è§’è‰²ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
    if (userCharacters.Count > 0 && selectedCharacter is null)
    {
        selectedCharacter = userCharacters[0];
        lastCreated = new CharacterCreated(selectedCharacter.Id, selectedCharacter.Name);
        
        // æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
        await CheckOfflineRewardsAsync();
    }
}
```

#### ç¦»çº¿æ”¶ç›Šæ£€æŸ¥å’Œåº”ç”¨

```csharp
/// <summary>
/// æ£€æŸ¥ç¦»çº¿æ”¶ç›Šï¼ˆåœ¨è§’è‰²åŠ è½½æ—¶è‡ªåŠ¨è°ƒç”¨ï¼‰
/// </summary>
private async Task CheckOfflineRewardsAsync()
{
    if (selectedCharacter is null) return;

    try
    {
        // æ›´æ–°å¿ƒè·³æ—¶é—´
        await UpdateHeartbeatIfNeededAsync();

        // æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
        offlineCheckResult = await Api.CheckOfflineAsync(selectedCharacter.Id);
        
        // å¦‚æœæœ‰ç¦»çº¿æ”¶ç›Šï¼Œå¼¹çª—ä¼šè‡ªåŠ¨æ˜¾ç¤º
        if (offlineCheckResult?.HasOfflineTime == true)
        {
            await InvokeAsync(StateHasChanged);
        }
    }
    catch (Exception ex)
    {
        userMessage = $"æ£€æŸ¥ç¦»çº¿æ”¶ç›Šå¤±è´¥: {ex.Message}";
    }
}

/// <summary>
/// åº”ç”¨ç¦»çº¿ç»“ç®—ï¼Œå®é™…å‘æ”¾æ”¶ç›Š
/// </summary>
private async Task ApplyOfflineSettlement()
{
    if (offlineCheckResult?.Settlement is null || selectedCharacter is null) return;

    try
    {
        await Api.ApplyOfflineSettlementAsync(selectedCharacter.Id, offlineCheckResult.Settlement);
        
        // é‡æ–°åŠ è½½ç”¨æˆ·æ•°æ®ä»¥æ›´æ–°é‡‘å¸å’Œç»éªŒæ˜¾ç¤º
        await LoadUserDataAsync();
        
        // åˆ·æ–°è®¡åˆ’åˆ—è¡¨
        await RefreshPlansAsync();
        
        // æ¸…é™¤ç¦»çº¿ç»“ç®—ç»“æœï¼Œå…³é—­å¼¹çª—
        offlineCheckResult = null;
        
        userMessage = "ç¦»çº¿æ”¶ç›Šå·²é¢†å–æˆåŠŸï¼";
        await InvokeAsync(StateHasChanged);
    }
    catch (Exception ex)
    {
        userMessage = $"é¢†å–ç¦»çº¿æ”¶ç›Šå¤±è´¥: {ex.Message}";
    }
}
```

#### å¿ƒè·³æ›´æ–°é›†æˆ

```csharp
/// <summary>
/// æ›´æ–°å¿ƒè·³æ—¶é—´ï¼ˆå¦‚æœéœ€è¦ï¼‰
/// åœ¨è®¡åˆ’ä»»åŠ¡åˆ·æ–°æ—¶ä¹Ÿä¼šè°ƒç”¨ï¼Œå®ç°æ¯2ç§’æ›´æ–°ä¸€æ¬¡
/// </summary>
private async Task UpdateHeartbeatIfNeededAsync()
{
    if (selectedCharacter is null) return;

    // æ¯2ç§’æ›´æ–°ä¸€æ¬¡å¿ƒè·³
    var now = DateTime.UtcNow;
    if ((now - lastHeartbeatUpdate).TotalSeconds < 2)
        return;

    try
    {
        await Api.UpdateHeartbeatAsync(selectedCharacter.Id);
        lastHeartbeatUpdate = now;
    }
    catch
    {
        // å¿ƒè·³æ›´æ–°å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
    }
}

// åœ¨è®¡åˆ’è½®è¯¢å¾ªç¯ä¸­è°ƒç”¨
async Task StartPlanPollingAsync(Guid battleId)
{
    // ...
    while (!_planPollCts.IsCancellationRequested)
    {
        try
        {
            // è·å–æˆ˜æ–—çŠ¶æ€
            currentPlanBattle = await Api.GetStepBattleStatusAsync(battleId, "sampled", _planPollCts.Token);
            
            // åˆ·æ–°è®¡åˆ’åˆ—è¡¨
            if (lastCreated is not null)
            {
                characterPlans = await Api.GetCharacterPlansAsync(lastCreated.Id);
            }
            
            // æ›´æ–°å¿ƒè·³æ—¶é—´ï¼ˆæ¯æ¬¡åˆ·æ–°è®¡åˆ’çŠ¶æ€æ—¶ï¼‰
            await UpdateHeartbeatIfNeededAsync();
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception) { }

        await Task.Delay(2000, _planPollCts.Token);
    }
    // ...
}
```

## æ— æ„Ÿç»§æ‰¿å®ç°åŸç†

### 1. ç¦»çº¿è®¡ç®—ä»å½“å‰è¿›åº¦ç»§ç»­

å½“ç”¨æˆ·ç¦»çº¿æ—¶ï¼Œåç«¯ä¼šï¼š
1. è®°å½•ç¦»çº¿æ—¶é—´ç‚¹ï¼š`LastSeenAtUtc`
2. ä¿å­˜å½“å‰è®¡åˆ’çš„æ‰§è¡ŒçŠ¶æ€ï¼š`ExecutedSeconds`
3. ä¿å­˜å½“å‰æˆ˜æ–—çŠ¶æ€ï¼š`BattleStateJson`

å½“ç”¨æˆ·ä¸Šçº¿æ—¶ï¼š
1. è®¡ç®—ç¦»çº¿æ—¶é•¿ï¼š`Now - LastSeenAtUtc`
2. ä»`ExecutedSeconds`å¼€å§‹ç»§ç»­æ¨¡æ‹Ÿ
3. æ¢å¤æˆ˜æ–—çŠ¶æ€å¿«ç…§ï¼Œç»§æ‰¿æ•Œäººè¡€é‡ç­‰çŠ¶æ€

### 2. åœ¨çº¿ç»§æ‰¿ç¦»çº¿ç»“æœ

å½“ç”¨æˆ·é¢†å–ç¦»çº¿æ”¶ç›Šåï¼š
1. å‰ç«¯ä¸éœ€è¦é‡æ–°å¼€å§‹æˆ˜æ–—
2. æˆ˜æ–—å¼•æ“ä¼šä»`BattleStateJson`æ¢å¤çŠ¶æ€
3. ç»§ç»­ä½¿ç”¨æ›´æ–°åçš„`ExecutedSeconds`
4. å®ç°å®Œå…¨æ— ç¼çš„æˆ˜æ–—ä½“éªŒ

### 3. è®¡åˆ’è‡ªåŠ¨è¡”æ¥

å¦‚æœç¦»çº¿æœŸé—´è®¡åˆ’å®Œæˆï¼š
1. åç«¯è‡ªåŠ¨æ ‡è®°è®¡åˆ’ä¸º`Completed`
2. æŸ¥æ‰¾ä¸‹ä¸€ä¸ª`Pending`çŠ¶æ€çš„è®¡åˆ’
3. è‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªè®¡åˆ’
4. å‰ç«¯å¼¹çª—ä¼šæç¤º"ä¸‹ä¸€ä¸ªè®¡åˆ’å·²è‡ªåŠ¨å¼€å§‹"

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

åˆ›å»ºäº†5ä¸ªå‰ç«¯é›†æˆæµ‹è¯•ï¼ŒéªŒè¯ï¼š
1. DTOåºåˆ—åŒ–å’Œååºåˆ—åŒ–
2. æ— ç¦»çº¿æ—¶é—´åœºæ™¯
3. æœ‰ç¦»çº¿æ”¶ç›Šåœºæ™¯
4. ç‰©å“æ‰è½æ•°æ®
5. è®¡åˆ’å®Œæˆå’Œè‡ªåŠ¨è¡”æ¥

### æµ‹è¯•ç»“æœ

```
Test summary: total: 5, failed: 0, succeeded: 5, skipped: 0, duration: 1.1s
```

## ä½¿ç”¨æµç¨‹

### ç”¨æˆ·åœºæ™¯1ï¼šæ­£å¸¸ç¦»çº¿æ”¶ç›Š

1. ç”¨æˆ·åœ¨æˆ˜æ–—ä¸­ï¼ˆè®¡åˆ’æ‰§è¡Œ30åˆ†é’Ÿï¼‰
2. ç”¨æˆ·å…³é—­æµè§ˆå™¨ï¼ˆç¦»çº¿1å°æ—¶ï¼‰
3. ç”¨æˆ·é‡æ–°ç™»å½•
4. ç³»ç»Ÿè‡ªåŠ¨æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
5. å¼¹çª—æ˜¾ç¤ºï¼š
   - ç¦»çº¿æ—¶é•¿ï¼š1å°æ—¶0åˆ†é’Ÿ
   - é‡‘å¸ï¼š+2000
   - ç»éªŒï¼š+3000
   - å‡»æ€ï¼š60
   - æç¤ºï¼šæ´»åŠ¨è®¡åˆ’ç»§ç»­æ‰§è¡Œä¸­ï¼Œå·²æ‰§è¡Œï¼š1å°æ—¶30åˆ†é’Ÿ
6. ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤é¢†å–"
7. æ”¶ç›Šå‘æ”¾åˆ°è§’è‰²
8. æˆ˜æ–—ç»§ç»­ï¼ˆä»1å°æ—¶30åˆ†é’Ÿçš„è¿›åº¦ç»§ç»­ï¼‰

### ç”¨æˆ·åœºæ™¯2ï¼šè®¡åˆ’å®Œæˆå¹¶è‡ªåŠ¨è¡”æ¥

1. ç”¨æˆ·æœ‰ä¸¤ä¸ªè®¡åˆ’ï¼š
   - è®¡åˆ’1ï¼š2å°æ—¶æˆ˜æ–—ï¼ˆRunningï¼Œå·²æ‰§è¡Œ20åˆ†é’Ÿï¼‰
   - è®¡åˆ’2ï¼š1å°æ—¶æˆ˜æ–—ï¼ˆPendingï¼‰
2. ç”¨æˆ·ç¦»çº¿3å°æ—¶
3. ç”¨æˆ·é‡æ–°ç™»å½•
4. ç³»ç»Ÿæ£€æµ‹åˆ°ï¼š
   - è®¡åˆ’1å·²å®Œæˆï¼ˆæ¨¡æ‹Ÿå‰©ä½™1å°æ—¶40åˆ†é’Ÿï¼‰
   - è®¡åˆ’2å·²è‡ªåŠ¨å¯åŠ¨
5. å¼¹çª—æ˜¾ç¤ºï¼š
   - ç¦»çº¿æ—¶é•¿ï¼š3å°æ—¶0åˆ†é’Ÿ
   - é‡‘å¸ï¼š+5000
   - ç»éªŒï¼š+8000
   - å‡»æ€ï¼š120
   - æç¤ºï¼šâœ… æ´»åŠ¨è®¡åˆ’å·²å®Œæˆ
   - æç¤ºï¼šğŸ”„ ä¸‹ä¸€ä¸ªè®¡åˆ’å·²è‡ªåŠ¨å¼€å§‹
6. ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤é¢†å–"
7. æ”¶ç›Šå‘æ”¾ï¼Œè®¡åˆ’2ç»§ç»­æ‰§è¡Œ

## æŠ€æœ¯äº®ç‚¹

1. **æœ€å°åŒ–æ”¹åŠ¨**ï¼šåªä¿®æ”¹äº†2ä¸ªæ–‡ä»¶ï¼Œæ–°å¢äº†2ä¸ªæ–‡ä»¶
2. **æ— æ„Ÿç»§æ‰¿**ï¼šå®Œå…¨æ— ç¼çš„ç¦»çº¿åˆ°åœ¨çº¿åˆ‡æ¢
3. **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šå¿ƒè·³ã€ç¦»çº¿æ£€æŸ¥ã€æ”¶ç›Šå‘æ”¾éƒ½æ˜¯è‡ªåŠ¨çš„
4. **è‰¯å¥½çš„é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½æœ‰try-catch
5. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼š
   - å¿…é¡»ç‚¹å‡»ç¡®è®¤æ‰èƒ½é¢†å–ï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰
   - æ¸…æ™°çš„çŠ¶æ€æç¤º
   - æ ¼å¼åŒ–çš„æ—¶é—´æ˜¾ç¤º
   - å“åº”å¼è®¾è®¡
6. **å®Œæ•´çš„æµ‹è¯•è¦†ç›–**ï¼š5ä¸ªå•å…ƒæµ‹è¯•éªŒè¯æ ¸å¿ƒåŠŸèƒ½

## åç»­ä¼˜åŒ–å»ºè®®

1. **UIå¢å¼º**ï¼š
   - æ·»åŠ åŠ¨ç”»æ•ˆæœï¼ˆæ·¡å…¥æ·¡å‡ºï¼‰
   - æ·»åŠ éŸ³æ•ˆæç¤º
   - æ”¯æŒæš—è‰²æ¨¡å¼

2. **åŠŸèƒ½æ‰©å±•**ï¼š
   - ç¦»çº¿æ”¶ç›Šå†å²è®°å½•
   - ç¦»çº¿æ”¶ç›Šç»Ÿè®¡å›¾è¡¨
   - ç¦»çº¿æ”¶ç›Šåˆ†äº«åŠŸèƒ½

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å¿ƒè·³å¯ä»¥ä½¿ç”¨WebSocketæ›¿ä»£è½®è¯¢
   - ç¦»çº¿æ£€æŸ¥å¯ä»¥æ·»åŠ ç¼“å­˜
   - å¤§é‡ç‰©å“æ‰è½æ—¶åˆ†é¡µæ˜¾ç¤º

## æ€»ç»“

ç¦»çº¿æˆ˜æ–—å‰ç«¯é›†æˆå·²æˆåŠŸå®ç°ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- âœ… å®Œæ•´çš„åŠŸèƒ½å®ç°
- âœ… è‰¯å¥½çš„ä»£ç è´¨é‡
- âœ… å®Œå–„çš„æµ‹è¯•è¦†ç›–
- âœ… ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ
- âœ… éµå¾ªç°æœ‰ä»£ç è§„èŒƒ
- âœ… æœ€å°åŒ–æ”¹åŠ¨åŸåˆ™

ç³»ç»Ÿå·²ç»å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼Œä¸ºç”¨æˆ·æä¾›æ— ç¼çš„ç¦»çº¿æˆ˜æ–—ä½“éªŒã€‚
