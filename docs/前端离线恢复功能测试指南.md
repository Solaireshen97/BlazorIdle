# 前端离线恢复功能测试指南

## 概述

本文档描述了如何测试前端计划任务状态的离线恢复功能，确保所有任务类型（单怪持续/无限、副本持续/无限）都能正确适配离线恢复功能。

## 功能说明

### 核心功能
1. **离线暂停**: 当玩家离线超过阈值（默认60秒），后台服务会自动暂停正在运行的任务
2. **离线快进**: 玩家上线时，系统会快进模拟离线期间的战斗并发放收益
3. **自动恢复**: 如果任务未完成，系统会自动恢复任务并继续执行
4. **前端轮询**: 前端会自动检测恢复的任务并开始轮询状态更新

### 任务状态说明
- **State = 0 (Pending)**: 待执行 - 黄色文本
- **State = 1 (Running)**: 执行中 - 绿色文本
- **State = 2 (Completed)**: 已完成 - 灰色文本
- **State = 3 (Cancelled)**: 已取消 - 灰色文本
- **State = 4 (Paused)**: 已暂停 - 蓝色文本

## 测试环境准备

### 1. 启动服务器
```bash
cd /home/runner/work/BlazorIdle/BlazorIdle/BlazorIdle.Server
dotnet run
```

### 2. 启动前端
```bash
cd /home/runner/work/BlazorIdle/BlazorIdle/BlazorIdle
dotnet watch run
```

### 3. 配置离线检测阈值（可选）
编辑 `appsettings.json`:
```json
{
  "Offline": {
    "OfflineDetectionSeconds": 60,
    "MaxOfflineSeconds": 43200,
    "EnableAutoSettlement": true
  }
}
```

## 测试场景

### 场景1: 单怪持续模式离线恢复测试

#### 步骤
1. **创建角色**
   - 打开浏览器访问 `http://localhost:5000`
   - 登录账户
   - 创建一个新角色（如果还没有）

2. **创建计划任务**
   - 活动类型：战斗 (Combat)
   - 限制类型：时长限制
   - 时长：300秒（5分钟）
   - 敌人：选择任意敌人（如 Training Dummy）
   - 敌人数：1
   - 点击"创建计划"

3. **等待任务启动**
   - 任务会自动开始执行（State = 1）
   - 观察"当前计划战斗状态"面板，确认DPS、击杀数等数据在更新
   - 等待约10-20秒，确保任务已执行一段时间

4. **模拟离线**
   - 关闭浏览器标签页（不要点击登出）
   - 等待至少70秒（超过60秒的离线检测阈值）

5. **验证暂停**（可选，需要数据库访问）
   - 在服务器端查询数据库，确认任务状态已变为 Paused (State = 4)
   - 确认 `BattleStateJson` 字段已保存战斗状态快照

6. **重新上线**
   - 重新打开浏览器并访问应用
   - 登录同一账户

7. **验证离线结算弹窗**
   - 应该看到"欢迎回来！"弹窗
   - 弹窗显示：
     - 离线时长（约70秒）
     - 离线收益（金币、经验、击杀数）
     - 任务状态："▶️ 活动计划继续执行中"
     - 已执行时长（应该包含离线期间的时长）

8. **关闭弹窗并验证轮询**
   - 点击"关闭"按钮
   - 确认任务列表中任务状态为"执行中"（State = 1）
   - 确认"当前计划战斗状态"面板出现并显示实时数据
   - 观察 ExecutedSeconds 持续增加
   - 等待任务完成或手动停止

#### 预期结果
- ✅ 离线期间任务被暂停
- ✅ 上线后显示离线收益弹窗
- ✅ 任务自动恢复执行
- ✅ 前端自动开始轮询任务状态
- ✅ 任务进度无缝衔接，ExecutedSeconds 正确累加

---

### 场景2: 单怪无限模式离线恢复测试

#### 步骤
1. **创建计划任务**
   - 活动类型：战斗 (Combat)
   - 限制类型：**无限制**
   - 敌人：选择任意敌人
   - 敌人数：1
   - 点击"创建计划"

2. **等待任务启动**
   - 任务自动开始执行
   - 等待约10-20秒

3. **模拟离线**
   - 关闭浏览器标签页
   - 等待至少70秒

4. **重新上线**
   - 重新打开浏览器并登录

5. **验证离线结算弹窗**
   - 应该看到离线收益弹窗
   - 任务状态应显示："▶️ 活动计划继续执行中"（因为是无限模式）

6. **关闭弹窗并验证轮询**
   - 点击"关闭"按钮
   - 确认任务状态为"执行中"
   - 确认轮询正常工作
   - **重要**: 因为是无限模式，任务会一直执行，不会自动完成

7. **手动停止任务**
   - 点击"停止"按钮
   - 确认任务状态变为"已完成"

#### 预期结果
- ✅ 无限模式任务可以被离线暂停
- ✅ 上线后任务继续执行
- ✅ 任务不会因离线而完成
- ✅ 可以手动停止任务

---

### 场景3: 副本持续模式离线恢复测试

#### 步骤
1. **创建计划任务**
   - 活动类型：地下城 (Dungeon)
   - 限制类型：时长限制
   - 时长：300秒
   - 地下城ID：intro_cave
   - 循环模式：**不勾选**（单次模式）
   - 点击"创建计划"

2. **等待任务启动**
   - 任务自动开始执行
   - 等待约10-20秒

3. **模拟离线**
   - 关闭浏览器标签页
   - 等待至少70秒

4. **重新上线**
   - 重新打开浏览器并登录

5. **验证离线结算弹窗**
   - 应该看到离线收益弹窗
   - 检查是否显示"活动计划继续执行中"或"活动计划已完成"
   - 注意：如果副本在离线期间完成了，会显示"✅ 活动计划已完成"

6. **关闭弹窗并验证**
   - 点击"关闭"按钮
   - 如果任务未完成：
     - 确认任务状态为"执行中"
     - 确认轮询正常工作
   - 如果任务已完成：
     - 确认任务状态为"已完成"
     - 可以选择删除该任务

#### 预期结果
- ✅ 副本任务可以被离线暂停
- ✅ 离线期间的波次和击杀正确累计
- ✅ 任务恢复后继续当前波次
- ✅ 副本完成时状态正确更新

---

### 场景4: 副本无限模式（循环）离线恢复测试

#### 步骤
1. **创建计划任务**
   - 活动类型：地下城 (Dungeon)
   - 限制类型：**无限制**
   - 地下城ID：intro_cave
   - 循环模式：**勾选**（循环模式）
   - 点击"创建计划"

2. **等待任务启动**
   - 任务自动开始执行
   - 等待副本至少完成一次循环（观察击杀数和波次）
   - 等待约20-30秒

3. **模拟离线**
   - 关闭浏览器标签页
   - 等待至少70秒

4. **重新上线**
   - 重新打开浏览器并登录

5. **验证离线结算弹窗**
   - 应该看到离线收益弹窗
   - 任务状态应显示："▶️ 活动计划继续执行中"
   - 应该能看到多次副本完成的累计收益

6. **关闭弹窗并验证轮询**
   - 点击"关闭"按钮
   - 确认任务状态为"执行中"
   - 确认轮询正常工作
   - 观察副本会不断循环执行

7. **手动停止任务**
   - 点击"停止"按钮
   - 确认任务状态变为"已完成"

#### 预期结果
- ✅ 循环副本任务可以被离线暂停
- ✅ 离线期间的多次副本完成正确累计
- ✅ 任务恢复后继续循环执行
- ✅ 可以手动停止循环任务

---

### 场景5: 暂停状态手动恢复测试

#### 步骤
1. **创建任意计划任务并启动**
   - 选择任意任务类型（战斗或副本）
   - 限制类型可以是时长限制或无限制

2. **模拟离线导致暂停**
   - 等待任务执行10-20秒
   - 关闭浏览器
   - 等待至少70秒

3. **验证暂停状态（需要数据库访问）**
   - 在服务器端查询数据库
   - 确认任务状态为 Paused (State = 4)

4. **重新上线但不关闭弹窗**
   - 重新打开浏览器并登录
   - 看到离线收益弹窗
   - **不要点击关闭按钮**

5. **手动刷新计划列表**
   - 在弹窗外面找到"刷新列表"按钮并点击
   - 观察任务列表

6. **验证暂停状态显示**
   - 任务状态应显示为"已暂停"（蓝色文本）
   - 应该看到"恢复"和"取消"两个按钮

7. **点击恢复按钮**
   - 点击"恢复"按钮
   - 确认任务状态变为"执行中"
   - 确认轮询自动开始
   - 确认"当前计划战斗状态"面板显示并更新

#### 预期结果
- ✅ 暂停状态正确显示为"已暂停"（蓝色）
- ✅ 显示"恢复"和"取消"按钮
- ✅ 点击"恢复"后任务恢复执行
- ✅ 前端自动开始轮询
- ✅ 进度无缝衔接

---

## 故障排查

### 问题1: 离线后任务没有暂停
**可能原因**:
- 离线时间不足60秒
- OfflineDetectionService 服务未启动
- 离线检测阈值配置过大

**解决方案**:
- 确保离线至少70秒
- 检查服务器日志，确认 OfflineDetectionService 正在运行
- 检查 appsettings.json 中的 `OfflineDetectionSeconds` 配置

### 问题2: 上线后没有显示离线收益弹窗
**可能原因**:
- 心跳更新失败
- 离线结算服务未正确配置
- 前端没有正确调用心跳API

**解决方案**:
- 检查浏览器控制台的网络请求
- 确认 `/api/users/heartbeat` 接口正常响应
- 检查服务器日志中的离线结算相关日志

### 问题3: 关闭弹窗后任务没有自动开始轮询
**可能原因**:
- RefreshPlansAsync 方法未正确调用
- 任务状态不是 Running (State = 1)
- BattleId 为空

**解决方案**:
- 检查浏览器控制台的错误信息
- 确认任务状态已恢复为 Running
- 确认 BattleId 字段不为空
- 手动点击"刷新列表"按钮

### 问题4: 任务进度不连续
**可能原因**:
- BattleStateJson 没有正确保存
- FastForward 引擎没有正确恢复战斗状态

**解决方案**:
- 检查数据库中的 BattleStateJson 字段
- 查看服务器日志中的 FastForward 相关日志
- 确认 ExecutedSeconds 字段正确更新

## 性能验证

### 验证点
1. **内存占用**: 暂停的任务不应占用战斗引擎内存
2. **响应速度**: 恢复任务应该在2秒内完成
3. **数据准确性**: 离线期间的收益计算应该准确
4. **轮询频率**: 任务状态轮询应该每2秒执行一次

### 验证方法
- 使用浏览器开发者工具监控网络请求
- 检查服务器端日志中的性能指标
- 对比离线前后的金币、经验、击杀数等数据

## 测试报告模板

```markdown
## 测试报告

### 测试环境
- 日期: YYYY-MM-DD
- 测试人员: [姓名]
- 服务器版本: [版本号]
- 前端版本: [版本号]

### 测试结果

#### 场景1: 单怪持续模式
- [ ] 通过 / [ ] 失败
- 问题描述: 

#### 场景2: 单怪无限模式
- [ ] 通过 / [ ] 失败
- 问题描述: 

#### 场景3: 副本持续模式
- [ ] 通过 / [ ] 失败
- 问题描述: 

#### 场景4: 副本无限模式
- [ ] 通过 / [ ] 失败
- 问题描述: 

#### 场景5: 手动恢复测试
- [ ] 通过 / [ ] 失败
- 问题描述: 

### 发现的问题
1. 
2. 
3. 

### 建议
1. 
2. 
3. 
```

## 总结

通过以上测试场景，可以全面验证前端计划任务状态的离线恢复功能。重点关注：
1. 任务暂停和恢复的状态转换
2. 离线收益的正确计算和显示
3. 前端轮询的自动启动
4. 各种任务类型的兼容性
5. 用户体验的流畅性

确保所有场景都能正常工作后，前端的离线恢复功能即可投入生产使用。
