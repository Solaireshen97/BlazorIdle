# SignalR ä¼˜åŒ–å®Œæˆæ€»ç»“

**é¡¹ç›®**: BlazorIdle SignalR å®æ—¶é€šä¿¡ä¼˜åŒ–  
**å®Œæˆæ—¥æœŸ**: 2025-10-14  
**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œå¾…ç«¯åˆ°ç«¯æµ‹è¯•

---

## ğŸ“‹ é¡¹ç›®ç›®æ ‡

ä¼˜åŒ–å‰ç«¯ SignalR é€šä¿¡ï¼Œå®ç°ï¼š
1. ç™»å½•åè‡ªåŠ¨å»ºç«‹å¹¶ä¿æŒæŒä¹…è¿æ¥
2. æˆ˜æ–—äº‹ä»¶å®æ—¶æ¨é€
3. é…ç½®å‚æ•°åŒ–ï¼Œé¿å…ç¡¬ç¼–ç 
4. å¯æ‰©å±•çš„æ¶æ„è®¾è®¡
5. å®Œå–„çš„æ–‡æ¡£å’Œæµ‹è¯•

---

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. å…³é”®é—®é¢˜ä¿®å¤

#### 1.1 CORS é…ç½®ä¿®å¤ âœ…
**é—®é¢˜**: å‰ç«¯æ— æ³•æ­£å¸¸è¿æ¥ SignalR Hubï¼ˆ401 é”™è¯¯ï¼‰

**åŸå› **: CORS ç­–ç•¥ç¼ºå°‘ `AllowCredentials()`ï¼Œå¯¼è‡´ JWT Token æ— æ³•é€šè¿‡

**è§£å†³æ–¹æ¡ˆ**:
```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowBlazorClient", policy =>
    {
        policy
            .WithOrigins("https://localhost:5001", ...)
            .AllowAnyHeader()
            .AllowAnyMethod()
            .AllowCredentials(); // âš ï¸ å…³é”®ä¿®å¤
    });
});
```

**å½±å“**: ğŸ”´ é«˜ - è¿™æ˜¯å¯¼è‡´è¿æ¥å¤±è´¥çš„æ ¹æœ¬åŸå› 

---

#### 1.2 JWT è®¤è¯å¢å¼º âœ…
**é—®é¢˜**: SignalR æ— æ³•ä»æŸ¥è¯¢å­—ç¬¦ä¸²è·å– JWT Token

**åŸå› **: é»˜è®¤ JWT è®¤è¯åªæ”¯æŒ Authorization Headerï¼Œä¸æ”¯æŒæŸ¥è¯¢å­—ç¬¦ä¸²

**è§£å†³æ–¹æ¡ˆ**:
```csharp
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.Events = new JwtBearerEvents
        {
            OnMessageReceived = context =>
            {
                var accessToken = context.Request.Query["access_token"];
                var path = context.HttpContext.Request.Path;
                
                if (!string.IsNullOrEmpty(accessToken) && 
                    path.StartsWithSegments("/hubs"))
                {
                    context.Token = accessToken;
                }
                return Task.CompletedTask;
            }
        };
    });
```

**å½±å“**: ğŸ”´ é«˜ - SignalR è®¤è¯å¿…éœ€

---

### 2. é…ç½®ä¼˜åŒ–

#### 2.1 é…ç½®æ–‡ä»¶ç»“æ„ âœ…
åˆ›å»ºäº†ç‹¬ç«‹çš„ SignalR é…ç½®æ–‡ä»¶ç»“æ„ï¼š

```
BlazorIdle/wwwroot/config/
â”œâ”€â”€ README.md                       # é…ç½®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ signalr.json                    # åŸºç¡€é…ç½®
â”œâ”€â”€ signalr.Development.json        # å¼€å‘ç¯å¢ƒé…ç½®
â””â”€â”€ signalr.Production.json         # ç”Ÿäº§ç¯å¢ƒé…ç½®
```

#### 2.2 æ–°å¢é…ç½®é¡¹ âœ…
- `AutoReconnect`: æ˜¯å¦è‡ªåŠ¨é‡è¿ï¼ˆé»˜è®¤: trueï¼‰
- `ConnectionStatusNotifications`: æ˜¯å¦æ˜¾ç¤ºè¿æ¥çŠ¶æ€é€šçŸ¥ï¼ˆé»˜è®¤: trueï¼‰

#### 2.3 ç¯å¢ƒå·®å¼‚åŒ–é…ç½® âœ…
- **å¼€å‘ç¯å¢ƒ**: å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼Œæ˜¾ç¤ºæ‰€æœ‰é€šçŸ¥
- **ç”Ÿäº§ç¯å¢ƒ**: ç¦ç”¨è¯¦ç»†æ—¥å¿—ï¼Œå¢åŠ é‡è¿æ¬¡æ•°å’Œå»¶è¿Ÿ

---

### 3. è¿æ¥ç®¡ç†å¢å¼º

#### 3.1 è¿æ¥çŠ¶æ€ç›‘æ§ âœ…
å®ç°äº†å®Œæ•´çš„è¿æ¥çŠ¶æ€ç›‘æ§æœºåˆ¶ï¼š

```csharp
// æœåŠ¡ç«¯
public void OnConnectionStateChanged(Action<string> handler)
{
    _connectionStateHandlers.Add(handler);
}

public string GetConnectionState()
{
    return _connection.State switch
    {
        HubConnectionState.Connected => "å·²è¿æ¥",
        HubConnectionState.Disconnected => "å·²æ–­å¼€",
        HubConnectionState.Connecting => "è¿æ¥ä¸­",
        HubConnectionState.Reconnecting => "é‡è¿ä¸­",
        _ => "æœªçŸ¥"
    };
}

// å®¢æˆ·ç«¯
SignalRService.OnConnectionStateChanged(HandleConnectionStateChanged);

private async void HandleConnectionStateChanged(string state)
{
    _signalRConnectionStatus = state;
    _isSignalRConnected = state == "å·²è¿æ¥";
    
    // æ˜¾ç¤ºå‹å¥½çš„çŠ¶æ€é€šçŸ¥
    switch (state)
    {
        case "å·²è¿æ¥": 
            toastNotification?.ShowSuccess("âœ… SignalR å·²è¿æ¥");
            break;
        case "å·²æ–­å¼€": 
            toastNotification?.ShowWarning("âš ï¸ SignalR å·²æ–­å¼€");
            break;
        case "é‡è¿ä¸­": 
            toastNotification?.ShowInfo("ğŸ”„ SignalR é‡è¿ä¸­...");
            break;
    }
}
```

#### 3.2 æŒä¹…è¿æ¥ç®¡ç† âœ…
- ç™»å½•åç«‹å³å»ºç«‹è¿æ¥
- æ•´ä¸ªä¼šè¯æœŸé—´ä¿æŒè¿æ¥
- æ–­å¼€åè‡ªåŠ¨é‡è¿
- è¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°è½®è¯¢æ¨¡å¼

---

### 4. æ–‡æ¡£å®Œå–„

åˆ›å»ºäº†å®Œæ•´çš„æ–‡æ¡£ä½“ç³»ï¼š

| æ–‡æ¡£ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `SignalRå‰ç«¯é›†æˆæ–¹æ¡ˆ.md` | âœ… æ›´æ–° | é›†æˆæŒ‡å—ï¼ŒåŒ…å«æœ€æ–°å®æ–½è¿›å±• |
| `SignalRä¼˜åŒ–è¿›åº¦æ›´æ–°.md` | âœ… æ›´æ–° | è¿›åº¦è·Ÿè¸ªï¼Œè®°å½•é—®é¢˜ä¿®å¤ |
| `SignalRé…ç½®å®Œæ•´æŒ‡å—.md` | âœ… æ–°å¢ | å…¨é¢çš„é…ç½®æ–‡æ¡£å’Œæœ€ä½³å®è·µ |
| `SignalRç«¯åˆ°ç«¯æµ‹è¯•æŒ‡å—.md` | âœ… æ–°å¢ | è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹å’ŒéªŒæ”¶æ ‡å‡† |
| `SignalRä¼˜åŒ–å®Œæˆæ€»ç»“.md` | âœ… æ–°å¢ | æœ¬æ–‡æ¡£ |
| `wwwroot/config/README.md` | âœ… æ–°å¢ | å®¢æˆ·ç«¯é…ç½®è¯´æ˜ |

---

## ğŸ“Š æŠ€æœ¯æŒ‡æ ‡

### æµ‹è¯•ç»“æœ
- âœ… æ‰€æœ‰ SignalR å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆ51/51ï¼‰
- âœ… æ„å»ºæˆåŠŸï¼ˆ0 é”™è¯¯ï¼‰
- âš ï¸ 5 ä¸ªè­¦å‘Šï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

### æ€§èƒ½ç›®æ ‡
| æŒ‡æ ‡ | ç›®æ ‡å€¼ | çŠ¶æ€ |
|------|--------|------|
| äº‹ä»¶é€šçŸ¥å»¶è¿Ÿ (P99) | < 1s | â³ å¾…ç«¯åˆ°ç«¯æµ‹è¯• |
| è¿æ¥å»ºç«‹æ—¶é—´ | < 5s | â³ å¾…ç«¯åˆ°ç«¯æµ‹è¯• |
| é‡è¿æ—¶é—´ | < 10s | â³ å¾…ç«¯åˆ°ç«¯æµ‹è¯• |
| ç½‘ç»œå¸¦å®½ | < 10 KB/s | â³ å¾…ç«¯åˆ°ç«¯æµ‹è¯• |

---

## ğŸ¯ æ¶æ„æ”¹è¿›

### å¯æ‰©å±•æ€§
1. **é…ç½®é©±åŠ¨**: æ‰€æœ‰å‚æ•°å¯é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´
2. **äº‹ä»¶ç±»å‹æ‰©å±•**: æ”¯æŒæ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹ï¼ˆPhase 3 é¢„ç•™ï¼‰
3. **è¿‡æ»¤å™¨æœºåˆ¶**: æ”¯æŒè‡ªå®šä¹‰äº‹ä»¶è¿‡æ»¤å™¨ï¼ˆå·²å®ç°ä½†æœªå¯ç”¨ï¼‰
4. **æ€§èƒ½ä¼˜åŒ–**: æ”¯æŒèŠ‚æµã€æ‰¹é‡å‘é€ç­‰ä¼˜åŒ–ç­–ç•¥

### å¯ç»´æŠ¤æ€§
1. **æ¸…æ™°çš„ä»£ç ç»“æ„**: æœåŠ¡å±‚ã€é…ç½®å±‚ã€UIå±‚åˆ†ç¦»
2. **å®Œå–„çš„æ—¥å¿—**: è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—
3. **æ–‡æ¡£å®Œæ•´**: ä»é…ç½®åˆ°æµ‹è¯•çš„å…¨æµç¨‹æ–‡æ¡£
4. **é…ç½®åˆ†ç¦»**: ç¯å¢ƒç‰¹å®šé…ç½®ç‹¬ç«‹ç®¡ç†

### å¯é æ€§
1. **è‡ªåŠ¨é‡è¿**: æŒ‡æ•°é€€é¿é‡è¿ç­–ç•¥
2. **é™çº§ç­–ç•¥**: SignalR ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§åˆ°è½®è¯¢
3. **é”™è¯¯å¤„ç†**: å…¨é¢çš„å¼‚å¸¸æ•è·å’Œå¤„ç†
4. **èµ„æºæ¸…ç†**: æ­£ç¡®çš„ Dispose å®ç°

---

## ğŸ”„ å®æ–½æµç¨‹

### Phase 1: é—®é¢˜åˆ†æï¼ˆ1å°æ—¶ï¼‰
- âœ… åˆ†æç°æœ‰ä»£ç 
- âœ… é˜…è¯»ç›¸å…³æ–‡æ¡£
- âœ… è¯†åˆ«å…³é”®é—®é¢˜
- âœ… åˆ¶å®šè§£å†³æ–¹æ¡ˆ

### Phase 2: æ ¸å¿ƒä¿®å¤ï¼ˆ2å°æ—¶ï¼‰
- âœ… ä¿®å¤ CORS é…ç½®
- âœ… å¢å¼º JWT è®¤è¯
- âœ… æµ‹è¯•è¿æ¥åŠŸèƒ½

### Phase 3: åŠŸèƒ½å¢å¼ºï¼ˆ2å°æ—¶ï¼‰
- âœ… æ·»åŠ è¿æ¥çŠ¶æ€ç›‘æ§
- âœ… åˆ›å»ºé…ç½®æ–‡ä»¶ç»“æ„
- âœ… å®ç°ç¯å¢ƒç‰¹å®šé…ç½®

### Phase 4: æ–‡æ¡£å®Œå–„ï¼ˆ1.5å°æ—¶ï¼‰
- âœ… æ›´æ–°é›†æˆæ–¹æ¡ˆæ–‡æ¡£
- âœ… æ›´æ–°è¿›åº¦è·Ÿè¸ªæ–‡æ¡£
- âœ… åˆ›å»ºé…ç½®å®Œæ•´æŒ‡å—
- âœ… åˆ›å»ºæµ‹è¯•æŒ‡å—
- âœ… åˆ›å»ºå®Œæˆæ€»ç»“

### Phase 5: ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆå¾…å®Œæˆï¼‰
- â³ æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
- â³ æ”¶é›†æ€§èƒ½æŒ‡æ ‡
- â³ éªŒè¯å¯é æ€§

---

## ğŸ“ˆ æ”¹è¿›æ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡
1. **å®æ—¶æ€§**: äº‹ä»¶é€šçŸ¥ä»è½®è¯¢å»¶è¿Ÿï¼ˆæœ€å¤š2ç§’ï¼‰é™è‡³ <1ç§’
2. **å¯è§æ€§**: è¿æ¥çŠ¶æ€å®æ—¶æ˜¾ç¤ºï¼Œç”¨æˆ·æ¸…æ¥šç³»ç»ŸçŠ¶æ€
3. **å¯é æ€§**: è‡ªåŠ¨é‡è¿ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
4. **å‹å¥½æ€§**: é™çº§ç­–ç•¥ä¿è¯æ ¸å¿ƒåŠŸèƒ½å§‹ç»ˆå¯ç”¨

### å¼€å‘ä½“éªŒæå‡
1. **é…ç½®åŒ–**: æ— éœ€ä¿®æ”¹ä»£ç å³å¯è°ƒæ•´è¡Œä¸º
2. **å¯è°ƒè¯•**: è¯¦ç»†æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥
3. **å¯æµ‹è¯•**: æ¸…æ™°çš„æµ‹è¯•ç”¨ä¾‹å’ŒéªŒæ”¶æ ‡å‡†
4. **å¯æ‰©å±•**: é¢„ç•™æ‰©å±•ç‚¹ï¼Œä¾¿äºæ·»åŠ æ–°åŠŸèƒ½

---

## âš ï¸ å¾…å®Œæˆä»»åŠ¡

### é«˜ä¼˜å…ˆçº§
- [ ] **ç«¯åˆ°ç«¯æµ‹è¯•**: æ‰§è¡Œå®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆè§æµ‹è¯•æŒ‡å—ï¼‰
- [ ] **æ€§èƒ½éªŒè¯**: éªŒè¯é€šçŸ¥å»¶è¿Ÿæ˜¯å¦æ»¡è¶³ <1s ç›®æ ‡

### ä¸­ä¼˜å…ˆçº§
- [ ] **å¥åº·æ£€æŸ¥**: æ·»åŠ å®šæœŸå¥åº·æ£€æŸ¥æœºåˆ¶
- [ ] **å¿ƒè·³ç›‘æ§**: æ·»åŠ å¿ƒè·³è¶…æ—¶æ£€æµ‹
- [ ] **æ€§èƒ½ç›‘æ§**: æ·»åŠ  Metrics æ”¶é›†å’Œå±•ç¤º

### ä½ä¼˜å…ˆçº§
- [ ] **ç§»åŠ¨ç«¯ä¼˜åŒ–**: é’ˆå¯¹ç§»åŠ¨ç«¯ç½‘ç»œç‰¹æ€§ä¼˜åŒ–
- [ ] **ç¦»çº¿å¤„ç†**: ç¦»çº¿æœŸé—´äº‹ä»¶çš„ç¼“å­˜å’Œé‡æ”¾
- [ ] **UI æ”¹è¿›**: è¿æ¥çŠ¶æ€æ˜¾ç¤º UI ç»„ä»¶åŒ–

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ
1. **é—®é¢˜å®šä½å‡†ç¡®**: é€šè¿‡åˆ†ææ—¥å¿—å’Œç½‘ç»œè¯·æ±‚å¿«é€Ÿå®šä½ CORS é—®é¢˜
2. **é…ç½®ä¼˜å…ˆ**: å…ˆå»ºç«‹é…ç½®ä½“ç³»ï¼Œå†å®ç°åŠŸèƒ½ï¼Œä¾¿äºåç»­ç»´æŠ¤
3. **æ–‡æ¡£åŒæ­¥**: ä»£ç å’Œæ–‡æ¡£åŒæ­¥æ›´æ–°ï¼Œé¿å…é—æ¼
4. **å°æ­¥è¿­ä»£**: æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µå°±æµ‹è¯•å’Œæäº¤ï¼Œé™ä½é£é™©

### æ•™è®­
1. **ä¾èµ–ç†è§£**: éœ€è¦æ·±å…¥ç†è§£ SignalR å’Œ JWT çš„é›†æˆæ–¹å¼
2. **é…ç½®ç»†èŠ‚**: CORSã€JWT ç­‰é…ç½®ç»†èŠ‚å®¹æ˜“é—æ¼ï¼Œéœ€è¦ä»”ç»†æ£€æŸ¥
3. **æµ‹è¯•é‡è¦**: ç«¯åˆ°ç«¯æµ‹è¯•ä¸èƒ½çœç•¥ï¼Œå•å…ƒæµ‹è¯•ä¸èƒ½è¦†ç›–æ‰€æœ‰åœºæ™¯

---

## ğŸ”— ç›¸å…³é“¾æ¥

### æ–‡æ¡£
- [SignalRå‰ç«¯é›†æˆæ–¹æ¡ˆ.md](./SignalRå‰ç«¯é›†æˆæ–¹æ¡ˆ.md)
- [SignalRä¼˜åŒ–è¿›åº¦æ›´æ–°.md](./SignalRä¼˜åŒ–è¿›åº¦æ›´æ–°.md)
- [SignalRé…ç½®å®Œæ•´æŒ‡å—.md](./SignalRé…ç½®å®Œæ•´æŒ‡å—.md)
- [SignalRç«¯åˆ°ç«¯æµ‹è¯•æŒ‡å—.md](./SignalRç«¯åˆ°ç«¯æµ‹è¯•æŒ‡å—.md)
- [wwwroot/config/README.md](../BlazorIdle/wwwroot/config/README.md)

### ä»£ç 
- `BlazorIdle.Server/Program.cs` - CORS å’Œ JWT é…ç½®
- `BlazorIdle/Services/BattleSignalRService.cs` - å®¢æˆ·ç«¯æœåŠ¡
- `BlazorIdle/Pages/Characters.razor` - UI é›†æˆ
- `BlazorIdle.Server/Hubs/BattleNotificationHub.cs` - Hub å®ç°

### é…ç½®
- `BlazorIdle.Server/appsettings.json` - æœåŠ¡ç«¯é…ç½®
- `BlazorIdle/wwwroot/appsettings.json` - å®¢æˆ·ç«¯é…ç½®
- `BlazorIdle/wwwroot/config/signalr*.json` - SignalR ä¸“ç”¨é…ç½®

---

## ğŸ“ åé¦ˆä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥é˜…ç›¸å…³æ–‡æ¡£
2. æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•
3. æŸ¥çœ‹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ—¥å¿—
4. åœ¨é¡¹ç›®ä¸­æäº¤ Issue æˆ– Pull Request

---

**å®Œæˆäºº**: GitHub Copilot Agent  
**å®¡æ ¸äºº**: å¾…æŒ‡å®š  
**æ‰¹å‡†äºº**: å¾…æŒ‡å®š
