# SignalR ç»Ÿä¸€ç®¡ç†ç³»ç»Ÿ - å®Œæ•´æ–¹æ¡ˆæ€»è§ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**ç”Ÿæˆæ—¥æœŸ**: 2025å¹´10æœˆ21æ—¥  
**çŠ¶æ€**: è®¾è®¡å®Œæˆ  
**ç›®æ ‡**: ä¸ºBlazorIdleé¡¹ç›®æä¾›ç»Ÿä¸€çš„ã€å¯æ‰©å±•çš„SignalRå®æ—¶é€šä¿¡è§£å†³æ–¹æ¡ˆ

---

## ğŸ“– æ–‡æ¡£å¯¼èˆª

æœ¬SignalRç»Ÿä¸€ç®¡ç†ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆåŒ…å«ä»¥ä¸‹æ–‡æ¡£ï¼Œ**å»ºè®®æŒ‰é¡ºåºé˜…è¯»**ï¼š

### 1ï¸âƒ£ [SignalRéœ€æ±‚åˆ†æä¸è¾¹ç•Œå®šä¹‰](./SignalRéœ€æ±‚åˆ†æä¸è¾¹ç•Œå®šä¹‰.md) â­

**é˜…è¯»æ—¶é—´**: 40åˆ†é’Ÿ  
**ç›®æ ‡è¯»è€…**: æ‰€æœ‰å›¢é˜Ÿæˆå‘˜

**ä¸»è¦å†…å®¹**:
- âœ… å„åŠŸèƒ½æ¨¡å—çš„SignalRéœ€æ±‚åˆ†æï¼ˆæˆ˜æ–—ã€ç”Ÿäº§ã€é‡‡é›†ã€ç»„é˜Ÿç­‰ï¼‰
- âœ… å®æ—¶æ¶ˆæ¯ vs APIæŸ¥è¯¢çš„è¾¹ç•Œå®šä¹‰
- âœ… SignalRéœ€æ±‚ä¼˜å…ˆçº§åˆ’åˆ†
- âœ… æŠ€æœ¯çº¦æŸä¸æŒ‘æˆ˜åˆ†æ

**ä¸ºä»€ä¹ˆå…ˆè¯»è¿™ä»½**:
- ç†è§£ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€çš„SignalRç³»ç»Ÿ
- æ˜ç¡®å“ªäº›åŠŸèƒ½éœ€è¦SignalRï¼Œå“ªäº›ç”¨APIå°±å¤Ÿäº†
- äº†è§£è®¾è®¡å†³ç­–çš„ä¾æ®

---

### 2ï¸âƒ£ [SignalRç»Ÿä¸€ç®¡ç†ç³»ç»Ÿ-æ€»ä½“æ¶æ„](./SignalRç»Ÿä¸€ç®¡ç†ç³»ç»Ÿ-æ€»ä½“æ¶æ„.md) â­â­â­

**é˜…è¯»æ—¶é—´**: 60åˆ†é’Ÿ  
**ç›®æ ‡è¯»è€…**: æ¶æ„å¸ˆã€åç«¯å¼€å‘è€…

**ä¸»è¦å†…å®¹**:
- âœ… æ•´ä½“æ¶æ„è®¾è®¡ä¸ç»„ä»¶åˆ’åˆ†
- âœ… GameHubç»Ÿä¸€Hubè®¾è®¡
- âœ… ConnectionManagerè¿æ¥ç®¡ç†
- âœ… SignalRDispatcheræ¶ˆæ¯åˆ†å‘
- âœ… Broadcasterä¸“ç”¨å¹¿æ’­å™¨
- âœ… DomainEventBusé¢†åŸŸäº‹ä»¶æ€»çº¿
- âœ… æ¶ˆæ¯æµç¨‹è¯¦è§£
- âœ… æ‰©å±•æœºåˆ¶è¯´æ˜

**ä¸ºä»€ä¹ˆé‡è¦**:
- è¿™æ˜¯æ ¸å¿ƒè®¾è®¡æ–‡æ¡£ï¼Œå¿…é¡»æ·±å…¥ç†è§£
- åç»­æ‰€æœ‰å®æ–½éƒ½åŸºäºè¿™ä¸ªæ¶æ„
- åŒ…å«å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œè®¾è®¡æ¨¡å¼

---

### 3ï¸âƒ£ [APIä¸SignalRé€‰æ‹©æŒ‡å—](./APIä¸SignalRé€‰æ‹©æŒ‡å—.md) â­â­

**é˜…è¯»æ—¶é—´**: 30åˆ†é’Ÿ  
**ç›®æ ‡è¯»è€…**: æ‰€æœ‰å¼€å‘è€…

**ä¸»è¦å†…å®¹**:
- âœ… å¿«é€Ÿå†³ç­–æ ‘ï¼ˆ5ç§’åˆ¤æ–­ç”¨å“ªä¸ªï¼‰
- âœ… è¯¦ç»†åˆ¤æ–­æ ‡å‡†ï¼ˆ5ä¸ªç»´åº¦ï¼‰
- âœ… å…¸å‹åœºæ™¯åˆ†ç±»ï¼ˆ100% API / 100% SignalR / æ··åˆæ¨¡å¼ï¼‰
- âœ… æ€§èƒ½è€ƒé‡ä¸ä¼˜åŒ–å»ºè®®
- âœ… å¸¸è§é”™è¯¯ä¸é¿å‘æŒ‡å—
- âœ… å†³ç­–é€ŸæŸ¥è¡¨

**ä¸ºä»€ä¹ˆæœ‰ç”¨**:
- å¼€å‘æ–°åŠŸèƒ½æ—¶å¿«é€Ÿå†³ç­–
- é¿å…æ»¥ç”¨SignalRæˆ–API
- æä¾›æœ€ä½³å®è·µå‚è€ƒ

---

### 4ï¸âƒ£ [SignalRå®æ–½è®¡åˆ’-åˆ†æ­¥æŒ‡å—](./SignalRå®æ–½è®¡åˆ’-åˆ†æ­¥æŒ‡å—.md) â­â­â­

**é˜…è¯»æ—¶é—´**: 90åˆ†é’Ÿ  
**ç›®æ ‡è¯»è€…**: å®æ–½å¼€å‘è€…

**ä¸»è¦å†…å®¹**:
- âœ… åˆ†5ä¸ªé˜¶æ®µçš„è¯¦ç»†å®æ–½è®¡åˆ’
- âœ… æ¯ä¸ªæ­¥éª¤çš„ä»»åŠ¡æ¸…å•å’ŒéªŒæ”¶æ ‡å‡†
- âœ… å®Œæ•´çš„ä»£ç ç¤ºä¾‹ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰
- âœ… å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°æŒ‡å—
- âœ… æµ‹è¯•æ–¹æ³•å’Œæ•…éšœæ’æŸ¥
- âœ… æ—¶é—´ä¼°ç®—å’Œäººå‘˜é…ç½®

**ä¸ºä»€ä¹ˆå…³é”®**:
- è¿™æ˜¯å®æ–½çš„æ“ä½œæ‰‹å†Œ
- æ–°æ‰‹å¼€å‘è€…å¯ä»¥æŒ‰æ­¥éª¤æ‰§è¡Œ
- åŒ…å«å¤§é‡å¯å¤åˆ¶çš„ä»£ç 

**å®æ–½é˜¶æ®µæ¦‚è§ˆ**:
```
é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„æ­å»º (2å‘¨)
  â”œâ”€ ç¯å¢ƒå‡†å¤‡
  â”œâ”€ GameHubå®ç°
  â”œâ”€ ConnectionManagerå®ç°
  â”œâ”€ SignalRDispatcherå®ç°
  â””â”€ å®¢æˆ·ç«¯è¿æ¥ç®¡ç†

é˜¶æ®µäºŒï¼šæˆ˜æ–—ç³»ç»Ÿé›†æˆ (2-3å‘¨)
  â”œâ”€ CombatBroadcaster
  â”œâ”€ BattleFrameBuffer
  â”œâ”€ BattleInstanceé›†æˆ
  â””â”€ å®¢æˆ·ç«¯æˆ˜æ–—çŠ¶æ€ç®¡ç†

é˜¶æ®µä¸‰ï¼šæ´»åŠ¨ä¸ç”Ÿäº§ç³»ç»Ÿ (2-3å‘¨)
  â”œâ”€ ActivityBroadcaster
  â”œâ”€ CraftingBroadcaster
  â”œâ”€ GatheringBroadcaster
  â””â”€ å®¢æˆ·ç«¯é›†æˆ

é˜¶æ®µå››ï¼šç»„é˜Ÿä¸ç¤¾äº¤ç³»ç»Ÿ (2-3å‘¨, å¯é€‰)
  â”œâ”€ PartyBroadcaster
  â”œâ”€ å¤šäººæˆ˜æ–—åŒæ­¥
  â””â”€ å®¢æˆ·ç«¯é›†æˆ

é˜¶æ®µäº”ï¼šä¼˜åŒ–ä¸ç›‘æ§ (1-2å‘¨)
  â”œâ”€ æ€§èƒ½ä¼˜åŒ–
  â”œâ”€ ç›‘æ§é¢æ¿
  â””â”€ æ–‡æ¡£å®Œå–„
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1. ç»Ÿä¸€ç®¡ç† ğŸ¯

**é—®é¢˜**: ä¹‹å‰çš„è®¾è®¡ä¸­ï¼Œåªæœ‰æˆ˜æ–—ç³»ç»Ÿæœ‰SignalRæ¨é€ï¼Œå…¶ä»–åŠŸèƒ½ï¼ˆç”Ÿäº§ã€é‡‡é›†ã€ç»„é˜Ÿç­‰ï¼‰å¦‚ä½•é›†æˆï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: 
- **å•ä¸€Hub**: æ‰€æœ‰æ¶ˆæ¯é€šè¿‡ `GameHub` ç»Ÿä¸€å¤„ç†
- **ç»Ÿä¸€è¿æ¥**: ä¸€ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªSignalRè¿æ¥
- **æ¶ˆæ¯è·¯ç”±**: æ ¹æ®æ¶ˆæ¯ç±»å‹è‡ªåŠ¨è·¯ç”±åˆ°ç›¸åº”å¤„ç†å™¨

**ä¼˜åŠ¿**:
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆå¤šHubï¼‰:
Client â”€â”€â”¬â”€> CombatHub
         â”œâ”€> ActivityHub
         â”œâ”€> PartyHub
         â””â”€> NotificationHub
         
4ä¸ªè¿æ¥ï¼Œç®¡ç†å¤æ‚ï¼Œèµ„æºæµªè´¹

ç»Ÿä¸€æ–¹å¼ï¼ˆå•Hubï¼‰:
Client â”€> GameHub â”€â”¬â”€> CombatBroadcaster
                   â”œâ”€> ActivityBroadcaster
                   â”œâ”€> PartyBroadcaster
                   â””â”€> GeneralBroadcaster

1ä¸ªè¿æ¥ï¼Œç»Ÿä¸€ç®¡ç†ï¼Œé«˜æ•ˆå¤ç”¨
```

---

### 2. äº‹ä»¶é©±åŠ¨ âš¡

**é—®é¢˜**: SignalRæ¨é€ä»£ç å¦‚ä½•ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: é€šè¿‡é¢†åŸŸäº‹ä»¶æ€»çº¿è§£è€¦

```
ä¸šåŠ¡é€»è¾‘ (Domain)
    â”‚
    â”‚ å‘å¸ƒäº‹ä»¶
    â–¼
é¢†åŸŸäº‹ä»¶æ€»çº¿ (EventBus)
    â”‚
    â”‚ è®¢é˜…
    â–¼
Broadcaster (Infrastructure)
    â”‚
    â”‚ æ¨é€
    â–¼
SignalR Hub
```

**ä¼˜åŠ¿**:
- âœ… ä¸šåŠ¡é€»è¾‘ä¸ä¾èµ–SignalR
- âœ… æ˜“äºæµ‹è¯•ï¼ˆMock EventBusï¼‰
- âœ… æ”¯æŒå¤šä¸ªè®¢é˜…è€…
- âœ… å¼‚æ­¥å¤„ç†ä¸é˜»å¡ä¸šåŠ¡

**ä»£ç ç¤ºä¾‹**:

```csharp
// âŒ è€¦åˆæ–¹å¼ï¼ˆä¸æ¨èï¼‰
public class BattleRunner
{
    private readonly IHubContext<GameHub> _hubContext;  // ç›´æ¥ä¾èµ–SignalR

    public async Task ExecuteTick()
    {
        // ä¸šåŠ¡é€»è¾‘...
        
        await _hubContext.Clients.Group($"battle:{battleId}")
            .SendAsync("FrameTick", frame);  // ç´§è€¦åˆ
    }
}

// âœ… è§£è€¦æ–¹å¼ï¼ˆæ¨èï¼‰
public class BattleRunner
{
    private readonly IDomainEventBus _eventBus;  // ä¾èµ–æŠ½è±¡

    public async Task ExecuteTick()
    {
        // ä¸šåŠ¡é€»è¾‘...
        
        await _eventBus.PublishAsync(new BattleFrameGeneratedEvent
        {
            BattleId = battleId,
            Frame = frame
        });  // ä½è€¦åˆ
    }
}

// Broadcasterè®¢é˜…å¹¶å¤„ç†
public class CombatBroadcaster
{
    public CombatBroadcaster(IDomainEventBus eventBus, ISignalRDispatcher dispatcher)
    {
        eventBus.Subscribe<BattleFrameGeneratedEvent>(async e =>
        {
            await dispatcher.SendToGroupAsync($"battle:{e.BattleId}", "FrameTick", e.Frame);
        });
    }
}
```

---

### 3. æ¨¡å—åŒ–è®¾è®¡ ğŸ”§

**é—®é¢˜**: å¦‚ä½•è®©æ–°åŠŸèƒ½æ˜“äºé›†æˆï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: æ¯ä¸ªåŠŸèƒ½æ¨¡å—æœ‰ç‹¬ç«‹çš„Broadcaster

```
CombatBroadcaster      â†’ æˆ˜æ–—ç›¸å…³æ¨é€
ActivityBroadcaster    â†’ æ´»åŠ¨ç›¸å…³æ¨é€
CraftingBroadcaster    â†’ åˆ¶ä½œç›¸å…³æ¨é€
GatheringBroadcaster   â†’ é‡‡é›†ç›¸å…³æ¨é€
PartyBroadcaster       â†’ ç»„é˜Ÿç›¸å…³æ¨é€
GeneralBroadcaster     â†’ é€šç”¨æ¨é€ï¼ˆç³»ç»Ÿå…¬å‘Šç­‰ï¼‰
```

**æ·»åŠ æ–°æ¨¡å—åªéœ€3æ­¥**:

```csharp
// æ­¥éª¤1: åˆ›å»ºBroadcaster
public class NewFeatureBroadcaster : INewFeatureBroadcaster
{
    private readonly ISignalRDispatcher _dispatcher;
    
    public NewFeatureBroadcaster(ISignalRDispatcher dispatcher, IDomainEventBus eventBus)
    {
        _dispatcher = dispatcher;
        eventBus.Subscribe<NewFeatureEvent>(OnNewFeatureEventAsync);
    }
    
    private async Task OnNewFeatureEventAsync(NewFeatureEvent @event)
    {
        await _dispatcher.SendToUserAsync(@event.UserId, "NewFeature", @event.Data);
    }
}

// æ­¥éª¤2: æ³¨å†ŒæœåŠ¡
builder.Services.AddSingleton<INewFeatureBroadcaster, NewFeatureBroadcaster>();

// æ­¥éª¤3: å®¢æˆ·ç«¯å¤„ç†
connection.On<NewFeatureData>("NewFeature", (data) => {
    // å¤„ç†æ•°æ®
});
```

---

### 4. æ€§èƒ½ä¼˜å…ˆ ğŸš€

**é—®é¢˜**: é«˜é¢‘æ¨é€ä¼šä¸ä¼šå½±å“æ€§èƒ½ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: å¤šå±‚ä¼˜åŒ–

#### 4.1 å¼‚æ­¥é˜Ÿåˆ—

```csharp
// æ¶ˆæ¯ä¸ç›´æ¥å‘é€ï¼Œå…ˆå…¥é˜Ÿ
await _messageChannel.Writer.WriteAsync(message);

// åå°çº¿ç¨‹æ‰¹é‡å¤„ç†
await foreach (var msg in _messageChannel.Reader.ReadAllAsync())
{
    batch.Add(msg);
    if (batch.Count >= 100 || timeWindow > 50ms)
    {
        await SendBatchAsync(batch);  // æ‰¹é‡å‘é€
    }
}
```

#### 4.2 ä¼˜å…ˆçº§è°ƒåº¦

```csharp
public enum MessagePriority
{
    Low = 0,      // éé‡è¦é€šçŸ¥
    Normal = 1,   // å¸¸è§„æ¶ˆæ¯
    High = 2,     // æˆ˜æ–—å¸§
    Critical = 3  // å…³é”®äº‹ä»¶ï¼ˆæ­»äº¡ã€æ‰è½ï¼‰
}

// æ‰¹é‡å‘é€å‰æŒ‰ä¼˜å…ˆçº§æ’åº
messages.Sort((a, b) => b.Priority.CompareTo(a.Priority));
```

#### 4.3 èƒŒå‹æ§åˆ¶

```csharp
// æœ‰ç•Œé€šé“ï¼Œé˜²æ­¢æ¶ˆæ¯å †ç§¯
var channel = Channel.CreateBounded<PendingMessage>(new BoundedChannelOptions(10000)
{
    FullMode = BoundedChannelFullMode.Wait  // é˜Ÿåˆ—æ»¡æ—¶ç­‰å¾…
});
```

**æ€§èƒ½ç›®æ ‡**:
- âœ… æˆ˜æ–—å¸§å»¶è¿Ÿ < 200msï¼ˆP95ï¼‰
- âœ… æ¶ˆæ¯é˜Ÿåˆ—æ·±åº¦ < 1000
- âœ… å•æœåŠ¡å™¨æ”¯æŒ > 100 å¹¶å‘ç”¨æˆ·
- âœ… CPUä½¿ç”¨ç‡ < 50%

---

### 5. å¯é ä¼ è¾“ ğŸ’ª

**é—®é¢˜**: ç½‘ç»œä¸ç¨³å®šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: å¤šé‡ä¿éšœ

#### 5.1 ç‰ˆæœ¬å·æœºåˆ¶

```typescript
// æ¯æ¡æ¶ˆæ¯å¸¦ç‰ˆæœ¬å·
interface FrameTick {
    version: number;  // å•è°ƒé€’å¢
    // ...
}

// å®¢æˆ·ç«¯æ£€æµ‹ç¼ºå£
if (frame.version !== lastVersion + 1) {
    // ç¼ºå¤±æ¶ˆæ¯ï¼Œè¯·æ±‚è¡¥å‘
    await connection.invoke("RequestBattleSync", battleId, lastVersion);
}
```

#### 5.2 æ¶ˆæ¯ç¼“å­˜

```csharp
// æœåŠ¡å™¨ç¼“å­˜æœ€è¿‘Nä¸ªå¸§
public class BattleFrameBuffer
{
    private readonly CircularBuffer<FrameTick> _buffer = new(300);
    
    public void Add(FrameTick frame)
    {
        _buffer.Add(frame);
    }
    
    public List<FrameTick> GetRange(long fromVersion, long toVersion)
    {
        return _buffer.Where(f => f.Version >= fromVersion && f.Version <= toVersion).ToList();
    }
}
```

#### 5.3 å¿«ç…§æ¢å¤

```csharp
// ç¼ºå£è¿‡å¤§æ—¶å‘é€å®Œæ•´å¿«ç…§
if (toVersion - fromVersion > 100)
{
    var snapshot = GenerateSnapshot();
    await _dispatcher.SendToUserAsync(userId, "BattleSnapshot", snapshot);
}
else
{
    var frames = _frameBuffer.GetRange(fromVersion, toVersion);
    await _dispatcher.SendToUserAsync(userId, "BattleFrames", frames);
}
```

#### 5.4 è‡ªåŠ¨é‡è¿

```typescript
// å®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
const retryDelays = [0, 2, 5, 10, 20, 30];  // ç§’

connection.onclose(async () => {
    for (let i = 0; i < retryDelays.length; i++) {
        await sleep(retryDelays[i] * 1000);
        if (await tryReconnect()) {
            break;
        }
    }
});
```

---

## ğŸ“Š å®æ—¶æ¶ˆæ¯ vs API è¾¹ç•Œ

### å†³ç­–åŸåˆ™

ä½¿ç”¨è¿™ä¸ªç®€å•çš„å†³ç­–æ ‘ï¼š

```
éœ€è¦æœåŠ¡å™¨ä¸»åŠ¨é€šçŸ¥ï¼Ÿ
        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
  æ˜¯         å¦
   â”‚          â”‚
   â–¼          â–¼
å®æ—¶æ€§      ä½¿ç”¨ API
< 2ç§’ï¼Ÿ
   â”‚
 â”Œâ”€â”´â”€â”
æ˜¯  å¦
 â”‚   â”‚
 â–¼   â–¼
SignalR  å¯é€‰
```

### å…¸å‹åœºæ™¯

| åœºæ™¯ | æ–¹æ¡ˆ | åŸå›  |
|------|------|------|
| æˆ˜æ–—çŠ¶æ€æ›´æ–° | SignalR | é«˜é¢‘å®æ—¶æ¨é€ |
| æŸ¥çœ‹èƒŒåŒ… | API | ä½é¢‘æŸ¥è¯¢ |
| æ´»åŠ¨å®Œæˆ | SignalR | äº‹ä»¶é€šçŸ¥ |
| æŸ¥çœ‹é…æ–¹ | API | é™æ€æ•°æ® |
| ç»„é˜Ÿé‚€è¯· | SignalR | å¤šç”¨æˆ·åŒæ­¥ |
| è´­ä¹°ç‰©å“ | API | æ“ä½œè¯·æ±‚ |
| åˆ¶ä½œå®Œæˆ | SignalR | äº‹ä»¶é€šçŸ¥ |
| å†å²è®°å½• | API | å†å²æ•°æ® |

è¯¦ç»†å†³ç­–æŒ‡å—è¯·å‚è€ƒ [APIä¸SignalRé€‰æ‹©æŒ‡å—](./APIä¸SignalRé€‰æ‹©æŒ‡å—.md)

---

## ğŸ—ï¸ æ¶æ„æ€»è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Blazor WebAssembly Client                                  â”‚
â”‚                                                              â”‚
â”‚  SignalRConnectionManager (å•ä¸€è¿æ¥)                         â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  MessageRouter â”€â”¬â”€> CombatHandler                           â”‚
â”‚                 â”œâ”€> ActivityHandler                         â”‚
â”‚                 â”œâ”€> PartyHandler                            â”‚
â”‚                 â””â”€> GeneralHandler                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ASP.NET Core Server                                        â”‚
â”‚                                                              â”‚
â”‚  GameHub (ç»Ÿä¸€å…¥å£)                                          â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  SignalRDispatcher (æ¶ˆæ¯é˜Ÿåˆ— + æ‰¹é‡å‘é€)                     â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€> CombatBroadcaster                                 â”‚
â”‚       â”œâ”€> ActivityBroadcaster                               â”‚
â”‚       â”œâ”€> PartyBroadcaster                                  â”‚
â”‚       â””â”€> GeneralBroadcaster                                â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Domain Event Bus                                â”‚       â”‚
â”‚  â”‚  - è§£è€¦ä¸šåŠ¡é€»è¾‘å’ŒSignalR                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚       â”‚         â”‚         â”‚              â”‚                  â”‚
â”‚       â–¼         â–¼         â–¼              â–¼                  â”‚
â”‚  Combat   Activity   Crafting      Economy                  â”‚
â”‚  System    System     System        System                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | ä½ç½® |
|------|------|------|
| **GameHub** | ç»Ÿä¸€Hubï¼Œè¿æ¥ç®¡ç†å’Œæ¶ˆæ¯è·¯ç”± | Infrastructure/SignalR/Hubs |
| **ConnectionManager** | ç”¨æˆ·ä¼šè¯å’Œè¿æ¥çŠ¶æ€ç®¡ç† | Infrastructure/SignalR/Services |
| **SignalRDispatcher** | æ¶ˆæ¯é˜Ÿåˆ—ã€æ‰¹é‡å‘é€ã€ä¼˜å…ˆçº§è°ƒåº¦ | Infrastructure/SignalR/Services |
| **Broadcaster** | ä¸“ç”¨å¹¿æ’­å™¨ï¼ˆæˆ˜æ–—ã€æ´»åŠ¨ç­‰ï¼‰ | Infrastructure/SignalR/Broadcasters |
| **DomainEventBus** | é¢†åŸŸäº‹ä»¶æ€»çº¿ï¼Œè§£è€¦ä¸šåŠ¡é€»è¾‘ | Infrastructure/Messaging |

---

## ğŸ“ˆ å®æ–½è·¯çº¿å›¾

### æ—¶é—´è§„åˆ’

```
æœˆä»½                1        2        3
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é˜¶æ®µä¸€ åŸºç¡€æ¶æ„    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
é˜¶æ®µäºŒ æˆ˜æ–—é›†æˆ    â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘
é˜¶æ®µä¸‰ æ´»åŠ¨ç”Ÿäº§    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µå›› ç»„é˜Ÿç¤¾äº¤    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆ (å¯é€‰)
é˜¶æ®µäº” ä¼˜åŒ–ç›‘æ§    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆ

æ€»è®¡: 2-3ä¸ªæœˆ
```

### é‡Œç¨‹ç¢‘

#### Milestone 1: åŸºç¡€æ¶æ„å°±ç»ªï¼ˆç¬¬2å‘¨ï¼‰

- âœ… GameHubè¿è¡Œæ­£å¸¸
- âœ… å®¢æˆ·ç«¯å¯ä»¥è¿æ¥
- âœ… æ¶ˆæ¯åˆ†å‘å™¨å·¥ä½œ
- âœ… è‡ªåŠ¨é‡è¿æ­£å¸¸

#### Milestone 2: æˆ˜æ–—ç³»ç»Ÿé›†æˆï¼ˆç¬¬5-6å‘¨ï¼‰

- âœ… æˆ˜æ–—å¸§æ¨é€æ­£å¸¸
- âœ… æ–­çº¿é‡è¿æ¢å¤çŠ¶æ€
- âœ… æ€§èƒ½è¾¾æ ‡ï¼ˆ< 200mså»¶è¿Ÿï¼‰
- âœ… å®¢æˆ·ç«¯æ¸²æŸ“æµç•…

#### Milestone 3: åŠŸèƒ½å®Œå–„ï¼ˆç¬¬10-12å‘¨ï¼‰

- âœ… æ´»åŠ¨å’Œç”Ÿäº§æ¨é€æ­£å¸¸
- âœ… æ‰€æœ‰åŠŸèƒ½é›†æˆå®Œæˆ
- âœ… ç›‘æ§ç³»ç»Ÿå°±ç»ª
- âœ… æ–‡æ¡£é½å…¨

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] æ‰€æœ‰è®¡åˆ’çš„æ¶ˆæ¯ç±»å‹éƒ½èƒ½æ­£å¸¸æ¨é€
- [ ] æ–­çº¿é‡è¿åçŠ¶æ€æ­£ç¡®æ¢å¤
- [ ] å¤šç”¨æˆ·åœºæ™¯ä¸‹æ¶ˆæ¯ä¸ä¸²å·
- [ ] ä¼˜å…ˆçº§è°ƒåº¦æ­£ç¡®å·¥ä½œ

### æ€§èƒ½éªŒæ”¶

- [ ] æˆ˜æ–—å¸§æ¨é€å»¶è¿Ÿ < 200msï¼ˆP95ï¼‰
- [ ] æ¶ˆæ¯é˜Ÿåˆ—æ·±åº¦ < 1000ï¼ˆæ­£å¸¸è´Ÿè½½ï¼‰
- [ ] è¿æ¥æ•°æ”¯æŒ > 100ï¼ˆå•æœåŠ¡å™¨ï¼‰
- [ ] CPUä½¿ç”¨ç‡ < 50%ï¼ˆæ­£å¸¸è´Ÿè½½ï¼‰

### å¯é æ€§éªŒæ”¶

- [ ] 7Ã—24å°æ—¶ç¨³å®šè¿è¡Œ
- [ ] é”™è¯¯ç‡ < 0.1%
- [ ] è‡ªåŠ¨é‡è¿æˆåŠŸç‡ > 95%
- [ ] æ¶ˆæ¯ä¸¢å¤±ç‡ < 0.01%

### å¯ç»´æŠ¤æ€§éªŒæ”¶

- [ ] ä»£ç è´¨é‡è‰¯å¥½
- [ ] æ–‡æ¡£é½å…¨
- [ ] æ—¥å¿—æ¸…æ™°
- [ ] ç›‘æ§å®Œå–„

---

## ğŸ“ å­¦ä¹ è·¯å¾„

### å¯¹äºæ–°æ‰‹å¼€å‘è€…

æ¨èå­¦ä¹ é¡ºåºï¼š

1. **ç¬¬1å¤©**: é˜…è¯» [SignalRéœ€æ±‚åˆ†æä¸è¾¹ç•Œå®šä¹‰](./SignalRéœ€æ±‚åˆ†æä¸è¾¹ç•Œå®šä¹‰.md)
   - ç†è§£ä¸ºä»€ä¹ˆéœ€è¦SignalR
   - å­¦ä¹ ä»€ä¹ˆæ—¶å€™ç”¨SignalR vs API

2. **ç¬¬2-3å¤©**: é˜…è¯» [SignalRç»Ÿä¸€ç®¡ç†ç³»ç»Ÿ-æ€»ä½“æ¶æ„](./SignalRç»Ÿä¸€ç®¡ç†ç³»ç»Ÿ-æ€»ä½“æ¶æ„.md)
   - ç†è§£æ•´ä½“æ¶æ„
   - å­¦ä¹ å„ç»„ä»¶èŒè´£

3. **ç¬¬4å¤©**: å‚è€ƒ [APIä¸SignalRé€‰æ‹©æŒ‡å—](./APIä¸SignalRé€‰æ‹©æŒ‡å—.md)
   - å­¦ä¹ å†³ç­–æ–¹æ³•
   - æŒæ¡æœ€ä½³å®è·µ

4. **ç¬¬5å¤©èµ·**: è·Ÿéš [SignalRå®æ–½è®¡åˆ’-åˆ†æ­¥æŒ‡å—](./SignalRå®æ–½è®¡åˆ’-åˆ†æ­¥æŒ‡å—.md)
   - åŠ¨æ‰‹å®æ–½
   - å®Œæˆæ¯ä¸ªæ­¥éª¤çš„ä»»åŠ¡

### å¯¹äºç»éªŒå¼€å‘è€…

å¯ä»¥ç›´æ¥ï¼š

1. å¿«é€Ÿæµè§ˆéœ€æ±‚åˆ†æï¼ˆ10åˆ†é’Ÿï¼‰
2. æ·±å…¥ç ”ç©¶æ€»ä½“æ¶æ„ï¼ˆ30åˆ†é’Ÿï¼‰
3. å¼€å§‹å®æ–½ï¼ˆå‚è€ƒå®æ–½è®¡åˆ’ï¼‰

---

## ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿

### vs ç°æœ‰æ–¹æ¡ˆï¼ˆåªæœ‰æˆ˜æ–—SignalRï¼‰

| æ–¹é¢ | ç°æœ‰æ–¹æ¡ˆ | ç»Ÿä¸€æ–¹æ¡ˆ |
|------|---------|---------|
| **æ¶æ„** | ä»…æˆ˜æ–—ç³»ç»Ÿæœ‰SignalR | ç»Ÿä¸€æ¡†æ¶æ”¯æŒæ‰€æœ‰åŠŸèƒ½ |
| **è¿æ¥æ•°** | æ¯ä¸ªæ¨¡å—ç‹¬ç«‹è¿æ¥ | å•ä¸€è¿æ¥å¤ç”¨ |
| **æ‰©å±•æ€§** | æ–°åŠŸèƒ½éœ€è¦é‡æ–°è®¾è®¡ | æ’ä»¶å¼æ‰©å±•ï¼Œ3æ­¥å®Œæˆ |
| **ç»´æŠ¤æ€§** | ä»£ç åˆ†æ•£ï¼Œéš¾ä»¥ç»´æŠ¤ | ç»Ÿä¸€ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤ |
| **æ€§èƒ½** | æ— ç»Ÿä¸€ä¼˜åŒ– | é˜Ÿåˆ—ã€æ‰¹é‡ã€ä¼˜å…ˆçº§ |
| **å¯é æ€§** | æ— ç»Ÿä¸€ä¿éšœ | ç‰ˆæœ¬å·ã€ç¼“å­˜ã€å¿«ç…§ |

### vs ä¼ ç»Ÿå¤šHubæ–¹æ¡ˆ

| æ–¹é¢ | å¤šHubæ–¹æ¡ˆ | å•Hubæ–¹æ¡ˆï¼ˆæœ¬æ–¹æ¡ˆï¼‰ |
|------|----------|-------------------|
| **è¿æ¥æ•°** | Nä¸ªHub = Nä¸ªè¿æ¥ | 1ä¸ªHub = 1ä¸ªè¿æ¥ |
| **ç®¡ç†å¤æ‚åº¦** | é«˜ | ä½ |
| **èµ„æºæ¶ˆè€—** | é«˜ | ä½ |
| **æ¶ˆæ¯è·¯ç”±** | åˆ†æ•£ | ç»Ÿä¸€ |
| **ç›‘æ§éš¾åº¦** | é«˜ | ä½ |

---

## ğŸ“ è·å–å¸®åŠ©

### æ–‡æ¡£å¯¼èˆª

- éœ€æ±‚åˆ†æ: [SignalRéœ€æ±‚åˆ†æä¸è¾¹ç•Œå®šä¹‰.md](./SignalRéœ€æ±‚åˆ†æä¸è¾¹ç•Œå®šä¹‰.md)
- æ€»ä½“æ¶æ„: [SignalRç»Ÿä¸€ç®¡ç†ç³»ç»Ÿ-æ€»ä½“æ¶æ„.md](./SignalRç»Ÿä¸€ç®¡ç†ç³»ç»Ÿ-æ€»ä½“æ¶æ„.md)
- é€‰æ‹©æŒ‡å—: [APIä¸SignalRé€‰æ‹©æŒ‡å—.md](./APIä¸SignalRé€‰æ‹©æŒ‡å—.md)
- å®æ–½è®¡åˆ’: [SignalRå®æ–½è®¡åˆ’-åˆ†æ­¥æŒ‡å—.md](./SignalRå®æ–½è®¡åˆ’-åˆ†æ­¥æŒ‡å—.md)

### é—ç•™æ–‡æ¡£

**æˆ˜æ–—ç³»ç»Ÿå®æ—¶å¸§æ¨é€ï¼ˆç‰ˆæœ¬2.0ï¼‰**:
- [å®æ—¶å¸§æ¨é€è®¾è®¡æ–¹æ¡ˆ.md](./å®æ—¶å¸§æ¨é€è®¾è®¡æ–¹æ¡ˆ.md)
- [æˆ˜æ–—å¸§å¹¿æ’­ç³»ç»Ÿå®ç°æŒ‡å—.md](./æˆ˜æ–—å¸§å¹¿æ’­ç³»ç»Ÿå®ç°æŒ‡å—.md)
- [å‰ç«¯æ¸²æŸ“ç­–ç•¥ä¸æ—¶é—´åŒæ­¥.md](./å‰ç«¯æ¸²æŸ“ç­–ç•¥ä¸æ—¶é—´åŒæ­¥.md)

è¿™äº›æ–‡æ¡£èšç„¦äºæˆ˜æ–—ç³»ç»Ÿçš„å¸§æ¨é€ç»†èŠ‚ï¼Œä¸æœ¬ç»Ÿä¸€æ–¹æ¡ˆå…¼å®¹ã€‚

**æ³¨æ„**: Phase1-3 å’Œ SignalRè®¾è®¡æ€»è§ˆï¼ˆç‰ˆæœ¬1.0ï¼‰å·²è¿‡æ—¶ï¼Œä¸å»ºè®®å‚è€ƒã€‚

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ | ä½œè€… |
|------|------|---------|------|
| 1.0 | 2025-10-21 | åˆå§‹ç‰ˆæœ¬ï¼Œç»Ÿä¸€ç®¡ç†ç³»ç»Ÿå®Œæ•´è®¾è®¡ | GitHub Copilot |

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ21æ—¥  
**ä½œè€…**: GitHub Copilot

---

## ğŸš€ å¼€å§‹ä½¿ç”¨

1. âœ… é˜…è¯»å®Œæœ¬æ€»è§ˆæ–‡æ¡£
2. âœ… æŒ‰é¡ºåºé˜…è¯»å…¶ä»–4ä»½æ–‡æ¡£
3. âœ… å¼€å§‹é˜¶æ®µä¸€å®æ–½
4. âœ… ä¿æŒè¿›åº¦è·Ÿè¸ª

**ç¥å¼€å‘é¡ºåˆ©ï¼** ğŸ‰
