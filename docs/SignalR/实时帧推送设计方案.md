# BlazorIdle å®æ—¶å¸§æ¨é€è®¾è®¡æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**ç”Ÿæˆæ—¥æœŸ**: 2025å¹´10æœˆ  
**çŠ¶æ€**: è®¾è®¡è§„åˆ’ - ä¿®è®¢ç‰ˆ  
**ç›®æ ‡**: åŸºäºå›ºå®šé¢‘ç‡å¸§å¹¿æ’­çš„ä½å»¶è¿Ÿå®æ—¶æˆ˜æ–—æ¨é€ç³»ç»Ÿ

---

## ğŸ“š è®¾è®¡èƒŒæ™¯ä¸ç›®æ ‡

### åŸè®¾è®¡çš„é—®é¢˜

1. **è½®è¯¢é™çº§ä¸éœ€è¦**: åç»­å‰ç«¯çš„è½®è¯¢åŠŸèƒ½å°†è¢« SignalR å®Œå…¨æ›¿ä»£ï¼Œæ— éœ€ä¿ç•™è½®è¯¢é€€çº§åŠŸèƒ½
2. **CombatSegment å»¶è¿Ÿé—®é¢˜**: èšåˆå¤šä¸ªåŸå­äº‹ä»¶åæ¨é€ä¼šé€ æˆæ˜¾è‘—å»¶è¿Ÿï¼Œæ— æ³•æ»¡è¶³ä½å»¶è¿Ÿå®æ—¶æ›´æ–°éœ€æ±‚
3. **ç¼ºå°‘å¹³æ»‘æ¸²æŸ“**: å‰ç«¯éœ€è¦åŠæ—¶è·å–æˆ˜æ–—ä¿¡æ¯æ›´æ–°ï¼Œå®ç°æµç•…çš„æˆ˜æ–—æ¼”å‡º

### æ–°è®¾è®¡ç›®æ ‡

âœ… **æŒç»­ SignalR äº‹ä»¶æµ**: å®Œå…¨æ›¿ä»£è½®è¯¢ï¼Œè¿æ¥å¤±è´¥æ—¶ç›´æ¥é‡è¿æˆ–è¿”å›å¤±è´¥  
âœ… **ä½å»¶è¿Ÿæ¨é€**: 5-10Hz å›ºå®šé¢‘ç‡å¸§å¹¿æ’­ï¼Œå»¶è¿Ÿ < 200ms  
âœ… **å¹³æ»‘æ¸²æŸ“**: å‰ç«¯åŸºäºæ—¶é—´æ’å€¼å’Œå¤–æ¨ï¼Œå®ç°æµç•…æˆ˜æ–—æ•ˆæœ  
âœ… **å¯é ä¼ è¾“**: ç‰ˆæœ¬å·æœºåˆ¶å¤„ç†ä¹±åº/ä¸¢åŒ…ï¼Œæ”¯æŒå·®å¼‚è¡¥å‘å’Œå¿«ç…§æ¢å¤  
âœ… **çµæ´»èŠ‚æµ**: æ ¹æ®å‰å°/åå°å’Œè®¾å¤‡æ€§èƒ½åŠ¨æ€è°ƒæ•´æ¨é€é¢‘ç‡

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Blazor WebAssembly Client                              â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  BattleFrameReceiver                           â”‚     â”‚
â”‚  â”‚  - æ¥æ”¶ FrameTickã€KeyEventã€Snapshot         â”‚     â”‚
â”‚  â”‚  - ç»´æŠ¤ lastVersion                           â”‚     â”‚
â”‚  â”‚  - æ£€æµ‹ç‰ˆæœ¬ç¼ºå£ï¼Œè¯·æ±‚è¡¥å‘/å¿«ç…§                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                     â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  BattleStateManager                            â”‚     â”‚
â”‚  â”‚  - ç»´æŠ¤å®¢æˆ·ç«¯æˆ˜æ–—çŠ¶æ€                          â”‚     â”‚
â”‚  â”‚  - æ—¶é—´åç§»æ ¡å‡†ï¼ˆserverTime vs clientTimeï¼‰    â”‚     â”‚
â”‚  â”‚  - åº”ç”¨ FrameTick æ›´æ–°                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                     â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  BattleRenderer                                â”‚     â”‚
â”‚  â”‚  - æ’å€¼/å¤–æ¨ç»˜åˆ¶è¿›åº¦ä¸æ•°å€¼                      â”‚     â”‚
â”‚  â”‚  - å¹³æ»‘çº æ­£åˆ°æƒå¨å€¼                            â”‚     â”‚
â”‚  â”‚  - æ¼”å‡ºèŠ‚å¥æ§åˆ¶ï¼ˆåˆå¹¶æ™®é€šä¼¤å®³ï¼Œç‹¬ç«‹å…³é”®äº‹ä»¶ï¼‰    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ SignalR WebSocket (æ— è½®è¯¢é™çº§)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ASP.NET Core Server                                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  BattleHub (SignalR Hub)                       â”‚     â”‚
â”‚  â”‚  - ç®¡ç† battle groupï¼ˆæ¯æˆ˜æ–—ä¸€ä¸ª groupï¼‰       â”‚     â”‚
â”‚  â”‚  - ç©å®¶åŠ å…¥/ç¦»å¼€ group                         â”‚     â”‚
â”‚  â”‚  - æ¨é€ FrameTickã€KeyEventã€Snapshot         â”‚     â”‚
â”‚  â”‚  - å¤„ç†è¡¥å‘è¯·æ±‚                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                     â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  BattleFrameBroadcaster                        â”‚     â”‚
â”‚  â”‚  - å›ºå®šé¢‘ç‡å¹¿æ’­ï¼ˆ5-10Hzï¼‰                      â”‚     â”‚
â”‚  â”‚  - ç”Ÿæˆ FrameTick                              â”‚     â”‚
â”‚  â”‚  - èŠ‚æµä¸é¢‘ç‡è°ƒæ•´                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                     â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  BattleFrameBuffer                             â”‚     â”‚
â”‚  â”‚  - ç¼“å­˜æœ€è¿‘ N ä¸ªå¸§ï¼ˆç”¨äºè¡¥å‘ï¼‰                  â”‚     â”‚
â”‚  â”‚  - å‘¨æœŸç”Ÿæˆ Snapshot                           â”‚     â”‚
â”‚  â”‚  - ç»´æŠ¤ currentVersion                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                     â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  BattleRunner (Domain)                         â”‚     â”‚
â”‚  â”‚  - æˆ˜æ–—é€»è¾‘æ‰§è¡Œ                                â”‚     â”‚
â”‚  â”‚  - äº§ç”Ÿå…³é”®äº‹ä»¶ï¼ˆæ€ªç‰©æ­»äº¡ã€æ‰è½ã€é˜¶æ®µåˆ‡æ¢ï¼‰     â”‚     â”‚
â”‚  â”‚  - æ›´æ–°æˆ˜æ–—çŠ¶æ€ï¼ˆHPã€èµ„æºã€Buff/Debuffï¼‰       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å¸§ç±»å‹å®šä¹‰

### 1. FrameTickï¼ˆå›ºå®šé¢‘ç‡å¹¿æ’­å¸§ï¼‰

**æ¨é€é¢‘ç‡**: 5â€“10Hzï¼ˆ100-200ms é—´éš”ï¼‰  
**ä½œç”¨**: æä¾›æˆ˜æ–—çŠ¶æ€çš„æŒç»­æ›´æ–°ï¼Œæ”¯æŒå‰ç«¯å¹³æ»‘æ¸²æŸ“

#### æ•°æ®ç»“æ„

```typescript
interface FrameTick {
  // ===== Header =====
  version: number;           // å•è°ƒé€’å¢ç‰ˆæœ¬å·
  serverTime: number;        // æœåŠ¡å™¨æ—¶é—´æˆ³ (ms)
  battleId: string;          // æˆ˜æ–—å®ä¾‹ ID
  phase: BattlePhase;        // æˆ˜æ–—é˜¶æ®µ (active/paused/ended)
  
  // ===== Metrics =====
  metrics: {
    // è¿›åº¦ç±»
    castProgress?: {         // è¯»æ¡è¿›åº¦ï¼ˆå¦‚æœæœ‰ï¼‰
      skillId: string;
      progress: number;      // 0.0 - 1.0
      remaining: number;     // å‰©ä½™æ—¶é—´ (ms)
    };
    
    // DPS ç»Ÿè®¡
    dps: {
      player: number;        // ç©å®¶ DPS
      received: number;      // æ‰¿å— DPS
    };
    
    // è¡€é‡ä¸æŠ¤ç›¾
    health: {
      current: number;
      max: number;
      delta: number;         // æœ¬å¸§å˜åŒ–é‡
    };
    shield: {
      current: number;
      delta: number;
    };
    
    // Buff/Debuff åˆ—è¡¨ï¼ˆä»…å‘é€å˜åŒ–é¡¹ï¼‰
    buffs?: BuffChange[];    // æ–°å¢/åˆ·æ–°çš„ Buff
    debuffs?: BuffChange[];  // æ–°å¢/åˆ·æ–°çš„ Debuff
    expiredBuffs?: string[]; // è¿‡æœŸçš„ Buff ID åˆ—è¡¨
  };
  
  // ===== Aggregates =====
  aggregates: {
    windowStart: number;     // ç»Ÿè®¡çª—å£èµ·å§‹æ—¶é—´
    windowEnd: number;       // ç»Ÿè®¡çª—å£ç»“æŸæ—¶é—´
    damage: {
      total: number;         // æœ¬çª—å£ç´¯è®¡ä¼¤å®³
      bySkill: Record<string, number>; // æŒ‰æŠ€èƒ½åˆ†ç±»
      byType: Record<string, number>;  // æŒ‰ä¼¤å®³ç±»å‹åˆ†ç±»
    };
    healing: {
      total: number;
      selfHeal: number;
      received: number;
    };
    hits: {
      total: number;
      critical: number;
      miss: number;
    };
  };
  
  // ===== Events =====
  events?: KeyEvent[];       // æœ¬å¸§æºå¸¦çš„å…³é”®äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
}

enum BattlePhase {
  Active = "active",
  Paused = "paused",
  Ended = "ended"
}

interface BuffChange {
  buffId: string;
  stacks: number;
  duration: number;          // å‰©ä½™æŒç»­æ—¶é—´ (ms)
  appliedAt: number;         // åº”ç”¨æ—¶é—´
}
```

#### æ¨é€ç­–ç•¥

```
æ­£å¸¸å‰å°ï¼š10Hz (æ¯ 100ms)
ç½‘ç»œå¥½/è®¾å¤‡å¥½ï¼šå¯è¾¾ 10Hz ä¸Šé™
é»˜è®¤é…ç½®ï¼š5-8Hz è¶³å¤Ÿå¹³æ»‘

åå°æˆ–ä½æ€§èƒ½ï¼šé™é¢‘åˆ° 2Hz (æ¯ 500ms)
å…³é”®äº‹ä»¶ï¼šä»å³æ—¶å‘é€ï¼ˆä¸å—èŠ‚æµé™åˆ¶ï¼‰
```

---

### 2. KeyEventï¼ˆå…³é”®äº‹ä»¶ï¼‰

**æ¨é€æ—¶æœº**: ç«‹å³æ¨é€ï¼Œä¸å—é¢‘ç‡é™åˆ¶  
**ä½œç”¨**: é€šçŸ¥é‡è¦æˆ˜æ–—äº‹ä»¶ï¼Œå‰ç«¯å¯ç‹¬ç«‹å±•ç¤ºåŠ¨ç”»

#### äº‹ä»¶ç±»å‹

```typescript
interface KeyEvent {
  eventId: string;
  version: number;           // äº‹ä»¶ç‰ˆæœ¬å·ï¼ˆä¸ FrameTick å…±äº«ç‰ˆæœ¬åºåˆ—ï¼‰
  timestamp: number;         // æœåŠ¡å™¨æ—¶é—´æˆ³
  battleId: string;
  eventType: KeyEventType;
  data: any;                 // äº‹ä»¶ç‰¹å®šæ•°æ®
}

enum KeyEventType {
  MonsterDeath = "monster_death",      // æ€ªç‰©æ­»äº¡
  ItemDrop = "item_drop",              // ç‰©å“æ‰è½
  PhaseTransition = "phase_transition", // é˜¶æ®µè½¬æ¢
  SkillCastComplete = "skill_cast_complete", // æŠ€èƒ½è¯»æ¡å®Œæˆ
  CriticalHit = "critical_hit",        // æš´å‡»
  PlayerDeath = "player_death",        // ç©å®¶æ­»äº¡
  BossSpawn = "boss_spawn",            // Boss å‡ºç°
  AchievementUnlock = "achievement_unlock" // æˆå°±è§£é”
}
```

#### ç¤ºä¾‹äº‹ä»¶æ•°æ®

```typescript
// æ€ªç‰©æ­»äº¡äº‹ä»¶
interface MonsterDeathEvent extends KeyEvent {
  eventType: KeyEventType.MonsterDeath;
  data: {
    monsterId: string;
    monsterName: string;
    killerId: string;      // å‡»æ€è€… ID
    position?: Vector3;    // æ­»äº¡ä½ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
    experience: number;    // è·å¾—ç»éªŒ
  };
}

// ç‰©å“æ‰è½äº‹ä»¶
interface ItemDropEvent extends KeyEvent {
  eventType: KeyEventType.ItemDrop;
  data: {
    itemId: string;
    itemName: string;
    rarity: string;        // common/rare/epic/legendary
    quantity: number;
    autoPickup: boolean;   // æ˜¯å¦è‡ªåŠ¨æ‹¾å–
  };
}

// é˜¶æ®µè½¬æ¢äº‹ä»¶
interface PhaseTransitionEvent extends KeyEvent {
  eventType: KeyEventType.PhaseTransition;
  data: {
    fromPhase: string;
    toPhase: string;
    reason: string;        // timeout/cleared/failed
  };
}
```

#### å…³é”®äº‹ä»¶å¯é™„åŠ åœ¨ FrameTick ä¸­

ä¸ºå‡å°‘ç½‘ç»œå¼€é”€ï¼Œéç´§æ€¥å…³é”®äº‹ä»¶å¯é™„åŠ åœ¨ä¸‹ä¸€ä¸ª FrameTick çš„ `events` å­—æ®µä¸­ä¸€èµ·å‘é€ã€‚

```
ç´§æ€¥äº‹ä»¶ï¼ˆç«‹å³å‘é€ï¼‰ï¼š
  - ç©å®¶æ­»äº¡
  - Boss å‡ºç°
  - æˆå°±è§£é”

å¯å»¶è¿Ÿäº‹ä»¶ï¼ˆé™„åŠ åœ¨ FrameTickï¼‰ï¼š
  - æ™®é€šæ€ªç‰©æ­»äº¡
  - æ™®é€šç‰©å“æ‰è½
  - æŠ€èƒ½è¯»æ¡å®Œæˆ
```

---

### 3. Snapshotï¼ˆå¿«ç…§ï¼‰

**æ¨é€æ—¶æœº**: 
- å®šæœŸå¿«ç…§ï¼šæ¯ 30-60 ç§’
- å¼‚å¸¸æ¢å¤ï¼šå®¢æˆ·ç«¯è¯·æ±‚æˆ–æ£€æµ‹åˆ°ç‰ˆæœ¬ç¼ºå£è¿‡å¤§æ—¶

**ä½œç”¨**: æä¾›å®Œæ•´æˆ˜æ–—çŠ¶æ€ï¼Œç”¨äºå¿«é€Ÿæ¢å¤

#### æ•°æ®ç»“æ„

```typescript
interface BattleSnapshot {
  version: number;           // å¿«ç…§ç‰ˆæœ¬å·
  serverTime: number;
  battleId: string;
  
  // å®Œæ•´æˆ˜æ–—çŠ¶æ€
  state: {
    phase: BattlePhase;
    elapsedTime: number;     // æˆ˜æ–—å·²è¿›è¡Œæ—¶é—´ (ms)
    
    // ç©å®¶çŠ¶æ€
    player: {
      health: { current: number; max: number; };
      shield: number;
      resources: Record<string, number>; // èµ„æºï¼ˆæ€’æ°”ã€æ³•åŠ›ç­‰ï¼‰
      buffs: BuffSnapshot[];
      debuffs: BuffSnapshot[];
      position?: Vector3;
    };
    
    // æ•ŒäººçŠ¶æ€
    enemies: EnemySnapshot[];
    
    // ç»Ÿè®¡æ•°æ®
    statistics: {
      totalDamage: number;
      totalHealing: number;
      totalHits: number;
      criticalHits: number;
      killCount: number;
      deathCount: number;
    };
  };
}

interface BuffSnapshot {
  buffId: string;
  stacks: number;
  remainingDuration: number;
  appliedAt: number;
}

interface EnemySnapshot {
  enemyId: string;
  enemyType: string;
  health: { current: number; max: number; };
  position?: Vector3;
  buffs: BuffSnapshot[];
}
```

#### å¿«ç…§ç­–ç•¥

```
å®šæœŸå¿«ç…§ï¼ˆæ¯ 30-60 ç§’ï¼‰ï¼š
  - å‡å°‘ç‰ˆæœ¬ç¼ºå£è¡¥å‘å‹åŠ›
  - æ”¯æŒé•¿æ—¶é—´æˆ˜æ–—

å·®å¼‚è¡¥å‘å¤±è´¥æ—¶ï¼š
  - å½“å®¢æˆ·ç«¯è¯·æ±‚è¡¥å‘ç‰ˆæœ¬èŒƒå›´ > 100 æ—¶
  - ç›´æ¥å‘é€æœ€æ–°å¿«ç…§

å®¢æˆ·ç«¯é‡è¿æ—¶ï¼š
  - æºå¸¦ lastVersion
  - å¦‚æœ lastVersion è¿‡æ—§ï¼ˆ> 300ï¼‰ï¼Œå‘é€å¿«ç…§
  - å¦åˆ™è¡¥å‘å¢é‡å¸§
```

---

## ğŸ”„ ç‰ˆæœ¬æœºåˆ¶ä¸æ¶ˆæ¯é¡ºåº

### ç‰ˆæœ¬å·è®¾è®¡

```
æ¯ä¸ªæˆ˜æ–—å®ä¾‹ç»´æŠ¤ä¸€ä¸ªå•è°ƒé€’å¢çš„ç‰ˆæœ¬å·ï¼š
  - FrameTick: æ¯å¸§ version++
  - KeyEvent: å³æ—¶äº‹ä»¶ä¹Ÿåˆ†é… version
  - Snapshot: å¿«ç…§è®°å½•å½“å‰ version

ç¤ºä¾‹åºåˆ—ï¼š
  version=1  -> FrameTick
  version=2  -> FrameTick
  version=3  -> KeyEvent (MonsterDeath)
  version=4  -> FrameTick (å¯èƒ½æºå¸¦ version=3 çš„äº‹ä»¶)
  version=5  -> FrameTick
  ...
  version=100 -> Snapshot
```

### å®¢æˆ·ç«¯ç‰ˆæœ¬ç®¡ç†

```typescript
class BattleFrameReceiver {
  private lastVersion: number = 0;
  private maxGapBeforeSnapshot: number = 100;
  
  onFrameReceived(frame: FrameTick | KeyEvent) {
    const receivedVersion = frame.version;
    
    if (receivedVersion === this.lastVersion + 1) {
      // æ­£å¸¸æƒ…å†µï¼šé¡ºåºæ¥æ”¶
      this.applyFrame(frame);
      this.lastVersion = receivedVersion;
    }
    else if (receivedVersion > this.lastVersion + 1) {
      // æ£€æµ‹åˆ°ç‰ˆæœ¬ç¼ºå£
      const gap = receivedVersion - this.lastVersion;
      
      if (gap > this.maxGapBeforeSnapshot) {
        // ç¼ºå£è¿‡å¤§ï¼Œè¯·æ±‚å¿«ç…§
        this.requestSnapshot(this.lastVersion);
      } else {
        // è¯·æ±‚å·®å¼‚è¡¥å‘
        this.requestDeltaFrames(this.lastVersion + 1, receivedVersion - 1);
      }
      
      // ä¸´æ—¶ç¼“å­˜å½“å‰å¸§ï¼ˆç­‰å¾…è¡¥å‘ååº”ç”¨ï¼‰
      this.bufferOutOfOrderFrame(frame);
    }
    else if (receivedVersion <= this.lastVersion) {
      // é‡å¤åŒ…æˆ–ä¹±åºæ—§åŒ…ï¼Œç›´æ¥ä¸¢å¼ƒ
      console.warn(`Discarding duplicate/old frame: ${receivedVersion}`);
    }
  }
  
  onSnapshotReceived(snapshot: BattleSnapshot) {
    // åº”ç”¨å¿«ç…§ï¼Œç›´æ¥æ›´æ–°åˆ°æœ€æ–°çŠ¶æ€
    this.applySnapshot(snapshot);
    this.lastVersion = snapshot.version;
    this.clearBufferedFrames(); // æ¸…ç©ºç¼“å­˜çš„ä¹±åºå¸§
  }
  
  onDeltaFramesReceived(frames: FrameTick[]) {
    // æŒ‰é¡ºåºåº”ç”¨è¡¥å‘çš„å¸§
    for (const frame of frames.sort((a, b) => a.version - b.version)) {
      if (frame.version === this.lastVersion + 1) {
        this.applyFrame(frame);
        this.lastVersion = frame.version;
      }
    }
    
    // å°è¯•åº”ç”¨ä¹‹å‰ç¼“å­˜çš„ä¹±åºå¸§
    this.flushBufferedFrames();
  }
}
```

### æœåŠ¡ç«¯è¡¥å‘æœºåˆ¶

```typescript
class BattleFrameBuffer {
  private frameHistory: Map<number, FrameTick> = new Map();
  private maxHistorySize: number = 300; // ä¿ç•™æœ€è¿‘ 300 å¸§
  private latestSnapshot: BattleSnapshot | null = null;
  
  addFrame(frame: FrameTick) {
    this.frameHistory.set(frame.version, frame);
    
    // æ¸…ç†è¿‡æ—§çš„å†å²å¸§
    if (this.frameHistory.size > this.maxHistorySize) {
      const oldestVersion = Math.min(...this.frameHistory.keys());
      this.frameHistory.delete(oldestVersion);
    }
  }
  
  getDeltaFrames(fromVersion: number, toVersion: number): FrameTick[] {
    const frames: FrameTick[] = [];
    
    for (let v = fromVersion; v <= toVersion; v++) {
      const frame = this.frameHistory.get(v);
      if (frame) {
        frames.push(frame);
      } else {
        // éƒ¨åˆ†å¸§å·²è¢«æ¸…ç†ï¼Œè¿”å›ç©ºè¡¨ç¤ºéœ€è¦å¿«ç…§
        return [];
      }
    }
    
    return frames;
  }
  
  getSnapshot(): BattleSnapshot | null {
    return this.latestSnapshot;
  }
  
  updateSnapshot(snapshot: BattleSnapshot) {
    this.latestSnapshot = snapshot;
  }
}
```

---

## ğŸ”Œ æ–­çº¿é‡è¿æµç¨‹

### å®¢æˆ·ç«¯é‡è¿ç­–ç•¥

```typescript
class BattleConnection {
  private reconnectAttempts: number = 0;
  private maxReconnectAttempts: number = 5;
  private reconnectDelays: number[] = [0, 2000, 5000, 10000, 20000]; // ms
  
  async onDisconnected() {
    console.warn("Battle connection lost, attempting to reconnect...");
    
    while (this.reconnectAttempts < this.maxReconnectAttempts) {
      const delay = this.reconnectDelays[this.reconnectAttempts] || 20000;
      await this.sleep(delay);
      
      try {
        await this.reconnect();
        console.info("Reconnected successfully");
        
        // é‡è¿æˆåŠŸï¼Œæºå¸¦ lastVersion æ¢å¤æ•°æ®
        await this.syncAfterReconnect();
        return;
      } catch (error) {
        this.reconnectAttempts++;
        console.error(`Reconnect attempt ${this.reconnectAttempts} failed:`, error);
      }
    }
    
    // é‡è¿å¤±è´¥
    this.onReconnectFailed();
  }
  
  async syncAfterReconnect() {
    const lastVersion = this.frameReceiver.getLastVersion();
    
    // è¯·æ±‚åŒæ­¥ï¼ˆæœåŠ¡ç«¯ä¼šåˆ¤æ–­æ˜¯è¡¥å‘å¢é‡è¿˜æ˜¯å¿«ç…§ï¼‰
    await this.hub.invoke("SyncBattleState", this.battleId, lastVersion);
  }
  
  onReconnectFailed() {
    // æ˜¾ç¤ºè¿æ¥å¤±è´¥æç¤ºï¼Œå…è®¸ç”¨æˆ·æ‰‹åŠ¨é‡è¯•æˆ–é€€å‡ºæˆ˜æ–—
    this.ui.showConnectionError({
      message: "æ— æ³•è¿æ¥åˆ°æˆ˜æ–—æœåŠ¡å™¨",
      actions: ["é‡è¯•", "é€€å‡ºæˆ˜æ–—"]
    });
  }
}
```

### æœåŠ¡ç«¯åŒæ­¥å¤„ç†

```csharp
// BattleHub.cs
public async Task SyncBattleState(string battleId, long clientLastVersion)
{
    var battle = _battleManager.GetBattle(battleId);
    if (battle == null)
    {
        await Clients.Caller.SendAsync("OnBattleNotFound", battleId);
        return;
    }
    
    var currentVersion = battle.CurrentVersion;
    var versionGap = currentVersion - clientLastVersion;
    
    if (versionGap <= 0)
    {
        // å®¢æˆ·ç«¯å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥
        await Clients.Caller.SendAsync("OnSyncComplete", currentVersion);
        return;
    }
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦å‘é€å¿«ç…§
    const long SnapshotThreshold = 300;
    
    if (versionGap > SnapshotThreshold || clientLastVersion == 0)
    {
        // å‘é€å¿«ç…§
        var snapshot = battle.GenerateSnapshot();
        await Clients.Caller.SendAsync("OnBattleSnapshot", snapshot);
    }
    else
    {
        // è¡¥å‘å¢é‡å¸§
        var deltaFrames = battle.GetDeltaFrames(clientLastVersion + 1, currentVersion);
        
        if (deltaFrames.Count == 0)
        {
            // å¢é‡å¸§å·²è¢«æ¸…ç†ï¼Œé™çº§ä¸ºå¿«ç…§
            var snapshot = battle.GenerateSnapshot();
            await Clients.Caller.SendAsync("OnBattleSnapshot", snapshot);
        }
        else
        {
            await Clients.Caller.SendAsync("OnDeltaFrames", deltaFrames);
        }
    }
    
    await Clients.Caller.SendAsync("OnSyncComplete", currentVersion);
}
```

---

## ğŸ¨ å‰ç«¯æ¸²æŸ“ç­–ç•¥

### æ—¶é—´åŒæ­¥

```typescript
class BattleTimeManager {
  private serverTimeOffset: number = 0; // æœåŠ¡å™¨æ—¶é—´ - å®¢æˆ·ç«¯æ—¶é—´
  private offsetSamples: number[] = [];
  private maxSamples: number = 10;
  
  // æ ¹æ® FrameTick ä¸­çš„ serverTime æ ¡å‡†æ—¶é—´åç§»
  calibrateTime(serverTime: number) {
    const clientTime = Date.now();
    const offset = serverTime - clientTime;
    
    this.offsetSamples.push(offset);
    if (this.offsetSamples.length > this.maxSamples) {
      this.offsetSamples.shift();
    }
    
    // ä½¿ç”¨ä¸­ä½æ•°å‡å°‘æŠ–åŠ¨
    this.serverTimeOffset = this.median(this.offsetSamples);
  }
  
  getServerTime(): number {
    return Date.now() + this.serverTimeOffset;
  }
  
  private median(values: number[]): number {
    const sorted = [...values].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 === 0
      ? (sorted[mid - 1] + sorted[mid]) / 2
      : sorted[mid];
  }
}
```

### æ’å€¼ä¸å¤–æ¨

```typescript
class BattleRenderer {
  private previousState: BattleState;
  private currentState: BattleState;
  private nextState: BattleState | null = null;
  
  private interpolationDelay: number = 100; // msï¼Œå»¶è¿Ÿç”¨äºæ’å€¼
  
  onFrameTick(frame: FrameTick) {
    // æ›´æ–°çŠ¶æ€å¿«ç…§
    this.previousState = this.currentState;
    this.currentState = this.nextState || this.currentState;
    this.nextState = this.extractState(frame);
  }
  
  render(renderTime: number) {
    const serverTime = this.timeManager.getServerTime();
    const targetTime = serverTime - this.interpolationDelay;
    
    // æ’å€¼æ¸²æŸ“
    if (this.nextState && targetTime >= this.currentState.timestamp) {
      const t = (targetTime - this.currentState.timestamp) 
                / (this.nextState.timestamp - this.currentState.timestamp);
      const clampedT = Math.min(Math.max(t, 0), 1);
      
      this.renderInterpolated(this.currentState, this.nextState, clampedT);
    } else {
      // å¤–æ¨æ¸²æŸ“ï¼ˆç½‘ç»œå»¶è¿Ÿæˆ–å¸§æœªåˆ°è¾¾ï¼‰
      const extrapolationTime = targetTime - this.currentState.timestamp;
      this.renderExtrapolated(this.currentState, extrapolationTime);
    }
  }
  
  renderInterpolated(from: BattleState, to: BattleState, t: number) {
    // çº¿æ€§æ’å€¼å…³é”®æ•°å€¼
    const health = this.lerp(from.health, to.health, t);
    const castProgress = this.lerp(from.castProgress || 0, to.castProgress || 0, t);
    
    this.ui.updateHealthBar(health);
    this.ui.updateCastBar(castProgress);
    
    // Buff/Debuff ä½¿ç”¨ç¦»æ•£çŠ¶æ€ï¼ˆä¸æ’å€¼ï¼‰
    this.ui.updateBuffs(to.buffs);
  }
  
  renderExtrapolated(state: BattleState, deltaTime: number) {
    // ç®€å•å¤–æ¨ï¼šå‡è®¾çº¿æ€§å˜åŒ–
    // æ³¨æ„ï¼šå¤–æ¨åº”ä¿å®ˆï¼Œé¿å…ä¸æƒå¨å€¼åå·®è¿‡å¤§
    
    if (state.castProgress !== null && state.castProgress < 1.0) {
      const extrapolatedProgress = state.castProgress + (deltaTime / state.castDuration);
      this.ui.updateCastBar(Math.min(extrapolatedProgress, 1.0));
    }
    
    // å…¶ä»–æ•°å€¼ä¿æŒä¸å˜ï¼ˆç­‰å¾…æƒå¨æ›´æ–°ï¼‰
    this.ui.updateHealthBar(state.health);
  }
  
  // å¹³æ»‘çº æ­£åˆ°æƒå¨å€¼
  smoothCorrect(displayValue: number, authorityValue: number, deltaTime: number): number {
    const error = authorityValue - displayValue;
    const correctionSpeed = 5.0; // æ¯ç§’çº æ­£é€Ÿåº¦
    
    if (Math.abs(error) < 0.01) {
      return authorityValue;
    }
    
    const correction = error * correctionSpeed * (deltaTime / 1000);
    return displayValue + correction;
  }
  
  private lerp(a: number, b: number, t: number): number {
    return a + (b - a) * t;
  }
}
```

### æ¼”å‡ºèŠ‚å¥æ§åˆ¶

```typescript
class BattleFXManager {
  private damageQueue: DamageEvent[] = [];
  private criticalQueue: CriticalEvent[] = [];
  
  onFrameTick(frame: FrameTick) {
    // æ™®é€šä¼¤å®³ï¼šåˆå¹¶ä¸ºå•ä¸ªæ•°å­—é£˜å­—
    if (frame.aggregates.damage.total > 0) {
      this.showMergedDamage(frame.aggregates.damage.total);
    }
  }
  
  onKeyEvent(event: KeyEvent) {
    switch (event.eventType) {
      case KeyEventType.CriticalHit:
        // æš´å‡»ï¼šç‹¬ç«‹åŠ¨ç”»ï¼Œéœ‡å±æ•ˆæœ
        this.playCriticalAnimation(event.data);
        break;
      
      case KeyEventType.MonsterDeath:
        // æ€ªç‰©æ­»äº¡ï¼šæ’­æ”¾æ­»äº¡åŠ¨ç”»
        this.playDeathAnimation(event.data);
        break;
      
      case KeyEventType.ItemDrop:
        // ç‰©å“æ‰è½ï¼šé—ªå…‰ç‰¹æ•ˆ + å£°éŸ³
        this.playItemDropFX(event.data);
        break;
      
      default:
        this.playGenericEventFX(event);
    }
  }
  
  private showMergedDamage(totalDamage: number) {
    // åœ¨æ•Œäººå¤´é¡¶æ˜¾ç¤ºåˆå¹¶åçš„ä¼¤å®³æ•°å­—
    this.damageText.show(totalDamage, { color: "white", fontSize: 24 });
  }
  
  private playCriticalAnimation(data: any) {
    // æ˜¾è‘—çš„æš´å‡»æ•ˆæœ
    this.damageText.show(data.damage, {
      color: "red",
      fontSize: 36,
      shake: true,
      particles: true
    });
    this.camera.shake(0.5, 200); // éœ‡å±
    this.audio.play("critical_hit");
  }
}
```

---

## ğŸ›ï¸ é¢‘ç‡ä¸èŠ‚æµç­–ç•¥

### åŠ¨æ€é¢‘ç‡è°ƒæ•´

```typescript
class BattleFrameScheduler {
  private baseFrequency: number = 10; // Hz
  private currentFrequency: number = 10;
  private minFrequency: number = 2;
  private maxFrequency: number = 10;
  
  // æ ¹æ®æ€§èƒ½å’Œç½‘ç»œçŠ¶æ€è°ƒæ•´é¢‘ç‡
  adjustFrequency() {
    const isForeground = document.visibilityState === "visible";
    const fps = this.performanceMonitor.getFPS();
    const latency = this.networkMonitor.getLatency();
    
    if (!isForeground) {
      // åå°ï¼šé™ä½åˆ° 2Hz
      this.currentFrequency = 2;
    } else if (fps < 30 || latency > 300) {
      // ä½æ€§èƒ½/é«˜å»¶è¿Ÿï¼šé™ä½é¢‘ç‡
      this.currentFrequency = Math.max(this.minFrequency, this.currentFrequency - 1);
    } else if (fps > 50 && latency < 100) {
      // é«˜æ€§èƒ½/ä½å»¶è¿Ÿï¼šæå‡é¢‘ç‡
      this.currentFrequency = Math.min(this.maxFrequency, this.currentFrequency + 1);
    }
    
    // é€šçŸ¥æœåŠ¡å™¨è°ƒæ•´æ¨é€é¢‘ç‡
    this.hub.invoke("SetFrameFrequency", this.currentFrequency);
  }
}
```

### æœåŠ¡ç«¯èŠ‚æµ

```csharp
// BattleFrameBroadcaster.cs
public class BattleFrameBroadcaster : BackgroundService
{
    private readonly IHubContext<BattleHub> _hubContext;
    private readonly ConcurrentDictionary<string, BattleFrameConfig> _battleConfigs;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            foreach (var (battleId, config) in _battleConfigs)
            {
                var interval = 1000 / config.Frequency; // ms
                
                if (DateTime.UtcNow - config.LastBroadcast >= TimeSpan.FromMilliseconds(interval))
                {
                    await BroadcastFrame(battleId, config);
                    config.LastBroadcast = DateTime.UtcNow;
                }
            }
            
            await Task.Delay(10, stoppingToken); // é«˜ç²¾åº¦è½®è¯¢
        }
    }
    
    private async Task BroadcastFrame(string battleId, BattleFrameConfig config)
    {
        var battle = _battleManager.GetBattle(battleId);
        if (battle == null) return;
        
        // ç”Ÿæˆ FrameTick
        var frame = battle.GenerateFrameTick();
        
        // å¸§åˆå¹¶ï¼šå¦‚æœæœ‰ç§¯å‹çš„å…³é”®äº‹ä»¶ï¼Œé™„åŠ åˆ°æœ¬å¸§
        var pendingEvents = battle.GetPendingKeyEvents();
        if (pendingEvents.Count > 0)
        {
            frame.Events = pendingEvents;
            battle.ClearPendingKeyEvents();
        }
        
        // æ¨é€åˆ° group
        await _hubContext.Clients.Group(battleId).SendAsync("OnFrameTick", frame);
        
        // ç¼“å­˜å¸§ï¼ˆç”¨äºè¡¥å‘ï¼‰
        battle.BufferFrame(frame);
    }
    
    public void SetBattleFrequency(string battleId, int frequency)
    {
        if (_battleConfigs.TryGetValue(battleId, out var config))
        {
            config.Frequency = Math.Clamp(frequency, 2, 10);
        }
    }
}

public class BattleFrameConfig
{
    public int Frequency { get; set; } = 8; // é»˜è®¤ 8Hz
    public DateTime LastBroadcast { get; set; }
}
```

---

## ğŸ” è¿æ¥å¤±è´¥å¤„ç†

### å®Œå…¨ç§»é™¤è½®è¯¢é™çº§

åŸè®¾è®¡ä¸­çš„è½®è¯¢é™çº§é€»è¾‘**å®Œå…¨ç§»é™¤**ï¼ŒSignalR è¿æ¥å¤±è´¥æ—¶ï¼š

1. **ç«‹å³é‡è¯•**: æŒ‰æŒ‡æ•°é€€é¿ç­–ç•¥é‡è¿ï¼ˆ0s â†’ 2s â†’ 5s â†’ 10s â†’ 20sï¼‰
2. **é‡è¿æ¬¡æ•°é™åˆ¶**: æœ€å¤š 5 æ¬¡é‡è¿å°è¯•
3. **å¤±è´¥åæç¤º**: æ˜¾ç¤ºè¿æ¥å¤±è´¥å¯¹è¯æ¡†ï¼Œæä¾›"é‡è¯•"å’Œ"é€€å‡ºæˆ˜æ–—"é€‰é¡¹

```typescript
// æ— è½®è¯¢é™çº§
class BattleConnection {
  // âŒ ç§»é™¤ï¼špollBattleState() æ–¹æ³•
  // âŒ ç§»é™¤ï¼šfallbackToPolling() æ–¹æ³•
  
  // âœ… ä¿ç•™ï¼šçº¯ SignalR é‡è¿é€»è¾‘
  async onDisconnected() {
    // ä»…é‡è¿ SignalRï¼Œä¸é™çº§åˆ°è½®è¯¢
    await this.retryConnection();
  }
  
  async retryConnection() {
    for (let i = 0; i < this.maxRetries; i++) {
      try {
        await this.connection.start();
        return; // æˆåŠŸ
      } catch {
        await this.sleep(this.retryDelays[i]);
      }
    }
    
    // é‡è¿å¤±è´¥
    this.showConnectionFailure();
  }
  
  showConnectionFailure() {
    this.ui.showModal({
      title: "è¿æ¥å¤±è´¥",
      message: "æ— æ³•è¿æ¥åˆ°æˆ˜æ–—æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",
      buttons: [
        { text: "é‡è¯•", action: () => this.retryConnection() },
        { text: "é€€å‡ºæˆ˜æ–—", action: () => this.exitBattle() }
      ]
    });
  }
}
```

### æœåŠ¡ç«¯è¿æ¥ç›‘æ§

```csharp
// BattleHub.cs
public override async Task OnConnectedAsync()
{
    var userId = Context.User?.FindFirst("sub")?.Value;
    if (string.IsNullOrEmpty(userId))
    {
        Context.Abort();
        return;
    }
    
    _logger.LogInformation("User {UserId} connected to BattleHub", userId);
    await base.OnConnectedAsync();
}

public override async Task OnDisconnectedAsync(Exception? exception)
{
    var userId = Context.User?.FindFirst("sub")?.Value;
    
    if (exception != null)
    {
        _logger.LogWarning(exception, "User {UserId} disconnected with error", userId);
    }
    else
    {
        _logger.LogInformation("User {UserId} disconnected normally", userId);
    }
    
    // æ¸…ç†ç”¨æˆ·çš„ battle group è®¢é˜…
    await CleanupUserBattles(userId);
    
    await base.OnDisconnectedAsync(exception);
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¸§åˆå¹¶ç­–ç•¥

```
åœºæ™¯ 1ï¼š50ms å†…äº§ç”Ÿå¤šä¸ªå…³é”®äº‹ä»¶
  â†’ åˆå¹¶ä¸ºä¸‹ä¸€ä¸ª FrameTick çš„ events å­—æ®µæºå¸¦

åœºæ™¯ 2ï¼šæœåŠ¡å™¨è´Ÿè½½é«˜
  â†’ å…è®¸å»¶è¿Ÿä¸€ä¸ª Tick å‘¨æœŸåˆå¹¶å‘é€
  â†’ ä¼˜å…ˆä¿è¯ FrameTick é¢‘ç‡ç¨³å®š

åœºæ™¯ 3ï¼šç´§æ€¥å…³é”®äº‹ä»¶ï¼ˆç©å®¶æ­»äº¡ã€Boss å‡ºç°ï¼‰
  â†’ ç«‹å³å•ç‹¬å‘é€ï¼Œä¸ç­‰å¾…åˆå¹¶
```

### å¸¦å®½ä¼˜åŒ–

```typescript
// ä»…å‘é€å˜åŒ–çš„ Buff/Debuff
interface FrameTick {
  metrics: {
    buffs?: BuffChange[];      // æ–°å¢æˆ–åˆ·æ–°çš„
    expiredBuffs?: string[];   // è¿‡æœŸçš„ ID åˆ—è¡¨ï¼ˆä»… IDï¼‰
  };
}

// å®¢æˆ·ç«¯ç»´æŠ¤å®Œæ•´ Buff åˆ—è¡¨
class BuffManager {
  private activeBuffs: Map<string, BuffState> = new Map();
  
  applyBuffChanges(changes: BuffChange[], expired: string[]) {
    // åº”ç”¨æ–°å¢/åˆ·æ–°
    for (const change of changes) {
      this.activeBuffs.set(change.buffId, {
        stacks: change.stacks,
        duration: change.duration,
        appliedAt: change.appliedAt
      });
    }
    
    // ç§»é™¤è¿‡æœŸ
    for (const buffId of expired) {
      this.activeBuffs.delete(buffId);
    }
  }
}
```

### å‹ç¼©ä¼˜åŒ–

```csharp
// å¯ç”¨ MessagePack åè®®ï¼ˆå¯é€‰ï¼‰
services.AddSignalR()
    .AddMessagePackProtocol(options =>
    {
        options.SerializerOptions = MessagePackSerializerOptions.Standard
            .WithCompression(MessagePackCompression.Lz4BlockArray);
    });
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### æœåŠ¡ç«¯æŒ‡æ ‡

```
battle_frame_broadcast_rate{battle_id}       # å®é™…å¹¿æ’­é¢‘ç‡
battle_frame_buffer_size{battle_id}          # å¸§ç¼“å†²åŒºå¤§å°
battle_delta_request_count{battle_id}        # è¡¥å‘è¯·æ±‚æ¬¡æ•°
battle_snapshot_request_count{battle_id}     # å¿«ç…§è¯·æ±‚æ¬¡æ•°
battle_active_connections{battle_id}         # æ´»è·ƒè¿æ¥æ•°

battle_frame_generation_duration_ms          # å¸§ç”Ÿæˆè€—æ—¶
battle_frame_send_duration_ms                # å¸§å‘é€è€—æ—¶
battle_key_event_delay_ms                    # å…³é”®äº‹ä»¶å»¶è¿Ÿ
```

### å®¢æˆ·ç«¯æŒ‡æ ‡

```
client_frame_receive_rate                    # å®é™…æ¥æ”¶é¢‘ç‡
client_frame_loss_count                      # ä¸¢å¸§æ¬¡æ•°
client_version_gap_count                     # ç‰ˆæœ¬ç¼ºå£æ¬¡æ•°
client_delta_request_count                   # è¡¥å‘è¯·æ±‚æ¬¡æ•°
client_snapshot_apply_count                  # å¿«ç…§åº”ç”¨æ¬¡æ•°

client_render_fps                            # æ¸²æŸ“å¸§ç‡
client_time_sync_offset_ms                   # æ—¶é—´åŒæ­¥åç§»
client_interpolation_lag_ms                  # æ’å€¼å»¶è¿Ÿ
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### å•å…ƒæµ‹è¯•

```typescript
describe("BattleFrameReceiver", () => {
  it("should apply frames in order", () => {
    const receiver = new BattleFrameReceiver();
    
    receiver.onFrameReceived({ version: 1, /* ... */ });
    receiver.onFrameReceived({ version: 2, /* ... */ });
    
    expect(receiver.getLastVersion()).toBe(2);
  });
  
  it("should detect version gap and request delta", () => {
    const receiver = new BattleFrameReceiver();
    const requestSpy = jest.spyOn(receiver, "requestDeltaFrames");
    
    receiver.onFrameReceived({ version: 1, /* ... */ });
    receiver.onFrameReceived({ version: 5, /* ... */ }); // ç¼ºå£
    
    expect(requestSpy).toHaveBeenCalledWith(2, 4);
  });
  
  it("should request snapshot for large gap", () => {
    const receiver = new BattleFrameReceiver();
    const requestSpy = jest.spyOn(receiver, "requestSnapshot");
    
    receiver.onFrameReceived({ version: 1, /* ... */ });
    receiver.onFrameReceived({ version: 150, /* ... */ }); // å¤§ç¼ºå£
    
    expect(requestSpy).toHaveBeenCalled();
  });
});
```

### é›†æˆæµ‹è¯•

```csharp
[Fact]
public async Task BattleFrameBroadcaster_ShouldSendFramesAtConfiguredFrequency()
{
    // Arrange
    var broadcaster = CreateBroadcaster();
    var battle = CreateMockBattle();
    var receivedFrames = new List<FrameTick>();
    
    // Act
    broadcaster.StartBroadcast(battle.Id, frequency: 10); // 10Hz
    await Task.Delay(1100); // ç­‰å¾… 1.1 ç§’
    broadcaster.StopBroadcast(battle.Id);
    
    // Assert
    Assert.InRange(receivedFrames.Count, 9, 12); // å…è®¸ Â±1 å¸§è¯¯å·®
}

[Fact]
public async Task BattleHub_ShouldHandleDeltaRequest()
{
    // Arrange
    var hub = CreateHub();
    var battle = CreateBattleWithHistory(version: 100);
    
    // Act
    await hub.SyncBattleState(battle.Id, clientLastVersion: 80);
    
    // Assert
    // éªŒè¯å®¢æˆ·ç«¯æ”¶åˆ° version 81-100 çš„å¸§
}
```

### å‹åŠ›æµ‹è¯•

```typescript
describe("Performance", () => {
  it("should handle 1000 concurrent battles at 10Hz", async () => {
    const battles = Array(1000).fill(null).map(() => createBattle());
    const startTime = Date.now();
    
    // è¿è¡Œ 10 ç§’
    await runBattlesFor(battles, 10000);
    
    const elapsedTime = Date.now() - startTime;
    const framesSent = battles.reduce((sum, b) => sum + b.frameCount, 0);
    const avgFrameRate = framesSent / (elapsedTime / 1000) / 1000;
    
    expect(avgFrameRate).toBeGreaterThanOrEqual(9); // è‡³å°‘ 9Hz
  });
});
```

---

## ğŸ“¦ éƒ¨ç½²é…ç½®

### appsettings.json

```json
{
  "BattleFrameSystem": {
    "DefaultFrequency": 8,
    "MinFrequency": 2,
    "MaxFrequency": 10,
    "ForegroundFrequency": 10,
    "BackgroundFrequency": 2,
    "SnapshotInterval": 60000,
    "MaxFrameBufferSize": 300,
    "SnapshotThreshold": 100,
    "MaxDeltaRequestGap": 100
  },
  "SignalR": {
    "MaximumReceiveMessageSize": 1048576,
    "StreamBufferCapacity": 10,
    "EnableDetailedErrors": true,
    "KeepAliveInterval": "00:00:10",
    "ClientTimeoutInterval": "00:00:30"
  }
}
```

### Program.cs

```csharp
builder.Services.AddSignalR(options =>
{
    options.EnableDetailedErrors = builder.Environment.IsDevelopment();
    options.MaximumReceiveMessageSize = 1 * 1024 * 1024; // 1MB
    options.KeepAliveInterval = TimeSpan.FromSeconds(10);
    options.ClientTimeoutInterval = TimeSpan.FromSeconds(30);
});

// æ³¨å†Œå¸§å¹¿æ’­æœåŠ¡
builder.Services.AddHostedService<BattleFrameBroadcaster>();
builder.Services.AddSingleton<IBattleFrameBuffer, BattleFrameBuffer>();

app.MapHub<BattleHub>("/hubs/battle");
```

---

## ğŸ“ è¿ç§»æŒ‡å—

### ä»æ—§è®¾è®¡è¿ç§»

#### 1. ç§»é™¤è½®è¯¢ç›¸å…³ä»£ç 

```typescript
// âŒ åˆ é™¤
class BattleApiService {
  pollBattleState() { /* ... */ }
  startPolling() { /* ... */ }
  stopPolling() { /* ... */ }
}

// âŒ åˆ é™¤é™çº§é€»è¾‘
if (signalRFailed) {
  fallbackToPolling();
}
```

#### 2. æ›¿æ¢ CombatSegment ä¸º FrameTick

```typescript
// æ—§ä»£ç 
connection.on("OnCombatSegmentUpdate", (segment: CombatSegment) => {
  // åº”ç”¨èšåˆæ•°æ®
});

// æ–°ä»£ç 
connection.on("OnFrameTick", (frame: FrameTick) => {
  // åº”ç”¨å®æ—¶å¸§æ•°æ®
  this.frameReceiver.onFrameReceived(frame);
});

connection.on("OnKeyEvent", (event: KeyEvent) => {
  // å¤„ç†å…³é”®äº‹ä»¶
  this.eventHandler.handleKeyEvent(event);
});
```

#### 3. æ·»åŠ ç‰ˆæœ¬ç®¡ç†

```typescript
// æ–°å¢
class BattleState {
  private lastVersion: number = 0;
  
  applyFrame(frame: FrameTick) {
    if (frame.version !== this.lastVersion + 1) {
      this.handleVersionGap(frame);
    } else {
      this.updateState(frame);
      this.lastVersion = frame.version;
    }
  }
}
```

#### 4. å®ç°æ—¶é—´åŒæ­¥

```typescript
// æ–°å¢
class TimeSync {
  private offsetSamples: number[] = [];
  
  calibrate(serverTime: number) {
    const offset = serverTime - Date.now();
    this.offsetSamples.push(offset);
    // ...
  }
}
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

âœ… **æŒç»­ SignalR æµ**: å®Œå…¨æ›¿ä»£è½®è¯¢ï¼Œè¿æ¥å¤±è´¥ç›´æ¥é‡è¿  
âœ… **ä½å»¶è¿Ÿæ¨é€**: 5-10Hz å›ºå®šé¢‘ç‡ï¼Œå»¶è¿Ÿ < 200ms  
âœ… **ç‰ˆæœ¬æœºåˆ¶**: å¤„ç†ä¹±åº/ä¸¢åŒ…ï¼Œæ”¯æŒå·®å¼‚è¡¥å‘  
âœ… **å¿«ç…§æ¢å¤**: å®šæœŸå¿«ç…§ + æ–­çº¿é‡è¿å¿«é€Ÿæ¢å¤  
âœ… **å¹³æ»‘æ¸²æŸ“**: æ—¶é—´åŒæ­¥ + æ’å€¼å¤–æ¨ + å¹³æ»‘çº æ­£  
âœ… **æ¼”å‡ºåˆ†çº§**: æ™®é€šä¼¤å®³åˆå¹¶ï¼Œå…³é”®äº‹ä»¶ç‹¬ç«‹åŠ¨ç”»

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| æ¨é€å»¶è¿Ÿ | < 200ms (10Hz) |
| ç‰ˆæœ¬ç¼ºå£æ¢å¤ | < 500ms |
| å¿«ç…§ç”Ÿæˆ | < 50ms |
| å®¢æˆ·ç«¯æ¸²æŸ“ | 60 FPS |
| é‡è¿æ¢å¤ | < 3s (æ­£å¸¸ç½‘ç»œ) |

### åç»­ä¼˜åŒ–æ–¹å‘

1. **WebTransport**: æœªæ¥å¯æ›¿ä»£ WebSocketï¼Œè¿›ä¸€æ­¥é™ä½å»¶è¿Ÿ
2. **é¢„æµ‹æ¸²æŸ“**: å®¢æˆ·ç«¯é¢„æµ‹ç©å®¶æ“ä½œï¼Œå‡å°‘æ„ŸçŸ¥å»¶è¿Ÿ
3. **è‡ªé€‚åº”ç ç‡**: æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´æ•°æ®è¯¦ç»†åº¦
4. **åˆ†å¸ƒå¼ SignalR**: ä½¿ç”¨ Redis Backplane æ”¯æŒæ¨ªå‘æ‰©å±•

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ21æ—¥
