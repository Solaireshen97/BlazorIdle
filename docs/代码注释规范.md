# 代码注释规范

**项目**: BlazorIdle  
**文档版本**: 1.0  
**创建日期**: 2025-10-15  
**适用范围**: BlazorIdle.Server 项目

---

## 📋 目录

1. [注释原则](#注释原则)
2. [类级注释](#类级注释)
3. [方法级注释](#方法级注释)
4. [API控制器注释](#api控制器注释)
5. [算法注释](#算法注释)
6. [TODO注释](#todo注释)
7. [示例](#示例)

---

## 注释原则

### 核心原则
1. **清晰性优先** - 注释应该清晰易懂，避免技术黑话
2. **中文为主** - 使用中文注释，提高可读性
3. **保持更新** - 代码变更时同步更新注释
4. **避免冗余** - 不注释显而易见的代码
5. **说明为什么** - 重点解释"为什么"而不是"做什么"

### 注释层级

| 优先级 | 代码类型 | 必需性 | 注释覆盖率要求 |
|--------|----------|--------|---------------|
| P0 | 公共API（Controllers） | 必需 | 100% |
| P0 | 核心引擎（BattleEngine等） | 必需 | 100% |
| P1 | 领域服务（Services） | 必需 | 90%+ |
| P1 | 工具类（Helpers/Utilities） | 必需 | 90%+ |
| P2 | 内部类（Internal） | 推荐 | 60%+ |
| P2 | 私有方法（Private） | 可选 | 30%+ |

---

## 类级注释

### 标准格式

```csharp
/// <summary>
/// [类的简要描述 - 一句话说明职责]
/// </summary>
/// <remarks>
/// 职责：
/// 1. [核心职责1]
/// 2. [核心职责2]
/// 3. [核心职责3]
/// 
/// 使用场景：
/// - [场景1]
/// - [场景2]
/// 
/// 注意事项：
/// - [重要提示1]
/// - [重要提示2]
/// </remarks>
public class ExampleService
{
    // 类实现
}
```

### 示例

```csharp
/// <summary>
/// 战斗引擎 - 核心战斗循环处理器
/// </summary>
/// <remarks>
/// 职责：
/// 1. 驱动事件调度器推进战斗时间
/// 2. 处理攻击、技能、Buff等战斗事件
/// 3. 管理敌人生成和波次切换
/// 
/// 使用场景：
/// - BattlesController 创建战斗实例
/// - 离线结算系统模拟战斗
/// - 战斗回放系统
/// 
/// 注意事项：
/// - 战斗引擎是有状态的，不可重用同一实例
/// - 所有时间以秒为单位
/// </remarks>
public sealed class BattleEngine
{
    // 类实现
}
```

---

## 方法级注释

### 标准格式

```csharp
/// <summary>
/// [方法功能的简要描述]
/// </summary>
/// <param name="paramName">[参数说明]</param>
/// <returns>[返回值说明]</returns>
/// <exception cref="ExceptionType">[什么情况下抛出异常]</exception>
/// <remarks>
/// [可选] 详细说明、算法描述、性能考虑等
/// </remarks>
/// <example>
/// [可选] 使用示例
/// <code>
/// var result = await SomeMethod(param1, param2);
/// </code>
/// </example>
```

### 参数注释规范

| 参数类型 | 注释内容 |
|---------|---------|
| ID类参数 | "角色ID" / "装备ID" / "用户ID" |
| 配置参数 | 说明配置的作用和默认值 |
| 可选参数 | 说明默认值和省略时的行为 |
| 复杂对象 | 说明对象的用途和必需字段 |

### 返回值注释规范

| 返回类型 | 注释内容 |
|---------|---------|
| bool | "是否成功" / "是否满足条件" |
| Result<T> | "操作结果，成功时包含[数据]，失败时包含错误消息" |
| Task<T> | "异步操作，返回[结果说明]" |
| null | 明确说明什么情况下返回null |

### 示例

```csharp
/// <summary>
/// 推进战斗到指定时间点
/// </summary>
/// <param name="targetTime">目标时间（秒），必须大于当前战斗时间</param>
/// <returns>战斗是否已结束</returns>
/// <exception cref="InvalidOperationException">当战斗已结束时抛出</exception>
/// <exception cref="ArgumentException">当目标时间小于当前时间时抛出</exception>
/// <remarks>
/// 处理流程：
/// 1. 验证战斗状态和目标时间
/// 2. 从事件队列中依次处理所有时间 <= targetTime 的事件
/// 3. 更新游戏时钟到目标时间
/// 4. 检查战斗结束条件
/// 
/// 性能考虑：
/// - 单次调用处理的事件数取决于时间跨度
/// - 建议每次推进不超过10秒，避免阻塞
/// </remarks>
public bool AdvanceTo(double targetTime)
{
    // 方法实现
}
```

---

## API控制器注释

### Controller类注释

```csharp
/// <summary>
/// [模块名称] API 控制器
/// </summary>
/// <remarks>
/// 提供的功能：
/// - [功能1说明]
/// - [功能2说明]
/// - [功能3说明]
/// 
/// 认证要求：
/// - [哪些接口需要认证]
/// - [使用的认证方式]
/// 
/// 基础路由：/api/[controller]
/// </remarks>
[ApiController]
[Route("api/[controller]")]
public class ExampleController : ControllerBase
{
    // 实现
}
```

### API方法注释

```csharp
/// <summary>
/// [接口功能简述]
/// </summary>
/// <param name="id">[参数说明]</param>
/// <returns>[返回内容说明]</returns>
/// <response code="200">[成功情况说明]</response>
/// <response code="400">[请求错误情况说明]</response>
/// <response code="401">[未授权情况说明]</response>
/// <response code="404">[未找到情况说明]</response>
/// <remarks>
/// 请求示例：
/// <code>
/// GET /api/characters/123e4567-e89b-12d3-a456-426614174000
/// </code>
/// 
/// 响应示例：
/// <code>
/// {
///   "id": "123e4567-e89b-12d3-a456-426614174000",
///   "name": "战士角色",
///   "level": 10
/// }
/// </code>
/// </remarks>
[HttpGet("{id:guid}")]
public async Task<ActionResult<CharacterDto>> GetCharacter(Guid id)
{
    // 方法实现
}
```

---

## 算法注释

### 复杂算法的步骤注释

```csharp
public double CalculateDamage(...)
{
    // 1. 计算基础伤害
    var baseDamage = weaponDamage + attackPower * coefficient;
    
    // 2. 应用暴击修正
    if (IsCritical(critChance))
    {
        baseDamage *= critMultiplier;
    }
    
    // 3. 应用护甲减免
    var effectiveArmor = CalculateEffectiveArmor(targetArmor, armorPenetration);
    var reduction = effectiveArmor / (effectiveArmor + K);
    var finalDamage = baseDamage * (1 - reduction);
    
    // 4. 应用伤害浮动 (±5%)
    finalDamage *= Random.Range(0.95, 1.05);
    
    return Math.Max(1, finalDamage);  // 保证至少造成1点伤害
}
```

### 关键决策点注释

```csharp
// 使用双手武器时需要卸下主手和副手装备
// 这是游戏设计决策，防止同时装备三件武器
if (weaponType == WeaponType.TwoHand)
{
    UnequipSlot(EquipmentSlot.MainHand);
    UnequipSlot(EquipmentSlot.OffHand);
}
```

### 性能相关注释

```csharp
// 性能优化：使用Dictionary而不是List.Find()
// 在大量装备查询时，Dictionary查找是O(1)，List是O(n)
private readonly Dictionary<Guid, GearInstance> _gearCache = new();
```

---

## TODO注释

### 标准格式

```csharp
// TODO: [优先级] [任务描述] - [负责人] [日期]
// TODO: P0 实现装备耐久度系统 - 张三 2025-10-20
// TODO: P1 优化战斗日志性能 - 李四 2025-11-01
// TODO: P2 添加套装加成显示 - 王五 待定
```

### 优先级定义

| 优先级 | 说明 | 时间要求 |
|--------|------|---------|
| P0 | 紧急/阻塞性问题 | 立即处理 |
| P1 | 重要功能缺失 | 本周内 |
| P2 | 优化改进 | 下个版本 |
| P3 | 长期规划 | 未来考虑 |

---

## 示例

### 完整的类注释示例

```csharp
using System;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;

namespace BlazorIdle.Server.Domain.Equipment.Services;

/// <summary>
/// 装备分解服务
/// </summary>
/// <remarks>
/// 职责：
/// 1. 验证装备归属和状态
/// 2. 计算分解产出的材料
/// 3. 删除装备并添加材料到背包
/// 
/// 使用场景：
/// - EquipmentController 处理玩家分解请求
/// - 批量分解功能
/// - 自动分解低品质装备
/// 
/// 注意事项：
/// - 已装备的装备不能分解
/// - 分解是不可逆操作
/// - 材料计算基于装备品级和稀有度
/// </remarks>
public class DisenchantService
{
    private readonly GameDbContext _context;
    private readonly ILogger<DisenchantService> _logger;

    /// <summary>
    /// 构造函数
    /// </summary>
    /// <param name="context">数据库上下文</param>
    /// <param name="logger">日志记录器</param>
    public DisenchantService(GameDbContext context, ILogger<DisenchantService> logger)
    {
        _context = context;
        _logger = logger;
    }

    /// <summary>
    /// 分解装备为材料
    /// </summary>
    /// <param name="characterId">角色ID</param>
    /// <param name="gearInstanceId">装备实例ID</param>
    /// <returns>分解结果，包含获得的材料列表</returns>
    /// <exception cref="ArgumentException">当ID无效时抛出</exception>
    /// <remarks>
    /// 处理流程：
    /// 1. 验证参数和装备归属
    /// 2. 检查装备是否已装备（已装备不能分解）
    /// 3. 根据装备品级和稀有度计算材料产出
    /// 4. 删除装备实例
    /// 5. 添加材料到角色背包
    /// 
    /// 材料计算规则：
    /// - T1装备：基础材料 x 1
    /// - T2装备：基础材料 x 2 + 中级材料 x 1
    /// - T3装备：基础材料 x 3 + 高级材料 x 1 + 精华 x 1
    /// </remarks>
    public async Task<DisenchantResult> DisenchantAsync(Guid characterId, Guid gearInstanceId)
    {
        // 方法实现
    }
}
```

---

## 注释检查清单

### 代码审查时的检查项

- [ ] 所有公共类有完整的类级注释
- [ ] 所有公共方法有 summary 和参数说明
- [ ] 异常情况有 exception 标签说明
- [ ] 复杂算法有步骤注释
- [ ] TODO 注释包含优先级和时间
- [ ] 注释使用清晰的中文表达
- [ ] 注释与代码保持同步

---

## 工具支持

### Visual Studio / Rider
- 输入 `///` 自动生成XML注释模板
- Alt+Enter → Generate Documentation

### VS Code
- 安装 C# XML Documentation Comments 插件
- 输入 `///` 自动生成模板

---

## 参考资料

- [C# XML Documentation Comments](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/xmldoc/)
- [装备系统优化报告](./装备系统持续优化报告2025-10-12.md) - 良好注释示例
- [ValidationHelper.cs](../BlazorIdle.Server/Domain/Common/Utilities/ValidationHelper.cs) - 工具类注释示例

---

**文档状态**: ✅ 已完成  
**适用版本**: BlazorIdle Server v1.0+  
**最后更新**: 2025-10-15
