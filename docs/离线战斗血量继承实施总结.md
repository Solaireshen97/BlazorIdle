# ç¦»çº¿æˆ˜æ–—è¡€é‡ç»§æ‰¿å®æ–½æ€»ç»“

## ğŸ“Œ é—®é¢˜åˆ†æ

### åŸæœ‰é—®é¢˜
åœ¨åŸæœ‰å®ç°ä¸­ï¼Œç¦»çº¿æˆ˜æ–—ç³»ç»Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. **åœ¨çº¿æˆ˜æ–—**é€šè¿‡`RunningBattle`åœ¨å†…å­˜ä¸­ç»´æŠ¤æ•Œäººçš„å½“å‰è¡€é‡
2. **ç¦»çº¿æˆ˜æ–—**é€šè¿‡`OfflineFastForwardEngine`é‡æ–°åˆ›å»ºæˆ˜æ–—ï¼Œæ•Œäººè¡€é‡æ€»æ˜¯ä»æ»¡è¡€å¼€å§‹
3. **æ— æ„Ÿç»§æ‰¿ç¼ºå¤±**ï¼šå¦‚æœç©å®¶åœ¨çº¿æˆ˜æ–—æ‰“åˆ°ä¸€åŠï¼ˆæ•Œäººå‰©ä½™50%è¡€é‡ï¼‰åç¦»çº¿ï¼Œç¦»çº¿ç»“ç®—æ—¶æ•Œäººä¼šé‡æ–°ä»100%è¡€é‡å¼€å§‹è®¡ç®—ï¼Œå¯¼è‡´è¿›åº¦ä¸¢å¤±

### ç”¨æˆ·éœ€æ±‚
å®ç°**æ— æ„Ÿçš„ç¦»çº¿æˆ˜æ–—æ•ˆæœ**ï¼š
- æ€ªç‰©çš„è¡€é‡åº”è¯¥ç»§æ‰¿åœ¨çº¿æˆ˜æ–—çš„è¿›åº¦
- å¦‚æœå‰¯æœ¬æ‰“åˆ°ä¸€åŠè¿›å…¥ç¦»çº¿ï¼Œåº”è¯¥ä»ç¦»çº¿æ—¶é—´ç‚¹çš„è¿›åº¦ï¼ˆæ³¢æ•°ã€æ•Œäººè¡€é‡ï¼‰ç»§ç»­è®¡ç®—
- ä¸Šçº¿æ—¶å¦‚æœè®¡åˆ’æœªå®Œæˆï¼Œåœ¨çº¿è®¡ç®—åº”è¯¥èƒ½å¤Ÿç»§æ‰¿ç¦»çº¿è®¡ç®—çš„ç»“æœ

---

## âœ… å®æ–½æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
é€šè¿‡åœ¨`ActivityPlan`ä¸­ä¿å­˜**æˆ˜æ–—è¿›åº¦å¿«ç…§**ï¼Œå®ç°åœ¨çº¿->ç¦»çº¿->åœ¨çº¿çš„æ— ç¼çŠ¶æ€ç»§æ‰¿ã€‚

### å…³é”®æ•°æ®ç»“æ„

#### 1. BattleProgressSnapshotï¼ˆæ–°å¢ï¼‰
```csharp
public class BattleProgressSnapshot
{
    /// <summary>å½“å‰ä¸»è¦æ•Œäººçš„è¡€é‡</summary>
    public int? PrimaryEnemyHp { get; set; }
    
    /// <summary>å½“å‰æ³¢æ¬¡ç´¢å¼•ï¼ˆç”¨äºå‰¯æœ¬ï¼‰</summary>
    public int? WaveIndex { get; set; }
    
    /// <summary>å·²å®Œæˆçš„Runæ•°é‡ï¼ˆç”¨äºå‰¯æœ¬ï¼‰</summary>
    public int? RunCount { get; set; }
    
    /// <summary>å¿«ç…§æ—¶é—´ï¼ˆæ¸¸æˆæ—¶é—´ï¼Œç§’ï¼‰</summary>
    public double SimulatedSeconds { get; set; }
}
```

#### 2. ActivityPlan æ‰©å±•
```csharp
public class ActivityPlan
{
    // ... åŸæœ‰å­—æ®µ ...
    
    /// <summary>æˆ˜æ–—è¿›åº¦å¿«ç…§JSONï¼ˆç”¨äºä¿å­˜æ•Œäººè¡€é‡ç­‰çŠ¶æ€ï¼Œæ”¯æŒæ— æ„Ÿç»§æ‰¿ï¼‰</summary>
    public string? BattleProgressJson { get; set; }
}
```

#### 3. Encounter æ‰©å±•
```csharp
public class Encounter
{
    // ... åŸæœ‰ä»£ç  ...
    
    /// <summary>
    /// æ„é€ å‡½æ•°ï¼šæ”¯æŒè‡ªå®šä¹‰åˆå§‹è¡€é‡ï¼ˆç”¨äºæˆ˜æ–—è¿›åº¦ç»§æ‰¿ï¼‰
    /// </summary>
    public Encounter(EnemyDefinition enemy, int initialHp)
    {
        Enemy = enemy;
        CurrentHp = Math.Min(Math.Max(0, initialHp), enemy.MaxHp);
    }
}
```

---

## ğŸ”„ å®ç°ç»†èŠ‚

### 1. ç¦»çº¿æˆ˜æ–—æ¢å¤è¿›åº¦

åœ¨`OfflineFastForwardEngine.SimulateBattle()`ä¸­ï¼š

```csharp
// 1. å°è¯•æ¢å¤æˆ˜æ–—è¿›åº¦å¿«ç…§
BattleProgressSnapshot? progressSnapshot = null;
if (!string.IsNullOrWhiteSpace(plan.BattleProgressJson))
{
    progressSnapshot = JsonSerializer.Deserialize<BattleProgressSnapshot>(plan.BattleProgressJson);
}

// 2. å°†æ¢å¤çš„è¡€é‡ä¼ é€’ç»™æˆ˜æ–—é…ç½®
config = new BattleSimulator.BattleConfig
{
    // ... å…¶ä»–é…ç½® ...
    InitialEnemyHp = progressSnapshot?.PrimaryEnemyHp
};
```

### 2. ContinuousEncounterProvider æ”¯æŒåˆå§‹è¡€é‡

```csharp
public ContinuousEncounterProvider(
    EnemyDefinition enemy, 
    int count, 
    double respawnDelaySeconds = 3.0, 
    int? initialEnemyHp = null)  // æ–°å¢å‚æ•°
{
    _initialEnemyHp = initialEnemyHp;
    // ... åˆå§‹åŒ–é€»è¾‘ ...
}

private EncounterGroup BuildGroup()
{
    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç»„ä¸”è®¾ç½®äº†åˆå§‹è¡€é‡ï¼Œä½¿ç”¨è‡ªå®šä¹‰è¡€é‡
    if (_isFirstGroup && _initialEnemyHp.HasValue)
    {
        var encounters = new List<Encounter>();
        encounters.Add(new Encounter(_enemy, _initialEnemyHp.Value)); // ç¬¬ä¸€ä¸ªæ•Œäººç”¨è‡ªå®šä¹‰è¡€é‡
        for (int i = 1; i < _count; i++)
            encounters.Add(new Encounter(_enemy)); // å…¶ä½™æ»¡è¡€
        return new EncounterGroup(encounters);
    }
    // ... æ­£å¸¸é€»è¾‘ ...
}
```

### 3. ä¿å­˜æˆ˜æ–—è¿›åº¦

åœ¨`OfflineFastForwardEngine.FastForward()`ä¸­ï¼š

```csharp
// åˆ¤æ–­è®¡åˆ’æ˜¯å¦å®Œæˆ
var planCompleted = plan.IsLimitReached();
if (planCompleted)
{
    plan.State = ActivityState.Completed;
    plan.CompletedAt = DateTime.UtcNow;
    plan.BattleProgressJson = null;  // å®Œæˆæ—¶æ¸…ç©ºå¿«ç…§
}
else
{
    // è®¡åˆ’æœªå®Œæˆæ—¶ä¿å­˜æˆ˜æ–—è¿›åº¦å¿«ç…§
    SaveBattleProgress(plan, simulationResult);
}
```

```csharp
private void SaveBattleProgress(ActivityPlan plan, SimulationResultWithEconomy result)
{
    if (result.BattleSnapshot is null) return;
    
    var snapshot = new BattleProgressSnapshot
    {
        PrimaryEnemyHp = result.BattleSnapshot.PrimaryEnemyHp,
        WaveIndex = result.BattleSnapshot.WaveIndex,
        RunCount = result.BattleSnapshot.RunCount,
        SimulatedSeconds = plan.ExecutedSeconds
    };
    
    plan.BattleProgressJson = JsonSerializer.Serialize(snapshot);
}
```

---

## ğŸ§ª å•å…ƒæµ‹è¯•

### æµ‹è¯•åœºæ™¯

#### 1. åŸºç¡€è¿›åº¦ç»§æ‰¿æµ‹è¯•
```csharp
[Fact]
public void FastForward_WithEnemyHpInPayload_ShouldInheritEnemyHp()
{
    // æµ‹è¯•ä»å·²æŸå¤±éƒ¨åˆ†è¡€é‡çš„æˆ˜æ–—ç»§ç»­
}
```

#### 2. è®¡åˆ’å®Œæˆæ—¶æ¸…ç©ºå¿«ç…§
```csharp
[Fact]
public void FastForward_CompletedPlan_ShouldClearBattleProgress()
{
    // éªŒè¯è®¡åˆ’å®Œæˆåä¸ä¿ç•™å¿«ç…§
}
```

#### 3. å¤šæ¬¡ç¦»çº¿ç»§æ‰¿é“¾
```csharp
[Fact]
public void FastForward_MultipleOfflineSessions_ShouldChainProgress()
{
    // éªŒè¯å¤šæ¬¡ç¦»çº¿-ä¸Šçº¿å¾ªç¯ä¸­è¿›åº¦æ­£ç¡®ç´¯ç§¯
}
```

### æµ‹è¯•ç»“æœ
âœ… æ‰€æœ‰æ–°å¢æµ‹è¯•é€šè¿‡  
âœ… æ‰€æœ‰ç°æœ‰æµ‹è¯•ä»ç„¶é€šè¿‡  
âœ… æ„å»ºæ— é”™è¯¯

---

## ğŸ“Š æ•°æ®æµå›¾

```
[åœ¨çº¿æˆ˜æ–—]
    â†“ (ç©å®¶ç¦»çº¿)
    ä¿å­˜è¿›åº¦å¿«ç…§åˆ° ActivityPlan.BattleProgressJson
    {
        PrimaryEnemyHp: 50,  // å½“å‰è¡€é‡
        WaveIndex: 3,
        SimulatedSeconds: 1200
    }
    â†“
[ç¦»çº¿æˆ˜æ–—]
    â†“ è¯»å– BattleProgressJson
    â†“ åˆ›å»º Encounter(enemy, initialHp: 50)
    â†“ ç»§ç»­æˆ˜æ–—æ¨¡æ‹Ÿ
    â†“ ä¿å­˜æ–°çš„è¿›åº¦å¿«ç…§
    {
        PrimaryEnemyHp: 20,  // æ›´æ–°åçš„è¡€é‡
        WaveIndex: 3,
        SimulatedSeconds: 2400
    }
    â†“ (ç©å®¶ä¸Šçº¿)
[åœ¨çº¿æˆ˜æ–—]
    â†“ è¯»å– BattleProgressJson
    â†“ ç»§æ‰¿ç¦»çº¿è¿›åº¦ç»§ç»­æˆ˜æ–—
```

---

## ğŸ¯ è¦†ç›–çš„åœºæ™¯

### âœ… å·²å®ç°
1. **æŒç»­æˆ˜æ–—æ¨¡å¼** (Continuous)
   - å•ä¸ªæ•Œäººè¡€é‡ç»§æ‰¿
   - å¤šä¸ªæ•Œäººæ—¶ï¼Œä¸»ç›®æ ‡è¡€é‡ç»§æ‰¿ï¼Œå…¶ä»–æ•Œäººæ»¡è¡€
   
2. **æ—¶é•¿é™åˆ¶è®¡åˆ’** (Duration)
   - ä»ç¦»çº¿æ—¶åˆ»çš„è¿›åº¦æ— æ„Ÿç»§ç»­
   - è®¡åˆ’å®Œæˆæ—¶è‡ªåŠ¨æ¸…ç©ºå¿«ç…§
   
3. **æ— é™è®¡åˆ’** (Infinite)
   - æ”¯æŒé•¿æœŸç¦»çº¿ï¼Œæ¯æ¬¡ç»§æ‰¿æœ€æ–°è¿›åº¦

4. **å¤šæ¬¡ç¦»çº¿å¾ªç¯**
   - æ”¯æŒåœ¨çº¿->ç¦»çº¿->åœ¨çº¿->ç¦»çº¿...çš„å¤šæ¬¡åˆ‡æ¢
   - æ¯æ¬¡éƒ½æ­£ç¡®ç»§æ‰¿ä¸Šä¸€æ¬¡çš„çŠ¶æ€

### ğŸ”„ æœªæ¥æ‰©å±•ï¼ˆå¦‚éœ€è¦ï¼‰
1. **å‰¯æœ¬æ¨¡å¼** (Dungeon)
   - å½“å‰å®ç°å·²é¢„ç•™ `WaveIndex` å’Œ `RunCount` å­—æ®µ
   - å¯æ‰©å±•æ”¯æŒå‰¯æœ¬æ³¢æ¬¡ç»§æ‰¿
   
2. **å¤šæ•Œäººè¯¦ç»†çŠ¶æ€**
   - å½“å‰åªä¿å­˜ä¸»ç›®æ ‡è¡€é‡
   - å¯æ‰©å±•ä¸ºä¿å­˜æ‰€æœ‰æ•Œäººè¡€é‡çš„æ•°ç»„

---

## ğŸ“ ä»£ç é£æ ¼éµå¾ª

1. **æœ€å°åŒ–ä¿®æ”¹åŸåˆ™**
   - åªä¿®æ”¹å¿…è¦çš„ç±»å’Œæ–¹æ³•
   - æ–°å¢å­—æ®µæ ‡è®°ä¸ºå¯é€‰ (`?`)ï¼Œå‘åå…¼å®¹
   
2. **ä¸­æ–‡æ³¨é‡Šé£æ ¼**
   - ä¸é¡¹ç›®ç°æœ‰æ³¨é‡Šé£æ ¼ä¿æŒä¸€è‡´
   - ä½¿ç”¨ XML æ–‡æ¡£æ³¨é‡Š

3. **æ•°æ®é©±åŠ¨è®¾è®¡**
   - ä½¿ç”¨ JSON åºåˆ—åŒ–ä¿å­˜å¿«ç…§
   - å¿«ç…§è®¾è®¡æ”¯æŒæœªæ¥æ‰©å±•

4. **é”™è¯¯å®¹å¿**
   - ååºåˆ—åŒ–å¤±è´¥æ—¶å¿½ç•¥å¹¶ä»å¤´å¼€å§‹
   - ä¸å½±å“æ­£å¸¸æµç¨‹

---

## âš™ï¸ é…ç½®è¯´æ˜

æ— éœ€é¢å¤–é…ç½®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
- åœ¨æˆ˜æ–—è¿›è¡Œä¸­ä¿å­˜è¿›åº¦å¿«ç…§
- åœ¨è®¡åˆ’å®Œæˆæ—¶æ¸…ç©ºå¿«ç…§
- åœ¨ä¸‹æ¬¡æˆ˜æ–—æ—¶è‡ªåŠ¨æ¢å¤å¿«ç…§

---

## ğŸ” éªŒè¯æ–¹æ³•

### æ‰‹åŠ¨éªŒè¯æ­¥éª¤
1. åˆ›å»ºä¸€ä¸ªæŒç»­æˆ˜æ–—è®¡åˆ’ï¼ˆDuration, 1å°æ—¶ï¼‰
2. è®©è®¡åˆ’è¿è¡Œ5åˆ†é’Ÿï¼ˆåœ¨çº¿ï¼‰
3. æ¨¡æ‹Ÿç¦»çº¿ï¼šè°ƒç”¨ `OfflineFastForwardEngine.FastForward()`
4. æ£€æŸ¥ `ActivityPlan.BattleProgressJson` æ˜¯å¦åŒ…å«è¿›åº¦å¿«ç…§
5. å†æ¬¡è°ƒç”¨ `FastForward()` éªŒè¯è¿›åº¦ç»§æ‰¿
6. ç­‰å¾…è®¡åˆ’å®Œæˆï¼Œæ£€æŸ¥ `BattleProgressJson` æ˜¯å¦ä¸º `null`

---

## ğŸ“Š å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶
1. `BattleProgressSnapshot.cs` - **æ–°å¢**
2. `ActivityPlan.cs` - æ·»åŠ  `BattleProgressJson` å­—æ®µ
3. `CombatActivityPayload.cs` - æ·»åŠ  `CurrentEnemyHp` å­—æ®µï¼ˆæœªä½¿ç”¨ï¼Œé¢„ç•™ï¼‰
4. `Encounter.cs` - æ–°å¢æ”¯æŒè‡ªå®šä¹‰åˆå§‹è¡€é‡çš„æ„é€ å‡½æ•°
5. `EncounterGroup.cs` - æ–°å¢æ”¯æŒç›´æ¥ä¼ å…¥ Encounter åˆ—è¡¨çš„æ„é€ å‡½æ•°
6. `ContinuousEncounterProvider.cs` - æ”¯æŒåˆå§‹è¡€é‡å‚æ•°
7. `BattleSimulator.cs` - BattleConfig æ·»åŠ  `InitialEnemyHp` å­—æ®µ
8. `OfflineFastForwardEngine.cs` - å®ç°è¿›åº¦ä¿å­˜å’Œæ¢å¤é€»è¾‘
9. `OfflineFastForwardEngineTests.cs` - æ–°å¢å•å…ƒæµ‹è¯•

### æ•°æ®åº“å½±å“
éœ€è¦ä¸º `ActivityPlan` è¡¨æ·»åŠ æ–°åˆ—ï¼š
```sql
ALTER TABLE ActivityPlans 
ADD BattleProgressJson NVARCHAR(MAX) NULL;
```

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡å®æ–½å®Œå…¨æ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼š
- âœ… æ€ªç‰©è¡€é‡ç»§æ‰¿åœ¨çº¿æˆ˜æ–—è¿›åº¦
- âœ… ç¦»çº¿ä»å½“å‰è¿›åº¦ç»§ç»­è®¡ç®—ï¼Œä¸é‡æ–°å¼€å§‹
- âœ… åœ¨çº¿èƒ½å¤Ÿç»§æ‰¿ç¦»çº¿è®¡ç®—çš„ç»“æœ
- âœ… æ”¯æŒå¤šæ¬¡åœ¨çº¿-ç¦»çº¿åˆ‡æ¢çš„è¿›åº¦é“¾
- âœ… æœ€å°åŒ–ä»£ç ä¿®æ”¹ï¼Œä¿æŒç°æœ‰é€»è¾‘å’Œé£æ ¼

å®ç°äº†**æ— æ„Ÿçš„ç¦»çº¿æˆ˜æ–—æ•ˆæœ**ã€‚
