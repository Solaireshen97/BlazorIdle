# BlazorIdle 商店系统设计方案（中篇）
## 实施计划与技术规范

**项目**: BlazorIdle  
**文档版本**: 1.0  
**创建日期**: 2025-10-12  
**状态**: 设计阶段  
**作者**: 系统架构设计团队  

---

## 📋 文档说明

本文档为《商店系统设计方案》的中篇，专注于详细的执行计划和技术实现规范。

### 与上下篇的关系

- **上篇**: 系统分析与架构设计 ← 设计基础
- **中篇**（本文档）: 实施计划与技术规范 ← 如何实施
- **下篇**: 测试验证与扩展设计 ← 质量保证

---

## 1. 整体实施计划概览

### 1.1 Phase 划分

| Phase | 周期 | 核心目标 | 前置依赖 | 验证标准 |
|-------|------|---------|---------|---------|
| **Phase 1** | 1-2周 | 基础模型与数据库 | 无 | 数据库迁移成功，模型定义完成 |
| **Phase 2** | 3-4周 | 货币系统与条件引擎 | Phase 1 | 货币可管理，条件可评估 |
| **Phase 3** | 5-7周 | 核心商店服务 | Phase 2 | 商店可创建，商品可配置 |
| **Phase 4** | 8-10周 | 购买流程实现 | Phase 3 | 购买成功，事务安全 |
| **Phase 5** | 11-12周 | 刷新机制与前端 | Phase 4 | 商店可刷新，前端可用 |
| **Phase 6** | 13-14周 | 测试优化与上线 | Phase 5 | 全系统测试通过 |

### 1.2 里程碑

| 里程碑 | 时间点 | 成果 | 前端可验证内容 |
|--------|--------|------|---------------|
| **M1: 数据基础** | 第2周末 | 数据模型和数据库完成 | 可查询商店定义数据 |
| **M2: 条件系统** | 第4周末 | 条件引擎可用 | 可评估解锁条件 |
| **M3: 商店核心** | 第7周末 | 商店服务完成 | 商店列表可显示 |
| **M4: 购买功能** | 第10周末 | 购买流程完成 | 可完成购买交易 |
| **M5: 完整功能** | 第12周末 | 刷新和前端完成 | 完整商店系统可用 |
| **M6: 上线准备** | 第14周末 | 测试通过，准备上线 | 全功能验证通过 |

---

## 2. Phase 1: 基础模型与数据库（第1-2周）

### 2.1 目标

建立商店系统的数据基础，包括数据库表、枚举定义、领域模型和配置加载机制。

### 2.2 任务清单

#### Task 1.1: 创建枚举类型（4小时）

**文件**: `BlazorIdle.Server/Domain/Shop/Models/ShopEnums.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

public enum ShopType { Regular, Reputation, Limited, SpecialExchange, BlackMarket, Seasonal }
public enum ShopItemType { Consumable, Equipment, Material, Recipe, CurrencyPack, SpecialItem, EquipmentGenerator }
public enum RefreshType { None, Daily, Weekly, Interval, Manual }
public enum CurrencyType { Gold, Gems, Reputation, Honor, Justice, Valor, Conquest, EventToken, Custom = 99 }
```

#### Task 1.2: 创建领域模型（8小时）

创建以下模型文件：
- `ShopDefinition.cs`
- `ShopItemDefinition.cs`
- `ShopInstance.cs`
- `PurchaseRecord.cs`
- `CurrencyBalance.cs`
- `PurchaseCounter.cs`

（详见上篇第9节的领域模型设计）

#### Task 1.3: 数据库表设计（8小时）

**创建迁移文件**: `AddShopSystemTables`

```sql
-- 商店定义表
CREATE TABLE shop_definitions (
    Id TEXT PRIMARY KEY,
    Name TEXT NOT NULL,
    Description TEXT,
    Icon TEXT DEFAULT '🏪',
    Type INTEGER NOT NULL,
    AccessPolicyJson TEXT,
    RefreshPolicyJson TEXT,
    ItemIdsJson TEXT,
    RandomPoolJson TEXT,
    TagsJson TEXT,
    SortOrder INTEGER DEFAULT 0,
    IsEnabled BOOLEAN DEFAULT TRUE,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL
);

-- 商品定义表
CREATE TABLE shop_item_definitions (
    Id TEXT PRIMARY KEY,
    Type INTEGER NOT NULL,
    TargetItemId TEXT NOT NULL,
    DisplayName TEXT,
    Description TEXT,
    Icon TEXT DEFAULT '📦',
    Rarity INTEGER NOT NULL,
    PriceJson TEXT NOT NULL,
    LimitJson TEXT NOT NULL,
    UnlockJson TEXT NOT NULL,
    BarterJson TEXT,
    EquipmentGeneratorJson TEXT,
    IsFeatured BOOLEAN DEFAULT FALSE,
    SortOrder INTEGER DEFAULT 0,
    IsEnabled BOOLEAN DEFAULT TRUE,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL
);

-- 商店实例表
CREATE TABLE shop_instances (
    Id TEXT PRIMARY KEY,
    DefinitionId TEXT NOT NULL,
    CurrentItemIdsJson TEXT,
    InventoryJson TEXT NOT NULL,
    LastAccessTime TEXT,
    AccessCount INTEGER DEFAULT 0,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL,
    FOREIGN KEY (DefinitionId) REFERENCES shop_definitions(Id)
);

-- 货币余额表
CREATE TABLE currency_balances (
    CharacterId TEXT NOT NULL,
    Type INTEGER NOT NULL,
    CustomCurrencyId TEXT,
    Balance INTEGER NOT NULL DEFAULT 0,
    UpdatedAt TEXT NOT NULL,
    PRIMARY KEY (CharacterId, Type, CustomCurrencyId),
    FOREIGN KEY (CharacterId) REFERENCES characters(Id)
);

-- 购买记录表
CREATE TABLE purchase_records (
    Id TEXT PRIMARY KEY,
    CharacterId TEXT NOT NULL,
    ShopId TEXT NOT NULL,
    ItemId TEXT NOT NULL,
    Quantity INTEGER NOT NULL,
    PaidCurrenciesJson TEXT NOT NULL,
    PaidItemsJson TEXT,
    ActualUnitPriceJson TEXT NOT NULL,
    DiscountPercent INTEGER DEFAULT 0,
    PurchaseTime TEXT NOT NULL,
    IdempotencyKey TEXT NOT NULL UNIQUE,
    FOREIGN KEY (CharacterId) REFERENCES characters(Id)
);

-- 购买计数器表
CREATE TABLE purchase_counters (
    CharacterId TEXT NOT NULL,
    ShopItemId TEXT NOT NULL,
    LifetimePurchaseCount INTEGER DEFAULT 0,
    DailyPurchaseCount INTEGER DEFAULT 0,
    DailyResetTime TEXT NOT NULL,
    WeeklyPurchaseCount INTEGER DEFAULT 0,
    WeeklyResetTime TEXT NOT NULL,
    LastPurchaseTime TEXT,
    PRIMARY KEY (CharacterId, ShopItemId),
    FOREIGN KEY (CharacterId) REFERENCES characters(Id)
);

-- 索引
CREATE INDEX IX_ShopInstances_DefinitionId ON shop_instances(DefinitionId);
CREATE INDEX IX_CurrencyBalances_CharacterId ON currency_balances(CharacterId);
CREATE INDEX IX_PurchaseRecords_CharacterId ON purchase_records(CharacterId);
CREATE INDEX IX_PurchaseRecords_PurchaseTime ON purchase_records(PurchaseTime);
CREATE INDEX IX_PurchaseCounters_CharacterId ON purchase_counters(CharacterId);
```

#### Task 1.4: Entity Framework配置（4小时）

**文件**: `BlazorIdle.Server/Infrastructure/Persistence/Configurations/ShopConfiguration.cs`

```csharp
public class ShopDefinitionConfiguration : IEntityTypeConfiguration<ShopDefinition>
{
    public void Configure(EntityTypeBuilder<ShopDefinition> builder)
    {
        builder.ToTable("shop_definitions");
        builder.HasKey(x => x.Id);
        builder.Property(x => x.AccessPolicy).HasColumnName("AccessPolicyJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
                v => JsonSerializer.Deserialize<ShopAccessPolicy>(v, (JsonSerializerOptions?)null)!);
        // ... 其他JSON转换配置
    }
}
```

### 2.3 验收标准

- [ ] 所有枚举定义完成
- [ ] 所有领域模型创建完成
- [ ] 数据库迁移成功执行
- [ ] EF Core配置正确
- [ ] 可通过DbContext查询商店数据

---

## 3. Phase 2: 货币系统与条件引擎（第3-4周）

### 3.1 目标

实现货币管理系统和条件解锁引擎，为商店系统提供基础服务。

### 3.2 任务清单

#### Task 2.1: 货币管理服务（12小时）

**文件**: `BlazorIdle.Server/Application/Shop/CurrencyService.cs`

```csharp
public interface ICurrencyService
{
    Task<CurrencyBalance> GetBalanceAsync(Guid characterId, CurrencyType type, string? customId = null);
    Task<Dictionary<CurrencyType, long>> GetAllBalancesAsync(Guid characterId);
    Task<bool> HasSufficientCurrencyAsync(Guid characterId, Dictionary<CurrencyType, long> required);
    Task<bool> DeductCurrencyAsync(Guid characterId, Dictionary<CurrencyType, long> amounts);
    Task AddCurrencyAsync(Guid characterId, Dictionary<CurrencyType, long> amounts);
    Task<bool> TransferCurrencyAsync(Guid fromCharId, Guid toCharId, CurrencyType type, long amount);
}

public class CurrencyService : ICurrencyService
{
    private readonly GameDbContext _context;
    
    public async Task<bool> DeductCurrencyAsync(Guid characterId, Dictionary<CurrencyType, long> amounts)
    {
        // 在事务中扣除多种货币
        using var transaction = await _context.Database.BeginTransactionAsync();
        try
        {
            foreach (var (type, amount) in amounts)
            {
                if (type == CurrencyType.Gold)
                {
                    var character = await _context.Characters.FindAsync(characterId);
                    if (character == null || character.Gold < amount)
                        return false;
                    character.Gold -= amount;
                }
                else
                {
                    var balance = await GetBalanceAsync(characterId, type);
                    if (balance.Balance < amount)
                        return false;
                    balance.Balance -= amount;
                    balance.UpdatedAt = DateTime.UtcNow;
                }
            }
            await _context.SaveChangesAsync();
            await transaction.CommitAsync();
            return true;
        }
        catch
        {
            await transaction.RollbackAsync();
            throw;
        }
    }
    
    // ... 其他方法实现
}
```

#### Task 2.2: 条件解锁引擎（16小时）

**文件**: `BlazorIdle.Server/Application/Shop/ConditionEvaluator.cs`

```csharp
public interface IConditionEvaluator
{
    Task<bool> EvaluateAsync(string? conditionExpr, Guid characterId);
    Task<Dictionary<string, bool>> EvaluateBatchAsync(List<string> exprs, Guid characterId);
    Task<string> GetFailureReasonAsync(string conditionExpr, Guid characterId);
}

public class ConditionEvaluator : IConditionEvaluator
{
    private readonly GameDbContext _context;
    private readonly IMemoryCache _cache;
    
    public async Task<bool> EvaluateAsync(string? conditionExpr, Guid characterId)
    {
        if (string.IsNullOrWhiteSpace(conditionExpr))
            return true;
        
        // 缓存键
        var cacheKey = $"condition:{characterId}:{conditionExpr}";
        if (_cache.TryGetValue<bool>(cacheKey, out var cached))
            return cached;
        
        var character = await _context.Characters.FindAsync(characterId);
        if (character == null)
            return false;
        
        var result = await EvaluateExpression(conditionExpr, character);
        
        // 缓存结果（5分钟）
        _cache.Set(cacheKey, result, TimeSpan.FromMinutes(5));
        
        return result;
    }
    
    private async Task<bool> EvaluateExpression(string expr, Character character)
    {
        // 解析并评估表达式
        if (expr.StartsWith("level >="))
        {
            var level = int.Parse(expr.Substring(8).Trim());
            return character.Level >= level;
        }
        else if (expr.StartsWith("AND("))
        {
            var subExprs = ParseSubExpressions(expr);
            foreach (var sub in subExprs)
            {
                if (!await EvaluateExpression(sub, character))
                    return false;
            }
            return true;
        }
        else if (expr.StartsWith("OR("))
        {
            var subExprs = ParseSubExpressions(expr);
            foreach (var sub in subExprs)
            {
                if (await EvaluateExpression(sub, character))
                    return true;
            }
            return false;
        }
        // ... 其他条件类型
        
        return false;
    }
    
    // ... 辅助方法
}
```

#### Task 2.3: 声望系统（8小时）

**文件**: `BlazorIdle.Server/Domain/Reputation/ReputationRecord.cs`

```csharp
public class ReputationRecord
{
    public Guid CharacterId { get; set; }
    public string FactionId { get; set; } = "";
    public int ReputationPoints { get; set; } = 0;
    public ReputationLevel Level { get; set; }
    public DateTime UpdatedAt { get; set; }
}

public enum ReputationLevel
{
    Hated = 0,
    Hostile = 1,
    Unfriendly = 2,
    Neutral = 3,
    Friendly = 4,
    Honored = 5,
    Revered = 6,
    Exalted = 7
}
```

### 2.4 验收标准

- [ ] 货币服务完成，可增减货币
- [ ] 条件评估器完成，可评估基本条件
- [ ] 声望系统完成，可追踪声望
- [ ] 单元测试通过

---

## 4. Phase 3: 核心商店服务（第5-7周）

### 4.1 目标

实现商店的创建、配置、查询等核心功能。

### 4.2 任务清单

#### Task 3.1: 商店服务（16小时）

**文件**: `BlazorIdle.Server/Application/Shop/ShopService.cs`

```csharp
public interface IShopService
{
    Task<ShopInstance?> GetShopAsync(string shopId, Guid characterId);
    Task<List<ShopDefinition>> GetAvailableShopsAsync(Guid characterId);
    Task<ShopItemDefinition?> GetItemAsync(string itemId);
    Task<List<ShopItemDefinition>> GetShopItemsAsync(string shopId, Guid characterId);
    Task<bool> IsShopUnlockedAsync(string shopId, Guid characterId);
    Task<bool> IsItemUnlockedAsync(string itemId, Guid characterId);
}

public class ShopService : IShopService
{
    private readonly GameDbContext _context;
    private readonly IConditionEvaluator _conditionEvaluator;
    private readonly IMemoryCache _cache;
    
    public async Task<ShopInstance?> GetShopAsync(string shopId, Guid characterId)
    {
        // 检查商店是否解锁
        if (!await IsShopUnlockedAsync(shopId, characterId))
            return null;
        
        // 获取或创建商店实例
        var instance = await _context.ShopInstances
            .Include(x => x.Definition)
            .FirstOrDefaultAsync(x => x.DefinitionId == shopId);
        
        if (instance == null)
        {
            var definition = await _context.ShopDefinitions.FindAsync(shopId);
            if (definition == null)
                return null;
            
            instance = new ShopInstance
            {
                DefinitionId = shopId,
                CurrentItemIds = definition.ItemIds,
                Inventory = new ShopInventory
                {
                    ShopId = Guid.NewGuid(),
                    LastRefreshTime = DateTime.UtcNow
                }
            };
            _context.ShopInstances.Add(instance);
            await _context.SaveChangesAsync();
        }
        
        return instance;
    }
    
    public async Task<List<ShopItemDefinition>> GetShopItemsAsync(string shopId, Guid characterId)
    {
        var shop = await GetShopAsync(shopId, characterId);
        if (shop == null)
            return new List<ShopItemDefinition>();
        
        var items = await _context.ShopItemDefinitions
            .Where(x => shop.CurrentItemIds.Contains(x.Id))
            .ToListAsync();
        
        // 过滤出已解锁的商品（或ShowWhenLocked=true的商品）
        var unlockedItems = new List<ShopItemDefinition>();
        foreach (var item in items)
        {
            var isUnlocked = await IsItemUnlockedAsync(item.Id, characterId);
            if (isUnlocked || item.Unlock.ShowWhenLocked)
            {
                unlockedItems.Add(item);
            }
        }
        
        return unlockedItems.OrderBy(x => x.SortOrder).ToList();
    }
    
    public async Task<bool> IsItemUnlockedAsync(string itemId, Guid characterId)
    {
        var item = await _context.ShopItemDefinitions.FindAsync(itemId);
        if (item == null)
            return false;
        
        // 检查等级要求
        var character = await _context.Characters.FindAsync(characterId);
        if (character == null || character.Level < item.Unlock.MinLevel)
            return false;
        
        // 检查条件表达式
        if (!string.IsNullOrWhiteSpace(item.Unlock.UnlockCondition))
        {
            return await _conditionEvaluator.EvaluateAsync(item.Unlock.UnlockCondition, characterId);
        }
        
        return true;
    }
    
    // ... 其他方法
}
```

#### Task 3.2: 配置加载器（8小时）

**文件**: `BlazorIdle.Server/Infrastructure/Shop/ShopConfigLoader.cs`

```csharp
public class ShopConfigLoader
{
    public async Task LoadFromJsonAsync(string filePath, GameDbContext context)
    {
        var json = await File.ReadAllTextAsync(filePath);
        var config = JsonSerializer.Deserialize<ShopSystemConfig>(json);
        
        // 加载商店定义
        foreach (var shopDef in config.Shops)
        {
            var existing = await context.ShopDefinitions.FindAsync(shopDef.Id);
            if (existing == null)
            {
                context.ShopDefinitions.Add(shopDef);
            }
            else
            {
                // 更新现有定义
                context.Entry(existing).CurrentValues.SetValues(shopDef);
            }
        }
        
        // 加载商品定义
        foreach (var itemDef in config.Items)
        {
            var existing = await context.ShopItemDefinitions.FindAsync(itemDef.Id);
            if (existing == null)
            {
                context.ShopItemDefinitions.Add(itemDef);
            }
        }
        
        await context.SaveChangesAsync();
    }
}
```

#### Task 3.3: 种子数据（4小时）

**文件**: `BlazorIdle.Server/Infrastructure/Persistence/ShopSeedData.cs`

```csharp
public static class ShopSeedData
{
    public static void SeedShopData(this ModelBuilder modelBuilder)
    {
        // 示例：杂货商人
        modelBuilder.Entity<ShopDefinition>().HasData(new ShopDefinition
        {
            Id = "shop_general_merchant",
            Name = "杂货商人",
            Description = "出售基础消耗品和材料",
            Icon = "🏪",
            Type = ShopType.Regular,
            AccessPolicy = new ShopAccessPolicy(),
            RefreshPolicy = new ShopRefreshPolicy { Type = RefreshType.None },
            ItemIds = new List<string> { "item_health_potion_small", "item_mana_potion_small" },
            IsEnabled = true
        });
        
        // 示例商品：小型生命药水
        modelBuilder.Entity<ShopItemDefinition>().HasData(new ShopItemDefinition
        {
            Id = "item_health_potion_small",
            Type = ShopItemType.Consumable,
            TargetItemId = "consumable_health_potion_small",
            DisplayName = "小型生命药水",
            Icon = "🧪",
            Rarity = Rarity.Common,
            Price = new ShopItemPrice
            {
                BasePrices = new Dictionary<CurrencyType, long> { { CurrencyType.Gold, 10 } }
            },
            Limit = new ShopItemLimit { MaxPurchasePerTransaction = 20 },
            Unlock = new ShopItemUnlock { MinLevel = 1 },
            IsEnabled = true
        });
    }
}
```

### 4.3 验收标准

- [ ] 商店服务完成，可查询商店
- [ ] 可获取商店商品列表
- [ ] 解锁条件正确生效
- [ ] 配置加载器可用
- [ ] 种子数据加载成功

---

## 5. Phase 4: 购买流程实现（第8-10周）

### 5.1 目标

实现完整的购买流程，包括价格计算、货币扣除、物品发放、事务管理。

### 5.2 任务清单

#### Task 4.1: 购买服务（20小时）

**文件**: `BlazorIdle.Server/Application/Shop/PurchaseService.cs`

```csharp
public interface IPurchaseService
{
    Task<PurchaseResult> PurchaseItemAsync(PurchaseRequest request);
    Task<PriceInfo> GetPriceInfoAsync(string itemId, Guid characterId, int quantity);
    Task<bool> CanPurchaseAsync(string itemId, Guid characterId, int quantity);
}

public class PurchaseService : IPurchaseService
{
    private readonly GameDbContext _context;
    private readonly ICurrencyService _currencyService;
    private readonly IConditionEvaluator _conditionEvaluator;
    private readonly IPriceCalculator _priceCalculator;
    
    public async Task<PurchaseResult> PurchaseItemAsync(PurchaseRequest request)
    {
        using var transaction = await _context.Database.BeginTransactionAsync();
        try
        {
            // 1. 验证商品和商店
            var item = await _context.ShopItemDefinitions.FindAsync(request.ItemId);
            if (item == null || !item.IsEnabled)
                return PurchaseResult.Failure("商品不存在或已下架");
            
            // 2. 检查解锁条件
            var isUnlocked = await _conditionEvaluator.EvaluateAsync(
                item.Unlock.UnlockCondition, request.CharacterId);
            if (!isUnlocked)
                return PurchaseResult.Failure("商品未解锁");
            
            // 3. 检查购买限制
            var counter = await GetOrCreatePurchaseCounterAsync(request.CharacterId, request.ItemId);
            if (!CheckPurchaseLimit(item.Limit, counter, request.Quantity))
                return PurchaseResult.Failure("超过购买限制");
            
            // 4. 计算价格
            var priceInfo = await _priceCalculator.CalculatePriceAsync(
                item, request.CharacterId, request.Quantity, counter.LifetimePurchaseCount);
            
            // 5. 验证货币充足
            if (!await _currencyService.HasSufficientCurrencyAsync(
                request.CharacterId, priceInfo.TotalCurrencies))
                return PurchaseResult.Failure("货币不足");
            
            // 6. 扣除货币
            if (!await _currencyService.DeductCurrencyAsync(
                request.CharacterId, priceInfo.TotalCurrencies))
                return PurchaseResult.Failure("货币扣除失败");
            
            // 7. 发放物品
            await GrantItemAsync(request.CharacterId, item.TargetItemId, request.Quantity);
            
            // 8. 更新购买计数
            await UpdatePurchaseCounterAsync(counter, request.Quantity);
            
            // 9. 记录购买历史
            var record = new PurchaseRecord
            {
                CharacterId = request.CharacterId,
                ShopId = request.ShopId,
                ItemId = request.ItemId,
                Quantity = request.Quantity,
                PaidCurrencies = priceInfo.TotalCurrencies,
                ActualUnitPrice = priceInfo.UnitPrices,
                DiscountPercent = priceInfo.DiscountPercent,
                IdempotencyKey = $"{request.CharacterId}:{request.ItemId}:{DateTime.UtcNow.Ticks}"
            };
            _context.PurchaseRecords.Add(record);
            
            await _context.SaveChangesAsync();
            await transaction.CommitAsync();
            
            return PurchaseResult.Success(record);
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            return PurchaseResult.Failure($"购买失败: {ex.Message}");
        }
    }
    
    private async Task GrantItemAsync(Guid characterId, string itemId, int quantity)
    {
        var existing = await _context.InventoryItems
            .FirstOrDefaultAsync(x => x.CharacterId == characterId && x.ItemId == itemId);
        
        if (existing != null)
        {
            existing.Quantity += quantity;
            existing.UpdatedAt = DateTime.UtcNow;
        }
        else
        {
            _context.InventoryItems.Add(new InventoryItem
            {
                CharacterId = characterId,
                ItemId = itemId,
                Quantity = quantity
            });
        }
    }
    
    // ... 其他辅助方法
}
```

#### Task 4.2: 价格计算器（12小时）

**文件**: `BlazorIdle.Server/Application/Shop/PriceCalculator.cs`

```csharp
public interface IPriceCalculator
{
    Task<PriceInfo> CalculatePriceAsync(ShopItemDefinition item, Guid characterId, 
        int quantity, int previousPurchaseCount);
}

public class PriceCalculator : IPriceCalculator
{
    private readonly IConditionEvaluator _conditionEvaluator;
    
    public async Task<PriceInfo> CalculatePriceAsync(ShopItemDefinition item, 
        Guid characterId, int quantity, int previousPurchaseCount)
    {
        var unitPrices = new Dictionary<CurrencyType, long>();
        
        // 1. 基础价格
        foreach (var (currencyType, basePrice) in item.Price.BasePrices)
        {
            var price = basePrice;
            
            // 2. 价格递增（根据购买次数）
            if (item.Price.PriceIncreasePercent > 0)
            {
                var multiplier = 1.0m + (item.Price.PriceIncreasePercent / 100.0m * previousPurchaseCount);
                multiplier = Math.Min(multiplier, item.Price.MaxPriceMultiplier);
                price = (long)(price * multiplier);
            }
            
            unitPrices[currencyType] = price;
        }
        
        // 3. 检查折扣
        int discountPercent = 0;
        if (item.Price.DiscountPercent > 0)
        {
            if (string.IsNullOrWhiteSpace(item.Price.DiscountCondition) ||
                await _conditionEvaluator.EvaluateAsync(item.Price.DiscountCondition, characterId))
            {
                discountPercent = item.Price.DiscountPercent;
            }
        }
        
        // 4. 应用折扣
        if (discountPercent > 0)
        {
            var discountMult = (100 - discountPercent) / 100.0m;
            foreach (var key in unitPrices.Keys.ToList())
            {
                unitPrices[key] = (long)(unitPrices[key] * discountMult);
            }
        }
        
        // 5. 计算总价
        var totalPrices = new Dictionary<CurrencyType, long>();
        foreach (var (currencyType, unitPrice) in unitPrices)
        {
            totalPrices[currencyType] = unitPrice * quantity;
        }
        
        return new PriceInfo
        {
            UnitPrices = unitPrices,
            TotalCurrencies = totalPrices,
            DiscountPercent = discountPercent
        };
    }
}
```

### 5.3 验收标准

- [ ] 购买流程完整实现
- [ ] 价格计算正确（含折扣和递增）
- [ ] 事务安全保证
- [ ] 购买限制正确生效
- [ ] 购买记录正确保存
- [ ] 单元测试和集成测试通过

---

## 6. Phase 5: 刷新机制与前端（第11-12周）

### 6.1 目标

实现商店刷新机制和前端UI集成。

### 6.2 任务清单

#### Task 5.1: 刷新服务（12小时）

**文件**: `BlazorIdle.Server/Application/Shop/RefreshService.cs`

```csharp
public interface IRefreshService
{
    Task RefreshShopAsync(string shopId);
    Task RefreshAllShopsAsync();
    Task<bool> CanManualRefreshAsync(string shopId, Guid characterId);
    Task<ManualRefreshResult> ManualRefreshAsync(string shopId, Guid characterId);
}

public class RefreshService : IRefreshService
{
    private readonly GameDbContext _context;
    private readonly ICurrencyService _currencyService;
    
    public async Task RefreshShopAsync(string shopId)
    {
        var instance = await _context.ShopInstances
            .Include(x => x.Definition)
            .FirstOrDefaultAsync(x => x.DefinitionId == shopId);
        
        if (instance == null || instance.Definition == null)
            return;
        
        var policy = instance.Definition.RefreshPolicy;
        if (policy.Type == RefreshType.None)
            return;
        
        // 从随机池抽取商品
        if (instance.Definition.RandomPool != null)
        {
            instance.CurrentItemIds = await DrawRandomItemsAsync(instance.Definition.RandomPool);
        }
        
        // 重置库存
        instance.Inventory.Stock.Clear();
        instance.Inventory.LastRefreshTime = DateTime.UtcNow;
        instance.Inventory.RefreshVersion++;
        
        // 计算下次刷新时间
        if (policy.Type == RefreshType.Daily)
        {
            instance.Inventory.NextRefreshTime = DateTime.UtcNow.Date.AddDays(1);
        }
        else if (policy.Type == RefreshType.Weekly)
        {
            var daysUntilMonday = ((int)DayOfWeek.Monday - (int)DateTime.UtcNow.DayOfWeek + 7) % 7;
            instance.Inventory.NextRefreshTime = DateTime.UtcNow.Date.AddDays(daysUntilMonday);
        }
        
        await _context.SaveChangesAsync();
    }
    
    private async Task<List<string>> DrawRandomItemsAsync(RandomItemPool pool)
    {
        var random = new Random();
        var totalWeight = pool.Items.Values.Sum();
        var selectedItems = new List<string>();
        
        for (int i = 0; i < pool.ItemCountPerRefresh; i++)
        {
            var roll = random.Next(totalWeight);
            var cumulative = 0;
            
            foreach (var (itemId, weight) in pool.Items)
            {
                cumulative += weight;
                if (roll < cumulative)
                {
                    if (pool.AllowDuplicates || !selectedItems.Contains(itemId))
                    {
                        selectedItems.Add(itemId);
                        break;
                    }
                }
            }
        }
        
        return selectedItems;
    }
    
    // ... 其他方法
}
```

#### Task 5.2: 定时刷新后台服务（8小时）

**文件**: `BlazorIdle.Server/Infrastructure/BackgroundServices/ShopRefreshHostedService.cs`

```csharp
public class ShopRefreshHostedService : BackgroundService
{
    private readonly IServiceProvider _serviceProvider;
    private readonly ILogger<ShopRefreshHostedService> _logger;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                using var scope = _serviceProvider.CreateScope();
                var refreshService = scope.ServiceProvider.GetRequiredService<IRefreshService>();
                
                await refreshService.RefreshAllShopsAsync();
                
                // 每5分钟检查一次
                await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error refreshing shops");
                await Task.Delay(TimeSpan.FromMinutes(1), stoppingToken);
            }
        }
    }
}
```

#### Task 5.3: 前端UI（详见下篇）

### 6.3 验收标准

- [ ] 刷新服务完成
- [ ] 定时刷新正常工作
- [ ] 手动刷新功能可用
- [ ] 随机商品池正确抽取
- [ ] 前端UI可用

---

## 7. Phase 6: 测试优化与上线（第13-14周）

详见下篇文档。

---

## 8. 数据库设计补充说明

### 8.1 JSON字段说明

为了灵活性，某些复杂对象使用JSON存储：

- `AccessPolicyJson`: ShopAccessPolicy对象
- `RefreshPolicyJson`: ShopRefreshPolicy对象
- `PriceJson`: ShopItemPrice对象
- `LimitJson`: ShopItemLimit对象
- `UnlockJson`: ShopItemUnlock对象

### 8.2 索引策略

重要查询路径：
1. 按角色ID查询货币余额
2. 按角色ID查询购买记录
3. 按商店ID查询商店实例
4. 按时间范围查询购买记录（用于统计）

---

## 9. 集成现有系统

### 9.1 与经济系统集成

- 复用 `InventoryItem` 表存储购买的物品
- 复用 `EconomyEventRecord` 记录购买事件（可选）
- 使用 `Character.Gold` 作为主要货币

### 9.2 与装备系统集成

- 购买装备类型商品时，生成 `GearInstance`
- 使用 `EquipmentGenerator` 配置随机生成装备
- 集成装备的稀有度和品级系统

### 9.3 与条件系统集成

- 等待条件解锁DSL实现后集成
- 暂时使用简化版条件评估
- 预留接口以便后续升级

---

## 总结

本文档（中篇）完成了商店系统的实施计划与技术规范，包括：

1. ✅ 完整的Phase执行计划（Phase 1-6）
2. ✅ 详细的任务清单和工时估算
3. ✅ 核心服务的代码框架
4. ✅ 数据库设计和迁移脚本
5. ✅ 与现有系统的集成方案

### 下一步

请参阅：
- **上篇**: 系统分析与架构设计（设计基础）
- **下篇**: 测试验证与扩展设计（质量保证、前端UI、性能优化）

---

**文档状态**: 已完成  
**审核状态**: 待审核  
**版本**: 1.0
