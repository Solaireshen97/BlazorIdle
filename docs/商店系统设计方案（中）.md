# å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰- è¯¦ç»†è®¾è®¡ä¸å®ç°è§„èŒƒ

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**è´Ÿè´£**: å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®æ¨¡å‹è¯¦ç»†è®¾è®¡](#æ•°æ®æ¨¡å‹è¯¦ç»†è®¾è®¡)
2. [API æ¥å£è®¾è®¡](#api-æ¥å£è®¾è®¡)
3. [æœåŠ¡å±‚è®¾è®¡](#æœåŠ¡å±‚è®¾è®¡)
4. [ä¸šåŠ¡é€»è¾‘å®ç°](#ä¸šåŠ¡é€»è¾‘å®ç°)
5. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
6. [é…ç½®ä¸ç§å­æ•°æ®](#é…ç½®ä¸ç§å­æ•°æ®)

---

## æ•°æ®æ¨¡å‹è¯¦ç»†è®¾è®¡

### 1.1 é¢†åŸŸæ¨¡å‹å®šä¹‰

#### 1.1.1 ShopDefinitionï¼ˆå•†åº—å®šä¹‰ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Server/Domain/Shop/ShopDefinition.cs`

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Server.Domain.Shop;

/// <summary>
/// å•†åº—å®šä¹‰å®ä½“
/// </summary>
public class ShopDefinition
{
    /// <summary>
    /// å•†åº—å”¯ä¸€æ ‡è¯†
    /// </summary>
    [Key]
    [MaxLength(100)]
    public string Id { get; set; } = "";

    /// <summary>
    /// å•†åº—åç§°
    /// </summary>
    [Required]
    [MaxLength(200)]
    public string Name { get; set; } = "";

    /// <summary>
    /// å•†åº—ç±»å‹
    /// </summary>
    [Required]
    public ShopType Type { get; set; } = ShopType.General;

    /// <summary>
    /// å•†åº—å›¾æ ‡
    /// </summary>
    [MaxLength(50)]
    public string Icon { get; set; } = "ğŸª";

    /// <summary>
    /// å•†åº—æè¿°
    /// </summary>
    [MaxLength(1000)]
    public string Description { get; set; } = "";

    /// <summary>
    /// è§£é”æ¡ä»¶è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼Œæœªæ¥æ”¯æŒ DSLï¼‰
    /// ç¤ºä¾‹: "level>=10" æˆ– "AND(level>=20, gold>=1000)"
    /// </summary>
    [MaxLength(500)]
    public string? UnlockCondition { get; set; }

    /// <summary>
    /// æ˜¯å¦å¯ç”¨
    /// </summary>
    public bool IsEnabled { get; set; } = true;

    /// <summary>
    /// æ’åºé¡ºåº
    /// </summary>
    public int SortOrder { get; set; } = 0;

    /// <summary>
    /// åˆ›å»ºæ—¶é—´
    /// </summary>
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation properties
    public ICollection<ShopItem> Items { get; set; } = new List<ShopItem>();
}

/// <summary>
/// å•†åº—ç±»å‹æšä¸¾
/// </summary>
public enum ShopType
{
    /// <summary>
    /// é€šç”¨å•†åº—ï¼ˆæ‰€æœ‰ç©å®¶å¯è§ï¼‰
    /// </summary>
    General = 0,

    /// <summary>
    /// ç‰¹æ®Šå•†åº—ï¼ˆéœ€è¦è§£é”ï¼‰
    /// </summary>
    Special = 1,

    /// <summary>
    /// é™æ—¶å•†åº—ï¼ˆé™å®šæ—¶é—´å¼€æ”¾ï¼‰
    /// </summary>
    Limited = 2,

    /// <summary>
    /// ä¸ªäººå•†åº—ï¼ˆè§’è‰²ä¸“å±ï¼‰
    /// </summary>
    Personal = 3
}
```

#### 1.1.2 ShopItemï¼ˆå•†å“å®šä¹‰ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Server/Domain/Shop/ShopItem.cs`

```csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.Text.Json;

namespace BlazorIdle.Server.Domain.Shop;

/// <summary>
/// å•†å“å®šä¹‰å®ä½“
/// </summary>
public class ShopItem
{
    /// <summary>
    /// å•†å“å”¯ä¸€æ ‡è¯†
    /// </summary>
    [Key]
    public Guid Id { get; set; } = Guid.NewGuid();

    /// <summary>
    /// æ‰€å±å•†åº— ID
    /// </summary>
    [Required]
    [MaxLength(100)]
    public string ShopId { get; set; } = "";

    /// <summary>
    /// å•†å“ç±»å‹
    /// </summary>
    [Required]
    public ShopItemType ItemType { get; set; }

    /// <summary>
    /// ç‰©å“å®šä¹‰ IDï¼ˆå…³è”åˆ°æ¸¸æˆå†…ç‰©å“/è£…å¤‡å®šä¹‰ï¼‰
    /// ç¤ºä¾‹: "potion_health_small", "weapon_iron_sword"
    /// </summary>
    [Required]
    [MaxLength(100)]
    public string ItemDefinitionId { get; set; } = "";

    /// <summary>
    /// æ˜¾ç¤ºåç§°ï¼ˆå¯è¦†ç›–ç‰©å“å®šä¹‰çš„åç§°ï¼‰
    /// </summary>
    [MaxLength(200)]
    public string? DisplayName { get; set; }

    /// <summary>
    /// å›¾æ ‡ï¼ˆå¯è¦†ç›–ç‰©å“å®šä¹‰çš„å›¾æ ‡ï¼‰
    /// </summary>
    [MaxLength(50)]
    public string? Icon { get; set; }

    /// <summary>
    /// æè¿°ï¼ˆå¯è¦†ç›–ç‰©å“å®šä¹‰çš„æè¿°ï¼‰
    /// </summary>
    [MaxLength(1000)]
    public string? Description { get; set; }

    /// <summary>
    /// ä»·æ ¼ä¿¡æ¯ï¼ˆJSON æ ¼å¼ï¼‰
    /// </summary>
    [Required]
    public string PriceJson { get; set; } = "";

    /// <summary>
    /// åº“å­˜é™åˆ¶ï¼ˆ-1 è¡¨ç¤ºæ— é™ï¼‰
    /// </summary>
    public int StockLimit { get; set; } = -1;

    /// <summary>
    /// å½“å‰åº“å­˜ï¼ˆä»…å½“ StockLimit > 0 æ—¶æœ‰æ•ˆï¼‰
    /// </summary>
    public int CurrentStock { get; set; } = 0;

    /// <summary>
    /// è´­ä¹°é™åˆ¶ä¿¡æ¯ï¼ˆJSON æ ¼å¼ï¼‰
    /// </summary>
    public string? PurchaseLimitJson { get; set; }

    /// <summary>
    /// ç­‰çº§è¦æ±‚
    /// </summary>
    public int RequiredLevel { get; set; } = 1;

    /// <summary>
    /// è§£é”æ¡ä»¶è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼‰
    /// </summary>
    [MaxLength(500)]
    public string? UnlockCondition { get; set; }

    /// <summary>
    /// æ˜¯å¦å¯ç”¨
    /// </summary>
    public bool IsEnabled { get; set; } = true;

    /// <summary>
    /// æ’åºé¡ºåº
    /// </summary>
    public int SortOrder { get; set; } = 0;

    /// <summary>
    /// åˆ›å»ºæ—¶é—´
    /// </summary>
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation property
    public ShopDefinition Shop { get; set; } = null!;

    // Helper methods
    public Price GetPrice()
    {
        return JsonSerializer.Deserialize<Price>(PriceJson)
            ?? throw new InvalidOperationException($"Invalid price JSON for item {Id}");
    }

    public void SetPrice(Price price)
    {
        PriceJson = JsonSerializer.Serialize(price);
    }

    public PurchaseLimit? GetPurchaseLimit()
    {
        if (string.IsNullOrEmpty(PurchaseLimitJson))
            return null;
        return JsonSerializer.Deserialize<PurchaseLimit>(PurchaseLimitJson);
    }

    public void SetPurchaseLimit(PurchaseLimit? limit)
    {
        PurchaseLimitJson = limit == null ? null : JsonSerializer.Serialize(limit);
    }
}

/// <summary>
/// å•†å“ç±»å‹æšä¸¾
/// </summary>
public enum ShopItemType
{
    /// <summary>
    /// æ¶ˆè€—å“ï¼ˆé£Ÿç‰©ã€è¯å‰‚ç­‰ï¼‰
    /// </summary>
    Consumable = 0,

    /// <summary>
    /// è£…å¤‡ï¼ˆæ­¦å™¨ã€é˜²å…·ç­‰ï¼‰
    /// </summary>
    Equipment = 1,

    /// <summary>
    /// ææ–™ï¼ˆåˆ¶ä½œææ–™ç­‰ï¼‰
    /// </summary>
    Material = 2,

    /// <summary>
    /// è´§å¸ï¼ˆç‰¹æ®Šè´§å¸ï¼‰
    /// </summary>
    Currency = 3,

    /// <summary>
    /// ç‰¹æ®Šç‰©å“ï¼ˆä»»åŠ¡é“å…·ã€å® ç‰©ç­‰ï¼‰
    /// </summary>
    Special = 4
}
```

#### 1.1.3 Priceï¼ˆä»·æ ¼å€¼å¯¹è±¡ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Server/Domain/Shop/ValueObjects/Price.cs`

```csharp
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Server.Domain.Shop.ValueObjects;

/// <summary>
/// ä»·æ ¼å€¼å¯¹è±¡
/// </summary>
public class Price
{
    /// <summary>
    /// è´§å¸ç±»å‹
    /// </summary>
    [Required]
    public CurrencyType CurrencyType { get; set; } = CurrencyType.Gold;

    /// <summary>
    /// é‡‘é¢/æ•°é‡
    /// </summary>
    [Range(0, int.MaxValue)]
    public int Amount { get; set; }

    /// <summary>
    /// è´§å¸/ç‰©å“ IDï¼ˆç”¨äºç‰¹æ®Šè´§å¸å’Œç‰©å“å…‘æ¢ï¼‰
    /// </summary>
    [MaxLength(100)]
    public string? CurrencyId { get; set; }
}

/// <summary>
/// è´§å¸ç±»å‹æšä¸¾
/// </summary>
public enum CurrencyType
{
    /// <summary>
    /// é‡‘å¸ï¼ˆä¸»è´§å¸ï¼‰
    /// </summary>
    Gold = 0,

    /// <summary>
    /// ç‰¹æ®Šè´§å¸ï¼ˆè£èª‰ç‚¹ã€ç«æŠ€åœºå¸ç­‰ï¼‰
    /// </summary>
    SpecialCurrency = 1,

    /// <summary>
    /// ç‰©å“ï¼ˆä»¥ç‰©æ˜“ç‰©ï¼‰
    /// </summary>
    Item = 2
}
```

#### 1.1.4 PurchaseLimitï¼ˆè´­ä¹°é™åˆ¶å€¼å¯¹è±¡ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Server/Domain/Shop/ValueObjects/PurchaseLimit.cs`

```csharp
using System;

namespace BlazorIdle.Server.Domain.Shop.ValueObjects;

/// <summary>
/// è´­ä¹°é™åˆ¶å€¼å¯¹è±¡
/// </summary>
public class PurchaseLimit
{
    /// <summary>
    /// é™åˆ¶ç±»å‹
    /// </summary>
    public PurchaseLimitType LimitType { get; set; } = PurchaseLimitType.None;

    /// <summary>
    /// æœ€å¤§è´­ä¹°æ¬¡æ•°
    /// </summary>
    public int MaxPurchases { get; set; }

    /// <summary>
    /// é‡ç½®æ—¶é—´é…ç½®ï¼ˆUTC å°æ—¶ï¼Œä»…ç”¨äº Daily/Weeklyï¼‰
    /// ç¤ºä¾‹: 0 è¡¨ç¤ºæ¯å¤© UTC 00:00 é‡ç½®
    /// </summary>
    public int ResetHour { get; set; } = 0;
}

/// <summary>
/// è´­ä¹°é™åˆ¶ç±»å‹æšä¸¾
/// </summary>
public enum PurchaseLimitType
{
    /// <summary>
    /// æ— é™åˆ¶
    /// </summary>
    None = 0,

    /// <summary>
    /// æ¯æ—¥é™åˆ¶
    /// </summary>
    Daily = 1,

    /// <summary>
    /// æ¯å‘¨é™åˆ¶ï¼ˆå‘¨ä¸€é‡ç½®ï¼‰
    /// </summary>
    Weekly = 2,

    /// <summary>
    /// æ€»è®¡é™åˆ¶ï¼ˆæ°¸ä¹…ï¼‰
    /// </summary>
    Total = 3
}
```

#### 1.1.5 PurchaseRecordï¼ˆè´­ä¹°è®°å½•ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Server/Domain/Shop/PurchaseRecord.cs`

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Server.Domain.Shop;

/// <summary>
/// è´­ä¹°è®°å½•å®ä½“
/// </summary>
public class PurchaseRecord
{
    /// <summary>
    /// è®°å½•å”¯ä¸€æ ‡è¯†
    /// </summary>
    [Key]
    public Guid Id { get; set; } = Guid.NewGuid();

    /// <summary>
    /// è§’è‰² ID
    /// </summary>
    [Required]
    public Guid CharacterId { get; set; }

    /// <summary>
    /// å•†åº— ID
    /// </summary>
    [Required]
    [MaxLength(100)]
    public string ShopId { get; set; } = "";

    /// <summary>
    /// å•†å“ ID
    /// </summary>
    [Required]
    public Guid ShopItemId { get; set; }

    /// <summary>
    /// ç‰©å“å®šä¹‰ IDï¼ˆå†—ä½™ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
    /// </summary>
    [Required]
    [MaxLength(100)]
    public string ItemDefinitionId { get; set; } = "";

    /// <summary>
    /// è´­ä¹°æ•°é‡
    /// </summary>
    [Range(1, 999)]
    public int Quantity { get; set; } = 1;

    /// <summary>
    /// å®é™…æ”¯ä»˜ä»·æ ¼ï¼ˆJSON æ ¼å¼ï¼‰
    /// </summary>
    [Required]
    public string PriceJson { get; set; } = "";

    /// <summary>
    /// è´­ä¹°æ—¶é—´
    /// </summary>
    public DateTime PurchasedAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// å…³è”çš„ç»æµäº‹ä»¶è®°å½• IDï¼ˆå¦‚æœæ¶‰åŠè´§å¸æ‰£å‡ï¼‰
    /// </summary>
    public Guid? EconomyEventId { get; set; }
}
```

#### 1.1.6 PurchaseCounterï¼ˆè´­ä¹°è®¡æ•°å™¨ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Server/Domain/Shop/PurchaseCounter.cs`

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Server.Domain.Shop;

/// <summary>
/// è´­ä¹°è®¡æ•°å™¨å®ä½“ï¼ˆç”¨äºé™åˆ¶æ£€æŸ¥ï¼‰
/// </summary>
public class PurchaseCounter
{
    /// <summary>
    /// å¤åˆä¸»é”®ï¼šCharacterId + ShopItemId + PeriodKey
    /// </summary>
    [Key]
    public Guid Id { get; set; } = Guid.NewGuid();

    /// <summary>
    /// è§’è‰² ID
    /// </summary>
    [Required]
    public Guid CharacterId { get; set; }

    /// <summary>
    /// å•†å“ ID
    /// </summary>
    [Required]
    public Guid ShopItemId { get; set; }

    /// <summary>
    /// å‘¨æœŸé”®ï¼ˆæ ¼å¼ç¤ºä¾‹ï¼šdaily_20251012, weekly_202541, totalï¼‰
    /// </summary>
    [Required]
    [MaxLength(50)]
    public string PeriodKey { get; set; } = "";

    /// <summary>
    /// å½“å‰å‘¨æœŸå·²è´­ä¹°æ•°é‡
    /// </summary>
    public int PurchaseCount { get; set; } = 0;

    /// <summary>
    /// ä¸Šæ¬¡è´­ä¹°æ—¶é—´
    /// </summary>
    public DateTime LastPurchaseAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// å‘¨æœŸè¿‡æœŸæ—¶é—´ï¼ˆç”¨äºæ¸…ç†ï¼‰
    /// </summary>
    public DateTime? ExpiresAt { get; set; }
}
```

### 1.2 DTO æ¨¡å‹å®šä¹‰

#### 1.2.1 ShopDtoï¼ˆå•†åº—åˆ—è¡¨å“åº”ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Shared/Dtos/Shop/ShopDto.cs`

```csharp
namespace BlazorIdle.Shared.Dtos.Shop;

/// <summary>
/// å•†åº— DTO
/// </summary>
public class ShopDto
{
    public string Id { get; set; } = "";
    public string Name { get; set; } = "";
    public string Type { get; set; } = "";
    public string Icon { get; set; } = "";
    public string Description { get; set; } = "";
    public bool IsUnlocked { get; set; }
    public string? UnlockHint { get; set; }
    public int ItemCount { get; set; }
}
```

#### 1.2.2 ShopItemDtoï¼ˆå•†å“è¯¦æƒ…å“åº”ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Shared/Dtos/Shop/ShopItemDto.cs`

```csharp
namespace BlazorIdle.Shared.Dtos.Shop;

/// <summary>
/// å•†å“ DTO
/// </summary>
public class ShopItemDto
{
    public Guid ItemId { get; set; }
    public string ItemType { get; set; } = "";
    public string ItemDefinitionId { get; set; } = "";
    public string DisplayName { get; set; } = "";
    public string Icon { get; set; } = "";
    public string Description { get; set; } = "";
    public PriceDto Price { get; set; } = new();
    public int StockLimit { get; set; }
    public int CurrentStock { get; set; }
    public PurchaseLimitDto? PurchaseLimit { get; set; }
    public int RequiredLevel { get; set; }
    public bool CanPurchase { get; set; }
    public string? PurchaseBlockReason { get; set; }
    public int PurchasedCount { get; set; }
}

public class PriceDto
{
    public string CurrencyType { get; set; } = "Gold";
    public int Amount { get; set; }
    public string? CurrencyId { get; set; }
    public string DisplayText { get; set; } = "";
}

public class PurchaseLimitDto
{
    public string LimitType { get; set; } = "None";
    public int MaxPurchases { get; set; }
    public int RemainingPurchases { get; set; }
    public DateTime? ResetTime { get; set; }
}
```

#### 1.2.3 PurchaseRequestï¼ˆè´­ä¹°è¯·æ±‚ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Shared/Dtos/Shop/PurchaseRequest.cs`

```csharp
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Shared.Dtos.Shop;

/// <summary>
/// è´­ä¹°è¯·æ±‚ DTO
/// </summary>
public class PurchaseRequest
{
    /// <summary>
    /// è§’è‰² ID
    /// </summary>
    [Required]
    public Guid CharacterId { get; set; }

    /// <summary>
    /// å•†åº— ID
    /// </summary>
    [Required]
    public string ShopId { get; set; } = "";

    /// <summary>
    /// å•†å“ ID
    /// </summary>
    [Required]
    public Guid ItemId { get; set; }

    /// <summary>
    /// è´­ä¹°æ•°é‡
    /// </summary>
    [Range(1, 999)]
    public int Quantity { get; set; } = 1;

    /// <summary>
    /// å¹‚ç­‰æ€§é”®ï¼ˆå¯é€‰ï¼Œç”¨äºé˜²é‡å¤ï¼‰
    /// </summary>
    public string? IdempotencyKey { get; set; }
}
```

#### 1.2.4 PurchaseResponseï¼ˆè´­ä¹°å“åº”ï¼‰

**ä½ç½®**ï¼š`BlazorIdle.Shared/Dtos/Shop/PurchaseResponse.cs`

```csharp
namespace BlazorIdle.Shared.Dtos.Shop;

/// <summary>
/// è´­ä¹°å“åº” DTO
/// </summary>
public class PurchaseResponse
{
    public bool Success { get; set; }
    public string? ErrorMessage { get; set; }
    public PurchaseResultDto? Result { get; set; }
}

public class PurchaseResultDto
{
    public Guid PurchaseRecordId { get; set; }
    public int RemainingGold { get; set; }
    public int ItemQuantity { get; set; }
    public DateTime PurchasedAt { get; set; }
}
```

---

## API æ¥å£è®¾è®¡

### 2.1 RESTful API ç«¯ç‚¹

#### 2.1.1 å•†åº—åˆ—è¡¨

**ç«¯ç‚¹**ï¼š`GET /api/shop/list`

**æè¿°**ï¼šè·å–è§’è‰²å¯è§çš„å•†åº—åˆ—è¡¨

**è¯·æ±‚å‚æ•°**ï¼š
```csharp
public class ListShopsQuery
{
    public Guid CharacterId { get; set; }
    public bool IncludeDisabled { get; set; } = false;
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "shops": [
    {
      "id": "general_shop",
      "name": "æ‚è´§é“º",
      "type": "General",
      "icon": "ğŸª",
      "description": "å‡ºå”®åŸºç¡€ç‰©å“å’Œæ¶ˆè€—å“",
      "isUnlocked": true,
      "unlockHint": null,
      "itemCount": 25
    },
    {
      "id": "weapon_shop",
      "name": "æ­¦å™¨åº—",
      "type": "General",
      "icon": "âš”ï¸",
      "description": "å‡ºå”®å„ç±»æ­¦å™¨å’Œé˜²å…·",
      "isUnlocked": false,
      "unlockHint": "è¾¾åˆ°ç­‰çº§ 10 è§£é”",
      "itemCount": 0
    }
  ]
}
```

#### 2.1.2 å•†å“åˆ—è¡¨

**ç«¯ç‚¹**ï¼š`GET /api/shop/{shopId}/items`

**æè¿°**ï¼šè·å–æŒ‡å®šå•†åº—çš„å•†å“åˆ—è¡¨

**è¯·æ±‚å‚æ•°**ï¼š
```csharp
public class ListShopItemsQuery
{
    public string ShopId { get; set; } = "";
    public Guid CharacterId { get; set; }
    public int Page { get; set; } = 1;
    public int PageSize { get; set; } = 50;
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "shopId": "general_shop",
  "items": [
    {
      "itemId": "550e8400-e29b-41d4-a716-446655440000",
      "itemType": "Consumable",
      "itemDefinitionId": "potion_health_small",
      "displayName": "å°å‹ç”Ÿå‘½è¯æ°´",
      "icon": "ğŸ§ª",
      "description": "æ¢å¤ 100 ç‚¹ç”Ÿå‘½å€¼",
      "price": {
        "currencyType": "Gold",
        "amount": 50,
        "displayText": "50 é‡‘å¸"
      },
      "stockLimit": -1,
      "currentStock": 0,
      "purchaseLimit": {
        "limitType": "Daily",
        "maxPurchases": 10,
        "remainingPurchases": 8,
        "resetTime": "2025-10-13T00:00:00Z"
      },
      "requiredLevel": 1,
      "canPurchase": true,
      "purchaseBlockReason": null,
      "purchasedCount": 2
    }
  ],
  "totalCount": 25,
  "page": 1,
  "pageSize": 50
}
```

#### 2.1.3 è´­ä¹°å•†å“

**ç«¯ç‚¹**ï¼š`POST /api/shop/purchase`

**æè¿°**ï¼šè´­ä¹°å•†å“

**è¯·æ±‚ä½“**ï¼š
```json
{
  "characterId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "shopId": "general_shop",
  "itemId": "550e8400-e29b-41d4-a716-446655440000",
  "quantity": 5,
  "idempotencyKey": "purchase_20251012_123456"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "errorMessage": null,
  "result": {
    "purchaseRecordId": "660e8400-e29b-41d4-a716-446655440001",
    "remainingGold": 4750,
    "itemQuantity": 5,
    "purchasedAt": "2025-10-12T14:30:00Z"
  }
}
```

**é”™è¯¯å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": false,
  "errorMessage": "é‡‘å¸ä¸è¶³ï¼Œéœ€è¦ 250 é‡‘å¸ï¼Œå½“å‰ä»…æœ‰ 200 é‡‘å¸",
  "result": null
}
```

#### 2.1.4 è´­ä¹°å†å²

**ç«¯ç‚¹**ï¼š`GET /api/shop/purchase-history`

**æè¿°**ï¼šè·å–è§’è‰²çš„è´­ä¹°å†å²è®°å½•

**è¯·æ±‚å‚æ•°**ï¼š
```csharp
public class PurchaseHistoryQuery
{
    public Guid CharacterId { get; set; }
    public string? ShopId { get; set; }  // å¯é€‰ï¼Œç­›é€‰ç‰¹å®šå•†åº—
    public DateTime? StartDate { get; set; }
    public DateTime? EndDate { get; set; }
    public int Page { get; set; } = 1;
    public int PageSize { get; set; } = 20;
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "records": [
    {
      "purchaseId": "660e8400-e29b-41d4-a716-446655440001",
      "shopId": "general_shop",
      "shopName": "æ‚è´§é“º",
      "itemName": "å°å‹ç”Ÿå‘½è¯æ°´",
      "quantity": 5,
      "price": {
        "currencyType": "Gold",
        "amount": 250
      },
      "purchasedAt": "2025-10-12T14:30:00Z"
    }
  ],
  "totalCount": 42,
  "page": 1,
  "pageSize": 20
}
```

### 2.2 Controller å®ç°

**ä½ç½®**ï¼š`BlazorIdle.Server/Api/ShopController.cs`

```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using BlazorIdle.Server.Application.Shop;
using BlazorIdle.Shared.Dtos.Shop;

namespace BlazorIdle.Server.Api;

[ApiController]
[Route("api/[controller]")]
[Authorize]
public class ShopController : ControllerBase
{
    private readonly IShopService _shopService;
    private readonly ILogger<ShopController> _logger;

    public ShopController(IShopService shopService, ILogger<ShopController> logger)
    {
        _shopService = shopService;
        _logger = logger;
    }

    /// <summary>
    /// è·å–å•†åº—åˆ—è¡¨
    /// </summary>
    [HttpGet("list")]
    public async Task<ActionResult<ListShopsResponse>> ListShops(
        [FromQuery] Guid characterId,
        [FromQuery] bool includeDisabled = false,
        CancellationToken ct = default)
    {
        try
        {
            var result = await _shopService.ListShopsAsync(characterId, includeDisabled, ct);
            return Ok(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to list shops for character {CharacterId}", characterId);
            return StatusCode(500, new { error = "è·å–å•†åº—åˆ—è¡¨å¤±è´¥" });
        }
    }

    /// <summary>
    /// è·å–å•†åº—å•†å“åˆ—è¡¨
    /// </summary>
    [HttpGet("{shopId}/items")]
    public async Task<ActionResult<ListShopItemsResponse>> ListShopItems(
        string shopId,
        [FromQuery] Guid characterId,
        [FromQuery] int page = 1,
        [FromQuery] int pageSize = 50,
        CancellationToken ct = default)
    {
        try
        {
            var result = await _shopService.ListShopItemsAsync(
                shopId, characterId, page, pageSize, ct);
            return Ok(result);
        }
        catch (KeyNotFoundException)
        {
            return NotFound(new { error = $"å•†åº— {shopId} ä¸å­˜åœ¨" });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to list items for shop {ShopId}", shopId);
            return StatusCode(500, new { error = "è·å–å•†å“åˆ—è¡¨å¤±è´¥" });
        }
    }

    /// <summary>
    /// è´­ä¹°å•†å“
    /// </summary>
    [HttpPost("purchase")]
    public async Task<ActionResult<PurchaseResponse>> Purchase(
        [FromBody] PurchaseRequest request,
        CancellationToken ct = default)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);

        try
        {
            var result = await _shopService.PurchaseItemAsync(request, ct);
            return Ok(result);
        }
        catch (InvalidOperationException ex)
        {
            return BadRequest(new PurchaseResponse
            {
                Success = false,
                ErrorMessage = ex.Message
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to purchase item {ItemId} for character {CharacterId}",
                request.ItemId, request.CharacterId);
            return StatusCode(500, new PurchaseResponse
            {
                Success = false,
                ErrorMessage = "è´­ä¹°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
            });
        }
    }

    /// <summary>
    /// è·å–è´­ä¹°å†å²
    /// </summary>
    [HttpGet("purchase-history")]
    public async Task<ActionResult<PurchaseHistoryResponse>> GetPurchaseHistory(
        [FromQuery] Guid characterId,
        [FromQuery] string? shopId = null,
        [FromQuery] DateTime? startDate = null,
        [FromQuery] DateTime? endDate = null,
        [FromQuery] int page = 1,
        [FromQuery] int pageSize = 20,
        CancellationToken ct = default)
    {
        try
        {
            var result = await _shopService.GetPurchaseHistoryAsync(
                characterId, shopId, startDate, endDate, page, pageSize, ct);
            return Ok(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get purchase history for character {CharacterId}",
                characterId);
            return StatusCode(500, new { error = "è·å–è´­ä¹°å†å²å¤±è´¥" });
        }
    }
}
```

---

## æœåŠ¡å±‚è®¾è®¡

### 3.1 æœåŠ¡æ¥å£

**ä½ç½®**ï¼š`BlazorIdle.Server/Application/Abstractions/IShopService.cs`

```csharp
using BlazorIdle.Shared.Dtos.Shop;

namespace BlazorIdle.Server.Application.Abstractions;

/// <summary>
/// å•†åº—æœåŠ¡æ¥å£
/// </summary>
public interface IShopService
{
    /// <summary>
    /// è·å–å•†åº—åˆ—è¡¨
    /// </summary>
    Task<ListShopsResponse> ListShopsAsync(
        Guid characterId,
        bool includeDisabled,
        CancellationToken ct = default);

    /// <summary>
    /// è·å–å•†åº—å•†å“åˆ—è¡¨
    /// </summary>
    Task<ListShopItemsResponse> ListShopItemsAsync(
        string shopId,
        Guid characterId,
        int page,
        int pageSize,
        CancellationToken ct = default);

    /// <summary>
    /// è´­ä¹°å•†å“
    /// </summary>
    Task<PurchaseResponse> PurchaseItemAsync(
        PurchaseRequest request,
        CancellationToken ct = default);

    /// <summary>
    /// è·å–è´­ä¹°å†å²
    /// </summary>
    Task<PurchaseHistoryResponse> GetPurchaseHistoryAsync(
        Guid characterId,
        string? shopId,
        DateTime? startDate,
        DateTime? endDate,
        int page,
        int pageSize,
        CancellationToken ct = default);
}
```

### 3.2 æœåŠ¡å®ç°éª¨æ¶

**ä½ç½®**ï¼š`BlazorIdle.Server/Application/Shop/ShopService.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using BlazorIdle.Server.Application.Abstractions;
using BlazorIdle.Server.Infrastructure.Persistence;
using BlazorIdle.Shared.Dtos.Shop;

namespace BlazorIdle.Server.Application.Shop;

/// <summary>
/// å•†åº—æœåŠ¡å®ç°
/// </summary>
public class ShopService : IShopService
{
    private readonly GameDbContext _context;
    private readonly IPurchaseValidator _validator;
    private readonly ILogger<ShopService> _logger;

    public ShopService(
        GameDbContext context,
        IPurchaseValidator validator,
        ILogger<ShopService> logger)
    {
        _context = context;
        _validator = validator;
        _logger = logger;
    }

    public async Task<ListShopsResponse> ListShopsAsync(
        Guid characterId,
        bool includeDisabled,
        CancellationToken ct = default)
    {
        // å®ç°è§ä¸‹ä¸€èŠ‚
        throw new NotImplementedException();
    }

    public async Task<ListShopItemsResponse> ListShopItemsAsync(
        string shopId,
        Guid characterId,
        int page,
        int pageSize,
        CancellationToken ct = default)
    {
        // å®ç°è§ä¸‹ä¸€èŠ‚
        throw new NotImplementedException();
    }

    public async Task<PurchaseResponse> PurchaseItemAsync(
        PurchaseRequest request,
        CancellationToken ct = default)
    {
        // å®ç°è§ä¸‹ä¸€èŠ‚
        throw new NotImplementedException();
    }

    public async Task<PurchaseHistoryResponse> GetPurchaseHistoryAsync(
        Guid characterId,
        string? shopId,
        DateTime? startDate,
        DateTime? endDate,
        int page,
        int pageSize,
        CancellationToken ct = default)
    {
        // å®ç°è§ä¸‹ä¸€èŠ‚
        throw new NotImplementedException();
    }
}
```

### 3.3 éªŒè¯å™¨æ¥å£

**ä½ç½®**ï¼š`BlazorIdle.Server/Application/Abstractions/IPurchaseValidator.cs`

```csharp
using BlazorIdle.Server.Domain.Characters;
using BlazorIdle.Server.Domain.Shop;

namespace BlazorIdle.Server.Application.Abstractions;

/// <summary>
/// è´­ä¹°éªŒè¯å™¨æ¥å£
/// </summary>
public interface IPurchaseValidator
{
    /// <summary>
    /// éªŒè¯è´­ä¹°è¯·æ±‚
    /// </summary>
    Task<ValidationResult> ValidatePurchaseAsync(
        Character character,
        ShopItem item,
        int quantity,
        CancellationToken ct = default);
}

/// <summary>
/// éªŒè¯ç»“æœ
/// </summary>
public class ValidationResult
{
    public bool IsValid { get; set; }
    public string? ErrorMessage { get; set; }
    public List<string> Errors { get; set; } = new();

    public static ValidationResult Success() => new() { IsValid = true };
    public static ValidationResult Failure(string error) =>
        new() { IsValid = false, ErrorMessage = error, Errors = new() { error } };
}
```

---

## ä¸šåŠ¡é€»è¾‘å®ç°

### 4.1 è´­ä¹°æµç¨‹å®ç°

**ä½ç½®**ï¼š`BlazorIdle.Server/Application/Shop/ShopService.cs` (PurchaseItemAsync æ–¹æ³•)

```csharp
public async Task<PurchaseResponse> PurchaseItemAsync(
    PurchaseRequest request,
    CancellationToken ct = default)
{
    using var transaction = await _context.Database.BeginTransactionAsync(ct);
    
    try
    {
        // 1. åŠ è½½è§’è‰²
        var character = await _context.Characters
            .FirstOrDefaultAsync(c => c.Id == request.CharacterId, ct);
        
        if (character == null)
            return CreateErrorResponse("è§’è‰²ä¸å­˜åœ¨");

        // 2. åŠ è½½å•†å“
        var item = await _context.Set<ShopItem>()
            .Include(i => i.Shop)
            .FirstOrDefaultAsync(i => i.Id == request.ItemId && i.ShopId == request.ShopId, ct);
        
        if (item == null)
            return CreateErrorResponse("å•†å“ä¸å­˜åœ¨");

        // 3. éªŒè¯è´­ä¹°
        var validationResult = await _validator.ValidatePurchaseAsync(
            character, item, request.Quantity, ct);
        
        if (!validationResult.IsValid)
            return CreateErrorResponse(validationResult.ErrorMessage!);

        // 4. æ‰£é™¤è´§å¸/ç‰©å“
        var price = item.GetPrice();
        await DeductCurrencyAsync(character, price, request.Quantity, ct);

        // 5. æ·»åŠ ç‰©å“åˆ°èƒŒåŒ…
        await AddItemToInventoryAsync(
            character.Id, item.ItemDefinitionId, request.Quantity, ct);

        // 6. è®°å½•è´­ä¹°
        var purchaseRecord = new Domain.Shop.PurchaseRecord
        {
            CharacterId = character.Id,
            ShopId = item.ShopId,
            ShopItemId = item.Id,
            ItemDefinitionId = item.ItemDefinitionId,
            Quantity = request.Quantity,
            PriceJson = item.PriceJson,
            PurchasedAt = DateTime.UtcNow
        };
        _context.Set<Domain.Shop.PurchaseRecord>().Add(purchaseRecord);

        // 7. æ›´æ–°è´­ä¹°è®¡æ•°
        await UpdatePurchaseCounterAsync(character.Id, item, request.Quantity, ct);

        // 8. æ›´æ–°åº“å­˜ï¼ˆå¦‚æœæœ‰é™åˆ¶ï¼‰
        if (item.StockLimit > 0)
        {
            item.CurrentStock -= request.Quantity;
        }

        await _context.SaveChangesAsync(ct);
        await transaction.CommitAsync(ct);

        _logger.LogInformation(
            "Character {CharacterId} purchased {Quantity}x {ItemId} from shop {ShopId}",
            character.Id, request.Quantity, item.ItemDefinitionId, item.ShopId);

        return new PurchaseResponse
        {
            Success = true,
            Result = new PurchaseResultDto
            {
                PurchaseRecordId = purchaseRecord.Id,
                RemainingGold = character.Gold,
                ItemQuantity = request.Quantity,
                PurchasedAt = purchaseRecord.PurchasedAt
            }
        };
    }
    catch (Exception ex)
    {
        await transaction.RollbackAsync(ct);
        _logger.LogError(ex, "Failed to purchase item {ItemId}", request.ItemId);
        return CreateErrorResponse("è´­ä¹°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
    }
}

private PurchaseResponse CreateErrorResponse(string message)
{
    return new PurchaseResponse
    {
        Success = false,
        ErrorMessage = message
    };
}
```

### 4.2 éªŒè¯å™¨å®ç°

**ä½ç½®**ï¼š`BlazorIdle.Server/Application/Shop/PurchaseValidator.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using BlazorIdle.Server.Application.Abstractions;
using BlazorIdle.Server.Domain.Characters;
using BlazorIdle.Server.Domain.Shop;
using BlazorIdle.Server.Domain.Shop.ValueObjects;
using BlazorIdle.Server.Infrastructure.Persistence;

namespace BlazorIdle.Server.Application.Shop;

/// <summary>
/// è´­ä¹°éªŒè¯å™¨å®ç°
/// </summary>
public class PurchaseValidator : IPurchaseValidator
{
    private readonly GameDbContext _context;

    public PurchaseValidator(GameDbContext context)
    {
        _context = context;
    }

    public async Task<ValidationResult> ValidatePurchaseAsync(
        Character character,
        ShopItem item,
        int quantity,
        CancellationToken ct = default)
    {
        // 1. æ£€æŸ¥å•†åº—å’Œå•†å“æ˜¯å¦å¯ç”¨
        if (!item.Shop.IsEnabled)
            return ValidationResult.Failure("å•†åº—æœªå¼€æ”¾");
        
        if (!item.IsEnabled)
            return ValidationResult.Failure("å•†å“å·²ä¸‹æ¶");

        // 2. æ£€æŸ¥ç­‰çº§è¦æ±‚
        if (character.Level < item.RequiredLevel)
            return ValidationResult.Failure(
                $"ç­‰çº§ä¸è¶³ï¼Œéœ€è¦ç­‰çº§ {item.RequiredLevel}");

        // 3. æ£€æŸ¥è´§å¸
        var price = item.GetPrice();
        var currencyCheckResult = await CheckCurrencyAsync(
            character, price, quantity, ct);
        if (!currencyCheckResult.IsValid)
            return currencyCheckResult;

        // 4. æ£€æŸ¥åº“å­˜é™åˆ¶
        if (item.StockLimit > 0 && item.CurrentStock < quantity)
            return ValidationResult.Failure(
                $"åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š{item.CurrentStock}");

        // 5. æ£€æŸ¥è´­ä¹°é™åˆ¶
        var limit = item.GetPurchaseLimit();
        if (limit != null && limit.LimitType != PurchaseLimitType.None)
        {
            var limitCheckResult = await CheckPurchaseLimitAsync(
                character.Id, item, limit, quantity, ct);
            if (!limitCheckResult.IsValid)
                return limitCheckResult;
        }

        // 6. æ£€æŸ¥èƒŒåŒ…ç©ºé—´ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå‡è®¾æ€»èƒ½å®¹çº³ï¼‰
        // æœªæ¥å¯ä»¥æ‰©å±•ä¸ºæ£€æŸ¥èƒŒåŒ…å®¹é‡ä¸Šé™

        return ValidationResult.Success();
    }

    private async Task<ValidationResult> CheckCurrencyAsync(
        Character character,
        Price price,
        int quantity,
        CancellationToken ct)
    {
        switch (price.CurrencyType)
        {
            case CurrencyType.Gold:
                var totalCost = price.Amount * quantity;
                if (character.Gold < totalCost)
                    return ValidationResult.Failure(
                        $"é‡‘å¸ä¸è¶³ï¼Œéœ€è¦ {totalCost} é‡‘å¸ï¼Œå½“å‰ä»…æœ‰ {character.Gold} é‡‘å¸");
                break;

            case CurrencyType.Item:
                // æ£€æŸ¥ç‰©å“æ•°é‡
                var item = await _context.Set<InventoryItem>()
                    .FirstOrDefaultAsync(
                        i => i.CharacterId == character.Id 
                            && i.ItemId == price.CurrencyId,
                        ct);
                
                var requiredQuantity = price.Amount * quantity;
                if (item == null || item.Quantity < requiredQuantity)
                    return ValidationResult.Failure(
                        $"ç‰©å“ {price.CurrencyId} ä¸è¶³ï¼Œéœ€è¦ {requiredQuantity}");
                break;

            case CurrencyType.SpecialCurrency:
                // æœªæ¥æ‰©å±•ï¼šæ£€æŸ¥ç‰¹æ®Šè´§å¸
                return ValidationResult.Failure("ç‰¹æ®Šè´§å¸ç³»ç»Ÿå°šæœªå®ç°");

            default:
                return ValidationResult.Failure("æœªçŸ¥çš„è´§å¸ç±»å‹");
        }

        return ValidationResult.Success();
    }

    private async Task<ValidationResult> CheckPurchaseLimitAsync(
        Guid characterId,
        ShopItem item,
        PurchaseLimit limit,
        int quantity,
        CancellationToken ct)
    {
        var periodKey = GetPeriodKey(limit.LimitType);
        
        var counter = await _context.Set<PurchaseCounter>()
            .FirstOrDefaultAsync(
                c => c.CharacterId == characterId
                    && c.ShopItemId == item.Id
                    && c.PeriodKey == periodKey,
                ct);

        var currentCount = counter?.PurchaseCount ?? 0;
        var remaining = limit.MaxPurchases - currentCount;

        if (remaining < quantity)
        {
            var resetInfo = limit.LimitType switch
            {
                PurchaseLimitType.Daily => "æ¯æ—¥",
                PurchaseLimitType.Weekly => "æ¯å‘¨",
                PurchaseLimitType.Total => "æ€»è®¡",
                _ => ""
            };
            return ValidationResult.Failure(
                $"è´­ä¹°æ¬¡æ•°å·²è¾¾åˆ°{resetInfo}ä¸Šé™ï¼Œå‰©ä½™å¯è´­ä¹°æ¬¡æ•°ï¼š{remaining}");
        }

        return ValidationResult.Success();
    }

    private string GetPeriodKey(PurchaseLimitType limitType)
    {
        var now = DateTime.UtcNow;
        return limitType switch
        {
            PurchaseLimitType.Daily => $"daily_{now:yyyyMMdd}",
            PurchaseLimitType.Weekly => $"weekly_{now:yyyyMM}_{GetWeekOfYear(now)}",
            PurchaseLimitType.Total => "total",
            _ => "none"
        };
    }

    private int GetWeekOfYear(DateTime date)
    {
        var firstDayOfYear = new DateTime(date.Year, 1, 1);
        var dayOfYear = (date - firstDayOfYear).Days;
        return dayOfYear / 7 + 1;
    }
}
```

---

## æ•°æ®åº“è®¾è®¡

### 5.1 æ•°æ®åº“è¡¨ç»“æ„

#### 5.1.1 shop_definitions è¡¨

```sql
CREATE TABLE shop_definitions (
    Id TEXT PRIMARY KEY,
    Name TEXT NOT NULL,
    Type INTEGER NOT NULL,
    Icon TEXT NOT NULL DEFAULT 'ğŸª',
    Description TEXT NOT NULL DEFAULT '',
    UnlockCondition TEXT,
    IsEnabled INTEGER NOT NULL DEFAULT 1,
    SortOrder INTEGER NOT NULL DEFAULT 0,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL
);

CREATE INDEX IX_ShopDefinitions_Type ON shop_definitions (Type);
CREATE INDEX IX_ShopDefinitions_IsEnabled ON shop_definitions (IsEnabled);
```

#### 5.1.2 shop_items è¡¨

```sql
CREATE TABLE shop_items (
    Id TEXT PRIMARY KEY,
    ShopId TEXT NOT NULL,
    ItemType INTEGER NOT NULL,
    ItemDefinitionId TEXT NOT NULL,
    DisplayName TEXT,
    Icon TEXT,
    Description TEXT,
    PriceJson TEXT NOT NULL,
    StockLimit INTEGER NOT NULL DEFAULT -1,
    CurrentStock INTEGER NOT NULL DEFAULT 0,
    PurchaseLimitJson TEXT,
    RequiredLevel INTEGER NOT NULL DEFAULT 1,
    UnlockCondition TEXT,
    IsEnabled INTEGER NOT NULL DEFAULT 1,
    SortOrder INTEGER NOT NULL DEFAULT 0,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL,
    FOREIGN KEY (ShopId) REFERENCES shop_definitions(Id) ON DELETE CASCADE
);

CREATE INDEX IX_ShopItems_ShopId ON shop_items (ShopId);
CREATE INDEX IX_ShopItems_ItemType ON shop_items (ItemType);
CREATE INDEX IX_ShopItems_IsEnabled ON shop_items (IsEnabled);
```

#### 5.1.3 purchase_records è¡¨

```sql
CREATE TABLE purchase_records (
    Id TEXT PRIMARY KEY,
    CharacterId TEXT NOT NULL,
    ShopId TEXT NOT NULL,
    ShopItemId TEXT NOT NULL,
    ItemDefinitionId TEXT NOT NULL,
    Quantity INTEGER NOT NULL,
    PriceJson TEXT NOT NULL,
    PurchasedAt TEXT NOT NULL,
    EconomyEventId TEXT,
    FOREIGN KEY (CharacterId) REFERENCES Characters(Id) ON DELETE CASCADE
);

CREATE INDEX IX_PurchaseRecords_CharacterId ON purchase_records (CharacterId);
CREATE INDEX IX_PurchaseRecords_ShopId ON purchase_records (ShopId);
CREATE INDEX IX_PurchaseRecords_PurchasedAt ON purchase_records (PurchasedAt DESC);
```

#### 5.1.4 purchase_counters è¡¨

```sql
CREATE TABLE purchase_counters (
    Id TEXT PRIMARY KEY,
    CharacterId TEXT NOT NULL,
    ShopItemId TEXT NOT NULL,
    PeriodKey TEXT NOT NULL,
    PurchaseCount INTEGER NOT NULL DEFAULT 0,
    LastPurchaseAt TEXT NOT NULL,
    ExpiresAt TEXT,
    UNIQUE(CharacterId, ShopItemId, PeriodKey),
    FOREIGN KEY (CharacterId) REFERENCES Characters(Id) ON DELETE CASCADE,
    FOREIGN KEY (ShopItemId) REFERENCES shop_items(Id) ON DELETE CASCADE
);

CREATE INDEX IX_PurchaseCounters_CharacterId ON purchase_counters (CharacterId);
CREATE INDEX IX_PurchaseCounters_PeriodKey ON purchase_counters (PeriodKey);
CREATE INDEX IX_PurchaseCounters_ExpiresAt ON purchase_counters (ExpiresAt)
    WHERE ExpiresAt IS NOT NULL;
```

### 5.2 EF Core é…ç½®

**ä½ç½®**ï¼š`BlazorIdle.Server/Infrastructure/Persistence/Configurations/ShopConfiguration.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using BlazorIdle.Server.Domain.Shop;

namespace BlazorIdle.Server.Infrastructure.Persistence.Configurations;

public class ShopDefinitionConfiguration : IEntityTypeConfiguration<ShopDefinition>
{
    public void Configure(EntityTypeBuilder<ShopDefinition> builder)
    {
        builder.ToTable("shop_definitions");
        
        builder.HasKey(s => s.Id);
        
        builder.Property(s => s.Name).IsRequired().HasMaxLength(200);
        builder.Property(s => s.Type).IsRequired();
        builder.Property(s => s.Icon).HasMaxLength(50);
        builder.Property(s => s.Description).HasMaxLength(1000);
        builder.Property(s => s.UnlockCondition).HasMaxLength(500);
        
        builder.HasMany(s => s.Items)
            .WithOne(i => i.Shop)
            .HasForeignKey(i => i.ShopId)
            .OnDelete(DeleteBehavior.Cascade);
    }
}

public class ShopItemConfiguration : IEntityTypeConfiguration<ShopItem>
{
    public void Configure(EntityTypeBuilder<ShopItem> builder)
    {
        builder.ToTable("shop_items");
        
        builder.HasKey(i => i.Id);
        
        builder.Property(i => i.ShopId).IsRequired().HasMaxLength(100);
        builder.Property(i => i.ItemType).IsRequired();
        builder.Property(i => i.ItemDefinitionId).IsRequired().HasMaxLength(100);
        builder.Property(i => i.DisplayName).HasMaxLength(200);
        builder.Property(i => i.Icon).HasMaxLength(50);
        builder.Property(i => i.Description).HasMaxLength(1000);
        builder.Property(i => i.PriceJson).IsRequired();
        builder.Property(i => i.UnlockCondition).HasMaxLength(500);
    }
}

public class PurchaseRecordConfiguration : IEntityTypeConfiguration<PurchaseRecord>
{
    public void Configure(EntityTypeBuilder<PurchaseRecord> builder)
    {
        builder.ToTable("purchase_records");
        
        builder.HasKey(r => r.Id);
        
        builder.Property(r => r.CharacterId).IsRequired();
        builder.Property(r => r.ShopId).IsRequired().HasMaxLength(100);
        builder.Property(r => r.ShopItemId).IsRequired();
        builder.Property(r => r.ItemDefinitionId).IsRequired().HasMaxLength(100);
        builder.Property(r => r.Quantity).IsRequired();
        builder.Property(r => r.PriceJson).IsRequired();
    }
}

public class PurchaseCounterConfiguration : IEntityTypeConfiguration<PurchaseCounter>
{
    public void Configure(EntityTypeBuilder<PurchaseCounter> builder)
    {
        builder.ToTable("purchase_counters");
        
        builder.HasKey(c => c.Id);
        
        builder.HasIndex(c => new { c.CharacterId, c.ShopItemId, c.PeriodKey })
            .IsUnique();
    }
}
```

---

## é…ç½®ä¸ç§å­æ•°æ®

### 6.1 åˆå§‹å•†åº—æ•°æ®

**ä½ç½®**ï¼š`BlazorIdle.Server/Infrastructure/Persistence/ShopSeedData.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using BlazorIdle.Server.Domain.Shop;
using BlazorIdle.Server.Domain.Shop.ValueObjects;
using System.Text.Json;

namespace BlazorIdle.Server.Infrastructure.Persistence;

/// <summary>
/// å•†åº—ç³»ç»Ÿç§å­æ•°æ®
/// </summary>
public static class ShopSeedData
{
    public static void SeedShops(this ModelBuilder modelBuilder)
    {
        var now = new DateTime(2025, 10, 12, 0, 0, 0, DateTimeKind.Utc);

        // æ‚è´§é“º
        modelBuilder.Entity<ShopDefinition>().HasData(
            new ShopDefinition
            {
                Id = "general_shop",
                Name = "æ‚è´§é“º",
                Type = ShopType.General,
                Icon = "ğŸª",
                Description = "å‡ºå”®åŸºç¡€æ¶ˆè€—å“å’Œææ–™",
                IsEnabled = true,
                SortOrder = 1,
                CreatedAt = now,
                UpdatedAt = now
            }
        );

        // æ­¦å™¨åº—
        modelBuilder.Entity<ShopDefinition>().HasData(
            new ShopDefinition
            {
                Id = "weapon_shop",
                Name = "æ­¦å™¨åº—",
                Type = ShopType.General,
                Icon = "âš”ï¸",
                Description = "å‡ºå”®å„ç±»æ­¦å™¨å’Œé˜²å…·",
                UnlockCondition = "level>=10",
                IsEnabled = true,
                SortOrder = 2,
                CreatedAt = now,
                UpdatedAt = now
            }
        );

        // ç‚¼é‡‘æœ¯å£«
        modelBuilder.Entity<ShopDefinition>().HasData(
            new ShopDefinition
            {
                Id = "alchemist_shop",
                Name = "ç‚¼é‡‘æœ¯å£«",
                Type = ShopType.Special,
                Icon = "ğŸ§™",
                Description = "å‡ºå”®é«˜çº§è¯å‰‚å’Œé­”æ³•ç‰©å“",
                UnlockCondition = "level>=20",
                IsEnabled = true,
                SortOrder = 3,
                CreatedAt = now,
                UpdatedAt = now
            }
        );
    }

    public static void SeedShopItems(this ModelBuilder modelBuilder)
    {
        var now = new DateTime(2025, 10, 12, 0, 0, 0, DateTimeKind.Utc);

        // æ‚è´§é“ºå•†å“
        SeedGeneralShopItems(modelBuilder, now);
    }

    private static void SeedGeneralShopItems(ModelBuilder modelBuilder, DateTime now)
    {
        // å°å‹ç”Ÿå‘½è¯æ°´
        modelBuilder.Entity<ShopItem>().HasData(
            new
            {
                Id = Guid.Parse("550e8400-e29b-41d4-a716-446655440001"),
                ShopId = "general_shop",
                ItemType = ShopItemType.Consumable,
                ItemDefinitionId = "potion_health_small",
                DisplayName = "å°å‹ç”Ÿå‘½è¯æ°´",
                Icon = "ğŸ§ª",
                Description = "æ¢å¤ 100 ç‚¹ç”Ÿå‘½å€¼",
                PriceJson = JsonSerializer.Serialize(new Price
                {
                    CurrencyType = CurrencyType.Gold,
                    Amount = 50
                }),
                StockLimit = -1,
                CurrentStock = 0,
                PurchaseLimitJson = JsonSerializer.Serialize(new PurchaseLimit
                {
                    LimitType = PurchaseLimitType.Daily,
                    MaxPurchases = 10
                }),
                RequiredLevel = 1,
                IsEnabled = true,
                SortOrder = 1,
                CreatedAt = now,
                UpdatedAt = now
            }
        );

        // é¢åŒ…
        modelBuilder.Entity<ShopItem>().HasData(
            new
            {
                Id = Guid.Parse("550e8400-e29b-41d4-a716-446655440002"),
                ShopId = "general_shop",
                ItemType = ShopItemType.Consumable,
                ItemDefinitionId = "food_bread",
                DisplayName = "é¢åŒ…",
                Icon = "ğŸ",
                Description = "æ¢å¤ 50 ç‚¹ç”Ÿå‘½å€¼",
                PriceJson = JsonSerializer.Serialize(new Price
                {
                    CurrencyType = CurrencyType.Gold,
                    Amount = 10
                }),
                StockLimit = -1,
                CurrentStock = 0,
                PurchaseLimitJson = (string?)null,
                RequiredLevel = 1,
                IsEnabled = true,
                SortOrder = 2,
                CreatedAt = now,
                UpdatedAt = now
            }
        );
    }
}
```

### 6.2 DbContext é›†æˆ

**ä½ç½®**ï¼š`BlazorIdle.Server/Infrastructure/Persistence/GameDbContext.cs`ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰

```csharp
// åœ¨ GameDbContext ç±»ä¸­æ·»åŠ 
public DbSet<ShopDefinition> ShopDefinitions => Set<ShopDefinition>();
public DbSet<ShopItem> ShopItems => Set<ShopItem>();
public DbSet<PurchaseRecord> PurchaseRecords => Set<PurchaseRecord>();
public DbSet<PurchaseCounter> PurchaseCounters => Set<PurchaseCounter>();

protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);
    
    // ... å…¶ä»–é…ç½® ...
    
    // å•†åº—ç³»ç»Ÿé…ç½®
    modelBuilder.ApplyConfiguration(new ShopDefinitionConfiguration());
    modelBuilder.ApplyConfiguration(new ShopItemConfiguration());
    modelBuilder.ApplyConfiguration(new PurchaseRecordConfiguration());
    modelBuilder.ApplyConfiguration(new PurchaseCounterConfiguration());
    
    // ç§å­æ•°æ®
    modelBuilder.SeedShops();
    modelBuilder.SeedShopItems();
}
```

---

## ä¸‹ä¸€æ­¥

æœ¬æ–‡æ¡£ï¼ˆä¸­ç¯‡ï¼‰å®Œæˆäº†è¯¦ç»†è®¾è®¡ä¸å®ç°è§„èŒƒã€‚æ¥ä¸‹æ¥ï¼š

- **ä¸‹ç¯‡**å°†åˆ¶å®šé˜¶æ®µæ€§å®æ–½æ–¹æ¡ˆã€æµ‹è¯•ç­–ç•¥ã€éªŒæ”¶æ ‡å‡†å’Œäº¤ä»˜æ¸…å•

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… ä¸­ç¯‡å®Œæˆ  
**ä¸‹ä¸€æ–‡æ¡£**ï¼šå•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰- å®æ–½æ–¹æ¡ˆä¸äº¤ä»˜  
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼šä¸ä¸Šã€ä¸‹ç¯‡åŒæ—¶äº¤ä»˜
