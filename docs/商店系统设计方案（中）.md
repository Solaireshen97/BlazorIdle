# BlazorIdle å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰
## å®æ–½è®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒ

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**ä½œè€…**: ç³»ç»Ÿæ¶æ„è®¾è®¡å›¢é˜Ÿ  

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£ä¸ºã€Šå•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆã€‹çš„ä¸­ç¯‡ï¼Œä¸“æ³¨äºè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’å’ŒæŠ€æœ¯å®ç°è§„èŒƒã€‚

### ä¸ä¸Šä¸‹ç¯‡çš„å…³ç³»

- **ä¸Šç¯‡**: ç³»ç»Ÿåˆ†æä¸æ¶æ„è®¾è®¡ â† è®¾è®¡åŸºç¡€
- **ä¸­ç¯‡**ï¼ˆæœ¬æ–‡æ¡£ï¼‰: å®æ–½è®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒ â† å¦‚ä½•å®æ–½
- **ä¸‹ç¯‡**: æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡ â† è´¨é‡ä¿è¯

---

## 1. æ•´ä½“å®æ–½è®¡åˆ’æ¦‚è§ˆ

### 1.1 Phase åˆ’åˆ†

| Phase | å‘¨æœŸ | æ ¸å¿ƒç›®æ ‡ | å‰ç½®ä¾èµ– | éªŒè¯æ ‡å‡† |
|-------|------|---------|---------|---------|
| **Phase 1** | 1-2å‘¨ | åŸºç¡€æ¨¡å‹ä¸æ•°æ®åº“ | æ—  | æ•°æ®åº“è¿ç§»æˆåŠŸï¼Œæ¨¡å‹å®šä¹‰å®Œæˆ |
| **Phase 2** | 3-4å‘¨ | è´§å¸ç³»ç»Ÿä¸æ¡ä»¶å¼•æ“ | Phase 1 | è´§å¸å¯ç®¡ç†ï¼Œæ¡ä»¶å¯è¯„ä¼° |
| **Phase 3** | 5-7å‘¨ | æ ¸å¿ƒå•†åº—æœåŠ¡ | Phase 2 | å•†åº—å¯åˆ›å»ºï¼Œå•†å“å¯é…ç½® |
| **Phase 4** | 8-10å‘¨ | è´­ä¹°æµç¨‹å®ç° | Phase 3 | è´­ä¹°æˆåŠŸï¼Œäº‹åŠ¡å®‰å…¨ |
| **Phase 5** | 11-12å‘¨ | åˆ·æ–°æœºåˆ¶ä¸å‰ç«¯ | Phase 4 | å•†åº—å¯åˆ·æ–°ï¼Œå‰ç«¯å¯ç”¨ |
| **Phase 6** | 13-14å‘¨ | æµ‹è¯•ä¼˜åŒ–ä¸ä¸Šçº¿ | Phase 5 | å…¨ç³»ç»Ÿæµ‹è¯•é€šè¿‡ |

### 1.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ç‚¹ | æˆæœ | å‰ç«¯å¯éªŒè¯å†…å®¹ |
|--------|--------|------|---------------|
| **M1: æ•°æ®åŸºç¡€** | ç¬¬2å‘¨æœ« | æ•°æ®æ¨¡å‹å’Œæ•°æ®åº“å®Œæˆ | å¯æŸ¥è¯¢å•†åº—å®šä¹‰æ•°æ® |
| **M2: æ¡ä»¶ç³»ç»Ÿ** | ç¬¬4å‘¨æœ« | æ¡ä»¶å¼•æ“å¯ç”¨ | å¯è¯„ä¼°è§£é”æ¡ä»¶ |
| **M3: å•†åº—æ ¸å¿ƒ** | ç¬¬7å‘¨æœ« | å•†åº—æœåŠ¡å®Œæˆ | å•†åº—åˆ—è¡¨å¯æ˜¾ç¤º |
| **M4: è´­ä¹°åŠŸèƒ½** | ç¬¬10å‘¨æœ« | è´­ä¹°æµç¨‹å®Œæˆ | å¯å®Œæˆè´­ä¹°äº¤æ˜“ |
| **M5: å®Œæ•´åŠŸèƒ½** | ç¬¬12å‘¨æœ« | åˆ·æ–°å’Œå‰ç«¯å®Œæˆ | å®Œæ•´å•†åº—ç³»ç»Ÿå¯ç”¨ |
| **M6: ä¸Šçº¿å‡†å¤‡** | ç¬¬14å‘¨æœ« | æµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡ä¸Šçº¿ | å…¨åŠŸèƒ½éªŒè¯é€šè¿‡ |

---

## 2. Phase 1: åŸºç¡€æ¨¡å‹ä¸æ•°æ®åº“ï¼ˆç¬¬1-2å‘¨ï¼‰

### 2.1 ç›®æ ‡

å»ºç«‹å•†åº—ç³»ç»Ÿçš„æ•°æ®åŸºç¡€ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¡¨ã€æšä¸¾å®šä¹‰ã€é¢†åŸŸæ¨¡å‹å’Œé…ç½®åŠ è½½æœºåˆ¶ã€‚

### 2.2 ä»»åŠ¡æ¸…å•

#### Task 1.1: åˆ›å»ºæšä¸¾ç±»å‹ï¼ˆ4å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Shop/Models/ShopEnums.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

public enum ShopType { Regular, Reputation, Limited, SpecialExchange, BlackMarket, Seasonal }
public enum ShopItemType { Consumable, Equipment, Material, Recipe, CurrencyPack, SpecialItem, EquipmentGenerator }
public enum RefreshType { None, Daily, Weekly, Interval, Manual }
public enum CurrencyType { Gold, Gems, Reputation, Honor, Justice, Valor, Conquest, EventToken, Custom = 99 }
```

#### Task 1.2: åˆ›å»ºé¢†åŸŸæ¨¡å‹ï¼ˆ8å°æ—¶ï¼‰

åˆ›å»ºä»¥ä¸‹æ¨¡å‹æ–‡ä»¶ï¼š
- `ShopDefinition.cs`
- `ShopItemDefinition.cs`
- `ShopInstance.cs`
- `PurchaseRecord.cs`
- `CurrencyBalance.cs`
- `PurchaseCounter.cs`

ï¼ˆè¯¦è§ä¸Šç¯‡ç¬¬9èŠ‚çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼‰

#### Task 1.3: æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆ8å°æ—¶ï¼‰

**åˆ›å»ºè¿ç§»æ–‡ä»¶**: `AddShopSystemTables`

```sql
-- å•†åº—å®šä¹‰è¡¨
CREATE TABLE shop_definitions (
    Id TEXT PRIMARY KEY,
    Name TEXT NOT NULL,
    Description TEXT,
    Icon TEXT DEFAULT 'ğŸª',
    Type INTEGER NOT NULL,
    AccessPolicyJson TEXT,
    RefreshPolicyJson TEXT,
    ItemIdsJson TEXT,
    RandomPoolJson TEXT,
    TagsJson TEXT,
    SortOrder INTEGER DEFAULT 0,
    IsEnabled BOOLEAN DEFAULT TRUE,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL
);

-- å•†å“å®šä¹‰è¡¨
CREATE TABLE shop_item_definitions (
    Id TEXT PRIMARY KEY,
    Type INTEGER NOT NULL,
    TargetItemId TEXT NOT NULL,
    DisplayName TEXT,
    Description TEXT,
    Icon TEXT DEFAULT 'ğŸ“¦',
    Rarity INTEGER NOT NULL,
    PriceJson TEXT NOT NULL,
    LimitJson TEXT NOT NULL,
    UnlockJson TEXT NOT NULL,
    BarterJson TEXT,
    EquipmentGeneratorJson TEXT,
    IsFeatured BOOLEAN DEFAULT FALSE,
    SortOrder INTEGER DEFAULT 0,
    IsEnabled BOOLEAN DEFAULT TRUE,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL
);

-- å•†åº—å®ä¾‹è¡¨
CREATE TABLE shop_instances (
    Id TEXT PRIMARY KEY,
    DefinitionId TEXT NOT NULL,
    CurrentItemIdsJson TEXT,
    InventoryJson TEXT NOT NULL,
    LastAccessTime TEXT,
    AccessCount INTEGER DEFAULT 0,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL,
    FOREIGN KEY (DefinitionId) REFERENCES shop_definitions(Id)
);

-- è´§å¸ä½™é¢è¡¨
CREATE TABLE currency_balances (
    CharacterId TEXT NOT NULL,
    Type INTEGER NOT NULL,
    CustomCurrencyId TEXT,
    Balance INTEGER NOT NULL DEFAULT 0,
    UpdatedAt TEXT NOT NULL,
    PRIMARY KEY (CharacterId, Type, CustomCurrencyId),
    FOREIGN KEY (CharacterId) REFERENCES characters(Id)
);

-- è´­ä¹°è®°å½•è¡¨
CREATE TABLE purchase_records (
    Id TEXT PRIMARY KEY,
    CharacterId TEXT NOT NULL,
    ShopId TEXT NOT NULL,
    ItemId TEXT NOT NULL,
    Quantity INTEGER NOT NULL,
    PaidCurrenciesJson TEXT NOT NULL,
    PaidItemsJson TEXT,
    ActualUnitPriceJson TEXT NOT NULL,
    DiscountPercent INTEGER DEFAULT 0,
    PurchaseTime TEXT NOT NULL,
    IdempotencyKey TEXT NOT NULL UNIQUE,
    FOREIGN KEY (CharacterId) REFERENCES characters(Id)
);

-- è´­ä¹°è®¡æ•°å™¨è¡¨
CREATE TABLE purchase_counters (
    CharacterId TEXT NOT NULL,
    ShopItemId TEXT NOT NULL,
    LifetimePurchaseCount INTEGER DEFAULT 0,
    DailyPurchaseCount INTEGER DEFAULT 0,
    DailyResetTime TEXT NOT NULL,
    WeeklyPurchaseCount INTEGER DEFAULT 0,
    WeeklyResetTime TEXT NOT NULL,
    LastPurchaseTime TEXT,
    PRIMARY KEY (CharacterId, ShopItemId),
    FOREIGN KEY (CharacterId) REFERENCES characters(Id)
);

-- ç´¢å¼•
CREATE INDEX IX_ShopInstances_DefinitionId ON shop_instances(DefinitionId);
CREATE INDEX IX_CurrencyBalances_CharacterId ON currency_balances(CharacterId);
CREATE INDEX IX_PurchaseRecords_CharacterId ON purchase_records(CharacterId);
CREATE INDEX IX_PurchaseRecords_PurchaseTime ON purchase_records(PurchaseTime);
CREATE INDEX IX_PurchaseCounters_CharacterId ON purchase_counters(CharacterId);
```

#### Task 1.4: Entity Frameworké…ç½®ï¼ˆ4å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Persistence/Configurations/ShopConfiguration.cs`

```csharp
public class ShopDefinitionConfiguration : IEntityTypeConfiguration<ShopDefinition>
{
    public void Configure(EntityTypeBuilder<ShopDefinition> builder)
    {
        builder.ToTable("shop_definitions");
        builder.HasKey(x => x.Id);
        builder.Property(x => x.AccessPolicy).HasColumnName("AccessPolicyJson")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
                v => JsonSerializer.Deserialize<ShopAccessPolicy>(v, (JsonSerializerOptions?)null)!);
        // ... å…¶ä»–JSONè½¬æ¢é…ç½®
    }
}
```

### 2.3 éªŒæ”¶æ ‡å‡†

- [ ] æ‰€æœ‰æšä¸¾å®šä¹‰å®Œæˆ
- [ ] æ‰€æœ‰é¢†åŸŸæ¨¡å‹åˆ›å»ºå®Œæˆ
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸæ‰§è¡Œ
- [ ] EF Coreé…ç½®æ­£ç¡®
- [ ] å¯é€šè¿‡DbContextæŸ¥è¯¢å•†åº—æ•°æ®

---

## 3. Phase 2: è´§å¸ç³»ç»Ÿä¸æ¡ä»¶å¼•æ“ï¼ˆç¬¬3-4å‘¨ï¼‰

### 3.1 ç›®æ ‡

å®ç°è´§å¸ç®¡ç†ç³»ç»Ÿå’Œæ¡ä»¶è§£é”å¼•æ“ï¼Œä¸ºå•†åº—ç³»ç»Ÿæä¾›åŸºç¡€æœåŠ¡ã€‚

### 3.2 ä»»åŠ¡æ¸…å•

#### Task 2.1: è´§å¸ç®¡ç†æœåŠ¡ï¼ˆ12å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/CurrencyService.cs`

```csharp
public interface ICurrencyService
{
    Task<CurrencyBalance> GetBalanceAsync(Guid characterId, CurrencyType type, string? customId = null);
    Task<Dictionary<CurrencyType, long>> GetAllBalancesAsync(Guid characterId);
    Task<bool> HasSufficientCurrencyAsync(Guid characterId, Dictionary<CurrencyType, long> required);
    Task<bool> DeductCurrencyAsync(Guid characterId, Dictionary<CurrencyType, long> amounts);
    Task AddCurrencyAsync(Guid characterId, Dictionary<CurrencyType, long> amounts);
    Task<bool> TransferCurrencyAsync(Guid fromCharId, Guid toCharId, CurrencyType type, long amount);
}

public class CurrencyService : ICurrencyService
{
    private readonly GameDbContext _context;
    
    public async Task<bool> DeductCurrencyAsync(Guid characterId, Dictionary<CurrencyType, long> amounts)
    {
        // åœ¨äº‹åŠ¡ä¸­æ‰£é™¤å¤šç§è´§å¸
        using var transaction = await _context.Database.BeginTransactionAsync();
        try
        {
            foreach (var (type, amount) in amounts)
            {
                if (type == CurrencyType.Gold)
                {
                    var character = await _context.Characters.FindAsync(characterId);
                    if (character == null || character.Gold < amount)
                        return false;
                    character.Gold -= amount;
                }
                else
                {
                    var balance = await GetBalanceAsync(characterId, type);
                    if (balance.Balance < amount)
                        return false;
                    balance.Balance -= amount;
                    balance.UpdatedAt = DateTime.UtcNow;
                }
            }
            await _context.SaveChangesAsync();
            await transaction.CommitAsync();
            return true;
        }
        catch
        {
            await transaction.RollbackAsync();
            throw;
        }
    }
    
    // ... å…¶ä»–æ–¹æ³•å®ç°
}
```

#### Task 2.2: æ¡ä»¶è§£é”å¼•æ“ï¼ˆ16å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/ConditionEvaluator.cs`

```csharp
public interface IConditionEvaluator
{
    Task<bool> EvaluateAsync(string? conditionExpr, Guid characterId);
    Task<Dictionary<string, bool>> EvaluateBatchAsync(List<string> exprs, Guid characterId);
    Task<string> GetFailureReasonAsync(string conditionExpr, Guid characterId);
}

public class ConditionEvaluator : IConditionEvaluator
{
    private readonly GameDbContext _context;
    private readonly IMemoryCache _cache;
    
    public async Task<bool> EvaluateAsync(string? conditionExpr, Guid characterId)
    {
        if (string.IsNullOrWhiteSpace(conditionExpr))
            return true;
        
        // ç¼“å­˜é”®
        var cacheKey = $"condition:{characterId}:{conditionExpr}";
        if (_cache.TryGetValue<bool>(cacheKey, out var cached))
            return cached;
        
        var character = await _context.Characters.FindAsync(characterId);
        if (character == null)
            return false;
        
        var result = await EvaluateExpression(conditionExpr, character);
        
        // ç¼“å­˜ç»“æœï¼ˆ5åˆ†é’Ÿï¼‰
        _cache.Set(cacheKey, result, TimeSpan.FromMinutes(5));
        
        return result;
    }
    
    private async Task<bool> EvaluateExpression(string expr, Character character)
    {
        // è§£æå¹¶è¯„ä¼°è¡¨è¾¾å¼
        if (expr.StartsWith("level >="))
        {
            var level = int.Parse(expr.Substring(8).Trim());
            return character.Level >= level;
        }
        else if (expr.StartsWith("AND("))
        {
            var subExprs = ParseSubExpressions(expr);
            foreach (var sub in subExprs)
            {
                if (!await EvaluateExpression(sub, character))
                    return false;
            }
            return true;
        }
        else if (expr.StartsWith("OR("))
        {
            var subExprs = ParseSubExpressions(expr);
            foreach (var sub in subExprs)
            {
                if (await EvaluateExpression(sub, character))
                    return true;
            }
            return false;
        }
        // ... å…¶ä»–æ¡ä»¶ç±»å‹
        
        return false;
    }
    
    // ... è¾…åŠ©æ–¹æ³•
}
```

#### Task 2.3: å£°æœ›ç³»ç»Ÿï¼ˆ8å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Reputation/ReputationRecord.cs`

```csharp
public class ReputationRecord
{
    public Guid CharacterId { get; set; }
    public string FactionId { get; set; } = "";
    public int ReputationPoints { get; set; } = 0;
    public ReputationLevel Level { get; set; }
    public DateTime UpdatedAt { get; set; }
}

public enum ReputationLevel
{
    Hated = 0,
    Hostile = 1,
    Unfriendly = 2,
    Neutral = 3,
    Friendly = 4,
    Honored = 5,
    Revered = 6,
    Exalted = 7
}
```

### 2.4 éªŒæ”¶æ ‡å‡†

- [ ] è´§å¸æœåŠ¡å®Œæˆï¼Œå¯å¢å‡è´§å¸
- [ ] æ¡ä»¶è¯„ä¼°å™¨å®Œæˆï¼Œå¯è¯„ä¼°åŸºæœ¬æ¡ä»¶
- [ ] å£°æœ›ç³»ç»Ÿå®Œæˆï¼Œå¯è¿½è¸ªå£°æœ›
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

---

## 4. Phase 3: æ ¸å¿ƒå•†åº—æœåŠ¡ï¼ˆç¬¬5-7å‘¨ï¼‰

### 4.1 ç›®æ ‡

å®ç°å•†åº—çš„åˆ›å»ºã€é…ç½®ã€æŸ¥è¯¢ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### 4.2 ä»»åŠ¡æ¸…å•

#### Task 3.1: å•†åº—æœåŠ¡ï¼ˆ16å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/ShopService.cs`

```csharp
public interface IShopService
{
    Task<ShopInstance?> GetShopAsync(string shopId, Guid characterId);
    Task<List<ShopDefinition>> GetAvailableShopsAsync(Guid characterId);
    Task<ShopItemDefinition?> GetItemAsync(string itemId);
    Task<List<ShopItemDefinition>> GetShopItemsAsync(string shopId, Guid characterId);
    Task<bool> IsShopUnlockedAsync(string shopId, Guid characterId);
    Task<bool> IsItemUnlockedAsync(string itemId, Guid characterId);
}

public class ShopService : IShopService
{
    private readonly GameDbContext _context;
    private readonly IConditionEvaluator _conditionEvaluator;
    private readonly IMemoryCache _cache;
    
    public async Task<ShopInstance?> GetShopAsync(string shopId, Guid characterId)
    {
        // æ£€æŸ¥å•†åº—æ˜¯å¦è§£é”
        if (!await IsShopUnlockedAsync(shopId, characterId))
            return null;
        
        // è·å–æˆ–åˆ›å»ºå•†åº—å®ä¾‹
        var instance = await _context.ShopInstances
            .Include(x => x.Definition)
            .FirstOrDefaultAsync(x => x.DefinitionId == shopId);
        
        if (instance == null)
        {
            var definition = await _context.ShopDefinitions.FindAsync(shopId);
            if (definition == null)
                return null;
            
            instance = new ShopInstance
            {
                DefinitionId = shopId,
                CurrentItemIds = definition.ItemIds,
                Inventory = new ShopInventory
                {
                    ShopId = Guid.NewGuid(),
                    LastRefreshTime = DateTime.UtcNow
                }
            };
            _context.ShopInstances.Add(instance);
            await _context.SaveChangesAsync();
        }
        
        return instance;
    }
    
    public async Task<List<ShopItemDefinition>> GetShopItemsAsync(string shopId, Guid characterId)
    {
        var shop = await GetShopAsync(shopId, characterId);
        if (shop == null)
            return new List<ShopItemDefinition>();
        
        var items = await _context.ShopItemDefinitions
            .Where(x => shop.CurrentItemIds.Contains(x.Id))
            .ToListAsync();
        
        // è¿‡æ»¤å‡ºå·²è§£é”çš„å•†å“ï¼ˆæˆ–ShowWhenLocked=trueçš„å•†å“ï¼‰
        var unlockedItems = new List<ShopItemDefinition>();
        foreach (var item in items)
        {
            var isUnlocked = await IsItemUnlockedAsync(item.Id, characterId);
            if (isUnlocked || item.Unlock.ShowWhenLocked)
            {
                unlockedItems.Add(item);
            }
        }
        
        return unlockedItems.OrderBy(x => x.SortOrder).ToList();
    }
    
    public async Task<bool> IsItemUnlockedAsync(string itemId, Guid characterId)
    {
        var item = await _context.ShopItemDefinitions.FindAsync(itemId);
        if (item == null)
            return false;
        
        // æ£€æŸ¥ç­‰çº§è¦æ±‚
        var character = await _context.Characters.FindAsync(characterId);
        if (character == null || character.Level < item.Unlock.MinLevel)
            return false;
        
        // æ£€æŸ¥æ¡ä»¶è¡¨è¾¾å¼
        if (!string.IsNullOrWhiteSpace(item.Unlock.UnlockCondition))
        {
            return await _conditionEvaluator.EvaluateAsync(item.Unlock.UnlockCondition, characterId);
        }
        
        return true;
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

#### Task 3.2: é…ç½®åŠ è½½å™¨ï¼ˆ8å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Shop/ShopConfigLoader.cs`

```csharp
public class ShopConfigLoader
{
    public async Task LoadFromJsonAsync(string filePath, GameDbContext context)
    {
        var json = await File.ReadAllTextAsync(filePath);
        var config = JsonSerializer.Deserialize<ShopSystemConfig>(json);
        
        // åŠ è½½å•†åº—å®šä¹‰
        foreach (var shopDef in config.Shops)
        {
            var existing = await context.ShopDefinitions.FindAsync(shopDef.Id);
            if (existing == null)
            {
                context.ShopDefinitions.Add(shopDef);
            }
            else
            {
                // æ›´æ–°ç°æœ‰å®šä¹‰
                context.Entry(existing).CurrentValues.SetValues(shopDef);
            }
        }
        
        // åŠ è½½å•†å“å®šä¹‰
        foreach (var itemDef in config.Items)
        {
            var existing = await context.ShopItemDefinitions.FindAsync(itemDef.Id);
            if (existing == null)
            {
                context.ShopItemDefinitions.Add(itemDef);
            }
        }
        
        await context.SaveChangesAsync();
    }
}
```

#### Task 3.3: ç§å­æ•°æ®ï¼ˆ4å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Persistence/ShopSeedData.cs`

```csharp
public static class ShopSeedData
{
    public static void SeedShopData(this ModelBuilder modelBuilder)
    {
        // ç¤ºä¾‹ï¼šæ‚è´§å•†äºº
        modelBuilder.Entity<ShopDefinition>().HasData(new ShopDefinition
        {
            Id = "shop_general_merchant",
            Name = "æ‚è´§å•†äºº",
            Description = "å‡ºå”®åŸºç¡€æ¶ˆè€—å“å’Œææ–™",
            Icon = "ğŸª",
            Type = ShopType.Regular,
            AccessPolicy = new ShopAccessPolicy(),
            RefreshPolicy = new ShopRefreshPolicy { Type = RefreshType.None },
            ItemIds = new List<string> { "item_health_potion_small", "item_mana_potion_small" },
            IsEnabled = true
        });
        
        // ç¤ºä¾‹å•†å“ï¼šå°å‹ç”Ÿå‘½è¯æ°´
        modelBuilder.Entity<ShopItemDefinition>().HasData(new ShopItemDefinition
        {
            Id = "item_health_potion_small",
            Type = ShopItemType.Consumable,
            TargetItemId = "consumable_health_potion_small",
            DisplayName = "å°å‹ç”Ÿå‘½è¯æ°´",
            Icon = "ğŸ§ª",
            Rarity = Rarity.Common,
            Price = new ShopItemPrice
            {
                BasePrices = new Dictionary<CurrencyType, long> { { CurrencyType.Gold, 10 } }
            },
            Limit = new ShopItemLimit { MaxPurchasePerTransaction = 20 },
            Unlock = new ShopItemUnlock { MinLevel = 1 },
            IsEnabled = true
        });
    }
}
```

### 4.3 éªŒæ”¶æ ‡å‡†

- [ ] å•†åº—æœåŠ¡å®Œæˆï¼Œå¯æŸ¥è¯¢å•†åº—
- [ ] å¯è·å–å•†åº—å•†å“åˆ—è¡¨
- [ ] è§£é”æ¡ä»¶æ­£ç¡®ç”Ÿæ•ˆ
- [ ] é…ç½®åŠ è½½å™¨å¯ç”¨
- [ ] ç§å­æ•°æ®åŠ è½½æˆåŠŸ

---

## 5. Phase 4: è´­ä¹°æµç¨‹å®ç°ï¼ˆç¬¬8-10å‘¨ï¼‰

### 5.1 ç›®æ ‡

å®ç°å®Œæ•´çš„è´­ä¹°æµç¨‹ï¼ŒåŒ…æ‹¬ä»·æ ¼è®¡ç®—ã€è´§å¸æ‰£é™¤ã€ç‰©å“å‘æ”¾ã€äº‹åŠ¡ç®¡ç†ã€‚

### 5.2 ä»»åŠ¡æ¸…å•

#### Task 4.1: è´­ä¹°æœåŠ¡ï¼ˆ20å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/PurchaseService.cs`

```csharp
public interface IPurchaseService
{
    Task<PurchaseResult> PurchaseItemAsync(PurchaseRequest request);
    Task<PriceInfo> GetPriceInfoAsync(string itemId, Guid characterId, int quantity);
    Task<bool> CanPurchaseAsync(string itemId, Guid characterId, int quantity);
}

public class PurchaseService : IPurchaseService
{
    private readonly GameDbContext _context;
    private readonly ICurrencyService _currencyService;
    private readonly IConditionEvaluator _conditionEvaluator;
    private readonly IPriceCalculator _priceCalculator;
    
    public async Task<PurchaseResult> PurchaseItemAsync(PurchaseRequest request)
    {
        using var transaction = await _context.Database.BeginTransactionAsync();
        try
        {
            // 1. éªŒè¯å•†å“å’Œå•†åº—
            var item = await _context.ShopItemDefinitions.FindAsync(request.ItemId);
            if (item == null || !item.IsEnabled)
                return PurchaseResult.Failure("å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶");
            
            // 2. æ£€æŸ¥è§£é”æ¡ä»¶
            var isUnlocked = await _conditionEvaluator.EvaluateAsync(
                item.Unlock.UnlockCondition, request.CharacterId);
            if (!isUnlocked)
                return PurchaseResult.Failure("å•†å“æœªè§£é”");
            
            // 3. æ£€æŸ¥è´­ä¹°é™åˆ¶
            var counter = await GetOrCreatePurchaseCounterAsync(request.CharacterId, request.ItemId);
            if (!CheckPurchaseLimit(item.Limit, counter, request.Quantity))
                return PurchaseResult.Failure("è¶…è¿‡è´­ä¹°é™åˆ¶");
            
            // 4. è®¡ç®—ä»·æ ¼
            var priceInfo = await _priceCalculator.CalculatePriceAsync(
                item, request.CharacterId, request.Quantity, counter.LifetimePurchaseCount);
            
            // 5. éªŒè¯è´§å¸å……è¶³
            if (!await _currencyService.HasSufficientCurrencyAsync(
                request.CharacterId, priceInfo.TotalCurrencies))
                return PurchaseResult.Failure("è´§å¸ä¸è¶³");
            
            // 6. æ‰£é™¤è´§å¸
            if (!await _currencyService.DeductCurrencyAsync(
                request.CharacterId, priceInfo.TotalCurrencies))
                return PurchaseResult.Failure("è´§å¸æ‰£é™¤å¤±è´¥");
            
            // 7. å‘æ”¾ç‰©å“
            await GrantItemAsync(request.CharacterId, item.TargetItemId, request.Quantity);
            
            // 8. æ›´æ–°è´­ä¹°è®¡æ•°
            await UpdatePurchaseCounterAsync(counter, request.Quantity);
            
            // 9. è®°å½•è´­ä¹°å†å²
            var record = new PurchaseRecord
            {
                CharacterId = request.CharacterId,
                ShopId = request.ShopId,
                ItemId = request.ItemId,
                Quantity = request.Quantity,
                PaidCurrencies = priceInfo.TotalCurrencies,
                ActualUnitPrice = priceInfo.UnitPrices,
                DiscountPercent = priceInfo.DiscountPercent,
                IdempotencyKey = $"{request.CharacterId}:{request.ItemId}:{DateTime.UtcNow.Ticks}"
            };
            _context.PurchaseRecords.Add(record);
            
            await _context.SaveChangesAsync();
            await transaction.CommitAsync();
            
            return PurchaseResult.Success(record);
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            return PurchaseResult.Failure($"è´­ä¹°å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task GrantItemAsync(Guid characterId, string itemId, int quantity)
    {
        var existing = await _context.InventoryItems
            .FirstOrDefaultAsync(x => x.CharacterId == characterId && x.ItemId == itemId);
        
        if (existing != null)
        {
            existing.Quantity += quantity;
            existing.UpdatedAt = DateTime.UtcNow;
        }
        else
        {
            _context.InventoryItems.Add(new InventoryItem
            {
                CharacterId = characterId,
                ItemId = itemId,
                Quantity = quantity
            });
        }
    }
    
    // ... å…¶ä»–è¾…åŠ©æ–¹æ³•
}
```

#### Task 4.2: ä»·æ ¼è®¡ç®—å™¨ï¼ˆ12å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/PriceCalculator.cs`

```csharp
public interface IPriceCalculator
{
    Task<PriceInfo> CalculatePriceAsync(ShopItemDefinition item, Guid characterId, 
        int quantity, int previousPurchaseCount);
}

public class PriceCalculator : IPriceCalculator
{
    private readonly IConditionEvaluator _conditionEvaluator;
    
    public async Task<PriceInfo> CalculatePriceAsync(ShopItemDefinition item, 
        Guid characterId, int quantity, int previousPurchaseCount)
    {
        var unitPrices = new Dictionary<CurrencyType, long>();
        
        // 1. åŸºç¡€ä»·æ ¼
        foreach (var (currencyType, basePrice) in item.Price.BasePrices)
        {
            var price = basePrice;
            
            // 2. ä»·æ ¼é€’å¢ï¼ˆæ ¹æ®è´­ä¹°æ¬¡æ•°ï¼‰
            if (item.Price.PriceIncreasePercent > 0)
            {
                var multiplier = 1.0m + (item.Price.PriceIncreasePercent / 100.0m * previousPurchaseCount);
                multiplier = Math.Min(multiplier, item.Price.MaxPriceMultiplier);
                price = (long)(price * multiplier);
            }
            
            unitPrices[currencyType] = price;
        }
        
        // 3. æ£€æŸ¥æŠ˜æ‰£
        int discountPercent = 0;
        if (item.Price.DiscountPercent > 0)
        {
            if (string.IsNullOrWhiteSpace(item.Price.DiscountCondition) ||
                await _conditionEvaluator.EvaluateAsync(item.Price.DiscountCondition, characterId))
            {
                discountPercent = item.Price.DiscountPercent;
            }
        }
        
        // 4. åº”ç”¨æŠ˜æ‰£
        if (discountPercent > 0)
        {
            var discountMult = (100 - discountPercent) / 100.0m;
            foreach (var key in unitPrices.Keys.ToList())
            {
                unitPrices[key] = (long)(unitPrices[key] * discountMult);
            }
        }
        
        // 5. è®¡ç®—æ€»ä»·
        var totalPrices = new Dictionary<CurrencyType, long>();
        foreach (var (currencyType, unitPrice) in unitPrices)
        {
            totalPrices[currencyType] = unitPrice * quantity;
        }
        
        return new PriceInfo
        {
            UnitPrices = unitPrices,
            TotalCurrencies = totalPrices,
            DiscountPercent = discountPercent
        };
    }
}
```

### 5.3 éªŒæ”¶æ ‡å‡†

- [ ] è´­ä¹°æµç¨‹å®Œæ•´å®ç°
- [ ] ä»·æ ¼è®¡ç®—æ­£ç¡®ï¼ˆå«æŠ˜æ‰£å’Œé€’å¢ï¼‰
- [ ] äº‹åŠ¡å®‰å…¨ä¿è¯
- [ ] è´­ä¹°é™åˆ¶æ­£ç¡®ç”Ÿæ•ˆ
- [ ] è´­ä¹°è®°å½•æ­£ç¡®ä¿å­˜
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡

---

## 6. Phase 5: åˆ·æ–°æœºåˆ¶ä¸å‰ç«¯ï¼ˆç¬¬11-12å‘¨ï¼‰

### 6.1 ç›®æ ‡

å®ç°å•†åº—åˆ·æ–°æœºåˆ¶å’Œå‰ç«¯UIé›†æˆã€‚

### 6.2 ä»»åŠ¡æ¸…å•

#### Task 5.1: åˆ·æ–°æœåŠ¡ï¼ˆ12å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/RefreshService.cs`

```csharp
public interface IRefreshService
{
    Task RefreshShopAsync(string shopId);
    Task RefreshAllShopsAsync();
    Task<bool> CanManualRefreshAsync(string shopId, Guid characterId);
    Task<ManualRefreshResult> ManualRefreshAsync(string shopId, Guid characterId);
}

public class RefreshService : IRefreshService
{
    private readonly GameDbContext _context;
    private readonly ICurrencyService _currencyService;
    
    public async Task RefreshShopAsync(string shopId)
    {
        var instance = await _context.ShopInstances
            .Include(x => x.Definition)
            .FirstOrDefaultAsync(x => x.DefinitionId == shopId);
        
        if (instance == null || instance.Definition == null)
            return;
        
        var policy = instance.Definition.RefreshPolicy;
        if (policy.Type == RefreshType.None)
            return;
        
        // ä»éšæœºæ± æŠ½å–å•†å“
        if (instance.Definition.RandomPool != null)
        {
            instance.CurrentItemIds = await DrawRandomItemsAsync(instance.Definition.RandomPool);
        }
        
        // é‡ç½®åº“å­˜
        instance.Inventory.Stock.Clear();
        instance.Inventory.LastRefreshTime = DateTime.UtcNow;
        instance.Inventory.RefreshVersion++;
        
        // è®¡ç®—ä¸‹æ¬¡åˆ·æ–°æ—¶é—´
        if (policy.Type == RefreshType.Daily)
        {
            instance.Inventory.NextRefreshTime = DateTime.UtcNow.Date.AddDays(1);
        }
        else if (policy.Type == RefreshType.Weekly)
        {
            var daysUntilMonday = ((int)DayOfWeek.Monday - (int)DateTime.UtcNow.DayOfWeek + 7) % 7;
            instance.Inventory.NextRefreshTime = DateTime.UtcNow.Date.AddDays(daysUntilMonday);
        }
        
        await _context.SaveChangesAsync();
    }
    
    private async Task<List<string>> DrawRandomItemsAsync(RandomItemPool pool)
    {
        var random = new Random();
        var totalWeight = pool.Items.Values.Sum();
        var selectedItems = new List<string>();
        
        for (int i = 0; i < pool.ItemCountPerRefresh; i++)
        {
            var roll = random.Next(totalWeight);
            var cumulative = 0;
            
            foreach (var (itemId, weight) in pool.Items)
            {
                cumulative += weight;
                if (roll < cumulative)
                {
                    if (pool.AllowDuplicates || !selectedItems.Contains(itemId))
                    {
                        selectedItems.Add(itemId);
                        break;
                    }
                }
            }
        }
        
        return selectedItems;
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

#### Task 5.2: å®šæ—¶åˆ·æ–°åå°æœåŠ¡ï¼ˆ8å°æ—¶ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/BackgroundServices/ShopRefreshHostedService.cs`

```csharp
public class ShopRefreshHostedService : BackgroundService
{
    private readonly IServiceProvider _serviceProvider;
    private readonly ILogger<ShopRefreshHostedService> _logger;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                using var scope = _serviceProvider.CreateScope();
                var refreshService = scope.ServiceProvider.GetRequiredService<IRefreshService>();
                
                await refreshService.RefreshAllShopsAsync();
                
                // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
                await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error refreshing shops");
                await Task.Delay(TimeSpan.FromMinutes(1), stoppingToken);
            }
        }
    }
}
```

#### Task 5.3: å‰ç«¯UIï¼ˆè¯¦è§ä¸‹ç¯‡ï¼‰

### 6.3 éªŒæ”¶æ ‡å‡†

- [ ] åˆ·æ–°æœåŠ¡å®Œæˆ
- [ ] å®šæ—¶åˆ·æ–°æ­£å¸¸å·¥ä½œ
- [ ] æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½å¯ç”¨
- [ ] éšæœºå•†å“æ± æ­£ç¡®æŠ½å–
- [ ] å‰ç«¯UIå¯ç”¨

---

## 7. Phase 6: æµ‹è¯•ä¼˜åŒ–ä¸ä¸Šçº¿ï¼ˆç¬¬13-14å‘¨ï¼‰

è¯¦è§ä¸‹ç¯‡æ–‡æ¡£ã€‚

---

## 8. æ•°æ®åº“è®¾è®¡è¡¥å……è¯´æ˜

### 8.1 JSONå­—æ®µè¯´æ˜

ä¸ºäº†çµæ´»æ€§ï¼ŒæŸäº›å¤æ‚å¯¹è±¡ä½¿ç”¨JSONå­˜å‚¨ï¼š

- `AccessPolicyJson`: ShopAccessPolicyå¯¹è±¡
- `RefreshPolicyJson`: ShopRefreshPolicyå¯¹è±¡
- `PriceJson`: ShopItemPriceå¯¹è±¡
- `LimitJson`: ShopItemLimitå¯¹è±¡
- `UnlockJson`: ShopItemUnlockå¯¹è±¡

### 8.2 ç´¢å¼•ç­–ç•¥

é‡è¦æŸ¥è¯¢è·¯å¾„ï¼š
1. æŒ‰è§’è‰²IDæŸ¥è¯¢è´§å¸ä½™é¢
2. æŒ‰è§’è‰²IDæŸ¥è¯¢è´­ä¹°è®°å½•
3. æŒ‰å•†åº—IDæŸ¥è¯¢å•†åº—å®ä¾‹
4. æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢è´­ä¹°è®°å½•ï¼ˆç”¨äºç»Ÿè®¡ï¼‰

---

## 9. é›†æˆç°æœ‰ç³»ç»Ÿ

### 9.1 ä¸ç»æµç³»ç»Ÿé›†æˆ

- å¤ç”¨ `InventoryItem` è¡¨å­˜å‚¨è´­ä¹°çš„ç‰©å“
- å¤ç”¨ `EconomyEventRecord` è®°å½•è´­ä¹°äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨ `Character.Gold` ä½œä¸ºä¸»è¦è´§å¸

### 9.2 ä¸è£…å¤‡ç³»ç»Ÿé›†æˆ

- è´­ä¹°è£…å¤‡ç±»å‹å•†å“æ—¶ï¼Œç”Ÿæˆ `GearInstance`
- ä½¿ç”¨ `EquipmentGenerator` é…ç½®éšæœºç”Ÿæˆè£…å¤‡
- é›†æˆè£…å¤‡çš„ç¨€æœ‰åº¦å’Œå“çº§ç³»ç»Ÿ

### 9.3 ä¸æ¡ä»¶ç³»ç»Ÿé›†æˆ

- ç­‰å¾…æ¡ä»¶è§£é”DSLå®ç°åé›†æˆ
- æš‚æ—¶ä½¿ç”¨ç®€åŒ–ç‰ˆæ¡ä»¶è¯„ä¼°
- é¢„ç•™æ¥å£ä»¥ä¾¿åç»­å‡çº§

---

## æ€»ç»“

æœ¬æ–‡æ¡£ï¼ˆä¸­ç¯‡ï¼‰å®Œæˆäº†å•†åº—ç³»ç»Ÿçš„å®æ–½è®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒï¼ŒåŒ…æ‹¬ï¼š

1. âœ… å®Œæ•´çš„Phaseæ‰§è¡Œè®¡åˆ’ï¼ˆPhase 1-6ï¼‰
2. âœ… è¯¦ç»†çš„ä»»åŠ¡æ¸…å•å’Œå·¥æ—¶ä¼°ç®—
3. âœ… æ ¸å¿ƒæœåŠ¡çš„ä»£ç æ¡†æ¶
4. âœ… æ•°æ®åº“è®¾è®¡å’Œè¿ç§»è„šæœ¬
5. âœ… ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆæ–¹æ¡ˆ

### ä¸‹ä¸€æ­¥

è¯·å‚é˜…ï¼š
- **ä¸Šç¯‡**: ç³»ç»Ÿåˆ†æä¸æ¶æ„è®¾è®¡ï¼ˆè®¾è®¡åŸºç¡€ï¼‰
- **ä¸‹ç¯‡**: æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡ï¼ˆè´¨é‡ä¿è¯ã€å‰ç«¯UIã€æ€§èƒ½ä¼˜åŒ–ï¼‰

---

**æ–‡æ¡£çŠ¶æ€**: å·²å®Œæˆ  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸  
**ç‰ˆæœ¬**: 1.0
