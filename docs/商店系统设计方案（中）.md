# 商店系统设计方案（中篇）- 详细设计与实现规范

**项目**: BlazorIdle  
**文档版本**: 1.0  
**创建日期**: 2025-10-12  
**状态**: 设计阶段  
**负责**: 开发团队

---

## 📋 目录

1. [数据模型详细设计](#数据模型详细设计)
2. [API 接口设计](#api-接口设计)
3. [服务层设计](#服务层设计)
4. [业务逻辑实现](#业务逻辑实现)
5. [数据库设计](#数据库设计)
6. [配置与种子数据](#配置与种子数据)

---

## 数据模型详细设计

### 1.1 领域模型定义

#### 1.1.1 ShopDefinition（商店定义）

**位置**：`BlazorIdle.Server/Domain/Shop/ShopDefinition.cs`

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Server.Domain.Shop;

/// <summary>
/// 商店定义实体
/// </summary>
public class ShopDefinition
{
    /// <summary>
    /// 商店唯一标识
    /// </summary>
    [Key]
    [MaxLength(100)]
    public string Id { get; set; } = "";

    /// <summary>
    /// 商店名称
    /// </summary>
    [Required]
    [MaxLength(200)]
    public string Name { get; set; } = "";

    /// <summary>
    /// 商店类型
    /// </summary>
    [Required]
    public ShopType Type { get; set; } = ShopType.General;

    /// <summary>
    /// 商店图标
    /// </summary>
    [MaxLength(50)]
    public string Icon { get; set; } = "🏪";

    /// <summary>
    /// 商店描述
    /// </summary>
    [MaxLength(1000)]
    public string Description { get; set; } = "";

    /// <summary>
    /// 解锁条件表达式（可选，未来支持 DSL）
    /// 示例: "level>=10" 或 "AND(level>=20, gold>=1000)"
    /// </summary>
    [MaxLength(500)]
    public string? UnlockCondition { get; set; }

    /// <summary>
    /// 是否启用
    /// </summary>
    public bool IsEnabled { get; set; } = true;

    /// <summary>
    /// 排序顺序
    /// </summary>
    public int SortOrder { get; set; } = 0;

    /// <summary>
    /// 创建时间
    /// </summary>
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// 更新时间
    /// </summary>
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation properties
    public ICollection<ShopItem> Items { get; set; } = new List<ShopItem>();
}

/// <summary>
/// 商店类型枚举
/// </summary>
public enum ShopType
{
    /// <summary>
    /// 通用商店（所有玩家可见）
    /// </summary>
    General = 0,

    /// <summary>
    /// 特殊商店（需要解锁）
    /// </summary>
    Special = 1,

    /// <summary>
    /// 限时商店（限定时间开放）
    /// </summary>
    Limited = 2,

    /// <summary>
    /// 个人商店（角色专属）
    /// </summary>
    Personal = 3
}
```

#### 1.1.2 ShopItem（商品定义）

**位置**：`BlazorIdle.Server/Domain/Shop/ShopItem.cs`

```csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.Text.Json;

namespace BlazorIdle.Server.Domain.Shop;

/// <summary>
/// 商品定义实体
/// </summary>
public class ShopItem
{
    /// <summary>
    /// 商品唯一标识
    /// </summary>
    [Key]
    public Guid Id { get; set; } = Guid.NewGuid();

    /// <summary>
    /// 所属商店 ID
    /// </summary>
    [Required]
    [MaxLength(100)]
    public string ShopId { get; set; } = "";

    /// <summary>
    /// 商品类型
    /// </summary>
    [Required]
    public ShopItemType ItemType { get; set; }

    /// <summary>
    /// 物品定义 ID（关联到游戏内物品/装备定义）
    /// 示例: "potion_health_small", "weapon_iron_sword"
    /// </summary>
    [Required]
    [MaxLength(100)]
    public string ItemDefinitionId { get; set; } = "";

    /// <summary>
    /// 显示名称（可覆盖物品定义的名称）
    /// </summary>
    [MaxLength(200)]
    public string? DisplayName { get; set; }

    /// <summary>
    /// 图标（可覆盖物品定义的图标）
    /// </summary>
    [MaxLength(50)]
    public string? Icon { get; set; }

    /// <summary>
    /// 描述（可覆盖物品定义的描述）
    /// </summary>
    [MaxLength(1000)]
    public string? Description { get; set; }

    /// <summary>
    /// 价格信息（JSON 格式）
    /// </summary>
    [Required]
    public string PriceJson { get; set; } = "";

    /// <summary>
    /// 库存限制（-1 表示无限）
    /// </summary>
    public int StockLimit { get; set; } = -1;

    /// <summary>
    /// 当前库存（仅当 StockLimit > 0 时有效）
    /// </summary>
    public int CurrentStock { get; set; } = 0;

    /// <summary>
    /// 购买限制信息（JSON 格式）
    /// </summary>
    public string? PurchaseLimitJson { get; set; }

    /// <summary>
    /// 等级要求
    /// </summary>
    public int RequiredLevel { get; set; } = 1;

    /// <summary>
    /// 解锁条件表达式（可选）
    /// </summary>
    [MaxLength(500)]
    public string? UnlockCondition { get; set; }

    /// <summary>
    /// 是否启用
    /// </summary>
    public bool IsEnabled { get; set; } = true;

    /// <summary>
    /// 排序顺序
    /// </summary>
    public int SortOrder { get; set; } = 0;

    /// <summary>
    /// 创建时间
    /// </summary>
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// 更新时间
    /// </summary>
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation property
    public ShopDefinition Shop { get; set; } = null!;

    // Helper methods
    public Price GetPrice()
    {
        return JsonSerializer.Deserialize<Price>(PriceJson)
            ?? throw new InvalidOperationException($"Invalid price JSON for item {Id}");
    }

    public void SetPrice(Price price)
    {
        PriceJson = JsonSerializer.Serialize(price);
    }

    public PurchaseLimit? GetPurchaseLimit()
    {
        if (string.IsNullOrEmpty(PurchaseLimitJson))
            return null;
        return JsonSerializer.Deserialize<PurchaseLimit>(PurchaseLimitJson);
    }

    public void SetPurchaseLimit(PurchaseLimit? limit)
    {
        PurchaseLimitJson = limit == null ? null : JsonSerializer.Serialize(limit);
    }
}

/// <summary>
/// 商品类型枚举
/// </summary>
public enum ShopItemType
{
    /// <summary>
    /// 消耗品（食物、药剂等）
    /// </summary>
    Consumable = 0,

    /// <summary>
    /// 装备（武器、防具等）
    /// </summary>
    Equipment = 1,

    /// <summary>
    /// 材料（制作材料等）
    /// </summary>
    Material = 2,

    /// <summary>
    /// 货币（特殊货币）
    /// </summary>
    Currency = 3,

    /// <summary>
    /// 特殊物品（任务道具、宠物等）
    /// </summary>
    Special = 4
}
```

#### 1.1.3 Price（价格值对象）

**位置**：`BlazorIdle.Server/Domain/Shop/ValueObjects/Price.cs`

```csharp
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Server.Domain.Shop.ValueObjects;

/// <summary>
/// 价格值对象
/// </summary>
public class Price
{
    /// <summary>
    /// 货币类型
    /// </summary>
    [Required]
    public CurrencyType CurrencyType { get; set; } = CurrencyType.Gold;

    /// <summary>
    /// 金额/数量
    /// </summary>
    [Range(0, int.MaxValue)]
    public int Amount { get; set; }

    /// <summary>
    /// 货币/物品 ID（用于特殊货币和物品兑换）
    /// </summary>
    [MaxLength(100)]
    public string? CurrencyId { get; set; }
}

/// <summary>
/// 货币类型枚举
/// </summary>
public enum CurrencyType
{
    /// <summary>
    /// 金币（主货币）
    /// </summary>
    Gold = 0,

    /// <summary>
    /// 特殊货币（荣誉点、竞技场币等）
    /// </summary>
    SpecialCurrency = 1,

    /// <summary>
    /// 物品（以物易物）
    /// </summary>
    Item = 2
}
```

#### 1.1.4 PurchaseLimit（购买限制值对象）

**位置**：`BlazorIdle.Server/Domain/Shop/ValueObjects/PurchaseLimit.cs`

```csharp
using System;

namespace BlazorIdle.Server.Domain.Shop.ValueObjects;

/// <summary>
/// 购买限制值对象
/// </summary>
public class PurchaseLimit
{
    /// <summary>
    /// 限制类型
    /// </summary>
    public PurchaseLimitType LimitType { get; set; } = PurchaseLimitType.None;

    /// <summary>
    /// 最大购买次数
    /// </summary>
    public int MaxPurchases { get; set; }

    /// <summary>
    /// 重置时间配置（UTC 小时，仅用于 Daily/Weekly）
    /// 示例: 0 表示每天 UTC 00:00 重置
    /// </summary>
    public int ResetHour { get; set; } = 0;
}

/// <summary>
/// 购买限制类型枚举
/// </summary>
public enum PurchaseLimitType
{
    /// <summary>
    /// 无限制
    /// </summary>
    None = 0,

    /// <summary>
    /// 每日限制
    /// </summary>
    Daily = 1,

    /// <summary>
    /// 每周限制（周一重置）
    /// </summary>
    Weekly = 2,

    /// <summary>
    /// 总计限制（永久）
    /// </summary>
    Total = 3
}
```

#### 1.1.5 PurchaseRecord（购买记录）

**位置**：`BlazorIdle.Server/Domain/Shop/PurchaseRecord.cs`

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Server.Domain.Shop;

/// <summary>
/// 购买记录实体
/// </summary>
public class PurchaseRecord
{
    /// <summary>
    /// 记录唯一标识
    /// </summary>
    [Key]
    public Guid Id { get; set; } = Guid.NewGuid();

    /// <summary>
    /// 角色 ID
    /// </summary>
    [Required]
    public Guid CharacterId { get; set; }

    /// <summary>
    /// 商店 ID
    /// </summary>
    [Required]
    [MaxLength(100)]
    public string ShopId { get; set; } = "";

    /// <summary>
    /// 商品 ID
    /// </summary>
    [Required]
    public Guid ShopItemId { get; set; }

    /// <summary>
    /// 物品定义 ID（冗余，便于查询）
    /// </summary>
    [Required]
    [MaxLength(100)]
    public string ItemDefinitionId { get; set; } = "";

    /// <summary>
    /// 购买数量
    /// </summary>
    [Range(1, 999)]
    public int Quantity { get; set; } = 1;

    /// <summary>
    /// 实际支付价格（JSON 格式）
    /// </summary>
    [Required]
    public string PriceJson { get; set; } = "";

    /// <summary>
    /// 购买时间
    /// </summary>
    public DateTime PurchasedAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// 关联的经济事件记录 ID（如果涉及货币扣减）
    /// </summary>
    public Guid? EconomyEventId { get; set; }
}
```

#### 1.1.6 PurchaseCounter（购买计数器）

**位置**：`BlazorIdle.Server/Domain/Shop/PurchaseCounter.cs`

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Server.Domain.Shop;

/// <summary>
/// 购买计数器实体（用于限制检查）
/// </summary>
public class PurchaseCounter
{
    /// <summary>
    /// 复合主键：CharacterId + ShopItemId + PeriodKey
    /// </summary>
    [Key]
    public Guid Id { get; set; } = Guid.NewGuid();

    /// <summary>
    /// 角色 ID
    /// </summary>
    [Required]
    public Guid CharacterId { get; set; }

    /// <summary>
    /// 商品 ID
    /// </summary>
    [Required]
    public Guid ShopItemId { get; set; }

    /// <summary>
    /// 周期键（格式示例：daily_20251012, weekly_202541, total）
    /// </summary>
    [Required]
    [MaxLength(50)]
    public string PeriodKey { get; set; } = "";

    /// <summary>
    /// 当前周期已购买数量
    /// </summary>
    public int PurchaseCount { get; set; } = 0;

    /// <summary>
    /// 上次购买时间
    /// </summary>
    public DateTime LastPurchaseAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// 周期过期时间（用于清理）
    /// </summary>
    public DateTime? ExpiresAt { get; set; }
}
```

### 1.2 DTO 模型定义

#### 1.2.1 ShopDto（商店列表响应）

**位置**：`BlazorIdle.Shared/Dtos/Shop/ShopDto.cs`

```csharp
namespace BlazorIdle.Shared.Dtos.Shop;

/// <summary>
/// 商店 DTO
/// </summary>
public class ShopDto
{
    public string Id { get; set; } = "";
    public string Name { get; set; } = "";
    public string Type { get; set; } = "";
    public string Icon { get; set; } = "";
    public string Description { get; set; } = "";
    public bool IsUnlocked { get; set; }
    public string? UnlockHint { get; set; }
    public int ItemCount { get; set; }
}
```

#### 1.2.2 ShopItemDto（商品详情响应）

**位置**：`BlazorIdle.Shared/Dtos/Shop/ShopItemDto.cs`

```csharp
namespace BlazorIdle.Shared.Dtos.Shop;

/// <summary>
/// 商品 DTO
/// </summary>
public class ShopItemDto
{
    public Guid ItemId { get; set; }
    public string ItemType { get; set; } = "";
    public string ItemDefinitionId { get; set; } = "";
    public string DisplayName { get; set; } = "";
    public string Icon { get; set; } = "";
    public string Description { get; set; } = "";
    public PriceDto Price { get; set; } = new();
    public int StockLimit { get; set; }
    public int CurrentStock { get; set; }
    public PurchaseLimitDto? PurchaseLimit { get; set; }
    public int RequiredLevel { get; set; }
    public bool CanPurchase { get; set; }
    public string? PurchaseBlockReason { get; set; }
    public int PurchasedCount { get; set; }
}

public class PriceDto
{
    public string CurrencyType { get; set; } = "Gold";
    public int Amount { get; set; }
    public string? CurrencyId { get; set; }
    public string DisplayText { get; set; } = "";
}

public class PurchaseLimitDto
{
    public string LimitType { get; set; } = "None";
    public int MaxPurchases { get; set; }
    public int RemainingPurchases { get; set; }
    public DateTime? ResetTime { get; set; }
}
```

#### 1.2.3 PurchaseRequest（购买请求）

**位置**：`BlazorIdle.Shared/Dtos/Shop/PurchaseRequest.cs`

```csharp
using System.ComponentModel.DataAnnotations;

namespace BlazorIdle.Shared.Dtos.Shop;

/// <summary>
/// 购买请求 DTO
/// </summary>
public class PurchaseRequest
{
    /// <summary>
    /// 角色 ID
    /// </summary>
    [Required]
    public Guid CharacterId { get; set; }

    /// <summary>
    /// 商店 ID
    /// </summary>
    [Required]
    public string ShopId { get; set; } = "";

    /// <summary>
    /// 商品 ID
    /// </summary>
    [Required]
    public Guid ItemId { get; set; }

    /// <summary>
    /// 购买数量
    /// </summary>
    [Range(1, 999)]
    public int Quantity { get; set; } = 1;

    /// <summary>
    /// 幂等性键（可选，用于防重复）
    /// </summary>
    public string? IdempotencyKey { get; set; }
}
```

#### 1.2.4 PurchaseResponse（购买响应）

**位置**：`BlazorIdle.Shared/Dtos/Shop/PurchaseResponse.cs`

```csharp
namespace BlazorIdle.Shared.Dtos.Shop;

/// <summary>
/// 购买响应 DTO
/// </summary>
public class PurchaseResponse
{
    public bool Success { get; set; }
    public string? ErrorMessage { get; set; }
    public PurchaseResultDto? Result { get; set; }
}

public class PurchaseResultDto
{
    public Guid PurchaseRecordId { get; set; }
    public int RemainingGold { get; set; }
    public int ItemQuantity { get; set; }
    public DateTime PurchasedAt { get; set; }
}
```

---

## API 接口设计

### 2.1 RESTful API 端点

#### 2.1.1 商店列表

**端点**：`GET /api/shop/list`

**描述**：获取角色可见的商店列表

**请求参数**：
```csharp
public class ListShopsQuery
{
    public Guid CharacterId { get; set; }
    public bool IncludeDisabled { get; set; } = false;
}
```

**响应示例**：
```json
{
  "shops": [
    {
      "id": "general_shop",
      "name": "杂货铺",
      "type": "General",
      "icon": "🏪",
      "description": "出售基础物品和消耗品",
      "isUnlocked": true,
      "unlockHint": null,
      "itemCount": 25
    },
    {
      "id": "weapon_shop",
      "name": "武器店",
      "type": "General",
      "icon": "⚔️",
      "description": "出售各类武器和防具",
      "isUnlocked": false,
      "unlockHint": "达到等级 10 解锁",
      "itemCount": 0
    }
  ]
}
```

#### 2.1.2 商品列表

**端点**：`GET /api/shop/{shopId}/items`

**描述**：获取指定商店的商品列表

**请求参数**：
```csharp
public class ListShopItemsQuery
{
    public string ShopId { get; set; } = "";
    public Guid CharacterId { get; set; }
    public int Page { get; set; } = 1;
    public int PageSize { get; set; } = 50;
}
```

**响应示例**：
```json
{
  "shopId": "general_shop",
  "items": [
    {
      "itemId": "550e8400-e29b-41d4-a716-446655440000",
      "itemType": "Consumable",
      "itemDefinitionId": "potion_health_small",
      "displayName": "小型生命药水",
      "icon": "🧪",
      "description": "恢复 100 点生命值",
      "price": {
        "currencyType": "Gold",
        "amount": 50,
        "displayText": "50 金币"
      },
      "stockLimit": -1,
      "currentStock": 0,
      "purchaseLimit": {
        "limitType": "Daily",
        "maxPurchases": 10,
        "remainingPurchases": 8,
        "resetTime": "2025-10-13T00:00:00Z"
      },
      "requiredLevel": 1,
      "canPurchase": true,
      "purchaseBlockReason": null,
      "purchasedCount": 2
    }
  ],
  "totalCount": 25,
  "page": 1,
  "pageSize": 50
}
```

#### 2.1.3 购买商品

**端点**：`POST /api/shop/purchase`

**描述**：购买商品

**请求体**：
```json
{
  "characterId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "shopId": "general_shop",
  "itemId": "550e8400-e29b-41d4-a716-446655440000",
  "quantity": 5,
  "idempotencyKey": "purchase_20251012_123456"
}
```

**响应示例**：
```json
{
  "success": true,
  "errorMessage": null,
  "result": {
    "purchaseRecordId": "660e8400-e29b-41d4-a716-446655440001",
    "remainingGold": 4750,
    "itemQuantity": 5,
    "purchasedAt": "2025-10-12T14:30:00Z"
  }
}
```

**错误响应示例**：
```json
{
  "success": false,
  "errorMessage": "金币不足，需要 250 金币，当前仅有 200 金币",
  "result": null
}
```

#### 2.1.4 购买历史

**端点**：`GET /api/shop/purchase-history`

**描述**：获取角色的购买历史记录

**请求参数**：
```csharp
public class PurchaseHistoryQuery
{
    public Guid CharacterId { get; set; }
    public string? ShopId { get; set; }  // 可选，筛选特定商店
    public DateTime? StartDate { get; set; }
    public DateTime? EndDate { get; set; }
    public int Page { get; set; } = 1;
    public int PageSize { get; set; } = 20;
}
```

**响应示例**：
```json
{
  "records": [
    {
      "purchaseId": "660e8400-e29b-41d4-a716-446655440001",
      "shopId": "general_shop",
      "shopName": "杂货铺",
      "itemName": "小型生命药水",
      "quantity": 5,
      "price": {
        "currencyType": "Gold",
        "amount": 250
      },
      "purchasedAt": "2025-10-12T14:30:00Z"
    }
  ],
  "totalCount": 42,
  "page": 1,
  "pageSize": 20
}
```

### 2.2 Controller 实现

**位置**：`BlazorIdle.Server/Api/ShopController.cs`

```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using BlazorIdle.Server.Application.Shop;
using BlazorIdle.Shared.Dtos.Shop;

namespace BlazorIdle.Server.Api;

[ApiController]
[Route("api/[controller]")]
[Authorize]
public class ShopController : ControllerBase
{
    private readonly IShopService _shopService;
    private readonly ILogger<ShopController> _logger;

    public ShopController(IShopService shopService, ILogger<ShopController> logger)
    {
        _shopService = shopService;
        _logger = logger;
    }

    /// <summary>
    /// 获取商店列表
    /// </summary>
    [HttpGet("list")]
    public async Task<ActionResult<ListShopsResponse>> ListShops(
        [FromQuery] Guid characterId,
        [FromQuery] bool includeDisabled = false,
        CancellationToken ct = default)
    {
        try
        {
            var result = await _shopService.ListShopsAsync(characterId, includeDisabled, ct);
            return Ok(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to list shops for character {CharacterId}", characterId);
            return StatusCode(500, new { error = "获取商店列表失败" });
        }
    }

    /// <summary>
    /// 获取商店商品列表
    /// </summary>
    [HttpGet("{shopId}/items")]
    public async Task<ActionResult<ListShopItemsResponse>> ListShopItems(
        string shopId,
        [FromQuery] Guid characterId,
        [FromQuery] int page = 1,
        [FromQuery] int pageSize = 50,
        CancellationToken ct = default)
    {
        try
        {
            var result = await _shopService.ListShopItemsAsync(
                shopId, characterId, page, pageSize, ct);
            return Ok(result);
        }
        catch (KeyNotFoundException)
        {
            return NotFound(new { error = $"商店 {shopId} 不存在" });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to list items for shop {ShopId}", shopId);
            return StatusCode(500, new { error = "获取商品列表失败" });
        }
    }

    /// <summary>
    /// 购买商品
    /// </summary>
    [HttpPost("purchase")]
    public async Task<ActionResult<PurchaseResponse>> Purchase(
        [FromBody] PurchaseRequest request,
        CancellationToken ct = default)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);

        try
        {
            var result = await _shopService.PurchaseItemAsync(request, ct);
            return Ok(result);
        }
        catch (InvalidOperationException ex)
        {
            return BadRequest(new PurchaseResponse
            {
                Success = false,
                ErrorMessage = ex.Message
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to purchase item {ItemId} for character {CharacterId}",
                request.ItemId, request.CharacterId);
            return StatusCode(500, new PurchaseResponse
            {
                Success = false,
                ErrorMessage = "购买失败，请稍后重试"
            });
        }
    }

    /// <summary>
    /// 获取购买历史
    /// </summary>
    [HttpGet("purchase-history")]
    public async Task<ActionResult<PurchaseHistoryResponse>> GetPurchaseHistory(
        [FromQuery] Guid characterId,
        [FromQuery] string? shopId = null,
        [FromQuery] DateTime? startDate = null,
        [FromQuery] DateTime? endDate = null,
        [FromQuery] int page = 1,
        [FromQuery] int pageSize = 20,
        CancellationToken ct = default)
    {
        try
        {
            var result = await _shopService.GetPurchaseHistoryAsync(
                characterId, shopId, startDate, endDate, page, pageSize, ct);
            return Ok(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get purchase history for character {CharacterId}",
                characterId);
            return StatusCode(500, new { error = "获取购买历史失败" });
        }
    }
}
```

---

## 服务层设计

### 3.1 服务接口

**位置**：`BlazorIdle.Server/Application/Abstractions/IShopService.cs`

```csharp
using BlazorIdle.Shared.Dtos.Shop;

namespace BlazorIdle.Server.Application.Abstractions;

/// <summary>
/// 商店服务接口
/// </summary>
public interface IShopService
{
    /// <summary>
    /// 获取商店列表
    /// </summary>
    Task<ListShopsResponse> ListShopsAsync(
        Guid characterId,
        bool includeDisabled,
        CancellationToken ct = default);

    /// <summary>
    /// 获取商店商品列表
    /// </summary>
    Task<ListShopItemsResponse> ListShopItemsAsync(
        string shopId,
        Guid characterId,
        int page,
        int pageSize,
        CancellationToken ct = default);

    /// <summary>
    /// 购买商品
    /// </summary>
    Task<PurchaseResponse> PurchaseItemAsync(
        PurchaseRequest request,
        CancellationToken ct = default);

    /// <summary>
    /// 获取购买历史
    /// </summary>
    Task<PurchaseHistoryResponse> GetPurchaseHistoryAsync(
        Guid characterId,
        string? shopId,
        DateTime? startDate,
        DateTime? endDate,
        int page,
        int pageSize,
        CancellationToken ct = default);
}
```

### 3.2 服务实现骨架

**位置**：`BlazorIdle.Server/Application/Shop/ShopService.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using BlazorIdle.Server.Application.Abstractions;
using BlazorIdle.Server.Infrastructure.Persistence;
using BlazorIdle.Shared.Dtos.Shop;

namespace BlazorIdle.Server.Application.Shop;

/// <summary>
/// 商店服务实现
/// </summary>
public class ShopService : IShopService
{
    private readonly GameDbContext _context;
    private readonly IPurchaseValidator _validator;
    private readonly ILogger<ShopService> _logger;

    public ShopService(
        GameDbContext context,
        IPurchaseValidator validator,
        ILogger<ShopService> logger)
    {
        _context = context;
        _validator = validator;
        _logger = logger;
    }

    public async Task<ListShopsResponse> ListShopsAsync(
        Guid characterId,
        bool includeDisabled,
        CancellationToken ct = default)
    {
        // 实现见下一节
        throw new NotImplementedException();
    }

    public async Task<ListShopItemsResponse> ListShopItemsAsync(
        string shopId,
        Guid characterId,
        int page,
        int pageSize,
        CancellationToken ct = default)
    {
        // 实现见下一节
        throw new NotImplementedException();
    }

    public async Task<PurchaseResponse> PurchaseItemAsync(
        PurchaseRequest request,
        CancellationToken ct = default)
    {
        // 实现见下一节
        throw new NotImplementedException();
    }

    public async Task<PurchaseHistoryResponse> GetPurchaseHistoryAsync(
        Guid characterId,
        string? shopId,
        DateTime? startDate,
        DateTime? endDate,
        int page,
        int pageSize,
        CancellationToken ct = default)
    {
        // 实现见下一节
        throw new NotImplementedException();
    }
}
```

### 3.3 验证器接口

**位置**：`BlazorIdle.Server/Application/Abstractions/IPurchaseValidator.cs`

```csharp
using BlazorIdle.Server.Domain.Characters;
using BlazorIdle.Server.Domain.Shop;

namespace BlazorIdle.Server.Application.Abstractions;

/// <summary>
/// 购买验证器接口
/// </summary>
public interface IPurchaseValidator
{
    /// <summary>
    /// 验证购买请求
    /// </summary>
    Task<ValidationResult> ValidatePurchaseAsync(
        Character character,
        ShopItem item,
        int quantity,
        CancellationToken ct = default);
}

/// <summary>
/// 验证结果
/// </summary>
public class ValidationResult
{
    public bool IsValid { get; set; }
    public string? ErrorMessage { get; set; }
    public List<string> Errors { get; set; } = new();

    public static ValidationResult Success() => new() { IsValid = true };
    public static ValidationResult Failure(string error) =>
        new() { IsValid = false, ErrorMessage = error, Errors = new() { error } };
}
```

---

## 业务逻辑实现

### 4.1 购买流程实现

**位置**：`BlazorIdle.Server/Application/Shop/ShopService.cs` (PurchaseItemAsync 方法)

```csharp
public async Task<PurchaseResponse> PurchaseItemAsync(
    PurchaseRequest request,
    CancellationToken ct = default)
{
    using var transaction = await _context.Database.BeginTransactionAsync(ct);
    
    try
    {
        // 1. 加载角色
        var character = await _context.Characters
            .FirstOrDefaultAsync(c => c.Id == request.CharacterId, ct);
        
        if (character == null)
            return CreateErrorResponse("角色不存在");

        // 2. 加载商品
        var item = await _context.Set<ShopItem>()
            .Include(i => i.Shop)
            .FirstOrDefaultAsync(i => i.Id == request.ItemId && i.ShopId == request.ShopId, ct);
        
        if (item == null)
            return CreateErrorResponse("商品不存在");

        // 3. 验证购买
        var validationResult = await _validator.ValidatePurchaseAsync(
            character, item, request.Quantity, ct);
        
        if (!validationResult.IsValid)
            return CreateErrorResponse(validationResult.ErrorMessage!);

        // 4. 扣除货币/物品
        var price = item.GetPrice();
        await DeductCurrencyAsync(character, price, request.Quantity, ct);

        // 5. 添加物品到背包
        await AddItemToInventoryAsync(
            character.Id, item.ItemDefinitionId, request.Quantity, ct);

        // 6. 记录购买
        var purchaseRecord = new Domain.Shop.PurchaseRecord
        {
            CharacterId = character.Id,
            ShopId = item.ShopId,
            ShopItemId = item.Id,
            ItemDefinitionId = item.ItemDefinitionId,
            Quantity = request.Quantity,
            PriceJson = item.PriceJson,
            PurchasedAt = DateTime.UtcNow
        };
        _context.Set<Domain.Shop.PurchaseRecord>().Add(purchaseRecord);

        // 7. 更新购买计数
        await UpdatePurchaseCounterAsync(character.Id, item, request.Quantity, ct);

        // 8. 更新库存（如果有限制）
        if (item.StockLimit > 0)
        {
            item.CurrentStock -= request.Quantity;
        }

        await _context.SaveChangesAsync(ct);
        await transaction.CommitAsync(ct);

        _logger.LogInformation(
            "Character {CharacterId} purchased {Quantity}x {ItemId} from shop {ShopId}",
            character.Id, request.Quantity, item.ItemDefinitionId, item.ShopId);

        return new PurchaseResponse
        {
            Success = true,
            Result = new PurchaseResultDto
            {
                PurchaseRecordId = purchaseRecord.Id,
                RemainingGold = character.Gold,
                ItemQuantity = request.Quantity,
                PurchasedAt = purchaseRecord.PurchasedAt
            }
        };
    }
    catch (Exception ex)
    {
        await transaction.RollbackAsync(ct);
        _logger.LogError(ex, "Failed to purchase item {ItemId}", request.ItemId);
        return CreateErrorResponse("购买失败，请稍后重试");
    }
}

private PurchaseResponse CreateErrorResponse(string message)
{
    return new PurchaseResponse
    {
        Success = false,
        ErrorMessage = message
    };
}
```

### 4.2 验证器实现

**位置**：`BlazorIdle.Server/Application/Shop/PurchaseValidator.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using BlazorIdle.Server.Application.Abstractions;
using BlazorIdle.Server.Domain.Characters;
using BlazorIdle.Server.Domain.Shop;
using BlazorIdle.Server.Domain.Shop.ValueObjects;
using BlazorIdle.Server.Infrastructure.Persistence;

namespace BlazorIdle.Server.Application.Shop;

/// <summary>
/// 购买验证器实现
/// </summary>
public class PurchaseValidator : IPurchaseValidator
{
    private readonly GameDbContext _context;

    public PurchaseValidator(GameDbContext context)
    {
        _context = context;
    }

    public async Task<ValidationResult> ValidatePurchaseAsync(
        Character character,
        ShopItem item,
        int quantity,
        CancellationToken ct = default)
    {
        // 1. 检查商店和商品是否启用
        if (!item.Shop.IsEnabled)
            return ValidationResult.Failure("商店未开放");
        
        if (!item.IsEnabled)
            return ValidationResult.Failure("商品已下架");

        // 2. 检查等级要求
        if (character.Level < item.RequiredLevel)
            return ValidationResult.Failure(
                $"等级不足，需要等级 {item.RequiredLevel}");

        // 3. 检查货币
        var price = item.GetPrice();
        var currencyCheckResult = await CheckCurrencyAsync(
            character, price, quantity, ct);
        if (!currencyCheckResult.IsValid)
            return currencyCheckResult;

        // 4. 检查库存限制
        if (item.StockLimit > 0 && item.CurrentStock < quantity)
            return ValidationResult.Failure(
                $"库存不足，当前库存：{item.CurrentStock}");

        // 5. 检查购买限制
        var limit = item.GetPurchaseLimit();
        if (limit != null && limit.LimitType != PurchaseLimitType.None)
        {
            var limitCheckResult = await CheckPurchaseLimitAsync(
                character.Id, item, limit, quantity, ct);
            if (!limitCheckResult.IsValid)
                return limitCheckResult;
        }

        // 6. 检查背包空间（简化版本，假设总能容纳）
        // 未来可以扩展为检查背包容量上限

        return ValidationResult.Success();
    }

    private async Task<ValidationResult> CheckCurrencyAsync(
        Character character,
        Price price,
        int quantity,
        CancellationToken ct)
    {
        switch (price.CurrencyType)
        {
            case CurrencyType.Gold:
                var totalCost = price.Amount * quantity;
                if (character.Gold < totalCost)
                    return ValidationResult.Failure(
                        $"金币不足，需要 {totalCost} 金币，当前仅有 {character.Gold} 金币");
                break;

            case CurrencyType.Item:
                // 检查物品数量
                var item = await _context.Set<InventoryItem>()
                    .FirstOrDefaultAsync(
                        i => i.CharacterId == character.Id 
                            && i.ItemId == price.CurrencyId,
                        ct);
                
                var requiredQuantity = price.Amount * quantity;
                if (item == null || item.Quantity < requiredQuantity)
                    return ValidationResult.Failure(
                        $"物品 {price.CurrencyId} 不足，需要 {requiredQuantity}");
                break;

            case CurrencyType.SpecialCurrency:
                // 未来扩展：检查特殊货币
                return ValidationResult.Failure("特殊货币系统尚未实现");

            default:
                return ValidationResult.Failure("未知的货币类型");
        }

        return ValidationResult.Success();
    }

    private async Task<ValidationResult> CheckPurchaseLimitAsync(
        Guid characterId,
        ShopItem item,
        PurchaseLimit limit,
        int quantity,
        CancellationToken ct)
    {
        var periodKey = GetPeriodKey(limit.LimitType);
        
        var counter = await _context.Set<PurchaseCounter>()
            .FirstOrDefaultAsync(
                c => c.CharacterId == characterId
                    && c.ShopItemId == item.Id
                    && c.PeriodKey == periodKey,
                ct);

        var currentCount = counter?.PurchaseCount ?? 0;
        var remaining = limit.MaxPurchases - currentCount;

        if (remaining < quantity)
        {
            var resetInfo = limit.LimitType switch
            {
                PurchaseLimitType.Daily => "每日",
                PurchaseLimitType.Weekly => "每周",
                PurchaseLimitType.Total => "总计",
                _ => ""
            };
            return ValidationResult.Failure(
                $"购买次数已达到{resetInfo}上限，剩余可购买次数：{remaining}");
        }

        return ValidationResult.Success();
    }

    private string GetPeriodKey(PurchaseLimitType limitType)
    {
        var now = DateTime.UtcNow;
        return limitType switch
        {
            PurchaseLimitType.Daily => $"daily_{now:yyyyMMdd}",
            PurchaseLimitType.Weekly => $"weekly_{now:yyyyMM}_{GetWeekOfYear(now)}",
            PurchaseLimitType.Total => "total",
            _ => "none"
        };
    }

    private int GetWeekOfYear(DateTime date)
    {
        var firstDayOfYear = new DateTime(date.Year, 1, 1);
        var dayOfYear = (date - firstDayOfYear).Days;
        return dayOfYear / 7 + 1;
    }
}
```

---

## 数据库设计

### 5.1 数据库表结构

#### 5.1.1 shop_definitions 表

```sql
CREATE TABLE shop_definitions (
    Id TEXT PRIMARY KEY,
    Name TEXT NOT NULL,
    Type INTEGER NOT NULL,
    Icon TEXT NOT NULL DEFAULT '🏪',
    Description TEXT NOT NULL DEFAULT '',
    UnlockCondition TEXT,
    IsEnabled INTEGER NOT NULL DEFAULT 1,
    SortOrder INTEGER NOT NULL DEFAULT 0,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL
);

CREATE INDEX IX_ShopDefinitions_Type ON shop_definitions (Type);
CREATE INDEX IX_ShopDefinitions_IsEnabled ON shop_definitions (IsEnabled);
```

#### 5.1.2 shop_items 表

```sql
CREATE TABLE shop_items (
    Id TEXT PRIMARY KEY,
    ShopId TEXT NOT NULL,
    ItemType INTEGER NOT NULL,
    ItemDefinitionId TEXT NOT NULL,
    DisplayName TEXT,
    Icon TEXT,
    Description TEXT,
    PriceJson TEXT NOT NULL,
    StockLimit INTEGER NOT NULL DEFAULT -1,
    CurrentStock INTEGER NOT NULL DEFAULT 0,
    PurchaseLimitJson TEXT,
    RequiredLevel INTEGER NOT NULL DEFAULT 1,
    UnlockCondition TEXT,
    IsEnabled INTEGER NOT NULL DEFAULT 1,
    SortOrder INTEGER NOT NULL DEFAULT 0,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL,
    FOREIGN KEY (ShopId) REFERENCES shop_definitions(Id) ON DELETE CASCADE
);

CREATE INDEX IX_ShopItems_ShopId ON shop_items (ShopId);
CREATE INDEX IX_ShopItems_ItemType ON shop_items (ItemType);
CREATE INDEX IX_ShopItems_IsEnabled ON shop_items (IsEnabled);
```

#### 5.1.3 purchase_records 表

```sql
CREATE TABLE purchase_records (
    Id TEXT PRIMARY KEY,
    CharacterId TEXT NOT NULL,
    ShopId TEXT NOT NULL,
    ShopItemId TEXT NOT NULL,
    ItemDefinitionId TEXT NOT NULL,
    Quantity INTEGER NOT NULL,
    PriceJson TEXT NOT NULL,
    PurchasedAt TEXT NOT NULL,
    EconomyEventId TEXT,
    FOREIGN KEY (CharacterId) REFERENCES Characters(Id) ON DELETE CASCADE
);

CREATE INDEX IX_PurchaseRecords_CharacterId ON purchase_records (CharacterId);
CREATE INDEX IX_PurchaseRecords_ShopId ON purchase_records (ShopId);
CREATE INDEX IX_PurchaseRecords_PurchasedAt ON purchase_records (PurchasedAt DESC);
```

#### 5.1.4 purchase_counters 表

```sql
CREATE TABLE purchase_counters (
    Id TEXT PRIMARY KEY,
    CharacterId TEXT NOT NULL,
    ShopItemId TEXT NOT NULL,
    PeriodKey TEXT NOT NULL,
    PurchaseCount INTEGER NOT NULL DEFAULT 0,
    LastPurchaseAt TEXT NOT NULL,
    ExpiresAt TEXT,
    UNIQUE(CharacterId, ShopItemId, PeriodKey),
    FOREIGN KEY (CharacterId) REFERENCES Characters(Id) ON DELETE CASCADE,
    FOREIGN KEY (ShopItemId) REFERENCES shop_items(Id) ON DELETE CASCADE
);

CREATE INDEX IX_PurchaseCounters_CharacterId ON purchase_counters (CharacterId);
CREATE INDEX IX_PurchaseCounters_PeriodKey ON purchase_counters (PeriodKey);
CREATE INDEX IX_PurchaseCounters_ExpiresAt ON purchase_counters (ExpiresAt)
    WHERE ExpiresAt IS NOT NULL;
```

### 5.2 EF Core 配置

**位置**：`BlazorIdle.Server/Infrastructure/Persistence/Configurations/ShopConfiguration.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using BlazorIdle.Server.Domain.Shop;

namespace BlazorIdle.Server.Infrastructure.Persistence.Configurations;

public class ShopDefinitionConfiguration : IEntityTypeConfiguration<ShopDefinition>
{
    public void Configure(EntityTypeBuilder<ShopDefinition> builder)
    {
        builder.ToTable("shop_definitions");
        
        builder.HasKey(s => s.Id);
        
        builder.Property(s => s.Name).IsRequired().HasMaxLength(200);
        builder.Property(s => s.Type).IsRequired();
        builder.Property(s => s.Icon).HasMaxLength(50);
        builder.Property(s => s.Description).HasMaxLength(1000);
        builder.Property(s => s.UnlockCondition).HasMaxLength(500);
        
        builder.HasMany(s => s.Items)
            .WithOne(i => i.Shop)
            .HasForeignKey(i => i.ShopId)
            .OnDelete(DeleteBehavior.Cascade);
    }
}

public class ShopItemConfiguration : IEntityTypeConfiguration<ShopItem>
{
    public void Configure(EntityTypeBuilder<ShopItem> builder)
    {
        builder.ToTable("shop_items");
        
        builder.HasKey(i => i.Id);
        
        builder.Property(i => i.ShopId).IsRequired().HasMaxLength(100);
        builder.Property(i => i.ItemType).IsRequired();
        builder.Property(i => i.ItemDefinitionId).IsRequired().HasMaxLength(100);
        builder.Property(i => i.DisplayName).HasMaxLength(200);
        builder.Property(i => i.Icon).HasMaxLength(50);
        builder.Property(i => i.Description).HasMaxLength(1000);
        builder.Property(i => i.PriceJson).IsRequired();
        builder.Property(i => i.UnlockCondition).HasMaxLength(500);
    }
}

public class PurchaseRecordConfiguration : IEntityTypeConfiguration<PurchaseRecord>
{
    public void Configure(EntityTypeBuilder<PurchaseRecord> builder)
    {
        builder.ToTable("purchase_records");
        
        builder.HasKey(r => r.Id);
        
        builder.Property(r => r.CharacterId).IsRequired();
        builder.Property(r => r.ShopId).IsRequired().HasMaxLength(100);
        builder.Property(r => r.ShopItemId).IsRequired();
        builder.Property(r => r.ItemDefinitionId).IsRequired().HasMaxLength(100);
        builder.Property(r => r.Quantity).IsRequired();
        builder.Property(r => r.PriceJson).IsRequired();
    }
}

public class PurchaseCounterConfiguration : IEntityTypeConfiguration<PurchaseCounter>
{
    public void Configure(EntityTypeBuilder<PurchaseCounter> builder)
    {
        builder.ToTable("purchase_counters");
        
        builder.HasKey(c => c.Id);
        
        builder.HasIndex(c => new { c.CharacterId, c.ShopItemId, c.PeriodKey })
            .IsUnique();
    }
}
```

---

## 配置与种子数据

### 6.1 初始商店数据

**位置**：`BlazorIdle.Server/Infrastructure/Persistence/ShopSeedData.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using BlazorIdle.Server.Domain.Shop;
using BlazorIdle.Server.Domain.Shop.ValueObjects;
using System.Text.Json;

namespace BlazorIdle.Server.Infrastructure.Persistence;

/// <summary>
/// 商店系统种子数据
/// </summary>
public static class ShopSeedData
{
    public static void SeedShops(this ModelBuilder modelBuilder)
    {
        var now = new DateTime(2025, 10, 12, 0, 0, 0, DateTimeKind.Utc);

        // 杂货铺
        modelBuilder.Entity<ShopDefinition>().HasData(
            new ShopDefinition
            {
                Id = "general_shop",
                Name = "杂货铺",
                Type = ShopType.General,
                Icon = "🏪",
                Description = "出售基础消耗品和材料",
                IsEnabled = true,
                SortOrder = 1,
                CreatedAt = now,
                UpdatedAt = now
            }
        );

        // 武器店
        modelBuilder.Entity<ShopDefinition>().HasData(
            new ShopDefinition
            {
                Id = "weapon_shop",
                Name = "武器店",
                Type = ShopType.General,
                Icon = "⚔️",
                Description = "出售各类武器和防具",
                UnlockCondition = "level>=10",
                IsEnabled = true,
                SortOrder = 2,
                CreatedAt = now,
                UpdatedAt = now
            }
        );

        // 炼金术士
        modelBuilder.Entity<ShopDefinition>().HasData(
            new ShopDefinition
            {
                Id = "alchemist_shop",
                Name = "炼金术士",
                Type = ShopType.Special,
                Icon = "🧙",
                Description = "出售高级药剂和魔法物品",
                UnlockCondition = "level>=20",
                IsEnabled = true,
                SortOrder = 3,
                CreatedAt = now,
                UpdatedAt = now
            }
        );
    }

    public static void SeedShopItems(this ModelBuilder modelBuilder)
    {
        var now = new DateTime(2025, 10, 12, 0, 0, 0, DateTimeKind.Utc);

        // 杂货铺商品
        SeedGeneralShopItems(modelBuilder, now);
    }

    private static void SeedGeneralShopItems(ModelBuilder modelBuilder, DateTime now)
    {
        // 小型生命药水
        modelBuilder.Entity<ShopItem>().HasData(
            new
            {
                Id = Guid.Parse("550e8400-e29b-41d4-a716-446655440001"),
                ShopId = "general_shop",
                ItemType = ShopItemType.Consumable,
                ItemDefinitionId = "potion_health_small",
                DisplayName = "小型生命药水",
                Icon = "🧪",
                Description = "恢复 100 点生命值",
                PriceJson = JsonSerializer.Serialize(new Price
                {
                    CurrencyType = CurrencyType.Gold,
                    Amount = 50
                }),
                StockLimit = -1,
                CurrentStock = 0,
                PurchaseLimitJson = JsonSerializer.Serialize(new PurchaseLimit
                {
                    LimitType = PurchaseLimitType.Daily,
                    MaxPurchases = 10
                }),
                RequiredLevel = 1,
                IsEnabled = true,
                SortOrder = 1,
                CreatedAt = now,
                UpdatedAt = now
            }
        );

        // 面包
        modelBuilder.Entity<ShopItem>().HasData(
            new
            {
                Id = Guid.Parse("550e8400-e29b-41d4-a716-446655440002"),
                ShopId = "general_shop",
                ItemType = ShopItemType.Consumable,
                ItemDefinitionId = "food_bread",
                DisplayName = "面包",
                Icon = "🍞",
                Description = "恢复 50 点生命值",
                PriceJson = JsonSerializer.Serialize(new Price
                {
                    CurrencyType = CurrencyType.Gold,
                    Amount = 10
                }),
                StockLimit = -1,
                CurrentStock = 0,
                PurchaseLimitJson = (string?)null,
                RequiredLevel = 1,
                IsEnabled = true,
                SortOrder = 2,
                CreatedAt = now,
                UpdatedAt = now
            }
        );
    }
}
```

### 6.2 DbContext 集成

**位置**：`BlazorIdle.Server/Infrastructure/Persistence/GameDbContext.cs`（新增部分）

```csharp
// 在 GameDbContext 类中添加
public DbSet<ShopDefinition> ShopDefinitions => Set<ShopDefinition>();
public DbSet<ShopItem> ShopItems => Set<ShopItem>();
public DbSet<PurchaseRecord> PurchaseRecords => Set<PurchaseRecord>();
public DbSet<PurchaseCounter> PurchaseCounters => Set<PurchaseCounter>();

protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);
    
    // ... 其他配置 ...
    
    // 商店系统配置
    modelBuilder.ApplyConfiguration(new ShopDefinitionConfiguration());
    modelBuilder.ApplyConfiguration(new ShopItemConfiguration());
    modelBuilder.ApplyConfiguration(new PurchaseRecordConfiguration());
    modelBuilder.ApplyConfiguration(new PurchaseCounterConfiguration());
    
    // 种子数据
    modelBuilder.SeedShops();
    modelBuilder.SeedShopItems();
}
```

---

## 下一步

本文档（中篇）完成了详细设计与实现规范。接下来：

- **下篇**将制定阶段性实施方案、测试策略、验收标准和交付清单

---

**文档状态**：✅ 中篇完成  
**下一文档**：商店系统设计方案（下篇）- 实施方案与交付  
**预计完成时间**：与上、下篇同时交付
