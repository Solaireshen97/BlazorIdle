# 商店系统设计方案 - 交付文档

**项目**: BlazorIdle 商店系统  
**文档版本**: 1.0  
**创建日期**: 2025-10-12  
**状态**: ✅ 设计阶段完成  
**负责**: 开发团队

---

## 📦 交付概览

本交付文档是 BlazorIdle 商店系统设计方案的总纲，包含完整的系统分析、详细设计和实施方案。

### 文档结构

商店系统设计方案分为**三篇独立文档**加**一份交付总纲**（本文档）：

```
商店系统设计方案（完整版）
├── 📄 商店系统设计方案（上）.md - 系统分析与总体架构
├── 📄 商店系统设计方案（中）.md - 详细设计与实现规范
├── 📄 商店系统设计方案（下）.md - 实施方案与交付清单
└── 📄 商店系统交付文档.md     - 交付总纲（本文档）
```

---

## 📋 执行摘要

### 项目目标

为 BlazorIdle 游戏设计并实施一个**全面、可扩展的商店系统**，实现以下核心目标：

1. **支持多种商品类型**：消耗品、装备、材料、特殊物品
2. **支持多种交易方式**：金币交易、特殊货币交易、物品兑换
3. **支持购买限制机制**：日限制、周限制、总限制
4. **为条件解锁系统预留接口**：支持未来的 DSL 条件引擎
5. **维持现有代码风格**：遵循项目既有的架构模式和命名规范

### 核心价值

| 价值维度 | 说明 |
|---------|------|
| **经济闭环完善** | 为游戏经济系统提供重要的货币消耗渠道，平衡通货膨胀 |
| **内容引导** | 通过商店解锁引导玩家探索游戏内容，提升进程感 |
| **玩法深度** | 支持限时商品、购买限制等机制，增加策略性和可玩性 |
| **可扩展性** | 为未来条件解锁、声望商店、拍卖行等功能做好准备 |

### 实施周期与工作量

| 阶段 | 周期 | 工作日 | 状态 |
|------|------|--------|------|
| Phase 1: 基础框架 | Week 1-2 | 10-12 | 📋 待实施 |
| Phase 2: 核心功能 | Week 3-4 | 10-12 | 📋 待实施 |
| Phase 3: 高级功能 | Week 5-6 | 8-10 | 📋 待实施 |
| Phase 4: 前端集成 | Week 7 | 5-7 | 📋 可选 |
| Phase 5: 条件适配 | Week 8+ | 按需 | 📋 可选 |

**总计**：约 **35-45 工作日**（单人全职）

---

## 📚 文档导航

### 上篇：系统分析与总体架构

**文件位置**：`docs/商店系统设计方案（上）.md`

**主要内容**：

1. **现状分析**
   - 已有系统回顾（经济系统、库存系统、装备系统）
   - 系统设计原则回顾
   - 缺失功能识别

2. **设计目标**
   - 功能目标（核心功能 + 扩展功能）
   - 非功能目标（性能、可靠性、可扩展性）
   - 成功标准

3. **系统架构设计**
   - 分层架构（Presentation → Application → Domain → Infrastructure）
   - 模块依赖关系
   - 核心流程设计（购买流程、查询流程）

4. **核心概念模型**
   - 商店（Shop）
   - 商品（ShopItem）
   - 价格（Price）
   - 购买限制（PurchaseLimit）
   - 购买记录（PurchaseRecord）

5. **技术选型与原则**
   - SOLID 原则
   - DDD 原则
   - 事务管理原则
   - 安全考虑

**关键亮点**：
- 完整的现状分析，识别系统缺失
- 清晰的领域模型设计
- 详细的业务规则定义
- 安全和防刷措施

---

### 中篇：详细设计与实现规范

**文件位置**：`docs/商店系统设计方案（中）.md`

**主要内容**：

1. **数据模型详细设计**
   - 领域模型定义（C# 代码）
   - DTO 模型定义（请求/响应）
   - 辅助方法和扩展

2. **API 接口设计**
   - RESTful 端点设计
   - 请求/响应示例
   - Controller 实现代码

3. **服务层设计**
   - 服务接口定义（`IShopService`, `IPurchaseValidator`）
   - 服务实现骨架
   - 验证器实现

4. **业务逻辑实现**
   - 购买流程完整实现（含事务管理）
   - 验证器详细实现（6 类验证规则）
   - 辅助方法实现

5. **数据库设计**
   - 4 张表结构（shop_definitions, shop_items, purchase_records, purchase_counters）
   - 索引策略
   - EF Core 配置

6. **配置与种子数据**
   - 初始商店数据（3 个商店）
   - 初始商品数据（示例）
   - DbContext 集成

**关键亮点**：
- 完整的代码实现（可直接使用）
- 详细的数据库设计
- 丰富的种子数据示例
- 清晰的验证逻辑

---

### 下篇：实施方案与交付清单

**文件位置**：`docs/商店系统设计方案（下）.md`

**主要内容**：

1. **阶段性实施方案**
   - Phase 1: 基础框架（领域模型、数据库迁移、服务接口）
   - Phase 2: 核心功能（购买流程、验证逻辑）
   - Phase 3: 高级功能（购买历史、物品兑换、库存管理）
   - Phase 4: 前端集成（UI 组件）
   - Phase 5: 条件解锁适配

2. **测试策略**
   - 单元测试（领域模型、验证器、服务层）
   - 集成测试（完整购买流程）
   - 性能测试（并发购买、查询性能）
   - 测试覆盖率目标（80%+）

3. **性能优化**
   - 数据库优化（索引策略、查询优化）
   - 缓存策略（商店定义缓存、商品列表缓存）
   - 并发控制（乐观锁）

4. **监控与运维**
   - 日志记录（关键日志点）
   - 指标收集（购买总数、成功率、响应时间）
   - 健康检查

5. **风险管理**
   - 技术风险（数据库迁移、并发超卖、性能问题）
   - 业务风险（经济失衡、玩家刷金）
   - 应急预案

6. **交付清单**
   - 代码交付（约 40 个文件）
   - 文档交付（设计文档、API 文档、用户手册）
   - 数据库交付（迁移脚本、种子数据）
   - 测试交付（测试报告、测试用例）

**关键亮点**：
- 详细的实施路线图
- 完善的测试策略
- 实用的性能优化建议
- 全面的交付清单

---

## 🎯 核心功能概览

### 功能矩阵

| 功能分类 | 功能点 | 优先级 | Phase | 状态 |
|---------|--------|--------|-------|------|
| **商店管理** | 商店定义和配置 | 🔴 高 | Phase 1 | 待实施 |
| **商店管理** | 商店解锁条件 | 🟡 中 | Phase 5 | 预留接口 |
| **商品管理** | 商品定义和配置 | 🔴 高 | Phase 1 | 待实施 |
| **商品管理** | 商品分类和排序 | 🔴 高 | Phase 1 | 待实施 |
| **商品管理** | 商品解锁条件 | 🟡 中 | Phase 5 | 预留接口 |
| **交易系统** | 金币购买 | 🔴 高 | Phase 2 | 待实施 |
| **交易系统** | 物品兑换 | 🟡 中 | Phase 3 | 待实施 |
| **交易系统** | 特殊货币购买 | 🟢 低 | 未来 | 预留接口 |
| **限制机制** | 购买数量限制 | 🔴 高 | Phase 2 | 待实施 |
| **限制机制** | 每日购买限制 | 🔴 高 | Phase 2 | 待实施 |
| **限制机制** | 每周购买限制 | 🔴 高 | Phase 2 | 待实施 |
| **限制机制** | 总计购买限制 | 🔴 高 | Phase 2 | 待实施 |
| **限制机制** | 库存限制 | 🟡 中 | Phase 3 | 待实施 |
| **历史记录** | 购买历史查询 | 🟡 中 | Phase 3 | 待实施 |
| **历史记录** | 经济事件关联 | 🟡 中 | Phase 3 | 待实施 |

### API 端点概览

| 端点 | 方法 | 描述 | Phase | 状态 |
|------|------|------|-------|------|
| `/api/shop/list` | GET | 获取商店列表 | Phase 2 | 待实施 |
| `/api/shop/{id}/items` | GET | 获取商品列表 | Phase 2 | 待实施 |
| `/api/shop/purchase` | POST | 购买商品 | Phase 2 | 待实施 |
| `/api/shop/purchase-history` | GET | 获取购买历史 | Phase 3 | 待实施 |

---

## 🏗️ 架构亮点

### 分层架构

```
┌─────────────────────────────────┐
│     Presentation Layer          │  API Controllers
│     (ShopController)            │
└────────────┬────────────────────┘
             │
┌────────────▼────────────────────┐
│     Application Layer           │  Business Logic
│     (ShopService, Validators)   │
└────────────┬────────────────────┘
             │
┌────────────▼────────────────────┐
│     Domain Layer                │  Domain Models
│     (ShopDefinition, ShopItem)  │
└────────────┬────────────────────┘
             │
┌────────────▼────────────────────┐
│     Infrastructure Layer        │  Database
│     (GameDbContext, EF Core)    │
└─────────────────────────────────┘
```

### 关键设计模式

1. **仓储模式**：通过 EF Core DbContext 访问数据
2. **服务层模式**：业务逻辑封装在服务层
3. **验证器模式**：独立的购买验证器
4. **值对象模式**：Price、PurchaseLimit
5. **DTO 模式**：请求/响应数据传输对象

### 事务管理

```csharp
// 购买流程使用数据库事务保证原子性
using var transaction = await _context.Database.BeginTransactionAsync();
try
{
    // 1. 验证
    // 2. 扣除货币/物品
    // 3. 添加物品到背包
    // 4. 记录购买
    // 5. 更新计数器
    await _context.SaveChangesAsync();
    await transaction.CommitAsync();
}
catch
{
    await transaction.RollbackAsync();
    throw;
}
```

---

## 📊 数据模型概览

### 核心实体

```
ShopDefinition (商店定义)
    ├── Id: string (PK)
    ├── Name: string
    ├── Type: ShopType
    ├── Icon: string
    ├── Description: string
    ├── UnlockCondition: string?
    ├── IsEnabled: bool
    └── Items: ICollection<ShopItem>

ShopItem (商品定义)
    ├── Id: Guid (PK)
    ├── ShopId: string (FK)
    ├── ItemType: ShopItemType
    ├── ItemDefinitionId: string
    ├── DisplayName: string?
    ├── Icon: string?
    ├── Description: string?
    ├── PriceJson: string
    ├── StockLimit: int
    ├── CurrentStock: int
    ├── PurchaseLimitJson: string?
    ├── RequiredLevel: int
    ├── UnlockCondition: string?
    └── IsEnabled: bool

PurchaseRecord (购买记录)
    ├── Id: Guid (PK)
    ├── CharacterId: Guid
    ├── ShopId: string
    ├── ShopItemId: Guid
    ├── ItemDefinitionId: string
    ├── Quantity: int
    ├── PriceJson: string
    ├── PurchasedAt: DateTime
    └── EconomyEventId: Guid?

PurchaseCounter (购买计数器)
    ├── Id: Guid (PK)
    ├── CharacterId: Guid
    ├── ShopItemId: Guid
    ├── PeriodKey: string
    ├── PurchaseCount: int
    ├── LastPurchaseAt: DateTime
    └── ExpiresAt: DateTime?
```

### 值对象

```csharp
// Price (价格)
{
  "currencyType": "Gold",      // Gold | SpecialCurrency | Item
  "amount": 100,
  "currencyId": null            // 用于特殊货币和物品
}

// PurchaseLimit (购买限制)
{
  "limitType": "Daily",         // None | Daily | Weekly | Total
  "maxPurchases": 10,
  "resetHour": 0                // UTC 小时
}
```

---

## 🧪 测试策略

### 测试覆盖率目标

| 测试类型 | 目标覆盖率 | 测试数量（估算） |
|---------|-----------|---------------|
| 单元测试 | 80%+ | 45 |
| 集成测试 | 100% | 15 |
| 性能测试 | 100% | 5 |

### 关键测试场景

#### 单元测试

- ✅ 价格序列化/反序列化
- ✅ 购买限制计算
- ✅ 等级验证
- ✅ 货币验证（金币、物品）
- ✅ 购买限制检查（Daily/Weekly/Total）

#### 集成测试

- ✅ 完整购买流程（金币交易）
- ✅ 完整购买流程（物品兑换）
- ✅ 购买限制生效
- ✅ 库存限制生效
- ✅ 事务回滚正确

#### 性能测试

- ✅ 商店列表查询性能（< 100ms）
- ✅ 商品列表查询性能（< 100ms）
- ✅ 购买操作性能（< 200ms）
- ✅ 并发购买不超卖
- ✅ 查询 1000 商品性能

---

## 🔒 安全设计

### 防护措施

| 威胁 | 防护措施 | 实现位置 |
|------|---------|---------|
| 重复购买 | 幂等性键 | ShopService |
| 并发超卖 | 乐观锁（RowVersion） | ShopItem |
| 金币刷取 | 购买限制 + 异常检测 | PurchaseValidator |
| SQL 注入 | EF Core 参数化查询 | 自动 |
| 未授权访问 | API 认证（[Authorize]） | ShopController |
| 速率限制 | API 限流 | 中间件 |

### 验证规则

购买前的 **6 类验证**（按顺序执行）：

1. **商店可用性检查**（IsEnabled、UnlockCondition）
2. **商品可用性检查**（存在性、库存）
3. **角色资格检查**（等级、解锁条件）
4. **货币检查**（金币/物品是否充足）
5. **购买限制检查**（Daily/Weekly/Total）
6. **并发检查**（库存限制商品）

---

## 📈 性能优化

### 数据库优化

**索引策略**：
- `IX_ShopItems_ShopId` - 商品查询
- `IX_ShopItems_ShopId_IsEnabled_SortOrder` - 复合索引
- `IX_PurchaseRecords_CharacterId` - 购买历史查询
- `IX_PurchaseCounters_CharacterId_ShopItemId_PeriodKey` - 限制检查

**查询优化**：
- 使用 `AsNoTracking()` 进行只读查询
- 使用 `Include()` 预加载关联数据
- 分页查询避免大数据集

### 缓存策略

| 数据类型 | 缓存时长 | 说明 |
|---------|---------|------|
| 商店列表 | 5 分钟 | 商店定义变化不频繁 |
| 商品列表 | 2 分钟 | 商品信息可能变化（库存） |
| 购买状态 | 不缓存 | 实时性要求高 |

---

## 🚀 后续扩展规划

### 短期扩展（Phase 6-7）

- **特殊货币系统**：实现多种特殊货币（荣誉点、竞技场币）
- **限时商店**：定时开放商店、商品轮换
- **批量购买优惠**：批量购买价格折扣

### 中期扩展（Phase 8-10）

- **声望商店**：与声望系统集成
- **动态定价**：根据供需调整价格
- **回购系统**：玩家可回购误卖物品

### 长期扩展（Phase 11+）

- **拍卖行**：玩家间交易、拍卖机制
- **商人 NPC**：移动商人、随机商品刷新

---

## 📦 交付物清单

### 代码交付

- **新增文件**：约 40 个
  - 后端代码：20 个
  - 共享 DTO：8 个
  - 测试代码：10 个
  - 其他：2 个

- **修改文件**：2 个
  - `GameDbContext.cs`（添加 DbSet）
  - `DependencyInjection.cs`（注册服务）

### 文档交付

- [x] 商店系统设计方案（上）- 系统分析与总体架构
- [x] 商店系统设计方案（中）- 详细设计与实现规范
- [x] 商店系统设计方案（下）- 实施方案与交付清单
- [x] 商店系统交付文档（本文档）
- [ ] 商店系统 API 文档（待生成）
- [ ] 商店系统使用手册（待生成）

### 数据库交付

- [ ] 数据库迁移脚本（`AddShopSystem`）
- [ ] 种子数据（3 个商店 + 20+ 商品）

### 测试交付

- [ ] 单元测试（45 个）
- [ ] 集成测试（15 个）
- [ ] 性能测试（5 个）
- [ ] 测试报告

---

## ✅ 验收标准

### 功能验收

- [ ] 商店列表查询成功（响应 < 100ms）
- [ ] 商品列表查询成功（响应 < 100ms）
- [ ] 购买功能完整（金币交易、物品兑换）
- [ ] 购买验证全部生效（6 类验证）
- [ ] 购买历史查询成功

### 质量验收

- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 所有集成测试通过
- [ ] 性能测试达标
- [ ] 无 P0/P1 Bug
- [ ] 代码审查通过

### 安全验收

- [ ] 所有 API 需要认证
- [ ] 输入验证完整
- [ ] SQL 注入防护
- [ ] 并发控制正确
- [ ] 事务回滚正确

---

## 📞 联系与支持

### 文档维护

- **文档所有者**：开发团队
- **创建日期**：2025-10-12
- **最后更新**：2025-10-12
- **下次审查**：实施完成后

### 相关文档

- `整合设计总结.txt` - 项目整体设计
- `项目进度与规划.md` - 项目进度追踪
- `边打边发-README.md` - 经济系统参考
- `装备系统优化推进报告2025-10-12.md` - 装备系统参考

### 反馈渠道

如对本设计方案有任何疑问或建议，请通过以下方式反馈：
- 提交 GitHub Issue
- 联系开发团队
- 参与设计评审会议

---

## 🎉 总结

### 设计优势

1. **完整性**：覆盖商店系统的所有核心功能
2. **可扩展性**：为未来功能预留接口
3. **可维护性**：清晰的架构和详细的文档
4. **可测试性**：完善的测试策略
5. **安全性**：全面的安全防护措施

### 实施建议

1. **严格按照 Phase 顺序实施**，确保每个阶段的验收标准
2. **优先完成 Phase 1-3**，实现核心功能
3. **Phase 4（前端集成）可并行开发或延后**
4. **持续集成测试**，确保质量
5. **定期评审进度**，及时调整计划

### 成功要素

- ✅ **清晰的需求分析**：深入理解现有系统和业务需求
- ✅ **详细的设计文档**：三篇独立文档，覆盖所有细节
- ✅ **可执行的代码示例**：提供完整的实现代码
- ✅ **完善的测试策略**：保证质量和稳定性
- ✅ **灵活的扩展规划**：为未来发展预留空间

---

**文档状态**：✅ 全部完成  
**下一步行动**：进入 Phase 1 实施阶段  
**预计开始时间**：待定  

**祝项目成功！** 🚀
