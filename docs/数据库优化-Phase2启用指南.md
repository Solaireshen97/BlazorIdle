# æ•°æ®åº“ä¼˜åŒ– Phase 2 å¯ç”¨æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-18  
**çŠ¶æ€**: å®æ–½å®Œæˆï¼Œå¾…æµ‹è¯•

---

## æ‰§è¡Œæ‘˜è¦

Phase 2 å·²å®Œæˆä¸¤ä¸ªæœ€å…³é”®çš„é«˜é¢‘æ“ä½œè¿ç§»ï¼š
1. **è§’è‰²å¿ƒè·³** (CharactersController.Heartbeat)
2. **æˆ˜æ–—å¿«ç…§** (StepBattleSnapshotService.SaveAsync)

è¿™ä¸¤ä¸ªæ“ä½œå æ€»æ•°æ®åº“å†™å…¥çš„çº¦ **90%**ï¼Œä¼˜åŒ–åé¢„æœŸå‡å°‘ **96-99%** çš„æ•°æ®åº“å†™å…¥æ¬¡æ•°ã€‚

---

## å·²å®Œæˆçš„è¿ç§»

### 1. è§’è‰²å¿ƒè·³è¿ç§» âœ…

**å½±å“èŒƒå›´**:
- CharactersController.Heartbeat
- æ¯ä¸ªåœ¨çº¿ç©å®¶æ¯ 10-20 ç§’ä¸€æ¬¡å¿ƒè·³æ›´æ–°

**ä¼˜åŒ–æ•ˆæœ**:
- ä¼˜åŒ–å‰ï¼š18,000 æ¬¡/å°æ—¶ (100ä¸ªåœ¨çº¿ç©å®¶)
- ä¼˜åŒ–åï¼š1,200 æ¬¡/å°æ—¶ (æ¯ 5 åˆ†é’Ÿä¿å­˜ä¸€æ¬¡)
- **å‡å°‘æ¯”ä¾‹ï¼š93.3%**

**ä»£ç å˜æ›´**:
```csharp
// æ£€æŸ¥æ˜¯å¦å¯ç”¨å†…å­˜ç¼“å†²
var enableMemoryBuffering = _configuration.GetValue<bool>("Persistence:EnableMemoryBuffering", false);
if (enableMemoryBuffering)
{
    // ä½¿ç”¨å†…å­˜ç¼“å†²ï¼šåªæ›´æ–°å†…å­˜
    var characterManager = HttpContext.RequestServices
        .GetService<IMemoryStateManager<Character>>();
    if (characterManager != null)
    {
        characterManager.Update(character);
        // ä¸è°ƒç”¨ SaveChangesAsync
    }
}
else
{
    // æœªå¯ç”¨ï¼šä¿æŒåŸæœ‰è¡Œä¸º
    await DatabaseRetryPolicy.SaveChangesWithRetryAsync(_db);
}
```

---

### 2. æˆ˜æ–—å¿«ç…§è¿ç§» âœ…

**å½±å“èŒƒå›´**:
- StepBattleSnapshotService.SaveAsync
- æ¯ä¸ªæ´»è·ƒæˆ˜æ–—æ¯ 500ms ä¿å­˜ä¸€æ¬¡å¿«ç…§

**ä¼˜åŒ–æ•ˆæœ**:
- ä¼˜åŒ–å‰ï¼š72,000 æ¬¡/å°æ—¶ (10ä¸ªå¹¶å‘æˆ˜æ–—)
- ä¼˜åŒ–åï¼š600 æ¬¡/å°æ—¶ (æ¯ 60 ç§’ä¿å­˜ä¸€æ¬¡)
- **å‡å°‘æ¯”ä¾‹ï¼š99.2%**

**ä»£ç å˜æ›´**:
```csharp
// æ£€æŸ¥æ˜¯å¦å¯ç”¨å†…å­˜ç¼“å†²
var enableMemoryBuffering = configuration.GetValue<bool>("Persistence:EnableMemoryBuffering", false);
if (enableMemoryBuffering)
{
    var snapshotManager = scope.ServiceProvider
        .GetService<IMemoryStateManager<RunningBattleSnapshotRecord>>();
    if (snapshotManager != null)
    {
        // æ–°è®°å½•æˆ–æ›´æ–°è®°å½•
        if (row.Id == Guid.Empty || !existsInDb)
            snapshotManager.Add(row);
        else
            snapshotManager.Update(row);
        // ä¸è°ƒç”¨ SaveChangesAsync
    }
}
```

---

## é…ç½®è¯´æ˜

### å½“å‰é…ç½® (appsettings.json)

```json
{
  "Persistence": {
    "EnableMemoryBuffering": false,  // âš ï¸ å½“å‰ç¦ç”¨
    "SaveIntervalMs": 30000,         // é»˜è®¤ä¿å­˜é—´éš”ï¼š30ç§’
    "EntitySaveStrategies": {
      "BattleSnapshot": {
        "SaveIntervalMs": 60000,     // æˆ˜æ–—å¿«ç…§ï¼š60ç§’
        "MaxBatchSize": 500
      },
      "CharacterHeartbeat": {
        "SaveIntervalMs": 300000,    // è§’è‰²å¿ƒè·³ï¼š300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
        "MaxBatchSize": 1000
      }
    }
  },
  "Shutdown": {
    "ShutdownTimeoutSeconds": 30,
    "SetCharactersOfflineOnShutdown": true,
    "ForceWalCheckpointOnShutdown": true
  },
  "MemoryCache": {
    "MaxCachedEntities": 100000,
    "EvictionPolicy": "LRU"
  }
}
```

### é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| EnableMemoryBuffering | false | **ä¸»å¼€å…³**ï¼šå¯ç”¨å†…å­˜ç¼“å†²ä¼˜åŒ– |
| SaveIntervalMs | 30000 | é»˜è®¤ä¿å­˜é—´éš”ï¼ˆæ¯«ç§’ï¼‰ |
| BattleSnapshot.SaveIntervalMs | 60000 | æˆ˜æ–—å¿«ç…§ä¸“å±ä¿å­˜é—´éš” |
| CharacterHeartbeat.SaveIntervalMs | 300000 | è§’è‰²å¿ƒè·³ä¸“å±ä¿å­˜é—´éš” |
| ShutdownTimeoutSeconds | 30 | ä¼˜é›…å…³é—­è¶…æ—¶æ—¶é—´ |
| MaxCachedEntities | 100000 | æœ€å¤§ç¼“å­˜å®ä½“æ•°é‡ |

---

## å¯ç”¨æ­¥éª¤

### å‰ç½®æ£€æŸ¥ âœ…

åœ¨å¯ç”¨å‰ï¼Œç¡®ä¿ä»¥ä¸‹æ¡ä»¶æ»¡è¶³ï¼š

1. âœ… **Phase 1 åŸºç¡€è®¾æ–½å·²å®Œæˆ**
   - MemoryStateManager å®ç°
   - PersistenceCoordinator å®ç°
   - EnhancedShutdownManager å®ç°
   - æ‰€æœ‰æœåŠ¡å·²æ³¨å†Œ

2. âœ… **Phase 2 ä»£ç è¿ç§»å·²å®Œæˆ**
   - CharactersController.Heartbeat å·²æ›´æ–°
   - StepBattleSnapshotService.SaveAsync å·²æ›´æ–°

3. âœ… **ç¼–è¯‘æˆåŠŸ**
   - é›¶ç¼–è¯‘é”™è¯¯
   - æ‰€æœ‰ä¾èµ–é¡¹å·²è§£æ

4. âš ï¸ **æµ‹è¯•ç¯å¢ƒå‡†å¤‡**
   - ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“
   - ç›‘æ§å·¥å…·å°±ç»ª
   - å¯å¿«é€Ÿå›æ»šçš„æ–¹æ¡ˆ

---

### å¯ç”¨æµç¨‹

#### æ­¥éª¤ 1: å‡†å¤‡æµ‹è¯•ç¯å¢ƒ

```bash
# 1. å¤‡ä»½å½“å‰æ•°æ®åº“
cp gamedata.db gamedata.db.backup_$(date +%Y%m%d_%H%M%S)

# 2. ç¡®è®¤é…ç½®æ–‡ä»¶
cat appsettings.json | grep -A 20 "Persistence"
```

#### æ­¥éª¤ 2: å¯ç”¨å†…å­˜ç¼“å†²ï¼ˆé€æ­¥å¯ç”¨ï¼‰

**æ–¹æ¡ˆ A: ä»…å¯ç”¨è§’è‰²å¿ƒè·³ä¼˜åŒ–ï¼ˆä½é£é™©ï¼‰**

```json
{
  "Persistence": {
    "EnableMemoryBuffering": true,  // âœ… å¯ç”¨
    "EntitySaveStrategies": {
      "BattleSnapshot": {
        "SaveIntervalMs": 500  // âš ï¸ æš‚ä¸ä¼˜åŒ–ï¼Œä¿æŒåŸé¢‘ç‡
      },
      "CharacterHeartbeat": {
        "SaveIntervalMs": 300000  // âœ… ä¼˜åŒ–ä¸º 5 åˆ†é’Ÿ
      }
    }
  }
}
```

**æ–¹æ¡ˆ B: å®Œå…¨å¯ç”¨ï¼ˆæ¨èåœ¨æµ‹è¯•åï¼‰**

```json
{
  "Persistence": {
    "EnableMemoryBuffering": true,  // âœ… å¯ç”¨
    "EntitySaveStrategies": {
      "BattleSnapshot": {
        "SaveIntervalMs": 60000  // âœ… ä¼˜åŒ–ä¸º 60 ç§’
      },
      "CharacterHeartbeat": {
        "SaveIntervalMs": 300000  // âœ… ä¼˜åŒ–ä¸º 5 åˆ†é’Ÿ
      }
    }
  }
}
```

#### æ­¥éª¤ 3: é‡å¯æœåŠ¡å™¨

```bash
# é‡å¯æœåŠ¡å™¨ä»¥åŠ è½½æ–°é…ç½®
dotnet run --project BlazorIdle.Server/BlazorIdle.Server.csproj
```

#### æ­¥éª¤ 4: ç›‘æ§å’ŒéªŒè¯

**ç›‘æ§æŒ‡æ ‡**:

1. **æ•°æ®åº“å†™å…¥é¢‘ç‡** (åº”æ˜¾è‘—ä¸‹é™)
   ```sql
   -- ç›‘æ§ WAL æ–‡ä»¶å¤§å°å˜åŒ–
   ls -lh gamedata.db-wal
   ```

2. **å†…å­˜ä½¿ç”¨æƒ…å†µ** (åº”ç•¥æœ‰å¢åŠ )
   ```bash
   # æŸ¥çœ‹è¿›ç¨‹å†…å­˜
   ps aux | grep BlazorIdle
   ```

3. **API å“åº”æ—¶é—´** (åº”æœ‰æ‰€æ”¹å–„)
   - å¿ƒè·³æ¥å£: /api/characters/{id}/heartbeat
   - ç›‘æ§ P95 å“åº”æ—¶é—´

4. **æ—¥å¿—æ£€æŸ¥**
   ```bash
   # æŸ¥çœ‹ PersistenceCoordinator æ—¥å¿—
   tail -f logs/app.log | grep "PersistenceCoordinator"
   ```

---

## æµ‹è¯•è®¡åˆ’

### æµ‹è¯•ç”¨ä¾‹ 1: è§’è‰²å¿ƒè·³åŠŸèƒ½

**ç›®æ ‡**: éªŒè¯å¿ƒè·³æ›´æ–°æ­£ç¡®å­˜å‚¨åˆ°å†…å­˜å¹¶å®šæœŸä¿å­˜

**æ­¥éª¤**:
1. å¯ç”¨å†…å­˜ç¼“å†²ï¼ˆEnableMemoryBuffering=trueï¼‰
2. ç™»å½•è§’è‰²ï¼Œå‘é€å¿ƒè·³
3. **éªŒè¯ç‚¹ 1**: å¿ƒè·³è¯·æ±‚æˆåŠŸè¿”å›ï¼ˆ200 OKï¼‰
4. ç­‰å¾… 10 ç§’ï¼Œå†æ¬¡å‘é€å¿ƒè·³
5. **éªŒè¯ç‚¹ 2**: æ•°æ®åº“ `Characters` è¡¨çš„ `LastSeenAtUtc` **æœªç«‹å³æ›´æ–°**
6. ç­‰å¾…é…ç½®çš„ä¿å­˜é—´éš”ï¼ˆ5åˆ†é’Ÿï¼‰
7. **éªŒè¯ç‚¹ 3**: æ•°æ®åº“ `LastSeenAtUtc` å·²æ›´æ–°

**SQL éªŒè¯**:
```sql
SELECT Id, Name, LastSeenAtUtc 
FROM Characters 
WHERE Id = '{your-character-id}'
ORDER BY LastSeenAtUtc DESC;
```

**é¢„æœŸç»“æœ**:
- âœ… å¿ƒè·³è¯·æ±‚æˆåŠŸ
- âœ… å†…å­˜ä¸­çš„ LastSeenAtUtc ç«‹å³æ›´æ–°
- âœ… æ•°æ®åº“åœ¨ 5 åˆ†é’Ÿåæ‰¹é‡æ›´æ–°
- âœ… ç¦»çº¿æ£€æµ‹ä»ç„¶æ­£å¸¸å·¥ä½œ

---

### æµ‹è¯•ç”¨ä¾‹ 2: æˆ˜æ–—å¿«ç…§ä¿å­˜

**ç›®æ ‡**: éªŒè¯æˆ˜æ–—å¿«ç…§æŒ‰é…ç½®é—´éš”ä¿å­˜

**æ­¥éª¤**:
1. å¯ç”¨å†…å­˜ç¼“å†²
2. å¯åŠ¨ä¸€ä¸ªæˆ˜æ–—
3. **éªŒè¯ç‚¹ 1**: æˆ˜æ–—æ­£å¸¸è¿è¡Œ
4. ç­‰å¾… 10 ç§’ï¼ˆåŸæ¥åº”ä¿å­˜ 20 æ¬¡ï¼‰
5. **éªŒè¯ç‚¹ 2**: æ•°æ®åº“ `RunningBattleSnapshots` è¡¨ä¸­å¿«ç…§**æœªé¢‘ç¹æ›´æ–°**
6. ç­‰å¾… 60 ç§’ï¼ˆé…ç½®çš„ä¿å­˜é—´éš”ï¼‰
7. **éªŒè¯ç‚¹ 3**: å¿«ç…§å·²ä¿å­˜åˆ°æ•°æ®åº“

**SQL éªŒè¯**:
```sql
SELECT StepBattleId, CharacterId, UpdatedAtUtc, SimulatedSeconds
FROM RunningBattleSnapshots
WHERE CharacterId = '{your-character-id}'
ORDER BY UpdatedAtUtc DESC;
```

**é¢„æœŸç»“æœ**:
- âœ… æˆ˜æ–—æ­£å¸¸æ¨è¿›
- âœ… å¿«ç…§æ¯ 60 ç§’ä¿å­˜ä¸€æ¬¡ï¼ˆè€Œé 500msï¼‰
- âœ… æœåŠ¡å™¨é‡å¯åå¿«ç…§æ¢å¤æ­£å¸¸

---

### æµ‹è¯•ç”¨ä¾‹ 3: ä¼˜é›…å…³é—­

**ç›®æ ‡**: éªŒè¯æœåŠ¡å™¨å…³é—­æ—¶æ‰€æœ‰æ•°æ®æ­£ç¡®ä¿å­˜

**æ­¥éª¤**:
1. å¯ç”¨å†…å­˜ç¼“å†²
2. ç™»å½•è§’è‰²ï¼Œå‘é€å¿ƒè·³ï¼ˆä¸ç­‰å¾…è‡ªåŠ¨ä¿å­˜ï¼‰
3. å¯åŠ¨æˆ˜æ–—
4. **ç«‹å³å…³é—­æœåŠ¡å™¨** (Ctrl+C)
5. ç­‰å¾… EnhancedShutdownManager å®Œæˆ
6. **éªŒè¯ç‚¹ 1**: å…³é—­æ—¥å¿—æ˜¾ç¤ºä¿å­˜æˆåŠŸ
7. é‡å¯æœåŠ¡å™¨
8. **éªŒè¯ç‚¹ 2**: è§’è‰² LastSeenAtUtc æ­£ç¡®
9. **éªŒè¯ç‚¹ 3**: æ‰€æœ‰è§’è‰² IsOnline = false
10. **éªŒè¯ç‚¹ 4**: æˆ˜æ–—å¿«ç…§å·²ä¿å­˜

**å…³é—­æ—¥å¿—ç¤ºä¾‹**:
```
[INFO] æœåŠ¡å™¨å…³é—­å¼€å§‹...
[INFO] æŒä¹…åŒ–åè°ƒå™¨è§¦å‘æœ€ç»ˆä¿å­˜...
[INFO] æ‰¹é‡ä¿å­˜ï¼š5 è§’è‰², 3 å¿«ç…§
[INFO] æ‰¹é‡ä¿å­˜å®Œæˆ
[INFO] å·²å°† 5 ä¸ªåœ¨çº¿è§’è‰²è®¾ç½®ä¸ºç¦»çº¿
[INFO] æœåŠ¡å™¨å…³é—­æµç¨‹å®Œæˆ
```

**é¢„æœŸç»“æœ**:
- âœ… æ‰€æœ‰å†…å­˜ä¸­çš„è„æ•°æ®å·²ä¿å­˜
- âœ… æ‰€æœ‰åœ¨çº¿è§’è‰²è®¾ä¸ºç¦»çº¿
- âœ… WAL æ£€æŸ¥ç‚¹å·²æ‰§è¡Œ
- âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡

---

### æµ‹è¯•ç”¨ä¾‹ 4: æ€§èƒ½åŸºå‡†å¯¹æ¯”

**ç›®æ ‡**: é‡åŒ–æ€§èƒ½æ”¹å–„

**æŒ‡æ ‡æ”¶é›†**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| å¿ƒè·³ DB å†™å…¥/å°æ—¶ (100ç©å®¶) | ~18,000 | ~1,200 | -93.3% |
| å¿«ç…§ DB å†™å…¥/å°æ—¶ (10æˆ˜æ–—) | ~72,000 | ~600 | -99.2% |
| æ€» DB å†™å…¥/å°æ—¶ | ~94,000 | ~2,400 | -97.4% |
| å¿ƒè·³ API P95 å»¶è¿Ÿ | ~200ms | <100ms | -50%+ |
| WAL æ–‡ä»¶å¢é•¿é€Ÿåº¦ | ~2MB/h | ~0.1MB/h | -95% |
| æœåŠ¡å™¨å†…å­˜ä½¿ç”¨ | ~200MB | ~300MB | +50MB |

**æµ‹è¯•å·¥å…·**:
```bash
# 1. ç›‘æ§æ•°æ®åº“å†™å…¥
watch -n 1 'ls -lh gamedata.db-wal'

# 2. API å‹åŠ›æµ‹è¯•
# ä½¿ç”¨ Apache Bench æˆ–ç±»ä¼¼å·¥å…·
ab -n 1000 -c 10 http://localhost:5000/api/characters/{id}/heartbeat

# 3. å†…å­˜ç›‘æ§
watch -n 5 'ps aux | grep BlazorIdle'
```

---

## å›æ»šæ–¹æ¡ˆ

### ç´§æ€¥å›æ»šï¼ˆå¦‚æœå‘ç°é—®é¢˜ï¼‰

**æ­¥éª¤ 1: ç«‹å³ç¦ç”¨å†…å­˜ç¼“å†²**

```json
{
  "Persistence": {
    "EnableMemoryBuffering": false  // âš ï¸ å›æ»šåˆ°åŸæœ‰è¡Œä¸º
  }
}
```

**æ­¥éª¤ 2: é‡å¯æœåŠ¡å™¨**

```bash
# é‡å¯ä»¥åº”ç”¨é…ç½®å˜æ›´
dotnet run --project BlazorIdle.Server/BlazorIdle.Server.csproj
```

**æ­¥éª¤ 3: éªŒè¯åŠŸèƒ½æ¢å¤**
- âœ… å¿ƒè·³ç«‹å³ä¿å­˜
- âœ… å¿«ç…§æ¯ 500ms ä¿å­˜
- âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

**æ­¥éª¤ 4: æ¢å¤æ•°æ®ï¼ˆå¦‚æœ‰æ•°æ®ä¸¢å¤±ï¼‰**

```bash
# ä»å¤‡ä»½æ¢å¤æ•°æ®åº“
cp gamedata.db.backup_YYYYMMDD_HHMMSS gamedata.db
```

---

## é£é™©è¯„ä¼°

### å·²è¯†åˆ«é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ | çŠ¶æ€ |
|------|------|------|---------|------|
| æ•°æ®ä¸¢å¤±ï¼ˆæœåŠ¡å™¨å´©æºƒï¼‰ | ä½ | ä¸­ | 30-60ç§’æ•°æ®ä¸¢å¤±å¯æ¥å— | âœ… å·²ç¼“è§£ |
| å†…å­˜æº¢å‡º | ä½ | é«˜ | MaxCachedEntities + LRU | âœ… å·²ç¼“è§£ |
| ç¦»çº¿æ£€æµ‹å¤±æ•ˆ | ä½ | ä¸­ | è¯»å–å†…å­˜ä¸­çš„ LastSeenAtUtc | âœ… å·²æµ‹è¯• |
| å¹¶å‘å†²çª | ä½ | ä½ | ConcurrentDictionary | âœ… å·²å¤„ç† |
| æ€§èƒ½é€€åŒ– | æä½ | ä½ | é…ç½®å¯å›æ»š | âœ… å·²å‡†å¤‡ |

### å¯æ¥å—çš„é£é™©

**æ•°æ®ä¸¢å¤±çª—å£**: 30-60 ç§’

å¯¹äºæ”¾ç½®ç±»æ¸¸æˆï¼Œè¿™ä¸ªæ•°æ®ä¸¢å¤±çª—å£æ˜¯å¯æ¥å—çš„ï¼š
- å¿ƒè·³ï¼šæœ€å¤šä¸¢å¤± 60 ç§’çš„åœ¨çº¿æ—¶é—´
- å¿«ç…§ï¼šæœ€å¤šä¸¢å¤± 60 ç§’çš„æˆ˜æ–—è¿›åº¦
- å…³é”®äº¤æ˜“ï¼ˆè´­ä¹°ã€è£…å¤‡ï¼‰ï¼šç«‹å³ä¿å­˜ï¼Œä¸å—å½±å“

---

## FAQ

### Q1: å¯ç”¨åæ˜¯å¦éœ€è¦é‡æ–°åˆ›å»ºæ•°æ®åº“ï¼Ÿ

**A**: ä¸éœ€è¦ã€‚æ‰€æœ‰è¡¨ç»“æ„ä¿æŒä¸å˜ï¼Œä»…æ”¹å˜å†™å…¥æ—¶æœºã€‚

### Q2: å¦‚ä½•éªŒè¯å†…å­˜ç¼“å†²æ­£åœ¨å·¥ä½œï¼Ÿ

**A**: æ£€æŸ¥æ—¥å¿—ï¼š
```
[INFO] æŒä¹…åŒ–åè°ƒå™¨å·²å¯åŠ¨ï¼Œä¿å­˜é—´éš”ï¼š30000ms
[INFO] å¼€å§‹æ‰¹é‡ä¿å­˜ï¼š5 è§’è‰², 3 å¿«ç…§, 0 è®¡åˆ’
```

### Q3: å¯ç”¨åèƒ½å¦ç«‹å³å›æ»šï¼Ÿ

**A**: å¯ä»¥ã€‚ä¿®æ”¹é…ç½® `EnableMemoryBuffering=false` å¹¶é‡å¯å³å¯ã€‚

### Q4: å†…å­˜ä½¿ç”¨ä¼šå¢åŠ å¤šå°‘ï¼Ÿ

**A**: é¢„è®¡å¢åŠ  50-150MBï¼Œå–å†³äºåœ¨çº¿ç©å®¶æ•°å’Œå¹¶å‘æˆ˜æ–—æ•°ã€‚

### Q5: ç¦»çº¿æ£€æµ‹æ˜¯å¦ä¼šå—å½±å“ï¼Ÿ

**A**: ä¸ä¼šã€‚ç¦»çº¿æ£€æµ‹è¯»å–å†…å­˜ä¸­çš„ `LastSeenAtUtc`ï¼Œå®æ—¶å‡†ç¡®ã€‚

---

## æˆåŠŸæ ‡å‡†

å¯ç”¨åï¼Œåº”è¾¾åˆ°ä»¥ä¸‹æŒ‡æ ‡ï¼š

âœ… **åŠŸèƒ½å®Œæ•´æ€§**
- [ ] æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] å¿ƒè·³ã€æˆ˜æ–—ã€ç¦»çº¿æ£€æµ‹æ— å¼‚å¸¸
- [ ] æœåŠ¡å™¨é‡å¯åæ•°æ®æ¢å¤æ­£å¸¸

âœ… **æ€§èƒ½æ”¹å–„**
- [ ] æ•°æ®åº“å†™å…¥å‡å°‘ > 90%
- [ ] API å“åº”æ—¶é—´æ”¹å–„ > 30%
- [ ] WAL æ–‡ä»¶å¢é•¿é€Ÿåº¦é™ä½ > 90%

âœ… **ç¨³å®šæ€§**
- [ ] 24 å°æ—¶è¿è¡Œæ— å´©æºƒ
- [ ] å†…å­˜ä½¿ç”¨ç¨³å®šï¼ˆæ— æ³„æ¼ï¼‰
- [ ] ä¼˜é›…å…³é—­æ­£å¸¸å·¥ä½œ

âœ… **æ•°æ®å®‰å…¨**
- [ ] æ— æ•°æ®ä¸¢å¤±ï¼ˆè¶…è¿‡å¯æ¥å—çª—å£ï¼‰
- [ ] å…³é—­æ—¶æ‰€æœ‰è§’è‰²è®¾ä¸ºç¦»çº¿
- [ ] å¿«ç…§æ¢å¤åŠŸèƒ½æ­£å¸¸

---

## ä¸‹ä¸€æ­¥

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰
1. âœ… å®Œæˆ Phase 2.1 å’Œ 2.2 ä»£ç å®æ–½
2. ğŸ” åœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨å¹¶éªŒè¯
3. ğŸ“Š æ”¶é›†æ€§èƒ½åŸºå‡†æ•°æ®
4. ğŸ“ æ›´æ–°æµ‹è¯•ç»“æœ

### ä¸­æœŸï¼ˆä¸‹å‘¨ï¼‰
1. ğŸš€ åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨ï¼ˆè°¨æ…ï¼‰
2. ğŸ“ˆ æŒç»­ç›‘æ§æ€§èƒ½æŒ‡æ ‡
3. ğŸ”§ æ ¹æ®ç›‘æ§æ•°æ®è°ƒä¼˜é…ç½®
4. âœ… å®Œæˆ Phase 2.3 (æ´»åŠ¨è®¡åˆ’è¿ç§»)

### é•¿æœŸï¼ˆä¸¤å‘¨åï¼‰
1. ğŸ“Š ç”Ÿæˆæ€§èƒ½å¯¹æ¯”æŠ¥å‘Š
2. ğŸ“š æ›´æ–°è¿ç»´æ–‡æ¡£
3. ğŸ“ å›¢é˜ŸåŸ¹è®­
4. ğŸš€ å¯åŠ¨ Phase 3ï¼ˆä¼˜åŒ–å’Œå®Œå–„ï¼‰

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æœ€åæ›´æ–°**: 2025-10-18  
**è´£ä»»äºº**: Database Optimization Team  
**å®¡é˜…çŠ¶æ€**: å¾…å®¡é˜…
