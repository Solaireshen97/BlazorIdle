# å•†åº—ç³»ç»Ÿ Phase 3 ä¼˜åŒ–è®¡åˆ’

**é¡¹ç›®**: BlazorIdle  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-13  
**çŠ¶æ€**: ğŸ“‹ è®¡åˆ’ä¸­  
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

åŸºäºå·²å®Œæˆçš„ Phase 1ï¼ˆåŸºç¡€æ¡†æ¶ï¼‰å’Œ Phase 2ï¼ˆé…ç½®åŒ–ä¸åº“å­˜é›†æˆï¼‰å·¥ä½œï¼ŒPhase 3 å°†è¿›ä¸€æ­¥ä¼˜åŒ–å•†åº—ç³»ç»Ÿï¼Œå¢å¼ºå…¶åŠŸèƒ½æ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

### å½“å‰å®ŒæˆçŠ¶æ€

âœ… **Phase 1 å®Œæˆ**ï¼š
- åŸºç¡€æ¡†æ¶æ­å»ºå®Œæˆ
- é¢†åŸŸæ¨¡å‹å®ç°å®Œæ¯•
- æ•°æ®åº“è¿ç§»å’Œç§å­æ•°æ®å°±ç»ª
- æ ¸å¿ƒ API ç«¯ç‚¹å®ç°

âœ… **Phase 2 å®Œæˆ**ï¼š
- å®Œå…¨é…ç½®åŒ–ï¼ˆ23 ä¸ªé…ç½®å‚æ•°ï¼‰
- åº“å­˜ç³»ç»Ÿé›†æˆ
- ç‰©å“è´§å¸æ”¯æŒ
- 52 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- äº‹åŠ¡å®Œæ•´æ€§ä¿è¯

### Phase 3 ç›®æ ‡

æœ¬é˜¶æ®µå°†åœ¨ç¨³å›ºçš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä»¥ä¸‹ä¼˜åŒ–ï¼š

1. **å•†åº—åˆ·æ–°æœºåˆ¶** - æ”¯æŒå•†åº—å®šæ—¶åˆ·æ–°å’Œæ‰‹åŠ¨åˆ·æ–°
2. **ä¿ƒé”€ç³»ç»ŸåŸºç¡€** - ä¸ºæœªæ¥çš„æŠ˜æ‰£å’Œä¿ƒé”€æ´»åŠ¨é¢„ç•™æ¥å£
3. **è´­ä¹°å†·å´ç³»ç»Ÿ** - é˜²æ­¢æ¶æ„åˆ·è´­ä¹°è¯·æ±‚
4. **å£°æœ›/å¿ è¯šåº¦åŸºç¡€** - ä¸ºå•†åº—å£°æœ›ç³»ç»Ÿæ‰“ä¸‹åŸºç¡€
5. **ç¼“å­˜ä¼˜åŒ–** - æ”¹è¿›ç¼“å­˜å¤±æ•ˆç­–ç•¥
6. **ç›‘æ§å’ŒæŒ‡æ ‡** - æ·»åŠ ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†
7. **æ—¥å¿—å¢å¼º** - å®Œå–„ä¸šåŠ¡æ—¥å¿—è®°å½•

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

| ä¼˜åŒ–é¢†åŸŸ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | ä¼˜å…ˆçº§ |
|---------|---------|---------|-------|
| å•†åº—åˆ·æ–° | æ— åˆ·æ–°æœºåˆ¶ | æ”¯æŒå®šæ—¶å’Œæ‰‹åŠ¨åˆ·æ–° | ğŸ”´ é«˜ |
| ä¿ƒé”€ç³»ç»Ÿ | æ—  | åŸºç¡€æ¶æ„å°±ç»ª | ğŸŸ¡ ä¸­ |
| è´­ä¹°å†·å´ | æ— é™åˆ¶ | é˜²åˆ·æœºåˆ¶ | ğŸ”´ é«˜ |
| å£°æœ›ç³»ç»Ÿ | æ—  | åŸºç¡€æ•°æ®ç»“æ„ | ğŸŸ¢ ä½ |
| ç¼“å­˜ç­–ç•¥ | åŸºç¡€ç¼“å­˜ | æ™ºèƒ½å¤±æ•ˆ | ğŸŸ¡ ä¸­ |
| ç›‘æ§æŒ‡æ ‡ | æ—  | å…³é”®æŒ‡æ ‡æ”¶é›† | ğŸŸ¡ ä¸­ |
| æ—¥å¿—è®°å½• | åŸºç¡€æ—¥å¿— | ç»“æ„åŒ–ä¸šåŠ¡æ—¥å¿— | ğŸŸ¢ ä½ |

---

## ğŸ“¦ è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å•†åº—åˆ·æ–°æœºåˆ¶

#### 1.1 éœ€æ±‚åˆ†æ

å•†åº—éœ€è¦æ”¯æŒä»¥ä¸‹åˆ·æ–°åœºæ™¯ï¼š
- **å®šæ—¶è‡ªåŠ¨åˆ·æ–°**ï¼šæ¯å¤©å›ºå®šæ—¶é—´åˆ·æ–°å•†åº—å†…å®¹
- **æ‰‹åŠ¨åˆ·æ–°**ï¼šç©å®¶ä½¿ç”¨è´§å¸/é“å…·æ‰‹åŠ¨åˆ·æ–°
- **äº‹ä»¶è§¦å‘åˆ·æ–°**ï¼šç‰¹æ®Šæ´»åŠ¨æ—¶åˆ·æ–°å•†åº—

#### 1.2 è®¾è®¡æ–¹æ¡ˆ

**æ•°æ®æ¨¡å‹æ‰©å±•**ï¼š

```csharp
// ShopDefinition æ·»åŠ åˆ·æ–°é…ç½®
public class ShopDefinition
{
    // ç°æœ‰å­—æ®µ...
    
    // æ–°å¢ï¼šåˆ·æ–°é…ç½®ï¼ˆJSON å­˜å‚¨ï¼‰
    public string? RefreshConfig { get; set; }
    
    // æ–°å¢ï¼šä¸Šæ¬¡åˆ·æ–°æ—¶é—´
    public DateTime? LastRefreshTime { get; set; }
}

// åˆ·æ–°é…ç½®å€¼å¯¹è±¡
public class ShopRefreshConfig
{
    /// <summary>
    /// åˆ·æ–°ç±»å‹ï¼šNone/Auto/Manual/Both
    /// </summary>
    public RefreshType Type { get; set; } = RefreshType.None;
    
    /// <summary>
    /// è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰
    /// </summary>
    public int AutoRefreshIntervalSeconds { get; set; }
    
    /// <summary>
    /// æ‰‹åŠ¨åˆ·æ–°æˆæœ¬
    /// </summary>
    public Price? ManualRefreshCost { get; set; }
    
    /// <summary>
    /// æ‰‹åŠ¨åˆ·æ–°å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
    /// </summary>
    public int ManualRefreshCooldownSeconds { get; set; }
    
    /// <summary>
    /// æ¯æ—¥æ‰‹åŠ¨åˆ·æ–°æ¬¡æ•°é™åˆ¶
    /// </summary>
    public int DailyManualRefreshLimit { get; set; } = -1; // -1 è¡¨ç¤ºæ— é™åˆ¶
}

public enum RefreshType
{
    None = 0,      // ä¸æ”¯æŒåˆ·æ–°
    Auto = 1,      // ä»…è‡ªåŠ¨åˆ·æ–°
    Manual = 2,    // ä»…æ‰‹åŠ¨åˆ·æ–°
    Both = 3       // æ”¯æŒè‡ªåŠ¨å’Œæ‰‹åŠ¨
}
```

**é…ç½®å‚æ•°**ï¼ˆæ·»åŠ åˆ° appsettings.jsonï¼‰ï¼š

```json
{
  "Shop": {
    // ç°æœ‰é…ç½®...
    
    // åˆ·æ–°é…ç½®ï¼ˆPhase 3 æ–°å¢ï¼‰
    "DefaultAutoRefreshSeconds": 86400,        // é»˜è®¤ 24 å°æ—¶
    "ManualRefreshCooldownSeconds": 3600,      // æ‰‹åŠ¨åˆ·æ–°å†·å´ 1 å°æ—¶
    "DefaultManualRefreshCost": 100,           // é»˜è®¤æ‰‹åŠ¨åˆ·æ–°æˆæœ¬ï¼ˆé‡‘å¸ï¼‰
    "MaxDailyManualRefreshes": 5               // æ¯æ—¥æœ€å¤šæ‰‹åŠ¨åˆ·æ–°æ¬¡æ•°
  }
}
```

**API æ¥å£**ï¼š

```csharp
// æ·»åŠ åˆ° IShopService
public interface IShopService
{
    // ç°æœ‰æ–¹æ³•...
    
    /// <summary>
    /// æ£€æŸ¥å•†åº—æ˜¯å¦éœ€è¦åˆ·æ–°
    /// </summary>
    Task<bool> ShouldRefreshShopAsync(string shopId);
    
    /// <summary>
    /// æ‰‹åŠ¨åˆ·æ–°å•†åº—
    /// </summary>
    Task<RefreshShopResponse> ManualRefreshShopAsync(string shopId, string characterId);
    
    /// <summary>
    /// è·å–å•†åº—åˆ·æ–°çŠ¶æ€
    /// </summary>
    Task<ShopRefreshStatus> GetRefreshStatusAsync(string shopId, string characterId);
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. æ•°æ®åº“è¿ç§»ï¼šæ·»åŠ  RefreshConfig å’Œ LastRefreshTime å­—æ®µ
2. å®ç° ShopRefreshConfig å€¼å¯¹è±¡å’Œåºåˆ—åŒ–
3. å®ç°åˆ·æ–°é€»è¾‘å’ŒéªŒè¯
4. æ·»åŠ  API ç«¯ç‚¹
5. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼ˆ8 ä¸ªï¼‰ï¼š
- è‡ªåŠ¨åˆ·æ–°æ—¶é—´æ£€æŸ¥
- æ‰‹åŠ¨åˆ·æ–°æˆæœ¬éªŒè¯
- æ‰‹åŠ¨åˆ·æ–°å†·å´éªŒè¯
- æ¯æ—¥åˆ·æ–°æ¬¡æ•°é™åˆ¶
- å¹¶å‘åˆ·æ–°è¯·æ±‚å¤„ç†
- åˆ·æ–°å¤±è´¥å›æ»š
- åˆ·æ–°å†å²è®°å½•
- åˆ·æ–°é€šçŸ¥äº‹ä»¶

---

### 2. è´­ä¹°å†·å´ç³»ç»Ÿ

#### 2.1 éœ€æ±‚åˆ†æ

é˜²æ­¢æ¶æ„åˆ·è´­ä¹°è¯·æ±‚ï¼Œéœ€è¦å®ç°ï¼š
- **å…¨å±€è´­ä¹°å†·å´**ï¼šè§’è‰²çº§åˆ«çš„è´­ä¹°æ“ä½œå†·å´
- **å•†å“çº§è´­ä¹°å†·å´**ï¼šç‰¹å®šå•†å“çš„è´­ä¹°å†·å´
- **åŠ¨æ€å†·å´è°ƒæ•´**ï¼šæ ¹æ®å•†å“ä»·å€¼åŠ¨æ€è°ƒæ•´å†·å´æ—¶é—´

#### 2.2 è®¾è®¡æ–¹æ¡ˆ

**æ•°æ®æ¨¡å‹**ï¼š

```csharp
// è´­ä¹°å†·å´è®°å½•
public class PurchaseCooldown
{
    public string Id { get; set; } = null!;
    public string CharacterId { get; set; } = null!;
    public string? ShopItemId { get; set; }  // null è¡¨ç¤ºå…¨å±€å†·å´
    public DateTime CooldownUntil { get; set; }
    public DateTime CreatedAt { get; set; }
    
    public static string GenerateId(string characterId, string? shopItemId = null)
    {
        return shopItemId == null 
            ? $"{characterId}_global"
            : $"{characterId}_{shopItemId}";
    }
}
```

**é…ç½®å‚æ•°**ï¼š

```json
{
  "Shop": {
    // ç°æœ‰é…ç½®...
    
    // è´­ä¹°å†·å´é…ç½®ï¼ˆPhase 3 æ–°å¢ï¼‰
    "EnablePurchaseCooldown": true,
    "GlobalPurchaseCooldownSeconds": 1,        // å…¨å±€è´­ä¹°å†·å´ 1 ç§’
    "ItemPurchaseCooldownSeconds": 5,          // å•å“è´­ä¹°å†·å´ 5 ç§’
    "ExpensiveItemThreshold": 1000,            // æ˜‚è´µç‰©å“é˜ˆå€¼
    "ExpensiveItemCooldownSeconds": 10         // æ˜‚è´µç‰©å“å†·å´ 10 ç§’
  }
}
```

**éªŒè¯é€»è¾‘**ï¼š

```csharp
// æ·»åŠ åˆ° PurchaseValidator
public async Task<(bool IsValid, string ErrorMessage)> ValidatePurchaseCooldownAsync(
    string characterId, 
    string shopItemId,
    int itemPrice)
{
    if (!_shopOptions.EnablePurchaseCooldown)
    {
        return (true, string.Empty);
    }
    
    // æ£€æŸ¥å…¨å±€å†·å´
    var globalCooldown = await _context.PurchaseCooldowns
        .FirstOrDefaultAsync(pc => pc.Id == PurchaseCooldown.GenerateId(characterId));
    
    if (globalCooldown != null && globalCooldown.CooldownUntil > DateTime.UtcNow)
    {
        var remainingSeconds = (globalCooldown.CooldownUntil - DateTime.UtcNow).TotalSeconds;
        return (false, $"è´­ä¹°å†·å´ä¸­ï¼Œè¿˜éœ€ç­‰å¾… {remainingSeconds:F1} ç§’");
    }
    
    // æ£€æŸ¥å•†å“çº§å†·å´
    var itemCooldown = await _context.PurchaseCooldowns
        .FirstOrDefaultAsync(pc => pc.Id == PurchaseCooldown.GenerateId(characterId, shopItemId));
    
    if (itemCooldown != null && itemCooldown.CooldownUntil > DateTime.UtcNow)
    {
        var remainingSeconds = (itemCooldown.CooldownUntil - DateTime.UtcNow).TotalSeconds;
        return (false, $"è¯¥ç‰©å“è´­ä¹°å†·å´ä¸­ï¼Œè¿˜éœ€ç­‰å¾… {remainingSeconds:F1} ç§’");
    }
    
    return (true, string.Empty);
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. åˆ›å»º PurchaseCooldown å®ä½“å’Œæ•°æ®åº“è¡¨
2. æ·»åŠ é…ç½®å‚æ•°åˆ° ShopOptions
3. å®ç°å†·å´éªŒè¯é€»è¾‘
4. åœ¨è´­ä¹°æµç¨‹ä¸­é›†æˆå†·å´æ£€æŸ¥
5. æ·»åŠ å†·å´æ¸…ç†å®šæ—¶ä»»åŠ¡ï¼ˆæ¸…ç†è¿‡æœŸè®°å½•ï¼‰
6. ç¼–å†™æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼ˆ6 ä¸ªï¼‰ï¼š
- å…¨å±€å†·å´ç”Ÿæ•ˆ
- å•†å“çº§å†·å´ç”Ÿæ•ˆ
- æ˜‚è´µç‰©å“å†·å´å»¶é•¿
- å†·å´è¿‡æœŸåå…è®¸è´­ä¹°
- å¹¶å‘è´­ä¹°å†·å´æ£€æŸ¥
- å†·å´è®°å½•æ¸…ç†

---

### 3. ä¿ƒé”€ç³»ç»ŸåŸºç¡€

#### 3.1 éœ€æ±‚åˆ†æ

ä¸ºæœªæ¥çš„ä¿ƒé”€æ´»åŠ¨é¢„ç•™åŸºç¡€æ¶æ„ï¼š
- **æŠ˜æ‰£æ”¯æŒ**ï¼šå•†å“ä»·æ ¼æŠ˜æ‰£
- **ç‰¹ä»·æ—¶æ®µ**ï¼šé™æ—¶ç‰¹ä»·
- **ç»„åˆä¼˜æƒ **ï¼šæœªæ¥æ‰©å±•

#### 3.2 è®¾è®¡æ–¹æ¡ˆ

**æ•°æ®æ¨¡å‹**ï¼š

```csharp
// ä¿ƒé”€é…ç½®å€¼å¯¹è±¡
public class PromotionConfig
{
    /// <summary>
    /// æŠ˜æ‰£ç™¾åˆ†æ¯” (0-100)ï¼Œ0 è¡¨ç¤ºæ— æŠ˜æ‰£
    /// </summary>
    public int DiscountPercentage { get; set; } = 0;
    
    /// <summary>
    /// ä¿ƒé”€å¼€å§‹æ—¶é—´
    /// </summary>
    public DateTime? StartTime { get; set; }
    
    /// <summary>
    /// ä¿ƒé”€ç»“æŸæ—¶é—´
    /// </summary>
    public DateTime? EndTime { get; set; }
    
    /// <summary>
    /// ä¿ƒé”€æ ‡ç­¾ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
    /// </summary>
    public string? PromotionTag { get; set; }
    
    /// <summary>
    /// æ˜¯å¦å½“å‰æ´»è·ƒ
    /// </summary>
    public bool IsActive()
    {
        var now = DateTime.UtcNow;
        return DiscountPercentage > 0
            && (StartTime == null || StartTime <= now)
            && (EndTime == null || EndTime >= now);
    }
    
    /// <summary>
    /// è®¡ç®—æŠ˜æ‰£åä»·æ ¼
    /// </summary>
    public int CalculateDiscountedPrice(int originalPrice)
    {
        if (!IsActive()) return originalPrice;
        return (int)(originalPrice * (100 - DiscountPercentage) / 100.0);
    }
}

// ShopItem æ·»åŠ ä¿ƒé”€é…ç½®
public class ShopItem
{
    // ç°æœ‰å­—æ®µ...
    
    // æ–°å¢ï¼šä¿ƒé”€é…ç½®ï¼ˆJSON å­˜å‚¨ï¼‰
    public string? PromotionConfig { get; set; }
    
    // è¾…åŠ©æ–¹æ³•
    public PromotionConfig? GetPromotionConfig()
    {
        if (string.IsNullOrEmpty(PromotionConfig))
            return null;
            
        return JsonSerializer.Deserialize<PromotionConfig>(PromotionConfig);
    }
    
    public void SetPromotionConfig(PromotionConfig? config)
    {
        PromotionConfig = config == null 
            ? null 
            : JsonSerializer.Serialize(config);
    }
}
```

**é…ç½®å‚æ•°**ï¼š

```json
{
  "Shop": {
    // ç°æœ‰é…ç½®...
    
    // ä¿ƒé”€é…ç½®ï¼ˆPhase 3 æ–°å¢ï¼‰
    "EnablePromotions": true,
    "MaxDiscountPercentage": 90,               // æœ€å¤§æŠ˜æ‰£ 90%
    "MinDiscountPercentage": 5,                // æœ€å°æŠ˜æ‰£ 5%
    "DefaultPromotionDurationHours": 24        // é»˜è®¤ä¿ƒé”€æŒç»­æ—¶é—´
  }
}
```

**API å“åº”æ‰©å±•**ï¼š

```csharp
// ShopItemDto æ·»åŠ ä¿ƒé”€ä¿¡æ¯
public class ShopItemDto
{
    // ç°æœ‰å­—æ®µ...
    
    // æ–°å¢ï¼šä¿ƒé”€ä¿¡æ¯
    public bool HasPromotion { get; set; }
    public int DiscountPercentage { get; set; }
    public int OriginalPrice { get; set; }
    public int DiscountedPrice { get; set; }
    public string? PromotionTag { get; set; }
    public DateTime? PromotionEndTime { get; set; }
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. æ•°æ®åº“è¿ç§»ï¼šæ·»åŠ  PromotionConfig å­—æ®µ
2. å®ç° PromotionConfig å€¼å¯¹è±¡
3. ä¿®æ”¹ä»·æ ¼è®¡ç®—é€»è¾‘æ”¯æŒæŠ˜æ‰£
4. æ›´æ–° API å“åº”åŒ…å«ä¿ƒé”€ä¿¡æ¯
5. ç¼–å†™æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼ˆ5 ä¸ªï¼‰ï¼š
- ä¿ƒé”€ä»·æ ¼è®¡ç®—æ­£ç¡®
- ä¿ƒé”€æ—¶é—´èŒƒå›´éªŒè¯
- è¿‡æœŸä¿ƒé”€ä¸ç”Ÿæ•ˆ
- æŠ˜æ‰£ç™¾åˆ†æ¯”è¾¹ç•Œæ£€æŸ¥
- æ— ä¿ƒé”€å•†å“ä»·æ ¼ä¸å˜

---

### 4. ç¼“å­˜ä¼˜åŒ–

#### 4.1 å½“å‰é—®é¢˜

- ç¼“å­˜å¤±æ•ˆç­–ç•¥è¿‡äºç®€å•
- ç¼ºå°‘ç»†ç²’åº¦çš„ç¼“å­˜æ§åˆ¶
- æ— ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

#### 4.2 ä¼˜åŒ–æ–¹æ¡ˆ

**ç¼“å­˜é”®ç­–ç•¥ä¼˜åŒ–**ï¼š

```csharp
public class ShopCacheService : IShopCacheService
{
    private const string ShopsKey = "Shops_All";
    private const string ShopItemsKeyPrefix = "ShopItems_";
    
    // æ–°å¢ï¼šç»†ç²’åº¦ç¼“å­˜é”®
    private const string ShopKeyPrefix = "Shop_";
    private const string ItemKeyPrefix = "Item_";
    private const string PurchaseCounterKeyPrefix = "PurchaseCounter_";
    
    // æ–°å¢ï¼šç¼“å­˜ç»Ÿè®¡
    private int _cacheHits = 0;
    private int _cacheMisses = 0;
    
    /// <summary>
    /// è·å–å•ä¸ªå•†åº—å®šä¹‰
    /// </summary>
    public async Task<ShopDefinition?> GetShopAsync(string shopId)
    {
        if (!_cachingEnabled)
        {
            Interlocked.Increment(ref _cacheMisses);
            return null;
        }
        
        var cacheKey = $"{ShopKeyPrefix}{shopId}";
        
        if (_cache.TryGetValue(cacheKey, out ShopDefinition? shop))
        {
            Interlocked.Increment(ref _cacheHits);
            _logger.LogDebug("Cache hit for shop {ShopId}", shopId);
            return shop;
        }
        
        Interlocked.Increment(ref _cacheMisses);
        _logger.LogDebug("Cache miss for shop {ShopId}", shopId);
        return null;
    }
    
    /// <summary>
    /// æ™ºèƒ½ç¼“å­˜å¤±æ•ˆï¼šä»…å¤±æ•ˆç›¸å…³ç¼“å­˜
    /// </summary>
    public void InvalidateShopCache(string shopId)
    {
        // å¤±æ•ˆå•ä¸ªå•†åº—ç¼“å­˜
        _cache.Remove($"{ShopKeyPrefix}{shopId}");
        
        // å¤±æ•ˆè¯¥å•†åº—çš„å•†å“ç¼“å­˜
        _cache.Remove($"{ShopItemsKeyPrefix}{shopId}");
        
        // å¤±æ•ˆå•†åº—åˆ—è¡¨ç¼“å­˜
        _cache.Remove(ShopsKey);
        
        _logger.LogInformation("Invalidated cache for shop {ShopId}", shopId);
    }
    
    /// <summary>
    /// è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
    /// </summary>
    public CacheStatistics GetStatistics()
    {
        var hits = Interlocked.CompareExchange(ref _cacheHits, 0, 0);
        var misses = Interlocked.CompareExchange(ref _cacheMisses, 0, 0);
        var total = hits + misses;
        
        return new CacheStatistics
        {
            Hits = hits,
            Misses = misses,
            Total = total,
            HitRate = total > 0 ? (double)hits / total : 0
        };
    }
}

public class CacheStatistics
{
    public int Hits { get; set; }
    public int Misses { get; set; }
    public int Total { get; set; }
    public double HitRate { get; set; }
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. æ·»åŠ ç»†ç²’åº¦ç¼“å­˜æ–¹æ³•
2. å®ç°æ™ºèƒ½å¤±æ•ˆç­–ç•¥
3. æ·»åŠ ç¼“å­˜ç»Ÿè®¡åŠŸèƒ½
4. æ·»åŠ ç¼“å­˜ç›‘æ§ç«¯ç‚¹
5. ç¼–å†™æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼ˆ4 ä¸ªï¼‰ï¼š
- ç»†ç²’åº¦ç¼“å­˜æ­£ç¡®å·¥ä½œ
- æ™ºèƒ½å¤±æ•ˆä¸å½±å“æ— å…³ç¼“å­˜
- ç¼“å­˜ç»Ÿè®¡å‡†ç¡®
- å¹¶å‘è®¿é—®ç»Ÿè®¡å‡†ç¡®

---

### 5. ç›‘æ§å’ŒæŒ‡æ ‡

#### 5.1 ä¸šåŠ¡æŒ‡æ ‡

éœ€è¦æ”¶é›†çš„å…³é”®æŒ‡æ ‡ï¼š

```csharp
// å•†åº—ä¸šåŠ¡æŒ‡æ ‡
public class ShopMetrics
{
    // è´­ä¹°ç›¸å…³
    public long TotalPurchases { get; set; }
    public long SuccessfulPurchases { get; set; }
    public long FailedPurchases { get; set; }
    
    // æ”¶å…¥ç›¸å…³
    public long TotalGoldSpent { get; set; }
    public long TotalItemsTraded { get; set; }
    
    // çƒ­é—¨å•†å“
    public Dictionary<string, int> TopSellingItems { get; set; } = new();
    
    // åˆ·æ–°ç›¸å…³
    public long ManualRefreshCount { get; set; }
    public long AutoRefreshCount { get; set; }
    
    // ç¼“å­˜ç›¸å…³
    public CacheStatistics CacheStats { get; set; } = new();
    
    // æ€§èƒ½ç›¸å…³
    public double AveragePurchaseTimeMs { get; set; }
    public double AverageQueryTimeMs { get; set; }
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. åˆ›å»º ShopMetrics ç±»
2. åœ¨å…³é”®æ“ä½œç‚¹åŸ‹ç‚¹æ”¶é›†æŒ‡æ ‡
3. å®ç°æŒ‡æ ‡èšåˆå’ŒæŒä¹…åŒ–
4. æ·»åŠ æŒ‡æ ‡æŸ¥è¯¢ API
5. ç¼–å†™æµ‹è¯•

---

### 6. æ—¥å¿—å¢å¼º

#### 6.1 ç»“æ„åŒ–æ—¥å¿—

ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—è®°å½•å…³é”®ä¸šåŠ¡äº‹ä»¶ï¼š

```csharp
// è´­ä¹°äº‹ä»¶æ—¥å¿—
_logger.LogInformation(
    "Purchase completed: CharacterId={CharacterId}, ShopId={ShopId}, ItemId={ItemId}, " +
    "Quantity={Quantity}, TotalPrice={TotalPrice}, CurrencyType={CurrencyType}, " +
    "PurchaseId={PurchaseId}, Timestamp={Timestamp}",
    characterId, shopId, shopItemId, quantity, totalPrice, currencyType, 
    purchaseRecord.Id, DateTime.UtcNow);

// åˆ·æ–°äº‹ä»¶æ—¥å¿—
_logger.LogInformation(
    "Shop refreshed: ShopId={ShopId}, RefreshType={RefreshType}, " +
    "Cost={Cost}, CharacterId={CharacterId}, Timestamp={Timestamp}",
    shopId, refreshType, cost, characterId, DateTime.UtcNow);

// å†·å´è§¦å‘æ—¥å¿—
_logger.LogWarning(
    "Purchase cooldown triggered: CharacterId={CharacterId}, ItemId={ItemId}, " +
    "RemainingSeconds={RemainingSeconds}, Timestamp={Timestamp}",
    characterId, itemId, remainingSeconds, DateTime.UtcNow);
```

**å®æ–½æ­¥éª¤**ï¼š
1. è¯†åˆ«å…³é”®ä¸šåŠ¡äº‹ä»¶
2. æ·»åŠ ç»“æ„åŒ–æ—¥å¿—
3. é…ç½®æ—¥å¿—çº§åˆ«å’Œè¾“å‡º
4. éªŒè¯æ—¥å¿—å¯æŸ¥è¯¢æ€§

---

## ğŸ“… å®æ–½è®¡åˆ’

### æ—¶é—´å®‰æ’

| ä»»åŠ¡ | å·¥ä½œé‡ | å¼€å§‹æ—¥æœŸ | ç»“æŸæ—¥æœŸ | è´Ÿè´£äºº |
|-----|--------|---------|---------|--------|
| å•†åº—åˆ·æ–°æœºåˆ¶ | 3 å¤© | å¾…å®š | å¾…å®š | å¾…åˆ†é… |
| è´­ä¹°å†·å´ç³»ç»Ÿ | 2 å¤© | å¾…å®š | å¾…å®š | å¾…åˆ†é… |
| ä¿ƒé”€ç³»ç»ŸåŸºç¡€ | 2 å¤© | å¾…å®š | å¾…å®š | å¾…åˆ†é… |
| ç¼“å­˜ä¼˜åŒ– | 1.5 å¤© | å¾…å®š | å¾…å®š | å¾…åˆ†é… |
| ç›‘æ§å’ŒæŒ‡æ ‡ | 1.5 å¤© | å¾…å®š | å¾…å®š | å¾…åˆ†é… |
| æ—¥å¿—å¢å¼º | 1 å¤© | å¾…å®š | å¾…å®š | å¾…åˆ†é… |
| **æ€»è®¡** | **11 å¤©** | - | - | - |

### é‡Œç¨‹ç¢‘

- **M1**: åˆ·æ–°æœºåˆ¶å’Œå†·å´ç³»ç»Ÿå®Œæˆï¼ˆ5 å¤©ï¼‰
- **M2**: ä¿ƒé”€åŸºç¡€å’Œç¼“å­˜ä¼˜åŒ–å®Œæˆï¼ˆ3.5 å¤©ï¼‰
- **M3**: ç›‘æ§å’Œæ—¥å¿—å®Œå–„ï¼ˆ2.5 å¤©ï¼‰

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•è¦†ç›–ç›®æ ‡

| æµ‹è¯•ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|---------|-----|------|
| å•å…ƒæµ‹è¯• | 30+ | è¦†ç›–æ–°å¢ä¸šåŠ¡é€»è¾‘ |
| é›†æˆæµ‹è¯• | 15+ | è¦†ç›–ç«¯åˆ°ç«¯æµç¨‹ |
| æ€§èƒ½æµ‹è¯• | 5+ | éªŒè¯æ€§èƒ½æŒ‡æ ‡ |

### å…³é”®æµ‹è¯•åœºæ™¯

**åˆ·æ–°æœºåˆ¶**ï¼ˆ8 ä¸ªæµ‹è¯•ï¼‰ï¼š
- è‡ªåŠ¨åˆ·æ–°è§¦å‘
- æ‰‹åŠ¨åˆ·æ–°æˆåŠŸ
- æ‰‹åŠ¨åˆ·æ–°å†·å´
- åˆ·æ–°æˆæœ¬éªŒè¯
- åˆ·æ–°æ¬¡æ•°é™åˆ¶
- å¹¶å‘åˆ·æ–°å¤„ç†
- åˆ·æ–°å¤±è´¥å›æ»š
- åˆ·æ–°å†å²è®°å½•

**è´­ä¹°å†·å´**ï¼ˆ6 ä¸ªæµ‹è¯•ï¼‰ï¼š
- å…¨å±€å†·å´è§¦å‘
- å•†å“å†·å´è§¦å‘
- æ˜‚è´µç‰©å“å†·å´å»¶é•¿
- å†·å´è¿‡æœŸå…è®¸è´­ä¹°
- å¹¶å‘è´­ä¹°å†·å´æ£€æŸ¥
- å†·å´è®°å½•æ¸…ç†

**ä¿ƒé”€ç³»ç»Ÿ**ï¼ˆ5 ä¸ªæµ‹è¯•ï¼‰ï¼š
- ä¿ƒé”€ä»·æ ¼è®¡ç®—
- ä¿ƒé”€æ—¶é—´éªŒè¯
- è¿‡æœŸä¿ƒé”€å¤±æ•ˆ
- æŠ˜æ‰£ç™¾åˆ†æ¯”é™åˆ¶
- æ— ä¿ƒé”€ä»·æ ¼ä¸å˜

**ç¼“å­˜ä¼˜åŒ–**ï¼ˆ4 ä¸ªæµ‹è¯•ï¼‰ï¼š
- ç»†ç²’åº¦ç¼“å­˜å·¥ä½œ
- æ™ºèƒ½å¤±æ•ˆç­–ç•¥
- ç¼“å­˜ç»Ÿè®¡å‡†ç¡®
- å¹¶å‘ç»Ÿè®¡å‡†ç¡®

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] å•†åº—åˆ·æ–°æœºåˆ¶å®Œæ•´å¯ç”¨
- [ ] è´­ä¹°å†·å´ç³»ç»Ÿæœ‰æ•ˆé˜²åˆ·
- [ ] ä¿ƒé”€ä»·æ ¼è®¡ç®—å‡†ç¡®
- [ ] ç¼“å­˜å‘½ä¸­ç‡æ˜¾è‘—æå‡
- [ ] ç›‘æ§æŒ‡æ ‡æ­£ç¡®æ”¶é›†
- [ ] æ—¥å¿—ç»“æ„åŒ–å®Œæ•´

### è´¨é‡éªŒæ”¶

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 85%
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡
- [ ] æ—  P0/P1 Bug
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

### æ€§èƒ½éªŒæ”¶

- [ ] è´­ä¹°æ“ä½œå“åº”æ—¶é—´ < 200msï¼ˆP95ï¼‰
- [ ] å•†åº—åˆ—è¡¨æŸ¥è¯¢ < 100msï¼ˆP95ï¼‰
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 80%
- [ ] å¹¶å‘è´­ä¹°å¤„ç†æ­£ç¡®

---

## ğŸ”’ å‘åå…¼å®¹æ€§

æ‰€æœ‰ Phase 3 ä¼˜åŒ–éƒ½éµå¾ªå‘åå…¼å®¹åŸåˆ™ï¼š

âœ… **é»˜è®¤ç¦ç”¨æ–°åŠŸèƒ½**ï¼š
- åˆ·æ–°æœºåˆ¶ï¼šé»˜è®¤ RefreshType.None
- è´­ä¹°å†·å´ï¼šé…ç½®å¯å…³é—­
- ä¿ƒé”€ç³»ç»Ÿï¼šé»˜è®¤æ— ä¿ƒé”€

âœ… **å¯é€‰å­—æ®µ**ï¼š
- æ‰€æœ‰æ–°å¢æ•°æ®åº“å­—æ®µéƒ½æ˜¯å¯é€‰çš„
- ç°æœ‰æ•°æ®ä¸å—å½±å“

âœ… **é…ç½®å‘åå…¼å®¹**ï¼š
- æ‰€æœ‰æ–°é…ç½®å‚æ•°éƒ½æœ‰é»˜è®¤å€¼
- ä¸æ·»åŠ é…ç½®ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ¸è¿›å¼å¯ç”¨

å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå¯ç”¨æ–°åŠŸèƒ½ï¼š
1. å…ˆå¯ç”¨æ—¥å¿—å’Œç›‘æ§ï¼ˆæ— é£é™©ï¼‰
2. å†å¯ç”¨ç¼“å­˜ä¼˜åŒ–ï¼ˆæ€§èƒ½æå‡ï¼‰
3. ç„¶åå¯ç”¨è´­ä¹°å†·å´ï¼ˆé˜²åˆ·ï¼‰
4. æœ€åå¯ç”¨åˆ·æ–°å’Œä¿ƒé”€ï¼ˆéœ€è¦é…ç½®ï¼‰

### 2. ç›‘æ§å…ˆè¡Œ

- å…ˆéƒ¨ç½²ç›‘æ§å’Œæ—¥å¿—
- è§‚å¯Ÿç³»ç»Ÿè¡Œä¸º
- æ ¹æ®æ•°æ®è°ƒæ•´å‚æ•°

### 3. æµ‹è¯•å……åˆ†

- æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹æµ‹è¯•
- ç»„åˆåŠŸèƒ½é›†æˆæµ‹è¯•
- å‹åŠ›æµ‹è¯•éªŒè¯æ€§èƒ½

---

## ğŸ“ åç»­ Phase 4+ å±•æœ›

Phase 3 å®Œæˆåï¼Œå¯ä»¥è€ƒè™‘çš„é«˜çº§åŠŸèƒ½ï¼š

### Phase 4: é«˜çº§åŠŸèƒ½
- **å£°æœ›ç³»ç»Ÿå®Œæ•´å®ç°**ï¼šå•†åº—å£°æœ›ç­‰çº§å’Œå¥–åŠ±
- **ç»„åˆä¼˜æƒ **ï¼šè´­ä¹°å¥—é¤å’Œæ‰¹é‡æŠ˜æ‰£
- **é™æ—¶å•†åº—**ï¼šæ´»åŠ¨å•†åº—å’ŒèŠ‚æ—¥å•†åº—
- **VIP ç³»ç»Ÿ**ï¼šä¼šå‘˜ä»·æ ¼å’Œä¸“å±å•†å“

### Phase 5: ç¤¾äº¤åŠŸèƒ½
- **ç©å®¶å•†åº—**ï¼šç©å®¶é—´äº¤æ˜“
- **æ‹å–è¡Œ**ï¼šç‰©å“æ‹å–ç³»ç»Ÿ
- **äº¤æ˜“ç¨**ï¼šç»æµè°ƒæ§æœºåˆ¶

### Phase 6: é«˜çº§åˆ†æ
- **æ¨èç³»ç»Ÿ**ï¼šåŸºäºè´­ä¹°å†å²æ¨èå•†å“
- **åŠ¨æ€å®šä»·**ï¼šæ ¹æ®å¸‚åœºä¾›éœ€è°ƒæ•´ä»·æ ¼
- **ç»æµæŠ¥è¡¨**ï¼šè¯¦ç»†çš„ç»æµæ•°æ®åˆ†æ

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [å•†åº—ç³»ç»Ÿé…ç½®åŒ–æ€»ç»“](./å•†åº—ç³»ç»Ÿé…ç½®åŒ–æ€»ç»“.md)
- [å•†åº—ç³»ç»Ÿä¼˜åŒ–å®Œæˆæ€»ç»“](./å•†åº—ç³»ç»Ÿä¼˜åŒ–å®Œæˆæ€»ç»“.md)
- [å•†åº—ç³»ç»Ÿ Phase 2 - å®Œå…¨é…ç½®åŒ–æ”¹è¿›æŠ¥å‘Š](./å•†åº—ç³»ç»ŸPhase2-å®Œå…¨é…ç½®åŒ–æ”¹è¿›æŠ¥å‘Š.md)
- [å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸Šï¼‰](./å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸Šï¼‰.md)
- [å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ï¼‰](./å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ï¼‰.md)
- [å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ï¼‰](./å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ï¼‰.md)

---

**æ–‡æ¡£çŠ¶æ€**: ğŸ“‹ è®¡åˆ’ä¸­  
**ä¸‹ä¸€æ­¥**: è¯„å®¡è®¡åˆ’å¹¶å¯åŠ¨å®æ–½

**åˆ›å»ºè€…**: å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-13
