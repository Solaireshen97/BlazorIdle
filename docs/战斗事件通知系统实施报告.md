# 战斗事件通知系统实施报告

## 概述

本文档描述了新增的战斗事件通知系统的实施详情。该系统为前端提供详细的战斗消息通知，包括攻击开始、伤害造成、伤害接收等事件信息。

## 需求背景

用户希望在前端界面上显示详细的战斗事件信息，例如：
- 角色XX开始攻击XX
- 角色对XX造成XX伤害
- 角色收到XX多少伤害

要求：
1. 参数需要设置到单独的配置文件中，不要写死在代码中
2. 考虑以后的可拓展性
3. 维持现有的代码风格

## 系统架构

### 1. 新增事件 DTO（数据传输对象）

#### 文件：`BlazorIdle.Shared/Models/BattleNotifications.cs`

新增了三个战斗事件 DTO 类：

**AttackStartEventDto - 攻击开始事件**
```csharp
public sealed class AttackStartEventDto : BattleEventDto
{
    public string AttackerName { get; set; }      // 攻击者名称
    public string AttackerType { get; set; }      // 攻击者类型（Player/Enemy）
    public string TargetName { get; set; }        // 目标名称
    public string TargetType { get; set; }        // 目标类型（Player/Enemy）
    public string AttackType { get; set; }        // 攻击类型（basic_attack/skill）
}
```

**DamageDealtEventDto - 伤害造成事件**
```csharp
public sealed class DamageDealtEventDto : BattleEventDto
{
    public string AttackerName { get; set; }      // 攻击者名称
    public string TargetName { get; set; }        // 目标名称
    public int Damage { get; set; }               // 伤害值
    public bool IsCrit { get; set; }              // 是否暴击
    public string DamageType { get; set; }        // 伤害类型（Physical/Magic/True）
    public int TargetCurrentHp { get; set; }      // 目标剩余血量
    public int TargetMaxHp { get; set; }          // 目标最大血量
}
```

**DamageReceivedEventDto - 受到伤害事件**
```csharp
public sealed class DamageReceivedEventDto : BattleEventDto
{
    public string ReceiverName { get; set; }      // 接收者名称
    public string AttackerName { get; set; }      // 攻击者名称
    public int Damage { get; set; }               // 受到的伤害值
    public string DamageType { get; set; }        // 伤害类型
    public int CurrentHp { get; set; }            // 接收者剩余血量
    public int MaxHp { get; set; }                // 接收者最大血量
}
```

### 2. 配置系统

#### 2.1 配置类定义

**文件：`BlazorIdle.Server/Config/BattleEventsOptions.cs`**

```csharp
public sealed class BattleEventsOptions
{
    public bool EnableBattleEventMessages { get; set; } = true;
    public BattleEventMessages Messages { get; set; }
    public Dictionary<string, string> DamageTypeNames { get; set; }
}

public sealed class AttackStartMessages
{
    public bool Enabled { get; set; } = true;
    public string PlayerAttacksEnemy { get; set; }  // 玩家攻击敌人消息模板
    public string EnemyAttacksPlayer { get; set; }  // 敌人攻击玩家消息模板
}

public sealed class DamageDealtMessages
{
    public bool Enabled { get; set; } = true;
    public string Normal { get; set; }              // 普通伤害消息模板
    public string Critical { get; set; }            // 暴击伤害消息模板
}

public sealed class DamageReceivedMessages
{
    public bool Enabled { get; set; } = true;
    public string Player { get; set; }              // 玩家受到伤害消息模板
    public string Enemy { get; set; }               // 敌人受到伤害消息模板
}
```

#### 2.2 配置文件

**文件：`BlazorIdle.Server/Config/BattleEvents/battle-events-config.json`**

```json
{
  "EnableBattleEventMessages": true,
  "Messages": {
    "AttackStart": {
      "Enabled": true,
      "PlayerAttacksEnemy": "{attacker} 开始攻击 {target}",
      "EnemyAttacksPlayer": "{attacker} 向 {target} 发起攻击"
    },
    "DamageDealt": {
      "Enabled": true,
      "Normal": "{attacker} 对 {target} 造成 {damage} 点{damageType}伤害",
      "Critical": "{attacker} 对 {target} 造成 {damage} 点{damageType}暴击伤害！"
    },
    "DamageReceived": {
      "Enabled": true,
      "Player": "{receiver} 受到 {attacker} 的 {damage} 点{damageType}伤害（剩余 {currentHp}/{maxHp}）",
      "Enemy": "{receiver} 受到 {damage} 点{damageType}伤害（剩余 {currentHp}/{maxHp}）"
    }
  },
  "DamageTypeNames": {
    "Physical": "物理",
    "Magic": "魔法",
    "True": "真实"
  }
}
```

**支持的占位符：**
- `{attacker}` - 攻击者名称
- `{target}` - 目标名称
- `{receiver}` - 接收者名称
- `{damage}` - 伤害值
- `{damageType}` - 伤害类型（会自动翻译为中文）
- `{currentHp}` - 当前血量
- `{maxHp}` - 最大血量

### 3. 消息格式化服务

**文件：`BlazorIdle.Server/Services/BattleEventMessageFormatter.cs`**

提供了消息格式化的核心功能：

```csharp
public sealed class BattleEventMessageFormatter
{
    // 创建攻击开始事件
    public AttackStartEventDto CreateAttackStartEvent(...)
    
    // 创建伤害造成事件
    public DamageDealtEventDto CreateDamageDealtEvent(...)
    
    // 创建受到伤害事件
    public DamageReceivedEventDto CreateDamageReceivedEvent(...)
    
    // 格式化攻击开始消息
    public string FormatAttackStartMessage(AttackStartEventDto evt)
    
    // 格式化伤害造成消息
    public string FormatDamageDealtMessage(DamageDealtEventDto evt)
    
    // 格式化受到伤害消息
    public string FormatDamageReceivedMessage(DamageReceivedEventDto evt, bool isPlayer)
}
```

### 4. SignalR 配置更新

#### 4.1 SignalROptions 扩展

**文件：`BlazorIdle.Server/Config/SignalROptions.cs`**

在 `NotificationOptions` 类中新增：

```csharp
public bool EnableAttackStartNotification { get; set; } = true;
public bool EnableDamageDealtNotification { get; set; } = true;
public bool EnableDamageReceivedNotification { get; set; } = true;
```

#### 4.2 SignalR 配置文件更新

**文件：`BlazorIdle.Server/Config/SignalR/signalr-config.json`**

在 `Notification` 节点中新增：

```json
"EnableAttackStartNotification": true,
"EnableDamageDealtNotification": true,
"EnableDamageReceivedNotification": true
```

#### 4.3 BattleNotificationService 更新

**文件：`BlazorIdle.Server/Services/BattleNotificationService.cs`**

在 `IsEventTypeEnabled` 方法中新增事件类型检查：

```csharp
"AttackStart" => _options.Notification.EnableAttackStartNotification,
"DamageDealt" => _options.Notification.EnableDamageDealtNotification,
"DamageReceived" => _options.Notification.EnableDamageReceivedNotification,
```

### 5. 战斗事件集成

#### 5.1 玩家攻击事件（AttackTickEvent）

**文件：`BlazorIdle.Server/Domain/Combat/AttackTickEvent.cs`**

在玩家攻击执行时，发送以下事件：

1. **攻击开始事件**（在伤害计算前）
```csharp
var attackStartDto = new AttackStartEventDto
{
    BattleId = context.Battle.Id,
    EventTime = ExecuteAt,
    EventType = "AttackStart",
    AttackerName = context.Player.Name,
    AttackerType = "Player",
    TargetName = target.Name,
    TargetType = "Enemy",
    AttackType = "basic_attack"
};
_ = context.NotificationService.NotifyEventAsync(context.Battle.Id, attackStartDto);
```

2. **伤害造成事件**（在伤害应用后）
```csharp
var damageDealtDto = new DamageDealtEventDto
{
    BattleId = context.Battle.Id,
    EventTime = ExecuteAt,
    EventType = "DamageDealt",
    AttackerName = context.Player.Name,
    TargetName = enemyTarget.Name,
    Damage = finalDamage,
    IsCrit = isCrit,
    DamageType = "Physical",
    TargetCurrentHp = enemyTarget.CurrentHp,
    TargetMaxHp = enemyTarget.MaxHp
};
_ = context.NotificationService.NotifyEventAsync(context.Battle.Id, damageDealtDto);
```

#### 5.2 敌人攻击事件（EnemyAttackEvent）

**文件：`BlazorIdle.Server/Domain/Combat/EnemyAttackEvent.cs`**

在敌人攻击执行时，发送以下事件：

1. **攻击开始事件**
2. **伤害造成事件**
3. **伤害接收事件**（特有，因为玩家受到伤害）

```csharp
// 伤害接收事件
var damageReceivedDto = new DamageReceivedEventDto
{
    BattleId = context.Battle.Id,
    EventTime = ExecuteAt,
    EventType = "DamageReceived",
    ReceiverName = context.Player.Name,
    AttackerName = Enemy.Name,
    Damage = actualDamage,
    DamageType = damageType.ToString(),
    CurrentHp = context.Player.CurrentHp,
    MaxHp = context.Player.MaxHp
};
_ = context.NotificationService.NotifyEventAsync(context.Battle.Id, damageReceivedDto);
```

## 单元测试

**文件：`tests/BlazorIdle.Tests/BattleEventNotificationTests.cs`**

创建了全面的单元测试，覆盖以下场景：

### 测试用例（共9个，全部通过）

1. **PlayerAttack_ShouldSendAttackStartEvent** - 测试玩家攻击发送攻击开始事件
2. **EnemyAttack_ShouldSendAttackStartEvent** - 测试敌人攻击发送攻击开始事件
3. **PlayerAttack_ShouldSendDamageDealtEvent** - 测试玩家攻击发送伤害造成事件
4. **EnemyAttack_ShouldSendDamageDealtEvent** - 测试敌人攻击发送伤害造成事件
5. **EnemyAttack_ShouldSendDamageReceivedEvent** - 测试敌人攻击发送伤害接收事件
6. **MessageFormatter_ShouldFormatAttackStartMessage** - 测试攻击开始消息格式化
7. **MessageFormatter_ShouldFormatDamageDealtMessage** - 测试伤害造成消息格式化
8. **MessageFormatter_ShouldFormatCriticalDamageMessage** - 测试暴击伤害消息格式化
9. **MessageFormatter_ShouldFormatDamageReceivedMessage** - 测试受到伤害消息格式化

### 测试结果
```
Test Run Successful.
Total tests: 9
     Passed: 9
 Total time: 0.9316 Seconds
```

## 使用指南

### 1. 自定义消息模板

修改 `BlazorIdle.Server/Config/BattleEvents/battle-events-config.json` 文件：

```json
{
  "Messages": {
    "AttackStart": {
      "PlayerAttacksEnemy": "【战斗】{attacker} 发起进攻，目标：{target}"
    }
  }
}
```

### 2. 禁用特定事件类型

在配置文件中设置 `Enabled` 为 `false`：

```json
{
  "Messages": {
    "AttackStart": {
      "Enabled": false
    }
  }
}
```

或在 SignalR 配置中禁用：

```json
{
  "Notification": {
    "EnableAttackStartNotification": false
  }
}
```

### 3. 自定义伤害类型名称

修改 `DamageTypeNames` 映射：

```json
{
  "DamageTypeNames": {
    "Physical": "物理",
    "Magic": "魔法",
    "True": "真实",
    "Fire": "火焰",
    "Ice": "冰霜"
  }
}
```

## 可扩展性设计

### 1. 添加新的事件类型

**步骤1：定义新的 DTO**

在 `BattleNotifications.cs` 中添加：

```csharp
public sealed class NewEventDto : BattleEventDto
{
    public string CustomField { get; set; }
}
```

**步骤2：添加配置类**

在 `BattleEventsOptions.cs` 中添加：

```csharp
public sealed class NewEventMessages
{
    public bool Enabled { get; set; } = true;
    public string Template { get; set; } = "{custom}";
}
```

**步骤3：添加到配置文件**

在 `battle-events-config.json` 中添加：

```json
{
  "Messages": {
    "NewEvent": {
      "Enabled": true,
      "Template": "新事件：{custom}"
    }
  }
}
```

**步骤4：在事件触发点发送通知**

```csharp
var newEventDto = new NewEventDto
{
    BattleId = context.Battle.Id,
    EventTime = now,
    EventType = "NewEvent",
    CustomField = "value"
};
_ = context.NotificationService.NotifyEventAsync(context.Battle.Id, newEventDto);
```

### 2. 扩展消息格式化器

在 `BattleEventMessageFormatter` 中添加新的格式化方法：

```csharp
public string FormatNewEventMessage(NewEventDto evt)
{
    return _options.Messages.NewEvent.Template
        .Replace("{custom}", evt.CustomField);
}
```

## 技术特点

### 1. 完全配置化 ✅
- 所有消息模板都在配置文件中定义
- 支持运行时配置重载
- 无需重新编译即可修改消息内容

### 2. 高可扩展性 ✅
- 清晰的接口设计
- 模块化的事件系统
- 易于添加新的事件类型

### 3. 向后兼容 ✅
- 不影响现有的战斗逻辑
- 可独立启用/禁用每种事件类型
- 保持现有代码风格

### 4. 性能优化 ✅
- 异步通知（使用 `_ = Task` 不等待）
- 配置驱动的事件过滤
- 避免不必要的消息生成

### 5. 易于测试 ✅
- Mock 友好的设计
- 全面的单元测试覆盖
- 清晰的依赖注入

## 文件清单

### 新增文件（4个）
1. `BlazorIdle.Server/Config/BattleEvents/battle-events-config.json` - 战斗事件配置文件
2. `BlazorIdle.Server/Config/BattleEventsOptions.cs` - 战斗事件配置类
3. `BlazorIdle.Server/Services/BattleEventMessageFormatter.cs` - 消息格式化服务
4. `tests/BlazorIdle.Tests/BattleEventNotificationTests.cs` - 单元测试

### 修改文件（6个）
1. `BlazorIdle.Shared/Models/BattleNotifications.cs` - 新增3个事件DTO
2. `BlazorIdle.Server/Config/SignalROptions.cs` - 新增3个通知开关
3. `BlazorIdle.Server/Config/SignalR/signalr-config.json` - 更新配置
4. `BlazorIdle.Server/Services/BattleNotificationService.cs` - 添加事件类型检查
5. `BlazorIdle.Server/Domain/Combat/AttackTickEvent.cs` - 集成事件通知
6. `BlazorIdle.Server/Domain/Combat/EnemyAttackEvent.cs` - 集成事件通知

## 代码统计

- **新增代码**：约 500 行
- **测试代码**：约 400 行
- **配置文件**：约 50 行
- **测试/代码比**：约 1:1.25

## 下一步建议

1. **前端集成**
   - 在前端添加战斗日志组件
   - 显示格式化后的战斗消息
   - 支持消息过滤和搜索

2. **增强功能**
   - 添加技能施放事件
   - 添加Buff生效/失效事件
   - 添加波次刷新事件

3. **国际化支持**
   - 支持多语言消息模板
   - 基于用户语言设置选择模板

4. **性能监控**
   - 统计事件发送频率
   - 监控通知服务性能
   - 优化高频事件的处理

## 总结

本次实施成功地为战斗系统添加了详细的事件通知功能，满足了以下要求：

✅ **参数配置化**：所有消息模板都在配置文件中定义，支持灵活定制  
✅ **高可扩展性**：清晰的架构设计，易于添加新的事件类型  
✅ **代码风格一致**：遵循现有的代码规范和架构模式  
✅ **完整测试覆盖**：9个单元测试全部通过，确保功能正确性  
✅ **向后兼容**：不影响现有功能，可独立启用/禁用

该系统为前端提供了丰富的战斗信息，为玩家带来更好的游戏体验。
