# BlazorIdle SignalR实时通知功能验收文档

**文档版本**: 1.0  
**创建日期**: 2025-10-13  
**状态**: 验收标准  
**关联文档**: [SignalR实时通知集成方案.md](./SignalR实时通知集成方案.md)

---

## 📋 验收概览

本文档定义了SignalR实时通知功能的详细验收标准，分为三个阶段：

- **Phase 1**（必须）：核心事件推送 - 玩家死亡/复活、波次完成、Boss出现
- **Phase 2**（可选）：批量事件聚合 - 优化高频事件推送
- **Phase 3**（可选）：细化通知内容 - 减少前端抓取次数

---

## 1. Phase 1 验收标准（核心功能）

### 1.1 功能验收清单

| ID | 验收项 | 测试步骤 | 预期结果 | 优先级 |
|----|-------|---------|---------|--------|
| **F1-01** | 玩家死亡实时通知 | 1. 启动战斗<br>2. 等待玩家血量降至0<br>3. 观察前端反应时间 | • SignalR通知到达时间<100ms<br>• 进度条立即停止<br>• UI显示死亡状态<br>• 显示复活倒计时 | ⭐⭐⭐ |
| **F1-02** | 玩家复活实时通知 | 1. 玩家死亡后<br>2. 等待复活时间<br>3. 观察复活瞬间 | • 复活瞬间前端收到通知<br>• 进度条立即恢复<br>• UI更新为战斗状态 | ⭐⭐⭐ |
| **F1-03** | 波次完成实时通知 | 1. 地下城模式战斗<br>2. 击杀最后一个怪物<br>3. 观察波次切换 | • 最后怪物死亡时立即收到通知<br>• UI显示波次切换动画<br>• 显示新波次信息 | ⭐⭐⭐ |
| **F1-04** | Boss出现实时通知 | 1. 地下城Boss波次<br>2. 观察Boss出现时刻 | • Boss出现时立即收到通知<br>• 显示Boss警告提示<br>• UI突出显示Boss信息 | ⭐⭐⭐ |
| **F1-05** | 副本完成实时通知 | 1. 完成最后一个波次<br>2. 观察完成提示 | • 立即收到副本完成通知<br>• 显示奖励统计<br>• 停止战斗动画 | ⭐⭐⭐ |
| **F1-06** | SignalR连接建立 | 1. 刷新页面<br>2. 观察连接建立时间 | • 1秒内建立WebSocket连接<br>• 控制台显示连接成功日志 | ⭐⭐⭐ |
| **F1-07** | 战斗订阅机制 | 1. 启动战斗<br>2. 检查订阅状态<br>3. 触发事件验证 | • 战斗启动后成功订阅<br>• 能够接收该战斗的通知<br>• 不接收其他战斗的通知 | ⭐⭐⭐ |
| **F1-08** | 降级到轮询 | 1. 禁用SignalR服务<br>2. 启动战斗<br>3. 验证功能正常 | • 自动检测SignalR不可用<br>• 降级到轮询模式<br>• 所有功能正常工作<br>• 显示提示信息 | ⭐⭐⭐ |
| **F1-09** | 自动重连机制 | 1. 建立连接后<br>2. 模拟网络中断30秒<br>3. 恢复网络 | • 自动尝试重连<br>• 30秒内重连成功<br>• 重连后恢复订阅<br>• 继续接收通知 | ⭐⭐ |
| **F1-10** | 多战斗并发 | 1. 同时启动2个战斗<br>2. 触发各自的事件<br>3. 验证通知隔离 | • 每个战斗独立订阅<br>• 通知不混乱<br>• 能够正确识别来源 | ⭐⭐ |

### 1.2 性能验收清单

| ID | 指标 | 测试方法 | 目标值 | 测量工具 |
|----|------|---------|--------|---------|
| **P1-01** | 通知延迟 | 事件发生时间戳 vs 前端接收时间戳 | < 200ms (P95) | Performance API |
| **P1-02** | 连接建立时间 | 页面加载到连接成功 | < 1秒 | console.time() |
| **P1-03** | 重连时间 | 断开连接到重连成功 | < 30秒 | SignalR日志 |
| **P1-04** | 服务端CPU增量 | 启用SignalR前后CPU使用率对比 | < 5%增量 | 系统监控 |
| **P1-05** | 服务端内存增量 | 1000并发连接的内存占用 | < 100MB | 性能测试工具 |
| **P1-06** | 消息丢失率 | 发送1000条消息，统计接收数 | < 0.1% | 自动化测试脚本 |
| **P1-07** | UI响应时间 | 收到通知到UI更新完成 | < 50ms | React DevTools / Blazor性能分析 |

### 1.3 兼容性验收清单

| ID | 验收项 | 测试场景 | 预期结果 |
|----|-------|---------|---------|
| **C1-01** | 轮询机制不受影响 | 禁用SignalR，使用纯轮询 | 所有功能正常，无回归问题 |
| **C1-02** | 旧客户端兼容 | 使用不含SignalR代码的旧版前端 | 能够正常使用，降级到轮询 |
| **C1-03** | 数据库兼容 | 检查数据库表结构 | 无新增表或字段修改 |
| **C1-04** | REST API兼容 | 调用现有API接口 | 接口签名和行为不变 |
| **C1-05** | WebSocket降级 | 在不支持WebSocket的环境测试 | 自动降级到LongPolling或轮询 |

### 1.4 健壮性验收清单

| ID | 场景 | 操作步骤 | 预期行为 | 验证点 |
|----|------|---------|---------|--------|
| **R1-01** | SignalR服务崩溃 | 1. 战斗进行中<br>2. 停止SignalR服务<br>3. 观察前端行为 | • 前端检测到连接断开<br>• 自动降级到轮询<br>• 用户无明显感知<br>• 战斗继续正常 | 日志中记录降级事件 |
| **R1-02** | 网络间歇性中断 | 1. 建立连接<br>2. 间歇性断网（每10秒断5秒）<br>3. 持续5分钟 | • 每次中断后尝试重连<br>• 重连后恢复订阅<br>• 通知能够继续接收 | 重连日志完整 |
| **R1-03** | 大量并发连接 | 使用压测工具模拟1000个客户端同时连接 | • 服务器正常响应<br>• 不发生崩溃<br>• 响应时间在可接受范围 | 监控所有请求成功 |
| **R1-04** | 无效战斗ID订阅 | 尝试订阅不存在的战斗ID | • 返回HubException<br>• 前端捕获异常<br>• 不影响其他功能 | 错误日志记录 |
| **R1-05** | 未认证用户连接 | 不带认证令牌尝试连接 | • 连接被拒绝<br>• 返回401错误 | 安全日志记录 |
| **R1-06** | 跨用户订阅攻击 | 用户A尝试订阅用户B的战斗 | • 订阅被拒绝<br>• 返回HubException<br>• 记录安全警告 | 安全审计日志 |

### 1.5 用户体验验收清单

| ID | 场景 | 体验描述 | 验收标准 | 测试方法 |
|----|------|---------|---------|---------|
| **UX1-01** | 玩家死亡瞬间 | 进度条立即停止，显示死亡动画，无延迟感 | • 用户感知延迟<500ms<br>• 视觉反馈清晰<br>• 无卡顿现象 | 用户观察+录屏分析 |
| **UX1-02** | 波次切换 | 立即显示新波次信息，过渡流畅 | • 切换流畅无卡顿<br>• 信息更新及时<br>• 动画自然 | 用户体验测试 |
| **UX1-03** | Boss出现 | 立即显示警告，视觉突出 | • Boss警告明显<br>• 音效提示（可选）<br>• UI样式突出 | 用户反馈 |
| **UX1-04** | 网络不稳定提示 | 降级时显示友好提示 | • 提示信息清晰<br>• 不干扰游戏<br>• 可关闭 | Toast通知测试 |
| **UX1-05** | 正常战斗流畅度 | 进度条预测与实际同步 | • 进度条流畅推进<br>• 轮询与SignalR配合无缝<br>• 无跳跃或回退 | 长时间观察测试 |

---

## 2. Phase 2 验收标准（批量优化）

### 2.1 功能验收清单

| ID | 验收项 | 测试步骤 | 预期结果 | 优先级 |
|----|-------|---------|---------|--------|
| **F2-01** | 批量击杀通知 | 1. 快速击杀10个怪物<br>2. 观察通知频率 | • 5秒内的击杀聚合为一条消息<br>• 消息包含所有击杀信息<br>• 前端正确解析批量数据 | ⭐⭐ |
| **F2-02** | 目标切换通知 | 1. 多怪物战斗<br>2. 观察目标切换 | • 目标切换时收到通知<br>• UI更新当前目标高亮<br>• 通知包含新旧目标信息 | ⭐⭐ |
| **F2-03** | 批量Buff变化 | 1. 触发多个Buff<br>2. 观察通知 | • Buff变化聚合推送<br>• 前端批量更新Buff显示 | ⭐ |

### 2.2 性能验收清单

| ID | 指标 | 测试方法 | 目标值 |
|----|------|---------|--------|
| **P2-01** | 消息频率降低 | 对比启用批量前后的消息数 | 消息数减少50%以上 |
| **P2-02** | 聚合延迟 | 事件发生到批量推送的延迟 | < 5秒（配置值） |
| **P2-03** | 批量处理性能 | 前端处理批量消息的时间 | < 100ms (100条记录) |

---

## 3. Phase 3 验收标准（深度集成）

### 3.1 功能验收清单

| ID | 验收项 | 测试步骤 | 预期结果 | 优先级 |
|----|-------|---------|---------|--------|
| **F3-01** | 富通知模型 | 1. 触发死亡事件<br>2. 检查通知内容 | • 通知包含死亡原因<br>• 包含复活倒计时<br>• 包含死亡位置等元数据 | ⭐⭐ |
| **F3-02** | 波次详情推送 | 1. 波次切换<br>2. 检查通知内容 | • 包含下一波怪物信息<br>• 包含是否Boss波次标识<br>• 包含预计战斗时间 | ⭐⭐ |
| **F3-03** | 智能抓取策略 | 1. 接收各类通知<br>2. 监控抓取次数 | • 非关键事件不触发抓取<br>• 关键事件仅抓取必要数据<br>• 抓取次数减少60% | ⭐⭐ |

### 3.2 性能验收清单

| ID | 指标 | 测试方法 | 目标值 |
|----|------|---------|--------|
| **P3-01** | 前端抓取次数 | 统计GetStatus调用次数 | 比Phase 1减少60% |
| **P3-02** | 网络流量 | 监控前端网络流量 | 减少40%以上 |
| **P3-03** | 通知包大小 | 测量富通知的数据量 | < 5KB per notification |

---

## 4. 测试执行指南

### 4.1 测试环境要求

| 组件 | 要求 |
|-----|------|
| 服务端 | ASP.NET Core 6.0+, SignalR已配置 |
| 前端 | Blazor WebAssembly, SignalR客户端包 |
| 浏览器 | Chrome 90+, Firefox 88+, Edge 90+ (支持WebSocket) |
| 网络 | 至少10Mbps，延迟<50ms（本地测试） |
| 测试工具 | Postman（API测试）, Chrome DevTools（性能分析）, JMeter（压测） |

### 4.2 测试执行流程

```
阶段1: 单元测试
  ├─ 运行服务端单元测试套件
  ├─ 运行前端单元测试套件
  └─ 确保覆盖率 > 80%

阶段2: 集成测试
  ├─ 端到端场景测试
  ├─ 跨模块集成测试
  └─ 异常场景测试

阶段3: 性能测试
  ├─ 压力测试（1000并发）
  ├─ 延迟测试
  └─ 长时间稳定性测试（24小时）

阶段4: 用户验收测试
  ├─ 真实用户场景模拟
  ├─ 用户体验评分
  └─ 问题反馈收集

阶段5: 生产验证
  ├─ 灰度发布（10%用户）
  ├─ 监控关键指标
  └─ 逐步扩大到100%
```

### 4.3 测试数据准备

| 数据类型 | 准备内容 |
|---------|---------|
| 测试用户 | 创建10个测试账号，各有不同等级和装备 |
| 测试战斗 | 准备各类战斗场景：普通战斗、Boss战、地下城 |
| 测试怪物 | 配置不同血量和攻击力的怪物 |
| 网络环境 | 准备模拟各种网络条件的工具 |

---

## 5. 缺陷分级标准

### 5.1 严重程度分级

| 级别 | 定义 | 示例 | 处理时限 |
|-----|------|------|---------|
| **P0 - 阻塞** | 核心功能完全不可用 | SignalR服务启动失败导致应用崩溃 | 立即修复 |
| **P1 - 严重** | 核心功能部分不可用或严重影响用户体验 | 死亡通知未推送导致进度条不停止 | 24小时内修复 |
| **P2 - 一般** | 非核心功能异常或用户体验受影响 | 重连日志过多影响性能 | 3天内修复 |
| **P3 - 轻微** | 小问题，不影响使用 | 日志消息格式不规范 | 下个版本修复 |

### 5.2 缺陷记录模板

```markdown
### 缺陷标题

**缺陷ID**: BUG-SIGNALR-XXX  
**发现时间**: YYYY-MM-DD  
**发现人**: XXX  
**严重程度**: P1  
**状态**: 待修复

**复现步骤**:
1. 步骤1
2. 步骤2
3. 步骤3

**预期结果**:
XXX

**实际结果**:
XXX

**环境信息**:
- 浏览器: Chrome 120
- 操作系统: Windows 11
- 服务端版本: v1.0.0

**附件**:
- 截图
- 日志文件
- 视频录屏
```

---

## 6. 验收签字表

### Phase 1 验收签字

| 角色 | 姓名 | 验收日期 | 签名 | 备注 |
|-----|------|---------|------|------|
| 产品负责人 |  |  |  |  |
| 技术负责人 |  |  |  |  |
| 测试负责人 |  |  |  |  |
| 前端开发 |  |  |  |  |
| 后端开发 |  |  |  |  |

**验收结论**:
- [ ] 通过，可以上线
- [ ] 有条件通过（列出遗留问题）
- [ ] 不通过（列出阻塞问题）

**遗留问题清单**:
1. 
2. 
3. 

---

## 7. 附录

### 7.1 测试用例模板

```gherkin
Feature: 玩家死亡实时通知

  Scenario: 正常死亡通知
    Given 用户已登录并启动战斗
    And SignalR连接已建立
    When 玩家血量降至0
    Then 前端在100ms内收到死亡通知
    And 所有进度条立即停止
    And UI显示死亡状态和复活倒计时

  Scenario: SignalR断线时的死亡通知
    Given 用户已登录并启动战斗
    And SignalR连接已断开
    When 玩家血量降至0
    Then 前端通过轮询获知死亡（延迟1-2秒）
    And UI最终显示正确的死亡状态
```

### 7.2 自动化测试脚本示例

```csharp
[Fact]
public async Task PlayerDeath_ShouldSendSignalRNotification()
{
    // Arrange
    var hubContext = Mock.Of<IHubContext<BattleHub>>();
    var notificationService = new BattleNotificationService(hubContext, logger);
    var battleId = Guid.NewGuid();
    
    // Act
    await notificationService.NotifyBattleEventAsync(
        battleId, 
        "PlayerDeath", 
        new { deathTime = 10.5 }
    );
    
    // Assert
    Mock.Get(hubContext.Clients)
        .Verify(c => c.Group($"Battle_{battleId}"), Times.Once);
}
```

### 7.3 性能测试脚本示例

```javascript
// JMeter HTTP请求采样器 - SignalR连接测试
// 或使用 Artillery 配置
config:
  target: 'https://your-server.com'
  phases:
    - duration: 60
      arrivalRate: 10
      name: "Warm up"
    - duration: 300
      arrivalRate: 50
      name: "Sustained load"

scenarios:
  - name: "SignalR Connection Test"
    engine: "ws"
    flow:
      - connect:
          url: "/battleHub"
      - think: 2
      - send:
          payload: '{"protocol":"json","version":1}'
      - think: 10
      - close
```

---

## 文档修订历史

| 版本 | 日期 | 修订内容 | 修订人 |
|-----|------|---------|--------|
| 1.0 | 2025-10-13 | 初始版本 | 系统分析 |

---

**验收文档结束**

本文档作为SignalR实时通知功能的正式验收依据，所有验收项必须通过后方可上线。Phase 1为强制要求，Phase 2-3为可选增强功能。
