# æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025-10-14  
**çŠ¶æ€**: å·²å®Œæˆ

---

## ğŸ“‹ æ¦‚è¿°

æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¯é…ç½®çš„äº‹ä»¶é€šçŸ¥ç³»ç»Ÿï¼Œç”¨äºå‘å‰ç«¯å®æ—¶ä¼ è¾“æˆ˜æ–—è¿‡ç¨‹ä¸­çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ”»å‡»å¼€å§‹ã€é€ æˆä¼¤å®³ã€å—åˆ°ä¼¤å®³ç­‰äº‹ä»¶ï¼Œå¹¶é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†æ¶ˆæ¯æ¨¡æ¿ï¼Œæ”¯æŒçµæ´»çš„å›½é™…åŒ–å’Œè‡ªå®šä¹‰ã€‚

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

1. **æ”»å‡»å¼€å§‹äº‹ä»¶** - æ˜¾ç¤º"è§’è‰² XX å¼€å§‹æ”»å‡» XX"
2. **ä¼¤å®³é€ æˆäº‹ä»¶** - æ˜¾ç¤º"è§’è‰²å¯¹ XX é€ æˆ XX ä¼¤å®³ï¼ˆæš´å‡»ï¼‰"
3. **ä¼¤å®³æ¥æ”¶äº‹ä»¶** - æ˜¾ç¤º"è§’è‰²å—åˆ°æ¥è‡ª XX çš„ XX ä¼¤å®³"
4. **æ•Œäººæ”»å‡»äº‹ä»¶** - æ˜¾ç¤º"æ•Œäºº XX å¼€å§‹æ”»å‡»ç©å®¶"

### è®¾è®¡ç‰¹ç‚¹

- **é…ç½®åŒ–æ¶ˆæ¯æ¨¡æ¿** - æ‰€æœ‰æ¶ˆæ¯æ ¼å¼å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä¸ç¡¬ç¼–ç 
- **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹å’Œæ¶ˆæ¯æ¨¡æ¿
- **å¼€å…³æ§åˆ¶** - æ¯ç§äº‹ä»¶ç±»å‹éƒ½å¯ä»¥ç‹¬ç«‹å¯ç”¨æˆ–ç¦ç”¨
- **å›½é™…åŒ–æ”¯æŒ** - æ¶ˆæ¯æ¨¡æ¿å¯ä»¥æ ¹æ®è¯­è¨€é…ç½®æ›´æ”¹
- **æ€§èƒ½ä¼˜åŒ–** - å¯é€‰çš„äº‹ä»¶èŠ‚æµå’Œæ‰¹å¤„ç†æ”¯æŒ

---

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### é…ç½®æ¶ˆæ¯æ¨¡æ¿

åœ¨ `appsettings.json` ä¸­é…ç½®æˆ˜æ–—æ¶ˆæ¯ï¼š

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
    "DamageDealtTemplate": "{attacker} å¯¹ {target} é€ æˆ {damage} ç‚¹ä¼¤å®³{critSuffix}",
    "CritSuffix": "ï¼ˆæš´å‡»ï¼‰",
    "DamageReceivedTemplate": "{target} å—åˆ°æ¥è‡ª {attacker} çš„ {damage} ç‚¹ä¼¤å®³",
    "EnemyAttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
    "EnableAttackStartedEvent": true,
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true,
    "EnableEnemyAttackStartedEvent": true,
    "PlayerName": "ç©å®¶",
    "MaxMessageHistory": 100
  }
}
```

### æ¨¡æ¿å‚æ•°è¯´æ˜

#### æ”»å‡»å¼€å§‹æ¨¡æ¿å‚æ•°
- `{attacker}` - æ”»å‡»è€…åç§°
- `{target}` - ç›®æ ‡åç§°

#### ä¼¤å®³é€ æˆæ¨¡æ¿å‚æ•°
- `{attacker}` - æ”»å‡»è€…åç§°
- `{target}` - ç›®æ ‡åç§°
- `{damage}` - ä¼¤å®³å€¼
- `{critSuffix}` - æš´å‡»åç¼€ï¼ˆä»…åœ¨æš´å‡»æ—¶æ˜¾ç¤ºï¼‰

#### ä¼¤å®³æ¥æ”¶æ¨¡æ¿å‚æ•°
- `{target}` - å—ä¼¤è€…åç§°
- `{attacker}` - æ”»å‡»è€…åç§°
- `{damage}` - ä¼¤å®³å€¼

### å¯ç”¨/ç¦ç”¨äº‹ä»¶

åœ¨ `appsettings.json` çš„ `SignalR.Notification` èŠ‚ä¸­æ§åˆ¶äº‹ä»¶é€šçŸ¥ï¼š

```json
{
  "SignalR": {
    "Notification": {
      "EnableAttackStartedNotification": true,
      "EnableEnemyAttackStartedNotification": true,
      "EnableDamageReceivedNotification": true,
      "EnableDamageAppliedNotification": false
    }
  }
}
```

**æ³¨æ„**: 
- `BattleMessages` ä¸­çš„ `Enable*Event` æ§åˆ¶æ˜¯å¦ç”Ÿæˆæ¶ˆæ¯
- `SignalR.Notification` ä¸­çš„ `Enable*Notification` æ§åˆ¶æ˜¯å¦å‘é€åˆ°å‰ç«¯
- ä¸¤è€…éƒ½éœ€è¦å¯ç”¨æ‰èƒ½åœ¨å‰ç«¯æ˜¾ç¤ºäº‹ä»¶

---

## ğŸ”§ äº‹ä»¶ç±»å‹è¯¦è§£

### 1. AttackStartedEventDto

**è§¦å‘æ—¶æœº**: ç©å®¶å¼€å§‹æ”»å‡»æ•Œäººæ—¶

**å±æ€§**:
```csharp
public sealed class AttackStartedEventDto : BattleEventDto
{
    public string AttackerName { get; set; }   // æ”»å‡»è€…åç§°
    public string TargetName { get; set; }      // ç›®æ ‡åç§°
    public string Message { get; set; }         // æ ¼å¼åŒ–çš„æ¶ˆæ¯
}
```

**ç¤ºä¾‹æ¶ˆæ¯**: "ç©å®¶ å¼€å§‹æ”»å‡» å²è±å§†"

### 2. DamageAppliedEventDto

**è§¦å‘æ—¶æœº**: ç©å®¶å¯¹æ•Œäººé€ æˆä¼¤å®³æ—¶

**å±æ€§**:
```csharp
public sealed class DamageAppliedEventDto : BattleEventDto
{
    public string Source { get; set; }          // ä¼¤å®³æ¥æºï¼ˆå¦‚ "basic_attack"ï¼‰
    public int Damage { get; set; }             // ä¼¤å®³å€¼
    public bool IsCrit { get; set; }            // æ˜¯å¦æš´å‡»
    public int TargetCurrentHp { get; set; }    // ç›®æ ‡å½“å‰è¡€é‡
    public int TargetMaxHp { get; set; }        // ç›®æ ‡æœ€å¤§è¡€é‡
    public string AttackerName { get; set; }    // æ”»å‡»è€…åç§°
    public string TargetName { get; set; }      // ç›®æ ‡åç§°
    public string Message { get; set; }         // æ ¼å¼åŒ–çš„æ¶ˆæ¯
}
```

**ç¤ºä¾‹æ¶ˆæ¯**: 
- æ™®é€šæ”»å‡»: "ç©å®¶ å¯¹ å“¥å¸ƒæ— é€ æˆ 150 ç‚¹ä¼¤å®³"
- æš´å‡»æ”»å‡»: "ç©å®¶ å¯¹ å“¥å¸ƒæ— é€ æˆ 300 ç‚¹ä¼¤å®³ï¼ˆæš´å‡»ï¼‰"

### 3. DamageReceivedEventDto

**è§¦å‘æ—¶æœº**: ç©å®¶å—åˆ°æ•Œäººæ”»å‡»æ—¶

**å±æ€§**:
```csharp
public sealed class DamageReceivedEventDto : BattleEventDto
{
    public string AttackerName { get; set; }    // æ”»å‡»è€…åç§°
    public string TargetName { get; set; }      // å—ä¼¤è€…åç§°
    public int Damage { get; set; }             // ä¼¤å®³å€¼
    public int TargetCurrentHp { get; set; }    // ç›®æ ‡å½“å‰è¡€é‡
    public int TargetMaxHp { get; set; }        // ç›®æ ‡æœ€å¤§è¡€é‡
    public string Message { get; set; }         // æ ¼å¼åŒ–çš„æ¶ˆæ¯
}
```

**ç¤ºä¾‹æ¶ˆæ¯**: "ç©å®¶ å—åˆ°æ¥è‡ª å“¥å¸ƒæ— çš„ 50 ç‚¹ä¼¤å®³"

### 4. AttackStartedEventDto (æ•Œäººæ”»å‡»)

**è§¦å‘æ—¶æœº**: æ•Œäººå¼€å§‹æ”»å‡»ç©å®¶æ—¶

**EventType**: "EnemyAttackStarted"

**ç¤ºä¾‹æ¶ˆæ¯**: "å“¥å¸ƒæ— å¼€å§‹æ”»å‡» ç©å®¶"

---

## ğŸ¨ å‰ç«¯é›†æˆç¤ºä¾‹

### è®¢é˜…æˆ˜æ–—äº‹ä»¶

```csharp
@inject BattleSignalRService SignalRService

// è®¢é˜…æ‰€æœ‰æˆ˜æ–—äº‹ä»¶
SignalRService.OnBattleEvent((battleId, eventData) =>
{
    if (eventData is AttackStartedEventDto attackEvent)
    {
        DisplayBattleLog(attackEvent.Message);
    }
    else if (eventData is DamageAppliedEventDto damageEvent)
    {
        DisplayBattleLog(damageEvent.Message);
        UpdateHealthBar(damageEvent.TargetCurrentHp, damageEvent.TargetMaxHp);
    }
    else if (eventData is DamageReceivedEventDto receivedEvent)
    {
        DisplayBattleLog(receivedEvent.Message);
        UpdatePlayerHealth(receivedEvent.TargetCurrentHp, receivedEvent.TargetMaxHp);
    }
});
```

### æ˜¾ç¤ºæˆ˜æ–—æ—¥å¿—

```csharp
private List<string> _battleLog = new();

private void DisplayBattleLog(string message)
{
    _battleLog.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
    
    // é™åˆ¶æ—¥å¿—æ•°é‡
    if (_battleLog.Count > 100)
    {
        _battleLog.RemoveAt(0);
    }
    
    StateHasChanged();
}
```

### UI ç¤ºä¾‹

```razor
<div class="battle-log">
    <h4>æˆ˜æ–—æ—¥å¿—</h4>
    <div class="log-content">
        @foreach (var log in _battleLog.TakeLast(20).Reverse())
        {
            <div class="log-entry">@log</div>
        }
    </div>
</div>
```

---

## ğŸ” é«˜çº§é…ç½®

### è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡æ¿

å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼ï¼š

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "âš”ï¸ {attacker} â†’ {target}",
    "DamageDealtTemplate": "ğŸ’¥ {attacker} å¯¹ {target} é€ æˆ {damage} ä¼¤å®³{critSuffix}",
    "CritSuffix": " â­",
    "DamageReceivedTemplate": "ğŸ›¡ï¸ {target} æ‰¿å— {damage} ä¼¤å®³ â† {attacker}"
  }
}
```

### å›½é™…åŒ–æ”¯æŒ

å¯ä»¥ä¸ºä¸åŒè¯­è¨€åˆ›å»ºä¸åŒçš„é…ç½®æ–‡ä»¶ï¼š

**appsettings.zh-CN.json** (ä¸­æ–‡)
```json
{
  "BattleMessages": {
    "PlayerName": "ç©å®¶",
    "AttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}"
  }
}
```

**appsettings.en.json** (è‹±æ–‡)
```json
{
  "BattleMessages": {
    "PlayerName": "Player",
    "AttackStartedTemplate": "{attacker} attacks {target}"
  }
}
```

### æ€§èƒ½ä¼˜åŒ–

å¯¹äºé«˜é¢‘æˆ˜æ–—äº‹ä»¶ï¼Œå¯ä»¥å¯ç”¨èŠ‚æµï¼š

```json
{
  "SignalR": {
    "Performance": {
      "EnableThrottling": true,
      "ThrottleWindowMs": 1000
    }
  }
}
```

---

## ğŸ“Š æµ‹è¯•

ç³»ç»ŸåŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼š

### å•å…ƒæµ‹è¯• (9ä¸ª)
- æ¶ˆæ¯æ¨¡æ¿æ ¼å¼åŒ–æµ‹è¯•
- æš´å‡»åç¼€æµ‹è¯•
- äº‹ä»¶DTOå±æ€§æµ‹è¯•
- é…ç½®è¯»å–æµ‹è¯•

### é›†æˆæµ‹è¯• (4ä¸ª)
- æ”»å‡»å¼€å§‹äº‹ä»¶è§¦å‘æµ‹è¯•
- ä¼¤å®³åº”ç”¨äº‹ä»¶è§¦å‘æµ‹è¯•
- æ•Œäººæ”»å‡»äº‹ä»¶è§¦å‘æµ‹è¯•
- äº‹ä»¶å¼€å…³åŠŸèƒ½æµ‹è¯•

è¿è¡Œæµ‹è¯•ï¼š
```bash
dotnet test --filter "FullyQualifiedName~BattleMessage"
```

---

## ğŸš€ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹

1. **åˆ›å»ºäº‹ä»¶DTO**
   
   åœ¨ `BlazorIdle.Shared/Models/BattleNotifications.cs` ä¸­æ·»åŠ ï¼š
   ```csharp
   public sealed class SkillCastEventDto : BattleEventDto
   {
       public string CasterName { get; set; } = "";
       public string SkillName { get; set; } = "";
       public string Message { get; set; } = "";
   }
   ```

2. **æ·»åŠ é…ç½®é€‰é¡¹**
   
   åœ¨ `BattleMessageOptions.cs` ä¸­æ·»åŠ ï¼š
   ```csharp
   public string SkillCastTemplate { get; set; } = "{caster} æ–½æ”¾äº† {skill}";
   public bool EnableSkillCastEvent { get; set; } = true;
   ```

3. **æ·»åŠ æ ¼å¼åŒ–æ–¹æ³•**
   
   åœ¨ `BattleMessageFormatter.cs` ä¸­æ·»åŠ ï¼š
   ```csharp
   public string FormatSkillCast(string casterName, string skillName)
   {
       return _options.SkillCastTemplate
           .Replace("{caster}", casterName)
           .Replace("{skill}", skillName);
   }
   ```

4. **è§¦å‘äº‹ä»¶**
   
   åœ¨ç›¸åº”çš„æˆ˜æ–—é€»è¾‘ä¸­æ·»åŠ äº‹ä»¶å‘é€ä»£ç ã€‚

5. **æ›´æ–°é…ç½®æ–‡ä»¶**
   
   åœ¨ `appsettings.json` ä¸­æ·»åŠ é…ç½®ã€‚

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **æ¶ˆæ¯ç®€æ´æ€§** - ä¿æŒæ¶ˆæ¯ç®€çŸ­æ˜äº†ï¼Œé€‚åˆåœ¨æˆ˜æ–—æ—¥å¿—ä¸­æ˜¾ç¤º
2. **æ€§èƒ½è€ƒè™‘** - é«˜é¢‘äº‹ä»¶å¯ä»¥è€ƒè™‘å¯ç”¨èŠ‚æµæˆ–æ‰¹å¤„ç†
3. **å¯è¯»æ€§** - ä½¿ç”¨æ¸…æ™°çš„å ä½ç¬¦åç§°ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
4. **æµ‹è¯•è¦†ç›–** - ä¸ºæ–°å¢çš„äº‹ä»¶ç±»å‹æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. **å‘åå…¼å®¹** - æ·»åŠ æ–°é…ç½®é¡¹æ—¶æä¾›åˆç†çš„é»˜è®¤å€¼

---

## ğŸ› æ•…éšœæ’é™¤

### æ¶ˆæ¯ä¸æ˜¾ç¤º

1. æ£€æŸ¥ `BattleMessages` ä¸­çš„ `Enable*Event` æ˜¯å¦ä¸º `true`
2. æ£€æŸ¥ `SignalR.Notification` ä¸­çš„ `Enable*Notification` æ˜¯å¦ä¸º `true`
3. æ£€æŸ¥ SignalR è¿æ¥æ˜¯å¦æ­£å¸¸
4. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤äº‹ä»¶æ˜¯å¦è¢«è§¦å‘

### æ¶ˆæ¯æ ¼å¼é”™è¯¯

1. ç¡®è®¤æ¨¡æ¿ä¸­çš„å ä½ç¬¦åç§°æ­£ç¡®ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
2. æ£€æŸ¥é…ç½®æ–‡ä»¶çš„JSONæ ¼å¼æ˜¯å¦æ­£ç¡®
3. éªŒè¯é…ç½®æ˜¯å¦è¢«æ­£ç¡®åŠ è½½

### æ€§èƒ½é—®é¢˜

1. è€ƒè™‘å¯ç”¨äº‹ä»¶èŠ‚æµ
2. é™åˆ¶å‰ç«¯æ˜¾ç¤ºçš„æ¶ˆæ¯å†å²æ•°é‡
3. å¯¹äºé«˜é¢‘äº‹ä»¶ï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨æŸäº›ä¸é‡è¦çš„äº‹ä»¶ç±»å‹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [SignalRæ‰©å±•å¼€å‘æŒ‡å—](./SignalRæ‰©å±•å¼€å‘æŒ‡å—.md)
- [æˆ˜æ–—ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](./æˆ˜æ–—ç³»ç»ŸPhase4å®ŒæˆæŠ¥å‘Š.md)
- [æ´»åŠ¨è®¡åˆ’å¿«é€Ÿå¼€å§‹](./æ´»åŠ¨è®¡åˆ’å¿«é€Ÿå¼€å§‹.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0 (2025-10-14)
- âœ… å®ç°åŸºç¡€æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿ
- âœ… æ”¯æŒæ”»å‡»å¼€å§‹ã€ä¼¤å®³é€ æˆã€ä¼¤å®³æ¥æ”¶äº‹ä»¶
- âœ… é…ç½®åŒ–æ¶ˆæ¯æ¨¡æ¿
- âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- âœ… æ–‡æ¡£ç¼–å†™å®Œæˆ
