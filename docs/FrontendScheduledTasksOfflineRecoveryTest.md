# 前端计划任务离线恢复功能测试文档

## 概述

本文档描述前端计划任务状态与离线恢复功能的测试流程和验证点。

## 修复内容

### 1. 前端支持暂停状态 (Paused State)

**修改文件**: `BlazorIdle/Pages/Characters.razor`

- 添加对 `State = 4` (Paused) 的显示支持
- 显示状态文本为 "已暂停"，样式类为 "text-info"
- 为暂停的计划添加 "恢复" 和 "取消" 按钮

### 2. 新增恢复计划方法

**修改文件**: `BlazorIdle/Services/ApiClient.cs`, `BlazorIdle/Pages/Characters.razor`

- 添加 `ResumePlanAsync` API 调用方法
- 添加 `ResumePlanResponse` DTO 类型
- 添加前端 `ResumePlanAsync` 方法处理恢复逻辑
- 恢复成功后自动开始轮询战斗状态

### 3. 离线恢复后自动重启轮询

**修改文件**: `BlazorIdle/Pages/Characters.razor`

- `CheckOfflineRewardsAsync`: 离线结算后检测是否需要重启轮询
  - 如果下一个计划已启动，自动开始轮询新计划
  - 如果当前计划未完成但正在运行，恢复轮询当前计划
- `UpdateHeartbeatIfNeededAsync`: 心跳更新时同样处理离线恢复轮询
- `RefreshPlansAsync`: 添加注释说明状态码含义

## 测试场景

### 场景 1: 持续战斗 (Continuous) 模式 + 离线恢复

**前置条件**:
- 角色已创建并登录
- 有可战斗的敌人

**测试步骤**:
1. 创建一个持续战斗计划 (Continuous)
   - 活动类型: 战斗 (Combat)
   - 限制类型: 时长限制
   - 时长: 300秒 (5分钟)
   - 敌人: Training Dummy
   - 敌人数: 1
2. 观察计划自动启动，状态变为 "执行中"
3. 等待计划执行 30 秒，观察战斗状态更新
4. 模拟离线：停止心跳更新（关闭页面或停止浏览器）
5. 等待 90 秒（超过离线检测阈值 60 秒）
6. 重新登录/刷新页面
7. 观察离线结算弹窗是否显示
8. 确认收益信息正确
9. 关闭弹窗后，观察计划状态
10. 验证计划是否继续执行（状态为 "执行中"）
11. 验证战斗状态是否自动开始轮询更新

**预期结果**:
- ✅ 离线结算弹窗正确显示离线时长和收益
- ✅ 计划状态保持 "执行中" 或显示已完成
- ✅ 如果计划未完成，ExecutedSeconds 应该增加了离线模拟的时长
- ✅ 战斗状态自动恢复轮询
- ✅ 金币和经验已自动发放到角色

### 场景 2: 无限战斗 (Infinite) 模式 + 离线恢复

**前置条件**:
- 角色已创建并登录

**测试步骤**:
1. 创建一个无限战斗计划
   - 活动类型: 战斗 (Combat)
   - 限制类型: 无限制
   - 敌人: Training Dummy
   - 敌人数: 1
2. 观察计划自动启动
3. 等待 30 秒
4. 模拟离线 90 秒
5. 重新登录
6. 观察离线结算弹窗
7. 验证计划是否继续执行（无限计划永不完成）
8. 验证战斗状态轮询是否恢复

**预期结果**:
- ✅ 离线结算正确
- ✅ 计划继续执行（状态为 "执行中"）
- ✅ ExecutedSeconds 持续增加
- ✅ 战斗状态自动轮询
- ✅ 可以手动停止计划

### 场景 3: 单次地下城 (Dungeon Single) 模式 + 离线恢复

**前置条件**:
- 角色已创建
- 地下城配置存在

**测试步骤**:
1. 创建一个单次地下城计划
   - 活动类型: 地下城 (Dungeon)
   - 限制类型: 时长限制
   - 时长: 300秒
   - 地下城ID: intro_cave
   - 循环模式: 不勾选
2. 观察计划启动
3. 等待 30 秒
4. 模拟离线 90 秒
5. 重新登录
6. 验证离线结算
7. 检查计划状态（可能已完成或继续执行）

**预期结果**:
- ✅ 离线结算显示地下城击杀和奖励
- ✅ 如果地下城完成，计划状态为 "已完成"
- ✅ 如果未完成，计划继续执行
- ✅ 战斗状态正确显示地下城进度

### 场景 4: 循环地下城 (Dungeon Loop) 模式 + 离线恢复

**测试步骤**:
1. 创建一个循环地下城计划
   - 活动类型: 地下城 (Dungeon)
   - 限制类型: 时长限制
   - 时长: 600秒 (10分钟)
   - 地下城ID: intro_cave
   - 循环模式: 勾选
2. 等待计划完成至少一轮地下城
3. 模拟离线 120 秒
4. 重新登录
5. 验证离线期间完成的地下城轮数
6. 验证计划是否继续循环

**预期结果**:
- ✅ 离线结算显示完成的地下城轮数
- ✅ 奖励正确累积
- ✅ 计划继续循环执行（直到时长到达）
- ✅ 战斗状态显示当前波次和轮数

### 场景 5: 手动暂停和恢复

**测试步骤**:
1. 创建并启动任意类型的计划
2. 等待计划执行一段时间
3. （注：当前前端没有直接暂停按钮，此功能由离线检测自动触发）
4. 如果计划被标记为 "已暂停"，点击 "恢复" 按钮
5. 验证计划恢复执行

**预期结果**:
- ✅ "恢复" 按钮可见并可点击
- ✅ 点击后计划状态变为 "执行中"
- ✅ 战斗状态自动开始轮询
- ✅ ExecutedSeconds 从暂停时继承

### 场景 6: 计划自动衔接 + 离线恢复

**前置条件**:
- 创建两个待执行的计划，槽位不同

**测试步骤**:
1. 创建计划1: 时长120秒，槽位0
2. 创建计划2: 时长180秒，槽位1
3. 计划1自动启动
4. 等待60秒
5. 模拟离线150秒
6. 重新登录
7. 观察离线结算信息

**预期结果**:
- ✅ 离线结算显示 "✅ 活动计划已完成"
- ✅ 显示 "🔄 下一个计划已自动开始"
- ✅ 计划1状态为 "已完成"
- ✅ 计划2状态为 "执行中"
- ✅ 计划2的战斗状态自动开始轮询

### 场景 7: 计划部分完成后继续

**测试步骤**:
1. 创建一个时长600秒的战斗计划
2. 等待执行100秒
3. 模拟离线60秒（不足以完成计划）
4. 重新登录
5. 验证离线结算

**预期结果**:
- ✅ 离线结算显示60秒的战斗收益
- ✅ 显示 "▶️ 活动计划继续执行中"
- ✅ ExecutedSeconds 约为 160秒
- ✅ 计划状态为 "执行中"
- ✅ 战斗状态自动轮询
- ✅ 计划会继续执行直到600秒完成

## 验证点清单

### UI 显示验证
- [ ] 计划列表正确显示所有状态：待执行、执行中、已完成、已取消、已暂停
- [ ] 暂停状态显示为蓝色 (text-info)
- [ ] 暂停的计划显示 "恢复" 和 "取消" 按钮
- [ ] 执行中的计划显示 "停止" 和 "查看战斗" 按钮
- [ ] ExecutedSeconds 正确显示并持续更新

### 离线结算弹窗验证
- [ ] 离线时长格式化显示正确（小时/分钟/秒）
- [ ] 金币、经验、击杀数显示正确
- [ ] 物品掉落列表显示正确（如果有）
- [ ] 计划完成状态显示正确
- [ ] 下一个计划启动提示显示正确（如适用）
- [ ] 收益已自动发放提示显示

### 功能逻辑验证
- [ ] 离线后心跳更新触发离线检测
- [ ] 离线超过阈值的计划被暂停
- [ ] 上线后离线结算正确计算
- [ ] 未完成的计划恢复执行
- [ ] 完成的计划自动启动下一个（如果有）
- [ ] 战斗状态轮询在适当时机自动启动
- [ ] 战斗状态轮询在计划停止时自动停止
- [ ] 恢复按钮功能正常
- [ ] 心跳更新每2秒执行一次（在计划轮询时）

### 数据一致性验证
- [ ] 角色金币和经验正确增加
- [ ] ExecutedSeconds 正确累积
- [ ] 战斗状态的 SimulatedSeconds 正确增长
- [ ] 敌人击杀数正确累积
- [ ] 地下城轮数正确记录

## 已知问题和边缘情况

### 1. 轮询启动时机

**问题描述**: 如果用户在离线结算弹窗显示时快速关闭，可能导致轮询未启动

**解决方案**: 在 `CheckOfflineRewardsAsync` 和 `UpdateHeartbeatIfNeededAsync` 中都添加了轮询启动逻辑

### 2. 多个计划并发

**注意事项**: 系统设计为每个角色同时只能有一个运行中的计划。前端轮询也是单一实例。

### 3. 网络断开处理

**注意事项**: 心跳更新失败不会抛出异常，不会影响主流程。但如果长时间网络断开，计划会被后端自动暂停。

## 测试环境要求

- .NET 8+ SDK
- Blazor WebAssembly 支持
- SQLite 数据库
- 浏览器开发者工具（用于检查网络请求）

## 测试数据准备

1. 确保数据库中存在可用的敌人配置
2. 确保地下城配置已加载（intro_cave 等）
3. 创建测试用角色，等级和属性足够击杀敌人

## 测试报告模板

```
测试场景: [场景名称]
测试时间: [日期时间]
测试人员: [姓名]

测试结果:
- [ ] 通过
- [ ] 失败
- [ ] 部分通过

详细说明:
[描述测试过程和观察到的行为]

发现的问题:
[列出任何异常或问题]

截图:
[附上相关截图]
```

## 自动化测试建议

虽然本次主要进行手动测试，但建议在未来添加以下自动化测试：

1. 单元测试：
   - `CheckOfflineRewardsAsync` 方法测试
   - `UpdateHeartbeatIfNeededAsync` 方法测试
   - `ResumePlanAsync` 方法测试

2. 集成测试：
   - 完整的离线-上线流程测试
   - 计划状态转换测试
   - 战斗状态轮询测试

3. E2E 测试：
   - 使用 Playwright 或 Selenium 测试完整用户流程

## 总结

本次修复主要解决了前端对离线恢复功能的适配问题：
1. 添加了对暂停状态的显示支持
2. 实现了计划恢复功能
3. 修复了离线恢复后战斗状态轮询自动重启的问题

这些修复确保了玩家在离线后重新上线时，计划任务能够无缝继续执行，并且前端能够正确显示和更新任务状态。
