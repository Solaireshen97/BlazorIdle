# BlazorIdle å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰
## é›†æˆæµ‹è¯•ã€æ€§èƒ½ä¼˜åŒ–ä¸è¿ç»´

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç±»å‹**: è®¾è®¡æ–¹æ¡ˆ - ä¸‹ç¯‡  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**ä½œè€…**: ç³»ç»Ÿæ¶æ„å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [Phase 5: é›†æˆæµ‹è¯•](#1-phase-5-é›†æˆæµ‹è¯•)
2. [Phase 6: æ€§èƒ½ä¼˜åŒ–](#2-phase-6-æ€§èƒ½ä¼˜åŒ–)
3. [ç›‘æ§ä¸æ—¥å¿—](#3-ç›‘æ§ä¸æ—¥å¿—)
4. [å®‰å…¨æ€§åŠ å›º](#4-å®‰å…¨æ€§åŠ å›º)
5. [è¿ç»´ä¸é…ç½®ç®¡ç†](#5-è¿ç»´ä¸é…ç½®ç®¡ç†)
6. [æ‰©å±•åŠŸèƒ½è®¾è®¡](#6-æ‰©å±•åŠŸèƒ½è®¾è®¡)
7. [äº¤ä»˜æ¸…å•](#7-äº¤ä»˜æ¸…å•)

---

## 1. Phase 5: é›†æˆæµ‹è¯•

### 1.1 æµ‹è¯•ç­–ç•¥

| æµ‹è¯•ç±»å‹ | è¦†ç›–èŒƒå›´ | å·¥å…· | ç›®æ ‡è¦†ç›–ç‡ |
|---------|---------|------|-----------|
| å•å…ƒæµ‹è¯• | é¢†åŸŸæ¨¡å‹ã€æœåŠ¡ç±» | xUnit | 80%+ |
| é›†æˆæµ‹è¯• | APIç«¯ç‚¹ã€æ•°æ®åº“äº¤äº’ | xUnit + TestServer | 70%+ |
| æ€§èƒ½æµ‹è¯• | å¹¶å‘è´­ä¹°ã€å¤§é‡å•†å“åŠ è½½ | BenchmarkDotNet | N/A |
| ç«¯åˆ°ç«¯æµ‹è¯• | å®Œæ•´è´­ä¹°æµç¨‹ | Playwright/Selenium | å…³é”®è·¯å¾„ |

### 1.2 å•å…ƒæµ‹è¯•æ¸…å•

#### 1.2.1 é¢†åŸŸæ¨¡å‹æµ‹è¯•

**æ–‡ä»¶**: `BlazorIdle.Server.Tests/Domain/Shop/ShopAggregateTests.cs`

```csharp
using BlazorIdle.Server.Domain.Shop.Models;
using Xunit;

namespace BlazorIdle.Server.Tests.Domain.Shop;

public class ShopAggregateTests
{
    [Fact]
    public void ShopInstance_ShouldInitializeCorrectly()
    {
        // Arrange & Act
        var shop = new ShopInstance("shop_test");
        
        // Assert
        Assert.NotEqual(Guid.Empty, shop.Id);
        Assert.Equal("shop_test", shop.ShopDefinitionId);
        Assert.Equal(0, shop.RefreshCount);
        Assert.NotNull(shop.ItemStocks);
        Assert.Empty(shop.ItemStocks);
    }
    
    [Fact]
    public void ShopInstance_Refresh_ShouldUpdateState()
    {
        // Arrange
        var shop = new ShopInstance("shop_test");
        var stocks = new List<ShopItemStock>
        {
            new ShopItemStock(shop.Id, "item1", 10, 10),
            new ShopItemStock(shop.Id, "item2", 5, 5)
        };
        var refreshTime = DateTime.UtcNow;
        
        // Act
        shop.Refresh(refreshTime, stocks);
        
        // Assert
        Assert.Equal(refreshTime, shop.LastRefreshTime);
        Assert.Equal(1, shop.RefreshCount);
        Assert.Equal(2, shop.ItemStocks.Count);
        Assert.Single(shop.DomainEvents); // ShopRefreshedEvent
    }
    
    [Fact]
    public void ShopInstance_TryDeductStock_ShouldSucceedWhenStockAvailable()
    {
        // Arrange
        var shop = new ShopInstance("shop_test");
        var stocks = new List<ShopItemStock>
        {
            new ShopItemStock(shop.Id, "item1", 10, 10)
        };
        shop.Refresh(DateTime.UtcNow, stocks);
        
        // Act
        var result = shop.TryDeductStock("item1", 3);
        
        // Assert
        Assert.True(result);
        Assert.Equal(7, shop.ItemStocks[0].CurrentStock);
    }
    
    [Fact]
    public void ShopInstance_TryDeductStock_ShouldFailWhenStockInsufficient()
    {
        // Arrange
        var shop = new ShopInstance("shop_test");
        var stocks = new List<ShopItemStock>
        {
            new ShopItemStock(shop.Id, "item1", 10, 5)
        };
        shop.Refresh(DateTime.UtcNow, stocks);
        
        // Act
        var result = shop.TryDeductStock("item1", 10);
        
        // Assert
        Assert.False(result);
        Assert.Equal(5, shop.ItemStocks[0].CurrentStock); // æœªæ‰£å‡
    }
}
```

#### 1.2.2 åº“å­˜ç®¡ç†æµ‹è¯•

**æ–‡ä»¶**: `BlazorIdle.Server.Tests/Domain/Shop/ShopItemStockTests.cs`

```csharp
public class ShopItemStockTests
{
    [Fact]
    public void TryDeduct_ShouldSucceed_WhenStockIsInfinite()
    {
        // Arrange
        var stock = new ShopItemStock(Guid.NewGuid(), "item1", null, null);
        
        // Act
        var result = stock.TryDeduct(100);
        
        // Assert
        Assert.True(result);
        Assert.Null(stock.CurrentStock); // ä»ç„¶æ˜¯æ— é™
    }
    
    [Theory]
    [InlineData(10, 5, true, 5)]   // åº“å­˜10ï¼Œæ‰£5ï¼ŒæˆåŠŸï¼Œå‰©5
    [InlineData(10, 10, true, 0)]  // åº“å­˜10ï¼Œæ‰£10ï¼ŒæˆåŠŸï¼Œå‰©0
    [InlineData(10, 11, false, 10)] // åº“å­˜10ï¼Œæ‰£11ï¼Œå¤±è´¥ï¼Œå‰©10
    [InlineData(0, 1, false, 0)]   // åº“å­˜0ï¼Œæ‰£1ï¼Œå¤±è´¥ï¼Œå‰©0
    public void TryDeduct_ShouldWorkCorrectly(
        int initialStock, 
        int deductAmount, 
        bool expectedResult, 
        int expectedRemaining)
    {
        // Arrange
        var stock = new ShopItemStock(Guid.NewGuid(), "item1", 100, initialStock);
        
        // Act
        var result = stock.TryDeduct(deductAmount);
        
        // Assert
        Assert.Equal(expectedResult, result);
        Assert.Equal(expectedRemaining, stock.CurrentStock);
    }
    
    [Fact]
    public void RestockToMax_ShouldResetToMaxStock()
    {
        // Arrange
        var stock = new ShopItemStock(Guid.NewGuid(), "item1", 20, 5);
        
        // Act
        stock.RestockToMax();
        
        // Assert
        Assert.Equal(20, stock.CurrentStock);
    }
}
```

#### 1.2.3 ä»·æ ¼è®¡ç®—æµ‹è¯•

```csharp
public class CurrencyCostTests
{
    [Theory]
    [InlineData(100, 1.0, 100)]   // æ— æŠ˜æ‰£
    [InlineData(100, 0.8, 80)]    // 8æŠ˜
    [InlineData(100, 0.5, 50)]    // 5æŠ˜
    [InlineData(100, 0.0, 0)]     // å…¨å…è´¹
    public void CalculateActualCost_ShouldApplyDiscount(
        long baseAmount, 
        double discount, 
        long expected)
    {
        // Arrange
        var cost = new CurrencyCost
        {
            CurrencyType = CurrencyType.Gold,
            Amount = baseAmount,
            DiscountFactor = discount
        };
        
        // Act
        var actual = cost.CalculateActualCost();
        
        // Assert
        Assert.Equal(expected, actual);
    }
}
```

### 1.3 é›†æˆæµ‹è¯•æ¸…å•

#### 1.3.1 è´­ä¹°æµç¨‹é›†æˆæµ‹è¯•

**æ–‡ä»¶**: `BlazorIdle.Server.Tests/Integration/PurchaseIntegrationTests.cs`

```csharp
using Microsoft.AspNetCore.Mvc.Testing;
using Xunit;

namespace BlazorIdle.Server.Tests.Integration;

public class PurchaseIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly WebApplicationFactory<Program> _factory;
    private readonly HttpClient _client;
    
    public PurchaseIntegrationTests(WebApplicationFactory<Program> factory)
    {
        _factory = factory;
        _client = factory.CreateClient();
    }
    
    [Fact]
    public async Task Purchase_ShouldSucceed_WhenAllConditionsMet()
    {
        // Arrange
        var characterId = await CreateTestCharacter(gold: 1000);
        await SeedTestShop();
        
        var request = new PurchaseRequest
        {
            CharacterId = characterId,
            ShopItemId = "test_item_bread",
            Quantity = 5,
            TransactionId = Guid.NewGuid().ToString()
        };
        
        // Act
        var response = await _client.PostAsJsonAsync("/api/shops/purchase", request);
        
        // Assert
        response.EnsureSuccessStatusCode();
        var result = await response.Content.ReadFromJsonAsync<PurchaseResult>();
        Assert.True(result.Success);
        Assert.Equal(5, result.ItemsGranted.First().Quantity);
        
        // éªŒè¯é‡‘å¸æ‰£é™¤
        var character = await GetCharacter(characterId);
        Assert.Equal(975, character.Gold); // 1000 - (5 * 5)
    }
    
    [Fact]
    public async Task Purchase_ShouldFail_WhenInsufficientGold()
    {
        // Arrange
        var characterId = await CreateTestCharacter(gold: 10); // åªæœ‰10é‡‘å¸
        await SeedTestShop();
        
        var request = new PurchaseRequest
        {
            CharacterId = characterId,
            ShopItemId = "test_item_bread",
            Quantity = 100, // éœ€è¦500é‡‘å¸
            TransactionId = Guid.NewGuid().ToString()
        };
        
        // Act
        var response = await _client.PostAsJsonAsync("/api/shops/purchase", request);
        
        // Assert
        var result = await response.Content.ReadFromJsonAsync<PurchaseResult>();
        Assert.False(result.Success);
        Assert.Contains("è´§å¸ä¸è¶³", result.Message);
    }
    
    [Fact]
    public async Task Purchase_ShouldBeIdempotent()
    {
        // Arrange
        var characterId = await CreateTestCharacter(gold: 1000);
        await SeedTestShop();
        
        var transactionId = Guid.NewGuid().ToString();
        var request = new PurchaseRequest
        {
            CharacterId = characterId,
            ShopItemId = "test_item_bread",
            Quantity = 5,
            TransactionId = transactionId
        };
        
        // Act - ç¬¬ä¸€æ¬¡è´­ä¹°
        var response1 = await _client.PostAsJsonAsync("/api/shops/purchase", request);
        var result1 = await response1.Content.ReadFromJsonAsync<PurchaseResult>();
        
        // Act - ç¬¬äºŒæ¬¡è´­ä¹°ï¼ˆç›¸åŒTransactionIdï¼‰
        var response2 = await _client.PostAsJsonAsync("/api/shops/purchase", request);
        var result2 = await response2.Content.ReadFromJsonAsync<PurchaseResult>();
        
        // Assert
        Assert.True(result1.Success);
        Assert.True(result2.Success); // å¹‚ç­‰ï¼Œä¸æŠ¥é”™
        
        // éªŒè¯åªæ‰£äº†ä¸€æ¬¡é’±
        var character = await GetCharacter(characterId);
        Assert.Equal(975, character.Gold);
    }
    
    [Fact]
    public async Task Purchase_ShouldDeductStock_WhenStockLimited()
    {
        // Arrange
        var characterId = await CreateTestCharacter(gold: 10000);
        await SeedTestShopWithLimitedStock(itemStock: 10);
        
        // Act - è´­ä¹°5ä¸ª
        await PurchaseItem(characterId, quantity: 5);
        
        // Assert - éªŒè¯åº“å­˜å‰©ä½™5ä¸ª
        var shop = await GetShopDetail("test_shop");
        var item = shop.Items.First(i => i.ShopItemId == "limited_item");
        Assert.Equal(5, item.CurrentStock);
    }
    
    [Fact]
    public async Task Purchase_ShouldEnforcePurchaseLimit()
    {
        // Arrange
        var characterId = await CreateTestCharacter(gold: 10000);
        await SeedTestShopWithDailyLimit(maxPerDay: 3);
        
        // Act - ç¬¬ä¸€æ¬¡è´­ä¹°3ä¸ªï¼ˆè¾¾åˆ°ä¸Šé™ï¼‰
        var result1 = await PurchaseItem(characterId, quantity: 3);
        Assert.True(result1.Success);
        
        // Act - ç¬¬äºŒæ¬¡å°è¯•è´­ä¹°1ä¸ªï¼ˆè¶…é™ï¼‰
        var result2 = await PurchaseItem(characterId, quantity: 1);
        
        // Assert
        Assert.False(result2.Success);
        Assert.Contains("é™è´­", result2.Message);
    }
    
    // è¾…åŠ©æ–¹æ³•
    private async Task<Guid> CreateTestCharacter(long gold) { /* ... */ }
    private async Task SeedTestShop() { /* ... */ }
    private async Task<Character> GetCharacter(Guid id) { /* ... */ }
    private async Task<ShopDetailDto> GetShopDetail(string shopId) { /* ... */ }
}
```

#### 1.3.2 å•†åº—åˆ·æ–°æµ‹è¯•

```csharp
public class ShopRefreshIntegrationTests
{
    [Fact]
    public async Task RefreshShop_ShouldRestockItems()
    {
        // Arrange
        var shopId = "test_shop_daily";
        await SeedTestShop(shopId, RefreshInterval.Daily);
        var shopInstance = await GetShopInstance(shopId);
        
        // æ¨¡æ‹Ÿè´­ä¹°è€—å°½åº“å­˜
        await DepleteSomeStock(shopInstance.Id);
        
        // Act
        await _refreshService.RefreshShopAsync(shopId);
        
        // Assert
        var refreshedShop = await GetShopInstance(shopId);
        Assert.True(refreshedShop.RefreshCount > shopInstance.RefreshCount);
        
        var stock = refreshedShop.ItemStocks.First();
        Assert.Equal(stock.MaxStock, stock.CurrentStock); // è¡¥æ»¡
    }
    
    [Fact]
    public async Task RefreshShop_ShouldSkip_WhenNotTimeYet()
    {
        // Arrange
        var shopId = "test_shop_daily";
        await SeedTestShop(shopId, RefreshInterval.Daily);
        
        // åˆšåˆšåˆ·æ–°è¿‡
        await _refreshService.RefreshShopAsync(shopId);
        var refreshCount1 = (await GetShopInstance(shopId)).RefreshCount;
        
        // Act - ç«‹å³å†æ¬¡åˆ·æ–°
        var result = await _refreshService.RefreshShopAsync(shopId);
        var refreshCount2 = (await GetShopInstance(shopId)).RefreshCount;
        
        // Assert
        Assert.Equal("å•†åº—å°šæœªåˆ°åˆ·æ–°æ—¶é—´", result.Message);
        Assert.Equal(refreshCount1, refreshCount2); // æœªåˆ·æ–°
    }
}
```

### 1.4 æ€§èƒ½æµ‹è¯•

#### 1.4.1 å¹¶å‘è´­ä¹°æµ‹è¯•

**æ–‡ä»¶**: `BlazorIdle.Server.Tests/Performance/ConcurrentPurchaseTests.cs`

```csharp
using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Running;

namespace BlazorIdle.Server.Tests.Performance;

[MemoryDiagnoser]
[SimpleJob(iterationCount: 100)]
public class ConcurrentPurchaseBenchmark
{
    private IPurchaseService _purchaseService;
    private Guid _characterId;
    private string _shopItemId;
    
    [GlobalSetup]
    public void Setup()
    {
        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        _characterId = Guid.NewGuid();
        _shopItemId = "test_item";
    }
    
    [Benchmark]
    public async Task Sequential_10Purchases()
    {
        for (int i = 0; i < 10; i++)
        {
            await _purchaseService.PurchaseAsync(new PurchaseRequest
            {
                CharacterId = _characterId,
                ShopItemId = _shopItemId,
                Quantity = 1,
                TransactionId = Guid.NewGuid().ToString()
            });
        }
    }
    
    [Benchmark]
    public async Task Concurrent_10Purchases()
    {
        var tasks = Enumerable.Range(0, 10).Select(i =>
            _purchaseService.PurchaseAsync(new PurchaseRequest
            {
                CharacterId = _characterId,
                ShopItemId = _shopItemId,
                Quantity = 1,
                TransactionId = Guid.NewGuid().ToString()
            })
        );
        
        await Task.WhenAll(tasks);
    }
}

// è¿è¡Œ: dotnet run -c Release --project BlazorIdle.Server.Tests
// BenchmarkRunner.Run<ConcurrentPurchaseBenchmark>();
```

#### 1.4.2 å¤§é‡å•†å“åŠ è½½æµ‹è¯•

```csharp
[MemoryDiagnoser]
public class ShopLoadBenchmark
{
    [Params(10, 50, 100, 500)]
    public int ItemCount;
    
    [Benchmark]
    public async Task LoadShopWithItems()
    {
        var shopId = $"test_shop_{ItemCount}items";
        await _shopService.GetShopDetailAsync(shopId);
    }
}
```

### 1.5 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | å½“å‰è¦†ç›–ç‡ | çŠ¶æ€ |
|-----|----------|-----------|------|
| Domain/Shop/Models | 85% | - | å¾…å®æ–½ |
| Domain/Shop/Services | 80% | - | å¾…å®æ–½ |
| Application/Shop | 75% | - | å¾…å®æ–½ |
| Controllers | 70% | - | å¾…å®æ–½ |

---

## 2. Phase 6: æ€§èƒ½ä¼˜åŒ–

### 2.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

#### 2.1.1 ç´¢å¼•ç­–ç•¥

```sql
-- ShopDefinitionsè¡¨
CREATE INDEX IX_ShopDefinitions_ShopType ON ShopDefinitions(ShopType);
CREATE INDEX IX_ShopDefinitions_IsActive ON ShopDefinitions(IsActive);
CREATE INDEX IX_ShopDefinitions_SortOrder ON ShopDefinitions(SortOrder);

-- ShopItemDefinitionsè¡¨
CREATE INDEX IX_ShopItemDefinitions_ShopDefinitionId ON ShopItemDefinitions(ShopDefinitionId);
CREATE INDEX IX_ShopItemDefinitions_ItemType ON ShopItemDefinitions(ItemType);
CREATE INDEX IX_ShopItemDefinitions_IsActive ON ShopItemDefinitions(IsActive);
CREATE INDEX IX_ShopItemDefinitions_DisplayOrder ON ShopItemDefinitions(DisplayOrder);

-- ShopInstanceè¡¨
CREATE INDEX IX_ShopInstance_ShopDefinitionId ON ShopInstance(ShopDefinitionId);
CREATE INDEX IX_ShopInstance_NextRefreshTime ON ShopInstance(NextRefreshTime)
    WHERE NextRefreshTime IS NOT NULL;

-- ShopItemStockè¡¨
CREATE INDEX IX_ShopItemStock_ShopInstanceId ON ShopItemStock(ShopInstanceId);
CREATE INDEX IX_ShopItemStock_ShopItemId ON ShopItemStock(ShopItemId);

-- PurchaseRecordè¡¨
CREATE INDEX IX_PurchaseRecord_CharacterId_PurchaseTime 
    ON PurchaseRecord(CharacterId, PurchaseTime DESC);
CREATE INDEX IX_PurchaseRecord_ShopItemId ON PurchaseRecord(ShopItemId);

-- CharacterPurchaseRecordè¡¨
CREATE INDEX IX_CharacterPurchaseRecord_CharacterId_ShopItemId 
    ON CharacterPurchaseRecord(CharacterId, ShopItemId);
```

#### 2.1.2 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

```csharp
// ä½¿ç”¨ AsNoTracking å‡å°‘å†…å­˜å ç”¨
public async Task<List<ShopDefinition>> GetAllActiveShopDefinitionsAsync(
    CancellationToken ct = default)
{
    return await _dbContext.ShopDefinitions
        .AsNoTracking()
        .Where(s => s.IsActive)
        .OrderBy(s => s.SortOrder)
        .Include(s => s.ItemDefinitions.Where(i => i.IsActive))
        .ToListAsync(ct);
}

// åˆ†é¡µæŸ¥è¯¢è´­ä¹°å†å²
public async Task<List<PurchaseRecord>> GetCharacterPurchaseHistoryAsync(
    Guid characterId,
    DateTime? startDate,
    DateTime? endDate,
    int page = 1,
    int pageSize = 50,
    CancellationToken ct = default)
{
    var query = _dbContext.PurchaseRecords
        .AsNoTracking()
        .Where(p => p.CharacterId == characterId);
    
    if (startDate.HasValue)
        query = query.Where(p => p.PurchaseTime >= startDate.Value);
        
    if (endDate.HasValue)
        query = query.Where(p => p.PurchaseTime <= endDate.Value);
    
    return await query
        .OrderByDescending(p => p.PurchaseTime)
        .Skip((page - 1) * pageSize)
        .Take(pageSize)
        .ToListAsync(ct);
}

// æ‰¹é‡æŸ¥è¯¢é™è´­è®°å½•
public async Task<Dictionary<string, CharacterPurchaseRecord>> GetCharacterPurchaseRecordsAsync(
    Guid characterId,
    List<string> shopItemIds,
    CancellationToken ct = default)
{
    var records = await _dbContext.CharacterPurchaseRecords
        .AsNoTracking()
        .Where(r => r.CharacterId == characterId && shopItemIds.Contains(r.ShopItemId))
        .ToListAsync(ct);
    
    return records.ToDictionary(r => r.ShopItemId);
}
```

### 2.2 ç¼“å­˜ç­–ç•¥

#### 2.2.1 å†…å­˜ç¼“å­˜ï¼ˆIMemoryCacheï¼‰

```csharp
using Microsoft.Extensions.Caching.Memory;

public class CachedShopRepository : IShopRepository
{
    private readonly IShopRepository _innerRepository;
    private readonly IMemoryCache _cache;
    private readonly ILogger<CachedShopRepository> _logger;
    
    private const string SHOP_DEF_KEY_PREFIX = "shop_def:";
    private const int CACHE_DURATION_MINUTES = 30;
    
    public async Task<ShopDefinition?> GetShopDefinitionAsync(
        string shopId,
        CancellationToken ct = default)
    {
        var cacheKey = $"{SHOP_DEF_KEY_PREFIX}{shopId}";
        
        if (_cache.TryGetValue(cacheKey, out ShopDefinition? cached))
        {
            _logger.LogDebug("Cache hit: {CacheKey}", cacheKey);
            return cached;
        }
        
        var definition = await _innerRepository.GetShopDefinitionAsync(shopId, ct);
        
        if (definition != null)
        {
            _cache.Set(cacheKey, definition, TimeSpan.FromMinutes(CACHE_DURATION_MINUTES));
            _logger.LogDebug("Cache set: {CacheKey}", cacheKey);
        }
        
        return definition;
    }
    
    public void InvalidateShopCache(string shopId)
    {
        var cacheKey = $"{SHOP_DEF_KEY_PREFIX}{shopId}";
        _cache.Remove(cacheKey);
        _logger.LogInformation("Cache invalidated: {CacheKey}", cacheKey);
    }
}
```

#### 2.2.2 åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedis - å¯é€‰ï¼‰

```csharp
using Microsoft.Extensions.Caching.Distributed;
using System.Text.Json;

public class DistributedCachedShopRepository : IShopRepository
{
    private readonly IShopRepository _innerRepository;
    private readonly IDistributedCache _cache;
    
    public async Task<ShopDefinition?> GetShopDefinitionAsync(
        string shopId,
        CancellationToken ct = default)
    {
        var cacheKey = $"shop_def:{shopId}";
        var cached = await _cache.GetStringAsync(cacheKey, ct);
        
        if (cached != null)
        {
            return JsonSerializer.Deserialize<ShopDefinition>(cached);
        }
        
        var definition = await _innerRepository.GetShopDefinitionAsync(shopId, ct);
        
        if (definition != null)
        {
            var serialized = JsonSerializer.Serialize(definition);
            await _cache.SetStringAsync(
                cacheKey, 
                serialized, 
                new DistributedCacheEntryOptions
                {
                    AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(30)
                },
                ct);
        }
        
        return definition;
    }
}
```

### 2.3 å¹¶å‘æ§åˆ¶

#### 2.3.1 ä¹è§‚é”

```csharp
// ShopInstanceå®ä½“æ·»åŠ Versionå­—æ®µ
public class ShopInstance
{
    public int Version { get; private set; }
    
    public void Refresh(...)
    {
        Version++; // æ›´æ–°ç‰ˆæœ¬å·
        // ...
    }
}

// EF Coreé…ç½®
builder.Property(s => s.Version)
    .IsConcurrencyToken();

// ä¿å­˜æ—¶å¤„ç†å¹¶å‘å†²çª
public async Task<ShopInstance> SaveShopInstanceAsync(
    ShopInstance instance,
    CancellationToken ct = default)
{
    try
    {
        _dbContext.Update(instance);
        await _dbContext.SaveChangesAsync(ct);
        return instance;
    }
    catch (DbUpdateConcurrencyException ex)
    {
        _logger.LogWarning(ex, "Concurrency conflict when saving shop instance {Id}", instance.Id);
        
        // é‡è¯•ç­–ç•¥
        await _dbContext.Entry(instance).ReloadAsync(ct);
        throw new ConcurrencyException("å•†åº—æ•°æ®å·²è¢«å…¶ä»–æ“ä½œä¿®æ”¹ï¼Œè¯·é‡è¯•");
    }
}
```

#### 2.3.2 åˆ†å¸ƒå¼é”ï¼ˆæœ‰é™åº“å­˜å•†å“ï¼‰

```csharp
using StackExchange.Redis;

public class DistributedLockService
{
    private readonly IConnectionMultiplexer _redis;
    
    public async Task<bool> AcquireLockAsync(
        string resourceKey,
        string lockId,
        TimeSpan expiry)
    {
        var db = _redis.GetDatabase();
        return await db.StringSetAsync(
            $"lock:{resourceKey}",
            lockId,
            expiry,
            When.NotExists);
    }
    
    public async Task ReleaseLockAsync(string resourceKey, string lockId)
    {
        var db = _redis.GetDatabase();
        var script = @"
            if redis.call('get', KEYS[1]) == ARGV[1] then
                return redis.call('del', KEYS[1])
            else
                return 0
            end";
        
        await db.ScriptEvaluateAsync(script, new RedisKey[] { $"lock:{resourceKey}" }, new RedisValue[] { lockId });
    }
}

// åœ¨è´­ä¹°æœåŠ¡ä¸­ä½¿ç”¨
public async Task<PurchaseResult> PurchaseAsync(
    PurchaseRequest request,
    CancellationToken ct = default)
{
    var lockId = Guid.NewGuid().ToString();
    var lockKey = $"shop_item:{request.ShopItemId}";
    
    if (!await _lockService.AcquireLockAsync(lockKey, lockId, TimeSpan.FromSeconds(30)))
    {
        return PurchaseResult.Fail("å•†å“æ­£åœ¨è¢«å…¶ä»–ç©å®¶è´­ä¹°ï¼Œè¯·ç¨åé‡è¯•");
    }
    
    try
    {
        // æ‰§è¡Œè´­ä¹°é€»è¾‘
        return await ExecutePurchaseAsync(request, ct);
    }
    finally
    {
        await _lockService.ReleaseLockAsync(lockKey, lockId);
    }
}
```

---

## 3. ç›‘æ§ä¸æ—¥å¿—

### 3.1 å…³é”®æŒ‡æ ‡ç›‘æ§

#### 3.1.1 ä¸šåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡ | æè¿° | é‡‡é›†æ–¹å¼ | å‘Šè­¦é˜ˆå€¼ |
|-----|------|---------|---------|
| **è´­ä¹°æˆåŠŸç‡** | (æˆåŠŸè´­ä¹°æ•°/æ€»è´­ä¹°è¯·æ±‚) * 100% | Counter | < 95% |
| **è´­ä¹°å“åº”æ—¶é—´** | P50/P95/P99å»¶è¿Ÿ | Histogram | P95 > 500ms |
| **åº“å­˜è€—å°½æ¬¡æ•°** | å•†å“åº“å­˜ä¸º0çš„æ¬¡æ•° | Counter | > 10/å°æ—¶ |
| **åˆ·æ–°å¤±è´¥ç‡** | å•†åº—åˆ·æ–°å¤±è´¥æ¯”ä¾‹ | Counter | > 1% |
| **è´§å¸æµé€šé‡** | æ¯æ—¥é‡‘å¸è¿›å‡ºæ€»é‡ | Gauge | å¼‚å¸¸æ³¢åŠ¨ |
| **çƒ­é”€å•†å“Top10** | è´­ä¹°æ¬¡æ•°æœ€å¤šçš„å•†å“ | TopK | N/A |

#### 3.1.2 æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | æè¿° | å‘Šè­¦é˜ˆå€¼ |
|-----|------|---------|
| **å¹¶å‘è´­ä¹°å†²çª** | ä¹è§‚é”å†²çªæ¬¡æ•° | > 100/åˆ†é’Ÿ |
| **æ•°æ®åº“è¿æ¥æ± ** | æ´»è·ƒ/ç©ºé—²è¿æ¥æ•° | æ´»è·ƒ > 80% |
| **ç¼“å­˜å‘½ä¸­ç‡** | å•†åº—å®šä¹‰ç¼“å­˜å‘½ä¸­ç‡ | < 90% |
| **APIé”™è¯¯ç‡** | 4xx/5xxå“åº”æ¯”ä¾‹ | > 1% |

#### 3.1.3 ç›‘æ§å®ç°ï¼ˆPrometheus + Grafanaï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Monitoring/ShopMetrics.cs`

```csharp
using Prometheus;

public class ShopMetrics
{
    // è´­ä¹°è®¡æ•°å™¨
    private static readonly Counter PurchaseTotal = Metrics
        .CreateCounter(
            "shop_purchase_total",
            "Total number of purchase requests",
            new CounterConfiguration
            {
                LabelNames = new[] { "shop_id", "item_type", "result" }
            });
    
    // è´­ä¹°å»¶è¿Ÿ
    private static readonly Histogram PurchaseDuration = Metrics
        .CreateHistogram(
            "shop_purchase_duration_seconds",
            "Purchase request duration in seconds",
            new HistogramConfiguration
            {
                LabelNames = new[] { "shop_id" },
                Buckets = Histogram.ExponentialBuckets(0.01, 2, 10)
            });
    
    // åº“å­˜è€—å°½
    private static readonly Counter StockDepleted = Metrics
        .CreateCounter(
            "shop_stock_depleted_total",
            "Number of times items went out of stock",
            new CounterConfiguration
            {
                LabelNames = new[] { "shop_id", "item_id" }
            });
    
    // è´§å¸æµé€š
    private static readonly Counter CurrencyFlow = Metrics
        .CreateCounter(
            "shop_currency_flow_total",
            "Total currency exchanged",
            new CounterConfiguration
            {
                LabelNames = new[] { "currency_type", "direction" } // in/out
            });
    
    // ç¼“å­˜å‘½ä¸­ç‡
    private static readonly Counter CacheHits = Metrics
        .CreateCounter(
            "shop_cache_hits_total",
            "Total cache hits",
            new CounterConfiguration
            {
                LabelNames = new[] { "cache_type" }
            });
    
    // è¾…åŠ©æ–¹æ³•
    public static void RecordPurchase(string shopId, string itemType, bool success)
    {
        PurchaseTotal.WithLabels(shopId, itemType, success ? "success" : "failure").Inc();
    }
    
    public static IDisposable MeasurePurchase(string shopId)
    {
        return PurchaseDuration.WithLabels(shopId).NewTimer();
    }
    
    public static void RecordStockDepletion(string shopId, string itemId)
    {
        StockDepleted.WithLabels(shopId, itemId).Inc();
    }
    
    public static void RecordCurrencyFlow(CurrencyType type, long amount, string direction)
    {
        CurrencyFlow.WithLabels(type.ToString(), direction).Inc(amount);
    }
}

// åœ¨PurchaseServiceä¸­ä½¿ç”¨
public async Task<PurchaseResult> PurchaseAsync(
    PurchaseRequest request,
    CancellationToken ct = default)
{
    using (ShopMetrics.MeasurePurchase(request.ShopId))
    {
        try
        {
            var result = await ExecutePurchaseAsync(request, ct);
            ShopMetrics.RecordPurchase(request.ShopId, itemType, result.Success);
            return result;
        }
        catch (Exception ex)
        {
            ShopMetrics.RecordPurchase(request.ShopId, itemType, false);
            throw;
        }
    }
}
```

### 3.2 ç»“æ„åŒ–æ—¥å¿—

#### 3.2.1 æ—¥å¿—è§„èŒƒ

```csharp
public class PurchaseService
{
    private readonly ILogger<PurchaseService> _logger;
    
    public async Task<PurchaseResult> PurchaseAsync(...)
    {
        _logger.LogInformation(
            "Purchase started: CharacterId={CharacterId}, ShopItemId={ShopItemId}, Quantity={Quantity}, TxId={TransactionId}",
            request.CharacterId,
            request.ShopItemId,
            request.Quantity,
            request.TransactionId);
        
        try
        {
            // æ‰§è¡Œè´­ä¹°
            var result = await ExecutePurchaseAsync(request, ct);
            
            _logger.LogInformation(
                "Purchase completed: CharacterId={CharacterId}, ShopItemId={ShopItemId}, Success={Success}, RemainingGold={Gold}",
                request.CharacterId,
                request.ShopItemId,
                result.Success,
                result.RemainingCurrency.GetValueOrDefault(CurrencyType.Gold));
            
            return result;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex,
                "Purchase failed: CharacterId={CharacterId}, ShopItemId={ShopItemId}, Error={Error}",
                request.CharacterId,
                request.ShopItemId,
                ex.Message);
            
            throw;
        }
    }
}
```

#### 3.2.2 æ—¥å¿—çº§åˆ«ä½¿ç”¨

| çº§åˆ« | ç”¨é€” | ç¤ºä¾‹ |
|-----|------|------|
| **Trace** | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ | æ¡ä»¶è¯„ä¼°æ­¥éª¤ |
| **Debug** | å¼€å‘è°ƒè¯• | ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­ |
| **Information** | æ­£å¸¸ä¸šåŠ¡æµç¨‹ | è´­ä¹°æˆåŠŸã€å•†åº—åˆ·æ–° |
| **Warning** | æ½œåœ¨é—®é¢˜ | åº“å­˜ä½ã€å¹¶å‘å†²çª |
| **Error** | é”™è¯¯æƒ…å†µ | è´­ä¹°å¤±è´¥ã€æ•°æ®åº“å¼‚å¸¸ |
| **Critical** | ä¸¥é‡é”™è¯¯ | æ•°æ®ä¸ä¸€è‡´ã€æœåŠ¡ä¸å¯ç”¨ |

---

## 4. å®‰å…¨æ€§åŠ å›º

### 4.1 é˜²åˆ·æœºåˆ¶

#### 4.1.1 è´­ä¹°é™é¢‘

```csharp
using Microsoft.AspNetCore.RateLimiting;

// Startup.cs é…ç½®
builder.Services.AddRateLimiter(options =>
{
    options.AddFixedWindowLimiter("purchase", opt =>
    {
        opt.Window = TimeSpan.FromMinutes(1);
        opt.PermitLimit = 20; // æ¯åˆ†é’Ÿæœ€å¤š20æ¬¡è´­ä¹°è¯·æ±‚
        opt.QueueLimit = 0;
    });
});

// Controlleråº”ç”¨é™é¢‘
[HttpPost("purchase")]
[EnableRateLimiting("purchase")]
public async Task<IActionResult> Purchase([FromBody] PurchaseRequest request)
{
    // ...
}
```

#### 4.1.2 ä»·æ ¼éªŒè¯

```csharp
public class PurchaseValidator
{
    public async Task<ValidationResult> ValidateAsync(PurchaseRequest request, ...)
    {
        // ... å…¶ä»–éªŒè¯
        
        // ä»·æ ¼éªŒè¯ï¼šå®¢æˆ·ç«¯ä¸ä¼ ä»·æ ¼ï¼ŒæœåŠ¡ç«¯æŸ¥è¯¢
        var itemDef = await _shopRepo.GetShopItemDefinitionAsync(request.ShopItemId, ct);
        var expectedPrices = itemDef.GetPrices();
        
        // å¦‚æœå®¢æˆ·ç«¯ä¼ äº†ä»·æ ¼ï¼ˆå¯é€‰ï¼‰ï¼ŒéªŒè¯æ˜¯å¦ä¸€è‡´
        if (request.ExpectedPrice != null)
        {
            var actualTotalCost = expectedPrices
                .Where(p => p.CurrencyType == CurrencyType.Gold)
                .Sum(p => p.Amount * request.Quantity);
                
            if (request.ExpectedPrice != actualTotalCost)
            {
                _logger.LogWarning(
                    "Price mismatch: CharacterId={CharacterId}, Expected={Expected}, Actual={Actual}",
                    request.CharacterId,
                    request.ExpectedPrice,
                    actualTotalCost);
                    
                return ValidationResult.Fail("ä»·æ ¼å·²å˜æ›´ï¼Œè¯·åˆ·æ–°åé‡è¯•");
            }
        }
        
        return ValidationResult.Success();
    }
}
```

#### 4.1.3 å¼‚å¸¸è¡Œä¸ºæ£€æµ‹

```csharp
public class AnomalyDetectionService
{
    /// <summary>
    /// æ£€æµ‹å¼‚å¸¸è´­ä¹°è¡Œä¸º
    /// </summary>
    public async Task<bool> IsAnomalousBehavior(
        Guid characterId,
        string shopItemId,
        int quantity,
        CancellationToken ct)
    {
        // 1. æ£€æŸ¥çŸ­æ—¶é—´å†…å¤§é‡è´­ä¹°åŒä¸€å•†å“
        var recentPurchases = await _purchaseHistoryRepo.GetCharacterPurchaseHistoryAsync(
            characterId,
            startDate: DateTime.UtcNow.AddMinutes(-5),
            ct: ct);
        
        var sameItemCount = recentPurchases
            .Where(p => p.ShopItemId == shopItemId)
            .Sum(p => p.Quantity);
        
        if (sameItemCount > 100) // 5åˆ†é’Ÿå†…è´­ä¹°åŒä¸€å•†å“è¶…è¿‡100ä¸ª
        {
            _logger.LogWarning(
                "Anomaly: Rapid purchase detected. CharacterId={CharacterId}, ItemId={ItemId}, Count={Count}",
                characterId, shopItemId, sameItemCount);
            return true;
        }
        
        // 2. æ£€æŸ¥è´¦å·åˆ›å»ºåç«‹å³å¤§é¢æ¶ˆè´¹
        var character = await _characterRepo.GetByIdAsync(characterId, ct);
        var accountAge = DateTime.UtcNow - character.CreatedAt;
        
        if (accountAge < TimeSpan.FromHours(1) && quantity * GetItemPrice(shopItemId) > 10000)
        {
            _logger.LogWarning(
                "Anomaly: New account high-value purchase. CharacterId={CharacterId}, AccountAge={Age}",
                characterId, accountAge);
            return true;
        }
        
        return false;
    }
}
```

### 4.2 SQLæ³¨å…¥é˜²æŠ¤

```csharp
// âœ… æ¨èï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆEF Coreè‡ªåŠ¨å¤„ç†ï¼‰
public async Task<ShopDefinition?> GetShopDefinitionAsync(string shopId, ...)
{
    return await _dbContext.ShopDefinitions
        .FirstOrDefaultAsync(s => s.Id == shopId, ct); // å‚æ•°åŒ–
}

// âŒ é¿å…ï¼šå­—ç¬¦ä¸²æ‹¼æ¥SQLï¼ˆå®¹æ˜“æ³¨å…¥ï¼‰
// var sql = $"SELECT * FROM ShopDefinitions WHERE Id = '{shopId}'"; // å±é™©ï¼
```

### 4.3 æ•°æ®åŠ å¯†

```csharp
// æ•æ„Ÿæ•°æ®åŠ å¯†ï¼ˆå¦‚ä»£å¸ä½™é¢ï¼‰
public class EncryptionService
{
    private readonly byte[] _key;
    private readonly byte[] _iv;
    
    public string Encrypt(string plainText)
    {
        using var aes = Aes.Create();
        aes.Key = _key;
        aes.IV = _iv;
        
        var encryptor = aes.CreateEncryptor();
        var plainBytes = Encoding.UTF8.GetBytes(plainText);
        var encryptedBytes = encryptor.TransformFinalBlock(plainBytes, 0, plainBytes.Length);
        
        return Convert.ToBase64String(encryptedBytes);
    }
    
    public string Decrypt(string cipherText)
    {
        // è§£å¯†å®ç°...
    }
}
```

---

## 5. è¿ç»´ä¸é…ç½®ç®¡ç†

### 5.1 é…ç½®æ–‡ä»¶ç»“æ„

#### 5.1.1 appsettings.json

```json
{
  "ShopSystem": {
    "EnablePurchaseLimit": true,
    "DefaultCacheMinutes": 30,
    "MaxPurchaseQuantity": 999,
    "RefreshIntervals": {
      "Daily": "00:00:00",
      "Weekly": "Monday 00:00:00",
      "Hourly": "HH:00:00"
    },
    "RateLimiting": {
      "PurchasePerMinute": 20,
      "RefreshPerHour": 10
    },
    "Monitoring": {
      "EnableMetrics": true,
      "EnableDetailedLogs": false
    }
  },
  
  "ConnectionStrings": {
    "GameDatabase": "Data Source=game.db",
    "RedisCache": "localhost:6379"
  }
}
```

#### 5.1.2 å•†åº—é…ç½®ï¼ˆJSONæ–‡ä»¶æˆ–æ•°æ®åº“ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Configuration/Shops/shops_config.json`

```json
{
  "version": "1.0",
  "shops": [
    {
      "id": "shop_general_town",
      "name": "åŸé•‡æ‚è´§é“º",
      "shopType": "General",
      "refreshInterval": "Never",
      "items": [
        {
          "shopItemId": "item_bread",
          "itemType": "Consumable",
          "itemId": "consumable_bread",
          "prices": [
            { "currencyType": "Gold", "amount": 5 }
          ],
          "stockPolicy": "Infinite"
        }
      ]
    }
  ]
}
```

### 5.2 é…ç½®çƒ­æ›´æ–°

```csharp
public class ShopConfigReloadService : BackgroundService
{
    private readonly IOptionsMonitor<ShopSystemOptions> _options;
    private readonly IShopRepository _shopRepo;
    private readonly ILogger<ShopConfigReloadService> _logger;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _options.OnChange(async (options, name) =>
        {
            _logger.LogInformation("Shop configuration changed, reloading...");
            await ReloadConfigurationAsync(options);
        });
        
        while (!stoppingToken.IsCancellationRequested)
        {
            await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
        }
    }
    
    private async Task ReloadConfigurationAsync(ShopSystemOptions options)
    {
        // é‡æ–°åŠ è½½å•†åº—é…ç½®
        var configPath = options.ConfigFilePath;
        var json = await File.ReadAllTextAsync(configPath);
        var config = JsonSerializer.Deserialize<ShopConfiguration>(json);
        
        // æ›´æ–°åˆ°æ•°æ®åº“
        foreach (var shopDef in config.Shops)
        {
            await _shopRepo.SaveShopDefinitionAsync(shopDef);
        }
        
        // æ¸…é™¤ç¼“å­˜
        // _cache.Clear();
        
        _logger.LogInformation("Shop configuration reloaded successfully");
    }
}
```

### 5.3 æ•°æ®åº“å¤‡ä»½

```bash
#!/bin/bash
# backup_shop_data.sh

DB_FILE="/app/data/game.db"
BACKUP_DIR="/app/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/game_$DATE.db"

# åˆ›å»ºå¤‡ä»½
sqlite3 $DB_FILE ".backup $BACKUP_FILE"

# å‹ç¼©
gzip $BACKUP_FILE

# ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "game_*.db.gz" -mtime +7 -delete

echo "Backup completed: $BACKUP_FILE.gz"
```

### 5.4 å®šæ—¶ä»»åŠ¡ï¼ˆå•†åº—åˆ·æ–°ï¼‰

```csharp
using Quartz;

public class ShopRefreshJob : IJob
{
    private readonly IShopRefreshService _refreshService;
    private readonly ILogger<ShopRefreshJob> _logger;
    
    public async Task Execute(IJobExecutionContext context)
    {
        _logger.LogInformation("Starting scheduled shop refresh...");
        
        // è·å–éœ€è¦åˆ·æ–°çš„å•†åº—åˆ—è¡¨
        var shopsToRefresh = await GetShopsNeedingRefresh();
        
        foreach (var shopId in shopsToRefresh)
        {
            try
            {
                var result = await _refreshService.RefreshShopAsync(shopId);
                _logger.LogInformation("Shop refreshed: {ShopId}, Result={Result}", shopId, result.Message);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Failed to refresh shop: {ShopId}", shopId);
            }
        }
        
        _logger.LogInformation("Scheduled shop refresh completed");
    }
}

// Startup.cs é…ç½®
builder.Services.AddQuartz(q =>
{
    q.UseMicrosoftDependencyInjectionJobFactory();
    
    // æ¯æ—¥0ç‚¹åˆ·æ–°
    var jobKey = new JobKey("ShopRefreshJob");
    q.AddJob<ShopRefreshJob>(opts => opts.WithIdentity(jobKey));
    q.AddTrigger(opts => opts
        .ForJob(jobKey)
        .WithIdentity("ShopRefreshTrigger")
        .WithCronSchedule("0 0 0 * * ?")); // æ¯å¤©0ç‚¹
});

builder.Services.AddQuartzHostedService(q => q.WaitForJobsToComplete = true);
```

---

## 6. æ‰©å±•åŠŸèƒ½è®¾è®¡

### 6.1 æ‹å–è¡Œç³»ç»Ÿï¼ˆæœªæ¥ï¼‰

#### 6.1.1 æ•°æ®æ¨¡å‹è‰æ¡ˆ

```csharp
/// <summary>
/// æ‹å–ç‰©å“
/// </summary>
public class AuctionItem
{
    public Guid Id { get; set; }
    public Guid SellerId { get; set; }
    public string ItemType { get; set; } // Equipment/Material/Consumable
    public string ItemId { get; set; }
    
    public long StartingBid { get; set; }
    public long BuyoutPrice { get; set; }
    public long CurrentBid { get; set; }
    public Guid? CurrentBidder { get; set; }
    
    public DateTime ListedAt { get; set; }
    public DateTime ExpiresAt { get; set; }
    public AuctionStatus Status { get; set; }
}

public enum AuctionStatus
{
    Active,
    Sold,
    Expired,
    Cancelled
}
```

#### 6.1.2 æ ¸å¿ƒåŠŸèƒ½

- ä¸Šæ¶ç‰©å“ï¼ˆè®¾ç½®èµ·æ‹ä»·ã€ä¸€å£ä»·ï¼‰
- ç«ä»·ç³»ç»Ÿï¼ˆæœ€é«˜å‡ºä»·è€…è·å¾—ï¼‰
- è‡ªåŠ¨ç»“ç®—ï¼ˆåˆ°æœŸåè‡ªåŠ¨å¤„ç†ï¼‰
- æœç´¢ç­›é€‰ï¼ˆæŒ‰ç±»å‹ã€ä»·æ ¼ã€æ—¶é—´ï¼‰
- æ‰‹ç»­è´¹æœºåˆ¶ï¼ˆä¸Šæ¶è´¹ã€æˆäº¤è´¹ï¼‰

### 6.2 ç©å®¶é—´äº¤æ˜“ï¼ˆæœªæ¥ï¼‰

#### 6.2.1 å®‰å…¨äº¤æ˜“æµç¨‹

```
äº¤æ˜“æµç¨‹
â”œâ”€â”€ 1. ç©å®¶Aå‘èµ·äº¤æ˜“è¯·æ±‚ â†’ ç©å®¶B
â”œâ”€â”€ 2. ç©å®¶Bæ¥å—è¯·æ±‚
â”œâ”€â”€ 3. åŒæ–¹æ”¾å…¥ç‰©å“/é‡‘å¸
â”œâ”€â”€ 4. åŒæ–¹ç¡®è®¤
â”œâ”€â”€ 5. æœåŠ¡ç«¯éªŒè¯
â”‚   â”œâ”€â”€ æ£€æŸ¥ç‰©å“æ‰€æœ‰æƒ
â”‚   â”œâ”€â”€ æ£€æŸ¥èƒŒåŒ…ç©ºé—´
â”‚   â”œâ”€â”€ æ£€æŸ¥äº¤æ˜“é™åˆ¶ï¼ˆç»‘å®šç‰©å“ï¼‰
â”‚   â””â”€â”€ é˜²ä½œå¼Šæ£€æµ‹
â”œâ”€â”€ 6. æ‰§è¡Œäº¤æ˜“ï¼ˆäº‹åŠ¡ï¼‰
â”‚   â”œâ”€â”€ æ‰£é™¤ç‰©å“/é‡‘å¸
â”‚   â”œâ”€â”€ å‘æ”¾ç‰©å“/é‡‘å¸
â”‚   â””â”€â”€ è®°å½•äº¤æ˜“æ—¥å¿—
â””â”€â”€ 7. é€šçŸ¥åŒæ–¹ç»“æœ
```

#### 6.2.2 é˜²åˆ·æœºåˆ¶

- äº¤æ˜“å†·å´æ—¶é—´ï¼ˆæ¯æ¬¡äº¤æ˜“å10åˆ†é’Ÿï¼‰
- äº¤æ˜“é™é¢ï¼ˆæ¯æ—¥æœ€å¤š10ç¬”ï¼‰
- æ–°è´¦å·é™åˆ¶ï¼ˆåˆ›å»ºå24å°æ—¶å†…ä¸èƒ½äº¤æ˜“ï¼‰
- å¤§é¢äº¤æ˜“å®¡æ ¸ï¼ˆå•ç¬”>10ä¸‡é‡‘å¸éœ€å®¡æ ¸ï¼‰

### 6.3 é»‘å¸‚ç³»ç»Ÿï¼ˆæœªæ¥ï¼‰

#### 6.3.1 ç‰¹æ€§

- éšæœºåˆ·æ–°æ—¶é—´ï¼ˆ2-6å°æ—¶ï¼‰
- ç¨€æœ‰ç‰©å“ï¼ˆé«˜ä»·å€¼ã€é™é‡ï¼‰
- ç‰¹æ®Šè´§å¸ï¼ˆé»‘å¸‚ä»£å¸ï¼‰
- é£é™©æœºåˆ¶ï¼ˆè´­ä¹°å¯èƒ½è¢«"æ‰§æ³•è€…"ç½šæ¬¾ï¼‰

---

## 7. äº¤ä»˜æ¸…å•

### 7.1 ä»£ç äº¤ä»˜

| ç±»åˆ« | æ–‡ä»¶/ç›®å½• | è¯´æ˜ |
|-----|----------|------|
| **é¢†åŸŸæ¨¡å‹** | `Domain/Shop/Models/` | ShopDefinition, ShopInstance, ShopItemDefinitionç­‰ |
| **ä»“å‚¨æ¥å£** | `Domain/Shop/Repositories/` | IShopRepository, IPurchaseHistoryRepository |
| **åº”ç”¨æœåŠ¡** | `Application/Shop/Services/` | PurchaseService, ShopRefreshService |
| **éªŒè¯å™¨** | `Application/Shop/Validators/` | PurchaseValidator |
| **APIæ§åˆ¶å™¨** | `Controllers/ShopController.cs` | REST APIç«¯ç‚¹ |
| **å‰ç«¯é¡µé¢** | `BlazorIdle/Pages/Shop*.razor` | ShopList, ShopDetail |
| **å‰ç«¯ç»„ä»¶** | `BlazorIdle/Components/Shop*.razor` | ShopItemCard, PurchaseModal |
| **æ•°æ®è¿ç§»** | `Infrastructure/Persistence/Migrations/` | EF Coreè¿ç§»è„šæœ¬ |
| **é…ç½®æ–‡ä»¶** | `Configuration/Shops/` | å•†åº—JSONé…ç½® |
| **å•å…ƒæµ‹è¯•** | `Tests/Domain/Shop/` | é¢†åŸŸæ¨¡å‹æµ‹è¯• |
| **é›†æˆæµ‹è¯•** | `Tests/Integration/` | APIé›†æˆæµ‹è¯• |

### 7.2 æ–‡æ¡£äº¤ä»˜

| æ–‡æ¡£ | æ–‡ä»¶å | è¯´æ˜ |
|-----|--------|------|
| **è®¾è®¡æ–¹æ¡ˆï¼ˆä¸Šç¯‡ï¼‰** | `å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸Šç¯‡ï¼‰.md` | æ¶æ„è®¾è®¡ä¸æ ¸å¿ƒåŠŸèƒ½ |
| **è®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰** | `å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰.md` | è¯¦ç»†å®æ–½æ­¥éª¤ |
| **è®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰** | `å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰.md` | é›†æˆæµ‹è¯•ã€æ€§èƒ½ä¼˜åŒ–ã€è¿ç»´ |
| **APIæ–‡æ¡£** | `API/å•†åº—ç³»ç»ŸAPIæ–‡æ¡£.md` | RESTful APIæ¥å£è¯´æ˜ |
| **æ•°æ®åº“è®¾è®¡** | `Database/å•†åº—ç³»ç»Ÿæ•°æ®åº“è®¾è®¡.md` | ERå›¾ã€è¡¨ç»“æ„ã€ç´¢å¼• |
| **ç”¨æˆ·æ‰‹å†Œ** | `UserGuide/å•†åº—ç³»ç»Ÿç”¨æˆ·æ‰‹å†Œ.md` | ç©å®¶ä½¿ç”¨æŒ‡å— |
| **è¿ç»´æ‰‹å†Œ** | `Operations/å•†åº—ç³»ç»Ÿè¿ç»´æ‰‹å†Œ.md` | éƒ¨ç½²ã€é…ç½®ã€ç›‘æ§ |
| **æµ‹è¯•æŠ¥å‘Š** | `Testing/å•†åº—ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š.md` | æµ‹è¯•ç»“æœã€è¦†ç›–ç‡ |

### 7.3 é…ç½®äº¤ä»˜

| é…ç½® | æ–‡ä»¶ | è¯´æ˜ |
|-----|------|------|
| **å•†åº—é…ç½®** | `shops_config.json` | å•†åº—å®šä¹‰ã€å•†å“é…ç½® |
| **åº”ç”¨é…ç½®** | `appsettings.json` | ç³»ç»Ÿå‚æ•°ã€è¿æ¥å­—ç¬¦ä¸² |
| **ç›‘æ§é…ç½®** | `prometheus.yml` | Prometheusé‡‡é›†é…ç½® |
| **æ—¥å¿—é…ç½®** | `nlog.config` | æ—¥å¿—çº§åˆ«ã€è¾“å‡ºç›®æ ‡ |

### 7.4 éªŒæ”¶æ ‡å‡†

#### 7.4.1 åŠŸèƒ½éªŒæ”¶

- [ ] å•†åº—åˆ—è¡¨åŠ è½½æ­£å¸¸ï¼Œæ˜¾ç¤ºå·²è§£é”å•†åº—
- [ ] å•†åº—è¯¦æƒ…é¡µæ˜¾ç¤ºå•†å“åˆ—è¡¨ã€ä»·æ ¼ã€åº“å­˜
- [ ] è´­ä¹°åŠŸèƒ½æ­£å¸¸ï¼Œæ‰£é™¤è´§å¸å¹¶å‘æ”¾ç‰©å“
- [ ] é™è´­æœºåˆ¶ç”Ÿæ•ˆï¼ˆæ—¥é™è´­ã€å‘¨é™è´­ï¼‰
- [ ] åº“å­˜æ‰£å‡æ­£ç¡®ï¼ˆæœ‰é™åº“å­˜å•†å“ï¼‰
- [ ] å•†åº—åˆ·æ–°åŠŸèƒ½æ­£å¸¸ï¼ˆå®šæ—¶åˆ·æ–°ã€æ‰‹åŠ¨åˆ·æ–°ï¼‰
- [ ] æ¡ä»¶è§£é”ç”Ÿæ•ˆï¼ˆå•†åº—è§£é”ã€å•†å“è§£é”ï¼‰
- [ ] å¤šè´§å¸æ”¯æŒï¼ˆé‡‘å¸ã€å£°æœ›ã€è£èª‰ï¼‰

#### 7.4.2 æ€§èƒ½éªŒæ”¶

- [ ] å•†åº—åˆ—è¡¨åŠ è½½æ—¶é—´ < 500ms
- [ ] è´­ä¹°å“åº”æ—¶é—´ < 200msï¼ˆP95ï¼‰
- [ ] æ”¯æŒ100å¹¶å‘è´­ä¹°è¯·æ±‚
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 90%

#### 7.4.3 è´¨é‡éªŒæ”¶

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] æ— å†…å­˜æ³„æ¼
- [ ] æ— SQLæ³¨å…¥æ¼æ´
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## 8. é£é™©ä¸åº”å¯¹

### 8.1 å·²è¯†åˆ«é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|-----|------|------|---------|
| **æ¡ä»¶DSLå®ç°å¤æ‚** | ä¸­ | é«˜ | å…ˆå®ç°ç®€å•æ¡ä»¶ï¼Œå¤æ‚æ¡ä»¶å»¶å |
| **å¹¶å‘è´­ä¹°å†²çª** | é«˜ | ä¸­ | ä½¿ç”¨ä¹è§‚é” + é‡è¯• + åˆ†å¸ƒå¼é” |
| **æ€§èƒ½ç“¶é¢ˆ** | ä¸­ | ä¸­ | ç¼“å­˜ + ç´¢å¼•ä¼˜åŒ– + åˆ†é¡µåŠ è½½ |
| **æ•°æ®ä¸ä¸€è‡´** | ä½ | é«˜ | äº‹åŠ¡ä¿è¯ + å¹‚ç­‰æ€§è®¾è®¡ |
| **ç©å®¶åˆ·é‡‘å¸** | ä¸­ | é«˜ | é™é¢‘ + å¼‚å¸¸æ£€æµ‹ + æ—¥å¿—å®¡è®¡ |

### 8.2 æœªæ¥æŒ‘æˆ˜

- **ç»æµé€šèƒ€æ§åˆ¶**ï¼šé•¿æœŸè¿è¥åè´§å¸è´¬å€¼
- **æ‹å–è¡Œæ€§èƒ½**ï¼šæµ·é‡å•†å“æœç´¢ä¼˜åŒ–
- **è·¨æœäº¤æ˜“**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
- **ä½œå¼Šå¯¹æŠ—**ï¼šå¤–æŒ‚ã€è„šæœ¬æ£€æµ‹

---

## 9. æ€»ç»“

æœ¬è®¾è®¡æ–¹æ¡ˆæ¶µç›–äº†å•†åº—ç³»ç»Ÿä»æ¶æ„è®¾è®¡åˆ°å®æ–½è½åœ°çš„å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

### 9.1 æ ¸å¿ƒæˆæœ

1. **å®Œæ•´çš„é¢†åŸŸæ¨¡å‹**ï¼šShopAggregateã€ShopItemã€PurchaseLimitç­‰
2. **çµæ´»çš„ä»·æ ¼ç³»ç»Ÿ**ï¼šæ”¯æŒå¤šè´§å¸ã€æŠ˜æ‰£ã€åŠ¨æ€å®šä»·
3. **å¼ºå¤§çš„æ¡ä»¶è§£é”**ï¼šDSLè¡¨è¾¾å¼ã€ç¼“å­˜ä¼˜åŒ–
4. **å¥å£®çš„å¹¶å‘æ§åˆ¶**ï¼šä¹è§‚é”ã€åˆ†å¸ƒå¼é”ã€å¹‚ç­‰æ€§ä¿è¯
5. **å…¨é¢çš„ç›‘æ§ä½“ç³»**ï¼šPrometheusæŒ‡æ ‡ã€ç»“æ„åŒ–æ—¥å¿—
6. **å®‰å…¨çš„é˜²åˆ·æœºåˆ¶**ï¼šé™é¢‘ã€ä»·æ ¼éªŒè¯ã€å¼‚å¸¸æ£€æµ‹

### 9.2 è®¾è®¡äº®ç‚¹

- âœ… **æ•°æ®é©±åŠ¨**ï¼šå•†åº—é…ç½®åŒ–ï¼Œæ˜“äºæ‰©å±•
- âœ… **æœåŠ¡ç«¯æƒå¨**ï¼šæ‰€æœ‰äº¤æ˜“æœåŠ¡ç«¯éªŒè¯
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜ã€ç´¢å¼•ã€åˆ†é¡µ
- âœ… **å¯ç›‘æ§å¯è¿ç»´**ï¼šæŒ‡æ ‡ã€æ—¥å¿—ã€å‘Šè­¦
- âœ… **ä¸ºæœªæ¥é¢„ç•™æ¥å£**ï¼šæ‹å–è¡Œã€äº¤æ˜“è¡Œã€é»‘å¸‚

### 9.3 åç»­å·¥ä½œ

- Phase 1-4å®æ–½ï¼ˆçº¦4-5å‘¨ï¼‰
- é›†æˆæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰
- éƒ¨ç½²ä¸Šçº¿ä¸ç›‘æ§ï¼ˆ3å¤©ï¼‰
- è¿­ä»£ä¼˜åŒ–ä¸æ‰©å±•åŠŸèƒ½å¼€å‘

---

**æ–‡æ¡£å®Œæˆ - å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆå…¨å¥—ï¼ˆä¸Šä¸­ä¸‹ä¸‰ç¯‡ï¼‰å·²äº¤ä»˜** ğŸ‰

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### A. å…³é”®APIç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|-----|------|------|
| `/api/shops` | GET | è·å–å•†åº—åˆ—è¡¨ |
| `/api/shops/{shopId}` | GET | è·å–å•†åº—è¯¦æƒ… |
| `/api/shops/purchase` | POST | è´­ä¹°å•†å“ |
| `/api/shops/{shopId}/refresh` | POST | æ‰‹åŠ¨åˆ·æ–°å•†åº— |
| `/api/purchase-history` | GET | è´­ä¹°å†å² |

### B. æ•°æ®åº“è¡¨æ¸…å•

- ShopDefinitions
- ShopItemDefinitions
- ShopInstance
- ShopItemStock
- PurchaseRecord
- CharacterPurchaseRecord
- ReputationRecord (æ–°å¢)
- CharacterWallet (æ–°å¢)
- TokenBalance (æ–°å¢)

### C. é…ç½®å‚æ•°

- `ShopSystem:EnablePurchaseLimit` - æ˜¯å¦å¯ç”¨é™è´­
- `ShopSystem:DefaultCacheMinutes` - ç¼“å­˜æ—¶é•¿
- `ShopSystem:MaxPurchaseQuantity` - å•æ¬¡æœ€å¤§è´­ä¹°æ•°é‡

### D. ç›‘æ§æŒ‡æ ‡

- `shop_purchase_total` - è´­ä¹°æ€»æ•°
- `shop_purchase_duration_seconds` - è´­ä¹°å»¶è¿Ÿ
- `shop_stock_depleted_total` - åº“å­˜è€—å°½æ¬¡æ•°
- `shop_currency_flow_total` - è´§å¸æµé€šé‡

---

**END**
