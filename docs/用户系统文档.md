# ç”¨æˆ·ç³»ç»Ÿï¼ˆUser Systemï¼‰æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ç”¨æˆ·è´¦å·ç³»ç»Ÿçš„è®¾è®¡ã€å®ç°å’Œä½¿ç”¨æ–¹æ³•ã€‚ç”¨æˆ·ç³»ç»Ÿä¸ºæ¸¸æˆæä¾›è´¦å·ç®¡ç†åŠŸèƒ½ï¼Œæ”¯æŒä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰å¤šä¸ªè§’è‰²ï¼ˆä¸ºæœªæ¥çš„ Roster ç³»ç»Ÿå¥ å®šåŸºç¡€ï¼‰ã€‚

## è®¾è®¡ç›®æ ‡

1. **è´¦å·ç®¡ç†**: æä¾›ç”¨æˆ·è´¦å·çš„åŸºæœ¬ä¿¡æ¯å­˜å‚¨ï¼ˆç”¨æˆ·åã€é‚®ç®±ç­‰ï¼‰
2. **å¤šè§’è‰²æ”¯æŒ**: ä¸€ä¸ªç”¨æˆ·å¯ä»¥åˆ›å»ºå’Œç®¡ç†å¤šä¸ªæ¸¸æˆè§’è‰²ï¼ˆæ”¯æŒ Roster ç³»ç»Ÿï¼‰
3. **æ¾è€¦åˆè®¾è®¡**: UserId ä¸ºå¯ç©ºå¤–é”®ï¼Œä¿æŒå‘åå…¼å®¹ï¼Œä¸ç ´åç°æœ‰æ— è´¦å·è§’è‰²
4. **å¯æ‰©å±•æ€§**: ä¸ºæœªæ¥çš„è®¤è¯ã€æˆæƒã€ç¤¾äº¤åŠŸèƒ½é¢„ç•™æ¥å£

## æ•°æ®åº“æ¶æ„

### è¡¨ç»“æ„

#### 1. users (ç”¨æˆ·è¡¨)

å­˜å‚¨ç”¨æˆ·è´¦å·çš„åŸºæœ¬ä¿¡æ¯ã€‚

| åˆ—å | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| Id | GUID | PRIMARY KEY | ç”¨æˆ·ID |
| Username | VARCHAR(64) | NOT NULL, UNIQUE | ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰ |
| Email | VARCHAR(256) | NOT NULL, UNIQUE | ç”µå­é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰ |
| PasswordHash | VARCHAR(256) | NOT NULL | å¯†ç å“ˆå¸Œï¼ˆBCryptï¼‰ |
| CreatedAt | DATETIME | NOT NULL | è´¦å·åˆ›å»ºæ—¶é—´ |
| UpdatedAt | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |
| LastLoginAt | DATETIME | NULL | æœ€åç™»å½•æ—¶é—´ï¼ˆå¯é€‰ï¼‰ |

**ç´¢å¼•**:
- PRIMARY KEY: `Id`
- UNIQUE INDEX: `Username` - ç¡®ä¿ç”¨æˆ·åå”¯ä¸€
- UNIQUE INDEX: `Email` - ç¡®ä¿é‚®ç®±å”¯ä¸€

**è®¾è®¡è¯´æ˜**:
- Username å’Œ Email éƒ½è®¾ä¸ºå”¯ä¸€ï¼Œä¸¤è€…éƒ½å¯ç”¨äºç™»å½•è¯†åˆ«
- LastLoginAt å¯é€‰å­—æ®µï¼Œç”¨äºè·Ÿè¸ªç”¨æˆ·æ´»è·ƒåº¦
- UpdatedAt å­—æ®µä¸ºæœªæ¥çš„è´¦å·ä¿¡æ¯æ›´æ–°é¢„ç•™

#### 2. Characters (è§’è‰²è¡¨) - æ–°å¢å­—æ®µ

åœ¨ç°æœ‰è§’è‰²è¡¨ä¸­æ–°å¢ç”¨æˆ·å…³è”å­—æ®µï¼š

| åˆ—å | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| UserId | GUID | NULL, FOREIGN KEY | æ‰€å±ç”¨æˆ·IDï¼ˆå¯ç©ºï¼‰ |

**ç´¢å¼•**:
- INDEX: `UserId` - æå‡æŒ‰ç”¨æˆ·æŸ¥è¯¢è§’è‰²çš„æ€§èƒ½
- INDEX: `(UserId, RosterOrder)` - å¤åˆç´¢å¼•ï¼Œä¼˜åŒ–æŒ‰é¡ºåºæŸ¥è¯¢è§’è‰²
- FOREIGN KEY: `UserId` â†’ `users(Id)` ON DELETE SET NULL

**è®¾è®¡è¯´æ˜**:
- UserId è®¾ä¸ºå¯ç©ºï¼Œä¿æŒå‘åå…¼å®¹ï¼ˆæ”¯æŒæœªç»‘å®šç”¨æˆ·çš„è§’è‰²ï¼‰
- RosterOrder é»˜è®¤ä¸º 0ï¼Œæ”¯æŒè§’è‰²æ’åºåŠŸèƒ½ï¼ˆç”¨äº Roster æ§½ä½ç®¡ç†ï¼‰
- ON DELETE SET NULLï¼šåˆ é™¤ç”¨æˆ·æ—¶ä¸åˆ é™¤è§’è‰²ï¼Œä»…å°† UserId è®¾ä¸º NULLï¼ˆä¿ç•™å­¤ç«‹è§’è‰²ï¼‰
- ç´¢å¼•ä¼˜åŒ–ï¼šåŠ é€Ÿ "æŸ¥è¯¢æŸç”¨æˆ·çš„æ‰€æœ‰è§’è‰²" å’Œ "æŒ‰é¡ºåºæ˜¾ç¤ºè§’è‰²" åœºæ™¯

### æ•°æ®å…³ç³»å›¾

```
users (ç”¨æˆ·)
    â””â”€â”€ 1:N â†’ Characters (è§’è‰²)

Characters (è§’è‰²)
    â”œâ”€â”€ N:1 â†’ users (ç”¨æˆ·) [å¯é€‰]
    â”œâ”€â”€ 1:N â†’ inventory_items (èƒŒåŒ…ç‰©å“)
    â””â”€â”€ 1:N â†’ economy_events (ç»æµäº‹ä»¶)
```

## é¢†åŸŸæ¨¡å‹

### User ç±»

```csharp
namespace BlazorIdle.Server.Domain.Characters;

/// <summary>
/// ç”¨æˆ·è´¦å·å®ä½“ï¼Œç”¨äºç®¡ç†ç”¨æˆ·ç™»å½•ä¿¡æ¯å’Œè§’è‰²å…³è”ã€‚
/// ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šä¸ªè§’è‰²ï¼ˆæ”¯æŒæœªæ¥çš„ Roster ç³»ç»Ÿï¼‰ã€‚
/// </summary>
public class User
{
    public Guid Id { get; set; }
    public string Username { get; set; } = "";
    public string Email { get; set; } = "";
    public string PasswordHash { get; set; } = "";  // å¯†ç å“ˆå¸Œï¼ˆBCryptï¼‰
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? LastLoginAt { get; set; }
    
    // Navigation property - ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šä¸ªè§’è‰²
    public ICollection<Character> Characters { get; set; } = new List<Character>();
}
```

### Character ç±»å˜æ›´

åœ¨ `Character` ç±»ä¸­æ–°å¢ï¼š

```csharp
/// <summary>
/// æ‰€å±ç”¨æˆ· IDï¼ˆå¤–é”®ï¼‰
/// </summary>
public Guid? UserId { get; set; }

/// <summary>
/// è§’è‰²åœ¨ç”¨æˆ· Roster ä¸­çš„æ˜¾ç¤ºé¡ºåºï¼ˆç”¨äºå¤šè§’è‰²ç®¡ç†ï¼‰
/// </summary>
public int RosterOrder { get; set; } = 0;

// Navigation property - æ‰€å±ç”¨æˆ·
public User? User { get; set; }
```

## EF Core é…ç½®

### UserConfiguration

```csharp
public class UserConfiguration : IEntityTypeConfiguration<User>
{
    public void Configure(EntityTypeBuilder<User> builder)
    {
        builder.ToTable("users");
        builder.HasKey(u => u.Id);
        
        // ç”¨æˆ·åï¼šå¿…å¡«ï¼Œå”¯ä¸€ï¼Œæœ€å¤§é•¿åº¦ 64
        builder.Property(u => u.Username)
            .IsRequired()
            .HasMaxLength(64);
        builder.HasIndex(u => u.Username).IsUnique();
        
        // ç”µå­é‚®ç®±ï¼šå¿…å¡«ï¼Œå”¯ä¸€ï¼Œæœ€å¤§é•¿åº¦ 256
        builder.Property(u => u.Email)
            .IsRequired()
            .HasMaxLength(256);
        builder.HasIndex(u => u.Email).IsUnique();
        
        // å¯†ç å“ˆå¸Œï¼šå¿…å¡«ï¼Œæœ€å¤§é•¿åº¦ 256
        builder.Property(u => u.PasswordHash)
            .IsRequired()
            .HasMaxLength(256);
        
        // é…ç½®ä¸ Character çš„ä¸€å¯¹å¤šå…³ç³»
        builder.HasMany(u => u.Characters)
            .WithOne(c => c.User)
            .HasForeignKey(c => c.UserId)
            .OnDelete(DeleteBehavior.SetNull);
    }
}
```

### CharacterConfiguration æ›´æ–°

```csharp
// åœ¨ CharacterConfiguration.Configure æ–¹æ³•ä¸­æ·»åŠ ï¼š
b.Property(x => x.UserId);
b.HasIndex(x => x.UserId);

// è§’è‰²åœ¨ç”¨æˆ· Roster ä¸­çš„æ˜¾ç¤ºé¡ºåº
b.Property(x => x.RosterOrder)
    .HasDefaultValue(0);
b.HasIndex(x => new { x.UserId, x.RosterOrder });
```

## æ•°æ®åº“è¿ç§»

### åº”ç”¨è¿ç§»

```bash
# æŸ¥çœ‹è¿ç§»
cd BlazorIdle.Server
dotnet ef migrations list

# åº”ç”¨è¿ç§»åˆ°æ•°æ®åº“
dotnet ef database update

# æˆ–åœ¨å¼€å‘ç¯å¢ƒè‡ªåŠ¨è¿ç§»ï¼ˆProgram.cs ä¸­å·²é…ç½®ï¼‰
dotnet run
```

### è¿ç§»å†…å®¹

è¿ç§» `20251007064214_AddUserTable` åŒ…å«ä»¥ä¸‹æ“ä½œï¼š

1. åˆ›å»º `users` è¡¨åŠå…¶ç´¢å¼•
2. åœ¨ `Characters` è¡¨ä¸­æ·»åŠ  `UserId` åˆ—
3. åˆ›å»ºå¤–é”®çº¦æŸ `FK_Characters_users_UserId`
4. åˆ›å»ºç´¢å¼• `IX_Characters_UserId`

è¿ç§» `20251007073221_AddPasswordAndRosterOrder` åŒ…å«ä»¥ä¸‹æ“ä½œï¼š

1. åœ¨ `users` è¡¨ä¸­æ·»åŠ  `PasswordHash` åˆ—ï¼ˆVARCHAR(256), NOT NULLï¼‰
2. åœ¨ `Characters` è¡¨ä¸­æ·»åŠ  `RosterOrder` åˆ—ï¼ˆINTEGER, NOT NULL, DEFAULT 0ï¼‰
3. åˆ›å»ºå¤åˆç´¢å¼• `IX_Characters_UserId_RosterOrder`

### å›æ»šè¿ç§»

å¦‚éœ€å›æ»šï¼š

```bash
dotnet ef migrations remove
# æˆ–å›æ»šåˆ°æŒ‡å®šè¿ç§»
dotnet ef database update <PreviousMigrationName>
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºç”¨æˆ·

```csharp
// æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶åº”ä½¿ç”¨ BCrypt.Net ç­‰åº“è¿›è¡Œå¯†ç å“ˆå¸Œ
// ç¤ºä¾‹: using BCrypt.Net;
// string passwordHash = BCrypt.HashPassword("userPassword");

var user = new User
{
    Id = Guid.NewGuid(),
    Username = "player123",
    Email = "player123@example.com",
    PasswordHash = BCrypt.Net.BCrypt.HashPassword("securePassword123"),  // ä½¿ç”¨ BCrypt å“ˆå¸Œå¯†ç 
    CreatedAt = DateTime.UtcNow,
    UpdatedAt = DateTime.UtcNow
};

_db.Users.Add(user);
await _db.SaveChangesAsync();
```

### 2. åˆ›å»ºè§’è‰²å¹¶å…³è”ç”¨æˆ·

```csharp
var character = new Character
{
    Id = Guid.NewGuid(),
    UserId = user.Id,  // å…³è”åˆ°ç”¨æˆ·
    RosterOrder = 0,   // ç¬¬ä¸€ä¸ªè§’è‰²ï¼Œé¡ºåºä¸º 0
    Name = "å‹‡è€…å°æ˜",
    Profession = Profession.Warrior,
    Level = 1
};

_db.Characters.Add(character);
await _db.SaveChangesAsync();
```

### 3. éªŒè¯ç”¨æˆ·å¯†ç 

```csharp
// ç”¨æˆ·ç™»å½•æ—¶éªŒè¯å¯†ç 
var user = await _db.Users
    .FirstOrDefaultAsync(u => u.Username == username);

if (user != null && BCrypt.Net.BCrypt.Verify(inputPassword, user.PasswordHash))
{
    // å¯†ç æ­£ç¡®ï¼Œæ›´æ–°æœ€åç™»å½•æ—¶é—´
    user.LastLoginAt = DateTime.UtcNow;
    await _db.SaveChangesAsync();
    
    // ç™»å½•æˆåŠŸé€»è¾‘...
}
else
{
    // å¯†ç é”™è¯¯æˆ–ç”¨æˆ·ä¸å­˜åœ¨
}
```

### 4. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²ï¼ˆæŒ‰é¡ºåºï¼‰

```csharp
// æ–¹å¼ 1: ä½¿ç”¨ Include åŠ è½½å¯¼èˆªå±æ€§å¹¶æ’åº
var user = await _db.Users
    .Include(u => u.Characters.OrderBy(c => c.RosterOrder))
    .FirstOrDefaultAsync(u => u.Id == userId);

var characters = user?.Characters;

// æ–¹å¼ 2: ç›´æ¥æŸ¥è¯¢è§’è‰²å¹¶æŒ‰ RosterOrder æ’åº
var characters = await _db.Characters
    .Where(c => c.UserId == userId)
    .OrderBy(c => c.RosterOrder)
    .ToListAsync();
```

### 5. æŸ¥è¯¢è§’è‰²åŠå…¶æ‰€å±ç”¨æˆ·

```csharp
var character = await _db.Characters
    .Include(c => c.User)
    .FirstOrDefaultAsync(c => c.Id == characterId);

var username = character?.User?.Username;
```

### 6. è°ƒæ•´è§’è‰²é¡ºåº

```csharp
// ä¸ºç”¨æˆ·çš„è§’è‰²é‡æ–°æ’åº
var characters = await _db.Characters
    .Where(c => c.UserId == userId)
    .OrderBy(c => c.RosterOrder)
    .ToListAsync();

// ä¾‹å¦‚ï¼šå°†ç¬¬ä¸‰ä¸ªè§’è‰²ç§»åŠ¨åˆ°ç¬¬ä¸€ä½
if (characters.Count >= 3)
{
    var characterToMove = characters[2];
    
    // å°†å…¶ä»–è§’è‰²å‘åç§»
    foreach (var c in characters.Take(2))
    {
        c.RosterOrder++;
    }
    
    // å°†ç›®æ ‡è§’è‰²ç§»åˆ°æœ€å‰
    characterToMove.RosterOrder = 0;
    
    await _db.SaveChangesAsync();
}
```

### 7. å¤„ç†æœªç»‘å®šç”¨æˆ·çš„è§’è‰²

```csharp
// æŸ¥è¯¢æ‰€æœ‰æœªç»‘å®šç”¨æˆ·çš„è§’è‰²ï¼ˆå­¤ç«‹è§’è‰²ï¼‰
var orphanCharacters = await _db.Characters
    .Where(c => c.UserId == null)
    .ToListAsync();

// å°†å­¤ç«‹è§’è‰²ç»‘å®šåˆ°ç”¨æˆ·
var character = await _db.Characters.FindAsync(characterId);
if (character != null && character.UserId == null)
{
    character.UserId = userId;
    await _db.SaveChangesAsync();
}
```

## API ç«¯ç‚¹å»ºè®®

è™½ç„¶å½“å‰æœªå®ç° APIï¼Œä½†å»ºè®®æ·»åŠ ä»¥ä¸‹ç«¯ç‚¹ï¼š

### ç”¨æˆ·ç®¡ç†

- `POST /api/users` - åˆ›å»ºç”¨æˆ·
- `GET /api/users/{id}` - è·å–ç”¨æˆ·ä¿¡æ¯
- `PUT /api/users/{id}` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- `GET /api/users/{id}/characters` - è·å–ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²

### è§’è‰²ç®¡ç†ï¼ˆæ›´æ–°ï¼‰

- `POST /api/characters` - åˆ›å»ºè§’è‰²ï¼ˆå¯é€‰ userId å’Œ rosterOrder å‚æ•°ï¼‰
- `PUT /api/characters/{id}/bind-user` - å°†è§’è‰²ç»‘å®šåˆ°ç”¨æˆ·
- `PUT /api/characters/{id}/reorder` - è°ƒæ•´è§’è‰²åœ¨ Roster ä¸­çš„é¡ºåº

### è®¤è¯ç«¯ç‚¹ï¼ˆå»ºè®®ï¼‰

- `POST /api/auth/login` - ç”¨æˆ·ç™»å½•ï¼ˆéªŒè¯ç”¨æˆ·å/é‚®ç®±å’Œå¯†ç ï¼‰
- `POST /api/auth/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/auth/change-password` - ä¿®æ”¹å¯†ç 
- `POST /api/auth/reset-password` - é‡ç½®å¯†ç ï¼ˆéœ€è¦é‚®ç®±éªŒè¯ï¼‰

## æœ€ä½³å®è·µ

### æ•°æ®ä¸€è‡´æ€§

1. **å‘åå…¼å®¹**: UserId ä¸ºå¯ç©ºï¼Œä¸å¼ºåˆ¶è¦æ±‚æ‰€æœ‰è§’è‰²å¿…é¡»ç»‘å®šç”¨æˆ·
2. **æ•°æ®å®Œæ•´æ€§**: åˆ©ç”¨æ•°æ®åº“ç´¢å¼•ç¡®ä¿ç”¨æˆ·åå’Œé‚®ç®±å”¯ä¸€æ€§
3. **è½¯åˆ é™¤**: åˆ é™¤ç”¨æˆ·æ—¶è§’è‰²ä¸è¢«åˆ é™¤ï¼Œä»…è§£é™¤å…³è”ï¼ˆSET NULLï¼‰
4. **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨ Include é¢„åŠ è½½å…³è”æ•°æ®ï¼Œé¿å… N+1 æŸ¥è¯¢é—®é¢˜
5. **æ—¶é—´æˆ³ç®¡ç†**: æ¯æ¬¡æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ—¶æ›´æ–° UpdatedAt å­—æ®µ

### å¯†ç å®‰å…¨æœ€ä½³å®è·µ

1. **ä½¿ç”¨ BCrypt**: æ¨èä½¿ç”¨ `BCrypt.Net-Next` NuGet åŒ…
   ```bash
   dotnet add package BCrypt.Net-Next
   ```

2. **å¯†ç å“ˆå¸Œç¤ºä¾‹**:
   ```csharp
   // æ³¨å†Œæ—¶å“ˆå¸Œå¯†ç 
   string passwordHash = BCrypt.Net.BCrypt.HashPassword(plainPassword);
   
   // ç™»å½•æ—¶éªŒè¯å¯†ç 
   bool isValid = BCrypt.Net.BCrypt.Verify(plainPassword, storedHash);
   ```

3. **å¯†ç å¼ºåº¦è¦æ±‚**ï¼ˆå»ºè®®åœ¨åº”ç”¨å±‚å®ç°ï¼‰:
   - æœ€å°é•¿åº¦ï¼š8 å­—ç¬¦
   - åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
   - ä¸ä½¿ç”¨å¸¸è§å¯†ç ï¼ˆå¦‚ "password123"ï¼‰
   
4. **å®‰å…¨å­˜å‚¨åŸåˆ™**:
   - âŒ æ°¸è¿œä¸è¦å­˜å‚¨æ˜æ–‡å¯†ç 
   - âŒ ä¸ä½¿ç”¨ MD5 æˆ– SHA1ï¼ˆå·²è¢«ç ´è§£ï¼‰
   - âœ… ä½¿ç”¨ BCryptã€Argon2 æˆ– PBKDF2
   - âœ… BCrypt è‡ªåŠ¨å¤„ç†ç›å€¼ï¼Œæ¯æ¬¡å“ˆå¸Œç»“æœéƒ½ä¸åŒ

### è§’è‰²æ’åºæœ€ä½³å®è·µ

1. **RosterOrder ä½¿ç”¨**:
   - æ–°å»ºè§’è‰²æ—¶è‡ªåŠ¨åˆ†é…ä¸‹ä¸€ä¸ªå¯ç”¨çš„é¡ºåºå·
   - åˆ é™¤è§’è‰²æ—¶å¯é€‰æ‹©æ˜¯å¦é‡æ–°æ’åºå…¶ä»–è§’è‰²
   - æŸ¥è¯¢æ—¶å§‹ç»ˆæŒ‰ RosterOrder æ’åº

2. **æ’åºç¤ºä¾‹**:
   ```csharp
   // è·å–ç”¨æˆ·ä¸‹ä¸€ä¸ªå¯ç”¨çš„é¡ºåºå·
   var nextOrder = await _db.Characters
       .Where(c => c.UserId == userId)
       .MaxAsync(c => (int?)c.RosterOrder) ?? -1;
   
   newCharacter.RosterOrder = nextOrder + 1;
   ```

## ä¸ Roster ç³»ç»Ÿçš„å…³ç³»

å½“å‰å®ç°ä¸ºæœªæ¥çš„ Roster ç³»ç»Ÿæ‰“ä¸‹åŸºç¡€ï¼š

- **User**: è´¦å·çº§åˆ«çš„å®ä½“ï¼Œç®¡ç†å¤šä¸ªè§’è‰²
- **Character**: è§’è‰²å®ä½“ï¼Œå±äºæŸä¸ªç”¨æˆ·
- **æœªæ¥æ‰©å±•**: 
  - Roster æ§½ä½ç®¡ç†ï¼ˆRosterSlot è¡¨ï¼‰
  - è§’è‰²åˆ‡æ¢é€»è¾‘
  - è´¦å·çº§å…±äº«èµ„æºï¼ˆæ—¥å¸¸é™é¢ã€å£°æœ›ç­‰ï¼‰

## å®‰å…¨è€ƒè™‘

1. **å¯†ç å­˜å‚¨**: 
   - âœ… å·²å®ç° `PasswordHash` å­—æ®µï¼Œä½¿ç”¨ BCrypt å“ˆå¸Œç®—æ³•å­˜å‚¨å¯†ç 
   - BCrypt è‡ªåŠ¨å¤„ç†ç›å€¼ï¼ˆsaltï¼‰ï¼Œæ¯æ¬¡å“ˆå¸Œç”Ÿæˆå”¯ä¸€ç»“æœ
   - æ¨èä½¿ç”¨ `BCrypt.Net-Next` NuGet åŒ…
   - æ°¸è¿œä¸è¦å­˜å‚¨æ˜æ–‡å¯†ç æˆ–å¯é€†åŠ å¯†çš„å¯†ç 
   
2. **å¯†ç ç­–ç•¥**:
   - å»ºè®®åœ¨åº”ç”¨å±‚æ·»åŠ å¯†ç å¼ºåº¦éªŒè¯ï¼ˆæœ€å°é•¿åº¦ã€å¤æ‚åº¦è¦æ±‚ï¼‰
   - å®ç°å¯†ç é‡ç½®åŠŸèƒ½æ—¶ä½¿ç”¨æ—¶é™æ€§ä»¤ç‰Œ
   - è€ƒè™‘æ·»åŠ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
   
3. **é‚®ç®±éªŒè¯**: å»ºè®®æ·»åŠ é‚®ç®±éªŒè¯æœºåˆ¶ï¼ˆå‘é€éªŒè¯é“¾æ¥ï¼‰

4. **ç”¨æˆ·åè§„åˆ™**: å»ºè®®åœ¨åº”ç”¨å±‚æ·»åŠ ç”¨æˆ·åæ ¼å¼éªŒè¯ï¼ˆé•¿åº¦ã€å­—ç¬¦é™åˆ¶ï¼‰

5. **è®¿é—®æ§åˆ¶**: ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„è§’è‰²æ•°æ®

6. **è§’è‰²é¡ºåº**: RosterOrder ä»…ç”¨äºæ˜¾ç¤ºæ’åºï¼Œä¸åº”å½±å“åŠŸèƒ½æƒé™

## å·²å®ç°åŠŸèƒ½

1. âœ… **å¯†ç åŠŸèƒ½**: 
   - PasswordHash å­—æ®µä½¿ç”¨ BCrypt å®‰å…¨å­˜å‚¨å¯†ç 
   - æ”¯æŒå¯†ç éªŒè¯å’Œæ›´æ–°
   
2. âœ… **è§’è‰²æ’åº**: 
   - RosterOrder å­—æ®µæ”¯æŒè§’è‰²åœ¨ Roster ä¸­çš„æ˜¾ç¤ºé¡ºåº
   - å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
   - ä¾¿äºå®ç°è§’è‰²æ§½ä½ç®¡ç†

## åç»­å¢å¼º

1. **è®¤è¯ç³»ç»Ÿ**: é›†æˆ JWT æˆ– Cookie è®¤è¯
2. **å¯†ç ç®¡ç†**: å®ç°å¯†ç é‡ç½®ã€ä¿®æ”¹å¯†ç åŠŸèƒ½
3. **ç”¨æˆ·èµ„æ–™**: æ‰©å±•ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤´åƒã€ç®€ä»‹ç­‰ï¼‰
4. **ç¤¾äº¤åŠŸèƒ½**: å¥½å‹ç³»ç»Ÿã€å…¬ä¼šç³»ç»Ÿ
5. **Roster æ§½ä½**: å®ç°æ§½ä½è§£é”å’Œåˆ‡æ¢é€»è¾‘
6. **è´¦å·çº§èµ„æº**: å…±äº«æ—¥å¸¸é™é¢ã€å£°æœ›ç­‰
7. **å¯†ç ç­–ç•¥**: å®ç°å¯†ç å¼ºåº¦æ£€æŸ¥ã€ç™»å½•å¤±è´¥é™åˆ¶

## ç›¸å…³æ–‡ä»¶

### é¢†åŸŸå±‚
- `BlazorIdle.Server/Domain/Characters/User.cs`
- `BlazorIdle.Server/Domain/Characters/Character.cs`

### åŸºç¡€è®¾æ–½å±‚
- `BlazorIdle.Server/Infrastructure/Persistence/Configurations/UserConfiguration.cs`
- `BlazorIdle.Server/Infrastructure/Persistence/Configurations/CharacterConfiguration.cs`
- `BlazorIdle.Server/Infrastructure/Persistence/GameDbContext.cs`

### æ•°æ®åº“è¿ç§»
- `BlazorIdle.Server/Migrations/20251007064214_AddUserTable.cs`
- `BlazorIdle.Server/Migrations/20251007064214_AddUserTable.Designer.cs`

## æ€»ç»“

ç”¨æˆ·ç³»ç»Ÿçš„å®ç°éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **æœ€å°åŒ–å˜æ›´**: ä»…åœ¨å¿…è¦çš„åœ°æ–¹æ·»åŠ ä»£ç ï¼Œä¸ä¿®æ”¹ç°æœ‰å·¥ä½œé€»è¾‘
2. **ä¿æŒä¸€è‡´**: éµå¾ªé¡¹ç›®ç°æœ‰çš„ä»£ç é£æ ¼å’Œæ¶æ„æ¨¡å¼
3. **å‘åå…¼å®¹**: UserId å¯ç©ºè®¾è®¡ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½
4. **é¢å‘æœªæ¥**: ä¸º Roster ç³»ç»Ÿå’Œæ›´å¤šåŠŸèƒ½é¢„ç•™æ‰©å±•ç©ºé—´
5. **æ–‡æ¡£å®Œæ•´**: æä¾›æ¸…æ™°çš„æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

é€šè¿‡è¿™ä¸ªè®¾è®¡ï¼Œæ¸¸æˆç°åœ¨æ”¯æŒç”¨æˆ·è´¦å·ç®¡ç†ï¼ŒåŒæ—¶ä¸ºæœªæ¥çš„å¤šè§’è‰² Roster ç³»ç»Ÿæ‰“ä¸‹äº†åšå®çš„åŸºç¡€ã€‚

---

## âœ¨ æœ€æ–°æ›´æ–°ï¼šJWT è®¤è¯ç³»ç»Ÿå·²å®ç°

**æ›´æ–°æ—¶é—´**: 2024-10-07

ç”¨æˆ·ç³»ç»Ÿç°å·²å®ç°å®Œæ•´çš„ JWT è®¤è¯åŠŸèƒ½ï¼

### å·²å®ç°åŠŸèƒ½

âœ… **ç”¨æˆ·æ³¨å†Œå’Œç™»å½•**: æ”¯æŒç”¨æˆ·å/é‚®ç®± + å¯†ç è®¤è¯  
âœ… **JWT Token è®¤è¯**: æ ‡å‡† JWT Bearer Token  
âœ… **å¯†ç å®‰å…¨**: BCrypt å“ˆå¸Œç®—æ³•  
âœ… **è§’è‰²è‡ªåŠ¨ç»‘å®š**: å·²è®¤è¯ç”¨æˆ·åˆ›å»ºè§’è‰²æ—¶è‡ªåŠ¨ç»‘å®š  
âœ… **ç”¨æˆ·ç®¡ç† API**: å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ç®¡ç†  
âœ… **è§’è‰²ç®¡ç† API**: ç»‘å®šã€æ’åºç­‰åŠŸèƒ½  
âœ… **Swagger æ”¯æŒ**: Swagger UI ä¸­å¯æµ‹è¯•è®¤è¯ API  

### æ–°å¢ API ç«¯ç‚¹

#### è®¤è¯ç«¯ç‚¹ï¼ˆæ— éœ€æˆæƒï¼‰
- `POST /api/auth/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/auth/login` - ç”¨æˆ·ç™»å½•
- `POST /api/auth/change-password` - ä¿®æ”¹å¯†ç 

#### ç”¨æˆ·ç®¡ç†ç«¯ç‚¹ï¼ˆéœ€è¦æˆæƒï¼‰
- `GET /api/users/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `GET /api/users/{id}` - è·å–ç”¨æˆ·ä¿¡æ¯
- `GET /api/users/{id}/characters` - è·å–ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
- `PUT /api/users/{id}` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯

#### è§’è‰²ç®¡ç†ç«¯ç‚¹
- `POST /api/characters` - åˆ›å»ºè§’è‰²ï¼ˆå¸¦ Token è‡ªåŠ¨ç»‘å®šï¼‰
- `PUT /api/characters/{id}/bind-user` - ç»‘å®šè§’è‰²åˆ°ç”¨æˆ·
- `PUT /api/characters/{id}/reorder` - è°ƒæ•´è§’è‰²é¡ºåº

### å¿«é€Ÿå¼€å§‹

```bash
# 1. æ³¨å†Œç”¨æˆ·
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"myuser","email":"user@example.com","password":"Pass123"}'

# 2. è·å– Token ååˆ›å»ºè§’è‰²ï¼ˆè‡ªåŠ¨ç»‘å®šï¼‰
curl -X POST http://localhost:5000/api/characters \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"name":"MyWarrior","profession":0}'
```

### è¯¦ç»†æ–‡æ¡£

- ğŸ“˜ [JWTè®¤è¯ç³»ç»Ÿæ–‡æ¡£](./JWTè®¤è¯ç³»ç»Ÿæ–‡æ¡£.md) - å®Œæ•´çš„è®¤è¯ç³»ç»Ÿè¯´æ˜
- ğŸ“¦ [APIè®¤è¯ç¤ºä¾‹](./APIè®¤è¯ç¤ºä¾‹.md) - å®é™…ä½¿ç”¨ç¤ºä¾‹å’Œä»£ç 
- ğŸ”‘ [è®¤è¯ç³»ç»Ÿå¿«é€Ÿå‚è€ƒ](./è®¤è¯ç³»ç»Ÿå¿«é€Ÿå‚è€ƒ.md) - å¿«é€ŸæŸ¥é˜…æ‰‹å†Œ

### å‘åå…¼å®¹

æœ¬å®ç°å®Œå…¨å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼š
- âœ… ä¸ç™»å½•ä¹Ÿèƒ½åˆ›å»ºè§’è‰²ï¼ˆè§’è‰²ä¸ç»‘å®šç”¨æˆ·ï¼‰
- âœ… ç°æœ‰ API ç«¯ç‚¹ä¿æŒä¸å˜
- âœ… å·²æœ‰æ•°æ®ä¸å—å½±å“

