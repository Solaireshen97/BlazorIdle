# 离线暂停恢复功能说明

## 概述

本文档说明了离线玩家检测和任务暂停恢复的功能实现。该功能确保玩家离线时，正在执行的任务会被正确暂停并保存状态，而不是直接完成，从而在玩家重新上线时可以恢复任务继续执行。

## 核心功能

### 1. 离线检测与任务暂停

**功能位置**: `BlazorIdle.Server/Services/OfflineDetectionService.cs`

- **检测周期**: 每 30 秒检查一次所有在线玩家的心跳时间
- **离线阈值**: 可配置，默认 60 秒（通过 `Offline:OfflineDetectionSeconds` 配置）
- **暂停机制**: 
  - 当玩家离线超过阈值时，调用 `PausePlanAsync` 暂停任务
  - 保存当前战斗状态快照（`BattleStateJson`）和已执行时长（`ExecutedSeconds`）
  - 停止战斗引擎以释放内存资源
  - 任务状态设置为 `Paused`（而不是 `Completed`）

### 2. 任务状态机

**新增状态**: `ActivityState.Paused`

状态转换流程：
```
Pending → Running → Paused (离线) → Running (上线恢复)
                 ↓
           Completed/Cancelled
```

### 3. 任务暂停方法

**方法位置**: `ActivityPlanService.PausePlanAsync`

**功能说明**:
- 保存当前战斗状态快照
- 更新已执行时长
- 停止战斗引擎（释放内存）
- 设置任务状态为 `Paused`
- 保留 `BattleStateJson` 用于后续恢复

**与 StopPlanAsync 的区别**:
| 特性 | PausePlanAsync | StopPlanAsync |
|------|----------------|---------------|
| 任务状态 | Paused | Completed |
| 战斗状态快照 | 保留 | 清空 |
| 可恢复性 | 可恢复 | 不可恢复 |
| 用途 | 玩家离线暂停 | 任务正常完成 |

### 4. 任务恢复机制

#### 4.1 玩家上线时恢复

**功能位置**: `OfflineSettlementService.CheckAndSettleAsync`

当玩家上线时：
1. 检查是否有 `Running` 或 `Paused` 状态的计划
2. 如果是 `Paused` 状态，临时改为 `Running` 以便快进引擎处理
3. 使用 `OfflineFastForwardEngine` 快进模拟离线期间的战斗
4. 从保存的 `BattleStateJson` 恢复战斗进度（敌人血量、波次等）
5. 计算并返回离线收益
6. 如果任务未完成，保持当前状态等待恢复运行

#### 4.2 服务器重启后恢复

**功能位置**: `StepBattleHostedService.RecoverPausedPlansAsync`

服务器启动时：
1. 查找所有 `Paused` 状态的计划
2. 检查玩家是否在线（心跳在 60 秒内）
3. 如果玩家在线，自动调用 `StartPlanAsync` 恢复任务运行
4. 如果玩家离线，保持 `Paused` 状态，等待玩家上线后通过离线结算恢复

### 5. 启动方法增强

**方法位置**: `ActivityPlanService.StartPlanAsync`

**增强说明**:
- 支持启动 `Pending` 状态的新任务
- 支持恢复 `Paused` 状态的暂停任务
- 从 `BattleStateJson` 恢复战斗状态快照
- 继承之前的 `ExecutedSeconds` 和战斗进度

### 6. 离线快进引擎增强

**功能位置**: `OfflineFastForwardEngine.FastForward`

**增强说明**:
- 支持处理 `Running` 和 `Paused` 状态的计划
- 从 `BattleStateJson` 恢复战斗状态
- 确保战斗进度无缝继承（敌人血量、击杀计数、波次等）
- 更新战斗状态快照以供下次使用

## 配置说明

在 `appsettings.json` 中配置：

```json
{
  "Offline": {
    "OfflineDetectionSeconds": 60,     // 离线检测阈值（秒）
    "MaxOfflineSeconds": 43200,        // 离线时长上限（12小时）
    "EnableAutoSettlement": true       // 是否启用自动结算
  }
}
```

## 使用场景

### 场景 1: 玩家短暂离线

1. 玩家正在执行一个 2 小时的战斗任务
2. 玩家离线 10 分钟
3. `OfflineDetectionService` 检测到离线超过 60 秒，调用 `PausePlanAsync` 暂停任务
4. 任务状态变为 `Paused`，保存当前进度
5. 玩家重新上线
6. `CheckAndSettleAsync` 快进模拟 10 分钟的战斗，计算收益
7. 返回离线收益供玩家领取
8. 任务继续执行（如果未完成）

### 场景 2: 服务器重启

1. 玩家正在执行任务，服务器需要重启维护
2. 服务器关闭前，任务保存快照到数据库
3. 服务器重启
4. `RecoverPausedPlansAsync` 恢复所有暂停的任务
5. 如果玩家仍在线，任务自动恢复运行
6. 如果玩家已离线，保持暂停状态等待玩家上线

### 场景 3: 玩家长时间离线

1. 玩家正在执行一个无限时长的战斗任务
2. 玩家离线 24 小时
3. 任务被暂停并保存状态
4. 玩家重新上线
5. 离线结算最多计算 12 小时的收益（受 `MaxOfflineSeconds` 限制）
6. 任务继续执行（从离线前的进度开始）

## 技术细节

### 战斗状态快照

`BattleStateJson` 包含：
- 敌人血量状态（`EnemyHealthState`）
- 当前波次索引（`WaveIndex`）
- 已完成的战斗轮数（`RunCount`）
- 快照时间戳（`SnapshotAtSeconds`）

### 无缝进度继承

通过以下机制确保进度无缝继承：
1. 暂停时保存完整的战斗状态快照
2. 恢复时从快照中还原敌人血量、波次等状态
3. 使用 `BattleEngine.RestoreBattleState` 方法恢复引擎状态
4. 继承 `ExecutedSeconds` 确保时间计算准确

### 内存管理

- 暂停时停止战斗引擎，释放内存资源
- 战斗状态快照序列化为 JSON 存储在数据库
- 恢复时重新创建战斗引擎，并从快照恢复状态

## 测试建议

### 单元测试

1. 测试 `PausePlanAsync` 正确保存状态
2. 测试 `StartPlanAsync` 可以恢复暂停的任务
3. 测试 `OfflineFastForwardEngine` 支持暂停状态的计划
4. 测试战斗状态快照的序列化/反序列化

### 集成测试

1. 测试完整的离线-上线循环
2. 测试服务器重启后恢复暂停的任务
3. 测试多个玩家并发离线/上线
4. 测试离线时长超过 12 小时的情况

### 场景测试

1. 创建一个战斗任务
2. 等待任务运行一段时间
3. 模拟玩家离线（停止心跳更新）
4. 等待 60 秒，观察任务是否被暂停
5. 模拟玩家上线（恢复心跳）
6. 验证离线收益计算正确
7. 验证任务继续执行

## 故障排查

### 问题：任务被标记为 Completed 而不是 Paused

**原因**: 仍在使用 `StopPlanAsync` 而不是 `PausePlanAsync`

**解决**: 确保 `OfflineDetectionService.CheckAndPauseOfflinePlayers` 调用 `PausePlanAsync`

### 问题：暂停的任务无法恢复

**原因**: `StartPlanAsync` 不支持 `Paused` 状态

**解决**: 确保 `StartPlanAsync` 允许启动 `Paused` 状态的计划

### 问题：恢复后进度丢失

**原因**: 战斗状态快照未正确保存或恢复

**解决**: 
1. 检查 `BattleStateJson` 是否正确保存
2. 检查 `BattleEngine.RestoreBattleState` 是否正确调用
3. 检查 `ExecutedSeconds` 是否正确更新

### 问题：服务器重启后暂停的任务未恢复

**原因**: `RecoverPausedPlansAsync` 未执行或出错

**解决**: 
1. 检查 `StepBattleHostedService` 启动日志
2. 检查是否有异常被捕获并记录
3. 验证数据库中是否有 `Paused` 状态的计划

## 未来改进

1. **心跳机制优化**: 实现更精确的心跳检测，减少误判
2. **暂停通知**: 向客户端推送任务暂停通知
3. **手动暂停**: 支持玩家手动暂停/恢复任务
4. **暂停历史**: 记录任务暂停/恢复的历史记录
5. **多任务队列**: 支持多个任务排队等待执行
6. **离线补偿**: 根据离线时长给予额外补偿

## 相关文档

- [离线战斗系统实施方案](./OfflineBattleImplementationPlan.md)
- [离线战斗文档索引](./离线战斗文档索引.md)
- [活动计划系统实施总结](./ACTIVITY_PLAN_AUTO_COMPLETION_SUMMARY.md)
- [实施完成报告](../实施完成报告.md)
