# BlazorIdle 商店系统设计交付清单

**项目**: BlazorIdle  
**交付类型**: 设计文档  
**交付日期**: 2025-10-12  
**版本**: 1.0  
**状态**: 设计完成，待实施

---

## 📋 交付概览

本次交付为 BlazorIdle 游戏的**商店系统**完整设计方案，包含架构设计、详细实施步骤、集成测试、性能优化和运维方案。设计方案覆盖了游戏商店的核心功能和未来扩展需求。

---

## 📦 交付文档清单

### 核心设计文档（3篇）

| 文档名称 | 文件路径 | 页数 | 内容概要 |
|---------|---------|------|---------|
| **商店系统设计方案（上篇）** | `/docs/商店系统设计方案（上篇）.md` | ~60页 | 架构设计与核心功能 |
| **商店系统设计方案（中篇）** | `/docs/商店系统设计方案（中篇）.md` | ~50页 | 详细实施步骤 |
| **商店系统设计方案（下篇）** | `/docs/商店系统设计方案（下篇）.md` | ~50页 | 集成测试、性能优化、运维 |

### 本交付清单

| 文档名称 | 文件路径 | 说明 |
|---------|---------|------|
| **商店系统设计交付清单** | `/docs/商店系统设计交付清单.md` | 本文档 |

---

## 📖 文档结构

### 《商店系统设计方案（上篇）》

**主题**: 架构设计与核心功能

#### 内容目录：
1. **设计概述**
   - 1.1 背景与目标
   - 1.2 设计原则
   - 1.3 与现有系统的关系

2. **需求分析**
   - 2.1 功能性需求（8种商店类型、4大商品类型）
   - 2.2 非功能性需求（性能、并发、安全）
   - 2.3 数据需求（6张核心数据表）

3. **系统架构设计**
   - 3.1 架构分层（DDD架构）
   - 3.2 模块边界
   - 3.3 核心工作流（购买流程、刷新流程）

4. **核心领域模型**
   - 4.1 ShopAggregate（商店聚合根）
   - 4.2 ShopDefinition（商店定义）
   - 4.3 ShopItemInstance（商品实例）
   - 4.4 PriceSpecification（价格规格）
   - 4.5 PurchaseLimit（限购规则）

5. **商店类型设计**
   - 5.1 普通商店（General Shop）
   - 5.2 装备商店（Equipment Shop）
   - 5.3 声望商店（Reputation Shop）
   - 5.4 荣誉商店（Honor Shop）

6. **交易货币系统**
   - 6.1 货币类型定义（金币、声望、荣誉、代币）
   - 6.2 货币存储设计
   - 6.3 货币兑换器服务

7. **条件解锁集成**
   - 7.1 条件DSL设计
   - 7.2 条件评估器接口
   - 7.3 商店解锁服务

#### 关键亮点：
- ✅ **8种商店类型**：普通、装备、材料、声望、荣誉、代币、限时、黑市
- ✅ **多货币支持**：金币、声望点、荣誉点、活动代币
- ✅ **灵活的条件解锁**：支持DSL表达式（level>=20, AND/OR/NOT逻辑）
- ✅ **完整的领域模型**：符合DDD设计原则

---

### 《商店系统设计方案（中篇）》

**主题**: 详细实施步骤与技术实现

#### 内容目录：
1. **实施路线图**
   - 1.1 总体时间规划（6个Phase，24-31天）
   - 1.2 里程碑定义
   - 1.3 风险与缓解策略

2. **Phase 1: 基础架构搭建**
   - 2.1 领域模型实现（8个任务）
   - 2.2 仓储接口定义
   - 2.3 数据库迁移

3. **Phase 2: 核心功能实现**
   - 3.1 购买服务实现（PurchaseService）
   - 3.2 商店刷新服务（ShopRefreshService）

4. **Phase 3: 条件解锁与货币系统**
   - 4.1 条件评估器实现（简化版DSL解析）
   - 4.2 货币兑换器实现

5. **Phase 4: 前端界面开发**
   - 5.1 前端组件清单（6个组件）
   - 5.2 ShopList页面实现
   - 5.3 ShopDetail页面实现

6. **数据库设计详解**
   - 6.1 ER图
   - 6.2 表结构SQL

7. **API接口设计**
   - 7.1 商店接口（GET /api/shops）
   - 7.2 购买接口（POST /api/shops/purchase）

#### 关键亮点：
- ✅ **详细的实施步骤**：每个Phase包含具体任务清单
- ✅ **完整的代码示例**：包含领域模型、服务类、API控制器
- ✅ **前后端实现**：Blazor前端 + ASP.NET Core后端
- ✅ **RESTful API设计**：标准的JSON接口

---

### 《商店系统设计方案（下篇）》

**主题**: 集成测试、性能优化与运维

#### 内容目录：
1. **Phase 5: 集成测试**
   - 1.1 测试策略（单元测试、集成测试、性能测试）
   - 1.2 单元测试清单（16个测试用例）
   - 1.3 集成测试清单（购买流程、商店刷新、并发购买）
   - 1.4 性能测试（BenchmarkDotNet）
   - 1.5 测试覆盖率目标（80%+）

2. **Phase 6: 性能优化**
   - 2.1 数据库查询优化（索引策略）
   - 2.2 缓存策略（内存缓存、Redis）
   - 2.3 并发控制（乐观锁、分布式锁）

3. **监控与日志**
   - 3.1 关键指标监控（12个业务指标）
   - 3.2 结构化日志（6个日志级别）
   - 3.3 Prometheus + Grafana集成

4. **安全性加固**
   - 4.1 防刷机制（限频、价格验证、异常检测）
   - 4.2 SQL注入防护
   - 4.3 数据加密

5. **运维与配置管理**
   - 5.1 配置文件结构（appsettings.json）
   - 5.2 配置热更新
   - 5.3 数据库备份
   - 5.4 定时任务（Quartz.NET）

6. **扩展功能设计**
   - 6.1 拍卖行系统（未来）
   - 6.2 玩家间交易（未来）
   - 6.3 黑市系统（未来）

7. **交付清单**
   - 7.1 代码交付（11个目录）
   - 7.2 文档交付（8个文档）
   - 7.3 配置交付（4个配置文件）
   - 7.4 验收标准（功能、性能、质量）

#### 关键亮点：
- ✅ **全面的测试方案**：覆盖单元、集成、性能测试
- ✅ **性能优化策略**：缓存、索引、并发控制
- ✅ **可观测性**：Prometheus指标、结构化日志
- ✅ **生产环境就绪**：监控、告警、备份、热更新

---

## 🎯 功能覆盖范围

### 核心功能（已设计）

| 功能模块 | 覆盖程度 | 说明 |
|---------|---------|------|
| **商店管理** | 100% | 8种商店类型、刷新机制、解锁条件 |
| **商品管理** | 100% | 4大类商品、定价系统、库存管理、限购 |
| **交易功能** | 100% | 购买、货币扣除、物品发放、交易记录 |
| **条件系统** | 80% | 简化版DSL实现，支持level/gold条件 |
| **货币系统** | 90% | 金币完整支持，声望/荣誉部分实现 |
| **前端界面** | 100% | 商店列表、商店详情、购买界面 |
| **监控日志** | 100% | Prometheus指标、结构化日志 |
| **性能优化** | 100% | 缓存、索引、并发控制 |
| **安全防护** | 100% | 限频、防刷、价格验证 |
| **测试方案** | 100% | 单元测试、集成测试、性能测试 |

### 扩展功能（待实施）

| 功能模块 | 优先级 | 说明 |
|---------|--------|------|
| **拍卖行系统** | P4 | 玩家间拍卖，竞价机制 |
| **玩家交易** | P4 | 点对点交易，安全流程 |
| **黑市系统** | P4 | 随机刷新，稀有物品 |
| **动态定价** | P5 | 根据供需调整价格 |

---

## 💡 设计特色

### 1. 数据驱动设计
所有商店、商品、价格、条件均通过配置文件管理，无需修改代码即可：
- 添加新商店
- 调整商品价格
- 修改刷新规则
- 更新解锁条件

### 2. 服务端权威
所有交易验证、价格计算、库存扣减在服务端完成：
- 防止客户端作弊
- 防止价格篡改
- 确保数据一致性

### 3. 多货币支持
支持5种货币类型，可组合使用：
- 金币（通用货币）
- 声望点（派系货币）
- 荣誉点（PvP货币）
- 活动代币（限时货币）
- 成就点（成就货币）

### 4. 灵活的条件系统
基于DSL表达式的条件解锁：
```
level>=20                                    # 等级条件
AND(level>=20, quest.completed('Q123'))     # 复合条件
OR(gold>=1000, token.event_2025>=50)        # 多路径解锁
```

### 5. 完善的限购机制
支持多种限购类型：
- 每日限购（PerDay）
- 每周限购（PerWeek）
- 每月限购（PerMonth）
- 每次刷新限购（PerRefresh）
- 终身限购（Lifetime）

### 6. 强大的并发控制
- 乐观锁（EF Core ConcurrencyToken）
- 分布式锁（Redis）
- 幂等性保证（TransactionId）

### 7. 可观测性
- 12个业务指标（Prometheus）
- 结构化日志（Serilog）
- Grafana可视化
- 告警机制

---

## 🔧 技术栈

| 技术领域 | 技术选型 |
|---------|---------|
| **后端框架** | ASP.NET Core 8.0 |
| **前端框架** | Blazor WebAssembly |
| **数据库** | SQLite (EF Core) |
| **缓存** | IMemoryCache / Redis (可选) |
| **监控** | Prometheus + Grafana |
| **日志** | Serilog / NLog |
| **测试** | xUnit + BenchmarkDotNet |
| **任务调度** | Quartz.NET |
| **分布式锁** | Redis (可选) |

---

## 📊 数据模型概览

### 核心数据表（9张）

| 表名 | 类型 | 说明 |
|-----|------|------|
| **ShopDefinitions** | 配置表 | 商店定义 |
| **ShopItemDefinitions** | 配置表 | 商品定义 |
| **ShopInstance** | 运行时 | 商店实例 |
| **ShopItemStock** | 运行时 | 商品库存 |
| **PurchaseRecord** | 日志表 | 购买历史 |
| **CharacterPurchaseRecord** | 运行时 | 限购记录 |
| **ReputationRecord** | 扩展表 | 声望记录 |
| **CharacterWallet** | 扩展表 | 货币钱包 |
| **TokenBalance** | 扩展表 | 代币余额 |

---

## 📅 实施时间表

| Phase | 阶段名称 | 工作量 | 开始日期 | 结束日期 |
|-------|---------|--------|---------|---------|
| P0 | 需求确认与设计评审 | 2天 | D1 | D2 |
| P1 | 基础架构搭建 | 3-4天 | D3 | D6 |
| P2 | 核心功能实现 | 5-6天 | D7 | D12 |
| P3 | 条件解锁与货币系统 | 4-5天 | D13 | D17 |
| P4 | 前端界面开发 | 5-6天 | D18 | D23 |
| P5 | 集成测试与优化 | 3-4天 | D24 | D27 |
| P6 | 部署与文档 | 2天 | D28 | D29 |

**总计**: 24-31天（约4-5周）

---

## ✅ 验收标准

### 功能验收（8项）

- [ ] 商店列表加载正常，显示已解锁商店
- [ ] 商店详情页显示商品列表、价格、库存
- [ ] 购买功能正常，扣除货币并发放物品
- [ ] 限购机制生效（日限购、周限购）
- [ ] 库存扣减正确（有限库存商品）
- [ ] 商店刷新功能正常（定时刷新、手动刷新）
- [ ] 条件解锁生效（商店解锁、商品解锁）
- [ ] 多货币支持（金币、声望、荣誉）

### 性能验收（4项）

- [ ] 商店列表加载时间 < 500ms
- [ ] 购买响应时间 < 200ms（P95）
- [ ] 支持100并发购买请求
- [ ] 缓存命中率 > 90%

### 质量验收（5项）

- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过率 100%
- [ ] 无内存泄漏
- [ ] 无SQL注入漏洞
- [ ] 代码审查通过

---

## 📈 项目价值

### 游戏性提升
- ✅ 提供多样化的获取物品途径（战斗掉落 + 商店购买）
- ✅ 增加玩家目标感（解锁商店、收集货币）
- ✅ 延长游戏生命周期（限时商品、刷新机制）

### 经济循环
- ✅ 建立金币消耗渠道（控制通胀）
- ✅ 引入多种货币（声望、荣誉），增加游戏深度
- ✅ 监控货币流通，平衡游戏经济

### 技术能力
- ✅ 完善的DDD架构实践
- ✅ 高性能并发交易处理
- ✅ 可观测性（监控、日志、告警）
- ✅ 为未来扩展打下基础（拍卖行、交易行）

---

## 🚀 后续工作

### 立即可做（P1）
1. 启动Phase 1实施（基础架构搭建）
2. 搭建开发环境（数据库、Redis、Prometheus）
3. 创建GitHub分支（feature/shop-system）

### 短期规划（P2）
1. 完成Phase 2-4实施（核心功能、前端界面）
2. 集成测试与性能测试
3. 生产环境部署

### 中期规划（P3）
1. 完善条件DSL引擎（支持更复杂条件）
2. 实现声望系统和荣誉系统
3. 开发拍卖行系统

### 长期规划（P4）
1. 玩家间交易系统
2. 黑市系统
3. 动态定价系统

---

## 📞 联系方式

如有疑问或需要进一步讨论，请联系：
- **项目负责人**: [待定]
- **技术架构师**: [待定]
- **文档维护**: GitHub Issues

---

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|-----|------|---------|------|
| 1.0 | 2025-10-12 | 初始版本，完成三篇设计文档 | 系统架构团队 |

---

**交付完成 - 商店系统设计方案已就绪，等待实施** ✅

---

## 附录：文档快速索引

### 按主题查找

**架构设计** → 《上篇》第3章  
**领域模型** → 《上篇》第4章  
**数据库设计** → 《中篇》第6章  
**API设计** → 《中篇》第7章  
**测试方案** → 《下篇》第1章  
**性能优化** → 《下篇》第2章  
**监控日志** → 《下篇》第3章  
**安全防护** → 《下篇》第4章  
**运维部署** → 《下篇》第5章  

### 按角色查找

**开发人员** → 《中篇》实施步骤 + 代码示例  
**测试人员** → 《下篇》第1章 测试方案  
**运维人员** → 《下篇》第5章 运维配置  
**产品经理** → 《上篇》需求分析 + 功能设计  
**架构师** → 《上篇》架构设计 + 《下篇》性能优化

---

**END**
