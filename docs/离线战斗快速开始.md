# ç¦»çº¿æˆ˜æ–—ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹æŒ‡å—

> ğŸ¯ **ç›®æ ‡**: 5åˆ†é’Ÿäº†è§£å¦‚ä½•å®ç°ç¦»çº¿æˆ˜æ–—åŠŸèƒ½

---

## ğŸ“Œ æ ¸å¿ƒæ¦‚å¿µ

**ç¦»çº¿æˆ˜æ–—** = ç”¨æˆ·ä¸‹çº¿åï¼Œç³»ç»Ÿç»§ç»­è®¡ç®—æˆ˜æ–—æ”¶ç›Šï¼Œä¸Šçº¿æ—¶ä¸€æ¬¡æ€§ç»“ç®—

**å…³é”®æµç¨‹**:
1. ç”¨æˆ·ä¸‹çº¿å‰æœ‰è¿è¡Œä¸­çš„æˆ˜æ–—è®¡åˆ’
2. ç³»ç»Ÿè®°å½•ä¸‹çº¿æ—¶é—´
3. ç”¨æˆ·ä¸Šçº¿æ—¶è‡ªåŠ¨è®¡ç®—ç¦»çº¿æœŸé—´æ”¶ç›Š
4. å±•ç¤ºæ”¶ç›Šå¹¶å‘æ”¾

---

## âœ… å·²æœ‰çš„ä»£ç ï¼ˆå¯ç›´æ¥å¤ç”¨ï¼‰

| ç»„ä»¶ | ä½ç½® | åŠŸèƒ½ |
|------|------|------|
| `ActivityPlan` | `Domain/Activities/ActivityPlan.cs` | æ´»åŠ¨è®¡åˆ’æ¨¡å‹ï¼ˆå·²å®Œæ•´ï¼‰ |
| `BattleSimulator` | `Application/Battles/BattleSimulator.cs` | æˆ˜æ–—å¿«è¿›æ¨¡æ‹Ÿå™¨ |
| `OfflineSettlementService` | `Application/Battles/Offline/Offline.cs` | ç¦»çº¿ç»“ç®—æœåŠ¡ï¼ˆåŸºç¡€ç‰ˆï¼‰ |
| `LastSeenAtUtc` | `Character.cs` | è§’è‰²æœ€ååœ¨çº¿æ—¶é—´å­—æ®µ |

---

## âŒ éœ€è¦æ–°å¢çš„ä»£ç 

### 1. æ ¸å¿ƒå¼•æ“ï¼ˆå¿…é¡»ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Battles/Offline/OfflineFastForwardEngine.cs`

**ä»£ç æ¡†æ¶**:
```csharp
public class OfflineFastForwardEngine
{
    private readonly BattleSimulator _simulator;
    
    public OfflineFastForwardResult FastForward(
        Character character,
        ActivityPlan plan,
        double offlineSeconds,
        double maxCapSeconds = 43200) // 12å°æ—¶
    {
        // 1. é™åˆ¶ç¦»çº¿æ—¶é•¿
        var capped = Math.Min(offlineSeconds, maxCapSeconds);
        
        // 2. è®¡ç®—è®¡åˆ’å‰©ä½™æ—¶é•¿
        var remaining = CalculateRemaining(plan, capped);
        
        // 3. å¿«è¿›æ¨¡æ‹Ÿ
        var result = Simulate(character, plan, remaining);
        
        // 4. æ›´æ–°è®¡åˆ’çŠ¶æ€
        plan.ExecutedSeconds += remaining;
        if (plan.IsLimitReached())
            plan.State = ActivityState.Completed;
        
        return result;
    }
}
```

---

### 2. è‡ªåŠ¨æ£€æµ‹ï¼ˆå¿…é¡»ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Battles/Offline/Offline.cs`ï¼ˆæ‰©å±•ï¼‰

**æ–°å¢æ–¹æ³•**:
```csharp
public async Task<OfflineCheckResult> CheckAndSettleAsync(
    Guid characterId, 
    CancellationToken ct)
{
    var character = await _characters.GetAsync(characterId, ct);
    
    // è®¡ç®—ç¦»çº¿æ—¶é•¿
    var offline = (DateTime.UtcNow - character.LastSeenAtUtc).TotalSeconds;
    
    if (offline <= 0)
        return new OfflineCheckResult { HasOfflineTime = false };
    
    // æŸ¥æ‰¾è¿è¡Œè®¡åˆ’
    var plan = await _plans.GetRunningPlanAsync(characterId, ct);
    if (plan is null)
        return new OfflineCheckResult { 
            HasOfflineTime = true, 
            HasRunningPlan = false 
        };
    
    // å¿«è¿›æ¨¡æ‹Ÿ
    var result = _engine.FastForward(character, plan, offline);
    
    // æ›´æ–°è®¡åˆ’
    await _plans.UpdateAsync(plan, ct);
    
    // æ›´æ–°å¿ƒè·³
    character.LastSeenAtUtc = DateTime.UtcNow;
    await _characters.UpdateAsync(character, ct);
    
    return new OfflineCheckResult { 
        HasOfflineTime = true,
        Settlement = result 
    };
}
```

---

### 3. APIç«¯ç‚¹ï¼ˆå¿…é¡»ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Api/OfflineController.cs`ï¼ˆæ‰©å±•ï¼‰

**æ–°å¢ç«¯ç‚¹**:
```csharp
[HttpGet("check")]
public async Task<ActionResult<OfflineCheckResult>> CheckOffline(
    [FromQuery] Guid characterId,
    CancellationToken ct)
{
    var result = await _offline.CheckAndSettleAsync(characterId, ct);
    return Ok(result);
}

[HttpPost("apply")]
public async Task<ActionResult> ApplySettlement(
    [FromBody] ApplySettlementRequest request,
    CancellationToken ct)
{
    await _offline.ApplySettlementAsync(
        request.CharacterId,
        request.Settlement,
        ct);
    return Ok();
}
```

---

### 4. å‰ç«¯å¼¹çª—ï¼ˆå¿…é¡»ï¼‰

**æ–‡ä»¶**: `BlazorIdle/Components/OfflineSettlementDialog.razor`ï¼ˆæ–°å»ºï¼‰

**ç»„ä»¶ä»£ç **:
```razor
@if (Result?.HasOfflineTime == true && Result.Settlement != null)
{
    <div class="offline-dialog">
        <h2>æ¬¢è¿å›æ¥ï¼</h2>
        <p>ç¦»çº¿æ—¶é•¿: @FormatDuration(Result.OfflineSeconds)</p>
        
        <div class="rewards">
            <div>é‡‘å¸: +@Result.Settlement.Gold</div>
            <div>ç»éªŒ: +@Result.Settlement.Exp</div>
            <div>å‡»æ€: @Result.Settlement.TotalKills</div>
        </div>
        
        <button @onclick="OnClaimClicked">ç¡®è®¤é¢†å–</button>
    </div>
}

@code {
    [Parameter] public OfflineCheckResult? Result { get; set; }
    [Parameter] public EventCallback OnClaim { get; set; }
    
    private async Task OnClaimClicked()
    {
        await OnClaim.InvokeAsync();
    }
    
    private string FormatDuration(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        return $"{ts.Hours}å°æ—¶{ts.Minutes}åˆ†é’Ÿ";
    }
}
```

---

### 5. å‰ç«¯é›†æˆï¼ˆå¿…é¡»ï¼‰

**æ–‡ä»¶**: `BlazorIdle/Pages/Characters.razor`ï¼ˆä¿®æ”¹ï¼‰

**åœ¨OnInitializedAsyncä¸­æ·»åŠ **:
```csharp
protected override async Task OnInitializedAsync()
{
    // ... åŸæœ‰ä»£ç  ...
    
    // æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
    if (selectedCharacter != null)
    {
        var offlineResult = await apiClient.CheckOfflineAsync(
            selectedCharacter.Id);
        
        if (offlineResult?.HasOfflineTime == true)
        {
            showOfflineDialog = true;
            this.offlineResult = offlineResult;
        }
    }
}

private async Task ClaimOfflineRewards()
{
    await apiClient.ApplyOfflineSettlementAsync(
        selectedCharacter.Id,
        offlineResult.Settlement);
    
    await RefreshCharacter();
    showOfflineDialog = false;
}
```

---

## ğŸš€ å®æ–½æ­¥éª¤ï¼ˆæŒ‰é¡ºåºï¼‰

### Step 1: åç«¯æ ¸å¿ƒï¼ˆ2å¤©ï¼‰
1. âœ… åˆ›å»º`OfflineFastForwardEngine.cs`
2. âœ… æ‰©å±•`OfflineSettlementService`æ·»åŠ `CheckAndSettleAsync`
3. âœ… æ·»åŠ APIç«¯ç‚¹`/api/offline/check`å’Œ`/api/offline/apply`
4. âœ… æ·»åŠ å¿ƒè·³ç«¯ç‚¹`/api/characters/{id}/heartbeat`

### Step 2: å‰ç«¯é›†æˆï¼ˆ1å¤©ï¼‰
5. âœ… åˆ›å»º`OfflineSettlementDialog.razor`ç»„ä»¶
6. âœ… æ‰©å±•`ApiClient.cs`æ·»åŠ ç¦»çº¿APIæ–¹æ³•
7. âœ… ä¿®æ”¹`Characters.razor`é›†æˆç¦»çº¿æ£€æŸ¥

### Step 3: æµ‹è¯•éªŒè¯ï¼ˆ1å¤©ï¼‰
8. âœ… å•å…ƒæµ‹è¯•ï¼šå¿«è¿›å¼•æ“ã€æ—¶é•¿è®¡ç®—
9. âœ… é›†æˆæµ‹è¯•ï¼šå®Œæ•´ç¦»çº¿æµç¨‹
10. âœ… æ‰‹åŠ¨æµ‹è¯•ï¼šUIå±•ç¤ºä¸äº¤äº’

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### å¿«é€Ÿæ‰‹åŠ¨æµ‹è¯•

1. **åˆ›å»ºè§’è‰²å’Œè®¡åˆ’**
```
POST /api/characters (åˆ›å»ºè§’è‰²)
POST /api/activity-plans/combat?characterId=xxx&limitType=duration&limitValue=3600
(åˆ›å»º1å°æ—¶æˆ˜æ–—è®¡åˆ’)
```

2. **æ¨¡æ‹Ÿç¦»çº¿**
```sql
-- ç›´æ¥ä¿®æ”¹æ•°æ®åº“
UPDATE Characters 
SET LastSeenAtUtc = datetime('now', '-1 hour')
WHERE Id = 'your-character-id';
```

3. **é‡æ–°ç™»å½•éªŒè¯**
- æ‰“å¼€Charactersé¡µé¢
- åº”è¯¥çœ‹åˆ°ç¦»çº¿ç»“ç®—å¼¹çª—
- æ£€æŸ¥æ”¶ç›Šæ•°æ®æ˜¯å¦æ­£ç¡®
- ç‚¹å‡»"ç¡®è®¤é¢†å–"
- éªŒè¯è§’è‰²æ•°æ®å·²æ›´æ–°

---

## ğŸ“Š å…³é”®æ•°æ®ç»“æ„

### OfflineFastForwardResult
```csharp
public class OfflineFastForwardResult
{
    public Guid CharacterId { get; set; }
    public Guid PlanId { get; set; }
    public double SimulatedSeconds { get; set; }  // æ¨¡æ‹Ÿæ—¶é•¿
    public bool PlanCompleted { get; set; }       // è®¡åˆ’æ˜¯å¦å®Œæˆ
    public long Gold { get; set; }                // é‡‘å¸æ”¶ç›Š
    public long Exp { get; set; }                 // ç»éªŒæ”¶ç›Š
    public Dictionary<string, double> Loot { get; set; }
}
```

### OfflineCheckResult
```csharp
public class OfflineCheckResult
{
    public bool HasOfflineTime { get; set; }      // æ˜¯å¦æœ‰ç¦»çº¿æ—¶é—´
    public double OfflineSeconds { get; set; }    // ç¦»çº¿æ€»æ—¶é•¿
    public bool HasRunningPlan { get; set; }      // æ˜¯å¦æœ‰è¿è¡Œè®¡åˆ’
    public OfflineFastForwardResult? Settlement { get; set; }
    public bool PlanCompleted { get; set; }       // è®¡åˆ’æ˜¯å¦å®Œæˆ
    public bool NextPlanStarted { get; set; }     // æ˜¯å¦å¯åŠ¨ä¸‹ä¸€ä¸ª
    public Guid? NextPlanId { get; set; }
}
```

---

## âš™ï¸ é…ç½®é¡¹

**æ–‡ä»¶**: `appsettings.json`

```json
{
  "Offline": {
    "MaxOfflineSeconds": 43200,     // 12å°æ—¶ä¸Šé™
    "EnableAutoSettlement": true     // æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç»“ç®—
  }
}
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ç¦»çº¿æ—¶é•¿è®¡ç®—
```csharp
// åœ¨CheckAndSettleAsyncæ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—
var offlineSeconds = (DateTime.UtcNow - character.LastSeenAtUtc).TotalSeconds;
Console.WriteLine($"[Offline] Character {characterId} offline for {offlineSeconds}s");
```

### 2. éªŒè¯å¿«è¿›ç»“æœ
```csharp
// åœ¨FastForwardæ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—
Console.WriteLine($"[FastForward] Simulated {simulatedSeconds}s, Gold={result.Gold}, Exp={result.Exp}");
```

### 3. å‰ç«¯è°ƒè¯•
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹APIå“åº”
await fetch('/api/offline/check?characterId=xxx')
  .then(r => r.json())
  .then(console.log);
```

---

## ğŸ“š å®Œæ•´æ–‡æ¡£å‚è€ƒ

- **è¯¦ç»†è®¾è®¡**: `docs/OfflineBattleImplementationPlan.md`
- **æµç¨‹å›¾**: `docs/ç¦»çº¿æˆ˜æ–—æµç¨‹å›¾.md`
- **å®æ–½æ€»ç»“**: `docs/ç¦»çº¿æˆ˜æ–—ç³»ç»Ÿå®æ–½æ€»ç»“.md`

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è®¾ç½®ç¦»çº¿æ—¶é•¿ä¸Šé™ï¼Ÿ
A: åœ¨`appsettings.json`ä¸­ä¿®æ”¹`Offline:MaxOfflineSeconds`

### Q2: ç¦»çº¿æœŸé—´è®¡åˆ’ä¼šç»§ç»­è¿è¡Œå—ï¼Ÿ
A: ä¸ä¼šã€‚ç¦»çº¿ç»“ç®—æ˜¯åœ¨ç”¨æˆ·ä¸Šçº¿æ—¶"å¿«è¿›æ¨¡æ‹Ÿ"è¿‡å»çš„æ—¶é—´

### Q3: å¦‚æœç¦»çº¿æ—¶é—´è¶…è¿‡è®¡åˆ’å‰©ä½™æ—¶é—´æ€ä¹ˆåŠï¼Ÿ
A: åªæ¨¡æ‹Ÿåˆ°è®¡åˆ’å®Œæˆï¼Œå¤šä½™æ—¶é—´ä¸è®¡ç®—ï¼ˆé™¤éæœ‰ä¸‹ä¸€ä¸ªè®¡åˆ’è‡ªåŠ¨å¯åŠ¨ï¼‰

### Q4: æ”¯æŒå¤šä¸ªè®¡åˆ’è‡ªåŠ¨è¡”æ¥å—ï¼Ÿ
A: æ”¯æŒã€‚å½“å‰è®¡åˆ’å®Œæˆåï¼Œä¼šè‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªPendingè®¡åˆ’

### Q5: å‰ç«¯éœ€è¦å®šæœŸå¿ƒè·³å—ï¼Ÿ
A: æ¨èä½†éå¿…é¡»ã€‚å¯ä»¥åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨ä¸€æ¬¡`/heartbeat`å³å¯

---

## âœ… æ£€æŸ¥æ¸…å•

å®æ–½å®Œæˆåæ£€æŸ¥ï¼š

- [ ] `OfflineFastForwardEngine` ç±»å·²åˆ›å»º
- [ ] `OfflineSettlementService.CheckAndSettleAsync` æ–¹æ³•å·²æ·»åŠ 
- [ ] APIç«¯ç‚¹ `/api/offline/check` å¯ç”¨
- [ ] APIç«¯ç‚¹ `/api/offline/apply` å¯ç”¨
- [ ] å‰ç«¯å¼¹çª—ç»„ä»¶å·²åˆ›å»º
- [ ] `Characters.razor` å·²é›†æˆç¦»çº¿æ£€æŸ¥
- [ ] å•å…ƒæµ‹è¯•å·²é€šè¿‡
- [ ] æ‰‹åŠ¨æµ‹è¯•æµç¨‹æ­£å¸¸

---

**å¼€å§‹å®æ–½å§ï¼** ğŸš€

æœ‰é—®é¢˜å‚è€ƒè¯¦ç»†æ–‡æ¡£ï¼š`docs/OfflineBattleImplementationPlan.md`
