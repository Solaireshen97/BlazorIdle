# ç”¨æˆ·ç³»ç»Ÿï¼ˆUser Systemï¼‰äº¤ä»˜è¯´æ˜

## ğŸ“¦ äº¤ä»˜æ¦‚è¿°

æœ¬æ¬¡äº¤ä»˜å®ç°äº†ç”¨æˆ·è´¦å·ç³»ç»Ÿï¼Œä¸ºæ¸¸æˆæä¾›ç”¨æˆ·ç®¡ç†åŠŸèƒ½ï¼Œå¹¶å»ºç«‹äº†ç”¨æˆ·ä¸è§’è‰²çš„å…³è”å…³ç³»ã€‚è¿™æ˜¯å®ç°å¤šè§’è‰² Roster ç³»ç»Ÿçš„åŸºç¡€ã€‚

**äº¤ä»˜æ—¥æœŸ**: 2025å¹´10æœˆ7æ—¥  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶é€šè¿‡æµ‹è¯•

---

## ğŸ¯ å®ç°ç›®æ ‡

æ ¹æ®ã€Šæ•´åˆè®¾è®¡æ€»ç»“.txtã€‹ä¸­çš„ç¬¬17èŠ‚"å¤šè§’è‰² Roster ç³»ç»Ÿ"è¦æ±‚ï¼Œå®ç°ï¼š

1. âœ… åˆ›å»º User é¢†åŸŸå®ä½“ï¼Œç®¡ç†ç”¨æˆ·è´¦å·ä¿¡æ¯
2. âœ… å»ºç«‹ User ä¸ Character çš„ä¸€å¯¹å¤šå…³ç³»ï¼ˆ1:Nï¼‰
3. âœ… ä¿æŒå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
4. âœ… éµå¾ªé¡¹ç›®ç°æœ‰ä»£ç é£æ ¼å’Œæ¶æ„æ¨¡å¼
5. âœ… æä¾›å®Œæ•´çš„æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

---

## ğŸ“ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. é¢†åŸŸæ¨¡å‹ï¼ˆDomainï¼‰

#### User ç±»
**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Characters/User.cs`

```csharp
public class User
{
    public Guid Id { get; set; }
    public string Username { get; set; } = "";
    public string Email { get; set; } = "";
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? LastLoginAt { get; set; }
    
    // ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šä¸ªè§’è‰²
    public ICollection<Character> Characters { get; set; } = new List<Character>();
}
```

**ç‰¹æ€§**:
- ç”¨æˆ·åå’Œé‚®ç®±ä½œä¸ºå”¯ä¸€æ ‡è¯†
- æ”¯æŒæ—¶é—´æˆ³è¿½è¸ªï¼ˆåˆ›å»ºã€æ›´æ–°ã€æœ€åç™»å½•ï¼‰
- å¯¼èˆªå±æ€§æ”¯æŒè®¿é—®ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²

#### Character ç±»æ›´æ–°
**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Characters/Character.cs`

**æ–°å¢å­—æ®µ**:
```csharp
public Guid? UserId { get; set; }           // æ‰€å±ç”¨æˆ·IDï¼ˆå¯ç©ºï¼‰
public User? User { get; set; }             // å¯¼èˆªå±æ€§
```

**è®¾è®¡äº®ç‚¹**:
- UserId è®¾ä¸ºå¯ç©ºï¼Œä¿æŒå‘åå…¼å®¹
- ä¸ç ´åç°æœ‰æœªç»‘å®šç”¨æˆ·çš„è§’è‰²

---

### 2. åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰

#### UserConfiguration
**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Persistence/Configurations/UserConfiguration.cs`

**é…ç½®å†…å®¹**:
- è¡¨åï¼š`users`
- ä¸»é”®ï¼š`Id` (GUID)
- å”¯ä¸€ç´¢å¼•ï¼š`Username`, `Email`
- å¤–é”®å…³ç³»ï¼š`User.Characters` â†’ `Character.UserId`
- åˆ é™¤è¡Œä¸ºï¼š`ON DELETE SET NULL`ï¼ˆä¿ç•™å­¤ç«‹è§’è‰²ï¼‰

#### CharacterConfiguration æ›´æ–°
**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Persistence/Configurations/CharacterConfiguration.cs`

**æ–°å¢é…ç½®**:
```csharp
b.Property(x => x.UserId);
b.HasIndex(x => x.UserId);  // ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
```

#### GameDbContext æ›´æ–°
**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Persistence/GameDbContext.cs`

**æ–°å¢å†…å®¹**:
```csharp
public DbSet<User> Users => Set<User>();
```

---

### 3. æ•°æ®åº“è¿ç§»ï¼ˆDatabase Migrationï¼‰

**è¿ç§»åç§°**: `20251007064214_AddUserTable`

**è¿ç§»æ–‡ä»¶**:
- `BlazorIdle.Server/Migrations/20251007064214_AddUserTable.cs`
- `BlazorIdle.Server/Migrations/20251007064214_AddUserTable.Designer.cs`

**æ‰§è¡Œçš„æ“ä½œ**:

1. **åˆ›å»º users è¡¨**
   - å­—æ®µï¼šId, Username, Email, CreatedAt, UpdatedAt, LastLoginAt
   - å”¯ä¸€ç´¢å¼•ï¼šUsername, Email
   - ä¸»é”®ï¼šId

2. **æ›´æ–° Characters è¡¨**
   - æ–°å¢åˆ—ï¼šUserId (nullable)
   - æ–°å¢ç´¢å¼•ï¼šIX_Characters_UserId
   - æ–°å¢å¤–é”®ï¼šFK_Characters_users_UserId

3. **å¤–é”®çº¦æŸ**
   - åˆ é™¤è¡Œä¸ºï¼šSET NULLï¼ˆåˆ é™¤ç”¨æˆ·æ—¶ä¿ç•™è§’è‰²ï¼‰

**åº”ç”¨è¿ç§»**:
```bash
cd BlazorIdle.Server
dotnet ef database update
```

**éªŒè¯ç»“æœ**: âœ… è¿ç§»æˆåŠŸåº”ç”¨åˆ°æ•°æ®åº“

---

## ğŸ“Š æ•°æ®åº“ç»“æ„

### users è¡¨

| åˆ—å | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| Id | GUID | PRIMARY KEY | ç”¨æˆ·ID |
| Username | VARCHAR(64) | NOT NULL, UNIQUE | ç”¨æˆ·å |
| Email | VARCHAR(256) | NOT NULL, UNIQUE | ç”µå­é‚®ç®± |
| CreatedAt | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| UpdatedAt | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |
| LastLoginAt | DATETIME | NULL | æœ€åç™»å½•æ—¶é—´ |

### Characters è¡¨ï¼ˆæ–°å¢å­—æ®µï¼‰

| åˆ—å | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| UserId | GUID | NULL, FOREIGN KEY | æ‰€å±ç”¨æˆ·ID |

### å…³ç³»å›¾

```
users (1) â”€â”€â”€â”€â”€< (N) Characters
  â”‚                    â”‚
  â””â”€â”€ ON DELETE â”€â”€â”€> SET NULL
```

---

## ğŸ“š æ–‡æ¡£

**ä¸»æ–‡æ¡£**: `docs/ç”¨æˆ·ç³»ç»Ÿæ–‡æ¡£.md` (6.8 KB)

**æ–‡æ¡£å†…å®¹**:
- ç³»ç»Ÿæ¦‚è¿°å’Œè®¾è®¡ç›®æ ‡
- æ•°æ®åº“æ¶æ„è¯¦è§£
- é¢†åŸŸæ¨¡å‹è¯´æ˜
- EF Core é…ç½®
- æ•°æ®åº“è¿ç§»æŒ‡å—
- ä½¿ç”¨ç¤ºä¾‹ï¼ˆ5ä¸ªåœºæ™¯ï¼‰
- API ç«¯ç‚¹å»ºè®®
- æœ€ä½³å®è·µ
- ä¸ Roster ç³»ç»Ÿçš„å…³ç³»
- å®‰å…¨è€ƒè™‘
- åç»­å¢å¼ºè®¡åˆ’

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºç”¨æˆ·å¹¶å…³è”è§’è‰²

```csharp
// 1. åˆ›å»ºç”¨æˆ·
var user = new User
{
    Id = Guid.NewGuid(),
    Username = "player001",
    Email = "player001@game.com"
};
await _db.Users.AddAsync(user);
await _db.SaveChangesAsync();

// 2. åˆ›å»ºè§’è‰²å¹¶å…³è”ç”¨æˆ·
var character = new Character
{
    Id = Guid.NewGuid(),
    UserId = user.Id,  // å…³è”ç”¨æˆ·
    Name = "æˆ˜å£«å°æ˜",
    Profession = Profession.Warrior
};
await _db.Characters.AddAsync(character);
await _db.SaveChangesAsync();
```

### æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²

```csharp
var user = await _db.Users
    .Include(u => u.Characters)
    .FirstOrDefaultAsync(u => u.Id == userId);

var characterNames = user.Characters.Select(c => c.Name).ToList();
```

### å¤„ç†æœªç»‘å®šç”¨æˆ·çš„è§’è‰²ï¼ˆå‘åå…¼å®¹ï¼‰

```csharp
// æŸ¥è¯¢å­¤ç«‹è§’è‰²
var orphans = await _db.Characters
    .Where(c => c.UserId == null)
    .ToListAsync();

// å°†è§’è‰²ç»‘å®šåˆ°ç”¨æˆ·
var character = await _db.Characters.FindAsync(characterId);
character.UserId = userId;
await _db.SaveChangesAsync();
```

---

## âœ… éªŒè¯æ¸…å•

- [x] ä»£ç ç¼–è¯‘æˆåŠŸï¼ˆ0 é”™è¯¯ï¼Œ0 è­¦å‘Šï¼‰
- [x] æ•°æ®åº“è¿ç§»åˆ›å»ºæˆåŠŸ
- [x] è¿ç§»åº”ç”¨åˆ°æ•°æ®åº“æˆåŠŸ
- [x] users è¡¨åˆ›å»ºæˆåŠŸ
- [x] Characters è¡¨æ–°å¢ UserId å­—æ®µ
- [x] å”¯ä¸€ç´¢å¼•åˆ›å»ºæˆåŠŸï¼ˆUsername, Emailï¼‰
- [x] å¤–é”®çº¦æŸåˆ›å»ºæˆåŠŸ
- [x] å®Œæ•´æ–‡æ¡£å·²åˆ›å»º
- [x] éµå¾ªç°æœ‰ä»£ç é£æ ¼
- [x] å‘åå…¼å®¹ï¼ˆUserId å¯ç©ºï¼‰

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### è®¾è®¡åŸåˆ™

1. **æœ€å°åŒ–å˜æ›´**: ä»…æ·»åŠ å¿…è¦ä»£ç ï¼Œä¸ä¿®æ”¹ç°æœ‰é€»è¾‘
2. **æ¾è€¦åˆ**: UserId å¯ç©ºï¼Œå¤–é”® SET NULL
3. **é«˜æ€§èƒ½**: å…³é”®å­—æ®µæ·»åŠ ç´¢å¼•
4. **å¯æ‰©å±•**: ä¸º Roster ç³»ç»Ÿé¢„ç•™ç©ºé—´
5. **ä¸€è‡´æ€§**: éµå¾ª InventoryItem å’Œ Character çš„ç°æœ‰æ¨¡å¼

### ä»£ç é£æ ¼ä¸€è‡´æ€§

- âœ… ä½¿ç”¨ä¸­æ–‡æ³¨é‡Šï¼ˆä¸é¡¹ç›®é£æ ¼ä¸€è‡´ï¼‰
- âœ… ä½¿ç”¨ `public class` å®šä¹‰é¢†åŸŸå®ä½“
- âœ… ä½¿ç”¨ `IEntityTypeConfiguration<T>` é…ç½® EF Core
- âœ… ä½¿ç”¨å¯¼èˆªå±æ€§å»ºç«‹å…³ç³»
- âœ… ä½¿ç”¨ `DateTime.UtcNow` åˆå§‹åŒ–æ—¶é—´æˆ³
- âœ… éµå¾ªå‘½åçº¦å®šï¼ˆè¡¨åå°å†™ï¼Œç±»å PascalCaseï¼‰

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•ä¼˜åŒ–**
   - Username å”¯ä¸€ç´¢å¼•ï¼šåŠ é€Ÿç”¨æˆ·åæŸ¥æ‰¾
   - Email å”¯ä¸€ç´¢å¼•ï¼šåŠ é€Ÿé‚®ç®±æŸ¥æ‰¾
   - UserId ç´¢å¼•ï¼šåŠ é€ŸæŒ‰ç”¨æˆ·æŸ¥è¯¢è§’è‰²

2. **æŸ¥è¯¢ä¼˜åŒ–**
   - ä½¿ç”¨ `Include()` é¢„åŠ è½½å¯¼èˆªå±æ€§
   - é¿å… N+1 æŸ¥è¯¢é—®é¢˜

---

## ğŸ” å®‰å…¨è€ƒè™‘

1. **æ•°æ®å®Œæ•´æ€§**
   - ç”¨æˆ·åå’Œé‚®ç®±å”¯ä¸€æ€§ç”±æ•°æ®åº“ç´¢å¼•ä¿è¯
   - å¤–é”®çº¦æŸç¡®ä¿å…³ç³»ä¸€è‡´æ€§

2. **å‘åå…¼å®¹**
   - UserId å¯ç©ºï¼Œæ”¯æŒæœªç»‘å®šç”¨æˆ·çš„è§’è‰²
   - åˆ é™¤ç”¨æˆ·ä¸åˆ é™¤è§’è‰²ï¼ˆä¿ç•™æ•°æ®ï¼‰

3. **æœªæ¥å¢å¼º**
   - å¯†ç å­˜å‚¨ï¼ˆå“ˆå¸ŒåŠ ç›ï¼‰
   - é‚®ç®±éªŒè¯
   - JWT è®¤è¯
   - è®¿é—®æ§åˆ¶

---

## ğŸš€ åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆå·²å°±ç»ªï¼‰
- âœ… åŸºç¡€ User å®ä½“
- âœ… User-Character å…³ç³»
- âœ… æ•°æ®åº“è¿ç§»

### ä¸­æœŸï¼ˆå»ºè®®ï¼‰
- [ ] ç”¨æˆ· API ç«¯ç‚¹ï¼ˆCRUDï¼‰
- [ ] è§’è‰²ç»‘å®š/è§£ç»‘ API
- [ ] ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼ˆJWTï¼‰

### é•¿æœŸï¼ˆRoster ç³»ç»Ÿï¼‰
- [ ] RosterSlot è¡¨
- [ ] æ§½ä½è§£é”é€»è¾‘
- [ ] è§’è‰²åˆ‡æ¢åŠŸèƒ½
- [ ] è´¦å·çº§å…±äº«èµ„æº

---

## ğŸ“¦ äº¤ä»˜æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰
1. `BlazorIdle.Server/Domain/Characters/User.cs` (940 å­—èŠ‚)
2. `BlazorIdle.Server/Infrastructure/Persistence/Configurations/UserConfiguration.cs` (1,389 å­—èŠ‚)
3. `BlazorIdle.Server/Migrations/20251007064214_AddUserTable.cs` (2,541 å­—èŠ‚)
4. `BlazorIdle.Server/Migrations/20251007064214_AddUserTable.Designer.cs` (è‡ªåŠ¨ç”Ÿæˆ)
5. `docs/ç”¨æˆ·ç³»ç»Ÿæ–‡æ¡£.md` (6,826 å­—èŠ‚)

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ4ä¸ªï¼‰
1. `BlazorIdle.Server/Domain/Characters/Character.cs` (+6 è¡Œ)
2. `BlazorIdle.Server/Infrastructure/Persistence/Configurations/CharacterConfiguration.cs` (+3 è¡Œ)
3. `BlazorIdle.Server/Infrastructure/Persistence/GameDbContext.cs` (+1 è¡Œ)
4. `BlazorIdle.Server/Migrations/GameDbContextModelSnapshot.cs` (è‡ªåŠ¨æ›´æ–°)

**æ€»è®¡**: 9 ä¸ªæ–‡ä»¶ï¼Œçº¦ 1,065 è¡Œæ–°å¢/ä¿®æ”¹ä»£ç 

---

## ğŸ“ å­¦ä¹ èµ„æº

- [EF Core å…³ç³»é…ç½®](https://docs.microsoft.com/en-us/ef/core/modeling/relationships)
- [EF Core è¿ç§»](https://docs.microsoft.com/en-us/ef/core/managing-schemas/migrations/)
- [é¢†åŸŸé©±åŠ¨è®¾è®¡](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/)

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
1. `docs/ç”¨æˆ·ç³»ç»Ÿæ–‡æ¡£.md` - è¯¦ç»†æ–‡æ¡£
2. ç°æœ‰ä»£ç ç¤ºä¾‹ï¼ˆInventoryItem, Characterï¼‰
3. EF Core å®˜æ–¹æ–‡æ¡£

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡äº¤ä»˜æˆåŠŸå®ç°äº†ç”¨æˆ·è´¦å·ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- âœ… **å®Œæ•´æ€§**: åŒ…å«é¢†åŸŸæ¨¡å‹ã€æ•°æ®åº“è¿ç§»å’Œæ–‡æ¡£
- âœ… **å…¼å®¹æ€§**: ä¸ç ´åç°æœ‰åŠŸèƒ½ï¼ŒUserId å¯ç©ºè®¾è®¡
- âœ… **å¯æ‰©å±•æ€§**: ä¸º Roster ç³»ç»Ÿæ‰“ä¸‹åŸºç¡€
- âœ… **ä¸€è‡´æ€§**: éµå¾ªé¡¹ç›®ä»£ç é£æ ¼å’Œæ¶æ„æ¨¡å¼
- âœ… **è´¨é‡**: ç¼–è¯‘é€šè¿‡ï¼Œè¿ç§»æˆåŠŸï¼Œæ–‡æ¡£å®Œæ•´

**å®ç°è´¨é‡**: ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ  
**æ–‡æ¡£å®Œæ•´åº¦**: ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ  
**ä»£ç é£æ ¼ä¸€è‡´æ€§**: ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ

---

**äº¤ä»˜æ—¶é—´**: 2025å¹´10æœˆ7æ—¥  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
