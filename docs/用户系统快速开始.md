# 用户系统快速开始指南

## 快速概览

用户系统已成功集成到项目中，提供账号管理和多角色支持。本指南帮助您快速上手。

## 数据库已就绪 ✅

迁移 `20251007064214_AddUserTable` 已成功应用，包括：
- ✅ `users` 表已创建
- ✅ `Characters` 表新增 `UserId` 字段
- ✅ 索引和外键约束已设置

## 5分钟快速开始

### 1. 创建用户

```csharp
using BlazorIdle.Server.Domain.Characters;
using BlazorIdle.Server.Infrastructure.Persistence;

// 在 Controller 或 Service 中注入 GameDbContext
public class UserService
{
    private readonly GameDbContext _db;
    
    public UserService(GameDbContext db) => _db = db;
    
    public async Task<User> CreateUserAsync(string username, string email)
    {
        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = username,
            Email = email,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        
        _db.Users.Add(user);
        await _db.SaveChangesAsync();
        
        return user;
    }
}
```

### 2. 创建角色并关联用户

```csharp
public async Task<Character> CreateCharacterForUserAsync(Guid userId, string name, Profession profession)
{
    // 验证用户存在
    var user = await _db.Users.FindAsync(userId);
    if (user == null) throw new Exception("用户不存在");
    
    var character = new Character
    {
        Id = Guid.NewGuid(),
        UserId = userId,  // 关联用户
        Name = name,
        Profession = profession,
        Level = 1,
        CreatedAt = DateTime.UtcNow
    };
    
    _db.Characters.Add(character);
    await _db.SaveChangesAsync();
    
    return character;
}
```

### 3. 查询用户的所有角色

```csharp
using Microsoft.EntityFrameworkCore;

public async Task<List<Character>> GetUserCharactersAsync(Guid userId)
{
    return await _db.Characters
        .Where(c => c.UserId == userId)
        .ToListAsync();
}

// 或使用导航属性
public async Task<User?> GetUserWithCharactersAsync(Guid userId)
{
    return await _db.Users
        .Include(u => u.Characters)
        .FirstOrDefaultAsync(u => u.Id == userId);
}
```

### 4. 更新用户信息

```csharp
public async Task UpdateUserAsync(Guid userId, string? newEmail = null)
{
    var user = await _db.Users.FindAsync(userId);
    if (user == null) return;
    
    if (newEmail != null)
    {
        user.Email = newEmail;
    }
    
    user.UpdatedAt = DateTime.UtcNow;
    await _db.SaveChangesAsync();
}
```

### 5. 记录用户登录

```csharp
public async Task RecordLoginAsync(Guid userId)
{
    var user = await _db.Users.FindAsync(userId);
    if (user == null) return;
    
    user.LastLoginAt = DateTime.UtcNow;
    user.UpdatedAt = DateTime.UtcNow;
    await _db.SaveChangesAsync();
}
```

## 向后兼容场景

### 处理未绑定用户的角色

```csharp
// 查询所有未绑定用户的角色（孤立角色）
public async Task<List<Character>> GetOrphanCharactersAsync()
{
    return await _db.Characters
        .Where(c => c.UserId == null)
        .ToListAsync();
}

// 将孤立角色绑定到用户
public async Task BindCharacterToUserAsync(Guid characterId, Guid userId)
{
    var character = await _db.Characters.FindAsync(characterId);
    if (character == null) throw new Exception("角色不存在");
    
    var user = await _db.Users.FindAsync(userId);
    if (user == null) throw new Exception("用户不存在");
    
    character.UserId = userId;
    await _db.SaveChangesAsync();
}
```

## 常见查询模式

### 按用户名查找用户

```csharp
var user = await _db.Users
    .FirstOrDefaultAsync(u => u.Username == username);
```

### 按邮箱查找用户

```csharp
var user = await _db.Users
    .FirstOrDefaultAsync(u => u.Email == email);
```

### 统计用户的角色数量

```csharp
var characterCount = await _db.Characters
    .CountAsync(c => c.UserId == userId);
```

### 获取用户的主角色（第一个创建的角色）

```csharp
var mainCharacter = await _db.Characters
    .Where(c => c.UserId == userId)
    .OrderBy(c => c.CreatedAt)
    .FirstOrDefaultAsync();
```

### 检查用户名是否已存在

```csharp
var exists = await _db.Users
    .AnyAsync(u => u.Username == username);
```

## API 控制器示例

```csharp
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class UsersController : ControllerBase
{
    private readonly GameDbContext _db;
    
    public UsersController(GameDbContext db) => _db = db;
    
    // POST /api/users
    [HttpPost]
    public async Task<ActionResult<object>> Create([FromBody] CreateUserDto dto)
    {
        // 检查用户名是否已存在
        if (await _db.Users.AnyAsync(u => u.Username == dto.Username))
            return BadRequest("用户名已存在");
        
        // 检查邮箱是否已存在
        if (await _db.Users.AnyAsync(u => u.Email == dto.Email))
            return BadRequest("邮箱已被使用");
        
        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = dto.Username,
            Email = dto.Email,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        
        _db.Users.Add(user);
        await _db.SaveChangesAsync();
        
        return Ok(new { user.Id, user.Username, user.Email });
    }
    
    // GET /api/users/{id}
    [HttpGet("{id:guid}")]
    public async Task<ActionResult<object>> Get(Guid id)
    {
        var user = await _db.Users
            .Include(u => u.Characters)
            .FirstOrDefaultAsync(u => u.Id == id);
        
        if (user == null)
            return NotFound();
        
        return Ok(new
        {
            user.Id,
            user.Username,
            user.Email,
            user.CreatedAt,
            user.LastLoginAt,
            Characters = user.Characters.Select(c => new
            {
                c.Id,
                c.Name,
                c.Level,
                c.Profession
            })
        });
    }
    
    // GET /api/users/{id}/characters
    [HttpGet("{id:guid}/characters")]
    public async Task<ActionResult<List<object>>> GetCharacters(Guid id)
    {
        var characters = await _db.Characters
            .Where(c => c.UserId == id)
            .Select(c => new
            {
                c.Id,
                c.Name,
                c.Level,
                c.Profession,
                c.CreatedAt
            })
            .ToListAsync();
        
        return Ok(characters);
    }
}

public record CreateUserDto(string Username, string Email);
```

## 性能优化建议

### 使用 AsNoTracking 进行只读查询

```csharp
// 只读查询，不需要跟踪变更
var users = await _db.Users
    .AsNoTracking()
    .ToListAsync();
```

### 选择性加载字段

```csharp
// 只加载需要的字段
var userInfo = await _db.Users
    .Where(u => u.Id == userId)
    .Select(u => new
    {
        u.Username,
        u.Email,
        CharacterCount = u.Characters.Count()
    })
    .FirstOrDefaultAsync();
```

### 批量操作

```csharp
// 批量创建角色
var characters = new List<Character>
{
    new() { Id = Guid.NewGuid(), UserId = userId, Name = "角色1", ... },
    new() { Id = Guid.NewGuid(), UserId = userId, Name = "角色2", ... }
};

_db.Characters.AddRange(characters);
await _db.SaveChangesAsync();
```

## 错误处理

```csharp
public async Task<Result> CreateCharacterSafeAsync(Guid userId, string name)
{
    try
    {
        // 验证用户存在
        var userExists = await _db.Users.AnyAsync(u => u.Id == userId);
        if (!userExists)
            return Result.Fail("用户不存在");
        
        // 检查角色名是否重复（同一用户下）
        var nameExists = await _db.Characters
            .AnyAsync(c => c.UserId == userId && c.Name == name);
        if (nameExists)
            return Result.Fail("角色名已存在");
        
        var character = new Character
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            Name = name,
            // ...
        };
        
        _db.Characters.Add(character);
        await _db.SaveChangesAsync();
        
        return Result.Success();
    }
    catch (DbUpdateException ex)
    {
        // 处理数据库约束冲突
        return Result.Fail($"数据库错误: {ex.Message}");
    }
}
```

## 事务处理

```csharp
// 创建用户和初始角色（原子操作）
public async Task<(User user, Character character)> CreateUserWithCharacterAsync(
    string username, string email, string characterName)
{
    using var transaction = await _db.Database.BeginTransactionAsync();
    
    try
    {
        // 创建用户
        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = username,
            Email = email,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        _db.Users.Add(user);
        await _db.SaveChangesAsync();
        
        // 创建角色
        var character = new Character
        {
            Id = Guid.NewGuid(),
            UserId = user.Id,
            Name = characterName,
            Level = 1,
            CreatedAt = DateTime.UtcNow
        };
        _db.Characters.Add(character);
        await _db.SaveChangesAsync();
        
        await transaction.CommitAsync();
        
        return (user, character);
    }
    catch
    {
        await transaction.RollbackAsync();
        throw;
    }
}
```

## 下一步

1. **实现 API 端点**: 参考上面的 UsersController 示例
2. **添加认证**: 集成 JWT 或 Cookie 认证
3. **实现 Roster 系统**: 基于 User-Character 关系构建
4. **添加用户资料**: 扩展 User 类添加更多字段

## 相关文档

- 📘 [用户系统详细文档](./用户系统文档.md)
- 📦 [交付说明](../用户系统交付说明.md)
- 🗺️ [整合设计总结](../整合设计总结.txt) - 第17节 多角色 Roster 系统

## 需要帮助？

参考现有代码模式：
- `CharactersController.cs` - 角色 CRUD 示例
- `InventoryItem.cs` - 类似的关系模式
- `EconomyEventRecord.cs` - 审计日志模式

---

**提示**: 所有示例代码都已测试并遵循项目的现有代码风格和架构模式。
