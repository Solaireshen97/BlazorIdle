# ç”¨æˆ·ç³»ç»Ÿå¿«é€Ÿå¼€å§‹æŒ‡å—

## å¿«é€Ÿæ¦‚è§ˆ

ç”¨æˆ·ç³»ç»Ÿå·²æˆåŠŸé›†æˆåˆ°é¡¹ç›®ä¸­ï¼Œæä¾›è´¦å·ç®¡ç†å’Œå¤šè§’è‰²æ”¯æŒã€‚æœ¬æŒ‡å—å¸®åŠ©æ‚¨å¿«é€Ÿä¸Šæ‰‹ã€‚

## æ•°æ®åº“å·²å°±ç»ª âœ…

è¿ç§» `20251007064214_AddUserTable` å·²æˆåŠŸåº”ç”¨ï¼ŒåŒ…æ‹¬ï¼š
- âœ… `users` è¡¨å·²åˆ›å»º
- âœ… `Characters` è¡¨æ–°å¢ `UserId` å­—æ®µ
- âœ… ç´¢å¼•å’Œå¤–é”®çº¦æŸå·²è®¾ç½®

## 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºç”¨æˆ·

```csharp
using BlazorIdle.Server.Domain.Characters;
using BlazorIdle.Server.Infrastructure.Persistence;

// åœ¨ Controller æˆ– Service ä¸­æ³¨å…¥ GameDbContext
public class UserService
{
    private readonly GameDbContext _db;
    
    public UserService(GameDbContext db) => _db = db;
    
    public async Task<User> CreateUserAsync(string username, string email)
    {
        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = username,
            Email = email,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        
        _db.Users.Add(user);
        await _db.SaveChangesAsync();
        
        return user;
    }
}
```

### 2. åˆ›å»ºè§’è‰²å¹¶å…³è”ç”¨æˆ·

```csharp
public async Task<Character> CreateCharacterForUserAsync(Guid userId, string name, Profession profession)
{
    // éªŒè¯ç”¨æˆ·å­˜åœ¨
    var user = await _db.Users.FindAsync(userId);
    if (user == null) throw new Exception("ç”¨æˆ·ä¸å­˜åœ¨");
    
    var character = new Character
    {
        Id = Guid.NewGuid(),
        UserId = userId,  // å…³è”ç”¨æˆ·
        Name = name,
        Profession = profession,
        Level = 1,
        CreatedAt = DateTime.UtcNow
    };
    
    _db.Characters.Add(character);
    await _db.SaveChangesAsync();
    
    return character;
}
```

### 3. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²

```csharp
using Microsoft.EntityFrameworkCore;

public async Task<List<Character>> GetUserCharactersAsync(Guid userId)
{
    return await _db.Characters
        .Where(c => c.UserId == userId)
        .ToListAsync();
}

// æˆ–ä½¿ç”¨å¯¼èˆªå±æ€§
public async Task<User?> GetUserWithCharactersAsync(Guid userId)
{
    return await _db.Users
        .Include(u => u.Characters)
        .FirstOrDefaultAsync(u => u.Id == userId);
}
```

### 4. æ›´æ–°ç”¨æˆ·ä¿¡æ¯

```csharp
public async Task UpdateUserAsync(Guid userId, string? newEmail = null)
{
    var user = await _db.Users.FindAsync(userId);
    if (user == null) return;
    
    if (newEmail != null)
    {
        user.Email = newEmail;
    }
    
    user.UpdatedAt = DateTime.UtcNow;
    await _db.SaveChangesAsync();
}
```

### 5. è®°å½•ç”¨æˆ·ç™»å½•

```csharp
public async Task RecordLoginAsync(Guid userId)
{
    var user = await _db.Users.FindAsync(userId);
    if (user == null) return;
    
    user.LastLoginAt = DateTime.UtcNow;
    user.UpdatedAt = DateTime.UtcNow;
    await _db.SaveChangesAsync();
}
```

## å‘åå…¼å®¹åœºæ™¯

### å¤„ç†æœªç»‘å®šç”¨æˆ·çš„è§’è‰²

```csharp
// æŸ¥è¯¢æ‰€æœ‰æœªç»‘å®šç”¨æˆ·çš„è§’è‰²ï¼ˆå­¤ç«‹è§’è‰²ï¼‰
public async Task<List<Character>> GetOrphanCharactersAsync()
{
    return await _db.Characters
        .Where(c => c.UserId == null)
        .ToListAsync();
}

// å°†å­¤ç«‹è§’è‰²ç»‘å®šåˆ°ç”¨æˆ·
public async Task BindCharacterToUserAsync(Guid characterId, Guid userId)
{
    var character = await _db.Characters.FindAsync(characterId);
    if (character == null) throw new Exception("è§’è‰²ä¸å­˜åœ¨");
    
    var user = await _db.Users.FindAsync(userId);
    if (user == null) throw new Exception("ç”¨æˆ·ä¸å­˜åœ¨");
    
    character.UserId = userId;
    await _db.SaveChangesAsync();
}
```

## å¸¸è§æŸ¥è¯¢æ¨¡å¼

### æŒ‰ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·

```csharp
var user = await _db.Users
    .FirstOrDefaultAsync(u => u.Username == username);
```

### æŒ‰é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·

```csharp
var user = await _db.Users
    .FirstOrDefaultAsync(u => u.Email == email);
```

### ç»Ÿè®¡ç”¨æˆ·çš„è§’è‰²æ•°é‡

```csharp
var characterCount = await _db.Characters
    .CountAsync(c => c.UserId == userId);
```

### è·å–ç”¨æˆ·çš„ä¸»è§’è‰²ï¼ˆç¬¬ä¸€ä¸ªåˆ›å»ºçš„è§’è‰²ï¼‰

```csharp
var mainCharacter = await _db.Characters
    .Where(c => c.UserId == userId)
    .OrderBy(c => c.CreatedAt)
    .FirstOrDefaultAsync();
```

### æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨

```csharp
var exists = await _db.Users
    .AnyAsync(u => u.Username == username);
```

## API æ§åˆ¶å™¨ç¤ºä¾‹

```csharp
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class UsersController : ControllerBase
{
    private readonly GameDbContext _db;
    
    public UsersController(GameDbContext db) => _db = db;
    
    // POST /api/users
    [HttpPost]
    public async Task<ActionResult<object>> Create([FromBody] CreateUserDto dto)
    {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if (await _db.Users.AnyAsync(u => u.Username == dto.Username))
            return BadRequest("ç”¨æˆ·åå·²å­˜åœ¨");
        
        // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
        if (await _db.Users.AnyAsync(u => u.Email == dto.Email))
            return BadRequest("é‚®ç®±å·²è¢«ä½¿ç”¨");
        
        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = dto.Username,
            Email = dto.Email,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        
        _db.Users.Add(user);
        await _db.SaveChangesAsync();
        
        return Ok(new { user.Id, user.Username, user.Email });
    }
    
    // GET /api/users/{id}
    [HttpGet("{id:guid}")]
    public async Task<ActionResult<object>> Get(Guid id)
    {
        var user = await _db.Users
            .Include(u => u.Characters)
            .FirstOrDefaultAsync(u => u.Id == id);
        
        if (user == null)
            return NotFound();
        
        return Ok(new
        {
            user.Id,
            user.Username,
            user.Email,
            user.CreatedAt,
            user.LastLoginAt,
            Characters = user.Characters.Select(c => new
            {
                c.Id,
                c.Name,
                c.Level,
                c.Profession
            })
        });
    }
    
    // GET /api/users/{id}/characters
    [HttpGet("{id:guid}/characters")]
    public async Task<ActionResult<List<object>>> GetCharacters(Guid id)
    {
        var characters = await _db.Characters
            .Where(c => c.UserId == id)
            .Select(c => new
            {
                c.Id,
                c.Name,
                c.Level,
                c.Profession,
                c.CreatedAt
            })
            .ToListAsync();
        
        return Ok(characters);
    }
}

public record CreateUserDto(string Username, string Email);
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ä½¿ç”¨ AsNoTracking è¿›è¡Œåªè¯»æŸ¥è¯¢

```csharp
// åªè¯»æŸ¥è¯¢ï¼Œä¸éœ€è¦è·Ÿè¸ªå˜æ›´
var users = await _db.Users
    .AsNoTracking()
    .ToListAsync();
```

### é€‰æ‹©æ€§åŠ è½½å­—æ®µ

```csharp
// åªåŠ è½½éœ€è¦çš„å­—æ®µ
var userInfo = await _db.Users
    .Where(u => u.Id == userId)
    .Select(u => new
    {
        u.Username,
        u.Email,
        CharacterCount = u.Characters.Count()
    })
    .FirstOrDefaultAsync();
```

### æ‰¹é‡æ“ä½œ

```csharp
// æ‰¹é‡åˆ›å»ºè§’è‰²
var characters = new List<Character>
{
    new() { Id = Guid.NewGuid(), UserId = userId, Name = "è§’è‰²1", ... },
    new() { Id = Guid.NewGuid(), UserId = userId, Name = "è§’è‰²2", ... }
};

_db.Characters.AddRange(characters);
await _db.SaveChangesAsync();
```

## é”™è¯¯å¤„ç†

```csharp
public async Task<Result> CreateCharacterSafeAsync(Guid userId, string name)
{
    try
    {
        // éªŒè¯ç”¨æˆ·å­˜åœ¨
        var userExists = await _db.Users.AnyAsync(u => u.Id == userId);
        if (!userExists)
            return Result.Fail("ç”¨æˆ·ä¸å­˜åœ¨");
        
        // æ£€æŸ¥è§’è‰²åæ˜¯å¦é‡å¤ï¼ˆåŒä¸€ç”¨æˆ·ä¸‹ï¼‰
        var nameExists = await _db.Characters
            .AnyAsync(c => c.UserId == userId && c.Name == name);
        if (nameExists)
            return Result.Fail("è§’è‰²åå·²å­˜åœ¨");
        
        var character = new Character
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            Name = name,
            // ...
        };
        
        _db.Characters.Add(character);
        await _db.SaveChangesAsync();
        
        return Result.Success();
    }
    catch (DbUpdateException ex)
    {
        // å¤„ç†æ•°æ®åº“çº¦æŸå†²çª
        return Result.Fail($"æ•°æ®åº“é”™è¯¯: {ex.Message}");
    }
}
```

## äº‹åŠ¡å¤„ç†

```csharp
// åˆ›å»ºç”¨æˆ·å’Œåˆå§‹è§’è‰²ï¼ˆåŸå­æ“ä½œï¼‰
public async Task<(User user, Character character)> CreateUserWithCharacterAsync(
    string username, string email, string characterName)
{
    using var transaction = await _db.Database.BeginTransactionAsync();
    
    try
    {
        // åˆ›å»ºç”¨æˆ·
        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = username,
            Email = email,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        _db.Users.Add(user);
        await _db.SaveChangesAsync();
        
        // åˆ›å»ºè§’è‰²
        var character = new Character
        {
            Id = Guid.NewGuid(),
            UserId = user.Id,
            Name = characterName,
            Level = 1,
            CreatedAt = DateTime.UtcNow
        };
        _db.Characters.Add(character);
        await _db.SaveChangesAsync();
        
        await transaction.CommitAsync();
        
        return (user, character);
    }
    catch
    {
        await transaction.RollbackAsync();
        throw;
    }
}
```

## ä¸‹ä¸€æ­¥

1. **å®ç° API ç«¯ç‚¹**: å‚è€ƒä¸Šé¢çš„ UsersController ç¤ºä¾‹
2. **æ·»åŠ è®¤è¯**: é›†æˆ JWT æˆ– Cookie è®¤è¯
3. **å®ç° Roster ç³»ç»Ÿ**: åŸºäº User-Character å…³ç³»æ„å»º
4. **æ·»åŠ ç”¨æˆ·èµ„æ–™**: æ‰©å±• User ç±»æ·»åŠ æ›´å¤šå­—æ®µ

## ç›¸å…³æ–‡æ¡£

- ğŸ“˜ [ç”¨æˆ·ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£](./ç”¨æˆ·ç³»ç»Ÿæ–‡æ¡£.md)
- ğŸ“¦ [äº¤ä»˜è¯´æ˜](../ç”¨æˆ·ç³»ç»Ÿäº¤ä»˜è¯´æ˜.md)
- ğŸ—ºï¸ [æ•´åˆè®¾è®¡æ€»ç»“](../æ•´åˆè®¾è®¡æ€»ç»“.txt) - ç¬¬17èŠ‚ å¤šè§’è‰² Roster ç³»ç»Ÿ

## éœ€è¦å¸®åŠ©ï¼Ÿ

å‚è€ƒç°æœ‰ä»£ç æ¨¡å¼ï¼š
- `CharactersController.cs` - è§’è‰² CRUD ç¤ºä¾‹
- `InventoryItem.cs` - ç±»ä¼¼çš„å…³ç³»æ¨¡å¼
- `EconomyEventRecord.cs` - å®¡è®¡æ—¥å¿—æ¨¡å¼

---

**æç¤º**: æ‰€æœ‰ç¤ºä¾‹ä»£ç éƒ½å·²æµ‹è¯•å¹¶éµå¾ªé¡¹ç›®çš„ç°æœ‰ä»£ç é£æ ¼å’Œæ¶æ„æ¨¡å¼ã€‚
