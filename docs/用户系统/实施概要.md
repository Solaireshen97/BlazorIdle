# JWT用户系统 - 实施概要

**生成日期**: 2025年10月23日  
**状态**: ✅ 设计完成，待实施

---

## 📊 文档生成概览

已生成 **3个完整设计文档**，共 **2819行**，覆盖从需求分析到代码实现的全流程：

```
docs/用户系统/
├── README.md                       (361行) - 导航和快速参考
├── JWT用户系统设计方案.md          (1429行) - 完整架构设计
└── JWT用户系统实施指南.md          (1029行) - 分步实施指导
```

---

## 🎯 核心设计要点

### 1. 轻量级设计

```
✅ 内存存储（无数据库）
✅ 预设测试账户（test1、test2、admin）
✅ 服务重启后重新初始化
✅ 最小化代码改动
```

### 2. 技术架构

```
客户端                          服务端
┌─────────────┐                ┌──────────────────┐
│ Login Page  │ ─────────────> │  AuthController  │
└─────────────┘                └──────────────────┘
       │                               │
       v                               v
┌─────────────┐                ┌──────────────────┐
│ AuthService │                │   AuthService    │
│ (Token管理) │                │ (JWT生成/验证)   │
└─────────────┘                └──────────────────┘
       │                               │
       v                               v
 LocalStorage                   ┌──────────────────┐
   (Token)                      │    UserStore     │
       │                        │  (内存存储)      │
       v                        └──────────────────┘
┌─────────────┐                        │
│ SignalR     │                        v
│ Connection  │ ───── Bearer Token ──> GameHub
└─────────────┘                    (用户验证)
```

### 3. 安全措施

| 层面 | 措施 | 说明 |
|------|------|------|
| 密码 | BCrypt哈希 | 工作因子12，不存储明文 |
| 传输 | HTTPS | 强制启用 |
| 令牌 | JWT + HMAC-SHA256 | 标准签名算法 |
| 过期 | 60分钟/7天 | 访问令牌/刷新令牌 |
| CORS | 来源限制 | 仅允许指定域名 |

---

## 📚 文档结构

### 1. README.md - 快速导航

**用途**: 项目入口，快速查找信息

**核心内容**:
- 背景和需求说明
- 系统架构一览
- 快速开始指南
- API速查表
- 故障排查速查
- 测试账户列表

**适合人群**: 所有开发人员

---

### 2. JWT用户系统设计方案.md - 完整设计

**用途**: 理解整体设计思路和技术选型

**核心内容** (13个章节):

1. ✅ **背景与需求** - 为什么需要JWT系统
2. ✅ **设计目标** - 核心价值和非功能需求
3. ✅ **系统架构** - 整体架构图、数据流图
4. ✅ **技术选型** - 服务端和客户端技术栈
5. ✅ **核心组件设计** - 4个核心组件详细设计
   - UserStore (用户存储)
   - AuthService (认证服务)
   - AuthController (API控制器)
   - AuthenticationService (客户端服务)
6. ✅ **API接口设计** - 4个REST API端点
7. ✅ **数据模型** - 5个数据模型定义
8. ✅ **安全性设计** - 5层安全措施
9. ✅ **客户端集成** - 登录页面、Token管理
10. ✅ **SignalR集成** - 连接配置、服务端验证
11. ✅ **配置管理** - 服务端和客户端配置
12. ✅ **测试计划** - 单元测试、集成测试、手动测试
13. ✅ **实施路线图** - 10步骤、3.5-6天完成

**适合人群**: 架构师、技术负责人

---

### 3. JWT用户系统实施指南.md - 代码实现

**用途**: 按步骤实施，提供完整代码示例

**核心内容** (3个阶段):

#### 阶段一: 服务端基础实施 (2-3天)

- ✅ **步骤1**: 安装依赖和配置
  - NuGet包安装命令
  - 目录结构创建
  - appsettings.json配置
  
- ✅ **步骤2**: 实现UserStore
  - User模型（完整代码）
  - IUserStore接口（完整代码）
  - InMemoryUserStore实现（完整代码，230行）
  - 测试账户初始化逻辑
  
- ✅ **步骤3**: 实现AuthService
  - JwtOptions配置类（完整代码）
  - AuthResult和DTOs（完整代码）
  - IAuthService接口（完整代码）
  - AuthService实现（完整代码，200行）
  - JWT令牌生成和验证

- ⏳ **步骤4**: 实现AuthController (待补充)
- ⏳ **步骤5**: 配置JWT认证中间件 (待补充)

#### 阶段二: 客户端实施 (1-2天) ⏳

#### 阶段三: SignalR集成 (0.5-1天) ⏳

**适合人群**: 所有开发人员

---

## 🚀 实施步骤总览

### 10步走完全流程

```
服务端（5步）
 ├─ [✅ 文档] 步骤1: 安装依赖和配置          (0.5天)
 ├─ [✅ 文档] 步骤2: 实现UserStore           (0.5天)
 ├─ [✅ 文档] 步骤3: 实现AuthService         (1天)
 ├─ [⏳ 待补] 步骤4: 实现AuthController      (0.5天)
 └─ [⏳ 待补] 步骤5: 配置JWT认证中间件       (0.5天)

客户端（3步）
 ├─ [⏳ 待补] 步骤6: 安装客户端依赖          (0.5天)
 ├─ [⏳ 待补] 步骤7: 实现AuthenticationService (1天)
 └─ [⏳ 待补] 步骤8: 创建登录页面            (0.5天)

集成（2步）
 ├─ [⏳ 待补] 步骤9: 修改SignalR连接管理     (0.5天)
 └─ [⏳ 待补] 步骤10: 端到端测试             (0.5天)

总计: 3.5-6天
```

---

## 💻 代码示例预览

### 服务端 - UserStore (InMemoryUserStore)

```csharp
public class InMemoryUserStore : IUserStore
{
    private readonly ConcurrentDictionary<string, User> _usersById = new();
    private readonly ConcurrentDictionary<string, string> _usernameToId = new();
    
    public InMemoryUserStore(ILogger<InMemoryUserStore> logger)
    {
        _logger = logger;
        InitializeTestAccounts(); // 初始化测试账户
    }
    
    private void InitializeTestAccounts()
    {
        CreateTestUser("test1", "password123");
        CreateTestUser("test2", "password123");
        CreateTestUser("admin", "admin123");
    }
    
    public async Task<User?> GetUserByUsernameAsync(string username)
    {
        var normalizedUsername = username.ToLowerInvariant();
        if (_usernameToId.TryGetValue(normalizedUsername, out var userId))
        {
            _usersById.TryGetValue(userId, out var user);
            return user;
        }
        return null;
    }
    
    // ... 其他方法
}
```

### 服务端 - AuthService (JWT生成)

```csharp
public string GenerateJwtToken(User user)
{
    var claims = new[]
    {
        new Claim(ClaimTypes.NameIdentifier, user.Id),
        new Claim(ClaimTypes.Name, user.Username),
        new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
    };
    
    var key = new SymmetricSecurityKey(
        Encoding.UTF8.GetBytes(_jwtOptions.SecretKey));
    var credentials = new SigningCredentials(
        key, SecurityAlgorithms.HmacSha256);
    
    var token = new JwtSecurityToken(
        issuer: _jwtOptions.Issuer,
        audience: _jwtOptions.Audience,
        claims: claims,
        expires: DateTime.UtcNow.AddMinutes(_jwtOptions.ExpirationMinutes),
        signingCredentials: credentials
    );
    
    return new JwtSecurityTokenHandler().WriteToken(token);
}
```

### API接口 - 登录

```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "test1",
  "password": "password123"
}
```

**响应**:
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "base64_encoded_refresh_token",
  "expiresAt": "2025-10-23T14:30:00Z",
  "user": {
    "id": "guid",
    "username": "test1",
    "createdAt": "2025-10-23T06:00:00Z"
  }
}
```

---

## 🎯 测试账户

系统预设3个测试账户（在`InMemoryUserStore`构造函数中初始化）：

| 用户名 | 密码 | 说明 |
|--------|------|------|
| test1 | password123 | 普通测试账户1 |
| test2 | password123 | 普通测试账户2 |
| admin | admin123 | 管理员测试账户 |

**注意**: 
- 数据存储在内存中
- 服务重启后会重新初始化
- 仅用于开发测试

---

## ✅ 验收标准

### 功能性验收

```
✅ 用户可以使用测试账户登录
✅ 登录后获得有效JWT令牌
✅ Token自动附加到HTTP请求
✅ Token自动附加到SignalR连接
✅ GameHub正确识别用户身份（通过ClaimTypes.NameIdentifier）
✅ Token过期后自动拒绝
✅ 令牌刷新机制正常工作
```

### 性能验收

```
✅ 登录响应时间 < 100ms
✅ Token验证时间 < 10ms
✅ SignalR连接建立时间 < 1秒
✅ 内存使用稳定（无泄漏）
```

### 安全性验收

```
✅ 密码使用BCrypt哈希（工作因子12）
✅ JWT使用HMAC-SHA256签名
✅ HTTPS强制启用
✅ 未授权请求返回401
✅ 错误消息不泄露敏感信息
```

---

## 🔧 依赖包清单

### 服务端新增 (BlazorIdle.Server)

```xml
<PackageReference Include="System.IdentityModel.Tokens.Jwt" Version="8.2.1" />
<PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
<PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="9.0.9" />
```

### 客户端新增 (BlazorIdle)

```xml
<PackageReference Include="Blazored.LocalStorage" Version="4.5.0" />
```

---

## 📋 配置文件示例

### 服务端配置 (appsettings.json)

```json
{
  "Jwt": {
    "SecretKey": "至少32字符的强密钥_BlazorIdleJwtSecret2025",
    "Issuer": "BlazorIdleServer",
    "Audience": "BlazorIdleClient",
    "ExpirationMinutes": 60,
    "RefreshTokenExpirationDays": 7
  }
}
```

### 客户端配置 (wwwroot/appsettings.json)

```json
{
  "ApiBaseUrl": "https://localhost:7056",
  "Auth": {
    "LoginPath": "/login",
    "TokenStorageKey": "authToken"
  }
}
```

---

## 🚦 下一步行动

### 选项1: 继续完善文档

让AI继续补充实施指南的剩余部分：
- 步骤4-5（服务端剩余步骤）
- 步骤6-8（客户端实施）
- 步骤9-10（SignalR集成）

### 选项2: 开始代码实现

直接按照已有文档开始编码：
1. 阅读设计方案了解架构
2. 按照实施指南步骤1-3创建代码
3. 遇到问题查看文档故障排查章节

### 选项3: AI辅助实现

让AI直接生成代码文件：
1. 根据设计文档生成所有代码
2. 创建测试用例
3. 验证功能正确性

---

## 📞 获取帮助

**问题排查顺序**:
1. 查看 `README.md` 的故障排查速查表
2. 查看对应文档的"故障排查"章节
3. 检查日志输出
4. 向团队成员寻求帮助

**文档导航**:
- 快速查找 → README.md
- 理解架构 → JWT用户系统设计方案.md
- 编码实现 → JWT用户系统实施指南.md

---

## 📊 文档质量指标

```
✅ 架构设计完整性: 100%
✅ API接口定义: 100%
✅ 数据模型定义: 100%
✅ 安全性设计: 100%
✅ 配置示例: 100%
✅ 测试计划: 100%

⏳ 代码示例完整性: 60%
   - 服务端步骤1-3: ✅ 完成
   - 服务端步骤4-5: ⏳ 待补充
   - 客户端步骤6-8: ⏳ 待补充
   - 集成步骤9-10: ⏳ 待补充
```

---

**文档状态**: ✅ 设计完成，实施指南60%完成  
**最后更新**: 2025年10月23日  
**下一步**: 选择实施路径（完善文档/开始编码/AI辅助）
