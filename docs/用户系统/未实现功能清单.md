# JWT用户系统未实现功能清单

**文档版本**: 1.0  
**生成日期**: 2025年10月24日  
**状态**: 规划文档  
**目标**: 列出当前JWT用户系统尚未实现的功能，供未来开发参考

---

## 📋 目录

1. [概述](#概述)
2. [高优先级功能](#高优先级功能)
3. [中优先级功能](#中优先级功能)
4. [低优先级功能](#低优先级功能)
5. [技术债务与改进](#技术债务与改进)
6. [安全性增强](#安全性增强)
7. [性能优化](#性能优化)

---

## 概述

### 当前实施状态

✅ **已完成的核心功能**（步骤1-10）:
- 用户注册与登录
- JWT令牌生成与验证
- 刷新令牌机制
- 基于内存的用户存储
- SignalR认证集成
- 客户端LocalStorage存储
- 测试账户系统
- 完整的单元测试和端到端测试
- 基本的安全措施（BCrypt、HTTPS、防时序攻击）

⚠️ **当前系统限制**:
- 用户数据仅存储在内存中（服务重启后丢失）
- 无用户配置文件管理
- 无密码重置功能
- 无邮箱验证
- 无社交登录
- 无多因素认证（MFA）
- 无角色和权限管理
- 无Token黑名单
- 无异常登录检测

---

## 高优先级功能

### P0: 数据持久化（生产环境必需）

**目标**: 将用户数据从内存存储迁移到数据库

**功能清单**:
1. **数据库设计**
   - [ ] 设计Users表结构
   - [ ] 设计RefreshTokens表结构
   - [ ] 创建数据库迁移脚本
   - [ ] 添加索引优化查询

2. **数据库实现**
   - [ ] 选择数据库（PostgreSQL/MySQL/SQLite）
   - [ ] 配置Entity Framework Core
   - [ ] 实现DatabaseUserStore（替换InMemoryUserStore）
   - [ ] 实现数据库迁移工具
   - [ ] 添加数据库连接字符串配置

3. **数据迁移**
   - [ ] 实现测试账户初始化脚本
   - [ ] 实现数据导入导出工具
   - [ ] 编写迁移文档

**验收标准**:
- ✅ 用户数据持久化存储
- ✅ 服务重启后用户数据不丢失
- ✅ 支持数据库备份和恢复
- ✅ 查询性能满足要求（< 50ms）
- ✅ 通过所有现有测试

**估算工时**: 2-3天  
**依赖**: 无  
**风险**: 需要选择合适的数据库，考虑部署环境

---

### P0: 密码重置功能

**目标**: 允许用户在忘记密码时重置密码

**功能清单**:
1. **邮件服务集成**
   - [ ] 选择邮件服务提供商（SendGrid/AWS SES/SMTP）
   - [ ] 配置邮件服务
   - [ ] 设计邮件模板
   - [ ] 实现邮件发送服务

2. **密码重置流程**
   - [ ] 实现"忘记密码"API端点
   - [ ] 生成密码重置令牌（时效性、一次性）
   - [ ] 发送重置邮件
   - [ ] 实现密码重置验证页面
   - [ ] 实现密码重置API端点
   - [ ] 添加安全验证（防止暴力破解）

3. **用户界面**
   - [ ] 创建"忘记密码"页面
   - [ ] 创建"重置密码"页面
   - [ ] 添加邮件发送成功/失败提示
   - [ ] 添加密码强度验证

**验收标准**:
- ✅ 用户可以请求密码重置
- ✅ 收到包含重置链接的邮件
- ✅ 重置令牌在15分钟后过期
- ✅ 重置令牌只能使用一次
- ✅ 成功重置密码后可以登录

**估算工时**: 2天  
**依赖**: P0-数据持久化  
**风险**: 邮件服务配置可能复杂，需要防止滥用

---

### P0: 邮箱验证

**目标**: 验证用户注册时提供的邮箱地址

**功能清单**:
1. **用户模型扩展**
   - [ ] 添加Email字段
   - [ ] 添加EmailConfirmed字段
   - [ ] 添加EmailConfirmationToken字段
   - [ ] 更新数据库迁移

2. **邮箱验证流程**
   - [ ] 注册时收集邮箱地址
   - [ ] 生成邮箱验证令牌
   - [ ] 发送验证邮件
   - [ ] 实现邮箱验证API端点
   - [ ] 未验证用户限制功能访问

3. **用户界面**
   - [ ] 注册表单添加邮箱输入
   - [ ] 创建邮箱验证页面
   - [ ] 显示邮箱验证状态
   - [ ] 添加"重新发送验证邮件"功能

**验收标准**:
- ✅ 注册时必须提供有效邮箱
- ✅ 注册后自动发送验证邮件
- ✅ 用户点击链接完成验证
- ✅ 未验证用户功能受限
- ✅ 验证链接24小时后过期

**估算工时**: 1.5天  
**依赖**: P0-数据持久化, P0-密码重置（共享邮件服务）  
**风险**: 邮件可能进入垃圾箱，需要良好的邮件送达率

---

## 中优先级功能

### P1: 角色和权限管理

**目标**: 实现基于角色的访问控制（RBAC）

**功能清单**:
1. **数据模型**
   - [ ] 设计Roles表
   - [ ] 设计Permissions表
   - [ ] 设计UserRoles关联表
   - [ ] 设计RolePermissions关联表
   - [ ] 创建数据库迁移

2. **授权服务**
   - [ ] 实现IRoleService接口
   - [ ] 实现IPermissionService接口
   - [ ] 实现角色分配功能
   - [ ] 实现权限检查功能
   - [ ] 在JWT中包含角色信息

3. **授权策略**
   - [ ] 配置ASP.NET Core授权策略
   - [ ] 创建自定义授权要求
   - [ ] 实现基于角色的API保护
   - [ ] 实现基于权限的API保护

4. **管理界面**
   - [ ] 创建角色管理页面
   - [ ] 创建权限管理页面
   - [ ] 创建用户角色分配页面
   - [ ] 添加角色权限配置页面

**预定义角色**:
- `User`: 普通用户（默认）
- `Moderator`: 版主（管理用户内容）
- `Admin`: 管理员（完全访问权限）

**验收标准**:
- ✅ 可以创建和管理角色
- ✅ 可以为角色分配权限
- ✅ 可以为用户分配角色
- ✅ API端点根据角色/权限保护
- ✅ JWT包含用户角色信息

**估算工时**: 3-4天  
**依赖**: P0-数据持久化  
**风险**: 权限模型设计需要前期充分规划

---

### P1: 用户配置文件管理

**目标**: 允许用户管理个人资料

**功能清单**:
1. **配置文件数据模型**
   - [ ] 添加UserProfile表
   - [ ] 添加字段：DisplayName, Avatar, Bio, Location, Website
   - [ ] 添加隐私设置字段
   - [ ] 创建数据库迁移

2. **配置文件API**
   - [ ] 实现获取配置文件API
   - [ ] 实现更新配置文件API
   - [ ] 实现头像上传功能
   - [ ] 实现配置文件隐私设置

3. **用户界面**
   - [ ] 创建用户配置文件页面
   - [ ] 创建配置文件编辑页面
   - [ ] 实现头像上传组件
   - [ ] 添加配置文件预览

**验收标准**:
- ✅ 用户可以查看自己的配置文件
- ✅ 用户可以编辑配置文件信息
- ✅ 用户可以上传和更换头像
- ✅ 支持配置文件隐私设置
- ✅ 头像图片大小限制（< 2MB）

**估算工时**: 2-3天  
**依赖**: P0-数据持久化  
**风险**: 头像存储需要考虑存储方案（本地/云存储）

---

### P1: Token黑名单机制

**目标**: 实现Token撤销功能，支持强制登出

**功能清单**:
1. **黑名单存储**
   - [ ] 设计TokenBlacklist表（或使用Redis）
   - [ ] 实现黑名单存储服务
   - [ ] 实现Token过期清理机制
   - [ ] 配置黑名单存储策略

2. **Token撤销功能**
   - [ ] 实现登出时加入黑名单
   - [ ] 实现强制登出API（管理员功能）
   - [ ] 在JWT验证中检查黑名单
   - [ ] 实现全局登出（撤销所有Token）

3. **清理机制**
   - [ ] 实现定时任务清理过期Token
   - [ ] 优化黑名单查询性能
   - [ ] 监控黑名单大小

**验收标准**:
- ✅ 用户登出后Token立即失效
- ✅ 管理员可以强制用户登出
- ✅ 已撤销的Token无法访问受保护资源
- ✅ 黑名单查询性能 < 10ms
- ✅ 过期Token自动从黑名单清除

**估算工时**: 1-2天  
**依赖**: P0-数据持久化  
**风险**: 需要高性能的黑名单存储（推荐Redis）

---

### P1: 账户安全设置

**目标**: 提供账户安全相关的设置和功能

**功能清单**:
1. **密码管理**
   - [ ] 实现修改密码功能
   - [ ] 添加密码强度要求
   - [ ] 密码修改后强制重新登录
   - [ ] 密码历史记录（防止重复使用）

2. **会话管理**
   - [ ] 显示当前活跃会话列表
   - [ ] 显示会话设备信息（IP、浏览器、时间）
   - [ ] 支持撤销单个会话
   - [ ] 支持撤销所有其他会话

3. **登录历史**
   - [ ] 记录登录历史（时间、IP、设备、结果）
   - [ ] 显示最近登录记录
   - [ ] 标记异常登录
   - [ ] 提供登录通知选项

**验收标准**:
- ✅ 用户可以修改密码
- ✅ 可以查看活跃会话列表
- ✅ 可以撤销特定会话
- ✅ 可以查看登录历史
- ✅ 异常登录会发送通知

**估算工时**: 2-3天  
**依赖**: P0-数据持久化, P1-Token黑名单  
**风险**: 会话跟踪可能影响性能

---

## 低优先级功能

### P2: 社交登录（OAuth）

**目标**: 支持使用第三方账号登录

**功能清单**:
1. **OAuth集成**
   - [ ] 集成Google登录
   - [ ] 集成GitHub登录
   - [ ] 集成Microsoft登录
   - [ ] 集成Discord登录
   - [ ] 统一OAuth回调处理

2. **账户关联**
   - [ ] 实现账户关联逻辑
   - [ ] 支持多个OAuth账户关联
   - [ ] 支持解除账户关联
   - [ ] 主账户选择机制

3. **用户界面**
   - [ ] 登录页面添加OAuth按钮
   - [ ] 创建账户关联管理页面
   - [ ] 显示已关联的账户列表

**支持的OAuth提供商**:
- Google
- GitHub
- Microsoft
- Discord

**验收标准**:
- ✅ 可以使用OAuth提供商登录
- ✅ 首次OAuth登录自动创建账户
- ✅ 可以关联多个OAuth账户
- ✅ OAuth和密码登录可以共存

**估算工时**: 3-4天  
**依赖**: P0-数据持久化  
**风险**: 需要申请和配置OAuth应用

---

### P2: 多因素认证（MFA）

**目标**: 提供额外的安全层，使用TOTP或SMS验证

**功能清单**:
1. **TOTP实现**
   - [ ] 集成TOTP库（Google Authenticator兼容）
   - [ ] 生成TOTP密钥
   - [ ] 显示QR码供用户扫描
   - [ ] 实现TOTP验证
   - [ ] 提供备用恢复代码

2. **MFA流程**
   - [ ] 实现MFA启用流程
   - [ ] 实现MFA禁用流程
   - [ ] 登录时MFA验证
   - [ ] MFA恢复流程

3. **用户界面**
   - [ ] 创建MFA设置页面
   - [ ] 显示MFA状态
   - [ ] 登录时MFA验证页面
   - [ ] 备用码管理页面

**验收标准**:
- ✅ 用户可以启用/禁用MFA
- ✅ 支持标准TOTP应用
- ✅ 提供10个备用恢复代码
- ✅ MFA启用后登录需要验证码
- ✅ 备用码只能使用一次

**估算工时**: 2-3天  
**依赖**: P0-数据持久化  
**风险**: 用户丢失MFA设备需要恢复机制

---

### P2: 异常登录检测

**目标**: 检测并通知异常登录行为

**功能清单**:
1. **异常检测规则**
   - [ ] 检测新设备/新位置登录
   - [ ] 检测短时间内多次登录失败
   - [ ] 检测IP地址变化过快
   - [ ] 检测不可能的旅行（地理位置矛盾）
   - [ ] 可配置的检测规则

2. **通知机制**
   - [ ] 发送邮件通知
   - [ ] 应用内通知
   - [ ] 可选的SMS通知
   - [ ] 通知设置管理

3. **响应措施**
   - [ ] 标记异常会话
   - [ ] 可选的自动锁定账户
   - [ ] 要求额外验证
   - [ ] 提供快速撤销会话

**验收标准**:
- ✅ 检测到异常登录
- ✅ 发送通知给用户
- ✅ 误报率 < 5%
- ✅ 用户可以确认安全登录
- ✅ 支持白名单设备/IP

**估算工时**: 3-4天  
**依赖**: P0-数据持久化, P0-邮箱验证, P1-会话管理  
**风险**: 误报可能影响用户体验

---

### P2: 账户锁定机制

**目标**: 防止暴力破解攻击

**功能清单**:
1. **锁定规则**
   - [ ] 配置失败尝试阈值（如5次）
   - [ ] 配置锁定时间（如30分钟）
   - [ ] 实现自动锁定逻辑
   - [ ] 实现手动锁定（管理员功能）

2. **锁定管理**
   - [ ] 记录锁定历史
   - [ ] 实现解锁API
   - [ ] 自动解锁定时任务
   - [ ] 发送锁定通知

3. **用户界面**
   - [ ] 显示账户锁定状态
   - [ ] 提供解锁申请流程
   - [ ] 管理员解锁界面

**验收标准**:
- ✅ 连续失败登录导致锁定
- ✅ 锁定期间无法登录
- ✅ 锁定时间后自动解锁
- ✅ 管理员可以手动解锁
- ✅ 用户收到锁定通知

**估算工时**: 1-2天  
**依赖**: P0-数据持久化  
**风险**: 可能被用于拒绝服务攻击

---

## 技术债务与改进

### T1: 测试覆盖率提升

**目标**: 提高测试覆盖率到90%以上

**任务清单**:
- [ ] 为AuthController添加集成测试
- [ ] 为SignalR认证添加集成测试
- [ ] 添加负载测试
- [ ] 添加性能基准测试
- [ ] 配置代码覆盖率报告

**估算工时**: 1-2天

---

### T1: 日志和监控增强

**目标**: 改进日志记录和监控能力

**任务清单**:
- [ ] 统一日志格式（结构化日志）
- [ ] 添加关键指标监控（登录成功率、Token刷新率）
- [ ] 集成Application Insights或类似服务
- [ ] 配置告警规则
- [ ] 添加分布式追踪

**估算工时**: 2天

---

### T1: API文档完善

**目标**: 提供完整的API文档

**任务清单**:
- [ ] 完善Swagger注释
- [ ] 添加API使用示例
- [ ] 生成Postman集合
- [ ] 创建API版本管理策略
- [ ] 编写API迁移指南

**估算工时**: 1天

---

### T2: 配置管理改进

**目标**: 改进配置管理方式

**任务清单**:
- [ ] 支持Azure Key Vault
- [ ] 支持AWS Secrets Manager
- [ ] 实现配置热重载
- [ ] 添加配置验证
- [ ] 环境特定配置管理

**估算工时**: 1天

---

## 安全性增强

### S1: 安全审计

**任务清单**:
- [ ] 执行OWASP Top 10检查
- [ ] 执行渗透测试
- [ ] 代码安全审查
- [ ] 依赖项安全扫描
- [ ] 生成安全审计报告

**估算工时**: 2-3天

---

### S1: CSRF保护

**任务清单**:
- [ ] 实现CSRF Token生成
- [ ] 在API中验证CSRF Token
- [ ] 配置SameSite Cookie
- [ ] 添加CSRF测试

**估算工时**: 0.5天

---

### S1: 内容安全策略（CSP）

**任务清单**:
- [ ] 配置CSP头
- [ ] 配置XSS保护
- [ ] 配置X-Frame-Options
- [ ] 配置HSTS

**估算工时**: 0.5天

---

### S2: 速率限制

**任务清单**:
- [ ] 实现API速率限制
- [ ] 实现登录速率限制
- [ ] 配置限制策略
- [ ] 添加限制监控

**估算工时**: 1天

---

## 性能优化

### P1: 缓存策略

**任务清单**:
- [ ] 实现用户信息缓存（Redis）
- [ ] 实现Token黑名单缓存
- [ ] 配置缓存过期策略
- [ ] 监控缓存命中率

**估算工时**: 1-2天

---

### P1: 数据库优化

**任务清单**:
- [ ] 添加数据库索引
- [ ] 优化查询语句
- [ ] 实现连接池优化
- [ ] 添加数据库监控

**估算工时**: 1天

---

### P2: Token压缩

**任务清单**:
- [ ] 减少JWT Payload大小
- [ ] 使用短claim名称
- [ ] 考虑使用引用token

**估算工时**: 0.5天

---

## 优先级说明

- **P0 (高优先级)**: 生产环境必需功能，应尽快实现
- **P1 (中优先级)**: 重要功能，提升系统可用性和安全性
- **P2 (低优先级)**: 增强功能，改善用户体验
- **T (技术债务)**: 技术改进，提升代码质量和可维护性
- **S (安全性)**: 安全增强，降低安全风险

---

## 实施建议

### 第一阶段（1-2周）
重点实现P0级别功能，确保系统可以在生产环境部署：
1. 数据持久化
2. 密码重置
3. 邮箱验证

### 第二阶段（2-3周）
实现P1级别功能，提升系统安全性和用户体验：
1. 角色和权限管理
2. Token黑名单
3. 用户配置文件管理
4. 账户安全设置

### 第三阶段（3-4周）
实现P2级别功能和技术改进：
1. 社交登录
2. 多因素认证
3. 异常登录检测
4. 性能优化

### 第四阶段（持续）
持续改进和维护：
1. 安全审计
2. 性能监控
3. 用户反馈收集
4. 功能迭代

---

## 总结

当前JWT用户系统已经实现了核心的认证功能，可以支持开发和测试环境使用。但要投入生产环境使用，还需要实现：

**必须实现（P0）**:
- 数据持久化
- 密码重置
- 邮箱验证

**强烈推荐（P1）**:
- 角色权限管理
- Token黑名单
- 账户安全设置

**可选增强（P2）**:
- 社交登录
- 多因素认证
- 异常检测

建议根据项目实际需求和时间表，按照优先级逐步实现这些功能。

---

**文档状态**: ✅ 完成  
**最后更新**: 2025年10月24日  
**作者**: GitHub Copilot

---

## 附录：功能估算总览

| 功能 | 优先级 | 估算工时 | 依赖 |
|------|--------|----------|------|
| 数据持久化 | P0 | 2-3天 | 无 |
| 密码重置 | P0 | 2天 | 数据持久化 |
| 邮箱验证 | P0 | 1.5天 | 数据持久化 |
| 角色权限管理 | P1 | 3-4天 | 数据持久化 |
| 用户配置文件 | P1 | 2-3天 | 数据持久化 |
| Token黑名单 | P1 | 1-2天 | 数据持久化 |
| 账户安全设置 | P1 | 2-3天 | 数据持久化 |
| 社交登录 | P2 | 3-4天 | 数据持久化 |
| 多因素认证 | P2 | 2-3天 | 数据持久化 |
| 异常登录检测 | P2 | 3-4天 | 多个依赖 |
| 账户锁定 | P2 | 1-2天 | 数据持久化 |

**总估算工时**: 约23-35天（约4-7周）

**注意**: 这些是乐观估算，实际开发时间可能会更长，建议预留20-30%的缓冲时间。
