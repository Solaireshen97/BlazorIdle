# JWT 用户系统文档

欢迎查阅 BlazorIdle 项目的JWT用户认证系统设计方案。

---

## 📚 文档概览

本目录包含JWT用户系统的完整设计和实施文档：

| 文档 | 说明 | 阅读时间 | 优先级 |
|------|------|----------|--------|
| [JWT用户系统设计方案.md](./JWT用户系统设计方案.md) | **核心设计文档** - 架构、技术选型、组件设计、安全性 | 60分钟 | ⭐⭐⭐ |
| [JWT用户系统实施指南.md](./JWT用户系统实施指南.md) | **实施手册** - 分步实施指导、详细代码示例 | 90分钟 | ⭐⭐⭐ |

---

## 🎯 背景与需求

### 当前状况

- ✅ **SignalR基础架构已完成**（阶段一，2025-10-23）
  - GameHub统一Hub实现
  - ConnectionManager连接管理
  - SignalRDispatcher消息分发
  - 客户端SignalRConnectionManager

- ⚠️ **存在问题**：
  - GameHub使用`ClaimTypes.NameIdentifier`验证用户身份
  - 但JWT认证系统尚未实现
  - 无法进行SignalR连接测试

- 🎯 **解决方案**：
  - 实现轻量级JWT用户认证系统
  - 支持SignalR连接测试
  - 为后续功能开发奠定基础

### 核心需求

1. **轻量级实现**: 不需要完整的用户管理系统，只需支持SignalR测试
2. **内存存储**: 无需数据库持久化，服务重启后数据清空
3. **测试账户**: 预设测试账户，方便开发调试
4. **JWT标准**: 使用标准JWT实现，便于后续扩展
5. **无缝集成**: 与现有SignalR架构完全兼容

---

## 🚀 快速开始

### 推荐阅读顺序

1. **首先阅读** [JWT用户系统设计方案.md](./JWT用户系统设计方案.md)
   - 了解整体设计思路
   - 理解技术选型和架构
   - 掌握核心组件设计
   - 熟悉安全性设计

2. **然后阅读** [JWT用户系统实施指南.md](./JWT用户系统实施指南.md)
   - 按步骤实施服务端
   - 按步骤实施客户端
   - 集成SignalR认证
   - 测试和验证

### 快速导航

**如果你想...**

- 📖 **了解整体设计** → 阅读 [设计方案](./JWT用户系统设计方案.md) 的"系统架构"章节
- 🛠️ **开始实施** → 阅读 [实施指南](./JWT用户系统实施指南.md) 的"阶段一"
- 🔒 **了解安全性** → 阅读 [设计方案](./JWT用户系统设计方案.md) 的"安全性设计"章节
- 🐛 **解决问题** → 查看两个文档的"故障排查"章节
- 📋 **查看API** → 阅读 [设计方案](./JWT用户系统设计方案.md) 的"API接口设计"章节

---

## 🏗️ 系统架构概览

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│  Blazor WebAssembly Client                                  │
│                                                              │
│  ┌────────────┐     ┌──────────────────┐                   │
│  │ Login Page │ ──> │ AuthService      │                   │
│  └────────────┘     └──────────────────┘                   │
│                              │                               │
│                              ▼                               │
│                     LocalStorage (JWT Token)                │
│                              │                               │
│                              ▼                               │
│              SignalRConnectionManager                       │
│              (附加Token到连接)                               │
│                                                              │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTPS + Bearer Token
┌────────────────────▼────────────────────────────────────────┐
│  ASP.NET Core Server                                        │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  JWT Authentication Middleware                        │  │
│  │  - Token验证                                          │  │
│  │  - Claims提取                                         │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                   │
│         ┌────────────────┼────────────────┐                 │
│         ▼                ▼                ▼                 │
│  ┌───────────┐   ┌─────────────┐   ┌──────────┐           │
│  │ GameHub   │   │ AuthAPI     │   │ 其他API  │           │
│  │ (SignalR) │   │ (登录/注册) │   │          │           │
│  └───────────┘   └─────────────┘   └──────────┘           │
│         │                │                                   │
│         │                ▼                                   │
│         │        ┌─────────────────┐                        │
│         │        │  AuthService    │                        │
│         │        │  (Token生成)    │                        │
│         │        └─────────────────┘                        │
│         │                │                                   │
│         └────────────────┼───────────────┐                  │
│                          ▼               │                  │
│                  ┌──────────────┐        │                  │
│                  │  UserStore   │        │                  │
│                  │  (内存存储)  │        │                  │
│                  └──────────────┘        │                  │
│                                           ▼                  │
│                                   Context.User.Claims       │
│                                   (用户身份)                 │
└──────────────────────────────────────────────────────────────┘
```

### 核心组件

1. **UserStore** (服务端)
   - 内存用户存储（ConcurrentDictionary）
   - 预设3个测试账户（test1、test2、admin）
   - 密码BCrypt哈希
   - 刷新令牌管理

2. **AuthService** (服务端)
   - JWT令牌生成（HMAC-SHA256）
   - 令牌验证
   - 登录/注册逻辑
   - 刷新令牌逻辑

3. **AuthController** (服务端)
   - POST /api/auth/login（登录）
   - POST /api/auth/register（注册）
   - POST /api/auth/refresh（刷新令牌）
   - GET /api/auth/me（获取当前用户）

4. **AuthenticationService** (客户端)
   - Token存储（LocalStorage）
   - HTTP请求拦截（自动附加Token）
   - 登录/登出逻辑

5. **JWT Authentication Middleware** (服务端)
   - 自动验证Bearer Token
   - 提取Claims到Context.User
   - SignalR连接认证支持

---

## 📋 实施路线图

### 3个阶段，10个步骤

```
阶段一：服务端基础实施 (2-3天)
├─ 步骤1: 安装依赖和配置 (0.5天)
├─ 步骤2: 实现UserStore (0.5天)
├─ 步骤3: 实现AuthService (1天)
├─ 步骤4: 实现AuthController (0.5天)
└─ 步骤5: 配置JWT认证中间件 (0.5天)

阶段二：客户端实施 (1-2天)
├─ 步骤6: 安装客户端依赖 (0.5天)
├─ 步骤7: 实现AuthenticationService (1天)
└─ 步骤8: 创建登录页面 (0.5天)

阶段三：SignalR集成 (0.5-1天)
├─ 步骤9: 修改SignalR连接管理 (0.5天)
└─ 步骤10: 端到端测试 (0.5天)

总计：3.5-6天（约1周）
```

---

## 🔑 测试账户

系统预设3个测试账户：

| 用户名 | 密码 | 说明 |
|--------|------|------|
| test1 | password123 | 普通测试账户1 |
| test2 | password123 | 普通测试账户2 |
| admin | admin123 | 管理员测试账户 |

**注意**：这些账户仅用于开发测试，数据存储在内存中，服务重启后会重新初始化。

---

## 🔒 安全性说明

### 已实现的安全措施

- ✅ **密码哈希**: 使用BCrypt（工作因子12）
- ✅ **JWT签名**: 使用HMAC-SHA256
- ✅ **HTTPS**: 强制启用HTTPS
- ✅ **Token过期**: 访问令牌60分钟，刷新令牌7天
- ✅ **CORS限制**: 仅允许指定来源
- ✅ **输入验证**: 使用DataAnnotations验证

### 生产环境建议

1. **密钥管理**：
   - 使用环境变量或密钥管理服务存储JWT密钥
   - 不要在代码或配置文件中硬编码密钥

2. **数据持久化**：
   - 使用数据库存储用户数据
   - 实现密码重置和邮件验证

3. **高级安全**：
   - 实现令牌黑名单
   - 添加多因素认证（MFA）
   - 实现异常登录检测

---

## 📊 API接口速查

### 登录

```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "test1",
  "password": "password123"
}
```

**响应**:
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "...",
  "expiresAt": "2025-10-23T14:30:00Z",
  "user": {
    "id": "user_123",
    "username": "test1",
    "createdAt": "2025-10-23T06:00:00Z"
  }
}
```

### 获取当前用户

```http
GET /api/auth/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**响应**:
```json
{
  "id": "user_123",
  "username": "test1",
  "createdAt": "2025-10-23T06:00:00Z"
}
```

---

## ✅ 验收标准

### 功能性验收

- ✅ 用户可以使用测试账户登录
- ✅ 登录后获得有效JWT令牌
- ✅ Token自动附加到HTTP请求
- ✅ Token自动附加到SignalR连接
- ✅ GameHub正确识别用户身份
- ✅ Token过期后自动拒绝
- ✅ 令牌刷新机制正常工作

### 性能验收

- ✅ 登录响应时间 < 100ms
- ✅ Token验证时间 < 10ms
- ✅ SignalR连接建立时间 < 1秒

### 安全性验收

- ✅ 密码使用BCrypt哈希
- ✅ JWT使用HMAC-SHA256签名
- ✅ HTTPS强制启用
- ✅ 未授权请求返回401

---

## 🔧 故障排查

### 常见问题速查

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| SignalR连接401 | Token未附加或无效 | 检查客户端Token获取逻辑 |
| 登录失败 | 用户名或密码错误 | 使用测试账户重试 |
| Token过期 | 令牌已过期 | 使用刷新令牌获取新Token |
| 编译错误 | 依赖包缺失 | 重新安装NuGet包 |

详细故障排查请参考文档的"故障排查"章节。

---

## 📚 相关文档

### BlazorIdle项目文档

- [SignalR实施计划-分步指南](../SignalR/SignalR实施计划-分步指南.md)
- [SignalR统一管理系统-总体架构](../SignalR/SignalR统一管理系统-总体架构.md)
- [SignalR README](../SignalR/README.md)

### 外部参考

- [JWT官方网站](https://jwt.io/)
- [ASP.NET Core身份认证](https://docs.microsoft.com/aspnet/core/security/authentication/)
- [BCrypt.Net-Next文档](https://github.com/BcryptNet/bcrypt.net)

---

## 🎯 下一步

1. ✅ 阅读 [JWT用户系统设计方案.md](./JWT用户系统设计方案.md)
2. 🚀 按照 [JWT用户系统实施指南.md](./JWT用户系统实施指南.md) 开始实施
3. ✅ 测试和验证用户系统
4. 🎉 继续SignalR阶段二（战斗系统集成）

---

## 📝 文档历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| 1.0 | 2025-10-23 | 初始版本，完整的设计和实施文档 |

---

**文档状态**: ✅ 完成  
**最后更新**: 2025年10月23日  
**作者**: GitHub Copilot

---

**🎉 开始使用JWT用户系统！**

推荐从 [JWT用户系统设计方案.md](./JWT用户系统设计方案.md) 开始阅读。
