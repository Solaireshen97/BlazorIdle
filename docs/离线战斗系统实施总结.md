# ç¦»çº¿æˆ˜æ–—ç³»ç»Ÿå®æ–½æ€»ç»“ï¼ˆç®€åŒ–ç‰ˆï¼‰

## ğŸ“Œ æ ¸å¿ƒéœ€æ±‚

å®ç°ç¦»çº¿æˆ˜æ–—æ”¶ç›Šï¼šç”¨æˆ·ä¸‹çº¿åï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®—ç¦»çº¿æœŸé—´çš„æˆ˜æ–—æ”¶ç›Šï¼Œä¸Šçº¿æ—¶å±•ç¤ºå¹¶å‘æ”¾ã€‚

---

## âœ… å·²æœ‰ç»„ä»¶ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰

1. **ActivityPlanæ¨¡å‹** - æ´»åŠ¨è®¡åˆ’å®ä½“ï¼Œå·²å®Œæ•´å®ç°
2. **ActivityPlanService** - æ´»åŠ¨è®¡åˆ’æœåŠ¡ï¼Œæ”¯æŒåˆ›å»ºã€å¯åŠ¨ã€åœæ­¢
3. **BattleSimulator** - æˆ˜æ–—æ¨¡æ‹Ÿå™¨ï¼Œæ”¯æŒå¿«è¿›åŠŸèƒ½
4. **OfflineSettlementServiceï¼ˆåŸºç¡€ç‰ˆï¼‰** - å·²æœ‰ç¦»çº¿æ¨¡æ‹Ÿä»£ç 
5. **Characterå®ä½“** - å·²åŒ…å«`LastSeenAtUtc`å’Œ`LastOfflineSettledAtUtc`å­—æ®µ

---

## âŒ ç¼ºå¤±ç»„ä»¶ï¼ˆéœ€è¦å®ç°ï¼‰

### åç«¯ç¼ºå¤±

1. **OfflineFastForwardEngine** - ä¸“ç”¨ç¦»çº¿å¿«è¿›å¼•æ“
   - å¤ç”¨BattleSimulator
   - å¤„ç†æ´»åŠ¨è®¡åˆ’é™åˆ¶ï¼ˆDuration/Infiniteï¼‰
   - æ›´æ–°è®¡åˆ’æ‰§è¡ŒçŠ¶æ€

2. **è‡ªåŠ¨ç¦»çº¿æ£€æµ‹** - ç™»å½•æ—¶è‡ªåŠ¨è§¦å‘ç¦»çº¿ç»“ç®—
   - æ£€æŸ¥`LastSeenAtUtc`è®¡ç®—ç¦»çº¿æ—¶é•¿
   - è°ƒç”¨å¿«è¿›å¼•æ“æ¨¡æ‹Ÿ
   - æ›´æ–°è®¡åˆ’çŠ¶æ€
   - è‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªè®¡åˆ’ï¼ˆå¦‚æœå½“å‰è®¡åˆ’å®Œæˆï¼‰

3. **æ–°å¢APIç«¯ç‚¹**
   - `GET /api/offline/check` - æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
   - `POST /api/offline/apply` - åº”ç”¨ç¦»çº¿ç»“ç®—å¹¶å‘æ”¾
   - `POST /api/characters/{id}/heartbeat` - æ›´æ–°åœ¨çº¿å¿ƒè·³

### å‰ç«¯ç¼ºå¤±

1. **ç¦»çº¿ç»“ç®—å¼¹çª—ç»„ä»¶** - å±•ç¤ºç¦»çº¿æ”¶ç›Šè¯¦æƒ…
2. **ApiClientæ‰©å±•** - è°ƒç”¨ç¦»çº¿ç›¸å…³API
3. **Charactersé¡µé¢é›†æˆ** - åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¦»çº¿æ”¶ç›Š

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Step 1: åˆ›å»ºOfflineFastForwardEngine

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Battles/Offline/OfflineFastForwardEngine.cs`

**æ ¸å¿ƒé€»è¾‘**:
```
è¾“å…¥: Character, ActivityPlan, OfflineSeconds
å¤„ç†:
  1. è®¡ç®—å®é™…æ¨¡æ‹Ÿæ—¶é•¿ = Min(ç¦»çº¿æ—¶é•¿, 12å°æ—¶ä¸Šé™)
  2. è®¡ç®—è®¡åˆ’å‰©ä½™æ—¶é•¿:
     - å¦‚æœæ˜¯Durationç±»å‹: å‰©ä½™ = LimitValue - ExecutedSeconds
     - å¦‚æœæ˜¯Infiniteç±»å‹: å‰©ä½™ = å…¨éƒ¨ç¦»çº¿æ—¶é•¿
  3. ä½¿ç”¨BattleSimulatorå¿«è¿›æ¨¡æ‹Ÿ
  4. æ›´æ–°è®¡åˆ’çš„ExecutedSeconds
  5. åˆ¤æ–­è®¡åˆ’æ˜¯å¦å®Œæˆ
è¾“å‡º: OfflineFastForwardResult (æ”¶ç›Šã€çŠ¶æ€ã€æ®µæ•°æ®)
```

---

### Step 2: æ‰©å±•OfflineSettlementService

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Battles/Offline/Offline.cs`

**æ–°å¢æ–¹æ³•**: `CheckAndSettleAsync(characterId)`

**æ ¸å¿ƒé€»è¾‘**:
```
1. è·å–è§’è‰²ï¼Œè®¡ç®—ç¦»çº¿æ—¶é•¿ = Now - LastSeenAtUtc
2. å¦‚æœç¦»çº¿æ—¶é•¿ <= 0ï¼Œç›´æ¥è¿”å›ï¼ˆæ— ç¦»çº¿ï¼‰
3. æŸ¥æ‰¾ç¦»çº¿æ—¶æ­£åœ¨è¿è¡Œçš„ActivityPlan
4. å¦‚æœæœ‰è¿è¡Œè®¡åˆ’ï¼š
   - è°ƒç”¨OfflineFastForwardEngine.FastForward()
   - æ›´æ–°è®¡åˆ’ExecutedSecondså’ŒçŠ¶æ€
   - å¦‚æœè®¡åˆ’å®Œæˆï¼Œæ ‡è®°ä¸ºCompleted
   - å¦‚æœè®¡åˆ’å®Œæˆï¼Œå°è¯•å¯åŠ¨ä¸‹ä¸€ä¸ªPendingè®¡åˆ’
5. æ›´æ–°LastSeenAtUtc = Now
6. è¿”å›ç¦»çº¿ç»“ç®—ç»“æœï¼ˆä½†ä¸ç«‹å³å‘æ”¾æ”¶ç›Šï¼‰
```

**æ–°å¢æ–¹æ³•**: `ApplySettlementAsync(characterId, settlement)`

**æ ¸å¿ƒé€»è¾‘**:
```
1. è·å–è§’è‰²
2. æ›´æ–°è§’è‰²Gold += settlement.Gold
3. æ›´æ–°è§’è‰²Experience += settlement.Exp
4. å‘æ”¾ç‰©å“åˆ°èƒŒåŒ…ï¼ˆå¦‚æœæœ‰ï¼‰
5. ä¿å­˜è§’è‰²æ•°æ®
```

---

### Step 3: æ·»åŠ APIç«¯ç‚¹

**æ–‡ä»¶**: `BlazorIdle.Server/Api/OfflineController.cs`

**æ–°å¢ç«¯ç‚¹1**: `GET /api/offline/check?characterId={id}`
- è°ƒç”¨`OfflineSettlementService.CheckAndSettleAsync()`
- è¿”å›`OfflineCheckResult`ï¼ˆåŒ…å«ç¦»çº¿æ—¶é•¿ã€æ”¶ç›Šé¢„è§ˆã€è®¡åˆ’çŠ¶æ€ï¼‰

**æ–°å¢ç«¯ç‚¹2**: `POST /api/offline/apply`
- æ¥æ”¶`{ characterId, settlement }`
- è°ƒç”¨`OfflineSettlementService.ApplySettlementAsync()`
- å®é™…å‘æ”¾é‡‘å¸ã€ç»éªŒã€ç‰©å“

**æ–‡ä»¶**: `BlazorIdle.Server/Api/CharactersController.cs`

**æ–°å¢ç«¯ç‚¹3**: `POST /api/characters/{id}/heartbeat`
- æ›´æ–°`character.LastSeenAtUtc = DateTime.UtcNow`
- ç”¨äºè®°å½•ç©å®¶åœ¨çº¿æ—¶é—´

---

### Step 4: å‰ç«¯é›†æˆ

#### 4.1 æ‰©å±•ApiClient

**æ–‡ä»¶**: `BlazorIdle/Services/ApiClient.cs`

**æ–°å¢æ–¹æ³•**:
```csharp
// æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
public Task<OfflineCheckResult?> CheckOfflineAsync(Guid characterId)

// åº”ç”¨ç¦»çº¿ç»“ç®—
public Task ApplyOfflineSettlementAsync(Guid characterId, OfflineFastForwardResult settlement)

// æ›´æ–°å¿ƒè·³
public Task UpdateHeartbeatAsync(Guid characterId)
```

---

#### 4.2 åˆ›å»ºç¦»çº¿ç»“ç®—å¼¹çª—

**æ–‡ä»¶**: `BlazorIdle/Components/OfflineSettlementDialog.razor`

**åŠŸèƒ½**:
- æ˜¾ç¤º"æ¬¢è¿å›æ¥ï¼ç¦»çº¿Xå°æ—¶Yåˆ†é’Ÿ"
- å±•ç¤ºæ”¶ç›Šï¼šé‡‘å¸+XXXï¼Œç»éªŒ+XXXï¼Œå‡»æ€XXX
- å±•ç¤ºæ‰è½ç‰©å“åˆ—è¡¨
- "ç¡®è®¤é¢†å–"æŒ‰é’®
- å¦‚æœè®¡åˆ’å®Œæˆä¸”å¯åŠ¨äº†ä¸‹ä¸€ä¸ªï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯

---

#### 4.3 ä¿®æ”¹Charactersé¡µé¢

**æ–‡ä»¶**: `BlazorIdle/Pages/Characters.razor`

**ä¿®æ”¹OnInitializedAsync**:
```csharp
protected override async Task OnInitializedAsync()
{
    // åŸæœ‰åŠ è½½é€»è¾‘...
    
    // å¦‚æœæœ‰é€‰ä¸­è§’è‰²
    if (selectedCharacter != null)
    {
        // 1. æ›´æ–°å¿ƒè·³
        await apiClient.UpdateHeartbeatAsync(selectedCharacter.Id);
        
        // 2. æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
        var offlineResult = await apiClient.CheckOfflineAsync(selectedCharacter.Id);
        
        // 3. å¦‚æœæœ‰ç¦»çº¿æ”¶ç›Šï¼Œæ˜¾ç¤ºå¼¹çª—
        if (offlineResult?.HasOfflineTime == true)
        {
            showOfflineDialog = true;
            offlineCheckResult = offlineResult;
        }
    }
}
```

**æ–°å¢æ–¹æ³•**:
```csharp
private async Task ApplyOfflineSettlement()
{
    // è°ƒç”¨APIåº”ç”¨ç¦»çº¿ç»“ç®—
    await apiClient.ApplyOfflineSettlementAsync(
        selectedCharacter.Id, 
        offlineCheckResult.Settlement
    );
    
    // åˆ·æ–°è§’è‰²æ•°æ®
    await RefreshCharacterAsync();
    
    // å…³é—­å¼¹çª—
    showOfflineDialog = false;
}
```

---

## ğŸ”„ å®Œæ•´æµç¨‹ç¤ºä¾‹

### åœºæ™¯1: ç”¨æˆ·ä¸‹çº¿1å°æ—¶ï¼Œè®¡åˆ’æœªå®Œæˆ

**åˆå§‹çŠ¶æ€**:
- è§’è‰²åœ¨çº¿ï¼Œæœ‰ä¸€ä¸ª3å°æ—¶æˆ˜æ–—è®¡åˆ’æ­£åœ¨è¿è¡Œ
- å·²æ‰§è¡Œ0.5å°æ—¶ï¼ˆExecutedSeconds=1800ï¼‰
- LastSeenAtUtc = 2025-01-07 10:00:00

**ç”¨æˆ·ä¸‹çº¿**:
- ç”¨æˆ·å…³é—­æµè§ˆå™¨ï¼ŒLastSeenAtUtcä¿æŒä¸å˜

**1å°æ—¶åç”¨æˆ·ä¸Šçº¿**:
- å‰ç«¯åŠ è½½ï¼Œè°ƒç”¨`GET /api/offline/check?characterId=xxx`

**åç«¯å¤„ç†**:
```
1. è®¡ç®—ç¦»çº¿æ—¶é•¿ = Now(11:00) - LastSeen(10:00) = 3600ç§’
2. æŸ¥æ‰¾è¿è¡Œè®¡åˆ’ï¼Œæ‰¾åˆ°3å°æ—¶æˆ˜æ–—è®¡åˆ’
3. è®¡ç®—å‰©ä½™æ—¶é•¿:
   - LimitValue = 10800ç§’ï¼ˆ3å°æ—¶ï¼‰
   - ExecutedSeconds = 1800ç§’
   - å‰©ä½™ = 10800 - 1800 = 9000ç§’
   - å®é™…æ¨¡æ‹Ÿ = Min(3600, 9000) = 3600ç§’
4. å¿«è¿›æ¨¡æ‹Ÿ3600ç§’æˆ˜æ–—
5. æ›´æ–°ExecutedSeconds = 1800 + 3600 = 5400ç§’
6. åˆ¤æ–­æ˜¯å¦å®Œæˆ: 5400 < 10800ï¼Œæœªå®Œæˆ
7. è®¡ç®—æ”¶ç›Š: Gold=+2000, Exp=+3000
8. è¿”å›ç»“æœ
```

**å‰ç«¯å±•ç¤º**:
```
å¼¹çª—æ˜¾ç¤º:
  ç¦»çº¿æ—¶é•¿: 1å°æ—¶0åˆ†é’Ÿ
  é‡‘å¸: +2000
  ç»éªŒ: +3000
  å‡»æ€: 60
  [ç¡®è®¤é¢†å–]æŒ‰é’®
```

**ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤é¢†å–"**:
- å‰ç«¯è°ƒç”¨`POST /api/offline/apply`
- åç«¯æ›´æ–°è§’è‰²Goldã€Experience
- æˆ˜æ–—è®¡åˆ’ç»§ç»­è¿è¡Œï¼ˆå‰©ä½™1.5å°æ—¶ï¼‰

---

### åœºæ™¯2: ç”¨æˆ·ä¸‹çº¿3å°æ—¶ï¼Œè®¡åˆ’å®Œæˆå¹¶å¯åŠ¨ä¸‹ä¸€ä¸ª

**åˆå§‹çŠ¶æ€**:
- è§’è‰²æœ‰ä¸¤ä¸ªè®¡åˆ’:
  - Plan1: 2å°æ—¶æˆ˜æ–—ï¼ˆRunningï¼Œå·²æ‰§è¡Œ0å°æ—¶ï¼‰
  - Plan2: 1å°æ—¶æˆ˜æ–—ï¼ˆPendingï¼‰
- LastSeenAtUtc = 2025-01-07 10:00:00

**3å°æ—¶åç”¨æˆ·ä¸Šçº¿**:

**åç«¯å¤„ç†**:
```
1. è®¡ç®—ç¦»çº¿æ—¶é•¿ = 10800ç§’ï¼ˆ3å°æ—¶ï¼‰
2. æŸ¥æ‰¾è¿è¡Œè®¡åˆ’ï¼Œæ‰¾åˆ°Plan1
3. è®¡ç®—å‰©ä½™æ—¶é•¿:
   - LimitValue = 7200ç§’
   - ExecutedSeconds = 0
   - å‰©ä½™ = 7200ç§’
   - å®é™…æ¨¡æ‹Ÿ = Min(10800, 7200) = 7200ç§’
4. å¿«è¿›æ¨¡æ‹Ÿ7200ç§’
5. æ›´æ–°Plan1:
   - ExecutedSeconds = 7200
   - State = Completed
   - CompletedAt = Now
6. è®¡ç®—æ”¶ç›Š: Gold=+5000, Exp=+8000
7. æŸ¥æ‰¾ä¸‹ä¸€ä¸ªPendingè®¡åˆ’ï¼Œæ‰¾åˆ°Plan2
8. è‡ªåŠ¨å¯åŠ¨Plan2
9. è¿”å›ç»“æœï¼ˆåŒ…å«NextPlanStarted=trueï¼‰
```

**å‰ç«¯å±•ç¤º**:
```
å¼¹çª—æ˜¾ç¤º:
  ç¦»çº¿æ—¶é•¿: 3å°æ—¶0åˆ†é’Ÿï¼ˆå®é™…è®¡ç®—2å°æ—¶ï¼‰
  é‡‘å¸: +5000
  ç»éªŒ: +8000
  å‡»æ€: 120
  
  æç¤º: "æ´»åŠ¨è®¡åˆ’å·²å®Œæˆï¼Œå·²è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€ä¸ªè®¡åˆ’"
  
  [ç¡®è®¤é¢†å–]æŒ‰é’®
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### OfflineFastForwardResult
```csharp
{
    CharacterId: Guid,
    PlanId: Guid,
    SimulatedSeconds: double,      // å®é™…æ¨¡æ‹Ÿæ—¶é•¿
    PlanCompleted: bool,            // è®¡åˆ’æ˜¯å¦å®Œæˆ
    TotalDamage: long,
    TotalKills: int,
    Gold: long,                     // é‡‘å¸æ”¶ç›Š
    Exp: long,                      // ç»éªŒæ”¶ç›Š
    Loot: Dictionary<string, double>,  // ç‰©å“æ‰è½
    UpdatedExecutedSeconds: double  // æ›´æ–°åçš„å·²æ‰§è¡Œæ—¶é•¿
}
```

### OfflineCheckResult
```csharp
{
    HasOfflineTime: bool,           // æ˜¯å¦æœ‰ç¦»çº¿æ—¶é—´
    OfflineSeconds: double,         // ç¦»çº¿æ€»æ—¶é•¿
    HasRunningPlan: bool,           // ç¦»çº¿æ—¶æ˜¯å¦æœ‰è¿è¡Œè®¡åˆ’
    Settlement: OfflineFastForwardResult?,  // ç»“ç®—ç»“æœ
    PlanCompleted: bool,            // è®¡åˆ’æ˜¯å¦å®Œæˆ
    NextPlanStarted: bool,          // æ˜¯å¦å¯åŠ¨äº†ä¸‹ä¸€ä¸ªè®¡åˆ’
    NextPlanId: Guid?               // ä¸‹ä¸€ä¸ªè®¡åˆ’ID
}
```

---

## âš™ï¸ é…ç½®é¡¹ï¼ˆappsettings.jsonï¼‰

```json
{
  "Offline": {
    "MaxOfflineSeconds": 43200,     // 12å°æ—¶ä¸Šé™
    "EnableAutoSettlement": true,   // æ˜¯å¦è‡ªåŠ¨ç»“ç®—
    "RequireManualConfirm": true    // æ˜¯å¦éœ€è¦å‰ç«¯ç¡®è®¤æ‰å‘æ”¾
  }
}
```

---

## ğŸ§ª æµ‹è¯•è¦ç‚¹

### åç«¯å•å…ƒæµ‹è¯•
1. OfflineFastForwardEngine:
   - æµ‹è¯•ç¦»çº¿æ—¶é•¿ä¸Šé™ï¼ˆè¶…è¿‡12å°æ—¶åªè®¡ç®—12å°æ—¶ï¼‰
   - æµ‹è¯•Durationè®¡åˆ’å‰©ä½™æ—¶é•¿è®¡ç®—
   - æµ‹è¯•Infiniteè®¡åˆ’æ¨¡æ‹Ÿå…¨éƒ¨ç¦»çº¿æ—¶é•¿
   - æµ‹è¯•è®¡åˆ’å®ŒæˆçŠ¶æ€åˆ¤æ–­

2. OfflineSettlementService:
   - æµ‹è¯•æ— ç¦»çº¿æ—¶é—´åœºæ™¯
   - æµ‹è¯•æœ‰ç¦»çº¿æ— è®¡åˆ’åœºæ™¯
   - æµ‹è¯•è®¡åˆ’å®Œæˆè‡ªåŠ¨è¡”æ¥

### å‰ç«¯é›†æˆæµ‹è¯•
1. åˆ›å»ºè§’è‰²å’Œè®¡åˆ’
2. æ¨¡æ‹Ÿä¸‹çº¿ï¼ˆä¿®æ”¹æ•°æ®åº“LastSeenAtUtcï¼‰
3. é‡æ–°ç™»å½•
4. éªŒè¯å¼¹çª—æ˜¾ç¤ºæ­£ç¡®
5. ç‚¹å‡»é¢†å–ï¼ŒéªŒè¯æ•°æ®æ›´æ–°

---

## â±ï¸ é¢„ä¼°å·¥ä½œé‡

| ä»»åŠ¡ | æ—¶é—´ |
|------|------|
| OfflineFastForwardEngineå®ç° | 0.5å¤© |
| OfflineSettlementServiceæ‰©å±• | 0.5å¤© |
| APIç«¯ç‚¹æ·»åŠ  | 0.5å¤© |
| å‰ç«¯ApiClientæ‰©å±• | 0.5å¤© |
| ç¦»çº¿ç»“ç®—å¼¹çª—ç»„ä»¶ | 1å¤© |
| Charactersé¡µé¢é›†æˆ | 0.5å¤© |
| å•å…ƒæµ‹è¯• | 1å¤© |
| é›†æˆæµ‹è¯•ä¸è°ƒä¼˜ | 1å¤© |
| **æ€»è®¡** | **5-6å¤©** |

---

## ğŸ¯ ä¼˜å…ˆçº§

### å¿…é¡»å®ç°ï¼ˆPhase 1ï¼‰
1. âœ… OfflineFastForwardEngine
2. âœ… OfflineSettlementService.CheckAndSettleAsync
3. âœ… APIç«¯ç‚¹ï¼ˆcheckã€applyï¼‰
4. âœ… å‰ç«¯å¼¹çª—ç»„ä»¶
5. âœ… Charactersé¡µé¢é›†æˆ

### æ¨èå®ç°ï¼ˆPhase 2ï¼‰
6. âœ… å¿ƒè·³æœºåˆ¶
7. âœ… è‡ªåŠ¨è¡”æ¥å®Œå–„
8. âœ… é…ç½®é¡¹

### å¯é€‰å®ç°ï¼ˆPhase 3ï¼‰
9. â­• ç¦»çº¿ç»“ç®—å†å²è®°å½•è¡¨
10. â­• æ”¶ç›Šè¡°å‡æœºåˆ¶

---

**æ–‡æ¡£ç»“æŸ**
