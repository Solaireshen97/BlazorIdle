# æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿæ¶æ„å›¾

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025-10-14  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…ç½®æ–‡ä»¶å±‚      â”‚      â”‚   æœåŠ¡å±‚         â”‚      â”‚   æˆ˜æ–—é€»è¾‘å±‚     â”‚
â”‚                  â”‚      â”‚                  â”‚      â”‚                  â”‚
â”‚  appsettings     â”‚â”€â”€â”€â”€â”€â–¶â”‚ BattleMessage    â”‚â—€â”€â”€â”€â”€â”€â”‚  BattleEngine    â”‚
â”‚  .json           â”‚      â”‚ Formatter        â”‚      â”‚                  â”‚
â”‚                  â”‚      â”‚                  â”‚      â”‚  AttackTickEvent â”‚
â”‚  BattleMessages  â”‚      â”‚                  â”‚      â”‚  DamageCalculatorâ”‚
â”‚  {                      â”‚                  â”‚      â”‚  EnemyAttackEventâ”‚
â”‚   templates...   â”‚      â”‚                  â”‚      â”‚                  â”‚
â”‚  }               â”‚      â”‚                  â”‚      â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚                          â”‚
                                   â”‚                          â”‚
                                   â–¼                          â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  äº‹ä»¶DTOå±‚       â”‚      â”‚  SignalRé€šçŸ¥å±‚   â”‚
                          â”‚                  â”‚      â”‚                  â”‚
                          â”‚ AttackStarted    â”‚      â”‚ BattleNotificationâ”‚
                          â”‚ DamageApplied    â”‚â”€â”€â”€â”€â”€â–¶â”‚ Service          â”‚
                          â”‚ DamageReceived   â”‚      â”‚                  â”‚
                          â”‚                  â”‚      â”‚                  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â”‚
                                                              â–¼
                                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                     â”‚   å‰ç«¯(Blazor)   â”‚
                                                     â”‚                  â”‚
                                                     â”‚  æˆ˜æ–—æ—¥å¿—æ˜¾ç¤º    â”‚
                                                     â”‚  è¡€é‡æ¡æ›´æ–°      â”‚
                                                     â”‚  åŠ¨ç”»è§¦å‘        â”‚
                                                     â”‚                  â”‚
                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ¶ˆæ¯æµç¨‹å›¾

### ç©å®¶æ”»å‡»æ•Œäººæµç¨‹

```
1. ç©å®¶å‘èµ·æ”»å‡»
   â”‚
   â–¼
2. AttackTickEvent è§¦å‘
   â”‚
   â”œâ”€â–¶ BattleMessageFormatter.FormatAttackStarted()
   â”‚   â”‚
   â”‚   â–¼
   â”‚   AttackStartedEventDto {
   â”‚     AttackerName: "ç©å®¶"
   â”‚     TargetName: "å²è±å§†"
   â”‚     Message: "ç©å®¶ å¼€å§‹æ”»å‡» å²è±å§†"
   â”‚   }
   â”‚   â”‚
   â”‚   â–¼
   â””â”€â–¶ NotificationService.NotifyEventAsync()
       â”‚
       â–¼
3. SignalR Hub å¹¿æ’­
   â”‚
   â–¼
4. å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤º
   "ç©å®¶ å¼€å§‹æ”»å‡» å²è±å§†"
```

### é€ æˆä¼¤å®³æµç¨‹

```
1. ä¼¤å®³è®¡ç®—
   â”‚
   â–¼
2. DamageCalculator.ApplyDamage()
   â”‚
   â”œâ”€â–¶ BattleMessageFormatter.FormatDamageDealt()
   â”‚   â”‚
   â”‚   â–¼
   â”‚   DamageAppliedEventDto {
   â”‚     AttackerName: "ç©å®¶"
   â”‚     TargetName: "å“¥å¸ƒæ—"
   â”‚     Damage: 150
   â”‚     IsCrit: true
   â”‚     Message: "ç©å®¶ å¯¹ å“¥å¸ƒæ— é€ æˆ 150 ç‚¹ä¼¤å®³ï¼ˆæš´å‡»ï¼‰"
   â”‚   }
   â”‚   â”‚
   â”‚   â–¼
   â””â”€â–¶ NotificationService.NotifyEventAsync()
       â”‚
       â–¼
3. SignalR Hub å¹¿æ’­
   â”‚
   â–¼
4. å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤º
   "ç©å®¶ å¯¹ å“¥å¸ƒæ— é€ æˆ 150 ç‚¹ä¼¤å®³ï¼ˆæš´å‡»ï¼‰"
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. é…ç½®å±‚ (Configuration Layer)

**æ–‡ä»¶**: `appsettings.json`

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
    "DamageDealtTemplate": "{attacker} å¯¹ {target} é€ æˆ {damage} ç‚¹ä¼¤å®³{critSuffix}",
    "CritSuffix": "ï¼ˆæš´å‡»ï¼‰",
    "DamageReceivedTemplate": "{target} å—åˆ°æ¥è‡ª {attacker} çš„ {damage} ç‚¹ä¼¤å®³",
    "EnemyAttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
    "EnableAttackStartedEvent": true,
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true,
    "EnableEnemyAttackStartedEvent": true,
    "PlayerName": "ç©å®¶",
    "MaxMessageHistory": 100
  }
}
```

**èŒè´£**:
- å­˜å‚¨æ‰€æœ‰æ¶ˆæ¯æ¨¡æ¿
- æ§åˆ¶äº‹ä»¶å¼€å…³
- æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°

---

### 2. é…ç½®æ¨¡å‹ (Configuration Model)

**æ–‡ä»¶**: `BattleMessageOptions.cs`

```csharp
public sealed class BattleMessageOptions
{
    public const string SectionName = "BattleMessages";
    
    public string AttackStartedTemplate { get; set; }
    public string DamageDealtTemplate { get; set; }
    public string CritSuffix { get; set; }
    public string DamageReceivedTemplate { get; set; }
    public string EnemyAttackStartedTemplate { get; set; }
    
    public bool EnableAttackStartedEvent { get; set; }
    public bool EnableDamageDealtEvent { get; set; }
    public bool EnableDamageReceivedEvent { get; set; }
    public bool EnableEnemyAttackStartedEvent { get; set; }
    
    public string PlayerName { get; set; }
    public int MaxMessageHistory { get; set; }
}
```

**èŒè´£**:
- å¼ºç±»å‹é…ç½®æ¨¡å‹
- æä¾›é»˜è®¤å€¼
- æ”¯æŒä¾èµ–æ³¨å…¥

---

### 3. æ¶ˆæ¯æ ¼å¼åŒ–å™¨ (Message Formatter)

**æ–‡ä»¶**: `BattleMessageFormatter.cs`

```csharp
public sealed class BattleMessageFormatter
{
    private readonly BattleMessageOptions _options;
    
    public string FormatAttackStarted(string attacker, string target)
    {
        return _options.AttackStartedTemplate
            .Replace("{attacker}", attacker)
            .Replace("{target}", target);
    }
    
    public string FormatDamageDealt(string attacker, string target, 
                                   int damage, bool isCrit)
    {
        var critSuffix = isCrit ? _options.CritSuffix : "";
        return _options.DamageDealtTemplate
            .Replace("{attacker}", attacker)
            .Replace("{target}", target)
            .Replace("{damage}", damage.ToString())
            .Replace("{critSuffix}", critSuffix);
    }
    
    // ... å…¶ä»–æ ¼å¼åŒ–æ–¹æ³•
}
```

**èŒè´£**:
- æ ¹æ®æ¨¡æ¿ç”Ÿæˆæ¶ˆæ¯
- æ›¿æ¢å ä½ç¬¦
- æ£€æŸ¥äº‹ä»¶å¼€å…³çŠ¶æ€

---

### 4. äº‹ä»¶DTO (Event Data Transfer Objects)

**æ–‡ä»¶**: `BattleNotifications.cs`

```csharp
// æ”»å‡»å¼€å§‹äº‹ä»¶
public sealed class AttackStartedEventDto : BattleEventDto
{
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public string Message { get; set; }
}

// é€ æˆä¼¤å®³äº‹ä»¶
public sealed class DamageAppliedEventDto : BattleEventDto
{
    public string Source { get; set; }
    public int Damage { get; set; }
    public bool IsCrit { get; set; }
    public int TargetCurrentHp { get; set; }
    public int TargetMaxHp { get; set; }
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public string Message { get; set; }
}

// å—åˆ°ä¼¤å®³äº‹ä»¶
public sealed class DamageReceivedEventDto : BattleEventDto
{
    public string AttackerName { get; set; }
    public string TargetName { get; set; }
    public int Damage { get; set; }
    public int TargetCurrentHp { get; set; }
    public int TargetMaxHp { get; set; }
    public string Message { get; set; }
}
```

**èŒè´£**:
- ä¼ è¾“äº‹ä»¶æ•°æ®
- åŒ…å«æ ¼å¼åŒ–çš„æ¶ˆæ¯
- æ”¯æŒåºåˆ—åŒ–åˆ°SignalR

---

### 5. æˆ˜æ–—é€»è¾‘é›†æˆç‚¹

#### AttackTickEvent.cs

```csharp
if (formatter?.IsAttackStartedEnabled == true)
{
    var message = formatter.FormatAttackStarted(
        attacker.Name, 
        enemy.Name
    );
    
    await notificationService.NotifyEventAsync(
        ctx.BattleId,
        new AttackStartedEventDto
        {
            BattleId = ctx.BattleId,
            EventTime = ctx.Clock.Now,
            EventType = "AttackStarted",
            AttackerName = attacker.Name,
            TargetName = enemy.Name,
            Message = message
        }
    );
}
```

#### DamageCalculator.cs

```csharp
if (formatter?.IsDamageDealtEnabled == true)
{
    var message = formatter.FormatDamageDealt(
        attackerName,
        targetName,
        finalDamage,
        result.IsCrit
    );
    
    await notificationService.NotifyEventAsync(
        battleId,
        new DamageAppliedEventDto
        {
            BattleId = battleId,
            EventTime = currentTime,
            EventType = "DamageApplied",
            Source = source,
            Damage = finalDamage,
            IsCrit = result.IsCrit,
            TargetCurrentHp = target.CurrentHp,
            TargetMaxHp = target.MaxHp,
            AttackerName = attackerName,
            TargetName = targetName,
            Message = message
        }
    );
}
```

---

## ğŸ”§ ä¾èµ–æ³¨å…¥é…ç½®

**æ–‡ä»¶**: `Program.cs`

```csharp
// æ³¨å†Œé…ç½®
builder.Services.Configure<BattleMessageOptions>(
    builder.Configuration.GetSection(BattleMessageOptions.SectionName)
);

// æ³¨å†ŒæœåŠ¡
builder.Services.AddSingleton<BattleMessageFormatter>();
```

---

## ğŸ¯ å‰ç«¯é›†æˆç¤ºä¾‹

```csharp
@inject BattleSignalRService SignalRService

protected override async Task OnInitializedAsync()
{
    SignalRService.OnBattleEvent((battleId, eventData) =>
    {
        if (eventData is AttackStartedEventDto attack)
        {
            AddBattleLog(attack.Message);
        }
        else if (eventData is DamageAppliedEventDto damage)
        {
            AddBattleLog(damage.Message);
            UpdateEnemyHealth(damage.TargetCurrentHp, damage.TargetMaxHp);
        }
        else if (eventData is DamageReceivedEventDto received)
        {
            AddBattleLog(received.Message);
            UpdatePlayerHealth(received.TargetCurrentHp, received.TargetMaxHp);
        }
    });
}

private void AddBattleLog(string message)
{
    _battleLog.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
    if (_battleLog.Count > 50)
    {
        _battleLog.RemoveAt(0);
    }
    StateHasChanged();
}
```

---

## ğŸ“Š æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆ˜æ–—äº‹ä»¶    â”‚
â”‚ (æ¸¸æˆé€»è¾‘)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageFormatter    â”‚
â”‚ - è¯»å–é…ç½®          â”‚
â”‚ - æ£€æŸ¥å¼€å…³          â”‚
â”‚ - ç”Ÿæˆæ¶ˆæ¯          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EventDto            â”‚
â”‚ - ç»“æ„åŒ–æ•°æ®        â”‚
â”‚ - åŒ…å«æ¶ˆæ¯          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NotificationService â”‚
â”‚ - åºåˆ—åŒ–            â”‚
â”‚ - SignalRå‘é€       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SignalR Hub         â”‚
â”‚ - å¹¿æ’­åˆ°è¿æ¥        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯æ¥æ”¶å™¨          â”‚
â”‚ - ååºåˆ—åŒ–          â”‚
â”‚ - æ˜¾ç¤ºæ¶ˆæ¯          â”‚
â”‚ - æ›´æ–°UI            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æµ‹è¯•æ¶æ„

### å•å…ƒæµ‹è¯•å±‚

```
BattleMessageTests.cs
â”œâ”€ FormatAttackStarted_ReplacesPlaceholders
â”œâ”€ FormatDamageDealt_WithoutCrit_ReplacesPlaceholders
â”œâ”€ FormatDamageDealt_WithCrit_IncludesCritSuffix
â”œâ”€ FormatDamageReceived_ReplacesPlaceholders
â”œâ”€ IsAttackStartedEnabled_ReturnsConfigValue
â”œâ”€ GetPlayerName_ReturnsConfigValue
â”œâ”€ AttackStartedEventDto_HasRequiredProperties
â”œâ”€ DamageAppliedEventDto_HasExtendedProperties
â””â”€ DamageReceivedEventDto_HasRequiredProperties
```

### é›†æˆæµ‹è¯•å±‚

```
BattleMessageIntegrationTests.cs
â”œâ”€ BattleEngine_WithMessageFormatter_SendsAttackStartedEvent
â”œâ”€ BattleEngine_WithMessageFormatter_SendsDamageAppliedEvent
â”œâ”€ BattleEngine_WithEnemyAttack_SendsDamageReceivedEvent
â””â”€ BattleEngine_WithDisabledEvents_DoesNotSendMessages
```

---

## ğŸš€ æ‰©å±•æµç¨‹

### æ·»åŠ æ–°äº‹ä»¶ç±»å‹çš„æ­¥éª¤

```
1. é…ç½®å±‚
   â””â”€ BattleMessageOptions.cs
      â””â”€ æ·»åŠ æ–°æ¨¡æ¿å±æ€§å’Œå¼€å…³

2. æœåŠ¡å±‚
   â””â”€ BattleMessageFormatter.cs
      â””â”€ æ·»åŠ æ–°çš„æ ¼å¼åŒ–æ–¹æ³•

3. DTOå±‚
   â””â”€ BattleNotifications.cs
      â””â”€ åˆ›å»ºæ–°çš„EventDtoç±»

4. æˆ˜æ–—é€»è¾‘å±‚
   â””â”€ ç›¸å…³æˆ˜æ–—äº‹ä»¶æ–‡ä»¶
      â””â”€ è§¦å‘æ–°äº‹ä»¶é€šçŸ¥

5. é…ç½®æ–‡ä»¶
   â””â”€ appsettings.json
      â””â”€ æ·»åŠ æ–°é…ç½®é¡¹

6. æµ‹è¯•å±‚
   â”œâ”€ BattleMessageTests.cs (å•å…ƒæµ‹è¯•)
   â””â”€ BattleMessageIntegrationTests.cs (é›†æˆæµ‹è¯•)
```

---

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### å¼‚æ­¥å¤„ç†

```csharp
// äº‹ä»¶é€šçŸ¥æ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡æˆ˜æ–—é€»è¾‘
await notificationService.NotifyEventAsync(battleId, eventDto);
```

### å¯é€‰èŠ‚æµ

```json
{
  "SignalR": {
    "Performance": {
      "EnableThrottling": true,
      "ThrottleWindowMs": 1000
    }
  }
}
```

### æ¡ä»¶è§¦å‘

```csharp
// åªæœ‰é…ç½®å¯ç”¨æ—¶æ‰è§¦å‘
if (formatter?.IsAttackStartedEnabled == true)
{
    // å‘é€äº‹ä»¶
}
```

---

## ğŸ“ æ€»ç»“

æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ¶æ„å®ç°äº†éœ€æ±‚ï¼š

1. **é…ç½®åŒ–** - æ‰€æœ‰æ¶ˆæ¯æ¨¡æ¿åœ¨é…ç½®æ–‡ä»¶ä¸­
2. **è§£è€¦** - æ¶ˆæ¯ç”Ÿæˆä¸æˆ˜æ–—é€»è¾‘åˆ†ç¦»
3. **å¯æ‰©å±•** - æ˜“äºæ·»åŠ æ–°äº‹ä»¶ç±»å‹
4. **å¯æµ‹è¯•** - å®Œæ•´çš„æµ‹è¯•è¦†ç›–
5. **é«˜æ€§èƒ½** - å¼‚æ­¥é€šçŸ¥ï¼Œå¯é€‰èŠ‚æµ
6. **ç±»å‹å®‰å…¨** - å¼ºç±»å‹DTOå’Œé…ç½®æ¨¡å‹

ç³»ç»Ÿå·²å‡†å¤‡å¥½æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼âœ…
