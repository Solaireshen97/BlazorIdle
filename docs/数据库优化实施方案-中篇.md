# BlazorIdle æ•°æ®åº“ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸­ç¯‡ï¼šé«˜é¢‘æ“ä½œè¿ç§»

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**é˜¶æ®µ**: Phase 2 - åŠŸèƒ½è¿ç§»  
**é¢„è®¡å·¥æ—¶**: 64-96 å°æ—¶ï¼ˆ8-12 ä¸ªå·¥ä½œæ—¥ï¼‰  
**ä¼˜å…ˆçº§**: P1ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰  
**ä¾èµ–**: ä¸Šç¯‡ï¼ˆåŸºç¡€è®¾æ–½ï¼‰å®Œæˆ  

---

## ğŸ“‹ ç›®å½•

1. [é˜¶æ®µç›®æ ‡](#é˜¶æ®µç›®æ ‡)
2. [è¿ç§»ç­–ç•¥](#è¿ç§»ç­–ç•¥)
3. [è¯¦ç»†è¿ç§»æ­¥éª¤](#è¯¦ç»†è¿ç§»æ­¥éª¤)
4. [æµ‹è¯•å’ŒéªŒè¯](#æµ‹è¯•å’ŒéªŒè¯)
5. [å›é€€æ–¹æ¡ˆ](#å›é€€æ–¹æ¡ˆ)
6. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)

---

## é˜¶æ®µç›®æ ‡

### ä¸»è¦ç›®æ ‡

âœ… **è¿ç§»é«˜é¢‘æ•°æ®åº“æ“ä½œåˆ°å†…å­˜ç®¡ç†**
- è§’è‰²å¿ƒè·³ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
- æˆ˜æ–—å¿«ç…§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- æ´»åŠ¨è®¡åˆ’è¿›åº¦ï¼ˆä¸­ç­‰é¢‘ç‡ï¼‰

âœ… **ä¿æŒåŠŸèƒ½å®Œæ•´æ€§**
- ä¸æ”¹å˜ä¸šåŠ¡é€»è¾‘
- ä¸å½±å“ç”¨æˆ·ä½“éªŒ
- API æ¥å£ä¿æŒå…¼å®¹

âœ… **éªŒè¯æ€§èƒ½æå‡**
- æ•°æ®åº“å†™å…¥å‡å°‘ > 80%
- å“åº”æ—¶é—´æ”¹å–„ > 30%
- å¹¶å‘èƒ½åŠ›æå‡ > 2x

### è¿ç§»åŸåˆ™

1. **æ¸è¿›å¼è¿ç§»**: æ¯æ¬¡è¿ç§»ä¸€ä¸ªæ¨¡å—ï¼Œé€æ­¥æ¨è¿›
2. **å……åˆ†æµ‹è¯•**: æ¯ä¸ªæ¨¡å—è¿ç§»åç‹¬ç«‹æµ‹è¯•éªŒè¯
3. **ä¿ç•™å›é€€**: é…ç½®å¼€å…³æ”¯æŒå¿«é€Ÿå›é€€
4. **ç›‘æ§å¯¹æ¯”**: è¿ç§»å‰åæ€§èƒ½æŒ‡æ ‡å¯¹æ¯”
5. **ç”¨æˆ·æ— æ„Ÿ**: ä¸å½±å“çº¿ä¸Šç”¨æˆ·ä½“éªŒ

---

## è¿ç§»ç­–ç•¥

### ä¼˜å…ˆçº§æ’åºï¼ˆæŒ‰å½±å“ Ã— é£é™©ï¼‰

| æ¨¡å— | å½±å“ï¼ˆæ”¶ç›Šï¼‰ | é£é™© | ä¼˜å…ˆçº§ | å·¥æ—¶ |
|-----|------------|------|--------|-----|
| è§’è‰²å¿ƒè·³ | é«˜ï¼ˆ18K/h â†’ 1.2K/hï¼‰ | ä½ | P0 | 12-16h |
| æˆ˜æ–—å¿«ç…§ | æé«˜ï¼ˆ72K/h â†’ 60/hï¼‰ | ä¸­ | P0 | 24-32h |
| æ´»åŠ¨è®¡åˆ’è¿›åº¦ | ä¸­ï¼ˆ3K/h â†’ 120/hï¼‰ | ä½ | P1 | 16-24h |
| å…¶ä»–æ“ä½œ | ä½ | æä½ | P2 | 12-24h |

### è¿ç§»é¡ºåº

```
Phase 2.1: è§’è‰²å¿ƒè·³è¿ç§»ï¼ˆ12-16hï¼‰
    â†“ æµ‹è¯•éªŒè¯
Phase 2.2: æˆ˜æ–—å¿«ç…§è¿ç§»ï¼ˆ24-32hï¼‰
    â†“ æµ‹è¯•éªŒè¯
Phase 2.3: æ´»åŠ¨è®¡åˆ’è¿ç§»ï¼ˆ16-24hï¼‰
    â†“ æµ‹è¯•éªŒè¯
Phase 2.4: å…¶ä»–æ“ä½œä¼˜åŒ–ï¼ˆ12-24hï¼‰
    â†“ å…¨é¢æµ‹è¯•
éªŒæ”¶å’Œä¸Šçº¿
```

---

## è¯¦ç»†è¿ç§»æ­¥éª¤

### Phase 2.1: è§’è‰²å¿ƒè·³è¿ç§» â±ï¸ 12-16h

#### ç›®æ ‡
å°†è§’è‰²å¿ƒè·³ä»"æ¯æ¬¡ç«‹å³ä¿å­˜"æ”¹ä¸º"å†…å­˜æ›´æ–° + å®šæœŸä¿å­˜"

#### ç°çŠ¶åˆ†æ

**å½“å‰ä»£ç ** (`CharactersController.cs:Heartbeat`):
```csharp
[HttpPost("{id}/heartbeat")]
public async Task<IActionResult> Heartbeat(Guid id)
{
    var character = await _db.Characters.FindAsync(id);
    if (character == null)
        return NotFound();
        
    character.LastSeenAtUtc = DateTime.UtcNow;
    character.IsOnline = true;
    
    // æ¯æ¬¡å¿ƒè·³éƒ½ä¿å­˜åˆ°æ•°æ®åº“
    await DatabaseRetryPolicy.SaveChangesWithRetryAsync(_db);
    
    return Ok();
}
```

**é—®é¢˜**:
- æ¯ 10-20 ç§’å¿ƒè·³ä¸€æ¬¡
- 100 ä¸ªåœ¨çº¿ç©å®¶ = 18,000-36,000 æ¬¡/å°æ—¶æ•°æ®åº“å†™å…¥
- LastSeenAtUtc åªç”¨äºç¦»çº¿æ£€æµ‹ï¼ˆ60ç§’é˜ˆå€¼ï¼‰ï¼Œä¸éœ€è¦å®æ—¶ç²¾ç¡®

#### è¿ç§»æ–¹æ¡ˆ

**æ­¥éª¤ 1: ä¿®æ”¹ CharactersController.Heartbeat** â±ï¸ 2-3h

**æ–°å®ç°**:
```csharp
[HttpPost("{id}/heartbeat")]
public async Task<IActionResult> Heartbeat(Guid id)
{
    var character = await _characterManager.GetAsync(id);
    if (character == null)
        return NotFound();
    
    // ä»…æ›´æ–°å†…å­˜
    character.LastSeenAtUtc = DateTime.UtcNow;
    character.IsOnline = true;
    
    // æ ‡è®°ä¸º Dirtyï¼ˆä¸ç«‹å³ä¿å­˜ï¼‰
    _characterManager.Update(character);
    
    _logger.LogDebug("è§’è‰² {CharacterId} å¿ƒè·³å·²æ›´æ–°ï¼ˆå†…å­˜ï¼‰", id);
    
    return Ok();
}
```

**æ³¨æ„äº‹é¡¹**:
- âœ… ä¿æŒ API æ¥å£ä¸å˜ï¼ˆå®¢æˆ·ç«¯æ— éœ€ä¿®æ”¹ï¼‰
- âœ… å“åº”é€Ÿåº¦æ›´å¿«ï¼ˆæ— éœ€ç­‰å¾…æ•°æ®åº“å†™å…¥ï¼‰
- âš ï¸ LastSeenAtUtc å¯èƒ½æœ‰å»¶è¿Ÿï¼ˆæœ€å¤š 5 åˆ†é’Ÿï¼‰

**æ­¥éª¤ 2: æ›´æ–°ç¦»çº¿æ£€æµ‹é€»è¾‘** â±ï¸ 3-4h

**ç°çŠ¶** (`OfflineDetectionService.cs`):
```csharp
protected override async Task ExecuteAsync(CancellationToken stoppingToken)
{
    while (!stoppingToken.IsCancellationRequested)
    {
        await Task.Delay(TimeSpan.FromSeconds(30), stoppingToken);
        
        var threshold = DateTime.UtcNow.AddSeconds(-_thresholdSeconds);
        
        // ä»æ•°æ®åº“æŸ¥è¯¢
        var offlineCharacters = await _db.Characters
            .Where(c => c.IsOnline && c.LastSeenAtUtc < threshold)
            .ToListAsync(stoppingToken);
            
        foreach (var character in offlineCharacters)
        {
            character.IsOnline = false;
            // ç«‹å³ä¿å­˜
            await _db.SaveChangesAsync(stoppingToken);
        }
    }
}
```

**æ–°å®ç°**:
```csharp
protected override async Task ExecuteAsync(CancellationToken stoppingToken)
{
    while (!stoppingToken.IsCancellationRequested)
    {
        await Task.Delay(TimeSpan.FromSeconds(30), stoppingToken);
        
        // å¢åŠ é˜ˆå€¼ä»¥é€‚åº”å¿ƒè·³ä¿å­˜å»¶è¿Ÿï¼ˆ60s + æœ€å¤§å»¶è¿Ÿ 5min = 360sï¼‰
        var threshold = DateTime.UtcNow.AddSeconds(-360); // 6 åˆ†é’Ÿ
        
        // ä»å†…å­˜ä¸­æ£€æŸ¥ï¼ˆæ›´å¿«ï¼‰
        var allCharacters = _characterManager.GetSnapshot();
        var offlineCharacters = allCharacters
            .Where(kv => kv.Value.IsOnline && kv.Value.LastSeenAtUtc < threshold)
            .Select(kv => kv.Value)
            .ToList();
        
        if (!offlineCharacters.Any())
            continue;
            
        _logger.LogInformation("æ£€æµ‹åˆ° {Count} ä¸ªç¦»çº¿è§’è‰²", offlineCharacters.Count);
        
        foreach (var character in offlineCharacters)
        {
            character.IsOnline = false;
            // æ›´æ–°å†…å­˜ï¼ˆä¸ç«‹å³ä¿å­˜ï¼‰
            _characterManager.Update(character);
        }
        
        // å¯é€‰ï¼šç«‹å³è§¦å‘ä¸€æ¬¡ä¿å­˜ï¼ˆç¡®ä¿ç¦»çº¿çŠ¶æ€åŠæ—¶æŒä¹…åŒ–ï¼‰
        await _persistenceCoordinator.TriggerSaveAsync("Character");
    }
}
```

**é…ç½®æ›´æ–°** (`appsettings.json`):
```json
{
  "Offline": {
    "OfflineDetectionSeconds": 30,
    "OfflineThresholdSeconds": 360,  // ä» 60s å¢åŠ åˆ° 360s
    "MaxOfflineSeconds": 43200,
    "AutoApplyRewards": true
  }
}
```

**æ­¥éª¤ 3: å•å…ƒæµ‹è¯•** â±ï¸ 3-4h

```csharp
public class CharacterHeartbeatTests
{
    [Fact]
    public async Task Heartbeat_ShouldUpdateMemoryOnly()
    {
        // Arrange
        var characterManager = new MemoryStateManager<Character>();
        var character = new Character { Id = Guid.NewGuid() };
        characterManager.Add(character);
        
        // Act
        character.LastSeenAtUtc = DateTime.UtcNow;
        characterManager.Update(character);
        
        // Assert
        var dirtyEntities = characterManager.GetDirtyEntities().ToList();
        dirtyEntities.Should().ContainSingle();
    }
    
    [Fact]
    public async Task OfflineDetection_ShouldUseMemory()
    {
        // æµ‹è¯•ç¦»çº¿æ£€æµ‹ä»å†…å­˜è¯»å–
        // ...
    }
}
```

**æ­¥éª¤ 4: é›†æˆæµ‹è¯•å’ŒéªŒè¯** â±ï¸ 4-5h

**æµ‹è¯•åœºæ™¯**:
1. æ¨¡æ‹Ÿ 100 ä¸ªç©å®¶å¿ƒè·³ï¼ˆæ¯ 10 ç§’ä¸€æ¬¡ï¼ŒæŒç»­ 5 åˆ†é’Ÿï¼‰
2. éªŒè¯æ•°æ®åº“å†™å…¥æ¬¡æ•°å¤§å¹…å‡å°‘
3. éªŒè¯ç¦»çº¿æ£€æµ‹ä»ç„¶æ­£å¸¸å·¥ä½œ
4. éªŒè¯å…³é—­æ—¶æ‰€æœ‰å¿ƒè·³æ­£ç¡®ä¿å­˜

**æ€§èƒ½éªŒè¯**:
```csharp
[Fact]
public async Task Heartbeat_PerformanceTest()
{
    // æ¨¡æ‹Ÿ 100 ä¸ªç©å®¶ï¼Œ5 åˆ†é’Ÿå¿ƒè·³
    var playerCount = 100;
    var durationMinutes = 5;
    
    var sw = Stopwatch.StartNew();
    
    // æ‰§è¡Œå¿ƒè·³
    for (int i = 0; i < durationMinutes * 60 / 10; i++)
    {
        foreach (var player in players)
        {
            await controller.Heartbeat(player.Id);
        }
        await Task.Delay(10000); // 10ç§’
    }
    
    sw.Stop();
    
    // éªŒè¯æ•°æ®åº“ä¿å­˜æ¬¡æ•°
    var saveCount = GetDatabaseSaveCount();
    saveCount.Should().BeLessThan(100); // è¿œå°‘äºä¹‹å‰çš„ 3000 æ¬¡
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] å¿ƒè·³ API æ­£å¸¸å·¥ä½œ
- [ ] ç¦»çº¿æ£€æµ‹æ­£å¸¸å·¥ä½œ
- [ ] æ•°æ®åº“å†™å…¥å‡å°‘ > 90%
- [ ] å“åº”æ—¶é—´å‡å°‘ > 50%
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### Phase 2.2: æˆ˜æ–—å¿«ç…§è¿ç§» â±ï¸ 24-32h

#### ç›®æ ‡
å°†æˆ˜æ–—å¿«ç…§ä»"æ¯ 500ms ä¿å­˜"æ”¹ä¸º"å†…å­˜ç®¡ç† + æ¯åˆ†é’Ÿä¿å­˜"

#### ç°çŠ¶åˆ†æ

**å½“å‰ä»£ç ** (`StepBattleHostedService.cs`):
```csharp
protected override async Task ExecuteAsync(CancellationToken stoppingToken)
{
    while (!stoppingToken.IsCancellationRequested)
    {
        await Task.Delay(500, stoppingToken);
        
        // æ¯ 500ms ä¿å­˜æ‰€æœ‰æˆ˜æ–—å¿«ç…§
        await _snapshotService.SaveAllRunningBattleSnapshotsAsync(stoppingToken);
    }
}
```

**StepBattleSnapshotService.SaveAllRunningBattleSnapshotsAsync**:
```csharp
public async Task SaveAllRunningBattleSnapshotsAsync(CancellationToken ct)
{
    var battleIds = _coordinator.InternalIdsSnapshot();
    
    using var scope = _scopeFactory.CreateScope();
    var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
    
    foreach (var id in battleIds)
    {
        var (found, status) = _coordinator.GetStatus(id);
        if (!found) continue;
        
        var snapshot = CreateSnapshot(id, status);
        
        // ç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
        db.RunningBattleSnapshots.Update(snapshot);
        await db.SaveChangesAsync(ct);
    }
}
```

**é—®é¢˜**:
- æ¯ 500ms ä¿å­˜ä¸€æ¬¡ï¼Œæ¯ä¸ªæˆ˜æ–— 7,200 æ¬¡/å°æ—¶
- 10 ä¸ªå¹¶å‘æˆ˜æ–— = 72,000 æ¬¡/å°æ—¶
- å¿«ç…§ä¸»è¦ç”¨äºæ¢å¤ï¼Œä¸éœ€è¦å®æ—¶æ›´æ–°

#### è¿ç§»æ–¹æ¡ˆ

**æ­¥éª¤ 1: ä¿®æ”¹ StepBattleHostedService** â±ï¸ 4-6h

**æ–°å®ç°**:
```csharp
protected override async Task ExecuteAsync(CancellationToken stoppingToken)
{
    _logger.LogInformation("æˆ˜æ–—å¿«ç…§æœåŠ¡å·²å¯åŠ¨ï¼ˆä½¿ç”¨å†…å­˜ç®¡ç†ï¼‰");
    
    while (!stoppingToken.IsCancellationRequested)
    {
        await Task.Delay(500, stoppingToken);
        
        // ä»…æ›´æ–°å†…å­˜å¿«ç…§ï¼ˆä¸ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
        await UpdateAllBattleSnapshotsInMemoryAsync(stoppingToken);
    }
}

private async Task UpdateAllBattleSnapshotsInMemoryAsync(CancellationToken ct)
{
    var battleIds = _coordinator.InternalIdsSnapshot();
    
    foreach (var id in battleIds)
    {
        var (found, status) = _coordinator.GetStatus(id);
        if (!found) continue;
        
        var snapshot = CreateSnapshot(id, status);
        
        // æ›´æ–°å†…å­˜ï¼ˆä¸ç«‹å³ä¿å­˜ï¼‰
        _battleSnapshotManager.Update(snapshot);
    }
    
    _logger.LogDebug("å·²æ›´æ–° {Count} ä¸ªæˆ˜æ–—å¿«ç…§ï¼ˆå†…å­˜ï¼‰", battleIds.Count());
}
```

**æ­¥éª¤ 2: åˆ›å»º BattleSnapshotRecoveryService** â±ï¸ 6-8h

æˆ˜æ–—æ¢å¤é€»è¾‘éœ€è¦è°ƒæ•´ï¼Œå› ä¸ºå¿«ç…§ä¸å†å®æ—¶ä¿å­˜ï¼š

```csharp
public class BattleSnapshotRecoveryService
{
    private readonly MemoryStateManager<RunningBattleSnapshotRecord> _snapshotManager;
    private readonly GameDbContext _db;
    private readonly ILogger<BattleSnapshotRecoveryService> _logger;
    
    /// <summary>
    /// æ¢å¤è§’è‰²çš„è¿è¡Œä¸­æˆ˜æ–—
    /// ç­–ç•¥ï¼š
    /// 1. å…ˆä»å†…å­˜æŸ¥æ‰¾æœ€æ–°å¿«ç…§
    /// 2. å†…å­˜æœªå‘½ä¸­åˆ™ä»æ•°æ®åº“åŠ è½½
    /// 3. å¿«ç…§è¿‡æœŸåˆ™æ”¾å¼ƒæ¢å¤
    /// </summary>
    public async Task<RunningBattleSnapshotRecord?> GetLatestSnapshotAsync(
        Guid characterId, 
        CancellationToken ct = default)
    {
        // 1. ä»å†…å­˜ä¸­æŸ¥æ‰¾ï¼ˆæœ€æ–°ï¼‰
        var memorySnapshot = _snapshotManager.GetSnapshot()
            .Values
            .Where(s => s.CharacterId == characterId)
            .OrderByDescending(s => s.SavedAtUtc)
            .FirstOrDefault();
        
        if (memorySnapshot != null)
        {
            _logger.LogInformation(
                "ä»å†…å­˜æ¢å¤æˆ˜æ–—å¿«ç…§ï¼ˆè§’è‰² {CharacterId}ï¼‰",
                characterId
            );
            return memorySnapshot;
        }
        
        // 2. å†…å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
        var dbSnapshot = await _db.RunningBattleSnapshots
            .Where(s => s.CharacterId == characterId)
            .OrderByDescending(s => s.SavedAtUtc)
            .FirstOrDefaultAsync(ct);
        
        if (dbSnapshot != null)
        {
            // æ£€æŸ¥å¿«ç…§æ˜¯å¦è¿‡æœŸï¼ˆ> 2 åˆ†é’Ÿè§†ä¸ºè¿‡æœŸï¼‰
            var age = DateTime.UtcNow - dbSnapshot.SavedAtUtc;
            if (age.TotalMinutes > 2)
            {
                _logger.LogWarning(
                    "æˆ˜æ–—å¿«ç…§å·²è¿‡æœŸï¼ˆ{Age} åˆ†é’Ÿï¼‰ï¼Œæ”¾å¼ƒæ¢å¤",
                    age.TotalMinutes
                );
                return null;
            }
            
            _logger.LogInformation(
                "ä»æ•°æ®åº“æ¢å¤æˆ˜æ–—å¿«ç…§ï¼ˆè§’è‰² {CharacterId}ï¼Œå¿«ç…§å¹´é¾„ {Age}sï¼‰",
                characterId,
                age.TotalSeconds
            );
            
            // åŠ è½½åˆ°å†…å­˜
            _snapshotManager.Add(dbSnapshot);
            
            return dbSnapshot;
        }
        
        _logger.LogInformation(
            "æœªæ‰¾åˆ°æˆ˜æ–—å¿«ç…§ï¼ˆè§’è‰² {CharacterId}ï¼‰",
            characterId
        );
        
        return null;
    }
}
```

**æ­¥éª¤ 3: æ›´æ–°æˆ˜æ–—ç»“æŸæ¸…ç†é€»è¾‘** â±ï¸ 3-4h

```csharp
public async Task CleanupBattleSnapshotAsync(Guid battleId)
{
    // ä»å†…å­˜ä¸­ç§»é™¤
    _battleSnapshotManager.Remove(battleId);
    
    // æ•°æ®åº“ä¸­åˆ é™¤ï¼ˆå»¶è¿Ÿåˆ°ä¸‹æ¬¡ä¿å­˜å‘¨æœŸï¼Œæˆ–è€…ç«‹å³åˆ é™¤ï¼‰
    using var scope = _scopeFactory.CreateScope();
    var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
    
    var snapshot = await db.RunningBattleSnapshots.FindAsync(battleId);
    if (snapshot != null)
    {
        db.RunningBattleSnapshots.Remove(snapshot);
        await db.SaveChangesAsync();
    }
}
```

**æ­¥éª¤ 4: é…ç½®æ›´æ–°** â±ï¸ 1-2h

```json
{
  "Persistence": {
    "EntitySaveStrategies": {
      "BattleSnapshot": {
        "SaveIntervalMs": 60000,  // æ¯åˆ†é’Ÿä¿å­˜ï¼ˆè€Œé 500msï¼‰
        "MaxBatchSize": 500,
        "SnapshotExpirationMinutes": 2  // å¿«ç…§è¿‡æœŸæ—¶é—´
      }
    }
  }
}
```

**æ­¥éª¤ 5: å•å…ƒæµ‹è¯•** â±ï¸ 4-6h

```csharp
public class BattleSnapshotMigrationTests
{
    [Fact]
    public async Task UpdateSnapshot_ShouldOnlyUpdateMemory()
    {
        // æµ‹è¯•å¿«ç…§ä»…æ›´æ–°å†…å­˜
    }
    
    [Fact]
    public async Task RecoverSnapshot_ShouldTryMemoryFirst()
    {
        // æµ‹è¯•æ¢å¤ä¼˜å…ˆä»å†…å­˜è¯»å–
    }
    
    [Fact]
    public async Task RecoverSnapshot_ShouldRejectExpiredSnapshot()
    {
        // æµ‹è¯•æ‹’ç»è¿‡æœŸå¿«ç…§
    }
}
```

**æ­¥éª¤ 6: é›†æˆæµ‹è¯•å’Œæ€§èƒ½éªŒè¯** â±ï¸ 6-8h

**æµ‹è¯•åœºæ™¯**:
1. æ¨¡æ‹Ÿ 10 ä¸ªå¹¶å‘æˆ˜æ–—ï¼ŒæŒç»­ 10 åˆ†é’Ÿ
2. éªŒè¯å¿«ç…§å†…å­˜æ›´æ–°æ­£å¸¸
3. éªŒè¯å®šæœŸä¿å­˜æ­£å¸¸å·¥ä½œ
4. éªŒè¯æˆ˜æ–—æ¢å¤åŠŸèƒ½æ­£å¸¸
5. æ¨¡æ‹ŸæœåŠ¡å™¨é‡å¯ï¼ŒéªŒè¯æ¢å¤é€»è¾‘

**æ€§èƒ½éªŒè¯**:
```csharp
[Fact]
public async Task BattleSnapshot_PerformanceTest()
{
    // 10 ä¸ªå¹¶å‘æˆ˜æ–—ï¼Œ10 åˆ†é’Ÿ
    var battleCount = 10;
    var durationMinutes = 10;
    
    var sw = Stopwatch.StartNew();
    
    // å¯åŠ¨æˆ˜æ–—
    var battles = StartBattles(battleCount);
    
    // ç­‰å¾… 10 åˆ†é’Ÿ
    await Task.Delay(TimeSpan.FromMinutes(durationMinutes));
    
    sw.Stop();
    
    // éªŒè¯æ•°æ®åº“ä¿å­˜æ¬¡æ•°
    var saveCount = GetDatabaseSaveCount();
    
    // ä¹‹å‰: 10 * 7200 * (10/60) = 12,000 æ¬¡
    // ç°åœ¨: 10 * 10 = 100 æ¬¡
    saveCount.Should().BeLessThan(200); // å‡å°‘ 99%
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] æˆ˜æ–—å¿«ç…§åŠŸèƒ½æ­£å¸¸
- [ ] æˆ˜æ–—æ¢å¤åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®åº“å†™å…¥å‡å°‘ > 98%
- [ ] å¿«ç…§è¿‡æœŸæœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### Phase 2.3: æ´»åŠ¨è®¡åˆ’è¿ç§» â±ï¸ 16-24h

#### ç›®æ ‡
å°†æ´»åŠ¨è®¡åˆ’çŠ¶æ€æ›´æ–°ä»"ç«‹å³ä¿å­˜"æ”¹ä¸º"å†…å­˜ç®¡ç† + å®šæœŸä¿å­˜"

#### ç°çŠ¶åˆ†æ

**å½“å‰ä»£ç ** (`ActivityPlanRepository.cs`):
```csharp
public async Task UpdateAsync(ActivityPlan plan, CancellationToken ct = default)
{
    _db.ActivityPlans.Update(plan);
    await DatabaseRetryPolicy.SaveChangesWithRetryAsync(_db, ct);
}
```

æ´»åŠ¨è®¡åˆ’çŠ¶æ€å˜æ›´é¢‘ç¹ï¼š
- çŠ¶æ€åˆ‡æ¢ï¼ˆPending â†’ Running â†’ Completedï¼‰
- è¿›åº¦æ›´æ–°ï¼ˆRemainingCount, RemainingDurationSecondsï¼‰
- å®Œæˆæ—¶é—´è®°å½•

#### è¿ç§»æ–¹æ¡ˆ

**æ­¥éª¤ 1: åˆ›å»º ActivityPlanService é€‚é…å±‚** â±ï¸ 6-8h

```csharp
public class ActivityPlanService
{
    private readonly MemoryStateManager<ActivityPlan> _planManager;
    private readonly GameDbContext _db;
    private readonly ILogger<ActivityPlanService> _logger;
    
    /// <summary>
    /// åˆ›å»ºæ´»åŠ¨è®¡åˆ’ï¼ˆç«‹å³æŒä¹…åŒ–ï¼Œå…³é”®æ“ä½œï¼‰
    /// </summary>
    public async Task<ActivityPlan> CreateAsync(
        Guid characterId,
        ActivityType type,
        ActivityLimit limit,
        CancellationToken ct = default)
    {
        var plan = new ActivityPlan
        {
            Id = Guid.NewGuid(),
            CharacterId = characterId,
            Type = type,
            State = ActivityState.Pending,
            Limit = limit,
            CreatedAt = DateTime.UtcNow
        };
        
        // æ·»åŠ åˆ°å†…å­˜
        _planManager.Add(plan);
        
        // ç«‹å³æŒä¹…åŒ–ï¼ˆåˆ›å»ºæ“ä½œæ˜¯å…³é”®æ“ä½œï¼‰
        _db.ActivityPlans.Add(plan);
        await _db.SaveChangesAsync(ct);
        
        _logger.LogInformation(
            "æ´»åŠ¨è®¡åˆ’å·²åˆ›å»ºï¼š{PlanId}, ç±»å‹ {Type}",
            plan.Id, plan.Type
        );
        
        return plan;
    }
    
    /// <summary>
    /// æ›´æ–°æ´»åŠ¨è®¡åˆ’çŠ¶æ€ï¼ˆä»…å†…å­˜ï¼‰
    /// </summary>
    public void UpdateState(Guid planId, ActivityState newState)
    {
        var plan = _planManager.GetAsync(planId).GetAwaiter().GetResult();
        if (plan == null)
        {
            _logger.LogWarning("æ´»åŠ¨è®¡åˆ’æœªæ‰¾åˆ°ï¼š{PlanId}", planId);
            return;
        }
        
        plan.State = newState;
        plan.UpdatedAt = DateTime.UtcNow;
        
        if (newState == ActivityState.Completed)
        {
            plan.CompletedAt = DateTime.UtcNow;
        }
        
        // æ›´æ–°å†…å­˜ï¼ˆä¸ç«‹å³ä¿å­˜ï¼‰
        _planManager.Update(plan);
        
        _logger.LogDebug(
            "æ´»åŠ¨è®¡åˆ’çŠ¶æ€å·²æ›´æ–°ï¼ˆå†…å­˜ï¼‰ï¼š{PlanId} -> {State}",
            planId, newState
        );
    }
    
    /// <summary>
    /// æ›´æ–°æ´»åŠ¨è¿›åº¦ï¼ˆä»…å†…å­˜ï¼‰
    /// </summary>
    public void UpdateProgress(Guid planId, int? remainingCount, double? remainingSeconds)
    {
        var plan = _planManager.GetAsync(planId).GetAwaiter().GetResult();
        if (plan == null) return;
        
        if (remainingCount.HasValue)
            plan.RemainingCount = remainingCount.Value;
            
        if (remainingSeconds.HasValue)
            plan.RemainingDurationSeconds = remainingSeconds.Value;
        
        plan.UpdatedAt = DateTime.UtcNow;
        
        // æ›´æ–°å†…å­˜
        _planManager.Update(plan);
        
        _logger.LogTrace(
            "æ´»åŠ¨è¿›åº¦å·²æ›´æ–°ï¼ˆå†…å­˜ï¼‰ï¼š{PlanId}, å‰©ä½™ {Count}/{Seconds}",
            planId, remainingCount, remainingSeconds
        );
    }
    
    /// <summary>
    /// åˆ é™¤æ´»åŠ¨è®¡åˆ’ï¼ˆç«‹å³æŒä¹…åŒ–ï¼‰
    /// </summary>
    public async Task DeleteAsync(Guid planId, CancellationToken ct = default)
    {
        // ä»å†…å­˜ç§»é™¤
        _planManager.Remove(planId);
        
        // ç«‹å³ä»æ•°æ®åº“åˆ é™¤
        var plan = await _db.ActivityPlans.FindAsync(new object[] { planId }, ct);
        if (plan != null)
        {
            _db.ActivityPlans.Remove(plan);
            await _db.SaveChangesAsync(ct);
        }
        
        _logger.LogInformation("æ´»åŠ¨è®¡åˆ’å·²åˆ é™¤ï¼š{PlanId}", planId);
    }
}
```

**æ­¥éª¤ 2: æ›´æ–°ä½¿ç”¨ ActivityPlanRepository çš„ä»£ç ** â±ï¸ 6-8h

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `ActivityPlansController.cs`
- `StepBattleCoordinator.cs`
- `OfflineSettlementService.cs`

**ç¤ºä¾‹ä¿®æ”¹** (`ActivityPlansController.cs`):
```csharp
// ä¹‹å‰
await _repository.UpdateAsync(plan);

// ä¹‹å
_activityPlanService.UpdateState(plan.Id, ActivityState.Running);
```

**æ­¥éª¤ 3: å•å…ƒæµ‹è¯•** â±ï¸ 4-6h

```csharp
public class ActivityPlanMigrationTests
{
    [Fact]
    public async Task CreatePlan_ShouldPersistImmediately()
    {
        // åˆ›å»ºåº”ç«‹å³æŒä¹…åŒ–
    }
    
    [Fact]
    public void UpdateState_ShouldOnlyUpdateMemory()
    {
        // çŠ¶æ€æ›´æ–°ä»…å†…å­˜
    }
    
    [Fact]
    public void UpdateProgress_ShouldOnlyUpdateMemory()
    {
        // è¿›åº¦æ›´æ–°ä»…å†…å­˜
    }
}
```

**æ­¥éª¤ 4: é›†æˆæµ‹è¯•** â±ï¸ 4-6h

**æµ‹è¯•åœºæ™¯**:
1. åˆ›å»ºå¤šä¸ªæ´»åŠ¨è®¡åˆ’
2. æ¨¡æ‹Ÿæ´»åŠ¨çŠ¶æ€å˜æ›´å’Œè¿›åº¦æ›´æ–°
3. éªŒè¯å†…å­˜æ›´æ–°æ­£å¸¸
4. éªŒè¯å®šæœŸä¿å­˜æ­£å¸¸
5. éªŒè¯å…³é—­æ—¶æ‰€æœ‰è®¡åˆ’æ­£ç¡®ä¿å­˜

#### éªŒæ”¶æ ‡å‡†

- [ ] æ´»åŠ¨è®¡åˆ’åˆ›å»ºæ­£å¸¸
- [ ] çŠ¶æ€æ›´æ–°æ­£å¸¸
- [ ] è¿›åº¦è·Ÿè¸ªæ­£å¸¸
- [ ] æ•°æ®åº“å†™å…¥å‡å°‘ > 90%
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### Phase 2.4: å…¶ä»–æ“ä½œä¼˜åŒ– â±ï¸ 12-24h

#### ç›®æ ‡
ä¼˜åŒ–å…¶ä»–ä½é¢‘ä½†å¯ä¼˜åŒ–çš„æ“ä½œ

#### ä¼˜åŒ–é¡¹ç›®

**1. ç»æµäº‹ä»¶è®°å½•** â±ï¸ 4-6h

å½“å‰ï¼šæ¯æ¬¡ç»æµäº‹ä»¶ï¼ˆé‡‘å¸ã€ç»éªŒè·å¾—ï¼‰ç«‹å³è®°å½•
ä¼˜åŒ–ï¼šæ‰¹é‡è®°å½•ï¼ˆæ¯åˆ†é’Ÿæ±‡æ€»ä¸€æ¬¡ï¼‰

**2. è£…å¤‡å˜æ›´** â±ï¸ 4-6h

å½“å‰ï¼šæ¯æ¬¡è£…å¤‡æ“ä½œç«‹å³ä¿å­˜
ä¿æŒï¼šè£…å¤‡å˜æ›´ä¿æŒç«‹å³ä¿å­˜ï¼ˆæ¶‰åŠç©å®¶èµ„äº§ï¼Œåº”ç¡®ä¿å®‰å…¨ï¼‰

**3. å•†åº—è´­ä¹°è®°å½•** â±ï¸ 4-6h

å½“å‰ï¼šæ¯æ¬¡è´­ä¹°ç«‹å³è®°å½•
ä¿æŒï¼šè´­ä¹°è®°å½•ä¿æŒç«‹å³ä¿å­˜ï¼ˆæ¶‰åŠç©å®¶æ¶ˆè´¹ï¼‰

**4. ç»Ÿè®¡æ•°æ®** â±ï¸ 4-6h

å½“å‰ï¼šéƒ¨åˆ†ç»Ÿè®¡æ•°æ®ç«‹å³æ›´æ–°
ä¼˜åŒ–ï¼šç»Ÿè®¡æ•°æ®æ‰¹é‡æ›´æ–°ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰

---

## æµ‹è¯•å’ŒéªŒè¯

### å…¨é¢é›†æˆæµ‹è¯•

**æµ‹è¯•ç¯å¢ƒæ­å»º** â±ï¸ 4-6h

1. å‡†å¤‡æµ‹è¯•æ•°æ®
2. é…ç½®æµ‹è¯•ç¯å¢ƒ
3. éƒ¨ç½²è¿ç§»åç‰ˆæœ¬

**æµ‹è¯•åœºæ™¯** â±ï¸ 8-12h

#### åœºæ™¯ 1: æ­£å¸¸æ¸¸æˆæµç¨‹
```
1. åˆ›å»ºè§’è‰²
2. å¼€å§‹æˆ˜æ–—ï¼ˆ10 åˆ†é’Ÿï¼‰
3. å¿ƒè·³ä¿æŒï¼ˆæ¯ 10 ç§’ï¼‰
4. æ´»åŠ¨è®¡åˆ’åˆ‡æ¢
5. æ­£å¸¸é€€å‡º
```

**éªŒè¯ç‚¹**:
- [ ] æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®å®Œæ•´æ€§
- [ ] æ€§èƒ½æå‡æ˜æ˜¾

#### åœºæ™¯ 2: é«˜è´Ÿè½½æµ‹è¯•
```
1. æ¨¡æ‹Ÿ 100 ä¸ªåœ¨çº¿ç©å®¶
2. 50 ä¸ªå¹¶å‘æˆ˜æ–—
3. æŒç»­ 30 åˆ†é’Ÿ
4. æ­£å¸¸å…³é—­
```

**éªŒè¯ç‚¹**:
- [ ] ç³»ç»Ÿç¨³å®šæ€§
- [ ] å†…å­˜ä½¿ç”¨åˆç†
- [ ] æ•°æ®åº“å‹åŠ›é™ä½
- [ ] æ‰€æœ‰æ•°æ®æ­£ç¡®ä¿å­˜

#### åœºæ™¯ 3: å¼‚å¸¸æ¢å¤æµ‹è¯•
```
1. å¯åŠ¨å¤šä¸ªæˆ˜æ–—
2. æ¨¡æ‹ŸæœåŠ¡å™¨é‡å¯
3. æ¢å¤æˆ˜æ–—
4. éªŒè¯æ•°æ®å®Œæ•´æ€§
```

**éªŒè¯ç‚¹**:
- [ ] æˆ˜æ–—æ¢å¤æ­£å¸¸
- [ ] æ— æ•°æ®ä¸¢å¤±
- [ ] çŠ¶æ€ä¸€è‡´æ€§

### æ€§èƒ½å¯¹æ¯”æµ‹è¯•

**æµ‹è¯•å·¥å…·**: Apache JMeter / k6

**æµ‹è¯•æŒ‡æ ‡**:

| æŒ‡æ ‡ | è¿ç§»å‰ | è¿ç§»å | ç›®æ ‡æ”¹å–„ |
|-----|-------|-------|---------|
| æ•°æ®åº“å†™å…¥æ¬¡æ•°/å°æ—¶ | ~100,000 | <5,000 | > 95% â†“ |
| API å“åº”æ—¶é—´ P95 | 300ms | <100ms | > 66% â†“ |
| å†…å­˜ä½¿ç”¨ | 200MB | <400MB | +100MB (acceptable) |
| CPU ä½¿ç”¨ç‡ | 40% | <35% | > 12% â†“ |
| å¹¶å‘æˆ˜æ–—æ•° | 15 | >50 | > 3x â†‘ |

---

## å›é€€æ–¹æ¡ˆ

### é…ç½®å¼€å…³

```json
{
  "Persistence": {
    "EnableMemoryBuffering": false  // è®¾ä¸º false å³å¯å›é€€
  }
}
```

### å›é€€æµç¨‹

1. **æ£€æµ‹é—®é¢˜**ï¼šç›‘æ§æŒ‡æ ‡å¼‚å¸¸æˆ–ç”¨æˆ·åé¦ˆ
2. **è¯„ä¼°å½±å“**ï¼šç¡®è®¤æ˜¯å¦éœ€è¦å›é€€
3. **æ‰§è¡Œå›é€€**ï¼š
   ```bash
   # æ›´æ–°é…ç½®
   "EnableMemoryBuffering": false
   
   # é‡å¯æœåŠ¡
   systemctl restart blazoridle
   ```
4. **éªŒè¯å›é€€**ï¼šç¡®è®¤ç³»ç»Ÿæ¢å¤æ­£å¸¸
5. **åˆ†æé—®é¢˜**ï¼šå®šä½æ ¹æœ¬åŸå› 
6. **ä¿®å¤é—®é¢˜**ï¼šä¿®å¤åé‡æ–°ä¸Šçº¿

### å›é€€å‡†å¤‡

- [ ] å‡†å¤‡å›é€€é…ç½®æ–‡ä»¶
- [ ] æµ‹è¯•å›é€€æµç¨‹
- [ ] æ–‡æ¡£åŒ–å›é€€æ­¥éª¤
- [ ] å‡†å¤‡å›é€€å†³ç­–æ ‡å‡†

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] API æ¥å£å…¼å®¹æ€§ä¿æŒ
- [ ] ç”¨æˆ·ä½“éªŒæ— æ„ŸçŸ¥å˜åŒ–

### æ€§èƒ½éªŒæ”¶

- [ ] æ•°æ®åº“å†™å…¥å‡å°‘ > 80%
- [ ] API å“åº”æ—¶é—´æ”¹å–„ > 30%
- [ ] å¹¶å‘èƒ½åŠ›æå‡ > 2x
- [ ] å†…å­˜å¢åŠ  < 200MB

### ç¨³å®šæ€§éªŒæ”¶

- [ ] 24 å°æ—¶ç¨³å®šæ€§æµ‹è¯•é€šè¿‡
- [ ] æ— å†…å­˜æ³„æ¼
- [ ] æ— æ•°æ®ä¸¢å¤±
- [ ] é”™è¯¯ç‡ < 0.1%

### æ–‡æ¡£éªŒæ”¶

- [ ] è¿ç§»æ–‡æ¡£å®Œæ•´
- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] è¿ç»´æ–‡æ¡£æ›´æ–°
- [ ] å›é€€æ–¹æ¡ˆæ–‡æ¡£

---

## ä¸Šçº¿è®¡åˆ’

### ç°åº¦å‘å¸ƒ

**Stage 1**: å†…éƒ¨æµ‹è¯•ï¼ˆ1-2 å¤©ï¼‰
- å¼€å‘ç¯å¢ƒå…¨é¢æµ‹è¯•
- ä¿®å¤å‘ç°çš„é—®é¢˜

**Stage 2**: å°èŒƒå›´ç°åº¦ï¼ˆ2-3 å¤©ï¼‰
- 10% ç”¨æˆ·æµé‡
- å¯†åˆ‡ç›‘æ§æŒ‡æ ‡
- å¿«é€Ÿå“åº”é—®é¢˜

**Stage 3**: æ‰©å¤§ç°åº¦ï¼ˆ3-5 å¤©ï¼‰
- 50% ç”¨æˆ·æµé‡
- ç»§ç»­ç›‘æ§
- æ”¶é›†åé¦ˆ

**Stage 4**: å…¨é‡ä¸Šçº¿ï¼ˆ1 å¤©ï¼‰
- 100% ç”¨æˆ·æµé‡
- æŒç»­ç›‘æ§
- å‡†å¤‡å¿«é€Ÿå›é€€

### ç›‘æ§æŒ‡æ ‡

ä¸Šçº¿åæŒç»­ç›‘æ§ï¼š
- æ•°æ®åº“å†™å…¥æ¬¡æ•°
- API å“åº”æ—¶é—´
- å†…å­˜ä½¿ç”¨
- CPU ä½¿ç”¨ç‡
- é”™è¯¯ç‡
- ç”¨æˆ·åé¦ˆ

---

## ä¸‹ä¸€æ­¥

å®Œæˆä¸­ç¯‡åï¼Œè¿›å…¥ä¸‹ç¯‡ï¼š**ä¼˜åŒ–å’Œå®Œå–„**

é¢„è§ˆä¸‹ç¯‡æ ¸å¿ƒä»»åŠ¡ï¼š
1. æ€§èƒ½è°ƒä¼˜
2. ç›‘æ§æŒ‡æ ‡å®Œå–„
3. æ–‡æ¡£å®Œå–„
4. è¿ç»´å·¥å…·å¼€å‘

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å¾…å®æ–½  
**ä¾èµ–**: ä¸Šç¯‡å®Œæˆ  
**é¢„è®¡å¼€å§‹**: ä¸Šç¯‡å®Œæˆå 1-2 å¤©  
**é¢„è®¡å®Œæˆ**: 8-12 ä¸ªå·¥ä½œæ—¥
