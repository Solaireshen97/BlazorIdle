# 日志规范文档

**项目**: BlazorIdle  
**文档版本**: 1.0  
**创建日期**: 2025-10-15  
**适用范围**: BlazorIdle.Server 项目  
**所属阶段**: Phase 5（日志系统设计）

---

## 📋 目录

1. [概述](#概述)
2. [日志级别规范](#日志级别规范)
3. [结构化日志模板](#结构化日志模板)
4. [核心业务日志点](#核心业务日志点)
5. [日志配置](#日志配置)
6. [实施指南](#实施指南)
7. [最佳实践](#最佳实践)
8. [示例代码](#示例代码)

---

## 概述

### 设计原则

本日志规范遵循以下核心原则：

1. **结构化日志** - 使用参数化日志，便于查询和分析
2. **合理分级** - 按重要性和用途正确使用日志级别
3. **性能考虑** - 避免过度日志影响性能
4. **安全意识** - 不记录敏感信息（密码、Token等）
5. **可维护性** - 日志信息清晰、一致、易于理解

### 日志框架

项目使用 Microsoft.Extensions.Logging 框架，支持：
- ✅ 结构化日志（支持参数化）
- ✅ 多种输出目标（控制台、文件、第三方服务）
- ✅ 日志级别过滤
- ✅ 依赖注入集成

---

## 日志级别规范

### 级别定义

| 级别 | 数值 | 用途 | 使用场景 | 示例 |
|------|------|------|----------|------|
| **Trace** | 0 | 最详细追踪 | 开发调试，详细执行路径 | 每个事件的触发时间 |
| **Debug** | 1 | 调试信息 | 开发环境，中间值验证 | 伤害计算的中间步骤 |
| **Information** | 2 | 关键节点 | 生产环境，业务流程标记 | 战斗开始、交易完成 |
| **Warning** | 3 | 异常但可恢复 | 配置缺失、资源不足 | 技能冷却中无法释放 |
| **Error** | 4 | 错误需处理 | 业务逻辑错误、数据异常 | 装备穿戴失败 |
| **Critical** | 5 | 严重致命 | 系统崩溃、数据损坏 | 数据库连接失败 |

### 使用指南

#### Trace - 详细追踪
```csharp
// ❌ 不推荐：生产环境默认关闭，不应依赖
_logger.LogTrace("开始计算...");

// ✅ 推荐：用于调试复杂流程
_logger.LogTrace(
    "战斗事件触发: EventType={EventType}, Time={Time}, Source={Source}",
    eventType,
    triggerTime,
    sourceId
);
```

#### Debug - 调试信息
```csharp
// ✅ 推荐：记录中间计算结果
_logger.LogDebug(
    "伤害计算: Base={Base}, AttackPower={AttackPower}, Final={Final}",
    baseDamage,
    attackPower,
    finalDamage
);

// ✅ 推荐：记录业务状态变化
_logger.LogDebug(
    "装备属性聚合: SlotCount={SlotCount}, TotalStats={TotalStats}",
    slotCount,
    JsonSerializer.Serialize(totalStats)
);
```

#### Information - 关键节点
```csharp
// ✅ 推荐：业务流程的开始和结束
_logger.LogInformation(
    "开始战斗: CharacterId={CharacterId}, EnemyId={EnemyId}, Mode={Mode}",
    characterId,
    enemyId,
    battleMode
);

_logger.LogInformation(
    "战斗结束: Duration={Duration}s, Victory={Victory}, Rewards={Rewards}",
    duration.TotalSeconds,
    isVictory,
    rewardCount
);

// ✅ 推荐：重要的状态变更
_logger.LogInformation(
    "角色升级: CharacterId={CharacterId}, OldLevel={OldLevel}, NewLevel={NewLevel}",
    characterId,
    oldLevel,
    newLevel
);
```

#### Warning - 异常情况
```csharp
// ✅ 推荐：可恢复的异常情况
_logger.LogWarning(
    "技能冷却中: SkillId={SkillId}, RemainingCooldown={Remaining}s",
    skillId,
    remainingCooldown
);

// ✅ 推荐：配置缺失但有默认值
_logger.LogWarning(
    "配置项缺失，使用默认值: Key={Key}, DefaultValue={DefaultValue}",
    configKey,
    defaultValue
);
```

#### Error - 错误需处理
```csharp
// ✅ 推荐：捕获的异常
_logger.LogError(
    ex,
    "装备穿戴失败: CharacterId={CharacterId}, EquipmentId={EquipmentId}",
    characterId,
    equipmentId
);

// ✅ 推荐：业务规则违反
_logger.LogError(
    "非法操作: 尝试装备错误职业的装备, CharacterId={CharacterId}, EquipmentId={EquipmentId}",
    characterId,
    equipmentId
);
```

#### Critical - 严重致命
```csharp
// ✅ 推荐：系统级致命错误
_logger.LogCritical(
    ex,
    "数据库连接失败: ConnectionString={ConnectionString}",
    connectionStringMasked  // 注意：遮蔽敏感信息
);
```

---

## 结构化日志模板

### 基本模板

#### 服务入口日志
```csharp
_logger.LogInformation(
    "开始处理 {Operation}，参数: CharacterId={CharacterId}, Param1={Param1}",
    operationName,
    characterId,
    param1
);
```

#### 服务出口日志
```csharp
_logger.LogInformation(
    "完成处理 {Operation}，耗时: {ElapsedMs}ms, 结果: {Result}",
    operationName,
    elapsed.TotalMilliseconds,
    result
);
```

#### 业务逻辑日志
```csharp
_logger.LogDebug(
    "计算 {Calculation}: Input={Input}, Multiplier={Multiplier}, Output={Output}",
    calculationType,
    inputValue,
    multiplier,
    outputValue
);
```

#### 错误处理日志
```csharp
_logger.LogError(
    ex,
    "处理 {Operation} 失败，参数: CharacterId={CharacterId}, Reason={Reason}",
    operationName,
    characterId,
    ex.Message
);
```

### 命名约定

#### 参数命名规范

| 类型 | 命名格式 | 示例 |
|------|----------|------|
| 实体ID | `{Entity}Id` | CharacterId, EquipmentId |
| 计数 | `{Entity}Count` | EventCount, RewardCount |
| 持续时间 | `{Action}Duration` / `Elapsed{Unit}` | BattleDuration, ElapsedMs |
| 状态 | `Is{State}` / `Has{Feature}` | IsVictory, HasRewards |
| 操作名 | `Operation` | "购买装备", "战斗结算" |

#### 日志消息格式

```csharp
// ✅ 推荐：清晰的操作描述 + 结构化参数
_logger.LogInformation(
    "角色购买商品: CharacterId={CharacterId}, ItemId={ItemId}, Quantity={Quantity}, Cost={Cost}",
    characterId, itemId, quantity, cost
);

// ❌ 不推荐：字符串拼接，难以解析
_logger.LogInformation($"角色{characterId}购买了{quantity}个{itemId}，花费{cost}金币");
```

---

## 核心业务日志点

### 1. 战斗系统（BattleEngine）

#### 1.1 战斗生命周期

```csharp
// 战斗开始
_logger.LogInformation(
    "战斗开始: CharacterId={CharacterId}, EnemyId={EnemyId}, EnemyLevel={EnemyLevel}, Mode={Mode}",
    characterId, enemyId, enemyLevel, battleMode
);

// 波次切换
_logger.LogInformation(
    "波次切换: BattleId={BattleId}, OldWave={OldWave}, NewWave={NewWave}, TotalWaves={TotalWaves}",
    battleId, oldWave, newWave, totalWaves
);

// 战斗结束
_logger.LogInformation(
    "战斗结束: BattleId={BattleId}, Duration={Duration}s, Victory={Victory}, EventCount={EventCount}",
    battleId, duration.TotalSeconds, isVictory, eventCount
);
```

#### 1.2 战斗事件

```csharp
// 角色死亡（Information）
_logger.LogInformation(
    "角色死亡: CharacterId={CharacterId}, BattleTime={BattleTime}s, WaveNumber={WaveNumber}",
    characterId, battleTime, waveNumber
);

// 角色复活（Information）
_logger.LogInformation(
    "角色复活: CharacterId={CharacterId}, ReviveTime={ReviveTime}s",
    characterId, reviveTime
);

// 技能释放（Debug）
_logger.LogDebug(
    "技能释放: SkillId={SkillId}, CasterId={CasterId}, TargetCount={TargetCount}, Time={Time}s",
    skillId, casterId, targetCount, battleTime
);

// 伤害计算（Trace）
_logger.LogTrace(
    "伤害计算: AttackerId={AttackerId}, TargetId={TargetId}, BaseDamage={BaseDamage}, FinalDamage={FinalDamage}",
    attackerId, targetId, baseDamage, finalDamage
);
```

### 2. 经济系统（RewardGrantService）

```csharp
// 奖励发放开始
_logger.LogInformation(
    "开始发放奖励: CharacterId={CharacterId}, RewardType={RewardType}, Source={Source}",
    characterId, rewardType, source
);

// 金币变更
_logger.LogInformation(
    "金币变更: CharacterId={CharacterId}, Delta={Delta}, NewBalance={NewBalance}, Source={Source}",
    characterId, goldDelta, newBalance, source
);

// 经验变更
_logger.LogInformation(
    "经验变更: CharacterId={CharacterId}, Delta={Delta}, NewExp={NewExp}, LevelUp={LevelUp}",
    characterId, expDelta, newExp, levelUp
);

// 幂等性检查
_logger.LogWarning(
    "重复奖励请求: CharacterId={CharacterId}, RewardId={RewardId}, 已忽略",
    characterId, rewardId
);
```

### 3. 装备系统（EquipmentService）

```csharp
// 装备穿戴
_logger.LogInformation(
    "装备穿戴: CharacterId={CharacterId}, EquipmentId={EquipmentId}, Slot={Slot}",
    characterId, equipmentId, slot
);

// 装备卸下
_logger.LogInformation(
    "装备卸下: CharacterId={CharacterId}, EquipmentId={EquipmentId}, Slot={Slot}",
    characterId, equipmentId, slot
);

// 装备分解
_logger.LogInformation(
    "装备分解: CharacterId={CharacterId}, EquipmentId={EquipmentId}, MaterialsGained={MaterialsGained}",
    characterId, equipmentId, materialsCount
);

// 装备重铸
_logger.LogInformation(
    "装备重铸: CharacterId={CharacterId}, EquipmentId={EquipmentId}, Cost={Cost}, Success={Success}",
    characterId, equipmentId, cost, success
);

// 属性计算（Debug）
_logger.LogDebug(
    "属性聚合: CharacterId={CharacterId}, EquippedCount={EquippedCount}, TotalAttack={TotalAttack}",
    characterId, equippedCount, totalAttack
);

// 验证失败（Warning）
_logger.LogWarning(
    "装备验证失败: CharacterId={CharacterId}, EquipmentId={EquipmentId}, Reason={Reason}",
    characterId, equipmentId, failureReason
);
```

### 4. 活动计划系统（ActivityPlansController）

```csharp
// 计划创建
_logger.LogInformation(
    "活动计划创建: CharacterId={CharacterId}, PlanId={PlanId}, ActivityType={ActivityType}",
    characterId, planId, activityType
);

// 计划执行开始
_logger.LogInformation(
    "活动开始执行: PlanId={PlanId}, CharacterId={CharacterId}, ActivityType={ActivityType}",
    planId, characterId, activityType
);

// 计划执行完成
_logger.LogInformation(
    "活动执行完成: PlanId={PlanId}, Duration={Duration}s, Outcome={Outcome}",
    planId, duration.TotalSeconds, outcome
);

// 离线结算
_logger.LogInformation(
    "离线结算: CharacterId={CharacterId}, OfflineDuration={OfflineDuration}min, RewardsGranted={RewardsGranted}",
    characterId, offlineDuration.TotalMinutes, rewardsCount
);
```

### 5. 用户认证（AuthController）

```csharp
// 登录成功
_logger.LogInformation(
    "用户登录成功: Username={Username}, IpAddress={IpAddress}",
    username, ipAddress
);

// 登录失败
_logger.LogWarning(
    "用户登录失败: Username={Username}, Reason={Reason}, IpAddress={IpAddress}",
    username, failureReason, ipAddress
);

// Token生成
_logger.LogDebug(
    "生成JWT Token: UserId={UserId}, ExpiresIn={ExpiresIn}min",
    userId, expiresInMinutes
);

// 权限验证失败
_logger.LogWarning(
    "权限验证失败: UserId={UserId}, RequiredRole={RequiredRole}, Action={Action}",
    userId, requiredRole, action
);
```

---

## 日志配置

### appsettings.json 配置示例

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information",
      "Microsoft.AspNetCore": "Warning",
      "BlazorIdle.Server.Domain.Combat": "Debug",
      "BlazorIdle.Server.Domain.Equipment": "Information",
      "BlazorIdle.Server.Api": "Information"
    }
  }
}
```

### 开发环境配置

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "BlazorIdle.Server": "Trace"
    }
  }
}
```

### 生产环境配置

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "BlazorIdle.Server.Domain.Combat.Engine": "Information",
      "BlazorIdle.Server.Domain.Combat.Events": "Warning"
    }
  }
}
```

---

## 实施指南

### 添加日志的步骤

1. **注入ILogger**
```csharp
public class BattleEngine
{
    private readonly ILogger<BattleEngine> _logger;
    
    public BattleEngine(ILogger<BattleEngine> logger)
    {
        _logger = logger;
    }
}
```

2. **确定日志点位置**
   - 服务方法入口和出口
   - 关键业务逻辑节点
   - 异常处理代码块
   - 性能敏感操作

3. **选择合适的级别**
   - 参考[日志级别规范](#日志级别规范)
   - 考虑生产环境的日志量

4. **编写结构化日志**
   - 使用参数化格式
   - 遵循命名约定
   - 包含足够的上下文信息

5. **测试日志输出**
   - 在开发环境验证
   - 检查日志格式和内容
   - 确认性能影响可接受

---

## 最佳实践

### DO - 推荐做法

✅ **使用结构化日志**
```csharp
_logger.LogInformation(
    "订单创建: OrderId={OrderId}, Amount={Amount}",
    orderId, amount
);
```

✅ **记录关键业务节点**
```csharp
_logger.LogInformation("战斗开始: ...");
// 业务逻辑
_logger.LogInformation("战斗结束: ...");
```

✅ **异常时记录上下文**
```csharp
try
{
    // 操作
}
catch (Exception ex)
{
    _logger.LogError(
        ex,
        "操作失败: CharacterId={CharacterId}, Operation={Operation}",
        characterId, operationName
    );
    throw;
}
```

✅ **使用条件日志减少性能影响**
```csharp
if (_logger.IsEnabled(LogLevel.Debug))
{
    var detailedInfo = ComputeExpensiveInfo();
    _logger.LogDebug("详细信息: {Info}", detailedInfo);
}
```

### DON'T - 避免做法

❌ **不要记录敏感信息**
```csharp
// ❌ 不推荐
_logger.LogInformation("用户登录: Password={Password}", password);

// ✅ 推荐
_logger.LogInformation("用户登录: Username={Username}", username);
```

❌ **不要使用字符串插值**
```csharp
// ❌ 不推荐：无法解析结构化数据
_logger.LogInformation($"用户{userId}购买了{itemId}");

// ✅ 推荐：结构化参数
_logger.LogInformation("用户购买: UserId={UserId}, ItemId={ItemId}", userId, itemId);
```

❌ **不要过度日志**
```csharp
// ❌ 不推荐：循环中的大量日志
foreach (var item in largeList)
{
    _logger.LogInformation("处理: {Item}", item);  // 可能数千条
}

// ✅ 推荐：汇总日志
_logger.LogInformation("批量处理: ItemCount={Count}", largeList.Count);
```

❌ **不要在热路径记录Debug日志**
```csharp
// ❌ 不推荐：高频调用
public double CalculateDamage(...)
{
    _logger.LogDebug("计算伤害..."); // 每秒可能调用数百次
    return damage;
}

// ✅ 推荐：仅在必要时记录
public double CalculateDamage(...)
{
    var damage = Calculate();
    if (_logger.IsEnabled(LogLevel.Trace))  // 生产环境默认关闭
    {
        _logger.LogTrace("伤害计算: ...");
    }
    return damage;
}
```

---

## 示例代码

### 完整服务类示例

```csharp
using Microsoft.Extensions.Logging;

namespace BlazorIdle.Server.Domain.Equipment.Services
{
    /// <summary>
    /// 装备服务 - 包含结构化日志示例
    /// </summary>
    public class EquipmentService
    {
        private readonly ILogger<EquipmentService> _logger;
        private readonly IEquipmentRepository _repository;
        
        public EquipmentService(
            ILogger<EquipmentService> logger,
            IEquipmentRepository repository)
        {
            _logger = logger;
            _repository = repository;
        }
        
        /// <summary>
        /// 装备穿戴
        /// </summary>
        public async Task<bool> EquipAsync(Guid characterId, Guid equipmentId, EquipmentSlot slot)
        {
            _logger.LogInformation(
                "开始装备穿戴: CharacterId={CharacterId}, EquipmentId={EquipmentId}, Slot={Slot}",
                characterId, equipmentId, slot
            );
            
            try
            {
                // 验证
                var equipment = await _repository.GetByIdAsync(equipmentId);
                if (equipment == null)
                {
                    _logger.LogWarning(
                        "装备不存在: EquipmentId={EquipmentId}",
                        equipmentId
                    );
                    return false;
                }
                
                _logger.LogDebug(
                    "装备验证通过: EquipmentId={EquipmentId}, Type={Type}, Level={Level}",
                    equipmentId, equipment.Type, equipment.Level
                );
                
                // 执行装备
                await _repository.EquipToSlotAsync(characterId, equipmentId, slot);
                
                _logger.LogInformation(
                    "装备穿戴成功: CharacterId={CharacterId}, EquipmentId={EquipmentId}, Slot={Slot}",
                    characterId, equipmentId, slot
                );
                
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(
                    ex,
                    "装备穿戴失败: CharacterId={CharacterId}, EquipmentId={EquipmentId}, Slot={Slot}",
                    characterId, equipmentId, slot
                );
                throw;
            }
        }
    }
}
```

---

## 附录

### 参考资料

1. [Microsoft.Extensions.Logging 官方文档](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/)
2. [Structured Logging 最佳实践](https://stackify.com/what-is-structured-logging-and-why-developers-need-it/)
3. [服务端代码优化方案](./服务端代码优化方案.md) - Phase 5 详细说明

### 变更历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| 1.0 | 2025-10-15 | 开发团队 | 初始版本 - Phase 5 日志规范 |

---

**文档状态**: ✅ 已完成  
**审核状态**: 待审核

*本文档是《服务端代码优化方案》Phase 5 的核心交付物*
