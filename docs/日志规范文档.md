# 日志规范文档

**项目**: BlazorIdle  
**文档版本**: 1.0  
**创建日期**: 2025-10-15  
**状态**: 规范定义

---

## 📋 目录

1. [概述](#概述)
2. [日志级别规范](#日志级别规范)
3. [结构化日志标准](#结构化日志标准)
4. [日志模板](#日志模板)
5. [核心业务流程日志规范](#核心业务流程日志规范)
6. [日志配置](#日志配置)
7. [日志查询](#日志查询)
8. [最佳实践](#最佳实践)

---

## 概述

### 目的

本文档定义 BlazorIdle 项目的日志规范，确保：
1. 日志信息完整、有价值
2. 日志格式统一、易于查询
3. 日志级别使用恰当
4. 日志覆盖关键业务流程

### 适用范围

- BlazorIdle.Server 所有服务端代码
- API Controllers
- Application Services
- Domain Services
- Background Services

---

## 日志级别规范

### 级别定义

| 级别 | 用途 | 使用场景 | 示例 |
|------|------|----------|------|
| **Trace** | 详细追踪 | 开发调试，追踪每个步骤 | 战斗每个事件的详细信息 |
| **Debug** | 调试信息 | 开发调试，中间变量值 | 伤害计算的中间结果 |
| **Information** | 关键节点 | 生产环境，重要业务节点 | 战斗开始/结束、交易完成 |
| **Warning** | 异常情况 | 可恢复的异常情况 | 资源不足、配置缺失（有默认值）|
| **Error** | 错误 | 业务逻辑错误、数据库错误 | 参数验证失败、数据库查询失败 |
| **Critical** | 致命错误 | 系统崩溃、数据损坏 | 数据库连接失败、关键服务不可用 |

### 使用原则

1. **生产环境默认级别**: Information
2. **开发环境默认级别**: Debug
3. **性能考虑**: Trace 和 Debug 日志不应在生产环境频繁输出
4. **安全考虑**: 不记录敏感信息（密码、Token等）

---

## 结构化日志标准

### 基本格式

使用结构化日志，方便查询和分析：

```csharp
// ✅ 正确 - 使用结构化参数
_logger.LogInformation(
    "用户 {UserId} 完成战斗 {BattleId}，耗时 {Duration}ms",
    userId,
    battleId,
    duration
);

// ❌ 错误 - 使用字符串插值
_logger.LogInformation($"用户 {userId} 完成战斗 {battleId}");
```

### 参数命名规范

1. **使用PascalCase**: `{UserId}`, `{CharacterId}`, `{Amount}`
2. **语义明确**: `{Duration}` 而不是 `{Time}`
3. **包含单位**: `{DurationMs}`, `{AmountGold}`
4. **避免缩写**: `{CharacterId}` 而不是 `{CharId}`

---

## 日志模板

### 服务入口日志

```csharp
_logger.LogInformation(
    "开始 {Operation}，参数: CharacterId={CharacterId}, UserId={UserId}",
    "装备穿戴",
    characterId,
    userId
);
```

### 服务出口日志

```csharp
_logger.LogInformation(
    "完成 {Operation}，结果: Success={Success}, Duration={DurationMs}ms",
    "装备穿戴",
    result.IsSuccess,
    stopwatch.ElapsedMilliseconds
);
```

### 业务逻辑日志

```csharp
_logger.LogDebug(
    "计算伤害: BaseDamage={BaseDamage}, Defense={Defense}, FinalDamage={FinalDamage}",
    baseDamage,
    defense,
    finalDamage
);
```

### 错误日志

```csharp
_logger.LogError(
    ex,
    "处理 {Operation} 失败，CharacterId={CharacterId}, Reason={Reason}",
    "装备穿戴",
    characterId,
    ex.Message
);
```

### 性能日志

```csharp
_logger.LogInformation(
    "战斗结算完成，BattleId={BattleId}, EventCount={EventCount}, Duration={DurationMs}ms",
    battleId,
    eventCount,
    stopwatch.ElapsedMilliseconds
);
```

### 警告日志

```csharp
_logger.LogWarning(
    "配置项 {ConfigKey} 缺失，使用默认值 {DefaultValue}",
    configKey,
    defaultValue
);
```

---

## 核心业务流程日志规范

### 战斗系统

#### 必需日志点（Information）

1. **战斗开始**
```csharp
_logger.LogInformation(
    "战斗开始，BattleId={BattleId}, CharacterId={CharacterId}, EnemyId={EnemyId}",
    battleId,
    characterId,
    enemyId
);
```

2. **战斗结束**
```csharp
_logger.LogInformation(
    "战斗结束，BattleId={BattleId}, Result={Result}, Duration={DurationSeconds}s, EventCount={EventCount}",
    battleId,
    result,
    duration,
    eventCount
);
```

3. **波次切换**
```csharp
_logger.LogInformation(
    "波次切换，BattleId={BattleId}, CurrentWave={CurrentWave}, NextEnemy={NextEnemy}",
    battleId,
    currentWave,
    nextEnemy
);
```

4. **角色死亡/复活**
```csharp
_logger.LogInformation(
    "角色死亡，BattleId={BattleId}, CharacterId={CharacterId}, Time={Time}s",
    battleId,
    characterId,
    time
);
```

#### 调试日志点（Debug）

1. **技能释放**
```csharp
_logger.LogDebug(
    "技能释放，BattleId={BattleId}, SkillId={SkillId}, Cost={Cost}, Cooldown={Cooldown}s",
    battleId,
    skillId,
    cost,
    cooldown
);
```

2. **Buff应用/移除**
```csharp
_logger.LogDebug(
    "Buff变更，BattleId={BattleId}, BuffId={BuffId}, Action={Action}, Stacks={Stacks}",
    battleId,
    buffId,
    action,
    stacks
);
```

### 经济系统

#### 必需日志点（Information）

1. **奖励发放**
```csharp
_logger.LogInformation(
    "奖励发放，CharacterId={CharacterId}, Source={Source}, Gold={Gold}, Exp={Exp}",
    characterId,
    source,
    gold,
    exp
);
```

2. **金币变更**
```csharp
_logger.LogInformation(
    "金币变更，CharacterId={CharacterId}, Amount={Amount}, Source={Source}, Balance={Balance}",
    characterId,
    amount,
    source,
    balance
);
```

3. **经济事件记录**
```csharp
_logger.LogInformation(
    "经济事件，CharacterId={CharacterId}, EventType={EventType}, Amount={Amount}",
    characterId,
    eventType,
    amount
);
```

#### 调试日志点（Debug）

1. **幂等性检查**
```csharp
_logger.LogDebug(
    "幂等性检查，EventId={EventId}, Exists={Exists}",
    eventId,
    exists
);
```

### 装备系统

#### 必需日志点（Information）

1. **装备穿戴/卸下**
```csharp
_logger.LogInformation(
    "装备穿戴，CharacterId={CharacterId}, GearId={GearId}, Slot={Slot}",
    characterId,
    gearId,
    slot
);
```

2. **装备分解**
```csharp
_logger.LogInformation(
    "装备分解，CharacterId={CharacterId}, GearId={GearId}, Materials={Materials}",
    characterId,
    gearId,
    materials
);
```

3. **装备重铸**
```csharp
_logger.LogInformation(
    "装备重铸，CharacterId={CharacterId}, GearId={GearId}, Result={Result}, NewTier={NewTier}",
    characterId,
    gearId,
    result,
    newTier
);
```

### 活动计划系统

#### 必需日志点（Information）

1. **计划创建/更新/删除**
```csharp
_logger.LogInformation(
    "活动计划变更，Action={Action}, PlanId={PlanId}, CharacterId={CharacterId}, Type={Type}",
    action,
    planId,
    characterId,
    planType
);
```

2. **计划执行开始/结束**
```csharp
_logger.LogInformation(
    "活动计划执行，Action={Action}, PlanId={PlanId}, Duration={Duration}",
    action,
    planId,
    duration
);
```

3. **离线结算**
```csharp
_logger.LogInformation(
    "离线结算，CharacterId={CharacterId}, OfflineDuration={Duration}s, Plans={PlansCompleted}",
    characterId,
    duration,
    plansCompleted
);
```

### API层

#### 必需日志点（Information）

1. **请求入口**
```csharp
_logger.LogInformation(
    "API请求，Endpoint={Endpoint}, Method={Method}, UserId={UserId}",
    endpoint,
    method,
    userId
);
```

2. **请求出口**
```csharp
_logger.LogInformation(
    "API响应，Endpoint={Endpoint}, StatusCode={StatusCode}, Duration={DurationMs}ms",
    endpoint,
    statusCode,
    duration
);
```

#### 警告日志点（Warning）

1. **参数验证失败**
```csharp
_logger.LogWarning(
    "参数验证失败，Endpoint={Endpoint}, Parameter={Parameter}, Reason={Reason}",
    endpoint,
    parameter,
    reason
);
```

#### 错误日志点（Error）

1. **异常处理**
```csharp
_logger.LogError(
    ex,
    "API异常，Endpoint={Endpoint}, Method={Method}, UserId={UserId}",
    endpoint,
    method,
    userId
);
```

---

## 日志配置

### appsettings.json

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information",
      "Microsoft.EntityFrameworkCore": "Warning",
      "BlazorIdle": "Debug"
    }
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning",
        "BlazorIdle": "Debug"
      }
    },
    "WriteTo": [
      {
        "Name": "Console",
        "Args": {
          "outputTemplate": "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}"
        }
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/blazoridle-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30,
          "outputTemplate": "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} [{Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}"
        }
      }
    ]
  }
}
```

### 开发环境配置

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "BlazorIdle": "Trace"
    }
  }
}
```

### 生产环境配置

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "BlazorIdle": "Information"
    }
  }
}
```

---

## 日志查询

### 基本查询

```bash
# 查看今天的日志
cat logs/blazoridle-$(date +%Y%m%d).log

# 查看错误日志
grep -i "error" logs/blazoridle-*.log

# 查看特定用户的日志
grep "UserId=abc123" logs/blazoridle-*.log
```

### 结构化查询（使用工具）

如果使用 ELK 或其他日志聚合工具：

```
# 查询特定操作的日志
Operation: "装备穿戴" AND CharacterId: "xxx"

# 查询慢请求
DurationMs > 1000

# 查询错误率
Level: "Error" | stats count() by Endpoint
```

---

## 最佳实践

### DO（推荐做法）

1. ✅ **使用结构化日志**
```csharp
_logger.LogInformation("用户 {UserId} 完成操作 {Operation}", userId, operation);
```

2. ✅ **记录关键上下文**
```csharp
_logger.LogInformation(
    "战斗结束，BattleId={BattleId}, Result={Result}, Duration={Duration}",
    battleId, result, duration
);
```

3. ✅ **在异常处理中记录完整信息**
```csharp
catch (Exception ex)
{
    _logger.LogError(ex, "操作 {Operation} 失败", operation);
    throw;
}
```

4. ✅ **记录性能关键节点**
```csharp
var sw = Stopwatch.StartNew();
// ... 业务逻辑 ...
sw.Stop();
_logger.LogInformation("操作耗时 {Duration}ms", sw.ElapsedMilliseconds);
```

### DON'T（不推荐做法）

1. ❌ **不要使用字符串插值**
```csharp
// 错误
_logger.LogInformation($"用户 {userId} 完成操作");
```

2. ❌ **不要记录敏感信息**
```csharp
// 错误
_logger.LogInformation("密码: {Password}", password);
```

3. ❌ **不要过度日志**
```csharp
// 错误 - 循环内的 Information 日志
foreach (var item in items)
{
    _logger.LogInformation("处理项 {Item}", item); // 应使用 Debug
}
```

4. ❌ **不要吞掉异常**
```csharp
// 错误
catch (Exception ex)
{
    _logger.LogError("操作失败");
    // 缺少异常对象和上下文
}
```

### 性能考虑

1. **避免在高频循环中使用 Information 日志**
```csharp
// ❌ 错误
foreach (var event in events) // 可能有数千个事件
{
    _logger.LogInformation("事件 {EventId}", event.Id);
}

// ✅ 正确
_logger.LogDebug("处理 {Count} 个事件", events.Count);
foreach (var event in events)
{
    _logger.LogTrace("事件详情 {EventId}", event.Id);
}
```

2. **使用日志作用域**
```csharp
using (_logger.BeginScope("BattleId={BattleId}", battleId))
{
    _logger.LogInformation("战斗开始");
    // ... 所有日志自动包含 BattleId
    _logger.LogInformation("战斗结束");
}
```

---

## 附录

### A. 日志级别决策树

```
是否需要在生产环境看到？
├─ 是 → Information
│  ├─ 是否是错误？
│  │  ├─ 是 → Error/Critical
│  │  └─ 否 → Information
│  └─ 是否是警告？
│     ├─ 是 → Warning
│     └─ 否 → Information
└─ 否 → Debug/Trace
   ├─ 是否是详细追踪？
   │  ├─ 是 → Trace
   │  └─ 否 → Debug
   └─ 仅开发调试
```

### B. 常见场景日志模板

```csharp
// 1. 服务方法入口
_logger.LogInformation("开始 {Method}, Params={Params}", nameof(MethodName), params);

// 2. 服务方法出口
_logger.LogInformation("完成 {Method}, Result={Result}, Duration={Duration}ms", 
    nameof(MethodName), result, sw.ElapsedMilliseconds);

// 3. 数据库操作
_logger.LogDebug("执行查询 {Query}, Params={Params}", query, params);

// 4. 外部服务调用
_logger.LogInformation("调用外部服务 {Service}, Endpoint={Endpoint}", service, endpoint);

// 5. 缓存操作
_logger.LogDebug("缓存操作 {Operation}, Key={Key}, Hit={Hit}", operation, key, hit);

// 6. 配置加载
_logger.LogInformation("加载配置 {ConfigSection}, Source={Source}", section, source);
```

---

**文档状态**: ✅ 规范定义完成  
**版本**: 1.0  
**最后更新**: 2025-10-15
