# BlazorIdle å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸Šç¯‡ï¼‰
## æ¶æ„è®¾è®¡ä¸æ ¸å¿ƒåŠŸèƒ½

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç±»å‹**: è®¾è®¡æ–¹æ¡ˆ - ä¸Šç¯‡  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**ä½œè€…**: ç³»ç»Ÿæ¶æ„å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [è®¾è®¡æ¦‚è¿°](#1-è®¾è®¡æ¦‚è¿°)
2. [éœ€æ±‚åˆ†æ](#2-éœ€æ±‚åˆ†æ)
3. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#3-ç³»ç»Ÿæ¶æ„è®¾è®¡)
4. [æ ¸å¿ƒé¢†åŸŸæ¨¡å‹](#4-æ ¸å¿ƒé¢†åŸŸæ¨¡å‹)
5. [å•†åº—ç±»å‹è®¾è®¡](#5-å•†åº—ç±»å‹è®¾è®¡)
6. [äº¤æ˜“è´§å¸ç³»ç»Ÿ](#6-äº¤æ˜“è´§å¸ç³»ç»Ÿ)
7. [æ¡ä»¶è§£é”é›†æˆ](#7-æ¡ä»¶è§£é”é›†æˆ)

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 èƒŒæ™¯ä¸ç›®æ ‡

æ ¹æ®é¡¹ç›®æ•´åˆè®¾è®¡æ€»ç»“å’Œè£…å¤‡ç³»ç»Ÿæ–‡æ¡£ï¼ŒBlazorIdle å½“å‰å·²ç»å…·å¤‡ï¼š
- âœ… å®Œå–„çš„æˆ˜æ–—ç³»ç»Ÿï¼ˆåŒè½¨æœºåˆ¶ã€æŠ€èƒ½ç³»ç»Ÿï¼‰
- âœ… ç»æµç³»ç»ŸåŸºç¡€ï¼ˆEconomyRegistryã€æ‰è½è¡¨ã€ç‰©å“å®šä¹‰ï¼‰
- âœ… è£…å¤‡ç³»ç»Ÿæ¡†æ¶ï¼ˆè£…å¤‡å®ä¾‹ã€è¯æ¡ã€å“çº§ï¼‰
- âœ… èƒŒåŒ…ç³»ç»Ÿï¼ˆInventoryItemï¼‰
- âœ… è§’è‰²ç³»ç»Ÿï¼ˆå±æ€§ã€ç­‰çº§ã€èŒä¸šï¼‰
- âš ï¸ æ¡ä»¶è§£é”DSLï¼ˆè®¾è®¡ä¸­ï¼Œå¾…å®æ–½ï¼‰

**å•†åº—ç³»ç»Ÿç›®æ ‡**ï¼š
1. **è¦†ç›–æ¸¸æˆè®¾è®¡ä¸­çš„å¤§éƒ¨åˆ†åŠŸèƒ½éœ€æ±‚**
   - æ”¯æŒæ¶ˆè€—å“è´­ä¹°ï¼ˆé£Ÿç‰©ã€è¯å‰‚ï¼‰
   - æ”¯æŒè£…å¤‡è´­ä¹°ï¼ˆå„å“è´¨ã€å„æ§½ä½ï¼‰
   - æ”¯æŒææ–™è´­ä¹°ï¼ˆåˆ¶ä½œææ–™ã€å¼ºåŒ–ææ–™ï¼‰
   - æ”¯æŒç‰¹æ®Šç‰©å“äº¤æ˜“ï¼ˆä»»åŠ¡é“å…·ã€ç¨€æœ‰ææ–™ï¼‰

2. **æ”¯æŒéé‡‘å¸äº¤æ˜“æœºåˆ¶**
   - å£°æœ›è´§å¸ï¼ˆæ´¾ç³»å£°æœ›ç‚¹æ•°ï¼‰
   - è£èª‰è´§å¸ï¼ˆPvP/æŒ‘æˆ˜è·å¾—ï¼‰
   - ç‰¹æ®Šä»£å¸ï¼ˆæ´»åŠ¨ã€æˆå°±å¥–åŠ±ï¼‰
   - å¤šè´§å¸ç»„åˆäº¤æ˜“

3. **é€‚é…æ¡ä»¶è§£é”ç³»ç»Ÿ**
   - å•†åº—è§£é”æ¡ä»¶ï¼ˆç­‰çº§ã€ä»»åŠ¡ã€å£°æœ›ï¼‰
   - å•†å“è§£é”æ¡ä»¶ï¼ˆè¿›åº¦ã€æˆå°±ï¼‰
   - é™è´­æœºåˆ¶ï¼ˆæ—¥é™è´­ã€å‘¨é™è´­ã€ç»ˆèº«é™è´­ï¼‰
   - åˆ·æ–°æœºåˆ¶ï¼ˆå›ºå®šåº“å­˜ã€å®šæ—¶åˆ·æ–°ï¼‰

4. **ä¸ºæœªæ¥æ‰©å±•é¢„ç•™æ¥å£**
   - åŠ¨æ€å®šä»·ç³»ç»Ÿ
   - æ‹å–è¡Œç³»ç»Ÿ
   - ç©å®¶é—´äº¤æ˜“
   - é»‘å¸‚/é™æ—¶å•†åº—

### 1.2 è®¾è®¡åŸåˆ™

åŸºäºé¡¹ç›®ã€Šæ•´åˆè®¾è®¡æ€»ç»“.txtã€‹ç¬¬3èŠ‚"æ¶æ„ä¸å·¥ç¨‹åŸåˆ™"ï¼š

1. **æœåŠ¡ç«¯æƒå¨ (Server Authoritative)**
   - æ‰€æœ‰äº¤æ˜“åœ¨æœåŠ¡ç«¯éªŒè¯å’Œæ‰§è¡Œ
   - ä»·æ ¼è®¡ç®—ã€åº“å­˜æ£€æŸ¥æœåŠ¡ç«¯å®Œæˆ
   - é˜²æ­¢å®¢æˆ·ç«¯ä½œå¼Šå’Œä»·æ ¼æ“æ§

2. **æ•°æ®é©±åŠ¨ (Data-Driven)**
   - å•†åº—å®šä¹‰é…ç½®åŒ–ï¼ˆJSON/æ•°æ®è¡¨ï¼‰
   - å•†å“é…ç½®åŒ–ï¼ˆä»·æ ¼ã€åº“å­˜ã€åˆ·æ–°è§„åˆ™ï¼‰
   - ä¾¿äºè¿è¥è°ƒæ•´å’Œå†…å®¹æ‰©å±•

3. **äº‹ä»¶é©±åŠ¨ (Event-Driven)**
   - è´­ä¹°äº‹ä»¶ï¼ˆPurchaseCompletedï¼‰
   - åº“å­˜å˜æ›´äº‹ä»¶ï¼ˆStockChangedï¼‰
   - åˆ·æ–°äº‹ä»¶ï¼ˆShopRefreshedï¼‰
   - è§£é”äº‹ä»¶ï¼ˆShopUnlockedï¼‰

4. **é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD)**
   - Shop èšåˆæ ¹ï¼ˆå•†åº—å®ä¾‹ï¼‰
   - ShopItem å€¼å¯¹è±¡ï¼ˆå•†å“é¡¹ï¼‰
   - Transaction å®ä½“ï¼ˆäº¤æ˜“è®°å½•ï¼‰

5. **å¯æµ‹è¯•æ€§ä¸ç›‘æ§**
   - å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
   - äº¤æ˜“å¹‚ç­‰æ€§ä¿è¯
   - ç»æµç›‘æ§æŒ‡æ ‡ï¼ˆè´­ä¹°é¢‘ç‡ã€è´§å¸æµé€šï¼‰

6. **å®‰å…¨æ€§**
   - äº¤æ˜“é™é¢‘ï¼ˆé˜²åˆ·ï¼‰
   - ä»·æ ¼éªŒè¯ï¼ˆé˜²ç¯¡æ”¹ï¼‰
   - åº“å­˜é”å®šï¼ˆå¹¶å‘æ§åˆ¶ï¼‰

### 1.3 ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»

```
å•†åº—ç³»ç»Ÿé›†æˆç‚¹
â”œâ”€â”€ ç»æµç³»ç»Ÿ (Economy)
â”‚   â”œâ”€â”€ EconomyRegistry: ç‰©å“å®šä¹‰æŸ¥è¯¢
â”‚   â”œâ”€â”€ RewardGrantService: ç‰©å“å‘æ”¾åˆ°èƒŒåŒ…
â”‚   â””â”€â”€ EconomyCalculator: æ‰è½/äº§å‡ºè®¡ç®—
â”‚
â”œâ”€â”€ è£…å¤‡ç³»ç»Ÿ (Equipment)
â”‚   â”œâ”€â”€ GearDefinition: è£…å¤‡å®šä¹‰æŸ¥è¯¢
â”‚   â”œâ”€â”€ GearGenerationService: è£…å¤‡å®ä¾‹ç”Ÿæˆ
â”‚   â””â”€â”€ å¯è´­ä¹°è£…å¤‡ç›´æ¥ç”Ÿæˆå®ä¾‹
â”‚
â”œâ”€â”€ èƒŒåŒ…ç³»ç»Ÿ (Inventory)
â”‚   â”œâ”€â”€ InventoryItem: è´­ä¹°åç‰©å“å…¥åº“
â”‚   â””â”€â”€ èƒŒåŒ…å®¹é‡æ£€æŸ¥
â”‚
â”œâ”€â”€ è§’è‰²ç³»ç»Ÿ (Character)
â”‚   â”œâ”€â”€ é‡‘å¸æ‰£é™¤/å¢åŠ 
â”‚   â”œâ”€â”€ ç­‰çº§/èŒä¸šæ£€æŸ¥
â”‚   â””â”€â”€ å£°æœ›å€¼æŸ¥è¯¢
â”‚
â”œâ”€â”€ æ¡ä»¶è§£é”ç³»ç»Ÿ (Unlock) - å¾…å®æ–½
â”‚   â”œâ”€â”€ ConditionExpr: å•†åº—è§£é”æ¡ä»¶
â”‚   â”œâ”€â”€ ConditionCache: æ¡ä»¶ç»“æœç¼“å­˜
â”‚   â””â”€â”€ å•†å“å¯è§æ€§/å¯è´­ä¹°æ€§åˆ¤å®š
â”‚
â””â”€â”€ ä»»åŠ¡/æˆå°±ç³»ç»Ÿ (Future)
    â””â”€â”€ è´­ä¹°ä»»åŠ¡é“å…·ã€æˆå°±å¥–åŠ±å…‘æ¢
```

---

## 2. éœ€æ±‚åˆ†æ

### 2.1 åŠŸèƒ½æ€§éœ€æ±‚

#### 2.1.1 å•†åº—ç±»å‹

| å•†åº—ç±»å‹ | æè¿° | è´§å¸ç±»å‹ | åˆ·æ–°æœºåˆ¶ | ä¼˜å…ˆçº§ |
|---------|------|---------|---------|--------|
| **æ™®é€šå•†åº—** | åŸºç¡€æ¶ˆè€—å“ã€ä½çº§è£…å¤‡ | é‡‘å¸ | å›ºå®šåº“å­˜ | P1 (é«˜) |
| **è£…å¤‡å•†åº—** | å„å“è´¨è£…å¤‡ã€æ­¦å™¨é˜²å…· | é‡‘å¸ | æ—¥åˆ·æ–° | P1 (é«˜) |
| **ææ–™å•†åº—** | åˆ¶ä½œææ–™ã€å¼ºåŒ–ææ–™ | é‡‘å¸ | å‘¨åˆ·æ–° | P2 (ä¸­) |
| **å£°æœ›å•†åº—** | æ´¾ç³»ä¸“å±ç‰©å“ã€é…æ–¹ | å£°æœ›ç‚¹ | å›ºå®šåº“å­˜ | P2 (ä¸­) |
| **è£èª‰å•†åº—** | æŒ‘æˆ˜å¥–åŠ±ã€ç¨€æœ‰è£…å¤‡ | è£èª‰ç‚¹ | å‘¨åˆ·æ–° | P3 (ä½) |
| **ä»£å¸å•†åº—** | æ´»åŠ¨ä»£å¸å…‘æ¢ | æ´»åŠ¨ä»£å¸ | å›ºå®šåº“å­˜ | P3 (ä½) |
| **é™æ—¶å•†åº—** | é™æ—¶æŠ˜æ‰£ã€ç¨€æœ‰ç‰©å“ | é‡‘å¸+ä»£å¸ | é™æ—¶åˆ·æ–° | P4 (æœªæ¥) |
| **é»‘å¸‚** | ç¦å¿Œç‰©å“ã€é«˜é£é™©é«˜æ”¶ç›Š | ç‰¹æ®Šè´§å¸ | éšæœºåˆ·æ–° | P4 (æœªæ¥) |

#### 2.1.2 å•†å“ç±»å‹

| å•†å“åˆ†ç±» | å­ç±»å‹ | ç¤ºä¾‹ |
|---------|--------|------|
| **æ¶ˆè€—å“** | é£Ÿç‰© | é¢åŒ…(+50HP)ã€è‚‰(+200HP) |
|           | è¯å‰‚ | ç”Ÿå‘½è¯æ°´ã€æ³•åŠ›è¯æ°´ã€å¢ç›Šè¯å‰‚ |
|           | å·è½´ | ä¼ é€å·ã€é‰´å®šå· |
| **è£…å¤‡** | æ­¦å™¨ | å‰‘ã€æ–§ã€æ³•æ–ã€å¼“ |
|         | é˜²å…· | å¤´ç›”ã€èƒ¸ç”²ã€è…¿ç”²ã€é´å­ |
|         | é¥°å“ | æˆ’æŒ‡ã€é¡¹é“¾ |
| **ææ–™** | åˆ¶ä½œææ–™ | é“çŸ¿ã€å¸ƒæ–™ã€æœ¨æ |
|         | å¼ºåŒ–ææ–™ | ç£¨åˆ€çŸ³ã€é™„é­”ç²‰å°˜ |
|         | åˆ†è§£ææ–™ | è£…å¤‡ç¢ç‰‡ã€ç²¾å |
| **ç‰¹æ®Šç‰©å“** | ä»»åŠ¡é“å…· | é’¥åŒ™ã€ä¿¡ä»¶ |
|             | é…æ–¹ | åˆ¶ä½œé…æ–¹ã€é™„é­”é…æ–¹ |
|             | å® ç‰©/åéª‘ | (æœªæ¥æ‰©å±•) |
| **è´§å¸ä»£å¸** | å…‘æ¢åˆ¸ | å•†åº—åˆ·æ–°åˆ¸ã€æŠ˜æ‰£åˆ¸ |
|             | æ´»åŠ¨ä»£å¸ | èŠ‚æ—¥ä»£å¸ã€æˆå°±ä»£å¸ |

#### 2.1.3 æ ¸å¿ƒåŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | åŠŸèƒ½ç‚¹ | æè¿° |
|---------|--------|------|
| **å•†åº—ç®¡ç†** | å•†åº—åˆ›å»º | åŠ¨æ€åˆ›å»ºå•†åº—å®ä¾‹ |
|            | å•†åº—é…ç½® | åç§°ã€å›¾æ ‡ã€è§£é”æ¡ä»¶ |
|            | å•†åº—åˆ·æ–° | å®šæ—¶/æ‰‹åŠ¨åˆ·æ–°åº“å­˜ |
|            | å•†åº—åˆ†ç±» | å•†åº—æ ‡ç­¾ã€æ’åº |
| **å•†å“ç®¡ç†** | å•†å“ä¸Šæ¶ | æ·»åŠ å•†å“åˆ°å•†åº— |
|            | å•†å“å®šä»· | å•/å¤šè´§å¸å®šä»· |
|            | åº“å­˜ç®¡ç† | æ— é™/æœ‰é™åº“å­˜ |
|            | é™è´­ç®¡ç† | æ—¥/å‘¨/ç»ˆèº«é™è´­ |
| **äº¤æ˜“åŠŸèƒ½** | è´­ä¹°å•†å“ | å•æ¬¡è´­ä¹°ã€æ‰¹é‡è´­ä¹° |
|            | è´§å¸æ‰£é™¤ | é‡‘å¸ã€å£°æœ›ã€ä»£å¸ |
|            | ç‰©å“å‘æ”¾ | è‡ªåŠ¨è¿›èƒŒåŒ…/é‚®ä»¶ |
|            | äº¤æ˜“è®°å½• | è´­ä¹°å†å²ã€ç»Ÿè®¡ |
| **æ¡ä»¶ç³»ç»Ÿ** | å•†åº—è§£é” | ç­‰çº§ã€ä»»åŠ¡ã€å£°æœ›æ¡ä»¶ |
|            | å•†å“è§£é” | è¿›åº¦ã€æˆå°±æ¡ä»¶ |
|            | å¯è§æ€§æ§åˆ¶ | æœªè§£é”å•†å“éšè—/ç°æ˜¾ |
| **æ‰©å±•åŠŸèƒ½** | æŠ˜æ‰£ç³»ç»Ÿ | VIPæŠ˜æ‰£ã€æ´»åŠ¨æŠ˜æ‰£ |
|            | å›è´­åŠŸèƒ½ | è¯¯å–å›è´­ï¼ˆ24hå†…ï¼‰ |
|            | é¢„è§ˆåŠŸèƒ½ | è£…å¤‡å±æ€§é¢„è§ˆ |
|            | æœç´¢/ç­›é€‰ | æŒ‰ç±»å‹ã€ä»·æ ¼ã€å“è´¨ç­›é€‰ |

### 2.2 éåŠŸèƒ½æ€§éœ€æ±‚

| éœ€æ±‚ç±»å‹ | å…·ä½“è¦æ±‚ |
|---------|---------|
| **æ€§èƒ½** | å•†åº—åˆ—è¡¨åŠ è½½ < 500ms |
|         | å•æ¬¡è´­ä¹°å“åº” < 200ms |
|         | æ”¯æŒ100+å•†å“å±•ç¤º |
| **å¹¶å‘** | æ”¯æŒå¤šç”¨æˆ·åŒæ—¶è´­ä¹°ï¼ˆæœ‰é™åº“å­˜å•†å“ï¼‰ |
|         | ä¹è§‚é”/æ‚²è§‚é”æœºåˆ¶ |
| **å®‰å…¨** | äº¤æ˜“é™é¢‘ï¼ˆ10æ¬¡/åˆ†é’Ÿï¼‰ |
|         | ä»·æ ¼é˜²ç¯¡æ”¹éªŒè¯ |
|         | åº“å­˜é˜²åˆ·æœºåˆ¶ |
| **å¯æ‰©å±•** | æ–°å¢å•†åº—ç±»å‹æ— éœ€æ”¹ä»£ç  |
|          | æ–°å¢è´§å¸ç±»å‹é…ç½®åŒ– |
| **ç›‘æ§** | äº¤æ˜“æµæ°´è®°å½• |
|         | è´§å¸æµé€šç›‘æ§ |
|         | çƒ­é”€å•†å“ç»Ÿè®¡ |
| **å…¼å®¹æ€§** | å‘åå…¼å®¹ç°æœ‰æ•°æ® |
|          | ä¸ç ´åç°æœ‰ç»æµç³»ç»Ÿ |

### 2.3 æ•°æ®éœ€æ±‚

#### 2.3.1 æ ¸å¿ƒæ•°æ®è¡¨

```
æ•°æ®è¡¨è®¾è®¡æ¦‚è§ˆ

ShopDefinition (å•†åº—å®šä¹‰ - é…ç½®è¡¨)
â”œâ”€â”€ Id (å•†åº—ID)
â”œâ”€â”€ Name (å•†åº—åç§°)
â”œâ”€â”€ Description (æè¿°)
â”œâ”€â”€ ShopType (å•†åº—ç±»å‹)
â”œâ”€â”€ Icon (å›¾æ ‡)
â”œâ”€â”€ UnlockConditionExpr (è§£é”æ¡ä»¶DSL)
â”œâ”€â”€ SortOrder (æ’åº)
â””â”€â”€ IsActive (æ˜¯å¦å¯ç”¨)

ShopInstance (å•†åº—å®ä¾‹ - è¿è¡Œæ—¶)
â”œâ”€â”€ Id (å®ä¾‹ID)
â”œâ”€â”€ ShopDefinitionId (å•†åº—å®šä¹‰ID)
â”œâ”€â”€ LastRefreshTime (ä¸Šæ¬¡åˆ·æ–°æ—¶é—´)
â”œâ”€â”€ NextRefreshTime (ä¸‹æ¬¡åˆ·æ–°æ—¶é—´)
â”œâ”€â”€ RefreshCount (åˆ·æ–°è®¡æ•°)
â””â”€â”€ CurrentStock (å½“å‰åº“å­˜å¿«ç…§)

ShopItem (å•†å“å®šä¹‰ - é…ç½®è¡¨)
â”œâ”€â”€ Id (å•†å“ID)
â”œâ”€â”€ ShopId (æ‰€å±å•†åº—ID)
â”œâ”€â”€ ItemType (ç‰©å“ç±»å‹: Consumable/Equipment/Material)
â”œâ”€â”€ ItemId (ç‰©å“å®šä¹‰ID)
â”œâ”€â”€ DisplayOrder (æ˜¾ç¤ºé¡ºåº)
â”œâ”€â”€ UnlockConditionExpr (è§£é”æ¡ä»¶)
â”œâ”€â”€ IsVisible (æ˜¯å¦å¯è§)
â””â”€â”€ IsActive (æ˜¯å¦å¯ç”¨)

ShopItemPrice (å•†å“ä»·æ ¼ - é…ç½®è¡¨)
â”œâ”€â”€ ShopItemId (å•†å“ID)
â”œâ”€â”€ CurrencyType (è´§å¸ç±»å‹: Gold/Reputation/Honor/Token)
â”œâ”€â”€ CurrencyId (è´§å¸ID - ç”¨äºå£°æœ›/ä»£å¸)
â”œâ”€â”€ Amount (ä»·æ ¼æ•°é‡)
â””â”€â”€ DiscountFactor (æŠ˜æ‰£ç³»æ•° 0-1)

ShopItemStock (å•†å“åº“å­˜ - è¿è¡Œæ—¶)
â”œâ”€â”€ ShopItemId (å•†å“ID)
â”œâ”€â”€ StockType (åº“å­˜ç±»å‹: Infinite/Limited/Personal)
â”œâ”€â”€ TotalStock (æ€»åº“å­˜ - nullè¡¨ç¤ºæ— é™)
â”œâ”€â”€ CurrentStock (å½“å‰åº“å­˜)
â”œâ”€â”€ RefreshInterval (åˆ·æ–°é—´éš”)
â””â”€â”€ LastRestockTime (ä¸Šæ¬¡è¡¥è´§æ—¶é—´)

ShopItemPurchaseLimit (é™è´­è§„åˆ™ - é…ç½®è¡¨)
â”œâ”€â”€ ShopItemId (å•†å“ID)
â”œâ”€â”€ LimitType (é™åˆ¶ç±»å‹: PerDay/PerWeek/Lifetime/PerRefresh)
â”œâ”€â”€ MaxQuantity (æœ€å¤§æ•°é‡)
â””â”€â”€ ResetTime (é‡ç½®æ—¶é—´)

PurchaseHistory (è´­ä¹°å†å² - è¿è¡Œæ—¶)
â”œâ”€â”€ Id (äº¤æ˜“ID)
â”œâ”€â”€ CharacterId (è§’è‰²ID)
â”œâ”€â”€ ShopItemId (å•†å“ID)
â”œâ”€â”€ Quantity (è´­ä¹°æ•°é‡)
â”œâ”€â”€ TotalCost (æ€»èŠ±è´¹) - JSON: {Gold: 100, Honor: 50}
â”œâ”€â”€ PurchaseTime (è´­ä¹°æ—¶é—´)
â””â”€â”€ TransactionId (å¹‚ç­‰æ€§é”®)
```

---

## 3. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 3.1 æ¶æ„åˆ†å±‚

åŸºäºé¡¹ç›®ç°æœ‰çš„ DDD æ¶æ„ï¼š

```
æ¶æ„å±‚æ¬¡åˆ’åˆ†

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Presentation Layer (è¡¨ç°å±‚)            â”‚
â”‚   BlazorIdle/Pages/                     â”‚
â”‚   - ShopList.razor (å•†åº—åˆ—è¡¨é¡µ)          â”‚
â”‚   - ShopDetail.razor (å•†åº—è¯¦æƒ…é¡µ)        â”‚
â”‚   - ShopPurchaseModal.razor (è´­ä¹°ç¡®è®¤æ¡†)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“ HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Layer (æ¥å£å±‚)                     â”‚
â”‚   BlazorIdle.Server/Controllers/        â”‚
â”‚   - ShopController.cs                   â”‚
â”‚   - PurchaseController.cs               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“ Application Services
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Application Layer (åº”ç”¨å±‚)             â”‚
â”‚   BlazorIdle.Server/Application/Shop/   â”‚
â”‚   - ShopService.cs (å•†åº—æœåŠ¡)            â”‚
â”‚   - PurchaseService.cs (è´­ä¹°æœåŠ¡)        â”‚
â”‚   - ShopRefreshService.cs (åˆ·æ–°æœåŠ¡)    â”‚
â”‚   - ShopUnlockService.cs (è§£é”æœåŠ¡)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“ Domain Logic
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Domain Layer (é¢†åŸŸå±‚)                  â”‚
â”‚   BlazorIdle.Server/Domain/Shop/        â”‚
â”‚   - Models/                             â”‚
â”‚     â”œâ”€â”€ ShopAggregate.cs                â”‚
â”‚     â”œâ”€â”€ ShopItem.cs                     â”‚
â”‚     â”œâ”€â”€ PriceSpecification.cs           â”‚
â”‚     â””â”€â”€ StockPolicy.cs                  â”‚
â”‚   - Services/                           â”‚
â”‚     â”œâ”€â”€ IShopRepository.cs              â”‚
â”‚     â”œâ”€â”€ IPurchaseValidator.cs           â”‚
â”‚     â””â”€â”€ IStockManager.cs                â”‚
â”‚   - Events/                             â”‚
â”‚     â”œâ”€â”€ PurchaseCompletedEvent.cs       â”‚
â”‚     â”œâ”€â”€ ShopRefreshedEvent.cs           â”‚
â”‚     â””â”€â”€ StockDepletedEvent.cs           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“ Data Access
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)       â”‚
â”‚   BlazorIdle.Server/Infrastructure/     â”‚
â”‚   - Persistence/                        â”‚
â”‚     â”œâ”€â”€ ShopRepository.cs               â”‚
â”‚     â””â”€â”€ PurchaseHistoryRepository.cs    â”‚
â”‚   - Configuration/                      â”‚
â”‚     â””â”€â”€ ShopEntityConfiguration.cs      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¨¡å—è¾¹ç•Œ

```
å•†åº—ç³»ç»Ÿæ¨¡å—åˆ’åˆ†

Shop Domain (å•†åº—é¢†åŸŸ)
â”œâ”€â”€ Shop Management (å•†åº—ç®¡ç†)
â”‚   â”œâ”€â”€ ShopDefinition: å•†åº—å®šä¹‰é…ç½®
â”‚   â”œâ”€â”€ ShopInstance: å•†åº—è¿è¡Œæ—¶å®ä¾‹
â”‚   â”œâ”€â”€ ShopRepository: å•†åº—ä»“å‚¨
â”‚   â””â”€â”€ ShopRefreshService: åˆ·æ–°æœåŠ¡
â”‚
â”œâ”€â”€ Item Management (å•†å“ç®¡ç†)
â”‚   â”œâ”€â”€ ShopItem: å•†å“å®šä¹‰
â”‚   â”œâ”€â”€ PriceSpecification: ä»·æ ¼è§„æ ¼
â”‚   â”œâ”€â”€ StockPolicy: åº“å­˜ç­–ç•¥
â”‚   â””â”€â”€ PurchaseLimit: é™è´­è§„åˆ™
â”‚
â”œâ”€â”€ Transaction (äº¤æ˜“ç®¡ç†)
â”‚   â”œâ”€â”€ PurchaseService: è´­ä¹°æœåŠ¡
â”‚   â”œâ”€â”€ PurchaseValidator: è´­ä¹°éªŒè¯å™¨
â”‚   â”œâ”€â”€ CurrencyExchanger: è´§å¸å…‘æ¢å™¨
â”‚   â””â”€â”€ TransactionLogger: äº¤æ˜“æ—¥å¿—
â”‚
â”œâ”€â”€ Unlock & Condition (è§£é”ä¸æ¡ä»¶)
â”‚   â”œâ”€â”€ ShopUnlockService: å•†åº—è§£é”
â”‚   â”œâ”€â”€ ItemVisibilityService: å•†å“å¯è§æ€§
â”‚   â””â”€â”€ ConditionEvaluator: æ¡ä»¶è¯„ä¼°å™¨
â”‚
â””â”€â”€ Events (é¢†åŸŸäº‹ä»¶)
    â”œâ”€â”€ PurchaseCompletedEvent: è´­ä¹°å®Œæˆ
    â”œâ”€â”€ ShopRefreshedEvent: å•†åº—åˆ·æ–°
    â”œâ”€â”€ StockChangedEvent: åº“å­˜å˜æ›´
    â””â”€â”€ ShopUnlockedEvent: å•†åº—è§£é”

å¤–éƒ¨ä¾èµ–æ¥å£
â”œâ”€â”€ IEconomyService: ç»æµç³»ç»Ÿé›†æˆ
â”œâ”€â”€ IInventoryService: èƒŒåŒ…ç³»ç»Ÿé›†æˆ
â”œâ”€â”€ ICharacterService: è§’è‰²ç³»ç»Ÿé›†æˆ
â”œâ”€â”€ IConditionService: æ¡ä»¶ç³»ç»Ÿé›†æˆ (å¾…å®æ–½)
â””â”€â”€ IRewardGrantService: å¥–åŠ±å‘æ”¾é›†æˆ
```

### 3.3 æ ¸å¿ƒå·¥ä½œæµ

#### 3.3.1 è´­ä¹°æµç¨‹

```
è´­ä¹°æµç¨‹ (Purchase Flow)

1. ç”¨æˆ·è¯·æ±‚è´­ä¹°
   POST /api/shop/purchase
   Body: { shopItemId, quantity, characterId }
   â”‚
   â†“
2. è´­ä¹°æœåŠ¡éªŒè¯
   PurchaseService.ValidatePurchase()
   â”œâ”€â”€ æ£€æŸ¥å•†åº—æ˜¯å¦è§£é”
   â”œâ”€â”€ æ£€æŸ¥å•†å“æ˜¯å¦è§£é”
   â”œâ”€â”€ æ£€æŸ¥é™è´­è§„åˆ™
   â”œâ”€â”€ æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
   â”œâ”€â”€ æ£€æŸ¥è´§å¸æ˜¯å¦è¶³å¤Ÿ
   â””â”€â”€ æ£€æŸ¥èƒŒåŒ…å®¹é‡
   â”‚
   â†“
3. æ‰§è¡Œäº¤æ˜“ (äº‹åŠ¡)
   PurchaseService.ExecutePurchase()
   BEGIN TRANSACTION
   â”œâ”€â”€ æ‰£é™¤è´§å¸ (Character.Gold -= cost)
   â”œâ”€â”€ æ‰£å‡åº“å­˜ (Stock.CurrentStock -= qty)
   â”œâ”€â”€ å‘æ”¾ç‰©å“ (InventoryService.AddItem)
   â”œâ”€â”€ è®°å½•é™è´­ (PurchaseHistory.Insert)
   â”œâ”€â”€ è®°å½•äº¤æ˜“æ—¥å¿— (TransactionLog.Insert)
   â””â”€â”€ å‘å¸ƒé¢†åŸŸäº‹ä»¶ (PurchaseCompletedEvent)
   COMMIT TRANSACTION
   â”‚
   â†“
4. è¿”å›ç»“æœ
   Response: { success, itemsGranted, remainingCurrency }
```

#### 3.3.2 åˆ·æ–°æµç¨‹

```
å•†åº—åˆ·æ–°æµç¨‹ (Refresh Flow)

1. è§¦å‘åˆ·æ–°
   - å®šæ—¶ä»»åŠ¡è§¦å‘ (Cron Job)
   - ç©å®¶æ‰‹åŠ¨è§¦å‘ (ä½¿ç”¨åˆ·æ–°åˆ¸)
   - å•†åº—é¦–æ¬¡è®¿é—®è§¦å‘
   â”‚
   â†“
2. åˆ·æ–°æœåŠ¡å¤„ç†
   ShopRefreshService.RefreshShop(shopId)
   â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–° (æ—¶é—´åˆ°æœŸ?)
   â”œâ”€â”€ è·å–å•†åº—å®šä¹‰
   â”œâ”€â”€ è·å–åˆ·æ–°è§„åˆ™é…ç½®
   â”‚
   â†“
3. ç”Ÿæˆæ–°åº“å­˜
   StockGenerationService.GenerateStock()
   â”œâ”€â”€ å›ºå®šå•†å“: é‡ç½®åº“å­˜
   â”œâ”€â”€ éšæœºå•†å“: ä»å•†å“æ± éšæœºé€‰æ‹©
   â”œâ”€â”€ å“è´¨éšæœº: æ ¹æ®æƒé‡Rollå“è´¨
   â””â”€â”€ ä»·æ ¼æµ®åŠ¨: åº”ç”¨ä»·æ ¼æ³¢åŠ¨ (å¯é€‰)
   â”‚
   â†“
4. æŒä¹…åŒ–ä¸é€šçŸ¥
   â”œâ”€â”€ æ›´æ–° ShopInstance.LastRefreshTime
   â”œâ”€â”€ æ›´æ–° ShopItemStock è¡¨
   â”œâ”€â”€ å‘å¸ƒ ShopRefreshedEvent
   â””â”€â”€ é€šçŸ¥åœ¨çº¿ç©å®¶ (SignalRæ¨é€)
```

---

## 4. æ ¸å¿ƒé¢†åŸŸæ¨¡å‹

### 4.1 å•†åº—èšåˆæ ¹ (ShopAggregate)

```csharp
/// <summary>
/// å•†åº—èšåˆæ ¹ - å•†åº—å®ä¾‹çš„å®Œæ•´çŠ¶æ€
/// </summary>
public class ShopAggregate
{
    public Guid Id { get; private set; }
    public string ShopDefinitionId { get; private set; }
    public ShopDefinition Definition { get; private set; }
    
    // åˆ·æ–°çŠ¶æ€
    public DateTime LastRefreshTime { get; private set; }
    public DateTime? NextRefreshTime { get; private set; }
    public int RefreshCount { get; private set; }
    
    // å•†å“é›†åˆ
    private readonly List<ShopItemInstance> _items = new();
    public IReadOnlyList<ShopItemInstance> Items => _items.AsReadOnly();
    
    // è§£é”çŠ¶æ€ç¼“å­˜
    private bool _isUnlocked;
    public bool IsUnlocked => _isUnlocked;
    
    /// <summary>
    /// æ£€æŸ¥å•†åº—æ˜¯å¦éœ€è¦åˆ·æ–°
    /// </summary>
    public bool NeedsRefresh(DateTime currentTime)
    {
        if (NextRefreshTime == null) return false;
        return currentTime >= NextRefreshTime.Value;
    }
    
    /// <summary>
    /// åˆ·æ–°å•†åº—
    /// </summary>
    public void Refresh(DateTime refreshTime, List<ShopItemInstance> newItems)
    {
        LastRefreshTime = refreshTime;
        NextRefreshTime = CalculateNextRefreshTime(refreshTime);
        RefreshCount++;
        
        _items.Clear();
        _items.AddRange(newItems);
        
        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        AddDomainEvent(new ShopRefreshedEvent(Id, refreshTime, newItems.Count));
    }
    
    /// <summary>
    /// è´­ä¹°å•†å“
    /// </summary>
    public PurchaseResult PurchaseItem(
        string shopItemId, 
        int quantity, 
        Guid characterId,
        IPurchaseValidator validator)
    {
        var item = _items.FirstOrDefault(i => i.ShopItemId == shopItemId);
        if (item == null)
            return PurchaseResult.Fail("å•†å“ä¸å­˜åœ¨");
            
        // éªŒè¯è´­ä¹°æ¡ä»¶
        var validationResult = validator.Validate(item, quantity, characterId);
        if (!validationResult.IsSuccess)
            return PurchaseResult.Fail(validationResult.ErrorMessage);
            
        // æ‰£å‡åº“å­˜
        if (!item.DeductStock(quantity))
            return PurchaseResult.Fail("åº“å­˜ä¸è¶³");
            
        // è®°å½•è´­ä¹°ï¼ˆç”±æœåŠ¡å±‚å®Œæˆè´§å¸æ‰£é™¤å’Œç‰©å“å‘æ”¾ï¼‰
        return PurchaseResult.Success(item, quantity);
    }
    
    private DateTime? CalculateNextRefreshTime(DateTime from)
    {
        return Definition.RefreshInterval switch
        {
            RefreshInterval.Daily => from.Date.AddDays(1),
            RefreshInterval.Weekly => from.Date.AddDays(7 - (int)from.DayOfWeek),
            RefreshInterval.Hourly => from.AddHours(1),
            RefreshInterval.Never => null,
            _ => null
        };
    }
}
```

### 4.2 å•†åº—å®šä¹‰ (ShopDefinition)

```csharp
/// <summary>
/// å•†åº—å®šä¹‰ - é™æ€é…ç½®æ•°æ®
/// </summary>
public class ShopDefinition
{
    public string Id { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public ShopType ShopType { get; set; }
    public string Icon { get; set; } = string.Empty;
    
    // è§£é”æ¡ä»¶
    public string? UnlockConditionExpr { get; set; }
    
    // åˆ·æ–°è§„åˆ™
    public RefreshInterval RefreshInterval { get; set; }
    public bool AllowManualRefresh { get; set; }
    public int? ManualRefreshCost { get; set; } // åˆ·æ–°åˆ¸æ¶ˆè€—
    
    // æ’åºä¸æ˜¾ç¤º
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
    public List<string> Tags { get; set; } = new();
    
    // å•†å“åˆ—è¡¨
    public List<ShopItemDefinition> ItemDefinitions { get; set; } = new();
}

/// <summary>
/// å•†åº—ç±»å‹
/// </summary>
public enum ShopType
{
    General,      // æ™®é€šå•†åº—
    Equipment,    // è£…å¤‡å•†åº—
    Material,     // ææ–™å•†åº—
    Reputation,   // å£°æœ›å•†åº—
    Honor,        // è£èª‰å•†åº—
    Token,        // ä»£å¸å•†åº—
    Limited,      // é™æ—¶å•†åº—
    BlackMarket   // é»‘å¸‚
}

/// <summary>
/// åˆ·æ–°é—´éš”
/// </summary>
public enum RefreshInterval
{
    Never,    // æ°¸ä¸åˆ·æ–°ï¼ˆå›ºå®šåº“å­˜ï¼‰
    Hourly,   // æ¯å°æ—¶
    Daily,    // æ¯æ—¥
    Weekly,   // æ¯å‘¨
    Monthly   // æ¯æœˆ
}
```

### 4.3 å•†å“å®ä¾‹ (ShopItemInstance)

```csharp
/// <summary>
/// å•†åº—å•†å“å®ä¾‹ - è¿è¡Œæ—¶çŠ¶æ€
/// </summary>
public class ShopItemInstance
{
    public Guid Id { get; private set; }
    public string ShopItemId { get; private set; }
    public string ShopId { get; private set; }
    
    // ç‰©å“å¼•ç”¨
    public ItemType ItemType { get; private set; }
    public string ItemId { get; private set; }
    
    // ä»·æ ¼ä¿¡æ¯
    private readonly List<CurrencyCost> _prices = new();
    public IReadOnlyList<CurrencyCost> Prices => _prices.AsReadOnly();
    
    // åº“å­˜ä¿¡æ¯
    public StockPolicy StockPolicy { get; private set; }
    public int? CurrentStock { get; private set; }
    public int? MaxStock { get; private set; }
    
    // é™è´­ä¿¡æ¯
    private readonly List<PurchaseLimit> _limits = new();
    public IReadOnlyList<PurchaseLimit> Limits => _limits.AsReadOnly();
    
    // è§£é”æ¡ä»¶
    public string? UnlockConditionExpr { get; private set; }
    public bool IsUnlocked { get; private set; }
    public bool IsVisible { get; private set; }
    
    // æ˜¾ç¤ºé¡ºåº
    public int DisplayOrder { get; private set; }
    
    /// <summary>
    /// æ‰£å‡åº“å­˜
    /// </summary>
    public bool DeductStock(int quantity)
    {
        if (StockPolicy == StockPolicy.Infinite)
            return true;
            
        if (CurrentStock == null || CurrentStock < quantity)
            return false;
            
        CurrentStock -= quantity;
        return true;
    }
    
    /// <summary>
    /// è¡¥å……åº“å­˜
    /// </summary>
    public void RestockToMax()
    {
        if (StockPolicy == StockPolicy.Limited && MaxStock.HasValue)
        {
            CurrentStock = MaxStock.Value;
        }
    }
    
    /// <summary>
    /// è®¡ç®—æ€»ä»·æ ¼
    /// </summary>
    public Dictionary<CurrencyType, long> CalculateTotalCost(int quantity)
    {
        var result = new Dictionary<CurrencyType, long>();
        foreach (var price in _prices)
        {
            result[price.CurrencyType] = price.Amount * quantity;
        }
        return result;
    }
}

/// <summary>
/// ç‰©å“ç±»å‹
/// </summary>
public enum ItemType
{
    Consumable,   // æ¶ˆè€—å“
    Equipment,    // è£…å¤‡
    Material,     // ææ–™
    Recipe,       // é…æ–¹
    Token,        // ä»£å¸
    Special       // ç‰¹æ®Šç‰©å“
}

/// <summary>
/// åº“å­˜ç­–ç•¥
/// </summary>
public enum StockPolicy
{
    Infinite,   // æ— é™åº“å­˜
    Limited,    // æœ‰é™åº“å­˜ï¼ˆå…¨æœå…±äº«ï¼‰
    Personal    // ä¸ªäººåº“å­˜ï¼ˆæ¯äººç‹¬ç«‹ï¼‰
}
```

### 4.4 ä»·æ ¼è§„æ ¼ (CurrencyCost)

```csharp
/// <summary>
/// è´§å¸èŠ±è´¹
/// </summary>
public class CurrencyCost
{
    public CurrencyType CurrencyType { get; set; }
    public string? CurrencyId { get; set; } // ç”¨äºå£°æœ›/ä»£å¸ç±»å‹
    public long Amount { get; set; }
    public double DiscountFactor { get; set; } = 1.0; // æŠ˜æ‰£ç³»æ•°
    
    /// <summary>
    /// è®¡ç®—å®é™…èŠ±è´¹
    /// </summary>
    public long CalculateActualCost()
    {
        return (long)(Amount * DiscountFactor);
    }
}

/// <summary>
/// è´§å¸ç±»å‹
/// </summary>
public enum CurrencyType
{
    Gold,         // é‡‘å¸
    Reputation,   // å£°æœ›ï¼ˆéœ€æŒ‡å®šæ´¾ç³»IDï¼‰
    Honor,        // è£èª‰ç‚¹
    Token,        // ä»£å¸ï¼ˆéœ€æŒ‡å®šä»£å¸IDï¼‰
    Achievement,  // æˆå°±ç‚¹
    Guild         // å…¬ä¼šè´¡çŒ®ï¼ˆæœªæ¥ï¼‰
}
```

### 4.5 é™è´­è§„åˆ™ (PurchaseLimit)

```csharp
/// <summary>
/// é™è´­è§„åˆ™
/// </summary>
public class PurchaseLimit
{
    public Guid Id { get; set; }
    public string ShopItemId { get; set; } = string.Empty;
    
    public LimitType LimitType { get; set; }
    public int MaxQuantity { get; set; }
    
    // é‡ç½®æ—¶é—´ï¼ˆç”¨äºæ—¥é™è´­/å‘¨é™è´­ï¼‰
    public DateTime? LastResetTime { get; set; }
    public DateTime? NextResetTime { get; set; }
}

/// <summary>
/// é™åˆ¶ç±»å‹
/// </summary>
public enum LimitType
{
    PerDay,       // æ¯æ—¥é™è´­
    PerWeek,      // æ¯å‘¨é™è´­
    PerMonth,     // æ¯æœˆé™è´­
    PerRefresh,   // æ¯æ¬¡åˆ·æ–°é™è´­
    Lifetime      // ç»ˆèº«é™è´­
}

/// <summary>
/// è§’è‰²è´­ä¹°è®°å½•
/// </summary>
public class CharacterPurchaseRecord
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    public string ShopItemId { get; set; } = string.Empty;
    
    public int PurchasedToday { get; set; }
    public int PurchasedThisWeek { get; set; }
    public int PurchasedThisMonth { get; set; }
    public int PurchasedThisRefresh { get; set; }
    public int PurchasedLifetime { get; set; }
    
    public DateTime LastPurchaseTime { get; set; }
    public DateTime LastDailyReset { get; set; }
    public DateTime LastWeeklyReset { get; set; }
    public DateTime LastMonthlyReset { get; set; }
    public DateTime? LastRefreshReset { get; set; }
    
    /// <summary>
    /// æ£€æŸ¥æ˜¯å¦è¶…å‡ºé™è´­
    /// </summary>
    public bool IsLimitExceeded(PurchaseLimit limit, int requestQuantity)
    {
        var current = limit.LimitType switch
        {
            LimitType.PerDay => PurchasedToday,
            LimitType.PerWeek => PurchasedThisWeek,
            LimitType.PerMonth => PurchasedThisMonth,
            LimitType.PerRefresh => PurchasedThisRefresh,
            LimitType.Lifetime => PurchasedLifetime,
            _ => 0
        };
        
        return (current + requestQuantity) > limit.MaxQuantity;
    }
    
    /// <summary>
    /// è®°å½•è´­ä¹°
    /// </summary>
    public void RecordPurchase(int quantity, DateTime purchaseTime)
    {
        PurchasedToday += quantity;
        PurchasedThisWeek += quantity;
        PurchasedThisMonth += quantity;
        PurchasedThisRefresh += quantity;
        PurchasedLifetime += quantity;
        LastPurchaseTime = purchaseTime;
    }
}
```

---

## 5. å•†åº—ç±»å‹è®¾è®¡

### 5.1 æ™®é€šå•†åº— (General Shop)

**å®šä½**: æ–°æ‰‹å‹å¥½ï¼Œæä¾›åŸºç¡€æ¶ˆè€—å“å’Œä½çº§è£…å¤‡

```json
{
  "id": "shop_general_town",
  "name": "åŸé•‡æ‚è´§é“º",
  "description": "å‡ºå”®æ—¥å¸¸æ¶ˆè€—å“å’ŒåŸºç¡€è£…å¤‡",
  "shopType": "General",
  "icon": "shop_general.png",
  "unlockConditionExpr": null,
  "refreshInterval": "Never",
  "allowManualRefresh": false,
  "sortOrder": 1,
  "isActive": true,
  "itemDefinitions": [
    {
      "shopItemId": "item_bread",
      "itemType": "Consumable",
      "itemId": "consumable_bread",
      "prices": [
        { "currencyType": "Gold", "amount": 5 }
      ],
      "stockPolicy": "Infinite",
      "purchaseLimits": [],
      "displayOrder": 1
    },
    {
      "shopItemId": "item_health_potion_minor",
      "itemType": "Consumable",
      "itemId": "potion_health_minor",
      "prices": [
        { "currencyType": "Gold", "amount": 20 }
      ],
      "stockPolicy": "Infinite",
      "purchaseLimits": [],
      "displayOrder": 2
    },
    {
      "shopItemId": "item_sword_iron",
      "itemType": "Equipment",
      "itemId": "weapon_sword_iron",
      "prices": [
        { "currencyType": "Gold", "amount": 100 }
      ],
      "stockPolicy": "Infinite",
      "unlockConditionExpr": "level>=5",
      "displayOrder": 10
    }
  ]
}
```

### 5.2 è£…å¤‡å•†åº— (Equipment Shop)

**å®šä½**: æä¾›å„ç­‰çº§æ®µè£…å¤‡ï¼Œæ¯æ—¥åˆ·æ–°å“è´¨

```json
{
  "id": "shop_equipment_blacksmith",
  "name": "é“åŒ é“º",
  "description": "å‡ºå”®ç²¾è‰¯è£…å¤‡ï¼Œæ¯æ—¥æ›´æ–°åº“å­˜",
  "shopType": "Equipment",
  "icon": "shop_blacksmith.png",
  "unlockConditionExpr": "level>=10",
  "refreshInterval": "Daily",
  "allowManualRefresh": true,
  "manualRefreshCost": 50,
  "sortOrder": 2,
  "itemDefinitions": [
    {
      "shopItemId": "random_weapon_tier1",
      "itemType": "Equipment",
      "itemId": "random:weapon:tier1",
      "prices": [
        { "currencyType": "Gold", "amount": 500 }
      ],
      "stockPolicy": "Limited",
      "maxStock": 3,
      "purchaseLimits": [
        { "limitType": "PerDay", "maxQuantity": 2 }
      ],
      "displayOrder": 1
    },
    {
      "shopItemId": "epic_chest_armor",
      "itemType": "Equipment",
      "itemId": "armor_chest_epic_01",
      "prices": [
        { "currencyType": "Gold", "amount": 2000 }
      ],
      "stockPolicy": "Limited",
      "maxStock": 1,
      "purchaseLimits": [
        { "limitType": "PerWeek", "maxQuantity": 1 }
      ],
      "unlockConditionExpr": "level>=20",
      "displayOrder": 5
    }
  ]
}
```

### 5.3 å£°æœ›å•†åº— (Reputation Shop)

**å®šä½**: æ´¾ç³»ä¸“å±ç‰©å“ï¼Œéœ€è¦å£°æœ›ç‚¹è´­ä¹°

```json
{
  "id": "shop_reputation_faction_a",
  "name": "é˜³å…‰è”ç›Ÿå†›éœ€å®˜",
  "description": "å…‘æ¢è”ç›Ÿä¸“å±è£…å¤‡å’Œé…æ–¹",
  "shopType": "Reputation",
  "icon": "shop_faction_a.png",
  "unlockConditionExpr": "reputation.faction_a>=Friendly",
  "refreshInterval": "Never",
  "sortOrder": 10,
  "itemDefinitions": [
    {
      "shopItemId": "recipe_enchant_fire",
      "itemType": "Recipe",
      "itemId": "recipe_enchant_fire_weapon",
      "prices": [
        { 
          "currencyType": "Reputation", 
          "currencyId": "faction_a",
          "amount": 500 
        }
      ],
      "stockPolicy": "Personal",
      "purchaseLimits": [
        { "limitType": "Lifetime", "maxQuantity": 1 }
      ],
      "unlockConditionExpr": "reputation.faction_a>=Honored",
      "displayOrder": 1
    },
    {
      "shopItemId": "mount_faction_a",
      "itemType": "Special",
      "itemId": "mount_griffin",
      "prices": [
        { 
          "currencyType": "Reputation", 
          "currencyId": "faction_a",
          "amount": 2000 
        },
        { "currencyType": "Gold", "amount": 5000 }
      ],
      "stockPolicy": "Personal",
      "purchaseLimits": [
        { "limitType": "Lifetime", "maxQuantity": 1 }
      ],
      "unlockConditionExpr": "reputation.faction_a>=Exalted",
      "displayOrder": 100
    }
  ]
}
```

### 5.4 è£èª‰å•†åº— (Honor Shop)

**å®šä½**: PvP/æŒ‘æˆ˜å¥–åŠ±å…‘æ¢ï¼Œæ¯å‘¨åˆ·æ–°

```json
{
  "id": "shop_honor_arena",
  "name": "ç«æŠ€åœºå•†äºº",
  "description": "å…‘æ¢è£èª‰è£…å¤‡å’Œç‰¹æ®Šé“å…·",
  "shopType": "Honor",
  "icon": "shop_honor.png",
  "unlockConditionExpr": "achievement.first_arena_win",
  "refreshInterval": "Weekly",
  "sortOrder": 15,
  "itemDefinitions": [
    {
      "shopItemId": "weapon_pvp_epic",
      "itemType": "Equipment",
      "itemId": "weapon_sword_pvp_s1",
      "prices": [
        { "currencyType": "Honor", "amount": 1000 }
      ],
      "stockPolicy": "Personal",
      "purchaseLimits": [
        { "limitType": "PerWeek", "maxQuantity": 1 }
      ],
      "unlockConditionExpr": "honor_rating>=1500",
      "displayOrder": 1
    }
  ]
}
```

---

## 6. äº¤æ˜“è´§å¸ç³»ç»Ÿ

### 6.1 è´§å¸ç±»å‹å®šä¹‰

| è´§å¸ç±»å‹ | æ ‡è¯† | è·å–æ–¹å¼ | ç”¨é€” | æ˜¯å¦æœ‰ä¸Šé™ |
|---------|-----|---------|------|----------|
| **é‡‘å¸** | Gold | æˆ˜æ–—æ‰è½ã€ä»»åŠ¡å¥–åŠ±ã€å‡ºå”®ç‰©å“ | é€šç”¨è´­ä¹° | å¦ |
| **å£°æœ›ç‚¹** | Reputation:{FactionId} | å®Œæˆæ´¾ç³»ä»»åŠ¡ã€å‰¯æœ¬ | æ´¾ç³»å•†åº— | å¦ |
| **è£èª‰ç‚¹** | Honor | PvPèƒœåˆ©ã€ç«æŠ€åœº | è£èª‰å•†åº— | å¦ |
| **æ´»åŠ¨ä»£å¸** | Token:{TokenId} | é™æ—¶æ´»åŠ¨ã€æˆå°± | ä»£å¸å•†åº— | å–å†³äºæ´»åŠ¨ |
| **æˆå°±ç‚¹** | Achievement | å®Œæˆæˆå°± | æˆå°±å•†åº— | å¦ |

### 6.2 è´§å¸å­˜å‚¨è®¾è®¡

#### 6.2.1 é‡‘å¸å­˜å‚¨ï¼ˆç°æœ‰ï¼‰

```csharp
// å·²å­˜åœ¨äº Character å®ä½“
public class Character
{
    public Guid Id { get; set; }
    public long Gold { get; set; } // é‡‘å¸å­˜å‚¨
    // ...å…¶ä»–å±æ€§
}
```

#### 6.2.2 å£°æœ›å­˜å‚¨ï¼ˆæ–°å¢ï¼‰

```csharp
/// <summary>
/// å£°æœ›è®°å½•è¡¨
/// </summary>
public class ReputationRecord
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    public string FactionId { get; set; } = string.Empty;
    
    public int ReputationPoints { get; set; } // å£°æœ›ç‚¹æ•°
    public ReputationLevel Level { get; set; } // å£°æœ›ç­‰çº§
    
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // å¯¼èˆªå±æ€§
    public Character Character { get; set; } = null!;
}

/// <summary>
/// å£°æœ›ç­‰çº§
/// </summary>
public enum ReputationLevel
{
    Hated = 0,      // ä»‡æ¨ (-6000 ~ -3000)
    Hostile = 1,    // æ•Œå¯¹ (-3000 ~ 0)
    Neutral = 2,    // ä¸­ç«‹ (0 ~ 3000)
    Friendly = 3,   // å‹å¥½ (3000 ~ 9000)
    Honored = 4,    // å°Šæ•¬ (9000 ~ 21000)
    Revered = 5,    // å´‡æ•¬ (21000 ~ 42000)
    Exalted = 6     // å´‡æ‹œ (42000+)
}
```

#### 6.2.3 è£èª‰/ä»£å¸å­˜å‚¨ï¼ˆæ–°å¢ï¼‰

```csharp
/// <summary>
/// è§’è‰²è´§å¸é’±åŒ…
/// </summary>
public class CharacterWallet
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    
    public long Gold { get; set; } // é‡‘å¸ï¼ˆä»Characterè¿ç§»ï¼‰
    public long HonorPoints { get; set; } // è£èª‰ç‚¹
    public long AchievementPoints { get; set; } // æˆå°±ç‚¹
    
    public DateTime UpdatedAt { get; set; }
    
    // å¯¼èˆªå±æ€§
    public Character Character { get; set; } = null!;
    public List<TokenBalance> TokenBalances { get; set; } = new();
}

/// <summary>
/// ä»£å¸ä½™é¢
/// </summary>
public class TokenBalance
{
    public Guid Id { get; set; }
    public Guid WalletId { get; set; }
    
    public string TokenId { get; set; } = string.Empty; // ä»£å¸ç±»å‹ID
    public long Amount { get; set; }
    public DateTime? ExpiresAt { get; set; } // ä»£å¸è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
    
    // å¯¼èˆªå±æ€§
    public CharacterWallet Wallet { get; set; } = null!;
}
```

### 6.3 è´§å¸å…‘æ¢å™¨æœåŠ¡

```csharp
/// <summary>
/// è´§å¸å…‘æ¢å™¨æ¥å£
/// </summary>
public interface ICurrencyExchanger
{
    /// <summary>
    /// æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰è¶³å¤Ÿè´§å¸
    /// </summary>
    Task<bool> HasEnoughCurrency(
        Guid characterId, 
        List<CurrencyCost> costs, 
        CancellationToken ct = default);
    
    /// <summary>
    /// æ‰£é™¤è´§å¸
    /// </summary>
    Task<CurrencyDeductionResult> DeductCurrency(
        Guid characterId, 
        List<CurrencyCost> costs,
        string reason,
        CancellationToken ct = default);
    
    /// <summary>
    /// é€€è¿˜è´§å¸
    /// </summary>
    Task RefundCurrency(
        Guid characterId, 
        List<CurrencyCost> costs,
        string reason,
        CancellationToken ct = default);
    
    /// <summary>
    /// è·å–è§’è‰²è´§å¸ä½™é¢
    /// </summary>
    Task<Dictionary<CurrencyType, long>> GetBalances(
        Guid characterId, 
        CancellationToken ct = default);
}

/// <summary>
/// è´§å¸æ‰£é™¤ç»“æœ
/// </summary>
public class CurrencyDeductionResult
{
    public bool Success { get; set; }
    public string? ErrorMessage { get; set; }
    public Dictionary<CurrencyType, long> DeductedAmounts { get; set; } = new();
    public Dictionary<CurrencyType, long> RemainingBalances { get; set; } = new();
}
```

---

## 7. æ¡ä»¶è§£é”é›†æˆ

### 7.1 æ¡ä»¶DSLè®¾è®¡

åŸºäºã€Šæ•´åˆè®¾è®¡æ€»ç»“.txtã€‹ç¬¬12èŠ‚"æ¡ä»¶/è§£é”DSLä¸ç¼“å­˜ä½“ç³»"ï¼š

```
æ¡ä»¶è¡¨è¾¾å¼è¯­æ³•

1. åŸºç¡€æ¯”è¾ƒ
   - level>=20                  (ç­‰çº§å¤§äºç­‰äº20)
   - gold>1000                  (é‡‘å¸å¤§äº1000)
   
2. å£°æœ›æ¡ä»¶
   - reputation.faction_a>=Honored     (å£°æœ›ç­‰çº§)
   - reputation_points.faction_a>=5000 (å£°æœ›ç‚¹æ•°)
   
3. ä»»åŠ¡æ¡ä»¶
   - quest.completed('Q123')    (ä»»åŠ¡å·²å®Œæˆ)
   - quest.active('Q456')       (ä»»åŠ¡è¿›è¡Œä¸­)
   
4. æˆå°±æ¡ä»¶
   - achievement.unlocked('ACH_001')
   - achievement_points>=500
   
5. æ—¶é—´æ¡ä»¶
   - date>=2025-12-25           (ç‰¹å®šæ—¥æœŸå)
   - time>=18:00                (æ¯æ—¥æ—¶é—´æ®µ)
   
6. è£…å¤‡æ¡ä»¶
   - equipped.slot.weapon       (è£…å¤‡äº†æ­¦å™¨)
   - equipment_level>=50        (è£…å¤‡ç­‰çº§)
   
7. èŒä¸šæ¡ä»¶
   - profession==Warrior
   - profession_level.Warrior>=20
   
8. é€»è¾‘ç»„åˆ
   - AND(level>=20, quest.completed('Q123'))
   - OR(gold>=1000, token.event_2025>=50)
   - NOT(quest.active('Q999'))
   - AND(level>=30, OR(reputation.faction_a>=Exalted, achievement.unlocked('ACH_MASTER')))
```

### 7.2 æ¡ä»¶è¯„ä¼°å™¨æ¥å£

```csharp
/// <summary>
/// æ¡ä»¶è¯„ä¼°å™¨æ¥å£
/// </summary>
public interface IConditionEvaluator
{
    /// <summary>
    /// è¯„ä¼°æ¡ä»¶è¡¨è¾¾å¼
    /// </summary>
    Task<bool> EvaluateAsync(
        string conditionExpr, 
        Guid characterId, 
        CancellationToken ct = default);
    
    /// <summary>
    /// æ‰¹é‡è¯„ä¼°æ¡ä»¶
    /// </summary>
    Task<Dictionary<string, bool>> EvaluateBatchAsync(
        List<string> conditionExprs, 
        Guid characterId, 
        CancellationToken ct = default);
    
    /// <summary>
    /// è§£ææ¡ä»¶ä¾èµ–é”®
    /// </summary>
    List<string> ParseDependencies(string conditionExpr);
    
    /// <summary>
    /// å¤±æ•ˆæ¡ä»¶ç¼“å­˜
    /// </summary>
    void InvalidateCache(string dependencyKey);
}

/// <summary>
/// æ¡ä»¶ä¸Šä¸‹æ–‡ - ç”¨äºæ¡ä»¶è¯„ä¼°
/// </summary>
public class ConditionContext
{
    public Guid CharacterId { get; set; }
    public int Level { get; set; }
    public long Gold { get; set; }
    public string Profession { get; set; } = string.Empty;
    
    public Dictionary<string, int> ReputationLevels { get; set; } = new();
    public Dictionary<string, bool> CompletedQuests { get; set; } = new();
    public Dictionary<string, bool> UnlockedAchievements { get; set; } = new();
    public Dictionary<string, long> TokenBalances { get; set; } = new();
    
    public DateTime CurrentTime { get; set; }
}
```

### 7.3 å•†åº—è§£é”æœåŠ¡

```csharp
/// <summary>
/// å•†åº—è§£é”æœåŠ¡
/// </summary>
public class ShopUnlockService
{
    private readonly IConditionEvaluator _conditionEvaluator;
    private readonly IShopRepository _shopRepository;
    
    /// <summary>
    /// è·å–è§’è‰²å·²è§£é”çš„å•†åº—åˆ—è¡¨
    /// </summary>
    public async Task<List<ShopDefinition>> GetUnlockedShopsAsync(
        Guid characterId, 
        CancellationToken ct = default)
    {
        var allShops = await _shopRepository.GetAllActiveShopsAsync(ct);
        var unlockedShops = new List<ShopDefinition>();
        
        foreach (var shop in allShops)
        {
            if (string.IsNullOrEmpty(shop.UnlockConditionExpr))
            {
                // æ— æ¡ä»¶ï¼Œé»˜è®¤è§£é”
                unlockedShops.Add(shop);
                continue;
            }
            
            var isUnlocked = await _conditionEvaluator.EvaluateAsync(
                shop.UnlockConditionExpr, 
                characterId, 
                ct);
                
            if (isUnlocked)
            {
                unlockedShops.Add(shop);
            }
        }
        
        return unlockedShops;
    }
    
    /// <summary>
    /// è·å–å•†åº—å†…å·²è§£é”çš„å•†å“
    /// </summary>
    public async Task<List<ShopItemInstance>> GetUnlockedItemsAsync(
        string shopId,
        Guid characterId,
        CancellationToken ct = default)
    {
        var shop = await _shopRepository.GetShopWithItemsAsync(shopId, ct);
        var unlockedItems = new List<ShopItemInstance>();
        
        foreach (var item in shop.Items)
        {
            // æ£€æŸ¥å•†å“è§£é”æ¡ä»¶
            bool isUnlocked = true;
            if (!string.IsNullOrEmpty(item.UnlockConditionExpr))
            {
                isUnlocked = await _conditionEvaluator.EvaluateAsync(
                    item.UnlockConditionExpr, 
                    characterId, 
                    ct);
            }
            
            // æ ¹æ®å¯è§æ€§ç­–ç•¥å†³å®šæ˜¯å¦è¿”å›
            if (isUnlocked || item.IsVisible)
            {
                item.IsUnlocked = isUnlocked;
                unlockedItems.Add(item);
            }
        }
        
        return unlockedItems;
    }
}
```

---

## 8. ä¸‹ç¯‡é¢„å‘Š

**å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰** å°†æ¶µç›–ï¼š
- è¯¦ç»†å®æ–½æ­¥éª¤ï¼ˆPhase 1-4ï¼‰
- æ•°æ®åº“è®¾è®¡ä¸è¿ç§»
- æ ¸å¿ƒæœåŠ¡å®ç°
- APIæ¥å£è®¾è®¡
- å‰ç«¯ç»„ä»¶è®¾è®¡

**å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰** å°†æ¶µç›–ï¼š
- ç³»ç»Ÿé›†æˆæµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
- ç›‘æ§ä¸æ—¥å¿—
- å®‰å…¨æ€§åŠ å›º
- è¿ç»´ä¸é…ç½®ç®¡ç†

---

## é™„å½•Aï¼šé¢†åŸŸäº‹ä»¶å®šä¹‰

```csharp
/// <summary>
/// è´­ä¹°å®Œæˆäº‹ä»¶
/// </summary>
public class PurchaseCompletedEvent : IDomainEvent
{
    public Guid CharacterId { get; set; }
    public string ShopId { get; set; } = string.Empty;
    public string ShopItemId { get; set; } = string.Empty;
    public int Quantity { get; set; }
    public Dictionary<CurrencyType, long> CostPaid { get; set; } = new();
    public DateTime PurchaseTime { get; set; }
}

/// <summary>
/// å•†åº—åˆ·æ–°äº‹ä»¶
/// </summary>
public class ShopRefreshedEvent : IDomainEvent
{
    public Guid ShopInstanceId { get; set; }
    public string ShopDefinitionId { get; set; } = string.Empty;
    public DateTime RefreshTime { get; set; }
    public int NewItemCount { get; set; }
}

/// <summary>
/// åº“å­˜è€—å°½äº‹ä»¶
/// </summary>
public class StockDepletedEvent : IDomainEvent
{
    public string ShopItemId { get; set; } = string.Empty;
    public DateTime DepletedTime { get; set; }
}

/// <summary>
/// å•†åº—è§£é”äº‹ä»¶
/// </summary>
public class ShopUnlockedEvent : IDomainEvent
{
    public Guid CharacterId { get; set; }
    public string ShopDefinitionId { get; set; } = string.Empty;
    public DateTime UnlockTime { get; set; }
}
```

---

## é™„å½•Bï¼šé…ç½®ç¤ºä¾‹æ±‡æ€»

å®Œæ•´çš„å•†åº—é…ç½®JSONç¤ºä¾‹ï¼š

```json
{
  "shops": [
    {
      "id": "shop_general_town",
      "name": "åŸé•‡æ‚è´§é“º",
      "shopType": "General",
      "unlockConditionExpr": null,
      "refreshInterval": "Never",
      "items": [...]
    },
    {
      "id": "shop_equipment_blacksmith",
      "name": "é“åŒ é“º",
      "shopType": "Equipment",
      "unlockConditionExpr": "level>=10",
      "refreshInterval": "Daily",
      "items": [...]
    },
    {
      "id": "shop_reputation_faction_a",
      "name": "é˜³å…‰è”ç›Ÿå†›éœ€å®˜",
      "shopType": "Reputation",
      "unlockConditionExpr": "reputation.faction_a>=Friendly",
      "refreshInterval": "Never",
      "items": [...]
    }
  ]
}
```

---

**æ–‡æ¡£ç»“æŸ - è¯·ç»§ç»­é˜…è¯»ã€Šå•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰ã€‹**
