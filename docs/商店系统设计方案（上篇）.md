# BlazorIdle 商店系统设计方案（上篇）
## 架构设计与核心功能

**项目**: BlazorIdle  
**文档类型**: 设计方案 - 上篇  
**创建日期**: 2025-10-12  
**版本**: 1.0  
**状态**: 设计阶段  
**作者**: 系统架构团队

---

## 📋 目录

1. [设计概述](#1-设计概述)
2. [需求分析](#2-需求分析)
3. [系统架构设计](#3-系统架构设计)
4. [核心领域模型](#4-核心领域模型)
5. [商店类型设计](#5-商店类型设计)
6. [交易货币系统](#6-交易货币系统)
7. [条件解锁集成](#7-条件解锁集成)

---

## 1. 设计概述

### 1.1 背景与目标

根据项目整合设计总结和装备系统文档，BlazorIdle 当前已经具备：
- ✅ 完善的战斗系统（双轨机制、技能系统）
- ✅ 经济系统基础（EconomyRegistry、掉落表、物品定义）
- ✅ 装备系统框架（装备实例、词条、品级）
- ✅ 背包系统（InventoryItem）
- ✅ 角色系统（属性、等级、职业）
- ⚠️ 条件解锁DSL（设计中，待实施）

**商店系统目标**：
1. **覆盖游戏设计中的大部分功能需求**
   - 支持消耗品购买（食物、药剂）
   - 支持装备购买（各品质、各槽位）
   - 支持材料购买（制作材料、强化材料）
   - 支持特殊物品交易（任务道具、稀有材料）

2. **支持非金币交易机制**
   - 声望货币（派系声望点数）
   - 荣誉货币（PvP/挑战获得）
   - 特殊代币（活动、成就奖励）
   - 多货币组合交易

3. **适配条件解锁系统**
   - 商店解锁条件（等级、任务、声望）
   - 商品解锁条件（进度、成就）
   - 限购机制（日限购、周限购、终身限购）
   - 刷新机制（固定库存、定时刷新）

4. **为未来扩展预留接口**
   - 动态定价系统
   - 拍卖行系统
   - 玩家间交易
   - 黑市/限时商店

### 1.2 设计原则

基于项目《整合设计总结.txt》第3节"架构与工程原则"：

1. **服务端权威 (Server Authoritative)**
   - 所有交易在服务端验证和执行
   - 价格计算、库存检查服务端完成
   - 防止客户端作弊和价格操控

2. **数据驱动 (Data-Driven)**
   - 商店定义配置化（JSON/数据表）
   - 商品配置化（价格、库存、刷新规则）
   - 便于运营调整和内容扩展

3. **事件驱动 (Event-Driven)**
   - 购买事件（PurchaseCompleted）
   - 库存变更事件（StockChanged）
   - 刷新事件（ShopRefreshed）
   - 解锁事件（ShopUnlocked）

4. **领域驱动设计 (DDD)**
   - Shop 聚合根（商店实例）
   - ShopItem 值对象（商品项）
   - Transaction 实体（交易记录）

5. **可测试性与监控**
   - 单元测试覆盖核心逻辑
   - 交易幂等性保证
   - 经济监控指标（购买频率、货币流通）

6. **安全性**
   - 交易限频（防刷）
   - 价格验证（防篡改）
   - 库存锁定（并发控制）

### 1.3 与现有系统的关系

```
商店系统集成点
├── 经济系统 (Economy)
│   ├── EconomyRegistry: 物品定义查询
│   ├── RewardGrantService: 物品发放到背包
│   └── EconomyCalculator: 掉落/产出计算
│
├── 装备系统 (Equipment)
│   ├── GearDefinition: 装备定义查询
│   ├── GearGenerationService: 装备实例生成
│   └── 可购买装备直接生成实例
│
├── 背包系统 (Inventory)
│   ├── InventoryItem: 购买后物品入库
│   └── 背包容量检查
│
├── 角色系统 (Character)
│   ├── 金币扣除/增加
│   ├── 等级/职业检查
│   └── 声望值查询
│
├── 条件解锁系统 (Unlock) - 待实施
│   ├── ConditionExpr: 商店解锁条件
│   ├── ConditionCache: 条件结果缓存
│   └── 商品可见性/可购买性判定
│
└── 任务/成就系统 (Future)
    └── 购买任务道具、成就奖励兑换
```

---

## 2. 需求分析

### 2.1 功能性需求

#### 2.1.1 商店类型

| 商店类型 | 描述 | 货币类型 | 刷新机制 | 优先级 |
|---------|------|---------|---------|--------|
| **普通商店** | 基础消耗品、低级装备 | 金币 | 固定库存 | P1 (高) |
| **装备商店** | 各品质装备、武器防具 | 金币 | 日刷新 | P1 (高) |
| **材料商店** | 制作材料、强化材料 | 金币 | 周刷新 | P2 (中) |
| **声望商店** | 派系专属物品、配方 | 声望点 | 固定库存 | P2 (中) |
| **荣誉商店** | 挑战奖励、稀有装备 | 荣誉点 | 周刷新 | P3 (低) |
| **代币商店** | 活动代币兑换 | 活动代币 | 固定库存 | P3 (低) |
| **限时商店** | 限时折扣、稀有物品 | 金币+代币 | 限时刷新 | P4 (未来) |
| **黑市** | 禁忌物品、高风险高收益 | 特殊货币 | 随机刷新 | P4 (未来) |

#### 2.1.2 商品类型

| 商品分类 | 子类型 | 示例 |
|---------|--------|------|
| **消耗品** | 食物 | 面包(+50HP)、肉(+200HP) |
|           | 药剂 | 生命药水、法力药水、增益药剂 |
|           | 卷轴 | 传送卷、鉴定卷 |
| **装备** | 武器 | 剑、斧、法杖、弓 |
|         | 防具 | 头盔、胸甲、腿甲、靴子 |
|         | 饰品 | 戒指、项链 |
| **材料** | 制作材料 | 铁矿、布料、木材 |
|         | 强化材料 | 磨刀石、附魔粉尘 |
|         | 分解材料 | 装备碎片、精华 |
| **特殊物品** | 任务道具 | 钥匙、信件 |
|             | 配方 | 制作配方、附魔配方 |
|             | 宠物/坐骑 | (未来扩展) |
| **货币代币** | 兑换券 | 商店刷新券、折扣券 |
|             | 活动代币 | 节日代币、成就代币 |

#### 2.1.3 核心功能清单

| 功能模块 | 功能点 | 描述 |
|---------|--------|------|
| **商店管理** | 商店创建 | 动态创建商店实例 |
|            | 商店配置 | 名称、图标、解锁条件 |
|            | 商店刷新 | 定时/手动刷新库存 |
|            | 商店分类 | 商店标签、排序 |
| **商品管理** | 商品上架 | 添加商品到商店 |
|            | 商品定价 | 单/多货币定价 |
|            | 库存管理 | 无限/有限库存 |
|            | 限购管理 | 日/周/终身限购 |
| **交易功能** | 购买商品 | 单次购买、批量购买 |
|            | 货币扣除 | 金币、声望、代币 |
|            | 物品发放 | 自动进背包/邮件 |
|            | 交易记录 | 购买历史、统计 |
| **条件系统** | 商店解锁 | 等级、任务、声望条件 |
|            | 商品解锁 | 进度、成就条件 |
|            | 可见性控制 | 未解锁商品隐藏/灰显 |
| **扩展功能** | 折扣系统 | VIP折扣、活动折扣 |
|            | 回购功能 | 误卖回购（24h内） |
|            | 预览功能 | 装备属性预览 |
|            | 搜索/筛选 | 按类型、价格、品质筛选 |

### 2.2 非功能性需求

| 需求类型 | 具体要求 |
|---------|---------|
| **性能** | 商店列表加载 < 500ms |
|         | 单次购买响应 < 200ms |
|         | 支持100+商品展示 |
| **并发** | 支持多用户同时购买（有限库存商品） |
|         | 乐观锁/悲观锁机制 |
| **安全** | 交易限频（10次/分钟） |
|         | 价格防篡改验证 |
|         | 库存防刷机制 |
| **可扩展** | 新增商店类型无需改代码 |
|          | 新增货币类型配置化 |
| **监控** | 交易流水记录 |
|         | 货币流通监控 |
|         | 热销商品统计 |
| **兼容性** | 向后兼容现有数据 |
|          | 不破坏现有经济系统 |

### 2.3 数据需求

#### 2.3.1 核心数据表

```
数据表设计概览

ShopDefinition (商店定义 - 配置表)
├── Id (商店ID)
├── Name (商店名称)
├── Description (描述)
├── ShopType (商店类型)
├── Icon (图标)
├── UnlockConditionExpr (解锁条件DSL)
├── SortOrder (排序)
└── IsActive (是否启用)

ShopInstance (商店实例 - 运行时)
├── Id (实例ID)
├── ShopDefinitionId (商店定义ID)
├── LastRefreshTime (上次刷新时间)
├── NextRefreshTime (下次刷新时间)
├── RefreshCount (刷新计数)
└── CurrentStock (当前库存快照)

ShopItem (商品定义 - 配置表)
├── Id (商品ID)
├── ShopId (所属商店ID)
├── ItemType (物品类型: Consumable/Equipment/Material)
├── ItemId (物品定义ID)
├── DisplayOrder (显示顺序)
├── UnlockConditionExpr (解锁条件)
├── IsVisible (是否可见)
└── IsActive (是否启用)

ShopItemPrice (商品价格 - 配置表)
├── ShopItemId (商品ID)
├── CurrencyType (货币类型: Gold/Reputation/Honor/Token)
├── CurrencyId (货币ID - 用于声望/代币)
├── Amount (价格数量)
└── DiscountFactor (折扣系数 0-1)

ShopItemStock (商品库存 - 运行时)
├── ShopItemId (商品ID)
├── StockType (库存类型: Infinite/Limited/Personal)
├── TotalStock (总库存 - null表示无限)
├── CurrentStock (当前库存)
├── RefreshInterval (刷新间隔)
└── LastRestockTime (上次补货时间)

ShopItemPurchaseLimit (限购规则 - 配置表)
├── ShopItemId (商品ID)
├── LimitType (限制类型: PerDay/PerWeek/Lifetime/PerRefresh)
├── MaxQuantity (最大数量)
└── ResetTime (重置时间)

PurchaseHistory (购买历史 - 运行时)
├── Id (交易ID)
├── CharacterId (角色ID)
├── ShopItemId (商品ID)
├── Quantity (购买数量)
├── TotalCost (总花费) - JSON: {Gold: 100, Honor: 50}
├── PurchaseTime (购买时间)
└── TransactionId (幂等性键)
```

---

## 3. 系统架构设计

### 3.1 架构分层

基于项目现有的 DDD 架构：

```
架构层次划分

┌─────────────────────────────────────────┐
│   Presentation Layer (表现层)            │
│   BlazorIdle/Pages/                     │
│   - ShopList.razor (商店列表页)          │
│   - ShopDetail.razor (商店详情页)        │
│   - ShopPurchaseModal.razor (购买确认框)│
└─────────────────────────────────────────┘
                    │
                    ↓ HTTP API
┌─────────────────────────────────────────┐
│   API Layer (接口层)                     │
│   BlazorIdle.Server/Controllers/        │
│   - ShopController.cs                   │
│   - PurchaseController.cs               │
└─────────────────────────────────────────┘
                    │
                    ↓ Application Services
┌─────────────────────────────────────────┐
│   Application Layer (应用层)             │
│   BlazorIdle.Server/Application/Shop/   │
│   - ShopService.cs (商店服务)            │
│   - PurchaseService.cs (购买服务)        │
│   - ShopRefreshService.cs (刷新服务)    │
│   - ShopUnlockService.cs (解锁服务)     │
└─────────────────────────────────────────┘
                    │
                    ↓ Domain Logic
┌─────────────────────────────────────────┐
│   Domain Layer (领域层)                  │
│   BlazorIdle.Server/Domain/Shop/        │
│   - Models/                             │
│     ├── ShopAggregate.cs                │
│     ├── ShopItem.cs                     │
│     ├── PriceSpecification.cs           │
│     └── StockPolicy.cs                  │
│   - Services/                           │
│     ├── IShopRepository.cs              │
│     ├── IPurchaseValidator.cs           │
│     └── IStockManager.cs                │
│   - Events/                             │
│     ├── PurchaseCompletedEvent.cs       │
│     ├── ShopRefreshedEvent.cs           │
│     └── StockDepletedEvent.cs           │
└─────────────────────────────────────────┘
                    │
                    ↓ Data Access
┌─────────────────────────────────────────┐
│   Infrastructure Layer (基础设施层)       │
│   BlazorIdle.Server/Infrastructure/     │
│   - Persistence/                        │
│     ├── ShopRepository.cs               │
│     └── PurchaseHistoryRepository.cs    │
│   - Configuration/                      │
│     └── ShopEntityConfiguration.cs      │
└─────────────────────────────────────────┘
```

### 3.2 模块边界

```
商店系统模块划分

Shop Domain (商店领域)
├── Shop Management (商店管理)
│   ├── ShopDefinition: 商店定义配置
│   ├── ShopInstance: 商店运行时实例
│   ├── ShopRepository: 商店仓储
│   └── ShopRefreshService: 刷新服务
│
├── Item Management (商品管理)
│   ├── ShopItem: 商品定义
│   ├── PriceSpecification: 价格规格
│   ├── StockPolicy: 库存策略
│   └── PurchaseLimit: 限购规则
│
├── Transaction (交易管理)
│   ├── PurchaseService: 购买服务
│   ├── PurchaseValidator: 购买验证器
│   ├── CurrencyExchanger: 货币兑换器
│   └── TransactionLogger: 交易日志
│
├── Unlock & Condition (解锁与条件)
│   ├── ShopUnlockService: 商店解锁
│   ├── ItemVisibilityService: 商品可见性
│   └── ConditionEvaluator: 条件评估器
│
└── Events (领域事件)
    ├── PurchaseCompletedEvent: 购买完成
    ├── ShopRefreshedEvent: 商店刷新
    ├── StockChangedEvent: 库存变更
    └── ShopUnlockedEvent: 商店解锁

外部依赖接口
├── IEconomyService: 经济系统集成
├── IInventoryService: 背包系统集成
├── ICharacterService: 角色系统集成
├── IConditionService: 条件系统集成 (待实施)
└── IRewardGrantService: 奖励发放集成
```

### 3.3 核心工作流

#### 3.3.1 购买流程

```
购买流程 (Purchase Flow)

1. 用户请求购买
   POST /api/shop/purchase
   Body: { shopItemId, quantity, characterId }
   │
   ↓
2. 购买服务验证
   PurchaseService.ValidatePurchase()
   ├── 检查商店是否解锁
   ├── 检查商品是否解锁
   ├── 检查限购规则
   ├── 检查库存是否充足
   ├── 检查货币是否足够
   └── 检查背包容量
   │
   ↓
3. 执行交易 (事务)
   PurchaseService.ExecutePurchase()
   BEGIN TRANSACTION
   ├── 扣除货币 (Character.Gold -= cost)
   ├── 扣减库存 (Stock.CurrentStock -= qty)
   ├── 发放物品 (InventoryService.AddItem)
   ├── 记录限购 (PurchaseHistory.Insert)
   ├── 记录交易日志 (TransactionLog.Insert)
   └── 发布领域事件 (PurchaseCompletedEvent)
   COMMIT TRANSACTION
   │
   ↓
4. 返回结果
   Response: { success, itemsGranted, remainingCurrency }
```

#### 3.3.2 刷新流程

```
商店刷新流程 (Refresh Flow)

1. 触发刷新
   - 定时任务触发 (Cron Job)
   - 玩家手动触发 (使用刷新券)
   - 商店首次访问触发
   │
   ↓
2. 刷新服务处理
   ShopRefreshService.RefreshShop(shopId)
   ├── 检查是否需要刷新 (时间到期?)
   ├── 获取商店定义
   ├── 获取刷新规则配置
   │
   ↓
3. 生成新库存
   StockGenerationService.GenerateStock()
   ├── 固定商品: 重置库存
   ├── 随机商品: 从商品池随机选择
   ├── 品质随机: 根据权重Roll品质
   └── 价格浮动: 应用价格波动 (可选)
   │
   ↓
4. 持久化与通知
   ├── 更新 ShopInstance.LastRefreshTime
   ├── 更新 ShopItemStock 表
   ├── 发布 ShopRefreshedEvent
   └── 通知在线玩家 (SignalR推送)
```

---

## 4. 核心领域模型

### 4.1 商店聚合根 (ShopAggregate)

```csharp
/// <summary>
/// 商店聚合根 - 商店实例的完整状态
/// </summary>
public class ShopAggregate
{
    public Guid Id { get; private set; }
    public string ShopDefinitionId { get; private set; }
    public ShopDefinition Definition { get; private set; }
    
    // 刷新状态
    public DateTime LastRefreshTime { get; private set; }
    public DateTime? NextRefreshTime { get; private set; }
    public int RefreshCount { get; private set; }
    
    // 商品集合
    private readonly List<ShopItemInstance> _items = new();
    public IReadOnlyList<ShopItemInstance> Items => _items.AsReadOnly();
    
    // 解锁状态缓存
    private bool _isUnlocked;
    public bool IsUnlocked => _isUnlocked;
    
    /// <summary>
    /// 检查商店是否需要刷新
    /// </summary>
    public bool NeedsRefresh(DateTime currentTime)
    {
        if (NextRefreshTime == null) return false;
        return currentTime >= NextRefreshTime.Value;
    }
    
    /// <summary>
    /// 刷新商店
    /// </summary>
    public void Refresh(DateTime refreshTime, List<ShopItemInstance> newItems)
    {
        LastRefreshTime = refreshTime;
        NextRefreshTime = CalculateNextRefreshTime(refreshTime);
        RefreshCount++;
        
        _items.Clear();
        _items.AddRange(newItems);
        
        // 发布领域事件
        AddDomainEvent(new ShopRefreshedEvent(Id, refreshTime, newItems.Count));
    }
    
    /// <summary>
    /// 购买商品
    /// </summary>
    public PurchaseResult PurchaseItem(
        string shopItemId, 
        int quantity, 
        Guid characterId,
        IPurchaseValidator validator)
    {
        var item = _items.FirstOrDefault(i => i.ShopItemId == shopItemId);
        if (item == null)
            return PurchaseResult.Fail("商品不存在");
            
        // 验证购买条件
        var validationResult = validator.Validate(item, quantity, characterId);
        if (!validationResult.IsSuccess)
            return PurchaseResult.Fail(validationResult.ErrorMessage);
            
        // 扣减库存
        if (!item.DeductStock(quantity))
            return PurchaseResult.Fail("库存不足");
            
        // 记录购买（由服务层完成货币扣除和物品发放）
        return PurchaseResult.Success(item, quantity);
    }
    
    private DateTime? CalculateNextRefreshTime(DateTime from)
    {
        return Definition.RefreshInterval switch
        {
            RefreshInterval.Daily => from.Date.AddDays(1),
            RefreshInterval.Weekly => from.Date.AddDays(7 - (int)from.DayOfWeek),
            RefreshInterval.Hourly => from.AddHours(1),
            RefreshInterval.Never => null,
            _ => null
        };
    }
}
```

### 4.2 商店定义 (ShopDefinition)

```csharp
/// <summary>
/// 商店定义 - 静态配置数据
/// </summary>
public class ShopDefinition
{
    public string Id { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public ShopType ShopType { get; set; }
    public string Icon { get; set; } = string.Empty;
    
    // 解锁条件
    public string? UnlockConditionExpr { get; set; }
    
    // 刷新规则
    public RefreshInterval RefreshInterval { get; set; }
    public bool AllowManualRefresh { get; set; }
    public int? ManualRefreshCost { get; set; } // 刷新券消耗
    
    // 排序与显示
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
    public List<string> Tags { get; set; } = new();
    
    // 商品列表
    public List<ShopItemDefinition> ItemDefinitions { get; set; } = new();
}

/// <summary>
/// 商店类型
/// </summary>
public enum ShopType
{
    General,      // 普通商店
    Equipment,    // 装备商店
    Material,     // 材料商店
    Reputation,   // 声望商店
    Honor,        // 荣誉商店
    Token,        // 代币商店
    Limited,      // 限时商店
    BlackMarket   // 黑市
}

/// <summary>
/// 刷新间隔
/// </summary>
public enum RefreshInterval
{
    Never,    // 永不刷新（固定库存）
    Hourly,   // 每小时
    Daily,    // 每日
    Weekly,   // 每周
    Monthly   // 每月
}
```

### 4.3 商品实例 (ShopItemInstance)

```csharp
/// <summary>
/// 商店商品实例 - 运行时状态
/// </summary>
public class ShopItemInstance
{
    public Guid Id { get; private set; }
    public string ShopItemId { get; private set; }
    public string ShopId { get; private set; }
    
    // 物品引用
    public ItemType ItemType { get; private set; }
    public string ItemId { get; private set; }
    
    // 价格信息
    private readonly List<CurrencyCost> _prices = new();
    public IReadOnlyList<CurrencyCost> Prices => _prices.AsReadOnly();
    
    // 库存信息
    public StockPolicy StockPolicy { get; private set; }
    public int? CurrentStock { get; private set; }
    public int? MaxStock { get; private set; }
    
    // 限购信息
    private readonly List<PurchaseLimit> _limits = new();
    public IReadOnlyList<PurchaseLimit> Limits => _limits.AsReadOnly();
    
    // 解锁条件
    public string? UnlockConditionExpr { get; private set; }
    public bool IsUnlocked { get; private set; }
    public bool IsVisible { get; private set; }
    
    // 显示顺序
    public int DisplayOrder { get; private set; }
    
    /// <summary>
    /// 扣减库存
    /// </summary>
    public bool DeductStock(int quantity)
    {
        if (StockPolicy == StockPolicy.Infinite)
            return true;
            
        if (CurrentStock == null || CurrentStock < quantity)
            return false;
            
        CurrentStock -= quantity;
        return true;
    }
    
    /// <summary>
    /// 补充库存
    /// </summary>
    public void RestockToMax()
    {
        if (StockPolicy == StockPolicy.Limited && MaxStock.HasValue)
        {
            CurrentStock = MaxStock.Value;
        }
    }
    
    /// <summary>
    /// 计算总价格
    /// </summary>
    public Dictionary<CurrencyType, long> CalculateTotalCost(int quantity)
    {
        var result = new Dictionary<CurrencyType, long>();
        foreach (var price in _prices)
        {
            result[price.CurrencyType] = price.Amount * quantity;
        }
        return result;
    }
}

/// <summary>
/// 物品类型
/// </summary>
public enum ItemType
{
    Consumable,   // 消耗品
    Equipment,    // 装备
    Material,     // 材料
    Recipe,       // 配方
    Token,        // 代币
    Special       // 特殊物品
}

/// <summary>
/// 库存策略
/// </summary>
public enum StockPolicy
{
    Infinite,   // 无限库存
    Limited,    // 有限库存（全服共享）
    Personal    // 个人库存（每人独立）
}
```

### 4.4 价格规格 (CurrencyCost)

```csharp
/// <summary>
/// 货币花费
/// </summary>
public class CurrencyCost
{
    public CurrencyType CurrencyType { get; set; }
    public string? CurrencyId { get; set; } // 用于声望/代币类型
    public long Amount { get; set; }
    public double DiscountFactor { get; set; } = 1.0; // 折扣系数
    
    /// <summary>
    /// 计算实际花费
    /// </summary>
    public long CalculateActualCost()
    {
        return (long)(Amount * DiscountFactor);
    }
}

/// <summary>
/// 货币类型
/// </summary>
public enum CurrencyType
{
    Gold,         // 金币
    Reputation,   // 声望（需指定派系ID）
    Honor,        // 荣誉点
    Token,        // 代币（需指定代币ID）
    Achievement,  // 成就点
    Guild         // 公会贡献（未来）
}
```

### 4.5 限购规则 (PurchaseLimit)

```csharp
/// <summary>
/// 限购规则
/// </summary>
public class PurchaseLimit
{
    public Guid Id { get; set; }
    public string ShopItemId { get; set; } = string.Empty;
    
    public LimitType LimitType { get; set; }
    public int MaxQuantity { get; set; }
    
    // 重置时间（用于日限购/周限购）
    public DateTime? LastResetTime { get; set; }
    public DateTime? NextResetTime { get; set; }
}

/// <summary>
/// 限制类型
/// </summary>
public enum LimitType
{
    PerDay,       // 每日限购
    PerWeek,      // 每周限购
    PerMonth,     // 每月限购
    PerRefresh,   // 每次刷新限购
    Lifetime      // 终身限购
}

/// <summary>
/// 角色购买记录
/// </summary>
public class CharacterPurchaseRecord
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    public string ShopItemId { get; set; } = string.Empty;
    
    public int PurchasedToday { get; set; }
    public int PurchasedThisWeek { get; set; }
    public int PurchasedThisMonth { get; set; }
    public int PurchasedThisRefresh { get; set; }
    public int PurchasedLifetime { get; set; }
    
    public DateTime LastPurchaseTime { get; set; }
    public DateTime LastDailyReset { get; set; }
    public DateTime LastWeeklyReset { get; set; }
    public DateTime LastMonthlyReset { get; set; }
    public DateTime? LastRefreshReset { get; set; }
    
    /// <summary>
    /// 检查是否超出限购
    /// </summary>
    public bool IsLimitExceeded(PurchaseLimit limit, int requestQuantity)
    {
        var current = limit.LimitType switch
        {
            LimitType.PerDay => PurchasedToday,
            LimitType.PerWeek => PurchasedThisWeek,
            LimitType.PerMonth => PurchasedThisMonth,
            LimitType.PerRefresh => PurchasedThisRefresh,
            LimitType.Lifetime => PurchasedLifetime,
            _ => 0
        };
        
        return (current + requestQuantity) > limit.MaxQuantity;
    }
    
    /// <summary>
    /// 记录购买
    /// </summary>
    public void RecordPurchase(int quantity, DateTime purchaseTime)
    {
        PurchasedToday += quantity;
        PurchasedThisWeek += quantity;
        PurchasedThisMonth += quantity;
        PurchasedThisRefresh += quantity;
        PurchasedLifetime += quantity;
        LastPurchaseTime = purchaseTime;
    }
}
```

---

## 5. 商店类型设计

### 5.1 普通商店 (General Shop)

**定位**: 新手友好，提供基础消耗品和低级装备

```json
{
  "id": "shop_general_town",
  "name": "城镇杂货铺",
  "description": "出售日常消耗品和基础装备",
  "shopType": "General",
  "icon": "shop_general.png",
  "unlockConditionExpr": null,
  "refreshInterval": "Never",
  "allowManualRefresh": false,
  "sortOrder": 1,
  "isActive": true,
  "itemDefinitions": [
    {
      "shopItemId": "item_bread",
      "itemType": "Consumable",
      "itemId": "consumable_bread",
      "prices": [
        { "currencyType": "Gold", "amount": 5 }
      ],
      "stockPolicy": "Infinite",
      "purchaseLimits": [],
      "displayOrder": 1
    },
    {
      "shopItemId": "item_health_potion_minor",
      "itemType": "Consumable",
      "itemId": "potion_health_minor",
      "prices": [
        { "currencyType": "Gold", "amount": 20 }
      ],
      "stockPolicy": "Infinite",
      "purchaseLimits": [],
      "displayOrder": 2
    },
    {
      "shopItemId": "item_sword_iron",
      "itemType": "Equipment",
      "itemId": "weapon_sword_iron",
      "prices": [
        { "currencyType": "Gold", "amount": 100 }
      ],
      "stockPolicy": "Infinite",
      "unlockConditionExpr": "level>=5",
      "displayOrder": 10
    }
  ]
}
```

### 5.2 装备商店 (Equipment Shop)

**定位**: 提供各等级段装备，每日刷新品质

```json
{
  "id": "shop_equipment_blacksmith",
  "name": "铁匠铺",
  "description": "出售精良装备，每日更新库存",
  "shopType": "Equipment",
  "icon": "shop_blacksmith.png",
  "unlockConditionExpr": "level>=10",
  "refreshInterval": "Daily",
  "allowManualRefresh": true,
  "manualRefreshCost": 50,
  "sortOrder": 2,
  "itemDefinitions": [
    {
      "shopItemId": "random_weapon_tier1",
      "itemType": "Equipment",
      "itemId": "random:weapon:tier1",
      "prices": [
        { "currencyType": "Gold", "amount": 500 }
      ],
      "stockPolicy": "Limited",
      "maxStock": 3,
      "purchaseLimits": [
        { "limitType": "PerDay", "maxQuantity": 2 }
      ],
      "displayOrder": 1
    },
    {
      "shopItemId": "epic_chest_armor",
      "itemType": "Equipment",
      "itemId": "armor_chest_epic_01",
      "prices": [
        { "currencyType": "Gold", "amount": 2000 }
      ],
      "stockPolicy": "Limited",
      "maxStock": 1,
      "purchaseLimits": [
        { "limitType": "PerWeek", "maxQuantity": 1 }
      ],
      "unlockConditionExpr": "level>=20",
      "displayOrder": 5
    }
  ]
}
```

### 5.3 声望商店 (Reputation Shop)

**定位**: 派系专属物品，需要声望点购买

```json
{
  "id": "shop_reputation_faction_a",
  "name": "阳光联盟军需官",
  "description": "兑换联盟专属装备和配方",
  "shopType": "Reputation",
  "icon": "shop_faction_a.png",
  "unlockConditionExpr": "reputation.faction_a>=Friendly",
  "refreshInterval": "Never",
  "sortOrder": 10,
  "itemDefinitions": [
    {
      "shopItemId": "recipe_enchant_fire",
      "itemType": "Recipe",
      "itemId": "recipe_enchant_fire_weapon",
      "prices": [
        { 
          "currencyType": "Reputation", 
          "currencyId": "faction_a",
          "amount": 500 
        }
      ],
      "stockPolicy": "Personal",
      "purchaseLimits": [
        { "limitType": "Lifetime", "maxQuantity": 1 }
      ],
      "unlockConditionExpr": "reputation.faction_a>=Honored",
      "displayOrder": 1
    },
    {
      "shopItemId": "mount_faction_a",
      "itemType": "Special",
      "itemId": "mount_griffin",
      "prices": [
        { 
          "currencyType": "Reputation", 
          "currencyId": "faction_a",
          "amount": 2000 
        },
        { "currencyType": "Gold", "amount": 5000 }
      ],
      "stockPolicy": "Personal",
      "purchaseLimits": [
        { "limitType": "Lifetime", "maxQuantity": 1 }
      ],
      "unlockConditionExpr": "reputation.faction_a>=Exalted",
      "displayOrder": 100
    }
  ]
}
```

### 5.4 荣誉商店 (Honor Shop)

**定位**: PvP/挑战奖励兑换，每周刷新

```json
{
  "id": "shop_honor_arena",
  "name": "竞技场商人",
  "description": "兑换荣誉装备和特殊道具",
  "shopType": "Honor",
  "icon": "shop_honor.png",
  "unlockConditionExpr": "achievement.first_arena_win",
  "refreshInterval": "Weekly",
  "sortOrder": 15,
  "itemDefinitions": [
    {
      "shopItemId": "weapon_pvp_epic",
      "itemType": "Equipment",
      "itemId": "weapon_sword_pvp_s1",
      "prices": [
        { "currencyType": "Honor", "amount": 1000 }
      ],
      "stockPolicy": "Personal",
      "purchaseLimits": [
        { "limitType": "PerWeek", "maxQuantity": 1 }
      ],
      "unlockConditionExpr": "honor_rating>=1500",
      "displayOrder": 1
    }
  ]
}
```

---

## 6. 交易货币系统

### 6.1 货币类型定义

| 货币类型 | 标识 | 获取方式 | 用途 | 是否有上限 |
|---------|-----|---------|------|----------|
| **金币** | Gold | 战斗掉落、任务奖励、出售物品 | 通用购买 | 否 |
| **声望点** | Reputation:{FactionId} | 完成派系任务、副本 | 派系商店 | 否 |
| **荣誉点** | Honor | PvP胜利、竞技场 | 荣誉商店 | 否 |
| **活动代币** | Token:{TokenId} | 限时活动、成就 | 代币商店 | 取决于活动 |
| **成就点** | Achievement | 完成成就 | 成就商店 | 否 |

### 6.2 货币存储设计

#### 6.2.1 金币存储（现有）

```csharp
// 已存在于 Character 实体
public class Character
{
    public Guid Id { get; set; }
    public long Gold { get; set; } // 金币存储
    // ...其他属性
}
```

#### 6.2.2 声望存储（新增）

```csharp
/// <summary>
/// 声望记录表
/// </summary>
public class ReputationRecord
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    public string FactionId { get; set; } = string.Empty;
    
    public int ReputationPoints { get; set; } // 声望点数
    public ReputationLevel Level { get; set; } // 声望等级
    
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // 导航属性
    public Character Character { get; set; } = null!;
}

/// <summary>
/// 声望等级
/// </summary>
public enum ReputationLevel
{
    Hated = 0,      // 仇恨 (-6000 ~ -3000)
    Hostile = 1,    // 敌对 (-3000 ~ 0)
    Neutral = 2,    // 中立 (0 ~ 3000)
    Friendly = 3,   // 友好 (3000 ~ 9000)
    Honored = 4,    // 尊敬 (9000 ~ 21000)
    Revered = 5,    // 崇敬 (21000 ~ 42000)
    Exalted = 6     // 崇拜 (42000+)
}
```

#### 6.2.3 荣誉/代币存储（新增）

```csharp
/// <summary>
/// 角色货币钱包
/// </summary>
public class CharacterWallet
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    
    public long Gold { get; set; } // 金币（从Character迁移）
    public long HonorPoints { get; set; } // 荣誉点
    public long AchievementPoints { get; set; } // 成就点
    
    public DateTime UpdatedAt { get; set; }
    
    // 导航属性
    public Character Character { get; set; } = null!;
    public List<TokenBalance> TokenBalances { get; set; } = new();
}

/// <summary>
/// 代币余额
/// </summary>
public class TokenBalance
{
    public Guid Id { get; set; }
    public Guid WalletId { get; set; }
    
    public string TokenId { get; set; } = string.Empty; // 代币类型ID
    public long Amount { get; set; }
    public DateTime? ExpiresAt { get; set; } // 代币过期时间（可选）
    
    // 导航属性
    public CharacterWallet Wallet { get; set; } = null!;
}
```

### 6.3 货币兑换器服务

```csharp
/// <summary>
/// 货币兑换器接口
/// </summary>
public interface ICurrencyExchanger
{
    /// <summary>
    /// 检查角色是否有足够货币
    /// </summary>
    Task<bool> HasEnoughCurrency(
        Guid characterId, 
        List<CurrencyCost> costs, 
        CancellationToken ct = default);
    
    /// <summary>
    /// 扣除货币
    /// </summary>
    Task<CurrencyDeductionResult> DeductCurrency(
        Guid characterId, 
        List<CurrencyCost> costs,
        string reason,
        CancellationToken ct = default);
    
    /// <summary>
    /// 退还货币
    /// </summary>
    Task RefundCurrency(
        Guid characterId, 
        List<CurrencyCost> costs,
        string reason,
        CancellationToken ct = default);
    
    /// <summary>
    /// 获取角色货币余额
    /// </summary>
    Task<Dictionary<CurrencyType, long>> GetBalances(
        Guid characterId, 
        CancellationToken ct = default);
}

/// <summary>
/// 货币扣除结果
/// </summary>
public class CurrencyDeductionResult
{
    public bool Success { get; set; }
    public string? ErrorMessage { get; set; }
    public Dictionary<CurrencyType, long> DeductedAmounts { get; set; } = new();
    public Dictionary<CurrencyType, long> RemainingBalances { get; set; } = new();
}
```

---

## 7. 条件解锁集成

### 7.1 条件DSL设计

基于《整合设计总结.txt》第12节"条件/解锁DSL与缓存体系"：

```
条件表达式语法

1. 基础比较
   - level>=20                  (等级大于等于20)
   - gold>1000                  (金币大于1000)
   
2. 声望条件
   - reputation.faction_a>=Honored     (声望等级)
   - reputation_points.faction_a>=5000 (声望点数)
   
3. 任务条件
   - quest.completed('Q123')    (任务已完成)
   - quest.active('Q456')       (任务进行中)
   
4. 成就条件
   - achievement.unlocked('ACH_001')
   - achievement_points>=500
   
5. 时间条件
   - date>=2025-12-25           (特定日期后)
   - time>=18:00                (每日时间段)
   
6. 装备条件
   - equipped.slot.weapon       (装备了武器)
   - equipment_level>=50        (装备等级)
   
7. 职业条件
   - profession==Warrior
   - profession_level.Warrior>=20
   
8. 逻辑组合
   - AND(level>=20, quest.completed('Q123'))
   - OR(gold>=1000, token.event_2025>=50)
   - NOT(quest.active('Q999'))
   - AND(level>=30, OR(reputation.faction_a>=Exalted, achievement.unlocked('ACH_MASTER')))
```

### 7.2 条件评估器接口

```csharp
/// <summary>
/// 条件评估器接口
/// </summary>
public interface IConditionEvaluator
{
    /// <summary>
    /// 评估条件表达式
    /// </summary>
    Task<bool> EvaluateAsync(
        string conditionExpr, 
        Guid characterId, 
        CancellationToken ct = default);
    
    /// <summary>
    /// 批量评估条件
    /// </summary>
    Task<Dictionary<string, bool>> EvaluateBatchAsync(
        List<string> conditionExprs, 
        Guid characterId, 
        CancellationToken ct = default);
    
    /// <summary>
    /// 解析条件依赖键
    /// </summary>
    List<string> ParseDependencies(string conditionExpr);
    
    /// <summary>
    /// 失效条件缓存
    /// </summary>
    void InvalidateCache(string dependencyKey);
}

/// <summary>
/// 条件上下文 - 用于条件评估
/// </summary>
public class ConditionContext
{
    public Guid CharacterId { get; set; }
    public int Level { get; set; }
    public long Gold { get; set; }
    public string Profession { get; set; } = string.Empty;
    
    public Dictionary<string, int> ReputationLevels { get; set; } = new();
    public Dictionary<string, bool> CompletedQuests { get; set; } = new();
    public Dictionary<string, bool> UnlockedAchievements { get; set; } = new();
    public Dictionary<string, long> TokenBalances { get; set; } = new();
    
    public DateTime CurrentTime { get; set; }
}
```

### 7.3 商店解锁服务

```csharp
/// <summary>
/// 商店解锁服务
/// </summary>
public class ShopUnlockService
{
    private readonly IConditionEvaluator _conditionEvaluator;
    private readonly IShopRepository _shopRepository;
    
    /// <summary>
    /// 获取角色已解锁的商店列表
    /// </summary>
    public async Task<List<ShopDefinition>> GetUnlockedShopsAsync(
        Guid characterId, 
        CancellationToken ct = default)
    {
        var allShops = await _shopRepository.GetAllActiveShopsAsync(ct);
        var unlockedShops = new List<ShopDefinition>();
        
        foreach (var shop in allShops)
        {
            if (string.IsNullOrEmpty(shop.UnlockConditionExpr))
            {
                // 无条件，默认解锁
                unlockedShops.Add(shop);
                continue;
            }
            
            var isUnlocked = await _conditionEvaluator.EvaluateAsync(
                shop.UnlockConditionExpr, 
                characterId, 
                ct);
                
            if (isUnlocked)
            {
                unlockedShops.Add(shop);
            }
        }
        
        return unlockedShops;
    }
    
    /// <summary>
    /// 获取商店内已解锁的商品
    /// </summary>
    public async Task<List<ShopItemInstance>> GetUnlockedItemsAsync(
        string shopId,
        Guid characterId,
        CancellationToken ct = default)
    {
        var shop = await _shopRepository.GetShopWithItemsAsync(shopId, ct);
        var unlockedItems = new List<ShopItemInstance>();
        
        foreach (var item in shop.Items)
        {
            // 检查商品解锁条件
            bool isUnlocked = true;
            if (!string.IsNullOrEmpty(item.UnlockConditionExpr))
            {
                isUnlocked = await _conditionEvaluator.EvaluateAsync(
                    item.UnlockConditionExpr, 
                    characterId, 
                    ct);
            }
            
            // 根据可见性策略决定是否返回
            if (isUnlocked || item.IsVisible)
            {
                item.IsUnlocked = isUnlocked;
                unlockedItems.Add(item);
            }
        }
        
        return unlockedItems;
    }
}
```

---

## 8. 下篇预告

**商店系统设计方案（中篇）** 将涵盖：
- 详细实施步骤（Phase 1-4）
- 数据库设计与迁移
- 核心服务实现
- API接口设计
- 前端组件设计

**商店系统设计方案（下篇）** 将涵盖：
- 系统集成测试
- 性能优化方案
- 监控与日志
- 安全性加固
- 运维与配置管理

---

## 附录A：领域事件定义

```csharp
/// <summary>
/// 购买完成事件
/// </summary>
public class PurchaseCompletedEvent : IDomainEvent
{
    public Guid CharacterId { get; set; }
    public string ShopId { get; set; } = string.Empty;
    public string ShopItemId { get; set; } = string.Empty;
    public int Quantity { get; set; }
    public Dictionary<CurrencyType, long> CostPaid { get; set; } = new();
    public DateTime PurchaseTime { get; set; }
}

/// <summary>
/// 商店刷新事件
/// </summary>
public class ShopRefreshedEvent : IDomainEvent
{
    public Guid ShopInstanceId { get; set; }
    public string ShopDefinitionId { get; set; } = string.Empty;
    public DateTime RefreshTime { get; set; }
    public int NewItemCount { get; set; }
}

/// <summary>
/// 库存耗尽事件
/// </summary>
public class StockDepletedEvent : IDomainEvent
{
    public string ShopItemId { get; set; } = string.Empty;
    public DateTime DepletedTime { get; set; }
}

/// <summary>
/// 商店解锁事件
/// </summary>
public class ShopUnlockedEvent : IDomainEvent
{
    public Guid CharacterId { get; set; }
    public string ShopDefinitionId { get; set; } = string.Empty;
    public DateTime UnlockTime { get; set; }
}
```

---

## 附录B：配置示例汇总

完整的商店配置JSON示例：

```json
{
  "shops": [
    {
      "id": "shop_general_town",
      "name": "城镇杂货铺",
      "shopType": "General",
      "unlockConditionExpr": null,
      "refreshInterval": "Never",
      "items": [...]
    },
    {
      "id": "shop_equipment_blacksmith",
      "name": "铁匠铺",
      "shopType": "Equipment",
      "unlockConditionExpr": "level>=10",
      "refreshInterval": "Daily",
      "items": [...]
    },
    {
      "id": "shop_reputation_faction_a",
      "name": "阳光联盟军需官",
      "shopType": "Reputation",
      "unlockConditionExpr": "reputation.faction_a>=Friendly",
      "refreshInterval": "Never",
      "items": [...]
    }
  ]
}
```

---

**文档结束 - 请继续阅读《商店系统设计方案（中篇）》**
