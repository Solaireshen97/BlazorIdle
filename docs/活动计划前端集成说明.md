# 活动计划前端集成说明

## 概述

本次更新将前端界面从直接调用战斗API改为使用活动计划系统，实现了完整的活动计划管理功能，同时保持了代码风格一致和最小化修改原则。

## 主要变更

### 1. API客户端扩展 (BlazorIdle/Services/ApiClient.cs)

新增活动计划相关方法：

```csharp
// 创建战斗计划
CreateCombatPlanAsync(characterId, slotIndex, limitType, limitValue, enemyId, enemyCount, ...)

// 创建地下城计划  
CreateDungeonPlanAsync(characterId, slotIndex, limitType, limitValue, dungeonId, loop, ...)

// 获取角色所有计划
GetCharacterPlansAsync(characterId)

// 获取单个计划
GetPlanAsync(planId)

// 启动计划（一般不需要手动调用，系统会自动启动）
StartPlanAsync(planId)

// 停止正在运行的计划
StopPlanAsync(planId)

// 取消待执行的计划
CancelPlanAsync(planId)

// 删除已完成或已取消的计划
DeletePlanAsync(planId)
```

新增数据传输对象：
- `ActivityPlanDto`: 活动计划信息
- `StartPlanResponse`: 启动计划响应

### 2. 前端界面改造 (BlazorIdle/Pages/Characters.razor)

#### 新增"4. 活动计划管理"部分

替代了原来直接调用Step战斗API的方式，提供了更高层次的活动计划管理界面：

**创建计划区域**：
- 活动类型选择：战斗/地下城
- 限制类型：时长限制/无限制
- 时长配置（秒）
- 槽位选择（0-4）
- 战斗参数：敌人、敌人数
- 地下城参数：地下城ID、循环模式
- Seed（可选）

**计划列表显示**：
- 表格形式展示所有计划
- 显示：ID、类型、状态、槽位、限制、执行时长、BattleId
- 按槽位和创建时间排序
- 状态用不同颜色标识：
  - 待执行（黄色）
  - 执行中（绿色）
  - 已完成（灰色）
  - 已取消（灰色）

**操作按钮**：
根据计划状态动态显示：
- 执行中：[停止] [查看战斗]
- 待执行：[取消]
- 已完成/已取消：[删除]

**当前战斗状态面板**：
实时显示正在运行的计划战斗状态：
- BattleId、SimSec、DPS、Segments、Completed
- Mode、Gold、Exp

#### 保留原有调试功能

将原来的"4. 异步 Step 战斗"重命名为"5. 异步 Step 战斗（调试）"，保留原有功能供开发调试使用。

### 3. 配置文件调整

**wwwroot/appsettings.json**：
```json
{
    "ApiBaseUrl": "http://localhost:5000"
}
```
更新API地址为后端服务器地址。

**BlazorIdle.Server/Program.cs**：
```csharp
policy.WithOrigins(
    "https://localhost:5001",
    "http://localhost:5001",  // 新增
    "http://localhost:5000"
)
```
添加http://localhost:5001到CORS允许列表，支持前端开发服务器访问。

## 核心特性

### 1. 自动启动机制

创建活动计划时，系统会自动检查：
- 如果角色当前没有运行中的任务 → 自动启动新计划
- 如果角色已有运行中的任务 → 新计划进入待执行队列

这简化了用户操作，无需手动调用启动接口。

### 2. 队列管理

支持同一角色的多个活动计划排队：
- 按槽位索引优先级排序（0 > 1 > 2 > 3 > 4）
- 同一槽位内按创建时间先后顺序
- 当前任务完成后自动启动下一个待执行任务

### 3. 状态机管理

清晰的状态转换流程：
```
创建 → 待执行 (Pending)
     ↓ (自动启动或队列推进)
   执行中 (Running)
     ↓ (完成或手动停止)
   已完成 (Completed)

待执行 → (手动取消) → 已取消 (Cancelled)
```

### 4. 实时状态更新

- 创建计划后自动开始轮询战斗状态
- 每2秒更新一次战斗进度
- 显示实时DPS、时长、收益等信息
- 计划完成后自动停止轮询

## 使用流程示例

### 场景1：创建一个5分钟战斗计划

1. 选择"活动类型"：战斗 (Combat)
2. 选择"限制类型"：时长限制
3. 输入"时长"：300秒
4. 选择"敌人"：Training Dummy
5. 点击"创建计划"
6. 系统自动启动，开始战斗
7. 在"活动计划列表"中看到状态为"执行中"
8. "当前计划战斗状态"面板实时显示战斗进度
9. 5分钟后计划自动完成，状态变为"已完成"

### 场景2：创建多个计划排队

1. 创建第一个计划（300秒）→ 自动启动，状态"执行中"
2. 创建第二个计划（600秒）→ 进入队列，状态"待执行"
3. 创建第三个计划（180秒）→ 进入队列，状态"待执行"
4. 第一个计划完成后，第二个计划自动启动
5. 第二个计划完成后，第三个计划自动启动

### 场景3：取消待执行的计划

1. 在"活动计划列表"中找到状态为"待执行"的计划
2. 点击该计划行的"取消"按钮
3. 计划状态变为"已取消"
4. 该计划不会再被执行
5. 可以点击"删除"按钮清理已取消的计划

### 场景4：停止正在运行的计划

1. 在"活动计划列表"中找到状态为"执行中"的计划
2. 点击该计划行的"停止"按钮
3. 系统停止战斗并保存结果
4. 计划状态变为"已完成"，显示执行时长
5. 如果有待执行的计划，会自动启动下一个

## 技术实现要点

### 1. 最小化修改

- 保持现有代码结构不变
- 复用现有的战斗状态轮询逻辑
- 不删除原有Step战斗功能（改为调试工具）
- 使用现有的UI组件和样式

### 2. 代码风格一致

- 遵循现有的命名规范
- 使用现有的布局结构（panel、card、table）
- 按钮样式与现有保持一致
- 状态颜色编码与现有约定一致

### 3. 错误处理

- 所有API调用都包含try-catch
- 错误信息显示在界面上（红色警告框）
- 不影响其他功能的正常使用

### 4. 资源管理

- 正确管理轮询定时器（CancellationTokenSource）
- 组件销毁时清理所有定时器
- 避免内存泄漏

## 与现有系统的兼容性

### 1. 保留现有功能

- 同步战斗测试功能完全保留
- 异步Step战斗调试功能完全保留（重命名为"调试"）
- 批量模拟器功能完全保留
- 背包系统功能完全保留

### 2. 数据兼容

- 使用相同的BattleId引用战斗记录
- 战斗状态API保持不变
- 可以通过活动计划查看对应的战斗详情

### 3. API层次

```
活动计划层 (新增)
    ↓ 调用
战斗协调器层 (StepBattleCoordinator)
    ↓ 调用  
战斗执行层 (BattleContext)
```

活动计划是更高层次的抽象，底层战斗系统保持不变。

## 未来扩展

当前实现为未来扩展预留了接口：

1. **多槽位并行**：虽然UI支持0-4槽位，但当前后端限制同时只能运行一个计划。未来可以支持不同槽位并行执行。

2. **更多活动类型**：界面已支持地下城类型，未来可以扩展采集、制作等活动类型。

3. **计划编辑**：当前不支持修改已创建的计划，未来可以添加编辑功能。

4. **计划模板**：可以保存常用的计划配置为模板，快速创建。

5. **批量操作**：可以添加批量取消、批量删除等功能。

## 测试验证

已通过浏览器测试验证以下功能：

✅ 创建战斗计划并自动启动  
✅ 创建第二个计划进入待执行队列  
✅ 取消待执行的计划  
✅ 停止正在运行的计划  
✅ 删除已完成/已取消的计划  
✅ 实时战斗状态显示正常  
✅ 计划列表排序正确  
✅ 状态颜色标识清晰  
✅ 操作按钮根据状态正确显示  

## 总结

本次更新成功地将前端界面集成到活动计划系统，实现了：

1. **用户体验提升**：从低层次的战斗API调用提升到高层次的活动计划管理
2. **功能完整性**：支持创建、停止、取消、删除等完整的生命周期管理
3. **代码质量**：保持现有代码风格，最小化修改，易于维护
4. **系统扩展性**：为未来更多活动类型和功能预留了扩展接口

活动计划系统现在可以为玩家提供更好的挂机体验，支持灵活的任务规划和自动化执行。
