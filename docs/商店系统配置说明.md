# 商店系统配置说明

**文档版本**: 1.0  
**创建日期**: 2025-10-12  
**更新日期**: 2025-10-12

---

## 📋 目录

1. [配置概述](#配置概述)
2. [配置参数详解](#配置参数详解)
3. [配置示例](#配置示例)
4. [使用说明](#使用说明)
5. [最佳实践](#最佳实践)

---

## 配置概述

商店系统的所有可配置参数都集中在 `appsettings.json` 的 `Shop` 配置节中。通过配置文件管理这些参数，可以在不修改代码的情况下调整系统行为。

### 设计原则

1. **数据驱动**：所有业务参数通过配置管理
2. **灵活性**：支持不同环境使用不同配置
3. **可维护性**：集中管理，易于查找和修改
4. **类型安全**：使用强类型配置类（ShopSettings）

---

## 配置参数详解

### 1. DailyResetPeriodSeconds

**类型**: `int`  
**默认值**: `86400`（24小时）  
**描述**: 每日购买限制的重置周期（秒）

当商品设置为"每日限购"时，系统使用此值判断是否需要重置购买计数器。

**示例场景**:
- 默认值 86400 秒 = 24 小时
- 如果需要 12 小时重置一次，可设置为 43200

```json
{
  "Shop": {
    "DailyResetPeriodSeconds": 86400
  }
}
```

---

### 2. WeeklyResetPeriodSeconds

**类型**: `int`  
**默认值**: `604800`（7天）  
**描述**: 每周购买限制的重置周期（秒）

当商品设置为"每周限购"时，系统使用此值判断是否需要重置购买计数器。

**示例场景**:
- 默认值 604800 秒 = 7 天
- 如果需要按活动周期（如5天）重置，可设置为 432000

```json
{
  "Shop": {
    "WeeklyResetPeriodSeconds": 604800
  }
}
```

---

### 3. DefaultPageSize

**类型**: `int`  
**默认值**: `20`  
**描述**: 购买历史查询的默认分页大小

当前端未指定分页大小或指定值≤0时，使用此默认值。

**推荐范围**: 10-50

```json
{
  "Shop": {
    "DefaultPageSize": 20
  }
}
```

---

### 4. MaxPageSize

**类型**: `int`  
**默认值**: `100`  
**描述**: 购买历史查询的最大分页大小

防止客户端请求过大的页面，保护服务器性能。

**推荐范围**: 50-200

```json
{
  "Shop": {
    "MaxPageSize": 100
  }
}
```

---

### 5. ShopDefinitionCacheMinutes

**类型**: `int`  
**默认值**: `5`  
**描述**: 商店定义的缓存时间（分钟）

商店定义（商店列表）变化频率较低，可以缓存较长时间。

**推荐值**:
- 开发环境: 1-2 分钟（方便测试）
- 生产环境: 5-10 分钟（平衡性能和实时性）

```json
{
  "Shop": {
    "ShopDefinitionCacheMinutes": 5
  }
}
```

---

### 6. ShopItemsCacheMinutes

**类型**: `int`  
**默认值**: `2`  
**描述**: 商品列表的缓存时间（分钟）

商品列表包含库存、购买次数等动态数据，需要较短的缓存时间。

**推荐值**:
- 开发环境: 0.5-1 分钟
- 生产环境: 1-3 分钟

```json
{
  "Shop": {
    "ShopItemsCacheMinutes": 2
  }
}
```

---

### 7. EnablePurchaseLimit

**类型**: `bool`  
**默认值**: `true`  
**描述**: 是否启用购买限制验证

如果设为 false，系统将跳过购买限制检查（仅用于测试）。

**注意**: 生产环境应始终保持为 `true`

```json
{
  "Shop": {
    "EnablePurchaseLimit": true
  }
}
```

---

### 8. EnableCache

**类型**: `bool`  
**默认值**: `true`  
**描述**: 是否启用缓存功能

如果设为 false，系统将禁用所有商店相关缓存。

**使用场景**:
- 开发/测试: 可设为 false，确保数据实时性
- 生产环境: 应设为 true，提升性能

```json
{
  "Shop": {
    "EnableCache": true
  }
}
```

---

### 9. CleanupSchedule

**类型**: `string`  
**默认值**: `"0 0 * * *"`  
**描述**: 购买计数器清理计划（Cron 表达式）

定期清理过期的购买计数器，释放数据库空间。

**Cron 表达式说明**:
- `"0 0 * * *"`: 每天凌晨 0 点
- `"0 2 * * *"`: 每天凌晨 2 点
- `"0 */6 * * *"`: 每 6 小时一次
- `"0 0 * * 0"`: 每周日凌晨

```json
{
  "Shop": {
    "CleanupSchedule": "0 0 * * *"
  }
}
```

**注意**: 此功能预留接口，具体实现待后续版本

---

## 配置示例

### 开发环境配置

```json
{
  "Shop": {
    "DailyResetPeriodSeconds": 300,          // 5分钟（便于测试）
    "WeeklyResetPeriodSeconds": 3600,        // 1小时（便于测试）
    "DefaultPageSize": 10,
    "MaxPageSize": 50,
    "ShopDefinitionCacheMinutes": 1,         // 短缓存时间
    "ShopItemsCacheMinutes": 1,              // 短缓存时间
    "EnablePurchaseLimit": true,
    "EnableCache": false,                     // 开发时可禁用缓存
    "CleanupSchedule": "0 */1 * * *"         // 每小时清理
  }
}
```

### 生产环境配置

```json
{
  "Shop": {
    "DailyResetPeriodSeconds": 86400,        // 24小时
    "WeeklyResetPeriodSeconds": 604800,      // 7天
    "DefaultPageSize": 20,
    "MaxPageSize": 100,
    "ShopDefinitionCacheMinutes": 5,
    "ShopItemsCacheMinutes": 2,
    "EnablePurchaseLimit": true,
    "EnableCache": true,                      // 启用缓存提升性能
    "CleanupSchedule": "0 0 * * *"           // 每天凌晨清理
  }
}
```

### 测试环境配置

```json
{
  "Shop": {
    "DailyResetPeriodSeconds": 60,           // 1分钟（快速测试）
    "WeeklyResetPeriodSeconds": 300,         // 5分钟（快速测试）
    "DefaultPageSize": 5,
    "MaxPageSize": 20,
    "ShopDefinitionCacheMinutes": 0,         // 禁用缓存
    "ShopItemsCacheMinutes": 0,              // 禁用缓存
    "EnablePurchaseLimit": true,
    "EnableCache": false,
    "CleanupSchedule": "0 */1 * * *"
  }
}
```

---

## 使用说明

### 1. 修改配置

#### 方法一：直接修改 appsettings.json

```json
{
  "Shop": {
    "DailyResetPeriodSeconds": 43200  // 修改为12小时
  }
}
```

#### 方法二：使用环境变量

```bash
# Linux/Mac
export Shop__DailyResetPeriodSeconds=43200

# Windows
set Shop__DailyResetPeriodSeconds=43200
```

#### 方法三：使用 appsettings.{Environment}.json

创建 `appsettings.Development.json`:

```json
{
  "Shop": {
    "EnableCache": false,
    "ShopDefinitionCacheMinutes": 1
  }
}
```

### 2. 验证配置

系统启动时会自动验证配置：
- 类型检查：确保值类型正确
- 范围检查：确保值在合理范围内（如果有验证规则）

配置错误时，应用会在启动时抛出异常。

### 3. 热更新（未来支持）

当前版本需要重启应用才能生效配置更改。未来版本将支持部分配置的热更新。

---

## 最佳实践

### 1. 环境隔离

- **开发环境**: 使用较短的重置周期和缓存时间，便于测试
- **测试环境**: 使用更短的周期，快速验证功能
- **生产环境**: 使用标准周期，注重性能和稳定性

### 2. 缓存策略

- **低频变化数据**（商店定义）: 使用较长缓存时间（5-10分钟）
- **中频变化数据**（商品列表）: 使用中等缓存时间（1-3分钟）
- **高频变化数据**（购买记录）: 不缓存

### 3. 性能调优

根据实际负载调整缓存时间：
- **高并发场景**: 适当延长缓存时间
- **实时性要求高**: 缩短缓存时间
- **监控指标**: 观察缓存命中率和响应时间

### 4. 安全考虑

- `EnablePurchaseLimit` 生产环境必须为 `true`
- 定期审查配置，确保符合业务规则
- 使用配置加密保护敏感信息

### 5. 监控建议

建议监控以下指标：
- 缓存命中率
- 购买失败原因分布
- 平均响应时间
- 数据库查询次数

---

## 常见问题

### Q1: 为什么修改配置后没有生效？

**A**: 需要重启应用。当前版本不支持热更新。

### Q2: 缓存时间设置为 0 会怎样？

**A**: 缓存时间为 0 或负数时，等同于禁用该项缓存。

### Q3: 如何完全禁用缓存？

**A**: 设置 `EnableCache` 为 `false`。

### Q4: 购买限制周期如何计算？

**A**: 从第一次购买时间开始计算。例如，如果在 10:00 首次购买，每日限制将在第二天 10:00 重置。

### Q5: 配置错误会导致什么？

**A**: 应用启动时会进行配置验证，如果配置错误会抛出异常，应用无法启动。

---

## 更新日志

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2025-10-12 | 初始版本，包含所有基础配置参数 |

---

**维护**: 开发团队  
**反馈**: 如有配置相关问题，请提交 Issue
