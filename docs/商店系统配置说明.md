# 商店系统配置说明

**项目**: BlazorIdle  
**版本**: 2.1  
**更新日期**: 2025-10-13  
**状态**: ✅ 完成

---

## 📋 目录

1. [配置概览](#配置概览)
2. [配置文件位置](#配置文件位置)
3. [配置参数详解](#配置参数详解)
4. [配置示例](#配置示例)
5. [配置优先级](#配置优先级)
6. [配置验证](#配置验证)
7. [最佳实践](#最佳实践)

---

## 配置概览

商店系统的所有参数已完全外部化，支持通过 `appsettings.json` 进行配置。这使得系统更加灵活，可以在不修改代码的情况下调整各种参数。

### 配置类型

| 配置类型 | 描述 | 位置 |
|---------|------|------|
| **系统配置** | appsettings.json 中的 Shop 节 | 运行时配置 |
| **数据配置** | Config/Shop/*.json | 商店和商品定义 |
| **代码默认值** | ShopSystemConfig.cs | 后备默认值 |

---

## 配置文件位置

### 主配置文件

```
BlazorIdle.Server/
├── appsettings.json              # 主配置文件（包含 Shop 节）
└── Config/Shop/                  # 商店数据配置目录
    ├── ShopDefinitions.json      # 商店定义
    └── ShopItems.json            # 商品定义
```

### 配置加载顺序

1. **appsettings.json** - 系统配置参数
2. **Config/Shop/ShopDefinitions.json** - 商店定义数据
3. **Config/Shop/ShopItems.json** - 商品定义数据
4. **ShopSystemConfig.cs** - 代码中的默认后备值（仅在配置缺失时使用）

---

## 配置参数详解

### appsettings.json - Shop 配置节

```json
{
  "Shop": {
    // === 文件路径配置 ===
    "ConfigPath": "Config/Shop",
    "ShopDefinitionsFile": "ShopDefinitions.json",
    "ShopItemsFile": "ShopItems.json",
    
    // === 缓存配置 ===
    "EnableCaching": true,
    "ShopDefinitionCacheMinutes": 60,
    "ShopItemsCacheMinutes": 30,
    
    // === 商店配置 ===
    "DefaultRefreshIntervalSeconds": 3600,
    "MaxShopNameLength": 50,
    "MaxShopDescriptionLength": 200,
    
    // === 商品配置 ===
    "MaxItemNameLength": 100,
    "MaxItemDescriptionLength": 500,
    "UnlimitedStock": -1,
    
    // === 购买限制配置 ===
    "DailyResetSeconds": 86400,
    "WeeklyResetSeconds": 604800,
    "DefaultDailyLimit": 10,
    "DefaultWeeklyLimit": 5,
    
    // === 价格配置 ===
    "MinPriceAmount": 1,
    "MaxPriceAmount": 1000000,
    
    // === 购买验证配置 ===
    "MinLevelRequirement": 1,
    "MaxLevelRequirement": 100,
    "MinPurchaseQuantity": 1,
    "MaxPurchaseQuantity": 999,
    
    // === 查询配置 ===
    "DefaultPageSize": 20,
    "MaxPageSize": 100,
    "PurchaseHistoryDefaultDays": 30
  }
}
```

### 详细参数说明

#### 文件路径配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| ConfigPath | string | "Config/Shop" | 商店配置文件存放目录 |
| ShopDefinitionsFile | string | "ShopDefinitions.json" | 商店定义文件名 |
| ShopItemsFile | string | "ShopItems.json" | 商品定义文件名 |

**用途**: 指定商店数据配置文件的位置。可以根据部署环境调整路径。

#### 缓存配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| EnableCaching | bool | true | 是否启用内存缓存 |
| ShopDefinitionCacheMinutes | int | 60 | 商店定义缓存时间（分钟） |
| ShopItemsCacheMinutes | int | 30 | 商品列表缓存时间（分钟） |

**性能影响**:
- 启用缓存可提升 90%+ 查询性能
- 缓存会占用约 50KB 内存
- 测试环境建议禁用缓存以确保数据实时性

**调优建议**:
- 生产环境: `EnableCaching = true`
- 开发/测试环境: `EnableCaching = false`
- 商店定义不常变化，可设置较长缓存时间（60-120 分钟）
- 商品列表可能频繁更新，建议 30-60 分钟

#### 商店配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| DefaultRefreshIntervalSeconds | int | 3600 | 默认商店刷新间隔（秒） |
| MaxShopNameLength | int | 50 | 商店名称最大长度 |
| MaxShopDescriptionLength | int | 200 | 商店描述最大长度 |

**用途**: 控制商店的基本属性限制和刷新行为。

#### 商品配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| MaxItemNameLength | int | 100 | 商品名称最大长度 |
| MaxItemDescriptionLength | int | 500 | 商品描述最大长度 |
| UnlimitedStock | int | -1 | 表示无限库存的特殊值 |

**注意**: 
- `UnlimitedStock = -1` 表示商品没有库存限制
- 任何 >= 0 的值表示有限库存

#### 购买限制配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| DailyResetSeconds | int | 86400 | 每日限制重置周期（秒，24小时） |
| WeeklyResetSeconds | int | 604800 | 每周限制重置周期（秒，7天） |
| DefaultDailyLimit | int | 10 | 默认每日购买限制数量 |
| DefaultWeeklyLimit | int | 5 | 默认每周购买限制数量 |

**用途**: 控制购买限制的重置时间和默认值。

**自定义重置周期**:
- 每日: 86400 秒（24 小时）
- 每周: 604800 秒（7 天）
- 自定义周期: 可以设置任意秒数

#### 价格配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| MinPriceAmount | int | 1 | 最小价格金额 |
| MaxPriceAmount | int | 1000000 | 最大价格金额 |

**用途**: 定义价格的合理范围，防止配置错误。

#### 购买验证配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| MinLevelRequirement | int | 1 | 最小等级要求 |
| MaxLevelRequirement | int | 100 | 最大等级要求 |
| MinPurchaseQuantity | int | 1 | 最小单次购买数量 |
| MaxPurchaseQuantity | int | 999 | 最大单次购买数量 |

**用途**: 控制购买验证的边界条件。

#### 查询配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| DefaultPageSize | int | 20 | 默认分页大小 |
| MaxPageSize | int | 100 | 最大分页大小 |
| PurchaseHistoryDefaultDays | int | 30 | 购买历史默认查询天数 |

**用途**: 控制查询和分页行为。

---

## 配置示例

### 示例 1: 生产环境配置（性能优先）

```json
{
  "Shop": {
    "EnableCaching": true,
    "ShopDefinitionCacheMinutes": 120,
    "ShopItemsCacheMinutes": 60,
    "DefaultPageSize": 30,
    "MaxPageSize": 100
  }
}
```

### 示例 2: 开发环境配置（数据实时性优先）

```json
{
  "Shop": {
    "EnableCaching": false,
    "DefaultPageSize": 10,
    "MaxPageSize": 50
  }
}
```

### 示例 3: 限时活动配置（缩短重置周期）

```json
{
  "Shop": {
    "DailyResetSeconds": 3600,
    "DefaultDailyLimit": 50
  }
}
```

说明: 将每日重置周期改为 1 小时，限购数量增加到 50 次。

### 示例 4: 测试环境配置

```json
{
  "Shop": {
    "EnableCaching": false,
    "MinLevelRequirement": 1,
    "MaxLevelRequirement": 1000,
    "MinPriceAmount": 1,
    "MaxPriceAmount": 999999999
  }
}
```

说明: 放宽限制以便于测试各种场景。

---

## 配置优先级

配置加载遵循以下优先级（从高到低）：

1. **appsettings.json** - 最高优先级，运行时配置
2. **ShopOptions（注入配置）** - 通过 IOptions<ShopOptions> 注入
3. **ShopSystemConfig.cs** - 最低优先级，代码中的默认后备值

### 配置读取逻辑

```csharp
// 示例：读取每日重置秒数
var dailyResetSeconds = _configuration.GetValue<int>(
    "Shop:DailyResetSeconds",                           // 优先从配置读取
    ShopSystemConfig.PurchaseLimitConfig.DailyResetSeconds  // 配置不存在时使用默认值
);
```

### 配置不存在时的行为

如果 `appsettings.json` 中没有 Shop 配置节，系统会：
1. 使用 `ShopOptions` 类中定义的默认值
2. 如果 `ShopOptions` 也没有值，则使用 `ShopSystemConfig` 中的常量

这保证了系统在任何情况下都能正常运行。

---

## 配置验证

### 自动验证

系统在以下时机会验证配置：

1. **服务启动时** - 加载配置时进行基本验证
2. **配置使用时** - 使用配置值前进行范围检查

### 常见配置错误

| 错误 | 原因 | 解决方案 |
|-----|------|---------|
| 文件未找到 | ConfigPath 或文件名配置错误 | 检查路径和文件名是否正确 |
| 缓存失效 | 缓存时间设置为负数 | 设置为正整数或 0（禁用缓存） |
| 页面大小无效 | DefaultPageSize > MaxPageSize | 确保 DefaultPageSize <= MaxPageSize |
| 重置周期无效 | 设置为 0 或负数 | 设置为正整数（秒） |

### 配置验证建议

在 `appsettings.json` 中添加配置后，建议：

1. **运行单元测试** - 验证配置是否正确加载
2. **检查日志** - 启动时查看配置加载日志
3. **功能测试** - 测试商店系统核心功能

---

## 最佳实践

### 1. 环境隔离

不同环境使用不同的配置文件：

```
appsettings.Development.json  # 开发环境
appsettings.Staging.json      # 预发布环境
appsettings.Production.json   # 生产环境
```

### 2. 配置版本控制

- ✅ **提交**: `appsettings.json`（包含默认/示例配置）
- ✅ **提交**: `appsettings.Development.json`
- ❌ **不提交**: `appsettings.Production.json`（包含敏感信息）

### 3. 配置文档化

每次修改配置时：
1. 更新此文档
2. 在代码注释中说明配置用途
3. 提供配置示例

### 4. 配置安全

- 不要在配置中硬编码密钥或敏感信息
- 生产环境使用环境变量或密钥管理服务
- 定期审查配置文件权限

### 5. 性能调优

根据实际负载调整配置：

**低流量场景** (< 100 并发):
```json
{
  "EnableCaching": true,
  "ShopDefinitionCacheMinutes": 60,
  "ShopItemsCacheMinutes": 30
}
```

**高流量场景** (> 1000 并发):
```json
{
  "EnableCaching": true,
  "ShopDefinitionCacheMinutes": 180,
  "ShopItemsCacheMinutes": 120
}
```

### 6. 监控配置影响

定期监控以下指标：
- 缓存命中率
- 数据库查询次数
- 平均响应时间
- 内存使用情况

根据监控结果调整配置。

---

## 配置迁移指南

### 从硬编码迁移到配置化（已完成）

本次优化已完成以下迁移：

| 迁移前 | 迁移后 |
|-------|--------|
| ShopSystemConfig.CacheConfig.EnableCaching | appsettings.json: Shop:EnableCaching |
| 硬编码的 86400（每日重置） | appsettings.json: Shop:DailyResetSeconds |
| 硬编码的 604800（每周重置） | appsettings.json: Shop:WeeklyResetSeconds |
| 硬编码的 20（默认分页） | appsettings.json: Shop:DefaultPageSize |

### 向后兼容性

- ✅ 现有代码无需修改
- ✅ 现有测试全部通过（45/45）
- ✅ 未配置时使用默认值
- ✅ ShopSystemConfig 作为后备方案保留

---

## 故障排查

### 问题: 配置未生效

**症状**: 修改配置后系统行为未改变

**排查步骤**:
1. 检查配置文件是否复制到输出目录
2. 检查配置键名是否正确（区分大小写）
3. 重启应用程序
4. 检查日志中的配置加载信息

### 问题: 配置文件未找到

**症状**: 启动时提示找不到 ShopDefinitions.json 或 ShopItems.json

**排查步骤**:
1. 检查文件是否存在于 Config/Shop 目录
2. 检查 .csproj 文件中的 `<ItemGroup>` 是否配置文件复制规则
3. 检查 ConfigPath 配置是否正确

### 问题: 缓存未命中

**症状**: 每次查询都访问数据库

**排查步骤**:
1. 检查 `EnableCaching` 是否为 true
2. 检查缓存时间是否设置过短
3. 检查内存缓存服务是否正确注册

---

## 相关文档

- [商店系统设计方案（上）](./商店系统设计方案（上）.md)
- [商店系统设计方案（中）](./商店系统设计方案（中）.md)
- [商店系统设计方案（下）](./商店系统设计方案（下）.md)
- [商店系统Phase2优化进度](./商店系统Phase2优化进度.md)
- [商店系统Phase2阶段性完成报告](./商店系统Phase2阶段性完成报告.md)

---

## 更新日志

### 2025-10-13
- ✅ 创建配置说明文档
- ✅ 完成所有参数的外部化配置
- ✅ 更新 ShopOptions 包含所有配置参数
- ✅ 更新 ShopService 和 PurchaseValidator 使用 IConfiguration
- ✅ 更新所有测试以支持配置注入
- ✅ 所有 45 个测试通过

---

**文档状态**: ✅ 完成  
**维护负责人**: 开发团队  
**最后审核**: 2025-10-13
