# 商店系统快速参考

**版本**: Phase 6  
**更新日期**: 2025-10-13  
**状态**: ✅ 最新

---

## 📊 系统概览

### 核心数据

| 指标 | 数值 |
|------|------|
| 商店数量 | 3 |
| 商品总数 | 17 |
| 配置参数 | 23 |
| 环境配置 | 4 |
| 测试覆盖 | 52 (100%) |
| 文档数量 | 17 |

---

## 🏪 商店列表

| ID | 名称 | 类型 | 图标 | 解锁条件 | 商品数 |
|----|------|------|------|---------|--------|
| general_shop | 杂货铺 | General | 🏪 | 无 | 5 |
| weapon_shop | 武器店 | General | ⚔️ | 无 | 6 |
| alchemist_shop | 炼金术士 | Special | 🧪 | level>=10 | 6 |

---

## 📦 商品清单

### 杂货铺 (5个)

| 商品 | 图标 | 价格 | 等级 | 稀有度 | 限制 |
|------|------|------|------|--------|------|
| 清水 | 💧 | 5金 | 1 | 普通 | 无 |
| 面包 | 🍞 | 10金 | 1 | 普通 | 无 |
| 绷带 | 🩹 | 25金 | 1 | 普通 | 无 |
| 小型生命药水 | 🧪 | 50金 | 1 | 普通 | 无 |
| 小型魔法药水 | 💙 | 50金 | 1 | 普通 | 无 |

### 武器店 (6个)

| 商品 | 图标 | 价格 | 等级 | 稀有度 | 限制 |
|------|------|------|------|--------|------|
| 青铜匕首 | 🗡️ | 150金 | 1 | 普通 | 无 |
| 木盾 | 🛡️ | 300金 | 1 | 普通 | 无 |
| 皮甲 | 🎽 | 400金 | 1 | 普通 | 无 |
| 铁剑 | ⚔️ | 500金 | 1 | 普通 | 无 |
| 铁盔 | ⛑️ | 600金 | 3 | 普通 | 无 |
| 钢剑 | ⚔️ | 1500金 | 5 | 优秀 | 无 |

### 炼金术士 (6个)

| 商品 | 图标 | 价格 | 等级 | 稀有度 | 限制 |
|------|------|------|------|--------|------|
| 高级生命药水 | 🧪 | 200金 | 10 | 优秀 | 每日5次 |
| 力量药剂 | 💪 | 500金 | 15 | 稀有 | 每周3次 |
| 传送卷轴 | 📜 | 1000金 | 10 | 稀有 | 无 |
| 魔法水晶 | 💎 | 2000金 | 12 | 稀有 | 每周2次 |
| 龙鳞 | 🐉 | 5000金 | 20 | 史诗 | 永久1次 |
| 凤凰羽毛 | 🪶 | 8000金 | 25 | 传说 | 永久2次 |

---

## 🎯 稀有度系统

| 稀有度 | 颜色 | 数量 | 占比 | 示例 |
|--------|------|------|------|------|
| 普通 (Common) | ⚪ 灰色 | 10 | 59% | 面包、铁剑 |
| 优秀 (Uncommon) | 🟢 绿色 | 2 | 12% | 钢剑、高级药水 |
| 稀有 (Rare) | 🔵 蓝色 | 3 | 18% | 力量药剂、卷轴 |
| 史诗 (Epic) | 🟣 紫色 | 1 | 6% | 龙鳞 |
| 传说 (Legendary) | 🟠 橙色 | 1 | 6% | 凤凰羽毛 |

---

## 💰 价格体系

### 价格梯度

| 等级范围 | 价格范围 | 商品类型 | 示例 |
|----------|----------|----------|------|
| Lv 1 | 5-50金 | 基础消耗品 | 清水、面包、药水 |
| Lv 1-3 | 150-600金 | 初级装备 | 匕首、盾、甲、剑、盔 |
| Lv 5 | 1500金 | 中级装备 | 钢剑 |
| Lv 10+ | 200-1000金 | 高级消耗 | 高级药水、卷轴 |
| Lv 10+ | 2000-8000金 | 稀有材料 | 水晶、龙鳞、羽毛 |

### 统计数据

- **最低价**: 5金币 (清水)
- **最高价**: 8000金币 (凤凰羽毛)
- **平均价**: 1193金币
- **中位价**: 500金币

---

## 🔒 购买限制

### 限制类型

| 类型 | 说明 | 重置周期 | 商品数 |
|------|------|----------|--------|
| Unlimited | 无限购买 | - | 11 |
| Daily | 每日限制 | 24小时 | 1 |
| Weekly | 每周限制 | 7天 | 2 |
| PerCharacter | 永久限制 | 角色生命周期 | 2 |

### 限制商品

| 商品 | 限制 | 次数 |
|------|------|------|
| 高级生命药水 | 每日 | 5次 |
| 力量药剂 | 每周 | 3次 |
| 魔法水晶 | 每周 | 2次 |
| 龙鳞 | 永久 | 1次 |
| 凤凰羽毛 | 永久 | 2次 |

---

## 📊 等级分布

```
Lv 1:  ████████████████████████████ 9个 (53%)
Lv 3:  ███ 1个 (6%)
Lv 5:  ███ 1个 (6%)
Lv 10: ██████ 2个 (12%)
Lv 12: ███ 1个 (6%)
Lv 15: ███ 1个 (6%)
Lv 20: ███ 1个 (6%)
Lv 25: ███ 1个 (6%)
```

---

## ⚙️ 配置参数 (23个)

### 缓存配置 (3个)
- `EnableCaching`: 是否启用缓存
- `ShopDefinitionCacheMinutes`: 商店定义缓存时间
- `ShopItemsCacheMinutes`: 商品缓存时间

### 文件配置 (3个)
- `ConfigPath`: 配置文件路径
- `ShopDefinitionsFile`: 商店定义文件名
- `ShopItemsFile`: 商品文件名

### 商店配置 (3个)
- `DefaultRefreshIntervalSeconds`: 默认刷新间隔
- `MaxShopNameLength`: 商店名称最大长度
- `MaxShopDescriptionLength`: 商店描述最大长度

### 商品配置 (3个)
- `MaxItemNameLength`: 商品名称最大长度
- `MaxItemDescriptionLength`: 商品描述最大长度
- `UnlimitedStock`: 无限库存标识 (-1)

### 限制配置 (4个)
- `DailyResetSeconds`: 每日重置秒数
- `WeeklyResetSeconds`: 每周重置秒数
- `DefaultDailyLimit`: 默认每日限制
- `DefaultWeeklyLimit`: 默认每周限制

### 价格配置 (2个)
- `MinPriceAmount`: 最小价格
- `MaxPriceAmount`: 最大价格

### 验证配置 (4个)
- `MinLevelRequirement`: 最小等级要求
- `MaxLevelRequirement`: 最大等级要求
- `MinPurchaseQuantity`: 最小购买数量
- `MaxPurchaseQuantity`: 最大购买数量

### 查询配置 (3个)
- `DefaultPageSize`: 默认分页大小
- `MaxPageSize`: 最大分页大小
- `PurchaseHistoryDefaultDays`: 购买历史默认天数

---

## 🌍 环境配置

### 配置文件

```
appsettings.json                     # 基础配置（生产默认）
appsettings.Development.json         # 开发环境
appsettings.Development.example.json # 开发环境示例
appsettings.Production.example.json  # 生产环境示例
appsettings.Testing.json             # 测试环境
```

### 环境差异

| 配置 | 生产 | 开发 | 测试 |
|------|------|------|------|
| 缓存 | ✅ 启用 | ❌ 禁用 | ❌ 禁用 |
| 缓存时间 | 60/30分 | 1/1分 | 0/0分 |
| 日志级别 | Info/Warn | Debug | Info/Warn |
| 分页大小 | 20/100 | 10/50 | 10/50 |
| 历史天数 | 30天 | 30天 | 7天 |

---

## 🔧 API 端点 (6个)

### 1. 获取商店列表
```
GET /api/shop/list/{characterId}
```

### 2. 获取商店商品
```
GET /api/shop/{shopId}/items/{characterId}
```

### 3. 购买商品
```
POST /api/shop/purchase/{characterId}
Body: { "ShopItemId": "xxx", "Quantity": 1 }
```

### 4. 获取购买历史
```
GET /api/shop/purchase-history/{characterId}
```

### 5. 获取商品（带过滤）
```
POST /api/shop/{shopId}/items/{characterId}/filter
Body: { "Category": "xxx", "Rarity": "xxx", ... }
```

---

## 📝 数据文件

### ShopDefinitions.json
```
Config/Shop/ShopDefinitions.json
```
- 定义3个商店
- 包含解锁条件
- 定义显示顺序

### ShopItems.json
```
Config/Shop/ShopItems.json
```
- 定义17个商品
- 包含价格和限制
- 定义等级要求

---

## 🧪 测试覆盖 (52个)

### 测试分类

| 类别 | 数量 | 说明 |
|------|------|------|
| 领域模型测试 | 17 | ShopDomainTests.cs |
| 服务层测试 | 9 | ShopServiceTests.cs |
| 缓存测试 | 7 | ShopCacheTests.cs |
| 过滤测试 | 12 | ShopFilteringTests.cs |
| 库存集成测试 | 7 | ShopInventoryIntegrationTests.cs |

### 测试命令

```bash
# 运行所有商店测试
dotnet test --filter "FullyQualifiedName~Shop"

# 运行特定测试类
dotnet test --filter "FullyQualifiedName~ShopServiceTests"
```

---

## 📚 文档索引

### 核心文档 (必读)

1. **商店系统-README.md** ⭐
   - 系统使用指南
   - 快速开始
   - API文档

2. **商店系统-配置指南.md** ⭐
   - 配置详解
   - 环境配置
   - 最佳实践

3. **商店系统优化总结-Phase1-6完整报告.md** ⭐
   - 完整实施过程
   - 所有阶段总结
   - 最终成果

### 阶段报告

4. 商店系统Phase1完成报告.md
5. 商店系统Phase2-完全配置化改进报告.md
6. 商店系统Phase3-性能优化完成报告.md
7. 商店系统Phase4-文档完善报告.md
8. 商店系统Phase5-前端集成完成报告.md
9. 商店系统Phase6-配置优化与内容扩展报告.md

### 设计文档

10. 商店系统设计方案（上）.md
11. 商店系统设计方案（中）.md
12. 商店系统设计方案（下）.md

---

## 🚀 快速上手

### 1. 启动服务器

```bash
cd BlazorIdle.Server
dotnet run
```

### 2. 访问商店

```
浏览器打开: https://localhost:5001
登录 → 创建角色 → 向下滚动到商店界面
```

### 3. 测试功能

- ✅ 查看3个商店
- ✅ 浏览17个商品
- ✅ 尝试购买
- ✅ 测试限制

---

## 🎯 常见场景

### 场景1: 添加新商品

1. 编辑 `Config/Shop/ShopItems.json`
2. 添加新商品条目
3. 重启服务器
4. 验证显示

### 场景2: 调整价格

1. 编辑 `Config/Shop/ShopItems.json`
2. 修改 `price.amount`
3. 重启服务器
4. 验证新价格

### 场景3: 修改限制

1. 编辑 `Config/Shop/ShopItems.json`
2. 修改 `purchaseLimit`
3. 重启服务器
4. 验证限制生效

### 场景4: 开发环境调试

1. 使用 `appsettings.Development.json`
2. 禁用缓存
3. 启用Debug日志
4. 快速迭代

---

## ⚠️ 注意事项

### DO ✅

- ✅ 使用配置文件修改参数
- ✅ 保持JSON格式正确
- ✅ 验证价格和等级范围
- ✅ 测试后再部署
- ✅ 备份配置文件

### DON'T ❌

- ❌ 在代码中硬编码参数
- ❌ 直接修改数据库
- ❌ 忽略配置验证
- ❌ 跳过测试环节
- ❌ 破坏JSON格式

---

## 📞 支持

### 问题排查

1. **商品不显示**
   - 检查 JSON 格式
   - 验证 `isEnabled: true`
   - 检查等级要求

2. **价格错误**
   - 验证配置文件
   - 检查缓存设置
   - 重启服务器

3. **购买失败**
   - 检查金币余额
   - 验证等级要求
   - 查看购买限制

### 获取帮助

1. 查看相关文档
2. 检查日志输出
3. 运行测试验证
4. 查看错误堆栈

---

**文档版本**: Phase 6  
**最后更新**: 2025-10-13  
**状态**: ✅ 最新

---

*快速参考文档 - 便于日常开发和维护使用*
