# 背包功能交付说明

## 交付日期
2025-10-06

## 任务概述
根据需求："为我在前端中做一个背包界面显示战斗中的物品掉落，沿用当前的逻辑"，已完成以下工作：

---

## 一、交付内容

### 1. 后端API
**文件**: `BlazorIdle.Server/Api/InventoryController.cs`

新增端点：
- `GET /api/inventory/{characterId}` - 获取角色背包

**响应格式**:
```json
{
  "characterId": "guid",
  "characterName": "角色名",
  "gold": 1234,
  "experience": 5678,
  "items": [
    {
      "itemId": "mat_scrap",
      "quantity": 42,
      "updatedAt": "2025-10-06T12:34:56Z"
    }
  ]
}
```

### 2. 前端组件
**文件**: `BlazorIdle/Components/InventoryPanel.razor`

**功能**:
- 显示角色金币和经验（带颜色强调）
- 显示物品列表（表格形式）
- 物品名称智能映射（中英文）
- 刷新按钮
- 空背包提示
- 响应式设计

**物品名称映射**:
- `mat_scrap` → "碎片 (Scrap)"
- `mat_core` → "核心 (Core)"
- `gem_small` → "小宝石 (Small Gem)"
- 其他物品显示原始ID（可扩展）

### 3. 数据模型
**文件**: `BlazorIdle/Services/ApiModels.cs`

新增类型：
- `InventoryResponse` - 背包响应
- `InventoryItemDto` - 物品DTO

### 4. API客户端
**文件**: `BlazorIdle/Services/ApiClient.cs`

新增方法：
```csharp
Task<InventoryResponse?> GetInventoryAsync(Guid characterId, CancellationToken ct)
```

### 5. 页面集成
**文件**: `BlazorIdle/Pages/Characters.razor`

在角色创建区域后添加：
```razor
<InventoryPanel CharacterId="@lastCreated.Id" CharacterName="@lastCreated.Name" />
```

### 6. 全局配置
**文件**: `BlazorIdle/_Imports.razor`

添加命名空间：
```razor
@using BlazorIdle.Components
```

---

## 二、使用方式

### 前端操作
1. 在"角色 & 战斗测试"页面创建角色
2. 角色创建后自动显示"背包"面板
3. 背包显示：
   - 当前金币和经验
   - 所有拥有的物品及数量
4. 点击"刷新"按钮更新背包数据

### 获取物品的方式
目前物品通过以下方式掉落：
1. **战斗结束**: 根据击杀敌人类型，按掉落表抽取
2. **掉落模式**:
   - `expected`: 显示期望值（小数）
   - `sampled`: 实际抽样（整数）
3. **持久化**: 当前需要配合 `RewardGrantService` 才会实际入库

---

## 三、物品掉落逻辑说明

### 掉落表配置
位置: `BlazorIdle.Server/Domain/Combat/Economy/EconomyRegistry.cs`

**示例配置**:
```csharp
// 普通掉落表
new LootTable("loot_common", new[]
{
    new LootEntry { 
        ItemId = "mat_scrap", 
        DropChance = 0.50,      // 50%概率
        QuantityMin = 1, 
        QuantityMax = 2,        // 数量1-2
        Rolls = 1               // 每次击杀roll 1次
    },
    new LootEntry { 
        ItemId = "gem_small",  
        DropChance = 0.05,      // 5%概率
        QuantityMin = 1, 
        QuantityMax = 1, 
        Rolls = 1 
    }
})

// 精英掉落表
new LootTable("loot_elite", new[]
{
    new LootEntry { 
        ItemId = "mat_core",  
        DropChance = 0.25, 
        QuantityMin = 1, 
        QuantityMax = 1, 
        Rolls = 1 
    },
    new LootEntry { 
        ItemId = "gem_small", 
        DropChance = 0.10, 
        QuantityMin = 1, 
        QuantityMax = 2, 
        Rolls = 2               // 精英多roll 2次
    }
})
```

### 敌人配置
```csharp
new EnemyEconomy(
    enemyId: "paper", 
    gold: 3,                    // 3金币
    exp: 2,                     // 2经验
    lootTableId: "loot_common"  // 使用普通掉落表
)

new EnemyEconomy(
    enemyId: "tank", 
    gold: 15, 
    exp: 10, 
    lootTableId: "loot_elite"   // 使用精英掉落表
)
```

### 计算公式

**期望值**:
```
期望件数 = Σ(rolls × dropChance × avgQuantity × killCount)
```

**抽样**:
```
for each kill:
    for each loot entry:
        for roll in 1..rolls:
            if random() <= dropChance:
                quantity = random(quantityMin, quantityMax)
                add to inventory
```

---

## 四、技术特点

### 优势
✅ **沿用现有逻辑**: 完全基于现有 `EconomyCalculator` 和 `InventoryItem`  
✅ **双模式支持**: 期望值和抽样均可查看  
✅ **RNG独立**: 经济RNG不影响战斗RNG，战斗可回放  
✅ **幂等性**: 奖励发放有幂等键保护  
✅ **可扩展**: 物品名称、图标、分类等易于扩展  
✅ **响应式**: 界面自适应不同屏幕尺寸  

### 限制
⚠️ **边打边发未启用**: 需要手动调用 `RewardGrantService`  
⚠️ **物品定义简单**: 仅ID和名称，无图标/描述/品质  
⚠️ **无分类筛选**: 所有物品平铺显示  
⚠️ **无使用功能**: 物品仅作展示  

---

## 五、代码统计

| 类别 | 文件数 | 代码行数 |
|------|--------|----------|
| 后端API | 1 | 48 |
| 前端组件 | 1 | 172 |
| 数据模型 | 1 | 17 |
| 配置文件 | 2 | 11 |
| **合计** | **5** | **248** |

---

## 六、测试建议

### 功能测试
1. **创建角色**: 背包应显示0金币、0经验、空物品列表
2. **进行战斗**: 
   - 击杀 `paper` 敌人：应获得3金币、2经验、有概率获得碎片/小宝石
   - 击杀 `tank` 敌人：应获得15金币、10经验、有概率获得核心/小宝石
3. **切换模式**:
   - `expected`: 显示小数（期望值）
   - `sampled`: 显示整数（实际抽样）
4. **刷新背包**: 点击刷新按钮应重新加载数据

### 数据验证
1. 金币/经验累加正确
2. 物品数量按数量降序排列
3. 同一物品不会重复显示（应合并）
4. 更新时间正确记录

### 边界情况
1. 角色不存在：返回404
2. 空背包：显示"背包为空"
3. 大量物品：表格应正常显示（后续可添加分页）

---

## 七、后续扩展建议

### 短期（1-2周）
1. **自动刷新**: 战斗结束后自动刷新背包
2. **物品图标**: 添加图标显示
3. **物品品质**: 添加颜色标识（普通/精良/稀有/史诗）
4. **物品分类**: 添加材料/宝石/装备等分类标签

### 中期（2-4周）
5. **物品详情**: 点击查看详细描述
6. **物品搜索**: 按名称或类型搜索
7. **物品排序**: 支持按类型/数量/获取时间排序
8. **物品使用**: 消耗品使用功能
9. **物品合成**: 材料合成装备

### 长期（1-2月）
10. **物品交易**: 玩家间交易（如启用）
11. **物品拍卖**: 拍卖行系统
12. **物品回收**: 一键回收/分解
13. **背包扩展**: 购买背包空间
14. **仓库系统**: 独立仓库存储

---

## 八、相关文档

1. **战斗功能分析与下阶段规划.md** - 完整的功能分析和5个Phase工作计划
2. **项目状态.txt** - 已更新背包功能完成状态
3. **整合设计总结.txt** - 原始设计文档参考

---

## 九、问题与反馈

如有任何问题或建议，请联系开发者或在项目中提issue。

**注意事项**:
- 当前"边打边发"功能未启用，物品掉落仅在前端计算显示
- 若需要持久化到数据库，需要配置并启用 `RewardGrantService`
- 建议在 `appsettings.json` 中设置 `Economy:DefaultDropMode` 为 `sampled` 以获得真实抽样体验

---

**交付完成** ✅