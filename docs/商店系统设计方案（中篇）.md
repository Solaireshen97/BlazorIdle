# BlazorIdle 商店系统设计方案（中篇）
## 详细实施步骤与技术实现

**项目**: BlazorIdle  
**文档类型**: 设计方案 - 中篇  
**创建日期**: 2025-10-12  
**版本**: 1.0  
**状态**: 设计阶段  
**作者**: 系统架构团队

---

## 📋 目录

1. [实施路线图](#1-实施路线图)
2. [Phase 1: 基础架构搭建](#2-phase-1-基础架构搭建)
3. [Phase 2: 核心功能实现](#3-phase-2-核心功能实现)
4. [Phase 3: 条件解锁与货币系统](#4-phase-3-条件解锁与货币系统)
5. [Phase 4: 前端界面开发](#5-phase-4-前端界面开发)
6. [数据库设计详解](#6-数据库设计详解)
7. [API接口设计](#7-api接口设计)

---

## 1. 实施路线图

### 1.1 总体时间规划

| Phase | 阶段名称 | 工作量 | 依赖项 | 交付物 |
|-------|---------|--------|--------|--------|
| **P0** | 需求确认与设计评审 | 2天 | 无 | 设计文档、数据库ER图 |
| **P1** | 基础架构搭建 | 3-4天 | P0 | 领域模型、仓储接口、数据表 |
| **P2** | 核心功能实现 | 5-6天 | P1 | 购买服务、刷新服务、库存管理 |
| **P3** | 条件解锁与货币系统 | 4-5天 | P2 | 条件评估器、货币兑换器、声望系统 |
| **P4** | 前端界面开发 | 5-6天 | P2, P3 | 商店列表、商店详情、购买界面 |
| **P5** | 集成测试与优化 | 3-4天 | P4 | 测试报告、性能报告 |
| **P6** | 部署与文档 | 2天 | P5 | 用户手册、运维文档 |

**总计**: 24-31天（约4-5周）

### 1.2 里程碑定义

| 里程碑 | 标准 | 验收条件 |
|--------|------|---------|
| **M1: 数据层完成** | P1结束 | 所有表创建、迁移脚本通过 |
| **M2: 购买功能可用** | P2结束 | 可购买金币商品、库存扣减正确 |
| **M3: 多货币支持** | P3结束 | 支持声望/荣誉购买 |
| **M4: 前端可用** | P4结束 | 用户可通过UI完成购买 |
| **M5: 系统上线** | P6结束 | 生产环境部署完成 |

### 1.3 风险与缓解策略

| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|---------|
| 条件DSL复杂度高 | 中 | 高 | Phase 3优先实现简单条件，复杂条件延后 |
| 并发购买冲突 | 高 | 中 | 使用乐观锁 + 重试机制 |
| 性能问题（商品多） | 中 | 中 | 分页加载 + 缓存热门商店 |
| 前后端联调延迟 | 低 | 低 | API优先开发，提供Mock数据 |

---

## 2. Phase 1: 基础架构搭建

### 2.1 领域模型实现

#### 任务清单

- [x] 2.1.1 创建 Domain/Shop 目录结构
- [ ] 2.1.2 实现 ShopDefinition 实体
- [ ] 2.1.3 实现 ShopInstance 聚合根
- [ ] 2.1.4 实现 ShopItemInstance 值对象
- [ ] 2.1.5 实现 CurrencyCost 值对象
- [ ] 2.1.6 实现 PurchaseLimit 实体
- [ ] 2.1.7 实现枚举类型（ShopType, ItemType, CurrencyType等）
- [ ] 2.1.8 编写领域模型单元测试

#### 2.1.1 目录结构创建

```bash
mkdir -p BlazorIdle.Server/Domain/Shop/Models
mkdir -p BlazorIdle.Server/Domain/Shop/Services
mkdir -p BlazorIdle.Server/Domain/Shop/Events
mkdir -p BlazorIdle.Server/Domain/Shop/ValueObjects
mkdir -p BlazorIdle.Server/Domain/Shop/Repositories
```

#### 2.1.2 ShopDefinition 实体实现

**文件**: `BlazorIdle.Server/Domain/Shop/Models/ShopDefinition.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

/// <summary>
/// 商店定义 - 静态配置实体
/// </summary>
public class ShopDefinition
{
    public string Id { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public ShopType ShopType { get; set; }
    public string Icon { get; set; } = string.Empty;
    
    // 解锁条件
    public string? UnlockConditionExpr { get; set; }
    
    // 刷新规则
    public RefreshInterval RefreshInterval { get; set; }
    public bool AllowManualRefresh { get; set; }
    public int? ManualRefreshCost { get; set; }
    
    // 排序与显示
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
    public string TagsJson { get; set; } = "[]"; // JSON序列化的标签
    
    // 时间戳
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // 导航属性
    public List<ShopItemDefinition> ItemDefinitions { get; set; } = new();
    
    // 辅助方法
    public List<string> GetTags() => 
        System.Text.Json.JsonSerializer.Deserialize<List<string>>(TagsJson) ?? new();
        
    public void SetTags(List<string> tags) => 
        TagsJson = System.Text.Json.JsonSerializer.Serialize(tags);
}
```

#### 2.1.3 ShopInstance 聚合根实现

**文件**: `BlazorIdle.Server/Domain/Shop/Models/ShopInstance.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

/// <summary>
/// 商店实例 - 运行时聚合根
/// </summary>
public class ShopInstance
{
    public Guid Id { get; private set; }
    public string ShopDefinitionId { get; private set; }
    
    // 刷新状态
    public DateTime LastRefreshTime { get; private set; }
    public DateTime? NextRefreshTime { get; private set; }
    public int RefreshCount { get; private set; }
    
    // 版本控制（乐观锁）
    public int Version { get; private set; }
    
    // 时间戳
    public DateTime CreatedAt { get; private set; }
    public DateTime UpdatedAt { get; private set; }
    
    // 导航属性
    public ShopDefinition Definition { get; set; } = null!;
    private readonly List<ShopItemStock> _itemStocks = new();
    public IReadOnlyList<ShopItemStock> ItemStocks => _itemStocks.AsReadOnly();
    
    // 领域事件
    private readonly List<IDomainEvent> _domainEvents = new();
    public IReadOnlyList<IDomainEvent> DomainEvents => _domainEvents.AsReadOnly();
    
    // 构造函数
    private ShopInstance() { } // EF Core
    
    public ShopInstance(string shopDefinitionId)
    {
        Id = Guid.NewGuid();
        ShopDefinitionId = shopDefinitionId;
        LastRefreshTime = DateTime.UtcNow;
        CreatedAt = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
        Version = 1;
    }
    
    /// <summary>
    /// 检查是否需要刷新
    /// </summary>
    public bool NeedsRefresh(DateTime currentTime)
    {
        if (NextRefreshTime == null) return false;
        return currentTime >= NextRefreshTime.Value;
    }
    
    /// <summary>
    /// 执行刷新
    /// </summary>
    public void Refresh(DateTime refreshTime, List<ShopItemStock> newStocks)
    {
        LastRefreshTime = refreshTime;
        NextRefreshTime = CalculateNextRefreshTime(refreshTime);
        RefreshCount++;
        UpdatedAt = refreshTime;
        Version++;
        
        _itemStocks.Clear();
        _itemStocks.AddRange(newStocks);
        
        // 发布领域事件
        _domainEvents.Add(new ShopRefreshedEvent
        {
            ShopInstanceId = Id,
            ShopDefinitionId = ShopDefinitionId,
            RefreshTime = refreshTime,
            NewItemCount = newStocks.Count
        });
    }
    
    /// <summary>
    /// 扣减商品库存
    /// </summary>
    public bool TryDeductStock(string shopItemId, int quantity)
    {
        var stock = _itemStocks.FirstOrDefault(s => s.ShopItemId == shopItemId);
        if (stock == null) return false;
        
        return stock.TryDeduct(quantity);
    }
    
    /// <summary>
    /// 计算下次刷新时间
    /// </summary>
    private DateTime? CalculateNextRefreshTime(DateTime from)
    {
        // 将在Definition加载后计算
        return null; // 占位实现
    }
    
    public void ClearDomainEvents() => _domainEvents.Clear();
}
```

#### 2.1.4 ShopItemDefinition 实体

**文件**: `BlazorIdle.Server/Domain/Shop/Models/ShopItemDefinition.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

/// <summary>
/// 商品定义 - 配置实体
/// </summary>
public class ShopItemDefinition
{
    public string Id { get; set; } = string.Empty; // shopItemId
    public string ShopDefinitionId { get; set; } = string.Empty;
    
    // 物品信息
    public ItemType ItemType { get; set; }
    public string ItemId { get; set; } = string.Empty;
    public string? ItemName { get; set; } // 冗余字段，方便查询
    
    // 价格信息（JSON序列化）
    public string PricesJson { get; set; } = "[]";
    
    // 库存配置
    public StockPolicy StockPolicy { get; set; }
    public int? MaxStock { get; set; }
    public int? RefreshStock { get; set; } // 刷新时补充的库存数
    
    // 限购配置（JSON序列化）
    public string PurchaseLimitsJson { get; set; } = "[]";
    
    // 解锁与可见性
    public string? UnlockConditionExpr { get; set; }
    public bool ShowWhenLocked { get; set; } // 未解锁时是否显示（灰显）
    
    // 显示顺序
    public int DisplayOrder { get; set; }
    public bool IsActive { get; set; }
    
    // 时间戳
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // 导航属性
    public ShopDefinition ShopDefinition { get; set; } = null!;
    
    // 辅助方法
    public List<CurrencyCost> GetPrices() =>
        System.Text.Json.JsonSerializer.Deserialize<List<CurrencyCost>>(PricesJson) ?? new();
        
    public void SetPrices(List<CurrencyCost> prices) =>
        PricesJson = System.Text.Json.JsonSerializer.Serialize(prices);
        
    public List<PurchaseLimitConfig> GetPurchaseLimits() =>
        System.Text.Json.JsonSerializer.Deserialize<List<PurchaseLimitConfig>>(PurchaseLimitsJson) ?? new();
        
    public void SetPurchaseLimits(List<PurchaseLimitConfig> limits) =>
        PurchaseLimitsJson = System.Text.Json.JsonSerializer.Serialize(limits);
}
```

#### 2.1.5 ShopItemStock 实体（运行时库存）

**文件**: `BlazorIdle.Server/Domain/Shop/Models/ShopItemStock.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

/// <summary>
/// 商品库存 - 运行时状态
/// </summary>
public class ShopItemStock
{
    public Guid Id { get; private set; }
    public Guid ShopInstanceId { get; private set; }
    public string ShopItemId { get; private set; }
    
    public int? CurrentStock { get; private set; } // null表示无限
    public int? MaxStock { get; private set; }
    
    public DateTime LastRestockTime { get; private set; }
    public DateTime UpdatedAt { get; private set; }
    
    // 导航属性
    public ShopInstance ShopInstance { get; set; } = null!;
    
    // 构造函数
    private ShopItemStock() { } // EF Core
    
    public ShopItemStock(
        Guid shopInstanceId, 
        string shopItemId, 
        int? maxStock,
        int? initialStock)
    {
        Id = Guid.NewGuid();
        ShopInstanceId = shopInstanceId;
        ShopItemId = shopItemId;
        MaxStock = maxStock;
        CurrentStock = initialStock;
        LastRestockTime = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
    }
    
    /// <summary>
    /// 尝试扣减库存
    /// </summary>
    public bool TryDeduct(int quantity)
    {
        // 无限库存
        if (CurrentStock == null)
            return true;
            
        // 库存不足
        if (CurrentStock < quantity)
            return false;
            
        CurrentStock -= quantity;
        UpdatedAt = DateTime.UtcNow;
        return true;
    }
    
    /// <summary>
    /// 补充库存到最大值
    /// </summary>
    public void RestockToMax()
    {
        if (MaxStock.HasValue)
        {
            CurrentStock = MaxStock.Value;
            LastRestockTime = DateTime.UtcNow;
            UpdatedAt = DateTime.UtcNow;
        }
    }
    
    /// <summary>
    /// 设置库存
    /// </summary>
    public void SetStock(int? stock)
    {
        CurrentStock = stock;
        UpdatedAt = DateTime.UtcNow;
    }
}
```

### 2.2 仓储接口定义

#### 2.2.1 IShopRepository 接口

**文件**: `BlazorIdle.Server/Domain/Shop/Repositories/IShopRepository.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Repositories;

public interface IShopRepository
{
    // 商店定义查询
    Task<ShopDefinition?> GetShopDefinitionAsync(
        string shopId, 
        CancellationToken ct = default);
        
    Task<List<ShopDefinition>> GetAllActiveShopDefinitionsAsync(
        CancellationToken ct = default);
        
    Task<List<ShopDefinition>> GetShopDefinitionsByTypeAsync(
        ShopType shopType, 
        CancellationToken ct = default);
    
    // 商店实例查询
    Task<ShopInstance?> GetShopInstanceAsync(
        Guid instanceId, 
        CancellationToken ct = default);
        
    Task<ShopInstance?> GetOrCreateShopInstanceAsync(
        string shopDefinitionId, 
        CancellationToken ct = default);
        
    Task<List<ShopInstance>> GetShopInstancesNeedingRefreshAsync(
        DateTime currentTime, 
        CancellationToken ct = default);
    
    // 商品定义查询
    Task<ShopItemDefinition?> GetShopItemDefinitionAsync(
        string shopItemId, 
        CancellationToken ct = default);
        
    Task<List<ShopItemDefinition>> GetShopItemDefinitionsByShopAsync(
        string shopDefinitionId, 
        CancellationToken ct = default);
    
    // 持久化
    Task<ShopInstance> SaveShopInstanceAsync(
        ShopInstance instance, 
        CancellationToken ct = default);
        
    Task SaveShopDefinitionAsync(
        ShopDefinition definition, 
        CancellationToken ct = default);
}
```

#### 2.2.2 IPurchaseHistoryRepository 接口

**文件**: `BlazorIdle.Server/Domain/Shop/Repositories/IPurchaseHistoryRepository.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Repositories;

public interface IPurchaseHistoryRepository
{
    // 查询购买历史
    Task<PurchaseRecord?> GetPurchaseRecordAsync(
        Guid transactionId, 
        CancellationToken ct = default);
        
    Task<List<PurchaseRecord>> GetCharacterPurchaseHistoryAsync(
        Guid characterId, 
        DateTime? startDate = null,
        DateTime? endDate = null,
        int page = 1, 
        int pageSize = 50,
        CancellationToken ct = default);
    
    // 查询限购状态
    Task<CharacterPurchaseRecord?> GetCharacterPurchaseRecordAsync(
        Guid characterId, 
        string shopItemId,
        CancellationToken ct = default);
        
    Task<Dictionary<string, CharacterPurchaseRecord>> GetCharacterPurchaseRecordsAsync(
        Guid characterId, 
        List<string> shopItemIds,
        CancellationToken ct = default);
    
    // 记录购买
    Task<PurchaseRecord> RecordPurchaseAsync(
        PurchaseRecord record, 
        CancellationToken ct = default);
        
    Task UpdateCharacterPurchaseRecordAsync(
        CharacterPurchaseRecord record,
        CancellationToken ct = default);
    
    // 重置限购计数
    Task ResetDailyPurchasesAsync(
        DateTime resetTime, 
        CancellationToken ct = default);
        
    Task ResetWeeklyPurchasesAsync(
        DateTime resetTime, 
        CancellationToken ct = default);
}
```

### 2.3 数据库迁移

#### 2.3.1 Entity Configuration

**文件**: `BlazorIdle.Server/Infrastructure/Persistence/Configurations/ShopDefinitionConfiguration.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using BlazorIdle.Server.Domain.Shop.Models;

namespace BlazorIdle.Server.Infrastructure.Persistence.Configurations;

public class ShopDefinitionConfiguration : IEntityTypeConfiguration<ShopDefinition>
{
    public void Configure(EntityTypeBuilder<ShopDefinition> builder)
    {
        builder.ToTable("ShopDefinitions");
        
        builder.HasKey(s => s.Id);
        builder.Property(s => s.Id).HasMaxLength(100);
        
        builder.Property(s => s.Name).IsRequired().HasMaxLength(200);
        builder.Property(s => s.Description).HasMaxLength(1000);
        builder.Property(s => s.Icon).HasMaxLength(200);
        
        builder.Property(s => s.ShopType).IsRequired();
        builder.Property(s => s.RefreshInterval).IsRequired();
        
        builder.Property(s => s.UnlockConditionExpr).HasMaxLength(500);
        builder.Property(s => s.TagsJson).HasMaxLength(1000).HasDefaultValue("[]");
        
        builder.Property(s => s.SortOrder).HasDefaultValue(0);
        builder.Property(s => s.IsActive).HasDefaultValue(true);
        
        builder.Property(s => s.CreatedAt).HasDefaultValueSql("CURRENT_TIMESTAMP");
        builder.Property(s => s.UpdatedAt).HasDefaultValueSql("CURRENT_TIMESTAMP");
        
        // 索引
        builder.HasIndex(s => s.ShopType);
        builder.HasIndex(s => s.IsActive);
        builder.HasIndex(s => s.SortOrder);
        
        // 关系
        builder.HasMany(s => s.ItemDefinitions)
            .WithOne(i => i.ShopDefinition)
            .HasForeignKey(i => i.ShopDefinitionId)
            .OnDelete(DeleteBehavior.Cascade);
    }
}
```

#### 2.3.2 创建迁移脚本

```bash
cd BlazorIdle.Server
dotnet ef migrations add AddShopSystem --context GameDbContext
dotnet ef database update
```

#### 2.3.3 初始数据种子

**文件**: `BlazorIdle.Server/Infrastructure/Persistence/Seeds/ShopSeeds.cs`

```csharp
using BlazorIdle.Server.Domain.Shop.Models;

namespace BlazorIdle.Server.Infrastructure.Persistence.Seeds;

public static class ShopSeeds
{
    public static List<ShopDefinition> GetDefaultShops()
    {
        return new List<ShopDefinition>
        {
            // 普通商店
            new ShopDefinition
            {
                Id = "shop_general_town",
                Name = "城镇杂货铺",
                Description = "出售日常消耗品和基础装备",
                ShopType = ShopType.General,
                Icon = "shop_general.png",
                UnlockConditionExpr = null,
                RefreshInterval = RefreshInterval.Never,
                AllowManualRefresh = false,
                SortOrder = 1,
                IsActive = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow,
                ItemDefinitions = new List<ShopItemDefinition>
                {
                    new ShopItemDefinition
                    {
                        Id = "item_bread",
                        ShopDefinitionId = "shop_general_town",
                        ItemType = ItemType.Consumable,
                        ItemId = "consumable_bread",
                        ItemName = "面包",
                        PricesJson = "[{\"CurrencyType\":0,\"Amount\":5}]", // Gold:5
                        StockPolicy = StockPolicy.Infinite,
                        MaxStock = null,
                        PurchaseLimitsJson = "[]",
                        UnlockConditionExpr = null,
                        ShowWhenLocked = true,
                        DisplayOrder = 1,
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow,
                        UpdatedAt = DateTime.UtcNow
                    },
                    new ShopItemDefinition
                    {
                        Id = "item_health_potion_minor",
                        ShopDefinitionId = "shop_general_town",
                        ItemType = ItemType.Consumable,
                        ItemId = "potion_health_minor",
                        ItemName = "生命药水（小）",
                        PricesJson = "[{\"CurrencyType\":0,\"Amount\":20}]",
                        StockPolicy = StockPolicy.Infinite,
                        DisplayOrder = 2,
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow,
                        UpdatedAt = DateTime.UtcNow
                    }
                }
            },
            
            // 装备商店
            new ShopDefinition
            {
                Id = "shop_equipment_blacksmith",
                Name = "铁匠铺",
                Description = "出售精良装备，每日更新库存",
                ShopType = ShopType.Equipment,
                Icon = "shop_blacksmith.png",
                UnlockConditionExpr = "level>=10",
                RefreshInterval = RefreshInterval.Daily,
                AllowManualRefresh = true,
                ManualRefreshCost = 50,
                SortOrder = 2,
                IsActive = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            }
        };
    }
}
```

---

## 3. Phase 2: 核心功能实现

### 3.1 购买服务实现

#### 任务清单

- [ ] 3.1.1 实现 PurchaseValidator（购买验证器）
- [ ] 3.1.2 实现 PurchaseService（购买服务）
- [ ] 3.1.3 实现 TransactionLogger（交易日志）
- [ ] 3.1.4 实现幂等性保证机制
- [ ] 3.1.5 编写购买流程单元测试
- [ ] 3.1.6 编写集成测试

#### 3.1.1 PurchaseValidator 实现

**文件**: `BlazorIdle.Server/Application/Shop/Validators/PurchaseValidator.cs`

```csharp
namespace BlazorIdle.Server.Application.Shop.Validators;

/// <summary>
/// 购买验证器
/// </summary>
public class PurchaseValidator : IPurchaseValidator
{
    private readonly ICharacterRepository _characterRepo;
    private readonly IShopRepository _shopRepo;
    private readonly IPurchaseHistoryRepository _purchaseHistoryRepo;
    private readonly ICurrencyExchanger _currencyExchanger;
    private readonly IConditionEvaluator _conditionEvaluator;
    private readonly ILogger<PurchaseValidator> _logger;
    
    public PurchaseValidator(
        ICharacterRepository characterRepo,
        IShopRepository shopRepo,
        IPurchaseHistoryRepository purchaseHistoryRepo,
        ICurrencyExchanger currencyExchanger,
        IConditionEvaluator conditionEvaluator,
        ILogger<PurchaseValidator> logger)
    {
        _characterRepo = characterRepo;
        _shopRepo = shopRepo;
        _purchaseHistoryRepo = purchaseHistoryRepo;
        _currencyExchanger = currencyExchanger;
        _conditionEvaluator = conditionEvaluator;
        _logger = logger;
    }
    
    public async Task<ValidationResult> ValidateAsync(
        PurchaseRequest request,
        CancellationToken ct = default)
    {
        // 1. 验证角色存在
        var character = await _characterRepo.GetByIdAsync(request.CharacterId, ct);
        if (character == null)
            return ValidationResult.Fail("角色不存在");
        
        // 2. 验证商店存在
        var shopInstance = await _shopRepo.GetShopInstanceAsync(request.ShopInstanceId, ct);
        if (shopInstance == null)
            return ValidationResult.Fail("商店不存在");
        
        // 3. 验证商品存在
        var itemDef = await _shopRepo.GetShopItemDefinitionAsync(request.ShopItemId, ct);
        if (itemDef == null || !itemDef.IsActive)
            return ValidationResult.Fail("商品不存在或已下架");
        
        // 4. 验证商品解锁条件
        if (!string.IsNullOrEmpty(itemDef.UnlockConditionExpr))
        {
            var isUnlocked = await _conditionEvaluator.EvaluateAsync(
                itemDef.UnlockConditionExpr, 
                request.CharacterId, 
                ct);
                
            if (!isUnlocked)
                return ValidationResult.Fail("商品未解锁");
        }
        
        // 5. 验证购买数量
        if (request.Quantity <= 0)
            return ValidationResult.Fail("购买数量必须大于0");
            
        if (request.Quantity > 999) // 单次最大购买数量
            return ValidationResult.Fail("单次购买数量不能超过999");
        
        // 6. 验证库存
        var stock = shopInstance.ItemStocks.FirstOrDefault(s => s.ShopItemId == request.ShopItemId);
        if (stock?.CurrentStock != null && stock.CurrentStock < request.Quantity)
            return ValidationResult.Fail($"库存不足，当前库存：{stock.CurrentStock}");
        
        // 7. 验证限购
        var purchaseRecord = await _purchaseHistoryRepo.GetCharacterPurchaseRecordAsync(
            request.CharacterId, 
            request.ShopItemId, 
            ct);
            
        var limits = itemDef.GetPurchaseLimits();
        foreach (var limit in limits)
        {
            if (purchaseRecord != null && purchaseRecord.IsLimitExceeded(limit, request.Quantity))
            {
                var limitDesc = limit.LimitType switch
                {
                    LimitType.PerDay => "每日",
                    LimitType.PerWeek => "每周",
                    LimitType.PerMonth => "每月",
                    LimitType.Lifetime => "终身",
                    _ => ""
                };
                return ValidationResult.Fail($"超出{limitDesc}限购数量（上限：{limit.MaxQuantity}）");
            }
        }
        
        // 8. 验证货币充足
        var prices = itemDef.GetPrices();
        var totalCosts = prices.Select(p => new CurrencyCost
        {
            CurrencyType = p.CurrencyType,
            CurrencyId = p.CurrencyId,
            Amount = p.Amount * request.Quantity
        }).ToList();
        
        var hasEnough = await _currencyExchanger.HasEnoughCurrency(
            request.CharacterId, 
            totalCosts, 
            ct);
            
        if (!hasEnough)
            return ValidationResult.Fail("货币不足");
        
        // 9. 验证背包空间（消耗品需要背包空间）
        if (itemDef.ItemType == ItemType.Consumable || itemDef.ItemType == ItemType.Material)
        {
            // TODO: 实现背包容量检查
            // var hasSpace = await _inventoryService.HasSpaceAsync(request.CharacterId, ct);
            // if (!hasSpace) return ValidationResult.Fail("背包已满");
        }
        
        return ValidationResult.Success();
    }
}

/// <summary>
/// 验证结果
/// </summary>
public class ValidationResult
{
    public bool IsSuccess { get; set; }
    public string? ErrorMessage { get; set; }
    
    public static ValidationResult Success() => new() { IsSuccess = true };
    public static ValidationResult Fail(string message) => new() { IsSuccess = false, ErrorMessage = message };
}

/// <summary>
/// 购买请求
/// </summary>
public class PurchaseRequest
{
    public Guid CharacterId { get; set; }
    public Guid ShopInstanceId { get; set; }
    public string ShopItemId { get; set; } = string.Empty;
    public int Quantity { get; set; }
    public string TransactionId { get; set; } = string.Empty; // 幂等性键
}
```

#### 3.1.2 PurchaseService 实现

**文件**: `BlazorIdle.Server/Application/Shop/Services/PurchaseService.cs`

```csharp
namespace BlazorIdle.Server.Application.Shop.Services;

/// <summary>
/// 购买服务
/// </summary>
public class PurchaseService : IPurchaseService
{
    private readonly IShopRepository _shopRepo;
    private readonly IPurchaseHistoryRepository _purchaseHistoryRepo;
    private readonly IPurchaseValidator _validator;
    private readonly ICurrencyExchanger _currencyExchanger;
    private readonly IRewardGrantService _rewardGrantService;
    private readonly ILogger<PurchaseService> _logger;
    private readonly GameDbContext _dbContext;
    
    public async Task<PurchaseResult> PurchaseAsync(
        PurchaseRequest request,
        CancellationToken ct = default)
    {
        // 幂等性检查
        var existingRecord = await _purchaseHistoryRepo.GetPurchaseRecordAsync(
            Guid.Parse(request.TransactionId), 
            ct);
            
        if (existingRecord != null)
        {
            _logger.LogInformation("Purchase already processed: {TransactionId}", request.TransactionId);
            return PurchaseResult.AlreadyProcessed(existingRecord);
        }
        
        // 验证购买条件
        var validationResult = await _validator.ValidateAsync(request, ct);
        if (!validationResult.IsSuccess)
        {
            return PurchaseResult.Fail(validationResult.ErrorMessage!);
        }
        
        // 开始事务
        await using var transaction = await _dbContext.Database.BeginTransactionAsync(ct);
        try
        {
            // 1. 获取商店实例和商品定义
            var shopInstance = await _shopRepo.GetShopInstanceAsync(request.ShopInstanceId, ct);
            var itemDef = await _shopRepo.GetShopItemDefinitionAsync(request.ShopItemId, ct);
            
            // 2. 扣除货币
            var prices = itemDef!.GetPrices();
            var totalCosts = prices.Select(p => new CurrencyCost
            {
                CurrencyType = p.CurrencyType,
                CurrencyId = p.CurrencyId,
                Amount = p.Amount * request.Quantity
            }).ToList();
            
            var deductResult = await _currencyExchanger.DeductCurrency(
                request.CharacterId, 
                totalCosts, 
                $"Purchase:{request.ShopItemId}:{request.Quantity}",
                ct);
                
            if (!deductResult.Success)
            {
                await transaction.RollbackAsync(ct);
                return PurchaseResult.Fail(deductResult.ErrorMessage!);
            }
            
            // 3. 扣减库存
            if (!shopInstance!.TryDeductStock(request.ShopItemId, request.Quantity))
            {
                await transaction.RollbackAsync(ct);
                return PurchaseResult.Fail("库存不足");
            }
            
            // 4. 发放物品
            var grantSuccess = await GrantItemAsync(
                request.CharacterId, 
                itemDef, 
                request.Quantity, 
                request.TransactionId,
                ct);
                
            if (!grantSuccess)
            {
                await transaction.RollbackAsync(ct);
                return PurchaseResult.Fail("物品发放失败");
            }
            
            // 5. 记录购买历史
            var purchaseRecord = new PurchaseRecord
            {
                Id = Guid.Parse(request.TransactionId),
                CharacterId = request.CharacterId,
                ShopItemId = request.ShopItemId,
                ItemType = itemDef.ItemType,
                ItemId = itemDef.ItemId,
                Quantity = request.Quantity,
                TotalCostJson = System.Text.Json.JsonSerializer.Serialize(totalCosts),
                PurchaseTime = DateTime.UtcNow
            };
            
            await _purchaseHistoryRepo.RecordPurchaseAsync(purchaseRecord, ct);
            
            // 6. 更新角色限购记录
            await UpdatePurchaseLimitRecordAsync(
                request.CharacterId, 
                request.ShopItemId, 
                request.Quantity,
                ct);
            
            // 7. 保存商店实例（库存变更）
            await _shopRepo.SaveShopInstanceAsync(shopInstance, ct);
            
            // 提交事务
            await transaction.CommitAsync(ct);
            
            // 8. 发布领域事件（事务外）
            PublishPurchaseCompletedEvent(request, itemDef, totalCosts);
            
            _logger.LogInformation(
                "Purchase completed: CharacterId={CharacterId}, Item={ItemId}, Qty={Quantity}",
                request.CharacterId, itemDef.ItemId, request.Quantity);
            
            return PurchaseResult.Success(purchaseRecord, deductResult.RemainingBalances);
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync(ct);
            _logger.LogError(ex, "Purchase failed: {TransactionId}", request.TransactionId);
            return PurchaseResult.Fail($"购买失败：{ex.Message}");
        }
    }
    
    private async Task<bool> GrantItemAsync(
        Guid characterId,
        ShopItemDefinition itemDef,
        int quantity,
        string transactionId,
        CancellationToken ct)
    {
        switch (itemDef.ItemType)
        {
            case ItemType.Consumable:
            case ItemType.Material:
                // 使用RewardGrantService发放物品到背包
                return await _rewardGrantService.GrantRewardsAsync(
                    characterId,
                    gold: 0,
                    exp: 0,
                    items: new Dictionary<string, int> { [itemDef.ItemId] = quantity },
                    idempotencyKey: transactionId,
                    eventType: "ShopPurchase",
                    ct: ct);
                    
            case ItemType.Equipment:
                // 装备需要生成实例（待实现）
                // TODO: 调用 GearGenerationService
                return true;
                
            case ItemType.Recipe:
                // 配方直接解锁（待实现）
                return true;
                
            default:
                return false;
        }
    }
    
    private async Task UpdatePurchaseLimitRecordAsync(
        Guid characterId,
        string shopItemId,
        int quantity,
        CancellationToken ct)
    {
        var record = await _purchaseHistoryRepo.GetCharacterPurchaseRecordAsync(
            characterId, 
            shopItemId, 
            ct);
            
        if (record == null)
        {
            record = new CharacterPurchaseRecord
            {
                Id = Guid.NewGuid(),
                CharacterId = characterId,
                ShopItemId = shopItemId,
                LastDailyReset = DateTime.UtcNow.Date,
                LastWeeklyReset = DateTime.UtcNow.Date,
                LastMonthlyReset = DateTime.UtcNow.Date
            };
        }
        
        record.RecordPurchase(quantity, DateTime.UtcNow);
        await _purchaseHistoryRepo.UpdateCharacterPurchaseRecordAsync(record, ct);
    }
    
    private void PublishPurchaseCompletedEvent(
        PurchaseRequest request,
        ShopItemDefinition itemDef,
        List<CurrencyCost> costs)
    {
        // TODO: 实现领域事件发布
        // _eventBus.Publish(new PurchaseCompletedEvent { ... });
    }
}
```

### 3.2 商店刷新服务

#### 任务清单

- [ ] 3.2.1 实现 ShopRefreshService
- [ ] 3.2.2 实现定时任务（Hosted Service）
- [ ] 3.2.3 实现手动刷新功能
- [ ] 3.2.4 编写刷新逻辑测试

#### 3.2.1 ShopRefreshService 实现

**文件**: `BlazorIdle.Server/Application/Shop/Services/ShopRefreshService.cs`

```csharp
namespace BlazorIdle.Server.Application.Shop.Services;

/// <summary>
/// 商店刷新服务
/// </summary>
public class ShopRefreshService : IShopRefreshService
{
    private readonly IShopRepository _shopRepo;
    private readonly ILogger<ShopRefreshService> _logger;
    
    public async Task<RefreshResult> RefreshShopAsync(
        string shopDefinitionId,
        CancellationToken ct = default)
    {
        var shopInstance = await _shopRepo.GetOrCreateShopInstanceAsync(shopDefinitionId, ct);
        var definition = await _shopRepo.GetShopDefinitionAsync(shopDefinitionId, ct);
        
        if (definition == null)
            return RefreshResult.Fail("商店定义不存在");
        
        // 检查是否需要刷新
        if (!shopInstance.NeedsRefresh(DateTime.UtcNow) && definition.RefreshInterval != RefreshInterval.Never)
            return RefreshResult.Skip("商店尚未到刷新时间");
        
        // 生成新库存
        var newStocks = await GenerateStocksAsync(definition, ct);
        
        // 执行刷新
        shopInstance.Refresh(DateTime.UtcNow, newStocks);
        
        // 保存
        await _shopRepo.SaveShopInstanceAsync(shopInstance, ct);
        
        _logger.LogInformation(
            "Shop refreshed: {ShopId}, ItemCount={Count}", 
            shopDefinitionId, 
            newStocks.Count);
        
        return RefreshResult.Success(shopInstance);
    }
    
    private async Task<List<ShopItemStock>> GenerateStocksAsync(
        ShopDefinition definition,
        CancellationToken ct)
    {
        var stocks = new List<ShopItemStock>();
        
        var itemDefs = await _shopRepo.GetShopItemDefinitionsByShopAsync(definition.Id, ct);
        
        foreach (var itemDef in itemDefs.Where(i => i.IsActive))
        {
            var stock = new ShopItemStock(
                Guid.Empty, // 将在ShopInstance.Refresh中设置
                itemDef.Id,
                itemDef.MaxStock,
                itemDef.RefreshStock ?? itemDef.MaxStock);
                
            stocks.Add(stock);
        }
        
        return stocks;
    }
}
```

---

## 4. Phase 3: 条件解锁与货币系统

### 4.1 条件评估器实现

**文件**: `BlazorIdle.Server/Application/Unlock/Services/ConditionEvaluator.cs`

```csharp
namespace BlazorIdle.Server.Application.Unlock.Services;

/// <summary>
/// 条件评估器 - 简化版实现
/// </summary>
public class ConditionEvaluator : IConditionEvaluator
{
    private readonly ICharacterRepository _characterRepo;
    private readonly ILogger<ConditionEvaluator> _logger;
    
    public async Task<bool> EvaluateAsync(
        string conditionExpr,
        Guid characterId,
        CancellationToken ct = default)
    {
        if (string.IsNullOrEmpty(conditionExpr))
            return true;
        
        var context = await BuildContextAsync(characterId, ct);
        
        try
        {
            return EvaluateExpression(conditionExpr, context);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to evaluate condition: {Expr}", conditionExpr);
            return false;
        }
    }
    
    private async Task<ConditionContext> BuildContextAsync(
        Guid characterId,
        CancellationToken ct)
    {
        var character = await _characterRepo.GetByIdAsync(characterId, ct);
        
        return new ConditionContext
        {
            CharacterId = characterId,
            Level = character?.Level ?? 0,
            Gold = character?.Gold ?? 0,
            Profession = character?.ProfessionId ?? "",
            CurrentTime = DateTime.UtcNow
        };
    }
    
    private bool EvaluateExpression(string expr, ConditionContext ctx)
    {
        expr = expr.Trim();
        
        // 简单解析：level>=10
        if (expr.StartsWith("level>="))
        {
            var value = int.Parse(expr.Substring(7));
            return ctx.Level >= value;
        }
        
        if (expr.StartsWith("level<="))
        {
            var value = int.Parse(expr.Substring(7));
            return ctx.Level <= value;
        }
        
        if (expr.StartsWith("gold>="))
        {
            var value = long.Parse(expr.Substring(6));
            return ctx.Gold >= value;
        }
        
        // AND逻辑
        if (expr.StartsWith("AND(") && expr.EndsWith(")"))
        {
            var inner = expr.Substring(4, expr.Length - 5);
            var conditions = SplitConditions(inner);
            return conditions.All(c => EvaluateExpression(c, ctx));
        }
        
        // OR逻辑
        if (expr.StartsWith("OR(") && expr.EndsWith(")"))
        {
            var inner = expr.Substring(3, expr.Length - 4);
            var conditions = SplitConditions(inner);
            return conditions.Any(c => EvaluateExpression(c, ctx));
        }
        
        // NOT逻辑
        if (expr.StartsWith("NOT(") && expr.EndsWith(")"))
        {
            var inner = expr.Substring(4, expr.Length - 5);
            return !EvaluateExpression(inner, ctx);
        }
        
        // 默认返回false
        return false;
    }
    
    private List<string> SplitConditions(string expr)
    {
        // 简化实现：按逗号分割（不考虑嵌套括号）
        return expr.Split(',').Select(s => s.Trim()).ToList();
    }
}
```

### 4.2 货币兑换器实现

**文件**: `BlazorIdle.Server/Application/Economy/Services/CurrencyExchanger.cs`

```csharp
namespace BlazorIdle.Server.Application.Economy.Services;

/// <summary>
/// 货币兑换器
/// </summary>
public class CurrencyExchanger : ICurrencyExchanger
{
    private readonly GameDbContext _dbContext;
    private readonly ILogger<CurrencyExchanger> _logger;
    
    public async Task<bool> HasEnoughCurrency(
        Guid characterId,
        List<CurrencyCost> costs,
        CancellationToken ct = default)
    {
        var balances = await GetBalancesAsync(characterId, ct);
        
        foreach (var cost in costs)
        {
            var balance = balances.GetValueOrDefault(cost.CurrencyType, 0);
            if (balance < cost.Amount)
                return false;
        }
        
        return true;
    }
    
    public async Task<CurrencyDeductionResult> DeductCurrency(
        Guid characterId,
        List<CurrencyCost> costs,
        string reason,
        CancellationToken ct = default)
    {
        var character = await _dbContext.Characters.FindAsync(new object[] { characterId }, ct);
        if (character == null)
            return CurrencyDeductionResult.Fail("角色不存在");
        
        var deducted = new Dictionary<CurrencyType, long>();
        
        foreach (var cost in costs)
        {
            switch (cost.CurrencyType)
            {
                case CurrencyType.Gold:
                    if (character.Gold < cost.Amount)
                        return CurrencyDeductionResult.Fail("金币不足");
                    character.Gold -= cost.Amount;
                    deducted[CurrencyType.Gold] = cost.Amount;
                    break;
                    
                // TODO: 实现其他货币类型
                default:
                    return CurrencyDeductionResult.Fail($"不支持的货币类型：{cost.CurrencyType}");
            }
        }
        
        await _dbContext.SaveChangesAsync(ct);
        
        var remaining = await GetBalancesAsync(characterId, ct);
        
        return CurrencyDeductionResult.Success(deducted, remaining);
    }
    
    private async Task<Dictionary<CurrencyType, long>> GetBalancesAsync(
        Guid characterId,
        CancellationToken ct)
    {
        var character = await _dbContext.Characters.FindAsync(new object[] { characterId }, ct);
        
        var balances = new Dictionary<CurrencyType, long>();
        if (character != null)
        {
            balances[CurrencyType.Gold] = character.Gold;
        }
        
        // TODO: 查询其他货币
        
        return balances;
    }
}
```

---

## 5. Phase 4: 前端界面开发

### 5.1 前端组件清单

| 组件 | 文件路径 | 功能 | 优先级 |
|-----|---------|------|--------|
| ShopList | Pages/ShopList.razor | 商店列表页 | P1 |
| ShopDetail | Pages/ShopDetail.razor | 商店详情页 | P1 |
| ShopItemCard | Components/ShopItemCard.razor | 商品卡片 | P1 |
| PurchaseModal | Components/PurchaseModal.razor | 购买确认框 | P1 |
| ShopFilter | Components/ShopFilter.razor | 商品筛选 | P2 |
| CurrencyDisplay | Components/CurrencyDisplay.razor | 货币显示 | P2 |

### 5.2 ShopList 页面实现

**文件**: `BlazorIdle/Pages/ShopList.razor`

```razor
@page "/shops"
@inject HttpClient Http
@inject IToastService Toast

<div class="shops-container">
    <h2>商店</h2>
    
    @if (_loading)
    {
        <p>加载中...</p>
    }
    else if (_shops.Count == 0)
    {
        <p>暂无可用商店</p>
    }
    else
    {
        <div class="shop-grid">
            @foreach (var shop in _shops)
            {
                <div class="shop-card @(shop.IsUnlocked ? "" : "locked")" 
                     @onclick="() => NavigateToShop(shop.ShopId)">
                    <img src="@shop.Icon" alt="@shop.Name" class="shop-icon" />
                    <h3>@shop.Name</h3>
                    <p>@shop.Description</p>
                    
                    @if (!shop.IsUnlocked)
                    {
                        <div class="lock-overlay">
                            <span>🔒 未解锁</span>
                        </div>
                    }
                    
                    @if (shop.RefreshInterval != "Never")
                    {
                        <div class="refresh-info">
                            <span>刷新: @shop.RefreshInterval</span>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ShopListItemDto> _shops = new();
    private bool _loading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadShopsAsync();
    }
    
    private async Task LoadShopsAsync()
    {
        try
        {
            _loading = true;
            var response = await Http.GetFromJsonAsync<ShopListResponse>("/api/shops");
            _shops = response?.Shops ?? new();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"加载商店失败：{ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }
    
    private void NavigateToShop(string shopId)
    {
        // TODO: 导航到商店详情页
    }
}
```

### 5.3 ShopDetail 页面实现

**文件**: `BlazorIdle/Pages/ShopDetail.razor`

```razor
@page "/shops/{ShopId}"
@inject HttpClient Http
@inject IToastService Toast

<div class="shop-detail-container">
    @if (_loading)
    {
        <p>加载中...</p>
    }
    else if (_shop != null)
    {
        <div class="shop-header">
            <h2>@_shop.Name</h2>
            <p>@_shop.Description</p>
            
            <div class="currency-display">
                <span>💰 金币: @_characterGold</span>
                <!-- TODO: 显示其他货币 -->
            </div>
        </div>
        
        <div class="items-grid">
            @foreach (var item in _shop.Items)
            {
                <ShopItemCard Item="@item" 
                              OnPurchase="HandlePurchaseAsync" />
            }
        </div>
    }
</div>

@code {
    [Parameter] public string ShopId { get; set; } = string.Empty;
    
    private ShopDetailDto? _shop;
    private long _characterGold;
    private bool _loading = true;
    
    protected override async Task OnParametersSetAsync()
    {
        await LoadShopDetailAsync();
    }
    
    private async Task LoadShopDetailAsync()
    {
        try
        {
            _loading = true;
            _shop = await Http.GetFromJsonAsync<ShopDetailDto>($"/api/shops/{ShopId}");
            // TODO: 加载角色货币信息
        }
        catch (Exception ex)
        {
            Toast.ShowError($"加载商店失败：{ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }
    
    private async Task HandlePurchaseAsync(string shopItemId, int quantity)
    {
        // TODO: 实现购买逻辑
    }
}
```

---

## 6. 数据库设计详解

### 6.1 ER图

```
[Character] 1--N [PurchaseRecord]
[Character] 1--N [CharacterPurchaseRecord]
[ShopDefinition] 1--N [ShopItemDefinition]
[ShopDefinition] 1--1 [ShopInstance]
[ShopInstance] 1--N [ShopItemStock]
```

### 6.2 表结构SQL

**完整建表语句见附录**

---

## 7. API接口设计

### 7.1 商店接口

#### GET /api/shops
获取角色可见的商店列表

**Response**:
```json
{
  "shops": [
    {
      "shopId": "shop_general_town",
      "name": "城镇杂货铺",
      "description": "出售日常消耗品",
      "icon": "shop_general.png",
      "shopType": "General",
      "isUnlocked": true,
      "refreshInterval": "Never"
    }
  ]
}
```

#### GET /api/shops/{shopId}
获取商店详情和商品列表

**Response**:
```json
{
  "shopId": "shop_general_town",
  "name": "城镇杂货铺",
  "items": [
    {
      "shopItemId": "item_bread",
      "itemType": "Consumable",
      "itemId": "consumable_bread",
      "itemName": "面包",
      "prices": [
        { "currencyType": "Gold", "amount": 5 }
      ],
      "currentStock": null,
      "maxStock": null,
      "isUnlocked": true,
      "remainingPurchases": null
    }
  ]
}
```

#### POST /api/shops/purchase
购买商品

**Request**:
```json
{
  "characterId": "guid",
  "shopItemId": "item_bread",
  "quantity": 10,
  "transactionId": "guid"
}
```

**Response**:
```json
{
  "success": true,
  "message": "购买成功",
  "itemsGranted": [
    { "itemId": "consumable_bread", "quantity": 10 }
  ],
  "remainingCurrency": {
    "gold": 950
  }
}
```

---

## 8. 下篇预告

**商店系统设计方案（下篇）** 将涵盖：
- Phase 5: 集成测试策略
- Phase 6: 性能优化与监控
- 安全性加固方案
- 运维配置管理
- 扩展功能设计（拍卖行、交易行）

---

**文档结束 - 请继续阅读《商店系统设计方案（下篇）》**
