# BlazorIdle å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸­ç¯‡ï¼‰
## è¯¦ç»†å®æ–½æ­¥éª¤ä¸æŠ€æœ¯å®ç°

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç±»å‹**: è®¾è®¡æ–¹æ¡ˆ - ä¸­ç¯‡  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**ä½œè€…**: ç³»ç»Ÿæ¶æ„å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [å®æ–½è·¯çº¿å›¾](#1-å®æ–½è·¯çº¿å›¾)
2. [Phase 1: åŸºç¡€æ¶æ„æ­å»º](#2-phase-1-åŸºç¡€æ¶æ„æ­å»º)
3. [Phase 2: æ ¸å¿ƒåŠŸèƒ½å®ç°](#3-phase-2-æ ¸å¿ƒåŠŸèƒ½å®ç°)
4. [Phase 3: æ¡ä»¶è§£é”ä¸è´§å¸ç³»ç»Ÿ](#4-phase-3-æ¡ä»¶è§£é”ä¸è´§å¸ç³»ç»Ÿ)
5. [Phase 4: å‰ç«¯ç•Œé¢å¼€å‘](#5-phase-4-å‰ç«¯ç•Œé¢å¼€å‘)
6. [æ•°æ®åº“è®¾è®¡è¯¦è§£](#6-æ•°æ®åº“è®¾è®¡è¯¦è§£)
7. [APIæ¥å£è®¾è®¡](#7-apiæ¥å£è®¾è®¡)

---

## 1. å®æ–½è·¯çº¿å›¾

### 1.1 æ€»ä½“æ—¶é—´è§„åˆ’

| Phase | é˜¶æ®µåç§° | å·¥ä½œé‡ | ä¾èµ–é¡¹ | äº¤ä»˜ç‰© |
|-------|---------|--------|--------|--------|
| **P0** | éœ€æ±‚ç¡®è®¤ä¸è®¾è®¡è¯„å®¡ | 2å¤© | æ—  | è®¾è®¡æ–‡æ¡£ã€æ•°æ®åº“ERå›¾ |
| **P1** | åŸºç¡€æ¶æ„æ­å»º | 3-4å¤© | P0 | é¢†åŸŸæ¨¡å‹ã€ä»“å‚¨æ¥å£ã€æ•°æ®è¡¨ |
| **P2** | æ ¸å¿ƒåŠŸèƒ½å®ç° | 5-6å¤© | P1 | è´­ä¹°æœåŠ¡ã€åˆ·æ–°æœåŠ¡ã€åº“å­˜ç®¡ç† |
| **P3** | æ¡ä»¶è§£é”ä¸è´§å¸ç³»ç»Ÿ | 4-5å¤© | P2 | æ¡ä»¶è¯„ä¼°å™¨ã€è´§å¸å…‘æ¢å™¨ã€å£°æœ›ç³»ç»Ÿ |
| **P4** | å‰ç«¯ç•Œé¢å¼€å‘ | 5-6å¤© | P2, P3 | å•†åº—åˆ—è¡¨ã€å•†åº—è¯¦æƒ…ã€è´­ä¹°ç•Œé¢ |
| **P5** | é›†æˆæµ‹è¯•ä¸ä¼˜åŒ– | 3-4å¤© | P4 | æµ‹è¯•æŠ¥å‘Šã€æ€§èƒ½æŠ¥å‘Š |
| **P6** | éƒ¨ç½²ä¸æ–‡æ¡£ | 2å¤© | P5 | ç”¨æˆ·æ‰‹å†Œã€è¿ç»´æ–‡æ¡£ |

**æ€»è®¡**: 24-31å¤©ï¼ˆçº¦4-5å‘¨ï¼‰

### 1.2 é‡Œç¨‹ç¢‘å®šä¹‰

| é‡Œç¨‹ç¢‘ | æ ‡å‡† | éªŒæ”¶æ¡ä»¶ |
|--------|------|---------|
| **M1: æ•°æ®å±‚å®Œæˆ** | P1ç»“æŸ | æ‰€æœ‰è¡¨åˆ›å»ºã€è¿ç§»è„šæœ¬é€šè¿‡ |
| **M2: è´­ä¹°åŠŸèƒ½å¯ç”¨** | P2ç»“æŸ | å¯è´­ä¹°é‡‘å¸å•†å“ã€åº“å­˜æ‰£å‡æ­£ç¡® |
| **M3: å¤šè´§å¸æ”¯æŒ** | P3ç»“æŸ | æ”¯æŒå£°æœ›/è£èª‰è´­ä¹° |
| **M4: å‰ç«¯å¯ç”¨** | P4ç»“æŸ | ç”¨æˆ·å¯é€šè¿‡UIå®Œæˆè´­ä¹° |
| **M5: ç³»ç»Ÿä¸Šçº¿** | P6ç»“æŸ | ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ |

### 1.3 é£é™©ä¸ç¼“è§£ç­–ç•¥

| é£é™©é¡¹ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|------|------|---------|
| æ¡ä»¶DSLå¤æ‚åº¦é«˜ | ä¸­ | é«˜ | Phase 3ä¼˜å…ˆå®ç°ç®€å•æ¡ä»¶ï¼Œå¤æ‚æ¡ä»¶å»¶å |
| å¹¶å‘è´­ä¹°å†²çª | é«˜ | ä¸­ | ä½¿ç”¨ä¹è§‚é” + é‡è¯•æœºåˆ¶ |
| æ€§èƒ½é—®é¢˜ï¼ˆå•†å“å¤šï¼‰ | ä¸­ | ä¸­ | åˆ†é¡µåŠ è½½ + ç¼“å­˜çƒ­é—¨å•†åº— |
| å‰åç«¯è”è°ƒå»¶è¿Ÿ | ä½ | ä½ | APIä¼˜å…ˆå¼€å‘ï¼Œæä¾›Mockæ•°æ® |

---

## 2. Phase 1: åŸºç¡€æ¶æ„æ­å»º

### 2.1 é¢†åŸŸæ¨¡å‹å®ç°

#### ä»»åŠ¡æ¸…å•

- [x] 2.1.1 åˆ›å»º Domain/Shop ç›®å½•ç»“æ„
- [ ] 2.1.2 å®ç° ShopDefinition å®ä½“
- [ ] 2.1.3 å®ç° ShopInstance èšåˆæ ¹
- [ ] 2.1.4 å®ç° ShopItemInstance å€¼å¯¹è±¡
- [ ] 2.1.5 å®ç° CurrencyCost å€¼å¯¹è±¡
- [ ] 2.1.6 å®ç° PurchaseLimit å®ä½“
- [ ] 2.1.7 å®ç°æšä¸¾ç±»å‹ï¼ˆShopType, ItemType, CurrencyTypeç­‰ï¼‰
- [ ] 2.1.8 ç¼–å†™é¢†åŸŸæ¨¡å‹å•å…ƒæµ‹è¯•

#### 2.1.1 ç›®å½•ç»“æ„åˆ›å»º

```bash
mkdir -p BlazorIdle.Server/Domain/Shop/Models
mkdir -p BlazorIdle.Server/Domain/Shop/Services
mkdir -p BlazorIdle.Server/Domain/Shop/Events
mkdir -p BlazorIdle.Server/Domain/Shop/ValueObjects
mkdir -p BlazorIdle.Server/Domain/Shop/Repositories
```

#### 2.1.2 ShopDefinition å®ä½“å®ç°

**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Shop/Models/ShopDefinition.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

/// <summary>
/// å•†åº—å®šä¹‰ - é™æ€é…ç½®å®ä½“
/// </summary>
public class ShopDefinition
{
    public string Id { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public ShopType ShopType { get; set; }
    public string Icon { get; set; } = string.Empty;
    
    // è§£é”æ¡ä»¶
    public string? UnlockConditionExpr { get; set; }
    
    // åˆ·æ–°è§„åˆ™
    public RefreshInterval RefreshInterval { get; set; }
    public bool AllowManualRefresh { get; set; }
    public int? ManualRefreshCost { get; set; }
    
    // æ’åºä¸æ˜¾ç¤º
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
    public string TagsJson { get; set; } = "[]"; // JSONåºåˆ—åŒ–çš„æ ‡ç­¾
    
    // æ—¶é—´æˆ³
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // å¯¼èˆªå±æ€§
    public List<ShopItemDefinition> ItemDefinitions { get; set; } = new();
    
    // è¾…åŠ©æ–¹æ³•
    public List<string> GetTags() => 
        System.Text.Json.JsonSerializer.Deserialize<List<string>>(TagsJson) ?? new();
        
    public void SetTags(List<string> tags) => 
        TagsJson = System.Text.Json.JsonSerializer.Serialize(tags);
}
```

#### 2.1.3 ShopInstance èšåˆæ ¹å®ç°

**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Shop/Models/ShopInstance.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

/// <summary>
/// å•†åº—å®ä¾‹ - è¿è¡Œæ—¶èšåˆæ ¹
/// </summary>
public class ShopInstance
{
    public Guid Id { get; private set; }
    public string ShopDefinitionId { get; private set; }
    
    // åˆ·æ–°çŠ¶æ€
    public DateTime LastRefreshTime { get; private set; }
    public DateTime? NextRefreshTime { get; private set; }
    public int RefreshCount { get; private set; }
    
    // ç‰ˆæœ¬æ§åˆ¶ï¼ˆä¹è§‚é”ï¼‰
    public int Version { get; private set; }
    
    // æ—¶é—´æˆ³
    public DateTime CreatedAt { get; private set; }
    public DateTime UpdatedAt { get; private set; }
    
    // å¯¼èˆªå±æ€§
    public ShopDefinition Definition { get; set; } = null!;
    private readonly List<ShopItemStock> _itemStocks = new();
    public IReadOnlyList<ShopItemStock> ItemStocks => _itemStocks.AsReadOnly();
    
    // é¢†åŸŸäº‹ä»¶
    private readonly List<IDomainEvent> _domainEvents = new();
    public IReadOnlyList<IDomainEvent> DomainEvents => _domainEvents.AsReadOnly();
    
    // æ„é€ å‡½æ•°
    private ShopInstance() { } // EF Core
    
    public ShopInstance(string shopDefinitionId)
    {
        Id = Guid.NewGuid();
        ShopDefinitionId = shopDefinitionId;
        LastRefreshTime = DateTime.UtcNow;
        CreatedAt = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
        Version = 1;
    }
    
    /// <summary>
    /// æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
    /// </summary>
    public bool NeedsRefresh(DateTime currentTime)
    {
        if (NextRefreshTime == null) return false;
        return currentTime >= NextRefreshTime.Value;
    }
    
    /// <summary>
    /// æ‰§è¡Œåˆ·æ–°
    /// </summary>
    public void Refresh(DateTime refreshTime, List<ShopItemStock> newStocks)
    {
        LastRefreshTime = refreshTime;
        NextRefreshTime = CalculateNextRefreshTime(refreshTime);
        RefreshCount++;
        UpdatedAt = refreshTime;
        Version++;
        
        _itemStocks.Clear();
        _itemStocks.AddRange(newStocks);
        
        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        _domainEvents.Add(new ShopRefreshedEvent
        {
            ShopInstanceId = Id,
            ShopDefinitionId = ShopDefinitionId,
            RefreshTime = refreshTime,
            NewItemCount = newStocks.Count
        });
    }
    
    /// <summary>
    /// æ‰£å‡å•†å“åº“å­˜
    /// </summary>
    public bool TryDeductStock(string shopItemId, int quantity)
    {
        var stock = _itemStocks.FirstOrDefault(s => s.ShopItemId == shopItemId);
        if (stock == null) return false;
        
        return stock.TryDeduct(quantity);
    }
    
    /// <summary>
    /// è®¡ç®—ä¸‹æ¬¡åˆ·æ–°æ—¶é—´
    /// </summary>
    private DateTime? CalculateNextRefreshTime(DateTime from)
    {
        // å°†åœ¨DefinitionåŠ è½½åè®¡ç®—
        return null; // å ä½å®ç°
    }
    
    public void ClearDomainEvents() => _domainEvents.Clear();
}
```

#### 2.1.4 ShopItemDefinition å®ä½“

**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Shop/Models/ShopItemDefinition.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

/// <summary>
/// å•†å“å®šä¹‰ - é…ç½®å®ä½“
/// </summary>
public class ShopItemDefinition
{
    public string Id { get; set; } = string.Empty; // shopItemId
    public string ShopDefinitionId { get; set; } = string.Empty;
    
    // ç‰©å“ä¿¡æ¯
    public ItemType ItemType { get; set; }
    public string ItemId { get; set; } = string.Empty;
    public string? ItemName { get; set; } // å†—ä½™å­—æ®µï¼Œæ–¹ä¾¿æŸ¥è¯¢
    
    // ä»·æ ¼ä¿¡æ¯ï¼ˆJSONåºåˆ—åŒ–ï¼‰
    public string PricesJson { get; set; } = "[]";
    
    // åº“å­˜é…ç½®
    public StockPolicy StockPolicy { get; set; }
    public int? MaxStock { get; set; }
    public int? RefreshStock { get; set; } // åˆ·æ–°æ—¶è¡¥å……çš„åº“å­˜æ•°
    
    // é™è´­é…ç½®ï¼ˆJSONåºåˆ—åŒ–ï¼‰
    public string PurchaseLimitsJson { get; set; } = "[]";
    
    // è§£é”ä¸å¯è§æ€§
    public string? UnlockConditionExpr { get; set; }
    public bool ShowWhenLocked { get; set; } // æœªè§£é”æ—¶æ˜¯å¦æ˜¾ç¤ºï¼ˆç°æ˜¾ï¼‰
    
    // æ˜¾ç¤ºé¡ºåº
    public int DisplayOrder { get; set; }
    public bool IsActive { get; set; }
    
    // æ—¶é—´æˆ³
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // å¯¼èˆªå±æ€§
    public ShopDefinition ShopDefinition { get; set; } = null!;
    
    // è¾…åŠ©æ–¹æ³•
    public List<CurrencyCost> GetPrices() =>
        System.Text.Json.JsonSerializer.Deserialize<List<CurrencyCost>>(PricesJson) ?? new();
        
    public void SetPrices(List<CurrencyCost> prices) =>
        PricesJson = System.Text.Json.JsonSerializer.Serialize(prices);
        
    public List<PurchaseLimitConfig> GetPurchaseLimits() =>
        System.Text.Json.JsonSerializer.Deserialize<List<PurchaseLimitConfig>>(PurchaseLimitsJson) ?? new();
        
    public void SetPurchaseLimits(List<PurchaseLimitConfig> limits) =>
        PurchaseLimitsJson = System.Text.Json.JsonSerializer.Serialize(limits);
}
```

#### 2.1.5 ShopItemStock å®ä½“ï¼ˆè¿è¡Œæ—¶åº“å­˜ï¼‰

**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Shop/Models/ShopItemStock.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Models;

/// <summary>
/// å•†å“åº“å­˜ - è¿è¡Œæ—¶çŠ¶æ€
/// </summary>
public class ShopItemStock
{
    public Guid Id { get; private set; }
    public Guid ShopInstanceId { get; private set; }
    public string ShopItemId { get; private set; }
    
    public int? CurrentStock { get; private set; } // nullè¡¨ç¤ºæ— é™
    public int? MaxStock { get; private set; }
    
    public DateTime LastRestockTime { get; private set; }
    public DateTime UpdatedAt { get; private set; }
    
    // å¯¼èˆªå±æ€§
    public ShopInstance ShopInstance { get; set; } = null!;
    
    // æ„é€ å‡½æ•°
    private ShopItemStock() { } // EF Core
    
    public ShopItemStock(
        Guid shopInstanceId, 
        string shopItemId, 
        int? maxStock,
        int? initialStock)
    {
        Id = Guid.NewGuid();
        ShopInstanceId = shopInstanceId;
        ShopItemId = shopItemId;
        MaxStock = maxStock;
        CurrentStock = initialStock;
        LastRestockTime = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
    }
    
    /// <summary>
    /// å°è¯•æ‰£å‡åº“å­˜
    /// </summary>
    public bool TryDeduct(int quantity)
    {
        // æ— é™åº“å­˜
        if (CurrentStock == null)
            return true;
            
        // åº“å­˜ä¸è¶³
        if (CurrentStock < quantity)
            return false;
            
        CurrentStock -= quantity;
        UpdatedAt = DateTime.UtcNow;
        return true;
    }
    
    /// <summary>
    /// è¡¥å……åº“å­˜åˆ°æœ€å¤§å€¼
    /// </summary>
    public void RestockToMax()
    {
        if (MaxStock.HasValue)
        {
            CurrentStock = MaxStock.Value;
            LastRestockTime = DateTime.UtcNow;
            UpdatedAt = DateTime.UtcNow;
        }
    }
    
    /// <summary>
    /// è®¾ç½®åº“å­˜
    /// </summary>
    public void SetStock(int? stock)
    {
        CurrentStock = stock;
        UpdatedAt = DateTime.UtcNow;
    }
}
```

### 2.2 ä»“å‚¨æ¥å£å®šä¹‰

#### 2.2.1 IShopRepository æ¥å£

**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Shop/Repositories/IShopRepository.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Repositories;

public interface IShopRepository
{
    // å•†åº—å®šä¹‰æŸ¥è¯¢
    Task<ShopDefinition?> GetShopDefinitionAsync(
        string shopId, 
        CancellationToken ct = default);
        
    Task<List<ShopDefinition>> GetAllActiveShopDefinitionsAsync(
        CancellationToken ct = default);
        
    Task<List<ShopDefinition>> GetShopDefinitionsByTypeAsync(
        ShopType shopType, 
        CancellationToken ct = default);
    
    // å•†åº—å®ä¾‹æŸ¥è¯¢
    Task<ShopInstance?> GetShopInstanceAsync(
        Guid instanceId, 
        CancellationToken ct = default);
        
    Task<ShopInstance?> GetOrCreateShopInstanceAsync(
        string shopDefinitionId, 
        CancellationToken ct = default);
        
    Task<List<ShopInstance>> GetShopInstancesNeedingRefreshAsync(
        DateTime currentTime, 
        CancellationToken ct = default);
    
    // å•†å“å®šä¹‰æŸ¥è¯¢
    Task<ShopItemDefinition?> GetShopItemDefinitionAsync(
        string shopItemId, 
        CancellationToken ct = default);
        
    Task<List<ShopItemDefinition>> GetShopItemDefinitionsByShopAsync(
        string shopDefinitionId, 
        CancellationToken ct = default);
    
    // æŒä¹…åŒ–
    Task<ShopInstance> SaveShopInstanceAsync(
        ShopInstance instance, 
        CancellationToken ct = default);
        
    Task SaveShopDefinitionAsync(
        ShopDefinition definition, 
        CancellationToken ct = default);
}
```

#### 2.2.2 IPurchaseHistoryRepository æ¥å£

**æ–‡ä»¶**: `BlazorIdle.Server/Domain/Shop/Repositories/IPurchaseHistoryRepository.cs`

```csharp
namespace BlazorIdle.Server.Domain.Shop.Repositories;

public interface IPurchaseHistoryRepository
{
    // æŸ¥è¯¢è´­ä¹°å†å²
    Task<PurchaseRecord?> GetPurchaseRecordAsync(
        Guid transactionId, 
        CancellationToken ct = default);
        
    Task<List<PurchaseRecord>> GetCharacterPurchaseHistoryAsync(
        Guid characterId, 
        DateTime? startDate = null,
        DateTime? endDate = null,
        int page = 1, 
        int pageSize = 50,
        CancellationToken ct = default);
    
    // æŸ¥è¯¢é™è´­çŠ¶æ€
    Task<CharacterPurchaseRecord?> GetCharacterPurchaseRecordAsync(
        Guid characterId, 
        string shopItemId,
        CancellationToken ct = default);
        
    Task<Dictionary<string, CharacterPurchaseRecord>> GetCharacterPurchaseRecordsAsync(
        Guid characterId, 
        List<string> shopItemIds,
        CancellationToken ct = default);
    
    // è®°å½•è´­ä¹°
    Task<PurchaseRecord> RecordPurchaseAsync(
        PurchaseRecord record, 
        CancellationToken ct = default);
        
    Task UpdateCharacterPurchaseRecordAsync(
        CharacterPurchaseRecord record,
        CancellationToken ct = default);
    
    // é‡ç½®é™è´­è®¡æ•°
    Task ResetDailyPurchasesAsync(
        DateTime resetTime, 
        CancellationToken ct = default);
        
    Task ResetWeeklyPurchasesAsync(
        DateTime resetTime, 
        CancellationToken ct = default);
}
```

### 2.3 æ•°æ®åº“è¿ç§»

#### 2.3.1 Entity Configuration

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Persistence/Configurations/ShopDefinitionConfiguration.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using BlazorIdle.Server.Domain.Shop.Models;

namespace BlazorIdle.Server.Infrastructure.Persistence.Configurations;

public class ShopDefinitionConfiguration : IEntityTypeConfiguration<ShopDefinition>
{
    public void Configure(EntityTypeBuilder<ShopDefinition> builder)
    {
        builder.ToTable("ShopDefinitions");
        
        builder.HasKey(s => s.Id);
        builder.Property(s => s.Id).HasMaxLength(100);
        
        builder.Property(s => s.Name).IsRequired().HasMaxLength(200);
        builder.Property(s => s.Description).HasMaxLength(1000);
        builder.Property(s => s.Icon).HasMaxLength(200);
        
        builder.Property(s => s.ShopType).IsRequired();
        builder.Property(s => s.RefreshInterval).IsRequired();
        
        builder.Property(s => s.UnlockConditionExpr).HasMaxLength(500);
        builder.Property(s => s.TagsJson).HasMaxLength(1000).HasDefaultValue("[]");
        
        builder.Property(s => s.SortOrder).HasDefaultValue(0);
        builder.Property(s => s.IsActive).HasDefaultValue(true);
        
        builder.Property(s => s.CreatedAt).HasDefaultValueSql("CURRENT_TIMESTAMP");
        builder.Property(s => s.UpdatedAt).HasDefaultValueSql("CURRENT_TIMESTAMP");
        
        // ç´¢å¼•
        builder.HasIndex(s => s.ShopType);
        builder.HasIndex(s => s.IsActive);
        builder.HasIndex(s => s.SortOrder);
        
        // å…³ç³»
        builder.HasMany(s => s.ItemDefinitions)
            .WithOne(i => i.ShopDefinition)
            .HasForeignKey(i => i.ShopDefinitionId)
            .OnDelete(DeleteBehavior.Cascade);
    }
}
```

#### 2.3.2 åˆ›å»ºè¿ç§»è„šæœ¬

```bash
cd BlazorIdle.Server
dotnet ef migrations add AddShopSystem --context GameDbContext
dotnet ef database update
```

#### 2.3.3 åˆå§‹æ•°æ®ç§å­

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Persistence/Seeds/ShopSeeds.cs`

```csharp
using BlazorIdle.Server.Domain.Shop.Models;

namespace BlazorIdle.Server.Infrastructure.Persistence.Seeds;

public static class ShopSeeds
{
    public static List<ShopDefinition> GetDefaultShops()
    {
        return new List<ShopDefinition>
        {
            // æ™®é€šå•†åº—
            new ShopDefinition
            {
                Id = "shop_general_town",
                Name = "åŸé•‡æ‚è´§é“º",
                Description = "å‡ºå”®æ—¥å¸¸æ¶ˆè€—å“å’ŒåŸºç¡€è£…å¤‡",
                ShopType = ShopType.General,
                Icon = "shop_general.png",
                UnlockConditionExpr = null,
                RefreshInterval = RefreshInterval.Never,
                AllowManualRefresh = false,
                SortOrder = 1,
                IsActive = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow,
                ItemDefinitions = new List<ShopItemDefinition>
                {
                    new ShopItemDefinition
                    {
                        Id = "item_bread",
                        ShopDefinitionId = "shop_general_town",
                        ItemType = ItemType.Consumable,
                        ItemId = "consumable_bread",
                        ItemName = "é¢åŒ…",
                        PricesJson = "[{\"CurrencyType\":0,\"Amount\":5}]", // Gold:5
                        StockPolicy = StockPolicy.Infinite,
                        MaxStock = null,
                        PurchaseLimitsJson = "[]",
                        UnlockConditionExpr = null,
                        ShowWhenLocked = true,
                        DisplayOrder = 1,
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow,
                        UpdatedAt = DateTime.UtcNow
                    },
                    new ShopItemDefinition
                    {
                        Id = "item_health_potion_minor",
                        ShopDefinitionId = "shop_general_town",
                        ItemType = ItemType.Consumable,
                        ItemId = "potion_health_minor",
                        ItemName = "ç”Ÿå‘½è¯æ°´ï¼ˆå°ï¼‰",
                        PricesJson = "[{\"CurrencyType\":0,\"Amount\":20}]",
                        StockPolicy = StockPolicy.Infinite,
                        DisplayOrder = 2,
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow,
                        UpdatedAt = DateTime.UtcNow
                    }
                }
            },
            
            // è£…å¤‡å•†åº—
            new ShopDefinition
            {
                Id = "shop_equipment_blacksmith",
                Name = "é“åŒ é“º",
                Description = "å‡ºå”®ç²¾è‰¯è£…å¤‡ï¼Œæ¯æ—¥æ›´æ–°åº“å­˜",
                ShopType = ShopType.Equipment,
                Icon = "shop_blacksmith.png",
                UnlockConditionExpr = "level>=10",
                RefreshInterval = RefreshInterval.Daily,
                AllowManualRefresh = true,
                ManualRefreshCost = 50,
                SortOrder = 2,
                IsActive = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            }
        };
    }
}
```

---

## 3. Phase 2: æ ¸å¿ƒåŠŸèƒ½å®ç°

### 3.1 è´­ä¹°æœåŠ¡å®ç°

#### ä»»åŠ¡æ¸…å•

- [ ] 3.1.1 å®ç° PurchaseValidatorï¼ˆè´­ä¹°éªŒè¯å™¨ï¼‰
- [ ] 3.1.2 å®ç° PurchaseServiceï¼ˆè´­ä¹°æœåŠ¡ï¼‰
- [ ] 3.1.3 å®ç° TransactionLoggerï¼ˆäº¤æ˜“æ—¥å¿—ï¼‰
- [ ] 3.1.4 å®ç°å¹‚ç­‰æ€§ä¿è¯æœºåˆ¶
- [ ] 3.1.5 ç¼–å†™è´­ä¹°æµç¨‹å•å…ƒæµ‹è¯•
- [ ] 3.1.6 ç¼–å†™é›†æˆæµ‹è¯•

#### 3.1.1 PurchaseValidator å®ç°

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/Validators/PurchaseValidator.cs`

```csharp
namespace BlazorIdle.Server.Application.Shop.Validators;

/// <summary>
/// è´­ä¹°éªŒè¯å™¨
/// </summary>
public class PurchaseValidator : IPurchaseValidator
{
    private readonly ICharacterRepository _characterRepo;
    private readonly IShopRepository _shopRepo;
    private readonly IPurchaseHistoryRepository _purchaseHistoryRepo;
    private readonly ICurrencyExchanger _currencyExchanger;
    private readonly IConditionEvaluator _conditionEvaluator;
    private readonly ILogger<PurchaseValidator> _logger;
    
    public PurchaseValidator(
        ICharacterRepository characterRepo,
        IShopRepository shopRepo,
        IPurchaseHistoryRepository purchaseHistoryRepo,
        ICurrencyExchanger currencyExchanger,
        IConditionEvaluator conditionEvaluator,
        ILogger<PurchaseValidator> logger)
    {
        _characterRepo = characterRepo;
        _shopRepo = shopRepo;
        _purchaseHistoryRepo = purchaseHistoryRepo;
        _currencyExchanger = currencyExchanger;
        _conditionEvaluator = conditionEvaluator;
        _logger = logger;
    }
    
    public async Task<ValidationResult> ValidateAsync(
        PurchaseRequest request,
        CancellationToken ct = default)
    {
        // 1. éªŒè¯è§’è‰²å­˜åœ¨
        var character = await _characterRepo.GetByIdAsync(request.CharacterId, ct);
        if (character == null)
            return ValidationResult.Fail("è§’è‰²ä¸å­˜åœ¨");
        
        // 2. éªŒè¯å•†åº—å­˜åœ¨
        var shopInstance = await _shopRepo.GetShopInstanceAsync(request.ShopInstanceId, ct);
        if (shopInstance == null)
            return ValidationResult.Fail("å•†åº—ä¸å­˜åœ¨");
        
        // 3. éªŒè¯å•†å“å­˜åœ¨
        var itemDef = await _shopRepo.GetShopItemDefinitionAsync(request.ShopItemId, ct);
        if (itemDef == null || !itemDef.IsActive)
            return ValidationResult.Fail("å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶");
        
        // 4. éªŒè¯å•†å“è§£é”æ¡ä»¶
        if (!string.IsNullOrEmpty(itemDef.UnlockConditionExpr))
        {
            var isUnlocked = await _conditionEvaluator.EvaluateAsync(
                itemDef.UnlockConditionExpr, 
                request.CharacterId, 
                ct);
                
            if (!isUnlocked)
                return ValidationResult.Fail("å•†å“æœªè§£é”");
        }
        
        // 5. éªŒè¯è´­ä¹°æ•°é‡
        if (request.Quantity <= 0)
            return ValidationResult.Fail("è´­ä¹°æ•°é‡å¿…é¡»å¤§äº0");
            
        if (request.Quantity > 999) // å•æ¬¡æœ€å¤§è´­ä¹°æ•°é‡
            return ValidationResult.Fail("å•æ¬¡è´­ä¹°æ•°é‡ä¸èƒ½è¶…è¿‡999");
        
        // 6. éªŒè¯åº“å­˜
        var stock = shopInstance.ItemStocks.FirstOrDefault(s => s.ShopItemId == request.ShopItemId);
        if (stock?.CurrentStock != null && stock.CurrentStock < request.Quantity)
            return ValidationResult.Fail($"åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š{stock.CurrentStock}");
        
        // 7. éªŒè¯é™è´­
        var purchaseRecord = await _purchaseHistoryRepo.GetCharacterPurchaseRecordAsync(
            request.CharacterId, 
            request.ShopItemId, 
            ct);
            
        var limits = itemDef.GetPurchaseLimits();
        foreach (var limit in limits)
        {
            if (purchaseRecord != null && purchaseRecord.IsLimitExceeded(limit, request.Quantity))
            {
                var limitDesc = limit.LimitType switch
                {
                    LimitType.PerDay => "æ¯æ—¥",
                    LimitType.PerWeek => "æ¯å‘¨",
                    LimitType.PerMonth => "æ¯æœˆ",
                    LimitType.Lifetime => "ç»ˆèº«",
                    _ => ""
                };
                return ValidationResult.Fail($"è¶…å‡º{limitDesc}é™è´­æ•°é‡ï¼ˆä¸Šé™ï¼š{limit.MaxQuantity}ï¼‰");
            }
        }
        
        // 8. éªŒè¯è´§å¸å……è¶³
        var prices = itemDef.GetPrices();
        var totalCosts = prices.Select(p => new CurrencyCost
        {
            CurrencyType = p.CurrencyType,
            CurrencyId = p.CurrencyId,
            Amount = p.Amount * request.Quantity
        }).ToList();
        
        var hasEnough = await _currencyExchanger.HasEnoughCurrency(
            request.CharacterId, 
            totalCosts, 
            ct);
            
        if (!hasEnough)
            return ValidationResult.Fail("è´§å¸ä¸è¶³");
        
        // 9. éªŒè¯èƒŒåŒ…ç©ºé—´ï¼ˆæ¶ˆè€—å“éœ€è¦èƒŒåŒ…ç©ºé—´ï¼‰
        if (itemDef.ItemType == ItemType.Consumable || itemDef.ItemType == ItemType.Material)
        {
            // TODO: å®ç°èƒŒåŒ…å®¹é‡æ£€æŸ¥
            // var hasSpace = await _inventoryService.HasSpaceAsync(request.CharacterId, ct);
            // if (!hasSpace) return ValidationResult.Fail("èƒŒåŒ…å·²æ»¡");
        }
        
        return ValidationResult.Success();
    }
}

/// <summary>
/// éªŒè¯ç»“æœ
/// </summary>
public class ValidationResult
{
    public bool IsSuccess { get; set; }
    public string? ErrorMessage { get; set; }
    
    public static ValidationResult Success() => new() { IsSuccess = true };
    public static ValidationResult Fail(string message) => new() { IsSuccess = false, ErrorMessage = message };
}

/// <summary>
/// è´­ä¹°è¯·æ±‚
/// </summary>
public class PurchaseRequest
{
    public Guid CharacterId { get; set; }
    public Guid ShopInstanceId { get; set; }
    public string ShopItemId { get; set; } = string.Empty;
    public int Quantity { get; set; }
    public string TransactionId { get; set; } = string.Empty; // å¹‚ç­‰æ€§é”®
}
```

#### 3.1.2 PurchaseService å®ç°

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/Services/PurchaseService.cs`

```csharp
namespace BlazorIdle.Server.Application.Shop.Services;

/// <summary>
/// è´­ä¹°æœåŠ¡
/// </summary>
public class PurchaseService : IPurchaseService
{
    private readonly IShopRepository _shopRepo;
    private readonly IPurchaseHistoryRepository _purchaseHistoryRepo;
    private readonly IPurchaseValidator _validator;
    private readonly ICurrencyExchanger _currencyExchanger;
    private readonly IRewardGrantService _rewardGrantService;
    private readonly ILogger<PurchaseService> _logger;
    private readonly GameDbContext _dbContext;
    
    public async Task<PurchaseResult> PurchaseAsync(
        PurchaseRequest request,
        CancellationToken ct = default)
    {
        // å¹‚ç­‰æ€§æ£€æŸ¥
        var existingRecord = await _purchaseHistoryRepo.GetPurchaseRecordAsync(
            Guid.Parse(request.TransactionId), 
            ct);
            
        if (existingRecord != null)
        {
            _logger.LogInformation("Purchase already processed: {TransactionId}", request.TransactionId);
            return PurchaseResult.AlreadyProcessed(existingRecord);
        }
        
        // éªŒè¯è´­ä¹°æ¡ä»¶
        var validationResult = await _validator.ValidateAsync(request, ct);
        if (!validationResult.IsSuccess)
        {
            return PurchaseResult.Fail(validationResult.ErrorMessage!);
        }
        
        // å¼€å§‹äº‹åŠ¡
        await using var transaction = await _dbContext.Database.BeginTransactionAsync(ct);
        try
        {
            // 1. è·å–å•†åº—å®ä¾‹å’Œå•†å“å®šä¹‰
            var shopInstance = await _shopRepo.GetShopInstanceAsync(request.ShopInstanceId, ct);
            var itemDef = await _shopRepo.GetShopItemDefinitionAsync(request.ShopItemId, ct);
            
            // 2. æ‰£é™¤è´§å¸
            var prices = itemDef!.GetPrices();
            var totalCosts = prices.Select(p => new CurrencyCost
            {
                CurrencyType = p.CurrencyType,
                CurrencyId = p.CurrencyId,
                Amount = p.Amount * request.Quantity
            }).ToList();
            
            var deductResult = await _currencyExchanger.DeductCurrency(
                request.CharacterId, 
                totalCosts, 
                $"Purchase:{request.ShopItemId}:{request.Quantity}",
                ct);
                
            if (!deductResult.Success)
            {
                await transaction.RollbackAsync(ct);
                return PurchaseResult.Fail(deductResult.ErrorMessage!);
            }
            
            // 3. æ‰£å‡åº“å­˜
            if (!shopInstance!.TryDeductStock(request.ShopItemId, request.Quantity))
            {
                await transaction.RollbackAsync(ct);
                return PurchaseResult.Fail("åº“å­˜ä¸è¶³");
            }
            
            // 4. å‘æ”¾ç‰©å“
            var grantSuccess = await GrantItemAsync(
                request.CharacterId, 
                itemDef, 
                request.Quantity, 
                request.TransactionId,
                ct);
                
            if (!grantSuccess)
            {
                await transaction.RollbackAsync(ct);
                return PurchaseResult.Fail("ç‰©å“å‘æ”¾å¤±è´¥");
            }
            
            // 5. è®°å½•è´­ä¹°å†å²
            var purchaseRecord = new PurchaseRecord
            {
                Id = Guid.Parse(request.TransactionId),
                CharacterId = request.CharacterId,
                ShopItemId = request.ShopItemId,
                ItemType = itemDef.ItemType,
                ItemId = itemDef.ItemId,
                Quantity = request.Quantity,
                TotalCostJson = System.Text.Json.JsonSerializer.Serialize(totalCosts),
                PurchaseTime = DateTime.UtcNow
            };
            
            await _purchaseHistoryRepo.RecordPurchaseAsync(purchaseRecord, ct);
            
            // 6. æ›´æ–°è§’è‰²é™è´­è®°å½•
            await UpdatePurchaseLimitRecordAsync(
                request.CharacterId, 
                request.ShopItemId, 
                request.Quantity,
                ct);
            
            // 7. ä¿å­˜å•†åº—å®ä¾‹ï¼ˆåº“å­˜å˜æ›´ï¼‰
            await _shopRepo.SaveShopInstanceAsync(shopInstance, ct);
            
            // æäº¤äº‹åŠ¡
            await transaction.CommitAsync(ct);
            
            // 8. å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼ˆäº‹åŠ¡å¤–ï¼‰
            PublishPurchaseCompletedEvent(request, itemDef, totalCosts);
            
            _logger.LogInformation(
                "Purchase completed: CharacterId={CharacterId}, Item={ItemId}, Qty={Quantity}",
                request.CharacterId, itemDef.ItemId, request.Quantity);
            
            return PurchaseResult.Success(purchaseRecord, deductResult.RemainingBalances);
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync(ct);
            _logger.LogError(ex, "Purchase failed: {TransactionId}", request.TransactionId);
            return PurchaseResult.Fail($"è´­ä¹°å¤±è´¥ï¼š{ex.Message}");
        }
    }
    
    private async Task<bool> GrantItemAsync(
        Guid characterId,
        ShopItemDefinition itemDef,
        int quantity,
        string transactionId,
        CancellationToken ct)
    {
        switch (itemDef.ItemType)
        {
            case ItemType.Consumable:
            case ItemType.Material:
                // ä½¿ç”¨RewardGrantServiceå‘æ”¾ç‰©å“åˆ°èƒŒåŒ…
                return await _rewardGrantService.GrantRewardsAsync(
                    characterId,
                    gold: 0,
                    exp: 0,
                    items: new Dictionary<string, int> { [itemDef.ItemId] = quantity },
                    idempotencyKey: transactionId,
                    eventType: "ShopPurchase",
                    ct: ct);
                    
            case ItemType.Equipment:
                // è£…å¤‡éœ€è¦ç”Ÿæˆå®ä¾‹ï¼ˆå¾…å®ç°ï¼‰
                // TODO: è°ƒç”¨ GearGenerationService
                return true;
                
            case ItemType.Recipe:
                // é…æ–¹ç›´æ¥è§£é”ï¼ˆå¾…å®ç°ï¼‰
                return true;
                
            default:
                return false;
        }
    }
    
    private async Task UpdatePurchaseLimitRecordAsync(
        Guid characterId,
        string shopItemId,
        int quantity,
        CancellationToken ct)
    {
        var record = await _purchaseHistoryRepo.GetCharacterPurchaseRecordAsync(
            characterId, 
            shopItemId, 
            ct);
            
        if (record == null)
        {
            record = new CharacterPurchaseRecord
            {
                Id = Guid.NewGuid(),
                CharacterId = characterId,
                ShopItemId = shopItemId,
                LastDailyReset = DateTime.UtcNow.Date,
                LastWeeklyReset = DateTime.UtcNow.Date,
                LastMonthlyReset = DateTime.UtcNow.Date
            };
        }
        
        record.RecordPurchase(quantity, DateTime.UtcNow);
        await _purchaseHistoryRepo.UpdateCharacterPurchaseRecordAsync(record, ct);
    }
    
    private void PublishPurchaseCompletedEvent(
        PurchaseRequest request,
        ShopItemDefinition itemDef,
        List<CurrencyCost> costs)
    {
        // TODO: å®ç°é¢†åŸŸäº‹ä»¶å‘å¸ƒ
        // _eventBus.Publish(new PurchaseCompletedEvent { ... });
    }
}
```

### 3.2 å•†åº—åˆ·æ–°æœåŠ¡

#### ä»»åŠ¡æ¸…å•

- [ ] 3.2.1 å®ç° ShopRefreshService
- [ ] 3.2.2 å®ç°å®šæ—¶ä»»åŠ¡ï¼ˆHosted Serviceï¼‰
- [ ] 3.2.3 å®ç°æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
- [ ] 3.2.4 ç¼–å†™åˆ·æ–°é€»è¾‘æµ‹è¯•

#### 3.2.1 ShopRefreshService å®ç°

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Shop/Services/ShopRefreshService.cs`

```csharp
namespace BlazorIdle.Server.Application.Shop.Services;

/// <summary>
/// å•†åº—åˆ·æ–°æœåŠ¡
/// </summary>
public class ShopRefreshService : IShopRefreshService
{
    private readonly IShopRepository _shopRepo;
    private readonly ILogger<ShopRefreshService> _logger;
    
    public async Task<RefreshResult> RefreshShopAsync(
        string shopDefinitionId,
        CancellationToken ct = default)
    {
        var shopInstance = await _shopRepo.GetOrCreateShopInstanceAsync(shopDefinitionId, ct);
        var definition = await _shopRepo.GetShopDefinitionAsync(shopDefinitionId, ct);
        
        if (definition == null)
            return RefreshResult.Fail("å•†åº—å®šä¹‰ä¸å­˜åœ¨");
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
        if (!shopInstance.NeedsRefresh(DateTime.UtcNow) && definition.RefreshInterval != RefreshInterval.Never)
            return RefreshResult.Skip("å•†åº—å°šæœªåˆ°åˆ·æ–°æ—¶é—´");
        
        // ç”Ÿæˆæ–°åº“å­˜
        var newStocks = await GenerateStocksAsync(definition, ct);
        
        // æ‰§è¡Œåˆ·æ–°
        shopInstance.Refresh(DateTime.UtcNow, newStocks);
        
        // ä¿å­˜
        await _shopRepo.SaveShopInstanceAsync(shopInstance, ct);
        
        _logger.LogInformation(
            "Shop refreshed: {ShopId}, ItemCount={Count}", 
            shopDefinitionId, 
            newStocks.Count);
        
        return RefreshResult.Success(shopInstance);
    }
    
    private async Task<List<ShopItemStock>> GenerateStocksAsync(
        ShopDefinition definition,
        CancellationToken ct)
    {
        var stocks = new List<ShopItemStock>();
        
        var itemDefs = await _shopRepo.GetShopItemDefinitionsByShopAsync(definition.Id, ct);
        
        foreach (var itemDef in itemDefs.Where(i => i.IsActive))
        {
            var stock = new ShopItemStock(
                Guid.Empty, // å°†åœ¨ShopInstance.Refreshä¸­è®¾ç½®
                itemDef.Id,
                itemDef.MaxStock,
                itemDef.RefreshStock ?? itemDef.MaxStock);
                
            stocks.Add(stock);
        }
        
        return stocks;
    }
}
```

---

## 4. Phase 3: æ¡ä»¶è§£é”ä¸è´§å¸ç³»ç»Ÿ

### 4.1 æ¡ä»¶è¯„ä¼°å™¨å®ç°

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Unlock/Services/ConditionEvaluator.cs`

```csharp
namespace BlazorIdle.Server.Application.Unlock.Services;

/// <summary>
/// æ¡ä»¶è¯„ä¼°å™¨ - ç®€åŒ–ç‰ˆå®ç°
/// </summary>
public class ConditionEvaluator : IConditionEvaluator
{
    private readonly ICharacterRepository _characterRepo;
    private readonly ILogger<ConditionEvaluator> _logger;
    
    public async Task<bool> EvaluateAsync(
        string conditionExpr,
        Guid characterId,
        CancellationToken ct = default)
    {
        if (string.IsNullOrEmpty(conditionExpr))
            return true;
        
        var context = await BuildContextAsync(characterId, ct);
        
        try
        {
            return EvaluateExpression(conditionExpr, context);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to evaluate condition: {Expr}", conditionExpr);
            return false;
        }
    }
    
    private async Task<ConditionContext> BuildContextAsync(
        Guid characterId,
        CancellationToken ct)
    {
        var character = await _characterRepo.GetByIdAsync(characterId, ct);
        
        return new ConditionContext
        {
            CharacterId = characterId,
            Level = character?.Level ?? 0,
            Gold = character?.Gold ?? 0,
            Profession = character?.ProfessionId ?? "",
            CurrentTime = DateTime.UtcNow
        };
    }
    
    private bool EvaluateExpression(string expr, ConditionContext ctx)
    {
        expr = expr.Trim();
        
        // ç®€å•è§£æï¼šlevel>=10
        if (expr.StartsWith("level>="))
        {
            var value = int.Parse(expr.Substring(7));
            return ctx.Level >= value;
        }
        
        if (expr.StartsWith("level<="))
        {
            var value = int.Parse(expr.Substring(7));
            return ctx.Level <= value;
        }
        
        if (expr.StartsWith("gold>="))
        {
            var value = long.Parse(expr.Substring(6));
            return ctx.Gold >= value;
        }
        
        // ANDé€»è¾‘
        if (expr.StartsWith("AND(") && expr.EndsWith(")"))
        {
            var inner = expr.Substring(4, expr.Length - 5);
            var conditions = SplitConditions(inner);
            return conditions.All(c => EvaluateExpression(c, ctx));
        }
        
        // ORé€»è¾‘
        if (expr.StartsWith("OR(") && expr.EndsWith(")"))
        {
            var inner = expr.Substring(3, expr.Length - 4);
            var conditions = SplitConditions(inner);
            return conditions.Any(c => EvaluateExpression(c, ctx));
        }
        
        // NOTé€»è¾‘
        if (expr.StartsWith("NOT(") && expr.EndsWith(")"))
        {
            var inner = expr.Substring(4, expr.Length - 5);
            return !EvaluateExpression(inner, ctx);
        }
        
        // é»˜è®¤è¿”å›false
        return false;
    }
    
    private List<string> SplitConditions(string expr)
    {
        // ç®€åŒ–å®ç°ï¼šæŒ‰é€—å·åˆ†å‰²ï¼ˆä¸è€ƒè™‘åµŒå¥—æ‹¬å·ï¼‰
        return expr.Split(',').Select(s => s.Trim()).ToList();
    }
}
```

### 4.2 è´§å¸å…‘æ¢å™¨å®ç°

**æ–‡ä»¶**: `BlazorIdle.Server/Application/Economy/Services/CurrencyExchanger.cs`

```csharp
namespace BlazorIdle.Server.Application.Economy.Services;

/// <summary>
/// è´§å¸å…‘æ¢å™¨
/// </summary>
public class CurrencyExchanger : ICurrencyExchanger
{
    private readonly GameDbContext _dbContext;
    private readonly ILogger<CurrencyExchanger> _logger;
    
    public async Task<bool> HasEnoughCurrency(
        Guid characterId,
        List<CurrencyCost> costs,
        CancellationToken ct = default)
    {
        var balances = await GetBalancesAsync(characterId, ct);
        
        foreach (var cost in costs)
        {
            var balance = balances.GetValueOrDefault(cost.CurrencyType, 0);
            if (balance < cost.Amount)
                return false;
        }
        
        return true;
    }
    
    public async Task<CurrencyDeductionResult> DeductCurrency(
        Guid characterId,
        List<CurrencyCost> costs,
        string reason,
        CancellationToken ct = default)
    {
        var character = await _dbContext.Characters.FindAsync(new object[] { characterId }, ct);
        if (character == null)
            return CurrencyDeductionResult.Fail("è§’è‰²ä¸å­˜åœ¨");
        
        var deducted = new Dictionary<CurrencyType, long>();
        
        foreach (var cost in costs)
        {
            switch (cost.CurrencyType)
            {
                case CurrencyType.Gold:
                    if (character.Gold < cost.Amount)
                        return CurrencyDeductionResult.Fail("é‡‘å¸ä¸è¶³");
                    character.Gold -= cost.Amount;
                    deducted[CurrencyType.Gold] = cost.Amount;
                    break;
                    
                // TODO: å®ç°å…¶ä»–è´§å¸ç±»å‹
                default:
                    return CurrencyDeductionResult.Fail($"ä¸æ”¯æŒçš„è´§å¸ç±»å‹ï¼š{cost.CurrencyType}");
            }
        }
        
        await _dbContext.SaveChangesAsync(ct);
        
        var remaining = await GetBalancesAsync(characterId, ct);
        
        return CurrencyDeductionResult.Success(deducted, remaining);
    }
    
    private async Task<Dictionary<CurrencyType, long>> GetBalancesAsync(
        Guid characterId,
        CancellationToken ct)
    {
        var character = await _dbContext.Characters.FindAsync(new object[] { characterId }, ct);
        
        var balances = new Dictionary<CurrencyType, long>();
        if (character != null)
        {
            balances[CurrencyType.Gold] = character.Gold;
        }
        
        // TODO: æŸ¥è¯¢å…¶ä»–è´§å¸
        
        return balances;
    }
}
```

---

## 5. Phase 4: å‰ç«¯ç•Œé¢å¼€å‘

### 5.1 å‰ç«¯ç»„ä»¶æ¸…å•

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ | ä¼˜å…ˆçº§ |
|-----|---------|------|--------|
| ShopList | Pages/ShopList.razor | å•†åº—åˆ—è¡¨é¡µ | P1 |
| ShopDetail | Pages/ShopDetail.razor | å•†åº—è¯¦æƒ…é¡µ | P1 |
| ShopItemCard | Components/ShopItemCard.razor | å•†å“å¡ç‰‡ | P1 |
| PurchaseModal | Components/PurchaseModal.razor | è´­ä¹°ç¡®è®¤æ¡† | P1 |
| ShopFilter | Components/ShopFilter.razor | å•†å“ç­›é€‰ | P2 |
| CurrencyDisplay | Components/CurrencyDisplay.razor | è´§å¸æ˜¾ç¤º | P2 |

### 5.2 ShopList é¡µé¢å®ç°

**æ–‡ä»¶**: `BlazorIdle/Pages/ShopList.razor`

```razor
@page "/shops"
@inject HttpClient Http
@inject IToastService Toast

<div class="shops-container">
    <h2>å•†åº—</h2>
    
    @if (_loading)
    {
        <p>åŠ è½½ä¸­...</p>
    }
    else if (_shops.Count == 0)
    {
        <p>æš‚æ— å¯ç”¨å•†åº—</p>
    }
    else
    {
        <div class="shop-grid">
            @foreach (var shop in _shops)
            {
                <div class="shop-card @(shop.IsUnlocked ? "" : "locked")" 
                     @onclick="() => NavigateToShop(shop.ShopId)">
                    <img src="@shop.Icon" alt="@shop.Name" class="shop-icon" />
                    <h3>@shop.Name</h3>
                    <p>@shop.Description</p>
                    
                    @if (!shop.IsUnlocked)
                    {
                        <div class="lock-overlay">
                            <span>ğŸ”’ æœªè§£é”</span>
                        </div>
                    }
                    
                    @if (shop.RefreshInterval != "Never")
                    {
                        <div class="refresh-info">
                            <span>åˆ·æ–°: @shop.RefreshInterval</span>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ShopListItemDto> _shops = new();
    private bool _loading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadShopsAsync();
    }
    
    private async Task LoadShopsAsync()
    {
        try
        {
            _loading = true;
            var response = await Http.GetFromJsonAsync<ShopListResponse>("/api/shops");
            _shops = response?.Shops ?? new();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"åŠ è½½å•†åº—å¤±è´¥ï¼š{ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }
    
    private void NavigateToShop(string shopId)
    {
        // TODO: å¯¼èˆªåˆ°å•†åº—è¯¦æƒ…é¡µ
    }
}
```

### 5.3 ShopDetail é¡µé¢å®ç°

**æ–‡ä»¶**: `BlazorIdle/Pages/ShopDetail.razor`

```razor
@page "/shops/{ShopId}"
@inject HttpClient Http
@inject IToastService Toast

<div class="shop-detail-container">
    @if (_loading)
    {
        <p>åŠ è½½ä¸­...</p>
    }
    else if (_shop != null)
    {
        <div class="shop-header">
            <h2>@_shop.Name</h2>
            <p>@_shop.Description</p>
            
            <div class="currency-display">
                <span>ğŸ’° é‡‘å¸: @_characterGold</span>
                <!-- TODO: æ˜¾ç¤ºå…¶ä»–è´§å¸ -->
            </div>
        </div>
        
        <div class="items-grid">
            @foreach (var item in _shop.Items)
            {
                <ShopItemCard Item="@item" 
                              OnPurchase="HandlePurchaseAsync" />
            }
        </div>
    }
</div>

@code {
    [Parameter] public string ShopId { get; set; } = string.Empty;
    
    private ShopDetailDto? _shop;
    private long _characterGold;
    private bool _loading = true;
    
    protected override async Task OnParametersSetAsync()
    {
        await LoadShopDetailAsync();
    }
    
    private async Task LoadShopDetailAsync()
    {
        try
        {
            _loading = true;
            _shop = await Http.GetFromJsonAsync<ShopDetailDto>($"/api/shops/{ShopId}");
            // TODO: åŠ è½½è§’è‰²è´§å¸ä¿¡æ¯
        }
        catch (Exception ex)
        {
            Toast.ShowError($"åŠ è½½å•†åº—å¤±è´¥ï¼š{ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }
    
    private async Task HandlePurchaseAsync(string shopItemId, int quantity)
    {
        // TODO: å®ç°è´­ä¹°é€»è¾‘
    }
}
```

---

## 6. æ•°æ®åº“è®¾è®¡è¯¦è§£

### 6.1 ERå›¾

```
[Character] 1--N [PurchaseRecord]
[Character] 1--N [CharacterPurchaseRecord]
[ShopDefinition] 1--N [ShopItemDefinition]
[ShopDefinition] 1--1 [ShopInstance]
[ShopInstance] 1--N [ShopItemStock]
```

### 6.2 è¡¨ç»“æ„SQL

**å®Œæ•´å»ºè¡¨è¯­å¥è§é™„å½•**

---

## 7. APIæ¥å£è®¾è®¡

### 7.1 å•†åº—æ¥å£

#### GET /api/shops
è·å–è§’è‰²å¯è§çš„å•†åº—åˆ—è¡¨

**Response**:
```json
{
  "shops": [
    {
      "shopId": "shop_general_town",
      "name": "åŸé•‡æ‚è´§é“º",
      "description": "å‡ºå”®æ—¥å¸¸æ¶ˆè€—å“",
      "icon": "shop_general.png",
      "shopType": "General",
      "isUnlocked": true,
      "refreshInterval": "Never"
    }
  ]
}
```

#### GET /api/shops/{shopId}
è·å–å•†åº—è¯¦æƒ…å’Œå•†å“åˆ—è¡¨

**Response**:
```json
{
  "shopId": "shop_general_town",
  "name": "åŸé•‡æ‚è´§é“º",
  "items": [
    {
      "shopItemId": "item_bread",
      "itemType": "Consumable",
      "itemId": "consumable_bread",
      "itemName": "é¢åŒ…",
      "prices": [
        { "currencyType": "Gold", "amount": 5 }
      ],
      "currentStock": null,
      "maxStock": null,
      "isUnlocked": true,
      "remainingPurchases": null
    }
  ]
}
```

#### POST /api/shops/purchase
è´­ä¹°å•†å“

**Request**:
```json
{
  "characterId": "guid",
  "shopItemId": "item_bread",
  "quantity": 10,
  "transactionId": "guid"
}
```

**Response**:
```json
{
  "success": true,
  "message": "è´­ä¹°æˆåŠŸ",
  "itemsGranted": [
    { "itemId": "consumable_bread", "quantity": 10 }
  ],
  "remainingCurrency": {
    "gold": 950
  }
}
```

---

## 8. ä¸‹ç¯‡é¢„å‘Š

**å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰** å°†æ¶µç›–ï¼š
- Phase 5: é›†æˆæµ‹è¯•ç­–ç•¥
- Phase 6: æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§
- å®‰å…¨æ€§åŠ å›ºæ–¹æ¡ˆ
- è¿ç»´é…ç½®ç®¡ç†
- æ‰©å±•åŠŸèƒ½è®¾è®¡ï¼ˆæ‹å–è¡Œã€äº¤æ˜“è¡Œï¼‰

---

**æ–‡æ¡£ç»“æŸ - è¯·ç»§ç»­é˜…è¯»ã€Šå•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰ã€‹**
