# BlazorIdle æ•°æ®åº“ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸Šç¯‡ï¼šåŸºç¡€è®¾æ–½å»ºè®¾

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**é˜¶æ®µ**: Phase 1 - åŸºç¡€è®¾æ–½  
**é¢„è®¡å·¥æ—¶**: 48-64 å°æ—¶ï¼ˆ6-8 ä¸ªå·¥ä½œæ—¥ï¼‰  
**ä¼˜å…ˆçº§**: P0ï¼ˆå¿…é¡»å®Œæˆï¼‰  
**ä¾èµ–**: æ—   

---

## ğŸ“‹ ç›®å½•

1. [é˜¶æ®µç›®æ ‡](#é˜¶æ®µç›®æ ‡)
2. [æ ¸å¿ƒä»»åŠ¡æ¸…å•](#æ ¸å¿ƒä»»åŠ¡æ¸…å•)
3. [è¯¦ç»†å®æ–½æ­¥éª¤](#è¯¦ç»†å®æ–½æ­¥éª¤)
4. [ä»£ç å®ç°](#ä»£ç å®ç°)
5. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
6. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)

---

## é˜¶æ®µç›®æ ‡

### ä¸»è¦ç›®æ ‡

âœ… **å»ºç«‹å†…å­˜ç¼“å†²åŸºç¡€è®¾æ–½**
- å®ç° MemoryStateManager é€šç”¨ç»„ä»¶
- æ”¯æŒå¤šç§å®ä½“ç±»å‹çš„å†…å­˜ç®¡ç†
- æä¾›çº¿ç¨‹å®‰å…¨çš„å¹¶å‘è®¿é—®

âœ… **å®ç°æŒä¹…åŒ–åè°ƒå™¨**
- å®šæœŸæ‰¹é‡ä¿å­˜æœºåˆ¶
- å¯é…ç½®çš„ä¿å­˜ç­–ç•¥
- é”™è¯¯é‡è¯•å’Œæ¢å¤

âœ… **å¢å¼ºä¼˜é›…å…³é—­**
- ç›‘å¬å…³é—­ä¿¡å·
- å¼ºåˆ¶æœ€ç»ˆä¿å­˜
- è®¾ç½®æ‰€æœ‰è§’è‰²ç¦»çº¿

âœ… **é…ç½®åŒ–æ”¯æŒ**
- å®šä¹‰é…ç½®é€‰é¡¹ç±»
- æ”¯æŒè¿è¡Œæ—¶é…ç½®
- æä¾›åˆç†é»˜è®¤å€¼

### ä¸æ”¹å˜çš„éƒ¨åˆ†

- âœ… ç°æœ‰ API æ¥å£ä¿æŒä¸å˜
- âœ… æ•°æ®æ¨¡å‹ç»“æ„ä¸å˜
- âœ… ä¸šåŠ¡é€»è¾‘ä¸å˜
- âœ… å®¢æˆ·ç«¯ä»£ç æ— éœ€ä¿®æ”¹

### æˆåŠŸæ ‡å‡†

- [ ] æ‰€æœ‰æ ¸å¿ƒç»„ä»¶é€šè¿‡å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•éªŒè¯åŸºç¡€è®¾æ–½æ­£å¸¸å·¥ä½œ
- [ ] æ€§èƒ½æµ‹è¯•æ˜¾ç¤ºæ— æ˜æ˜¾æ€§èƒ½é€€åŒ–
- [ ] é…ç½®æ–‡ä»¶å¯æ­£å¸¸åŠ è½½å’Œåº”ç”¨

---

## æ ¸å¿ƒä»»åŠ¡æ¸…å•

### Task 1.1: åˆ›å»ºé€šç”¨æ¥å£å’ŒæŠ½è±¡ â±ï¸ 4-6h

**æ–‡ä»¶**:
- `BlazorIdle.Server/Application/Abstractions/IMemoryStateManager.cs`
- `BlazorIdle.Server/Application/Abstractions/IEntity.cs`
- `BlazorIdle.Server/Application/Abstractions/IPersistenceCoordinator.cs`

**ä»»åŠ¡**:
1. å®šä¹‰ `IEntity` æ¥å£ï¼ˆæ‰€æœ‰éœ€è¦å†…å­˜ç®¡ç†çš„å®ä½“ï¼‰
2. å®šä¹‰ `IMemoryStateManager<T>` æ¥å£
3. å®šä¹‰ `IPersistenceCoordinator` æ¥å£
4. æ·»åŠ  XML æ–‡æ¡£æ³¨é‡Š

**éªŒæ”¶**:
- [ ] æ¥å£ç¼–è¯‘é€šè¿‡
- [ ] æ³¨é‡Šå®Œæ•´æ¸…æ™°
- [ ] éµå¾ª SOLID åŸåˆ™

---

### Task 1.2: å®ç° MemoryStateManager â±ï¸ 12-16h

**æ–‡ä»¶**:
- `BlazorIdle.Server/Infrastructure/Memory/MemoryStateManager.cs`
- `BlazorIdle.Server/Infrastructure/Memory/DirtyTracker.cs`

**ä»»åŠ¡**:
1. å®ç°å†…å­˜å­˜å‚¨ï¼ˆConcurrentDictionaryï¼‰
2. å®ç° Dirty è¿½è¸ª
3. å®ç°è¯»å†™é”ä¿æŠ¤å¿«ç…§æ“ä½œ
4. å®ç° LRU ç¼“å­˜æ¸…ç†ç­–ç•¥
5. æ·»åŠ æ—¥å¿—è®°å½•
6. ç¼–å†™å•å…ƒæµ‹è¯•

**å…³é”®å®ç°ç‚¹**:

```csharp
public class MemoryStateManager<T> : IMemoryStateManager<T> 
    where T : class, IEntity
{
    private readonly ConcurrentDictionary<Guid, T> _store;
    private readonly ConcurrentDictionary<Guid, DateTime> _dirtyEntities;
    private readonly ConcurrentDictionary<Guid, DateTime> _accessTimes; // LRU
    private readonly ReaderWriterLockSlim _lock;
    private readonly MemoryCacheOptions _options;
    private readonly ILogger<MemoryStateManager<T>> _logger;
    
    // æ ¸å¿ƒæ–¹æ³•
    public async Task<T?> GetAsync(Guid id, CancellationToken ct);
    public void Update(T entity);
    public void Add(T entity);
    public void Remove(Guid id);
    public IEnumerable<(Guid Id, T Entity)> GetDirtyEntities();
    public void ClearDirty(IEnumerable<Guid> ids);
    public IReadOnlyDictionary<Guid, T> GetSnapshot();
    
    // è¾…åŠ©æ–¹æ³•
    private void EvictIfNeeded();
    private void UpdateAccessTime(Guid id);
}
```

**å•å…ƒæµ‹è¯•è¦†ç›–**:
- [ ] å¹¶å‘è¯»å†™æµ‹è¯•
- [ ] Dirty è¿½è¸ªæµ‹è¯•
- [ ] LRU æ¸…ç†æµ‹è¯•
- [ ] å¿«ç…§éš”ç¦»æµ‹è¯•

**éªŒæ”¶**:
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç è¦†ç›–ç‡ > 90%
- [ ] å¹¶å‘å‹åŠ›æµ‹è¯•é€šè¿‡ï¼ˆ1000+ å¹¶å‘æ“ä½œï¼‰

---

### Task 1.3: å®ç° PersistenceCoordinator â±ï¸ 16-20h

**æ–‡ä»¶**:
- `BlazorIdle.Server/Infrastructure/Persistence/PersistenceCoordinator.cs`
- `BlazorIdle.Server/Infrastructure/Persistence/BatchSaveStrategy.cs`

**ä»»åŠ¡**:
1. ç»§æ‰¿ BackgroundService
2. å®ç°å®šæœŸä¿å­˜å¾ªç¯
3. å®ç°æ‰¹é‡ä¿å­˜é€»è¾‘
4. å®ç°åˆ†å®ä½“ç±»å‹ä¿å­˜ç­–ç•¥
5. å®ç°é‡è¯•æœºåˆ¶
6. å®ç°å…³é—­æ—¶æœ€ç»ˆä¿å­˜
7. æ·»åŠ æ€§èƒ½ç›‘æ§åŸ‹ç‚¹
8. ç¼–å†™é›†æˆæµ‹è¯•

**æ ¸å¿ƒå®ç°**:

```csharp
public class PersistenceCoordinator : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly IOptions<PersistenceOptions> _options;
    private readonly ILogger<PersistenceCoordinator> _logger;
    
    // å„ç±»å‹å®ä½“çš„çŠ¶æ€ç®¡ç†å™¨
    private MemoryStateManager<Character> _characterManager;
    private MemoryStateManager<RunningBattleSnapshotRecord> _battleSnapshotManager;
    private MemoryStateManager<ActivityPlan> _activityPlanManager;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("æŒä¹…åŒ–åè°ƒå™¨å·²å¯åŠ¨");
        
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                await Task.Delay(_options.Value.SaveIntervalMs, stoppingToken);
                await PeriodicSaveAsync(stoppingToken);
            }
            catch (OperationCanceledException)
            {
                _logger.LogInformation("æŒä¹…åŒ–åè°ƒå™¨åœæ­¢ä¿¡å·å·²æ¥æ”¶");
                break;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "å®šæœŸä¿å­˜å‘ç”Ÿé”™è¯¯");
            }
        }
        
        // å…³é—­æ—¶æœ€ç»ˆä¿å­˜
        await FinalSaveAsync();
        _logger.LogInformation("æŒä¹…åŒ–åè°ƒå™¨å·²åœæ­¢");
    }
    
    private async Task PeriodicSaveAsync(CancellationToken ct)
    {
        var sw = Stopwatch.StartNew();
        
        using var scope = _scopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
        
        // æŒ‰ç­–ç•¥ä¿å­˜ä¸åŒå®ä½“ç±»å‹
        int totalSaved = 0;
        
        // æˆ˜æ–—å¿«ç…§ï¼ˆå¦‚æœåˆ°äº†ä¿å­˜æ—¶é—´ï¼‰
        if (ShouldSave("BattleSnapshot"))
        {
            totalSaved += await SaveEntityTypeAsync(
                _battleSnapshotManager, 
                db.RunningBattleSnapshots, 
                ct
            );
        }
        
        // è§’è‰²å¿ƒè·³
        if (ShouldSave("CharacterHeartbeat"))
        {
            totalSaved += await SaveEntityTypeAsync(
                _characterManager,
                db.Characters,
                ct
            );
        }
        
        // æ´»åŠ¨è®¡åˆ’
        if (ShouldSave("ActivityPlan"))
        {
            totalSaved += await SaveEntityTypeAsync(
                _activityPlanManager,
                db.ActivityPlans,
                ct
            );
        }
        
        sw.Stop();
        
        if (totalSaved > 0)
        {
            _logger.LogInformation(
                "å®šæœŸä¿å­˜å®Œæˆï¼š{Count} ä¸ªå®ä½“ï¼Œè€—æ—¶ {ElapsedMs}ms",
                totalSaved, sw.ElapsedMilliseconds
            );
        }
    }
    
    private async Task<int> SaveEntityTypeAsync<T>(
        MemoryStateManager<T> manager,
        DbSet<T> dbSet,
        CancellationToken ct) where T : class, IEntity
    {
        var dirtyEntities = manager.GetDirtyEntities().ToList();
        if (!dirtyEntities.Any())
            return 0;
            
        var maxBatch = _options.Value.MaxBatchSize;
        var batches = dirtyEntities.Chunk(maxBatch);
        
        int saved = 0;
        foreach (var batch in batches)
        {
            foreach (var (id, entity) in batch)
            {
                dbSet.Update(entity);
            }
            
            await DatabaseRetryPolicy.SaveChangesWithRetryAsync(
                dbSet.Context as GameDbContext, 
                ct, 
                _logger
            );
            
            manager.ClearDirty(batch.Select(x => x.Id));
            saved += batch.Length;
        }
        
        return saved;
    }
    
    public async Task FinalSaveAsync()
    {
        _logger.LogWarning("æ‰§è¡Œæœ€ç»ˆä¿å­˜...");
        
        var sw = Stopwatch.StartNew();
        
        using var scope = _scopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
        
        // å¼ºåˆ¶ä¿å­˜æ‰€æœ‰ Dirty å®ä½“
        int totalSaved = 0;
        totalSaved += await SaveEntityTypeAsync(_battleSnapshotManager, db.RunningBattleSnapshots, CancellationToken.None);
        totalSaved += await SaveEntityTypeAsync(_characterManager, db.Characters, CancellationToken.None);
        totalSaved += await SaveEntityTypeAsync(_activityPlanManager, db.ActivityPlans, CancellationToken.None);
        
        sw.Stop();
        
        _logger.LogInformation(
            "æœ€ç»ˆä¿å­˜å®Œæˆï¼š{Count} ä¸ªå®ä½“ï¼Œè€—æ—¶ {ElapsedMs}ms",
            totalSaved, sw.ElapsedMilliseconds
        );
    }
    
    private bool ShouldSave(string entityType)
    {
        // æ ¹æ®é…ç½®çš„ä¿å­˜ç­–ç•¥åˆ¤æ–­æ˜¯å¦åº”è¯¥ä¿å­˜
        // å®ç°çœç•¥...
    }
}
```

**é›†æˆæµ‹è¯•åœºæ™¯**:
- [ ] å¯åŠ¨åæ­£å¸¸å®šæœŸä¿å­˜
- [ ] åœæ­¢æ—¶è§¦å‘æœ€ç»ˆä¿å­˜
- [ ] ä¿å­˜å¤±è´¥é‡è¯•æœºåˆ¶
- [ ] å¤§æ‰¹é‡æ•°æ®ä¿å­˜æ€§èƒ½

**éªŒæ”¶**:
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ—¥å¿—è¾“å‡ºå®Œæ•´
- [ ] æ€§èƒ½ç¬¦åˆé¢„æœŸï¼ˆæ‰¹é‡ä¿å­˜ < 500msï¼‰

---

### Task 1.4: å¢å¼º ShutdownManager â±ï¸ 8-10h

**æ–‡ä»¶**:
- `BlazorIdle.Server/Services/EnhancedShutdownManager.cs`

**ä»»åŠ¡**:
1. æ›¿æ¢ç°æœ‰ GracefulShutdownCoordinator
2. é›†æˆ PersistenceCoordinator æœ€ç»ˆä¿å­˜
3. å®ç°è®¾ç½®æ‰€æœ‰è§’è‰²ç¦»çº¿åŠŸèƒ½
4. å®ç°è¶…æ—¶ä¿æŠ¤
5. æ·»åŠ æ—¥å¿—å’Œç›‘æ§
6. ç¼–å†™é›†æˆæµ‹è¯•

**æ ¸å¿ƒå®ç°**:

```csharp
public class EnhancedShutdownManager : IHostedService
{
    private readonly IHostApplicationLifetime _appLifetime;
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly PersistenceCoordinator _persistenceCoordinator;
    private readonly IOptions<ShutdownOptions> _options;
    private readonly ILogger<EnhancedShutdownManager> _logger;
    private readonly CancellationTokenSource _shutdownCts = new();
    
    public static CancellationToken ShutdownToken => _instance?._shutdownCts.Token ?? CancellationToken.None;
    private static EnhancedShutdownManager? _instance;
    
    public Task StartAsync(CancellationToken cancellationToken)
    {
        _instance = this;
        _logger.LogInformation("å¢å¼ºçš„å…³é—­ç®¡ç†å™¨å·²å¯åŠ¨");
        
        _appLifetime.ApplicationStopping.Register(() =>
        {
            _logger.LogWarning("========================================");
            _logger.LogWarning("æœåŠ¡å™¨å…³é—­å¼€å§‹ - æ‰§è¡Œä¼˜é›…å…³é—­æµç¨‹");
            _logger.LogWarning("========================================");
            
            // è§¦å‘å…³é—­ä¿¡å·
            _shutdownCts.Cancel();
            
            // æ‰§è¡Œå…³é—­æµç¨‹ï¼ˆåŒæ­¥ç­‰å¾…ï¼‰
            ExecuteShutdownAsync().GetAwaiter().GetResult();
        });
        
        return Task.CompletedTask;
    }
    
    private async Task ExecuteShutdownAsync()
    {
        var sw = Stopwatch.StartNew();
        
        try
        {
            // Step 1: è§¦å‘åè°ƒå™¨æœ€ç»ˆä¿å­˜
            _logger.LogInformation("[1/3] å¼€å§‹ä¿å­˜æ‰€æœ‰æ•°æ®...");
            var saveTask = _persistenceCoordinator.FinalSaveAsync();
            
            // Step 2: è®¾ç½®æ‰€æœ‰è§’è‰²ç¦»çº¿
            _logger.LogInformation("[2/3] è®¾ç½®æ‰€æœ‰åœ¨çº¿è§’è‰²ä¸ºç¦»çº¿...");
            var offlineTask = SetAllCharactersOfflineAsync();
            
            // Step 3: ç­‰å¾…ä»»åŠ¡å®Œæˆï¼ˆå¸¦è¶…æ—¶ï¼‰
            var timeoutTask = Task.Delay(
                TimeSpan.FromSeconds(_options.Value.ShutdownTimeoutSeconds)
            );
            
            var completedTask = await Task.WhenAny(
                Task.WhenAll(saveTask, offlineTask),
                timeoutTask
            );
            
            if (completedTask == timeoutTask)
            {
                _logger.LogWarning("å…³é—­æµç¨‹è¶…æ—¶ï¼ˆ{Timeout}ç§’ï¼‰ï¼Œå¼ºåˆ¶ç»§ç»­",
                    _options.Value.ShutdownTimeoutSeconds);
            }
            else
            {
                _logger.LogInformation("[3/3] æ‰€æœ‰å…³é—­ä»»åŠ¡å·²å®Œæˆ");
            }
            
            // Step 4: å¼ºåˆ¶æ‰§è¡Œ WAL æ£€æŸ¥ç‚¹ï¼ˆå¦‚æœé…ç½®å¯ç”¨ï¼‰
            if (_options.Value.ForceWalCheckpointOnShutdown)
            {
                _logger.LogInformation("æ‰§è¡Œ WAL æ£€æŸ¥ç‚¹...");
                await ForceWalCheckpointAsync();
            }
            
            sw.Stop();
            
            _logger.LogInformation("========================================");
            _logger.LogInformation("ä¼˜é›…å…³é—­æµç¨‹å®Œæˆï¼Œè€—æ—¶ {ElapsedMs}ms", sw.ElapsedMilliseconds);
            _logger.LogInformation("========================================");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å…³é—­æµç¨‹å‘ç”Ÿé”™è¯¯");
        }
    }
    
    private async Task SetAllCharactersOfflineAsync()
    {
        using var scope = _scopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
        
        var sw = Stopwatch.StartNew();
        
        try
        {
            // ä½¿ç”¨ ExecuteUpdateAsync æ‰¹é‡æ›´æ–°ï¼ˆEF Core 7+ï¼‰
            int updatedCount = await db.Characters
                .Where(c => c.IsOnline)
                .ExecuteUpdateAsync(setters => setters
                    .SetProperty(c => c.IsOnline, false)
                    .SetProperty(c => c.LastSeenAtUtc, DateTime.UtcNow)
                );
            
            sw.Stop();
            
            _logger.LogInformation(
                "å·²å°† {Count} ä¸ªåœ¨çº¿è§’è‰²è®¾ç½®ä¸ºç¦»çº¿ï¼ˆè€—æ—¶ {ElapsedMs}msï¼‰",
                updatedCount, sw.ElapsedMilliseconds
            );
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è®¾ç½®è§’è‰²ç¦»çº¿æ—¶å‘ç”Ÿé”™è¯¯");
            
            // é™çº§æ–¹æ¡ˆï¼šé€ä¸ªæ›´æ–°
            await SetCharactersOfflineFallbackAsync(db);
        }
    }
    
    private async Task SetCharactersOfflineFallbackAsync(GameDbContext db)
    {
        var onlineCharacters = await db.Characters
            .Where(c => c.IsOnline)
            .ToListAsync();
            
        foreach (var character in onlineCharacters)
        {
            character.IsOnline = false;
            character.LastSeenAtUtc = DateTime.UtcNow;
        }
        
        await db.SaveChangesAsync();
        
        _logger.LogInformation(
            "ä½¿ç”¨é™çº§æ–¹æ¡ˆè®¾ç½®äº† {Count} ä¸ªè§’è‰²ä¸ºç¦»çº¿",
            onlineCharacters.Count
        );
    }
    
    private async Task ForceWalCheckpointAsync()
    {
        using var scope = _scopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
        
        await db.Database.ExecuteSqlRawAsync("PRAGMA wal_checkpoint(TRUNCATE)");
        
        _logger.LogInformation("WAL æ£€æŸ¥ç‚¹å·²æ‰§è¡Œ");
    }
    
    public Task StopAsync(CancellationToken cancellationToken)
    {
        _logger.LogInformation("å¢å¼ºçš„å…³é—­ç®¡ç†å™¨å·²åœæ­¢");
        _shutdownCts.Dispose();
        return Task.CompletedTask;
    }
}
```

**é›†æˆæµ‹è¯•åœºæ™¯**:
- [ ] æ­£å¸¸å…³é—­æµç¨‹å®Œæ•´æ‰§è¡Œ
- [ ] è¶…æ—¶ä¿æŠ¤ç”Ÿæ•ˆ
- [ ] æ‰€æœ‰åœ¨çº¿è§’è‰²æ­£ç¡®è®¾ä¸ºç¦»çº¿
- [ ] WAL æ£€æŸ¥ç‚¹æ­£ç¡®æ‰§è¡Œ

**éªŒæ”¶**:
- [ ] æµ‹è¯•é€šè¿‡
- [ ] æ—¥å¿—å®Œæ•´æ¸…æ™°
- [ ] å…³é—­æ—¶é—´ < 30 ç§’

---

### Task 1.5: é…ç½®é€‰é¡¹å®šä¹‰å’Œæ³¨å†Œ â±ï¸ 4-6h

**æ–‡ä»¶**:
- `BlazorIdle.Server/Config/PersistenceOptions.cs`
- `BlazorIdle.Server/Config/ShutdownOptions.cs`
- `BlazorIdle.Server/Config/MemoryCacheOptions.cs`

**ä»»åŠ¡**:
1. å®šä¹‰é…ç½®ç±»
2. æ·»åŠ æ•°æ®éªŒè¯ç‰¹æ€§
3. æä¾›é»˜è®¤å€¼
4. åœ¨ Program.cs æ³¨å†Œ
5. æ›´æ–° appsettings.json
6. ç¼–å†™é…ç½®éªŒè¯æµ‹è¯•

**é…ç½®ç±»å®ç°**:

```csharp
/// <summary>
/// æŒä¹…åŒ–é…ç½®é€‰é¡¹
/// </summary>
public class PersistenceOptions
{
    /// <summary>
    /// æ˜¯å¦å¯ç”¨å†…å­˜ç¼“å†²ï¼ˆç”¨äºå›é€€ï¼‰
    /// </summary>
    public bool EnableMemoryBuffering { get; set; } = true;
    
    /// <summary>
    /// å®šæœŸä¿å­˜é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    /// </summary>
    [Range(1000, 300000)]
    public int SaveIntervalMs { get; set; } = 30000; // 30ç§’
    
    /// <summary>
    /// æ‰¹é‡ä¿å­˜å¤§å°é™åˆ¶
    /// </summary>
    [Range(100, 10000)]
    public int MaxBatchSize { get; set; } = 1000;
    
    /// <summary>
    /// å¼ºåˆ¶ä¿å­˜é˜ˆå€¼ï¼ˆDirty å®ä½“æ•°é‡ï¼‰
    /// </summary>
    [Range(1000, 100000)]
    public int ForceSaveThreshold { get; set; } = 5000;
    
    /// <summary>
    /// ä¿å­˜å¤±è´¥é‡è¯•æ¬¡æ•°
    /// </summary>
    [Range(1, 10)]
    public int SaveRetryAttempts { get; set; } = 3;
    
    /// <summary>
    /// ä¸åŒå®ä½“ç±»å‹çš„ä¿å­˜ç­–ç•¥
    /// </summary>
    public Dictionary<string, EntitySaveStrategy> EntitySaveStrategies { get; set; } = new();
}

/// <summary>
/// å®ä½“ä¿å­˜ç­–ç•¥
/// </summary>
public class EntitySaveStrategy
{
    [Range(1000, 600000)]
    public int SaveIntervalMs { get; set; }
    
    [Range(10, 5000)]
    public int MaxBatchSize { get; set; }
}

/// <summary>
/// å…³é—­é…ç½®é€‰é¡¹
/// </summary>
public class ShutdownOptions
{
    /// <summary>
    /// ä¼˜é›…å…³é—­è¶…æ—¶ï¼ˆç§’ï¼‰
    /// </summary>
    [Range(10, 300)]
    public int ShutdownTimeoutSeconds { get; set; } = 30;
    
    /// <summary>
    /// æ˜¯å¦åœ¨å…³é—­æ—¶è®¾ç½®æ‰€æœ‰è§’è‰²ä¸ºç¦»çº¿
    /// </summary>
    public bool SetCharactersOfflineOnShutdown { get; set; } = true;
    
    /// <summary>
    /// æ˜¯å¦åœ¨å…³é—­æ—¶å¼ºåˆ¶æ‰§è¡Œ WAL æ£€æŸ¥ç‚¹
    /// </summary>
    public bool ForceWalCheckpointOnShutdown { get; set; } = true;
    
    /// <summary>
    /// å…³é—­æ—¶ä¿å­˜é‡è¯•æ¬¡æ•°
    /// </summary>
    [Range(1, 10)]
    public int ShutdownSaveRetryAttempts { get; set; } = 5;
}

/// <summary>
/// å†…å­˜ç¼“å­˜é…ç½®é€‰é¡¹
/// </summary>
public class MemoryCacheOptions
{
    /// <summary>
    /// å†…å­˜ç¼“å­˜æœ€å¤§å®ä½“æ•°ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
    /// </summary>
    [Range(1000, 1000000)]
    public int MaxCachedEntities { get; set; } = 100000;
    
    /// <summary>
    /// è¶…è¿‡é˜ˆå€¼æ—¶çš„æ¸…ç†ç­–ç•¥ï¼ˆLRU / TTLï¼‰
    /// </summary>
    public string EvictionPolicy { get; set; } = "LRU";
    
    /// <summary>
    /// TTLï¼ˆç§’ï¼Œä»…å½“ EvictionPolicy = TTLï¼‰
    /// </summary>
    [Range(60, 86400)]
    public int TimeToLiveSeconds { get; set; } = 3600;
}
```

**appsettings.json æ›´æ–°**:

```json
{
  "Persistence": {
    "EnableMemoryBuffering": true,
    "SaveIntervalMs": 30000,
    "MaxBatchSize": 1000,
    "ForceSaveThreshold": 5000,
    "SaveRetryAttempts": 3,
    "EntitySaveStrategies": {
      "BattleSnapshot": {
        "SaveIntervalMs": 60000,
        "MaxBatchSize": 500
      },
      "CharacterHeartbeat": {
        "SaveIntervalMs": 300000,
        "MaxBatchSize": 1000
      },
      "ActivityPlan": {
        "SaveIntervalMs": 30000,
        "MaxBatchSize": 200
      }
    }
  },
  "Shutdown": {
    "ShutdownTimeoutSeconds": 30,
    "SetCharactersOfflineOnShutdown": true,
    "ForceWalCheckpointOnShutdown": true,
    "ShutdownSaveRetryAttempts": 5
  },
  "MemoryCache": {
    "MaxCachedEntities": 100000,
    "EvictionPolicy": "LRU",
    "TimeToLiveSeconds": 3600
  }
}
```

**Program.cs æ³¨å†Œ**:

```csharp
// é…ç½®é€‰é¡¹æ³¨å†Œ
builder.Services.Configure<PersistenceOptions>(
    builder.Configuration.GetSection("Persistence"));
builder.Services.Configure<ShutdownOptions>(
    builder.Configuration.GetSection("Shutdown"));
builder.Services.Configure<MemoryCacheOptions>(
    builder.Configuration.GetSection("MemoryCache"));

// é…ç½®éªŒè¯
builder.Services.AddOptions<PersistenceOptions>()
    .Bind(builder.Configuration.GetSection("Persistence"))
    .ValidateDataAnnotations()
    .ValidateOnStart();
```

**éªŒæ”¶**:
- [ ] é…ç½®æ­£å¸¸åŠ è½½
- [ ] éªŒè¯è§„åˆ™ç”Ÿæ•ˆ
- [ ] é»˜è®¤å€¼æ­£ç¡®

---

### Task 1.6: ä¾èµ–æ³¨å…¥å’ŒæœåŠ¡æ³¨å†Œ â±ï¸ 4-6h

**æ–‡ä»¶**:
- `BlazorIdle.Server/Infrastructure/DependencyInjection.cs`

**ä»»åŠ¡**:
1. æ³¨å†Œ MemoryStateManager ä¸ºå•ä¾‹
2. æ³¨å†Œ PersistenceCoordinator ä¸ºåå°æœåŠ¡
3. æ›¿æ¢ GracefulShutdownCoordinator ä¸º EnhancedShutdownManager
4. æ›´æ–° Program.cs

**DependencyInjection.cs æ›´æ–°**:

```csharp
public static class DependencyInjection
{
    public static IServiceCollection AddInfrastructure(
        this IServiceCollection services, 
        IConfiguration configuration)
    {
        // ... ç°æœ‰ä»£ç  ...
        
        // å†…å­˜çŠ¶æ€ç®¡ç†å™¨ï¼ˆå•ä¾‹ - å…¨å±€å…±äº«ï¼‰
        services.AddSingleton<MemoryStateManager<Character>>();
        services.AddSingleton<MemoryStateManager<RunningBattleSnapshotRecord>>();
        services.AddSingleton<MemoryStateManager<ActivityPlan>>();
        
        // æŒä¹…åŒ–åè°ƒå™¨ï¼ˆåå°æœåŠ¡ï¼‰
        services.AddHostedService<PersistenceCoordinator>();
        
        // å¢å¼ºçš„å…³é—­ç®¡ç†å™¨ï¼ˆä¼˜å…ˆæ³¨å†Œï¼Œæœ€å…ˆæ¥æ”¶å…³é—­ä¿¡å·ï¼‰
        services.AddHostedService<EnhancedShutdownManager>();
        
        return services;
    }
}
```

**éªŒæ”¶**:
- [ ] æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] ä¾èµ–æ³¨å…¥æ­£å¸¸å·¥ä½œ
- [ ] æœåŠ¡ç”Ÿå‘½å‘¨æœŸæ­£ç¡®

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

**æµ‹è¯•é¡¹ç›®**: `BlazorIdle.Server.Tests`

**è¦†ç›–èŒƒå›´**:
1. MemoryStateManager
   - å¹¶å‘è¯»å†™
   - Dirty è¿½è¸ª
   - LRU æ¸…ç†
   - å¿«ç…§éš”ç¦»

2. PersistenceCoordinator
   - æ‰¹é‡ä¿å­˜é€»è¾‘
   - é‡è¯•æœºåˆ¶
   - æœ€ç»ˆä¿å­˜

3. EnhancedShutdownManager
   - å…³é—­æµç¨‹
   - è¶…æ—¶ä¿æŠ¤
   - è®¾ç½®è§’è‰²ç¦»çº¿

**æµ‹è¯•å·¥å…·**:
- xUnit
- Moq
- FluentAssertions

### é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**:
1. å¯åŠ¨æµç¨‹
   - æ‰€æœ‰æœåŠ¡æ­£å¸¸å¯åŠ¨
   - é…ç½®æ­£ç¡®åŠ è½½

2. è¿è¡Œæ—¶è¡Œä¸º
   - å®šæœŸä¿å­˜æ­£å¸¸è§¦å‘
   - æ‰¹é‡ä¿å­˜æ­£ç¡®æ‰§è¡Œ

3. å…³é—­æµç¨‹
   - ä¼˜é›…å…³é—­å®Œæ•´æ‰§è¡Œ
   - æ‰€æœ‰æ•°æ®æ­£ç¡®ä¿å­˜
   - è§’è‰²çŠ¶æ€æ­£ç¡®æ›´æ–°

### æ€§èƒ½æµ‹è¯•

**æµ‹è¯•æŒ‡æ ‡**:
- å†…å­˜ä½¿ç”¨ï¼ˆä¸è¶…è¿‡ +200MBï¼‰
- CPU ä½¿ç”¨ï¼ˆä¸è¶…è¿‡ +10%ï¼‰
- æ‰¹é‡ä¿å­˜æ—¶é—´ï¼ˆ< 500ms for 1000 entitiesï¼‰
- å…³é—­æ—¶é—´ï¼ˆ< 30sï¼‰

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§

- [ ] æ‰€æœ‰æ ¸å¿ƒç±»å®ç°å®Œæˆ
- [ ] æ‰€æœ‰æ¥å£å®šä¹‰å®Œæˆ
- [ ] é…ç½®é€‰é¡¹å®Œæ•´

### ä»£ç è´¨é‡

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 90%
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] éµå¾ªç¼–ç è§„èŒƒ

### æ€§èƒ½è¦æ±‚

- [ ] å¹¶å‘æµ‹è¯•é€šè¿‡ï¼ˆ1000+ å¹¶å‘æ“ä½œï¼‰
- [ ] å†…å­˜å ç”¨ç¬¦åˆé¢„æœŸ
- [ ] æ‰¹é‡ä¿å­˜æ€§èƒ½è¾¾æ ‡

### æ–‡æ¡£å®Œæ•´æ€§

- [ ] æ‰€æœ‰å…¬å…± API æœ‰ XML æ³¨é‡Š
- [ ] README æ›´æ–°
- [ ] é…ç½®è¯´æ˜æ–‡æ¡£

### å…¼å®¹æ€§

- [ ] ç°æœ‰ API æ¥å£ä¸å˜
- [ ] æ•°æ®æ¨¡å‹ä¸å˜
- [ ] å‘åå…¼å®¹

---

## é£é™©å’Œç¼“è§£

### é£é™© 1: æ—¶é—´ä¼°ç®—ä¸å‡†

**ç¼“è§£**:
- é¢„ç•™ 20% ç¼“å†²æ—¶é—´
- æ¯æ—¥è¿›åº¦è·Ÿè¸ª
- åŠæ—¶è°ƒæ•´è®¡åˆ’

### é£é™© 2: å¹¶å‘é—®é¢˜

**ç¼“è§£**:
- å……åˆ†çš„å¹¶å‘æµ‹è¯•
- ä½¿ç”¨æˆç†Ÿçš„å¹¶å‘å·¥å…·ï¼ˆConcurrentDictionaryï¼‰
- Code Review é‡ç‚¹å…³æ³¨çº¿ç¨‹å®‰å…¨

### é£é™© 3: é›†æˆé—®é¢˜

**ç¼“è§£**:
- åˆ†æ­¥é›†æˆæµ‹è¯•
- ä¿ç•™å›é€€æœºåˆ¶
- è¯¦ç»†æ—¥å¿—è®°å½•

---

## ä¸‹ä¸€æ­¥

å®Œæˆä¸Šç¯‡åï¼Œè¿›å…¥ä¸­ç¯‡ï¼š**é«˜é¢‘æ“ä½œè¿ç§»**

é¢„è§ˆä¸­ç¯‡æ ¸å¿ƒä»»åŠ¡ï¼š
1. è¿ç§»è§’è‰²å¿ƒè·³åˆ°å†…å­˜ç®¡ç†
2. è¿ç§»æˆ˜æ–—å¿«ç…§åˆ°å†…å­˜ç®¡ç†
3. è¿ç§»æ´»åŠ¨è®¡åˆ’åˆ°å†…å­˜ç®¡ç†
4. å…¨é¢æµ‹è¯•å’ŒéªŒè¯

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å¾…å®æ–½  
**å¼€å§‹å‰å‡†å¤‡**:
1. [ ] åˆ›å»º Feature åˆ†æ”¯
2. [ ] é…ç½®å¼€å‘ç¯å¢ƒ
3. [ ] å®¡é˜…æœ¬æ–‡æ¡£
4. [ ] åˆ†é…å¼€å‘ä»»åŠ¡
