# BlazorIdle å•†åº—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ˆä¸Šç¯‡ï¼‰
## ç³»ç»Ÿåˆ†æä¸æ¶æ„è®¾è®¡

**é¡¹ç›®**: BlazorIdle  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**ä½œè€…**: ç³»ç»Ÿæ¶æ„è®¾è®¡å›¢é˜Ÿ  

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£ä¸º BlazorIdle å•†åº—ç³»ç»Ÿçš„å®Œæ•´è®¾è®¡æ–¹æ¡ˆï¼Œæ—¨åœ¨ä¸ºæ¸¸æˆæ·»åŠ å…¨é¢çš„å•†åº—åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§äº¤æ˜“ç±»å‹å’Œæ¡ä»¶è§£é”æœºåˆ¶ã€‚

### æ–‡æ¡£ç»“æ„

- **ä¸Šç¯‡ï¼ˆæœ¬æ–‡æ¡£ï¼‰**: ç³»ç»Ÿåˆ†æä¸æ¶æ„è®¾è®¡
- **ä¸­ç¯‡**: å®æ–½è®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒ
- **ä¸‹ç¯‡**: æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡

---

## 1. æ„¿æ™¯ä¸è®¾è®¡ç›®æ ‡

### 1.1 æ„¿æ™¯

ä¸º BlazorIdle æ„å»ºä¸€ä¸ªå®Œå–„çš„å•†åº—ç³»ç»Ÿï¼Œä½¿ç©å®¶èƒ½å¤Ÿï¼š
- è´­ä¹°å„ç±»æ¸¸æˆé“å…·ï¼ˆæ¶ˆè€—å“ã€è£…å¤‡ã€ææ–™ç­‰ï¼‰
- é€šè¿‡å¤šç§è´§å¸å’Œç‰©å“è¿›è¡Œäº¤æ˜“
- ä½“éªŒæ¡ä»¶è§£é”å¸¦æ¥çš„è¿›ç¨‹æ„Ÿ
- æ„Ÿå—åŠ¨æ€åˆ·æ–°å’Œé™è´­æœºåˆ¶å¸¦æ¥çš„ç­–ç•¥æ·±åº¦

### 1.2 æ ¸å¿ƒè®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| **åŠŸèƒ½å®Œæ•´æ€§** | æ”¯æŒæ¶ˆè€—å“ã€è£…å¤‡ã€ææ–™ã€ç‰¹æ®Šç‰©å“ç­‰å…¨å“ç±»äº¤æ˜“ | â­â­â­â­â­ |
| **è´§å¸å¤šæ ·æ€§** | æ”¯æŒé‡‘å¸ã€å£°æœ›ã€ç‰¹æ®Šä»£å¸ç­‰å¤šç§è´§å¸ä½“ç³» | â­â­â­â­â­ |
| **æ¡ä»¶è§£é”** | ä¸æ¡ä»¶è§£é”DSLé›†æˆï¼Œæ”¯æŒå¤æ‚è§£é”é€»è¾‘ | â­â­â­â­â­ |
| **åŠ¨æ€åˆ·æ–°** | æ”¯æŒå®šæ—¶åˆ·æ–°ã€æ‰‹åŠ¨åˆ·æ–°ç­‰å¤šç§åˆ·æ–°ç­–ç•¥ | â­â­â­â­ |
| **é™è´­æœºåˆ¶** | æ”¯æŒå•æ¬¡ã€æ¯æ—¥ã€æ¯å‘¨ã€æ°¸ä¹…ç­‰é™è´­ç±»å‹ | â­â­â­â­ |
| **æ•°æ®é©±åŠ¨** | æ‰€æœ‰é…ç½®å¯é€šè¿‡JSON/æ•°æ®åº“é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç  | â­â­â­â­â­ |
| **æ‰©å±•æ€§** | é¢„ç•™æ¥å£æ”¯æŒæœªæ¥çš„æ‹å–è¡Œã€ç©å®¶äº¤æ˜“ç­‰åŠŸèƒ½ | â­â­â­ |
| **æ€§èƒ½ä¼˜åŒ–** | ç¼“å­˜æœºåˆ¶ã€æ‰¹é‡æ“ä½œã€å¼‚æ­¥å¤„ç† | â­â­â­â­ |

### 1.3 è®¾è®¡åŸåˆ™

1. **æœåŠ¡ç«¯æƒå¨**: æ‰€æœ‰äº¤æ˜“åˆ¤å®šã€ä»·æ ¼è®¡ç®—ã€åº“å­˜ç®¡ç†åœ¨æœåŠ¡ç«¯è¿›è¡Œ
2. **æ•°æ®é©±åŠ¨**: å•†åº—ã€å•†å“ã€ä»·æ ¼ã€æ¡ä»¶å…¨éƒ¨é…ç½®åŒ–
3. **äº‹åŠ¡å®‰å…¨**: æ‰€æœ‰è´­ä¹°æ“ä½œåœ¨æ•°æ®åº“äº‹åŠ¡ä¸­å®Œæˆï¼Œä¿è¯åŸå­æ€§
4. **å¹‚ç­‰ä¿æŠ¤**: é˜²æ­¢é‡å¤è´­ä¹°å’Œå¹¶å‘é—®é¢˜
5. **å®¡è®¡è¿½è¸ª**: å®Œæ•´è®°å½•æ‰€æœ‰äº¤æ˜“å†å²
6. **å‘åå…¼å®¹**: æ–°ç³»ç»Ÿä¸ç°æœ‰ç»æµç³»ç»Ÿã€è£…å¤‡ç³»ç»Ÿæ— ç¼é›†æˆ
7. **ä»£ç é£æ ¼ä¸€è‡´**: éµå¾ªé¡¹ç›®ç°æœ‰çš„DDDæ¶æ„å’Œå‘½åè§„èŒƒ

---

## 2. éœ€æ±‚åˆ†æ

### 2.1 æ ¸å¿ƒéœ€æ±‚æ±‡æ€»

#### åŸºç¡€äº¤æ˜“åŠŸèƒ½
- âœ… è´­ä¹°æ¶ˆè€—å“ï¼ˆé£Ÿç‰©ã€è¯å‰‚ï¼‰
- âœ… è´­ä¹°è£…å¤‡ï¼ˆå„ç±»è£…å¤‡å’Œæ­¦å™¨ï¼‰
- âœ… è´­ä¹°ææ–™å’Œåˆ¶ä½œé…æ–¹
- âœ… è´­ä¹°ç‰¹æ®Šç‰©å“ï¼ˆç¨€æœ‰é“å…·ã€å® ç‰©ã€åéª‘ç­‰ï¼‰

#### è´§å¸ç³»ç»Ÿ
- âœ… æ”¯æŒé‡‘å¸äº¤æ˜“
- âœ… æ”¯æŒå£°æœ›è´§å¸
- âœ… æ”¯æŒç‰¹æ®Šä»£å¸ï¼ˆå¦‚æˆ˜åœºå¾½ç« ã€å‰¯æœ¬ä»£å¸ï¼‰
- âœ… æ”¯æŒç‰©å“ä»¥ç‰©æ˜“ç‰©ï¼ˆç‰¹æ®Šç‰©å“äº¤æ˜“ï¼‰
- âœ… æ”¯æŒå¤åˆè´§å¸ï¼ˆå¤šç§è´§å¸ç»„åˆï¼‰

#### æ¡ä»¶è§£é”ç³»ç»Ÿ
- âœ… ç­‰çº§æ¡ä»¶ï¼ˆè§’è‰²ç­‰çº§ã€æŠ€èƒ½ç­‰çº§ï¼‰
- âœ… å£°æœ›æ¡ä»¶ï¼ˆæ´¾ç³»å£°æœ›ç­‰çº§ï¼‰
- âœ… ä»»åŠ¡æ¡ä»¶ï¼ˆå®Œæˆç‰¹å®šä»»åŠ¡ï¼‰
- âœ… æˆå°±æ¡ä»¶ï¼ˆè¾¾æˆç‰¹å®šæˆå°±ï¼‰
- âœ… ç‰©å“æ¡ä»¶ï¼ˆæ‹¥æœ‰ç‰¹å®šç‰©å“ï¼‰
- âœ… å¤åˆæ¡ä»¶ï¼ˆAND/OR/NOTé€»è¾‘ç»„åˆï¼‰

#### é™è´­ä¸åˆ·æ–°
- âœ… æ°¸ä¹…è´­ä¹°é™åˆ¶ï¼ˆä¸€æ¬¡æ€§è´­ä¹°ï¼‰
- âœ… æ¯æ—¥è´­ä¹°é™åˆ¶
- âœ… æ¯å‘¨è´­ä¹°é™åˆ¶
- âœ… åº“å­˜æ•°é‡é™åˆ¶
- âœ… å®šæ—¶åˆ·æ–°ï¼ˆæ¯æ—¥ã€æ¯å‘¨ï¼‰
- âœ… æ‰‹åŠ¨åˆ·æ–°ï¼ˆæ¶ˆè€—è´§å¸ï¼‰

### 2.2 ç°æœ‰ç³»ç»Ÿé›†æˆåˆ†æ

é¡¹ç›®å·²å…·å¤‡ä»¥ä¸‹åŸºç¡€è®¾æ–½ï¼š

1. **ç»æµç³»ç»Ÿ**
   - `InventoryItem`: èƒŒåŒ…ç‰©å“ç®¡ç†
   - `EconomyEventRecord`: ç»æµäº‹ä»¶è®°å½•ï¼ˆå¹‚ç­‰ä¿æŠ¤ï¼‰
   - `ItemDefinition`: ç‰©å“å®šä¹‰
   - `Character.Gold`: é‡‘å¸ç³»ç»Ÿ

2. **è£…å¤‡ç³»ç»Ÿ**
   - `GearDefinition`: è£…å¤‡å®šä¹‰ï¼ˆæ”¯æŒç¨€æœ‰åº¦ã€å“çº§ã€è¯æ¡ï¼‰
   - `GearInstance`: è£…å¤‡å®ä¾‹åŒ–
   - å®Œæ•´çš„17æ§½ä½è£…å¤‡ç³»ç»Ÿ

3. **å¾…é›†æˆç³»ç»Ÿ**
   - **æ¡ä»¶è§£é”DSL**: æ ¹æ®æ•´åˆè®¾è®¡æ€»ç»“è§„åˆ’ï¼Œå°†ç»Ÿä¸€ä½¿ç”¨ `ConditionExpr`
   - **å£°æœ›ç³»ç»Ÿ**: éœ€è¦æ–°å¢å£°æœ›è¿½è¸ª
   - **ä»»åŠ¡ç³»ç»Ÿ**: éœ€è¦æ–°å¢ä»»åŠ¡å®ŒæˆçŠ¶æ€è¿½è¸ª

---

## 3. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‰ç«¯å±‚ (Blazor) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•†åº—åˆ—è¡¨UI â”‚ å•†å“æµè§ˆUI â”‚ è´­ä¹°ç¡®è®¤UI â”‚ è´§å¸æ˜¾ç¤ºUI           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ APIå±‚ (Controllers) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ShopController â”‚ ItemController â”‚ PurchaseController          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åº”ç”¨å±‚ (Application) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ShopService â”‚ PurchaseService â”‚ RefreshService                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é¢†åŸŸå±‚ (Domain) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Shop Domain: ShopDefinition, ShopInstance, ShopItem           â”‚
â”‚  Purchase Domain: PurchaseOrder, PriceCalculator               â”‚
â”‚  Currency Domain: CurrencyType, CurrencyBalance                â”‚
â”‚  Unlock Domain: ConditionExpr, UnlockService                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åŸºç¡€è®¾æ–½å±‚ (Infrastructure) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Repository â”‚ DbContext â”‚ Cache â”‚ EventBus                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæ¨¡å—åˆ’åˆ†

| æ¨¡å— | èŒè´£ | å…³é”®ç»„ä»¶ |
|------|------|---------|
| **Shop Core** | å•†åº—å®šä¹‰ä¸å®ä¾‹ç®¡ç† | ShopDefinition, ShopInstance |
| **Purchase** | è´­ä¹°æµç¨‹ä¸äº‹åŠ¡ç®¡ç† | PurchaseService, PurchaseOrder |
| **Currency** | è´§å¸ç®¡ç†ä¸éªŒè¯ | CurrencyType, CurrencyBalance, CurrencyValidator |
| **Unlock** | æ¡ä»¶è§£é”ä¸æƒé™éªŒè¯ | ConditionExpr, UnlockService |
| **Refresh** | å•†åº—åˆ·æ–°ä¸åº“å­˜ç®¡ç† | RefreshService, RefreshPolicy |
| **Pricing** | ä»·æ ¼è®¡ç®—ä¸æŠ˜æ‰£ | PriceCalculator, DiscountPolicy |

---

## 4. å•†åº—ç±»å‹ç³»ç»Ÿ

### 4.1 å•†åº—ç±»å‹æšä¸¾

```csharp
public enum ShopType
{
    Regular = 0,          // å¸¸è§„å•†åº— - å›ºå®šå•†å“ï¼Œæ°¸ä¹…å¯ç”¨
    Reputation = 1,       // å£°æœ›å•†åº— - éœ€è¦å£°æœ›ç­‰çº§è§£é”
    Limited = 2,          // é™æ—¶å•†åº— - å®šæ—¶åˆ·æ–°å•†å“
    SpecialExchange = 3,  // ç‰¹æ®Šå…‘æ¢ - ç‰¹æ®Šè´§å¸æˆ–ç‰©å“å…‘æ¢
    BlackMarket = 4,      // é»‘å¸‚å•†åº— - ç¨€æœ‰å•†å“ï¼Œé«˜ä»·æ ¼
    Seasonal = 5          // å­£èŠ‚å•†åº— - ç‰¹å®šæ—¶é—´æ®µå¼€æ”¾
}
```

### 4.2 å•†åº—ç‰¹æ€§å¯¹æ¯”

| å•†åº—ç±»å‹ | å•†å“æ¥æº | åˆ·æ–°æœºåˆ¶ | è´§å¸ç±»å‹ | å…¸å‹ç”¨é€” |
|---------|---------|---------|---------|---------|
| **Regular** | å›ºå®šåˆ—è¡¨ | ä¸åˆ·æ–° | é‡‘å¸ | åŸºç¡€æ¶ˆè€—å“ã€æ™®é€šè£…å¤‡ |
| **Reputation** | å›ºå®šåˆ—è¡¨ | ä¸åˆ·æ–° | é‡‘å¸+å£°æœ› | ç¨€æœ‰è£…å¤‡ã€é«˜çº§é…æ–¹ |
| **Limited** | éšæœºæ±  | å®šæ—¶åˆ·æ–° | é‡‘å¸/ä»£å¸ | é™é‡å•†å“ã€æŠ˜æ‰£å•†å“ |
| **SpecialExchange** | å›ºå®šåˆ—è¡¨ | ä¸åˆ·æ–° | ç‰¹æ®Šä»£å¸ | å‰¯æœ¬å¥–åŠ±å…‘æ¢ |
| **BlackMarket** | éšæœºæ±  | æ‰‹åŠ¨åˆ·æ–° | é‡‘å¸ï¼ˆé«˜ä»·ï¼‰ | è¶…ç¨€æœ‰ç‰©å“ |
| **Seasonal** | å›ºå®š+éšæœº | å­£èŠ‚åˆ‡æ¢ | æ´»åŠ¨è´§å¸ | å­£èŠ‚æ€§ç‰©å“ |

---

## 5. å•†å“å®šä¹‰ç³»ç»Ÿ

### 5.1 å•†å“ç±»å‹

```csharp
public enum ShopItemType
{
    Consumable = 0,        // æ¶ˆè€—å“ - é£Ÿç‰©ã€è¯å‰‚
    Equipment = 1,         // è£…å¤‡ - æ­¦å™¨ã€æŠ¤ç”²
    Material = 2,          // ææ–™ - åˆ¶ä½œææ–™
    Recipe = 3,            // é…æ–¹ - åˆ¶ä½œé…æ–¹ã€æŠ€èƒ½ä¹¦
    CurrencyPack = 4,      // è´§å¸åŒ… - ç»éªŒã€é‡‘å¸å¢ç›Š
    SpecialItem = 5,       // ç‰¹æ®Šç‰©å“ - å® ç‰©ã€åéª‘
    EquipmentGenerator = 6 // è£…å¤‡ç”Ÿæˆå™¨ - éšæœºè£…å¤‡
}
```

### 5.2 å®šä»·ç­–ç•¥

```
å®šä»·å…¬å¼ = åŸºç¡€ä»·æ ¼ Ã— å“è´¨ç³»æ•° Ã— ç¨€æœ‰åº¦ç³»æ•° Ã— ç­‰çº§ç³»æ•°

å“è´¨ç³»æ•°:
- Common: 1.0
- Uncommon: 2.0
- Rare: 5.0
- Epic: 10.0
- Legendary: 25.0

ç¨€æœ‰åº¦ç³»æ•°:
- å¸¸è§: 1.0
- ç¨€æœ‰: 1.5
- é™é‡: 3.0
```

---

## 6. è´§å¸ä¸äº¤æ˜“ç³»ç»Ÿ

### 6.1 è´§å¸ç±»å‹

```csharp
public enum CurrencyType
{
    Gold = 0,        // é‡‘å¸ - ä¸»è¦è´§å¸
    Gems = 1,        // é’»çŸ³/å®çŸ³ - é«˜çº§è´§å¸
    Reputation = 2,  // å£°æœ›ç‚¹æ•° - æ´¾ç³»å£°æœ›
    Honor = 3,       // è£èª‰ç‚¹æ•° - PvPè´§å¸
    Justice = 4,     // æ­£ä¹‰ç‚¹æ•° - å‰¯æœ¬è´§å¸
    Valor = 5,       // å‹‡æ°”ç‚¹æ•° - é«˜çº§å‰¯æœ¬è´§å¸
    Conquest = 6,    // å¾æœç‚¹æ•° - é«˜çº§PvPè´§å¸
    EventToken = 7,  // æ´»åŠ¨ä»£å¸ - é™æ—¶æ´»åŠ¨è´§å¸
    Custom = 99      // è‡ªå®šä¹‰è´§å¸ - å¯æ‰©å±•
}
```

### 6.2 è´§å¸ç®¡ç†

```csharp
public class CurrencyBalance
{
    public Guid CharacterId { get; set; }
    public CurrencyType Type { get; set; }
    public string? CustomCurrencyId { get; set; }
    public long Balance { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

### 6.3 ä»¥ç‰©æ˜“ç‰©æœºåˆ¶

```csharp
public class BarterExchange
{
    // éœ€è¦çš„ç‰©å“ï¼ˆç‰©å“ID -> æ•°é‡ï¼‰
    public Dictionary<string, int> RequiredItems { get; set; } = new();
    
    // è·å¾—çš„ç‰©å“ï¼ˆç‰©å“ID -> æ•°é‡ï¼‰
    public Dictionary<string, int> ReceivedItems { get; set; } = new();
    
    // æ˜¯å¦æ¶ˆè€—éœ€è¦çš„ç‰©å“
    public bool ConsumeRequiredItems { get; set; } = true;
    
    // å…‘æ¢æ¯”ä¾‹ï¼ˆä¾‹å¦‚: 3:1ï¼‰
    public string? ExchangeRatio { get; set; }
}
```

---

## 7. æ¡ä»¶è§£é”ç³»ç»Ÿ

### 7.1 æ¡ä»¶è¡¨è¾¾å¼DSL

```
åŸºç¡€è¯­æ³•:
- ç­‰çº§: level >= 20
- å£°æœ›: reputation.FactionName >= 300
- ä»»åŠ¡: quest.completed('QuestId')
- æˆå°±: achievement.unlocked('AchievementId')
- ç‰©å“: item.owned('ItemId', count>=5)
- èŒä¸š: profession == 'Warrior'

é€»è¾‘ç»„åˆ:
- AND(condition1, condition2, ...)
- OR(condition1, condition2, ...)
- NOT(condition)

ç¤ºä¾‹:
1. ç®€å•: "level >= 30"
2. å£°æœ›: "reputation.merchants >= 500"
3. å¤åˆ: "AND(level >= 40, reputation.arcane >= 1000)"
4. æˆ–æ¡ä»¶: "OR(profession == 'Mage', profession == 'Warlock')"
5. å¦å®š: "NOT(quest.completed('EvilPath'))"
```

### 7.2 æ¡ä»¶è¯„ä¼°æ¥å£

```csharp
public interface IConditionEvaluator
{
    Task<bool> EvaluateAsync(string conditionExpr, Guid characterId);
    Task<Dictionary<string, bool>> EvaluateBatchAsync(List<string> exprs, Guid characterId);
    Task<string> GetFailureReasonAsync(string conditionExpr, Guid characterId);
    List<string> ParseDependencies(string conditionExpr);
}
```

---

## 8. åˆ·æ–°ä¸åº“å­˜æœºåˆ¶

### 8.1 åˆ·æ–°ç±»å‹

```csharp
public enum RefreshType
{
    None = 0,      // ä¸åˆ·æ–° - å›ºå®šå•†å“
    Daily = 1,     // æ¯æ—¥åˆ·æ–°
    Weekly = 2,    // æ¯å‘¨åˆ·æ–°
    Interval = 3,  // å®šæ—¶åˆ·æ–° - å›ºå®šé—´éš”
    Manual = 4     // æ‰‹åŠ¨åˆ·æ–° - ç©å®¶ä¸»åŠ¨
}
```

### 8.2 éšæœºå•†å“æ± 

```csharp
public class RandomItemPool
{
    public string PoolId { get; set; } = "";
    public Dictionary<string, int> Items { get; set; } = new(); // å•†å“ID -> æƒé‡
    public int ItemCountPerRefresh { get; set; } = 5;
    public bool AllowDuplicates { get; set; } = false;
    public int? GuaranteedRareAfterCount { get; set; }  // ä¿åº•æœºåˆ¶
}
```

### 8.3 è´­ä¹°é™åˆ¶

```csharp
public class ShopItemLimit
{
    public int StockQuantity { get; set; } = -1;  // -1=æ— é™
    public int MaxPurchasePerTransaction { get; set; } = 99;
    public int LifetimePurchaseLimit { get; set; } = 0;  // 0=æ— é™åˆ¶
    public int DailyPurchaseLimit { get; set; } = 0;
    public int WeeklyPurchaseLimit { get; set; } = 0;
    public int PurchaseCooldownSeconds { get; set; } = 0;
}
```

---

## 9. é¢†åŸŸæ¨¡å‹è¯¦ç»†è®¾è®¡

### 9.1 å•†åº—å®šä¹‰ï¼ˆShopDefinitionï¼‰

```csharp
public class ShopDefinition
{
    public string Id { get; set; } = "";
    public string Name { get; set; } = "";
    public string Description { get; set; } = "";
    public string Icon { get; set; } = "ğŸª";
    public ShopType Type { get; set; }
    public ShopAccessPolicy AccessPolicy { get; set; } = new();
    public ShopRefreshPolicy RefreshPolicy { get; set; } = new();
    public List<string> ItemIds { get; set; } = new();
    public RandomItemPool? RandomPool { get; set; }
    public List<string> Tags { get; set; } = new();
    public int SortOrder { get; set; } = 0;
    public bool IsEnabled { get; set; } = true;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}

public class ShopAccessPolicy
{
    public string? UnlockCondition { get; set; }
    public string? RequiredItemId { get; set; }
    public int MaxAccessCount { get; set; } = 0;  // 0=æ— é™
    public int DailyAccessLimit { get; set; } = 0;
}

public class ShopRefreshPolicy
{
    public RefreshType Type { get; set; }
    public int IntervalSeconds { get; set; }
    public DateTime? NextRefreshTime { get; set; }
    public Dictionary<string, long>? ManualRefreshCost { get; set; }
    public int ManualRefreshCooldownSeconds { get; set; }
}
```

### 9.2 å•†å“å®šä¹‰ï¼ˆShopItemDefinitionï¼‰

```csharp
public class ShopItemDefinition
{
    public string Id { get; set; } = "";
    public ShopItemType Type { get; set; }
    public string TargetItemId { get; set; } = "";
    public string? DisplayName { get; set; }
    public string? Description { get; set; }
    public string Icon { get; set; } = "ğŸ“¦";
    public Rarity Rarity { get; set; }
    public ShopItemPrice Price { get; set; } = new();
    public ShopItemLimit Limit { get; set; } = new();
    public ShopItemUnlock Unlock { get; set; } = new();
    public BarterExchange? Barter { get; set; }
    public EquipmentGeneratorConfig? EquipmentGenerator { get; set; }
    public bool IsFeatured { get; set; } = false;
    public int SortOrder { get; set; } = 0;
    public bool IsEnabled { get; set; } = true;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}

public class ShopItemPrice
{
    public Dictionary<CurrencyType, long> BasePrices { get; set; } = new();
    public Dictionary<string, int>? ItemCosts { get; set; }
    public int DiscountPercent { get; set; } = 0;
    public string? DiscountCondition { get; set; }
    public int PriceIncreasePercent { get; set; } = 0;
    public decimal MaxPriceMultiplier { get; set; } = 1.0m;
}

public class ShopItemUnlock
{
    public string? UnlockCondition { get; set; }
    public int MinLevel { get; set; } = 1;
    public Dictionary<string, int>? RequiredReputationLevels { get; set; }
    public List<string>? RequiredQuests { get; set; }
    public Dictionary<string, int>? RequiredItems { get; set; }
    public bool ShowWhenLocked { get; set; } = true;
}

public class EquipmentGeneratorConfig
{
    public string GearDefinitionId { get; set; } = "";
    public int MinItemLevel { get; set; } = 1;
    public int MaxItemLevel { get; set; } = 100;
    public List<Rarity> AllowedRarities { get; set; } = new();
    public int MinTier { get; set; } = 1;
    public int MaxTier { get; set; } = 3;
}
```

### 9.3 å•†åº—å®ä¾‹ï¼ˆShopInstanceï¼‰

```csharp
public class ShopInstance
{
    public Guid Id { get; set; }
    public string DefinitionId { get; set; } = "";
    public List<string> CurrentItemIds { get; set; } = new();
    public ShopInventory Inventory { get; set; } = new();
    public DateTime? LastAccessTime { get; set; }
    public int AccessCount { get; set; } = 0;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    public ShopDefinition? Definition { get; set; }
}

public class ShopInventory
{
    public Guid ShopId { get; set; }
    public Dictionary<string, int> Stock { get; set; } = new();  // å•†å“ID -> å‰©ä½™æ•°é‡
    public DateTime LastRefreshTime { get; set; }
    public DateTime? NextRefreshTime { get; set; }
    public int RefreshVersion { get; set; } = 0;
}
```

### 9.4 è´­ä¹°è®°å½•ï¼ˆPurchaseRecordï¼‰

```csharp
public class PurchaseRecord
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    public string ShopId { get; set; } = "";
    public string ItemId { get; set; } = "";
    public int Quantity { get; set; }
    public Dictionary<CurrencyType, long> PaidCurrencies { get; set; } = new();
    public Dictionary<string, int>? PaidItems { get; set; }
    public Dictionary<CurrencyType, long> ActualUnitPrice { get; set; } = new();
    public int DiscountPercent { get; set; } = 0;
    public DateTime PurchaseTime { get; set; } = DateTime.UtcNow;
    public string IdempotencyKey { get; set; } = "";
    public Character? Character { get; set; }
}
```

### 9.5 è´­ä¹°è®¡æ•°å™¨ï¼ˆPurchaseCounterï¼‰

```csharp
public class PurchaseCounter
{
    public Guid CharacterId { get; set; }
    public string ShopItemId { get; set; } = "";
    public int LifetimePurchaseCount { get; set; } = 0;
    public int DailyPurchaseCount { get; set; } = 0;
    public DateTime DailyResetTime { get; set; }
    public int WeeklyPurchaseCount { get; set; } = 0;
    public DateTime WeeklyResetTime { get; set; }
    public DateTime? LastPurchaseTime { get; set; }
}
```

---

## æ€»ç»“

æœ¬æ–‡æ¡£ï¼ˆä¸Šç¯‡ï¼‰å®Œæˆäº†å•†åº—ç³»ç»Ÿçš„ç³»ç»Ÿåˆ†æä¸æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… æ˜ç¡®äº†æ„¿æ™¯ä¸è®¾è®¡ç›®æ ‡
2. âœ… å®Œæˆäº†éœ€æ±‚åˆ†æ
3. âœ… è®¾è®¡äº†ç³»ç»Ÿæ¶æ„å’Œæ¨¡å—åˆ’åˆ†
4. âœ… å®šä¹‰äº†å•†åº—ç±»å‹ç³»ç»Ÿ
5. âœ… è®¾è®¡äº†å•†å“å®šä¹‰ç³»ç»Ÿ
6. âœ… è§„åˆ’äº†è´§å¸ä¸äº¤æ˜“æœºåˆ¶
7. âœ… è®¾è®¡äº†æ¡ä»¶è§£é”ç³»ç»Ÿ
8. âœ… å®šä¹‰äº†åˆ·æ–°ä¸åº“å­˜æœºåˆ¶
9. âœ… å®Œæˆäº†é¢†åŸŸæ¨¡å‹è¯¦ç»†è®¾è®¡

### ä¸‹ä¸€æ­¥

è¯·å‚é˜…ï¼š
- **ä¸­ç¯‡**: å®æ–½è®¡åˆ’ä¸æŠ€æœ¯è§„èŒƒï¼ˆPhase 1-6 è¯¦ç»†æ‰§è¡Œè®¡åˆ’ï¼‰
- **ä¸‹ç¯‡**: æµ‹è¯•éªŒè¯ä¸æ‰©å±•è®¾è®¡ï¼ˆæµ‹è¯•ç­–ç•¥ã€å‰ç«¯UIã€æ€§èƒ½ä¼˜åŒ–ï¼‰

---

**æ–‡æ¡£çŠ¶æ€**: å·²å®Œæˆ  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸  
**ç‰ˆæœ¬**: 1.0
