# BlazorIdle 商店系统设计方案（上篇）
## 系统分析与架构设计

**项目**: BlazorIdle  
**文档版本**: 1.0  
**创建日期**: 2025-10-12  
**状态**: 设计阶段  
**作者**: 系统架构设计团队  

---

## 📋 文档说明

本文档为 BlazorIdle 商店系统的完整设计方案，旨在为游戏添加全面的商店功能，支持多种交易类型和条件解锁机制。

### 文档结构

- **上篇（本文档）**: 系统分析与架构设计
- **中篇**: 实施计划与技术规范
- **下篇**: 测试验证与扩展设计

---

## 1. 愿景与设计目标

### 1.1 愿景

为 BlazorIdle 构建一个完善的商店系统，使玩家能够：
- 购买各类游戏道具（消耗品、装备、材料等）
- 通过多种货币和物品进行交易
- 体验条件解锁带来的进程感
- 感受动态刷新和限购机制带来的策略深度

### 1.2 核心设计目标

| 目标 | 描述 | 优先级 |
|------|------|--------|
| **功能完整性** | 支持消耗品、装备、材料、特殊物品等全品类交易 | ⭐⭐⭐⭐⭐ |
| **货币多样性** | 支持金币、声望、特殊代币等多种货币体系 | ⭐⭐⭐⭐⭐ |
| **条件解锁** | 与条件解锁DSL集成，支持复杂解锁逻辑 | ⭐⭐⭐⭐⭐ |
| **动态刷新** | 支持定时刷新、手动刷新等多种刷新策略 | ⭐⭐⭐⭐ |
| **限购机制** | 支持单次、每日、每周、永久等限购类型 | ⭐⭐⭐⭐ |
| **数据驱动** | 所有配置可通过JSON/数据库配置，无需修改代码 | ⭐⭐⭐⭐⭐ |
| **扩展性** | 预留接口支持未来的拍卖行、玩家交易等功能 | ⭐⭐⭐ |
| **性能优化** | 缓存机制、批量操作、异步处理 | ⭐⭐⭐⭐ |

### 1.3 设计原则

1. **服务端权威**: 所有交易判定、价格计算、库存管理在服务端进行
2. **数据驱动**: 商店、商品、价格、条件全部配置化
3. **事务安全**: 所有购买操作在数据库事务中完成，保证原子性
4. **幂等保护**: 防止重复购买和并发问题
5. **审计追踪**: 完整记录所有交易历史
6. **向后兼容**: 新系统与现有经济系统、装备系统无缝集成
7. **代码风格一致**: 遵循项目现有的DDD架构和命名规范

---

## 2. 需求分析

### 2.1 核心需求汇总

#### 基础交易功能
- ✅ 购买消耗品（食物、药剂）
- ✅ 购买装备（各类装备和武器）
- ✅ 购买材料和制作配方
- ✅ 购买特殊物品（稀有道具、宠物、坐骑等）

#### 货币系统
- ✅ 支持金币交易
- ✅ 支持声望货币
- ✅ 支持特殊代币（如战场徽章、副本代币）
- ✅ 支持物品以物易物（特殊物品交易）
- ✅ 支持复合货币（多种货币组合）

#### 条件解锁系统
- ✅ 等级条件（角色等级、技能等级）
- ✅ 声望条件（派系声望等级）
- ✅ 任务条件（完成特定任务）
- ✅ 成就条件（达成特定成就）
- ✅ 物品条件（拥有特定物品）
- ✅ 复合条件（AND/OR/NOT逻辑组合）

#### 限购与刷新
- ✅ 永久购买限制（一次性购买）
- ✅ 每日购买限制
- ✅ 每周购买限制
- ✅ 库存数量限制
- ✅ 定时刷新（每日、每周）
- ✅ 手动刷新（消耗货币）

### 2.2 现有系统集成分析

项目已具备以下基础设施：

1. **经济系统**
   - `InventoryItem`: 背包物品管理
   - `EconomyEventRecord`: 经济事件记录（幂等保护）
   - `ItemDefinition`: 物品定义
   - `Character.Gold`: 金币系统

2. **装备系统**
   - `GearDefinition`: 装备定义（支持稀有度、品级、词条）
   - `GearInstance`: 装备实例化
   - 完整的17槽位装备系统

3. **待集成系统**
   - **条件解锁DSL**: 根据整合设计总结规划，将统一使用 `ConditionExpr`
   - **声望系统**: 需要新增声望追踪
   - **任务系统**: 需要新增任务完成状态追踪

---

## 3. 系统架构设计

### 3.1 整体架构

```
┌─────────────────────── 前端层 (Blazor) ───────────────────────┐
│  商店列表UI │ 商品浏览UI │ 购买确认UI │ 货币显示UI           │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────── API层 (Controllers) ───────────────────┐
│  ShopController │ ItemController │ PurchaseController          │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────── 应用层 (Application) ──────────────────┐
│  ShopService │ PurchaseService │ RefreshService                │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────── 领域层 (Domain) ───────────────────────┐
│  Shop Domain: ShopDefinition, ShopInstance, ShopItem           │
│  Purchase Domain: PurchaseOrder, PriceCalculator               │
│  Currency Domain: CurrencyType, CurrencyBalance                │
│  Unlock Domain: ConditionExpr, UnlockService                   │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────── 基础设施层 (Infrastructure) ────────────┐
│  Repository │ DbContext │ Cache │ EventBus                     │
└───────────────────────────────────────────────────────────────┘
```

### 3.2 核心模块划分

| 模块 | 职责 | 关键组件 |
|------|------|---------|
| **Shop Core** | 商店定义与实例管理 | ShopDefinition, ShopInstance |
| **Purchase** | 购买流程与事务管理 | PurchaseService, PurchaseOrder |
| **Currency** | 货币管理与验证 | CurrencyType, CurrencyBalance, CurrencyValidator |
| **Unlock** | 条件解锁与权限验证 | ConditionExpr, UnlockService |
| **Refresh** | 商店刷新与库存管理 | RefreshService, RefreshPolicy |
| **Pricing** | 价格计算与折扣 | PriceCalculator, DiscountPolicy |

---

## 4. 商店类型系统

### 4.1 商店类型枚举

```csharp
public enum ShopType
{
    Regular = 0,          // 常规商店 - 固定商品，永久可用
    Reputation = 1,       // 声望商店 - 需要声望等级解锁
    Limited = 2,          // 限时商店 - 定时刷新商品
    SpecialExchange = 3,  // 特殊兑换 - 特殊货币或物品兑换
    BlackMarket = 4,      // 黑市商店 - 稀有商品，高价格
    Seasonal = 5          // 季节商店 - 特定时间段开放
}
```

### 4.2 商店特性对比

| 商店类型 | 商品来源 | 刷新机制 | 货币类型 | 典型用途 |
|---------|---------|---------|---------|---------|
| **Regular** | 固定列表 | 不刷新 | 金币 | 基础消耗品、普通装备 |
| **Reputation** | 固定列表 | 不刷新 | 金币+声望 | 稀有装备、高级配方 |
| **Limited** | 随机池 | 定时刷新 | 金币/代币 | 限量商品、折扣商品 |
| **SpecialExchange** | 固定列表 | 不刷新 | 特殊代币 | 副本奖励兑换 |
| **BlackMarket** | 随机池 | 手动刷新 | 金币（高价） | 超稀有物品 |
| **Seasonal** | 固定+随机 | 季节切换 | 活动货币 | 季节性物品 |

---

## 5. 商品定义系统

### 5.1 商品类型

```csharp
public enum ShopItemType
{
    Consumable = 0,        // 消耗品 - 食物、药剂
    Equipment = 1,         // 装备 - 武器、护甲
    Material = 2,          // 材料 - 制作材料
    Recipe = 3,            // 配方 - 制作配方、技能书
    CurrencyPack = 4,      // 货币包 - 经验、金币增益
    SpecialItem = 5,       // 特殊物品 - 宠物、坐骑
    EquipmentGenerator = 6 // 装备生成器 - 随机装备
}
```

### 5.2 定价策略

```
定价公式 = 基础价格 × 品质系数 × 稀有度系数 × 等级系数

品质系数:
- Common: 1.0
- Uncommon: 2.0
- Rare: 5.0
- Epic: 10.0
- Legendary: 25.0

稀有度系数:
- 常见: 1.0
- 稀有: 1.5
- 限量: 3.0
```

---

## 6. 货币与交易系统

### 6.1 货币类型

```csharp
public enum CurrencyType
{
    Gold = 0,        // 金币 - 主要货币
    Gems = 1,        // 钻石/宝石 - 高级货币
    Reputation = 2,  // 声望点数 - 派系声望
    Honor = 3,       // 荣誉点数 - PvP货币
    Justice = 4,     // 正义点数 - 副本货币
    Valor = 5,       // 勇气点数 - 高级副本货币
    Conquest = 6,    // 征服点数 - 高级PvP货币
    EventToken = 7,  // 活动代币 - 限时活动货币
    Custom = 99      // 自定义货币 - 可扩展
}
```

### 6.2 货币管理

```csharp
public class CurrencyBalance
{
    public Guid CharacterId { get; set; }
    public CurrencyType Type { get; set; }
    public string? CustomCurrencyId { get; set; }
    public long Balance { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

### 6.3 以物易物机制

```csharp
public class BarterExchange
{
    // 需要的物品（物品ID -> 数量）
    public Dictionary<string, int> RequiredItems { get; set; } = new();
    
    // 获得的物品（物品ID -> 数量）
    public Dictionary<string, int> ReceivedItems { get; set; } = new();
    
    // 是否消耗需要的物品
    public bool ConsumeRequiredItems { get; set; } = true;
    
    // 兑换比例（例如: 3:1）
    public string? ExchangeRatio { get; set; }
}
```

---

## 7. 条件解锁系统

### 7.1 条件表达式DSL

```
基础语法:
- 等级: level >= 20
- 声望: reputation.FactionName >= 300
- 任务: quest.completed('QuestId')
- 成就: achievement.unlocked('AchievementId')
- 物品: item.owned('ItemId', count>=5)
- 职业: profession == 'Warrior'

逻辑组合:
- AND(condition1, condition2, ...)
- OR(condition1, condition2, ...)
- NOT(condition)

示例:
1. 简单: "level >= 30"
2. 声望: "reputation.merchants >= 500"
3. 复合: "AND(level >= 40, reputation.arcane >= 1000)"
4. 或条件: "OR(profession == 'Mage', profession == 'Warlock')"
5. 否定: "NOT(quest.completed('EvilPath'))"
```

### 7.2 条件评估接口

```csharp
public interface IConditionEvaluator
{
    Task<bool> EvaluateAsync(string conditionExpr, Guid characterId);
    Task<Dictionary<string, bool>> EvaluateBatchAsync(List<string> exprs, Guid characterId);
    Task<string> GetFailureReasonAsync(string conditionExpr, Guid characterId);
    List<string> ParseDependencies(string conditionExpr);
}
```

---

## 8. 刷新与库存机制

### 8.1 刷新类型

```csharp
public enum RefreshType
{
    None = 0,      // 不刷新 - 固定商品
    Daily = 1,     // 每日刷新
    Weekly = 2,    // 每周刷新
    Interval = 3,  // 定时刷新 - 固定间隔
    Manual = 4     // 手动刷新 - 玩家主动
}
```

### 8.2 随机商品池

```csharp
public class RandomItemPool
{
    public string PoolId { get; set; } = "";
    public Dictionary<string, int> Items { get; set; } = new(); // 商品ID -> 权重
    public int ItemCountPerRefresh { get; set; } = 5;
    public bool AllowDuplicates { get; set; } = false;
    public int? GuaranteedRareAfterCount { get; set; }  // 保底机制
}
```

### 8.3 购买限制

```csharp
public class ShopItemLimit
{
    public int StockQuantity { get; set; } = -1;  // -1=无限
    public int MaxPurchasePerTransaction { get; set; } = 99;
    public int LifetimePurchaseLimit { get; set; } = 0;  // 0=无限制
    public int DailyPurchaseLimit { get; set; } = 0;
    public int WeeklyPurchaseLimit { get; set; } = 0;
    public int PurchaseCooldownSeconds { get; set; } = 0;
}
```

---

## 9. 领域模型详细设计

### 9.1 商店定义（ShopDefinition）

```csharp
public class ShopDefinition
{
    public string Id { get; set; } = "";
    public string Name { get; set; } = "";
    public string Description { get; set; } = "";
    public string Icon { get; set; } = "🏪";
    public ShopType Type { get; set; }
    public ShopAccessPolicy AccessPolicy { get; set; } = new();
    public ShopRefreshPolicy RefreshPolicy { get; set; } = new();
    public List<string> ItemIds { get; set; } = new();
    public RandomItemPool? RandomPool { get; set; }
    public List<string> Tags { get; set; } = new();
    public int SortOrder { get; set; } = 0;
    public bool IsEnabled { get; set; } = true;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}

public class ShopAccessPolicy
{
    public string? UnlockCondition { get; set; }
    public string? RequiredItemId { get; set; }
    public int MaxAccessCount { get; set; } = 0;  // 0=无限
    public int DailyAccessLimit { get; set; } = 0;
}

public class ShopRefreshPolicy
{
    public RefreshType Type { get; set; }
    public int IntervalSeconds { get; set; }
    public DateTime? NextRefreshTime { get; set; }
    public Dictionary<string, long>? ManualRefreshCost { get; set; }
    public int ManualRefreshCooldownSeconds { get; set; }
}
```

### 9.2 商品定义（ShopItemDefinition）

```csharp
public class ShopItemDefinition
{
    public string Id { get; set; } = "";
    public ShopItemType Type { get; set; }
    public string TargetItemId { get; set; } = "";
    public string? DisplayName { get; set; }
    public string? Description { get; set; }
    public string Icon { get; set; } = "📦";
    public Rarity Rarity { get; set; }
    public ShopItemPrice Price { get; set; } = new();
    public ShopItemLimit Limit { get; set; } = new();
    public ShopItemUnlock Unlock { get; set; } = new();
    public BarterExchange? Barter { get; set; }
    public EquipmentGeneratorConfig? EquipmentGenerator { get; set; }
    public bool IsFeatured { get; set; } = false;
    public int SortOrder { get; set; } = 0;
    public bool IsEnabled { get; set; } = true;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}

public class ShopItemPrice
{
    public Dictionary<CurrencyType, long> BasePrices { get; set; } = new();
    public Dictionary<string, int>? ItemCosts { get; set; }
    public int DiscountPercent { get; set; } = 0;
    public string? DiscountCondition { get; set; }
    public int PriceIncreasePercent { get; set; } = 0;
    public decimal MaxPriceMultiplier { get; set; } = 1.0m;
}

public class ShopItemUnlock
{
    public string? UnlockCondition { get; set; }
    public int MinLevel { get; set; } = 1;
    public Dictionary<string, int>? RequiredReputationLevels { get; set; }
    public List<string>? RequiredQuests { get; set; }
    public Dictionary<string, int>? RequiredItems { get; set; }
    public bool ShowWhenLocked { get; set; } = true;
}

public class EquipmentGeneratorConfig
{
    public string GearDefinitionId { get; set; } = "";
    public int MinItemLevel { get; set; } = 1;
    public int MaxItemLevel { get; set; } = 100;
    public List<Rarity> AllowedRarities { get; set; } = new();
    public int MinTier { get; set; } = 1;
    public int MaxTier { get; set; } = 3;
}
```

### 9.3 商店实例（ShopInstance）

```csharp
public class ShopInstance
{
    public Guid Id { get; set; }
    public string DefinitionId { get; set; } = "";
    public List<string> CurrentItemIds { get; set; } = new();
    public ShopInventory Inventory { get; set; } = new();
    public DateTime? LastAccessTime { get; set; }
    public int AccessCount { get; set; } = 0;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    public ShopDefinition? Definition { get; set; }
}

public class ShopInventory
{
    public Guid ShopId { get; set; }
    public Dictionary<string, int> Stock { get; set; } = new();  // 商品ID -> 剩余数量
    public DateTime LastRefreshTime { get; set; }
    public DateTime? NextRefreshTime { get; set; }
    public int RefreshVersion { get; set; } = 0;
}
```

### 9.4 购买记录（PurchaseRecord）

```csharp
public class PurchaseRecord
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    public string ShopId { get; set; } = "";
    public string ItemId { get; set; } = "";
    public int Quantity { get; set; }
    public Dictionary<CurrencyType, long> PaidCurrencies { get; set; } = new();
    public Dictionary<string, int>? PaidItems { get; set; }
    public Dictionary<CurrencyType, long> ActualUnitPrice { get; set; } = new();
    public int DiscountPercent { get; set; } = 0;
    public DateTime PurchaseTime { get; set; } = DateTime.UtcNow;
    public string IdempotencyKey { get; set; } = "";
    public Character? Character { get; set; }
}
```

### 9.5 购买计数器（PurchaseCounter）

```csharp
public class PurchaseCounter
{
    public Guid CharacterId { get; set; }
    public string ShopItemId { get; set; } = "";
    public int LifetimePurchaseCount { get; set; } = 0;
    public int DailyPurchaseCount { get; set; } = 0;
    public DateTime DailyResetTime { get; set; }
    public int WeeklyPurchaseCount { get; set; } = 0;
    public DateTime WeeklyResetTime { get; set; }
    public DateTime? LastPurchaseTime { get; set; }
}
```

---

## 总结

本文档（上篇）完成了商店系统的系统分析与架构设计，包括：

1. ✅ 明确了愿景与设计目标
2. ✅ 完成了需求分析
3. ✅ 设计了系统架构和模块划分
4. ✅ 定义了商店类型系统
5. ✅ 设计了商品定义系统
6. ✅ 规划了货币与交易机制
7. ✅ 设计了条件解锁系统
8. ✅ 定义了刷新与库存机制
9. ✅ 完成了领域模型详细设计

### 下一步

请参阅：
- **中篇**: 实施计划与技术规范（Phase 1-6 详细执行计划）
- **下篇**: 测试验证与扩展设计（测试策略、前端UI、性能优化）

---

**文档状态**: 已完成  
**审核状态**: 待审核  
**版本**: 1.0
