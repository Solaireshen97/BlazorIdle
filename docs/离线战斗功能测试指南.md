# 离线战斗功能测试指南

## 🧪 概述

本文档提供离线战斗功能的手动测试指南，帮助验证实现是否符合预期。

---

## 📋 测试前准备

### 1. 启动应用

```bash
cd /home/runner/work/BlazorIdle/BlazorIdle
dotnet run --project BlazorIdle.Server
```

### 2. 登录账号

1. 打开浏览器访问 `http://localhost:5000`
2. 注册/登录账号
3. 创建或选择一个角色

---

## 🔬 测试用例

### 测试用例 1: 无离线时间场景

**目的**：验证刚登录时不会弹窗

**步骤**：
1. 登录账号
2. 立即观察页面

**预期结果**：
- ✅ 不显示离线收益弹窗
- ✅ 正常显示角色信息

---

### 测试用例 2: 短时间离线（无计划）

**目的**：验证离线但无运行计划时不弹窗

**步骤**：
1. 登录账号，选择角色
2. 不创建任何计划
3. 关闭浏览器，等待 1 分钟
4. 重新打开浏览器，登录

**预期结果**：
- ✅ 不显示离线收益弹窗（因为没有运行中的计划）
- ✅ LastSeenAtUtc 已更新

---

### 测试用例 3: 短时间离线（有运行计划）⭐

**目的**：验证基本离线战斗流程

**步骤**：
1. 登录账号，选择角色
2. 创建一个 5 分钟的战斗计划
3. 等待计划开始运行（状态变为"执行中"）
4. 等待约 30 秒，确保计划有进度
5. **关键步骤**：关闭浏览器标签页
6. 等待 1 分钟（模拟离线）
7. 重新打开浏览器，登录

**预期结果**：
- ✅ 显示离线收益弹窗
- ✅ 显示离线时长约 "0小时1分钟"
- ✅ 显示金币、经验、伤害、击杀数（非零）
- ✅ 显示"活动计划继续进行中..."提示
- ✅ 点击"确认领取"后，角色金币和经验增加
- ✅ 战斗计划继续运行

**验证点**：
```
弹窗显示示例：
🎉 欢迎回来！离线收益结算
离线时长: 0小时1分钟
💰 金币: +150 （根据实际战斗情况）
⭐ 经验: +200
⚔️ 总伤害: 12000
💀 击杀数: 3
⏳ 活动计划继续进行中...
```

---

### 测试用例 4: 无感继承效果验证 ⭐⭐⭐

**目的**：验证离线计算从当前进度继续（最重要的测试）

**步骤**：
1. 登录账号，选择角色
2. 创建一个 **10 分钟** (600秒) 的战斗计划
3. 等待计划开始运行
4. 等待约 **2 分钟**，观察"执行时长"显示约 120 秒
5. **记录当前执行时长**：例如 120 秒
6. **关键步骤**：立即关闭浏览器
7. 等待 **3 分钟**（180秒）
8. 重新打开浏览器，登录

**预期结果**：
- ✅ 显示离线收益弹窗
- ✅ 离线时长约 "0小时3分钟"
- ✅ 模拟时长约 180 秒
- ✅ **关键验证**：点击"确认领取"后，查看计划列表
  - 执行时长应该约为 120 + 180 = 300 秒（5分钟）
  - 而不是重新开始的 180 秒
- ✅ 计划状态仍为"执行中"（因为总共10分钟还没完成）

**验证方法**：
```
离线前：ExecutedSeconds ≈ 120 秒
离线时长：180 秒
离线后：ExecutedSeconds ≈ 300 秒 ← 证明从120秒继续计算
```

---

### 测试用例 5: 计划在离线期间完成

**目的**：验证计划完成判断和自动衔接

**步骤**：
1. 登录账号，选择角色
2. 创建一个 **3 分钟** (180秒) 的战斗计划
3. 等待计划开始运行
4. 等待约 **1 分钟**
5. 关闭浏览器
6. 等待 **3 分钟**（比剩余时间长）
7. 重新打开浏览器，登录

**预期结果**：
- ✅ 显示离线收益弹窗
- ✅ 显示"✅ 活动计划已完成！"提示
- ✅ 点击"确认领取"后，查看计划列表
  - 计划状态变为"已完成"
  - ExecutedSeconds ≥ 180 秒
- ✅ 如果创建了第二个计划，应该显示"已自动开始下一个计划"

**可选步骤**（测试自动衔接）：
- 在步骤2后，再创建一个待执行的战斗计划
- 离线期间第一个计划完成后，应自动启动第二个
- 弹窗应该显示"已自动开始下一个计划"

---

### 测试用例 6: 心跳更新验证

**目的**：验证心跳机制正常工作

**步骤**：
1. 登录账号，选择角色
2. 创建并启动一个战斗计划
3. 观察计划列表，保持页面打开约 10 秒
4. 使用数据库工具查看 Character 表的 LastSeenAtUtc 字段

**预期结果**：
- ✅ LastSeenAtUtc 每 2 秒更新一次
- ✅ 时间戳持续推进

**数据库查询**（可选）：
```sql
SELECT Id, Name, LastSeenAtUtc 
FROM Characters 
WHERE Id = 'your-character-id';
```

---

### 测试用例 7: 长时间离线（12小时上限）

**目的**：验证 12 小时离线时长上限

**注意**：此测试需要较长时间，可以使用数据库直接修改

**模拟步骤**：
1. 创建并启动一个无限制战斗计划
2. 使用数据库工具修改 LastSeenAtUtc
   ```sql
   UPDATE Characters 
   SET LastSeenAtUtc = DATEADD(HOUR, -24, GETUTCDATE())
   WHERE Id = 'your-character-id';
   ```
3. 刷新页面或重新登录

**预期结果**：
- ✅ 离线时长显示约 "24小时0分钟"（或接近）
- ✅ 但**模拟时长**只有约 43200 秒（12小时）
- ✅ 收益只计算 12 小时的战斗

**验证方法**：
- 检查弹窗中的"模拟时长"字段
- 应该 ≤ 43200 秒

---

### 测试用例 8: 弹窗交互

**目的**：验证用户交互功能

**步骤**：
1. 触发离线收益弹窗（使用测试用例 3）
2. 测试以下交互：
   - 点击"稍后"按钮
   - 点击右上角关闭按钮 (X)
   - 点击"确认领取"按钮

**预期结果**：
- ✅ 点击"稍后"：弹窗关闭，收益未发放
- ✅ 点击关闭 (X)：弹窗关闭，收益未发放
- ✅ 点击"确认领取"：
  - 弹窗关闭
  - 角色金币、经验增加
  - 显示"离线收益已领取！"消息

**二次检查**：
- 关闭弹窗后不再领取，再次刷新页面
- ✅ 不应该再次显示离线收益弹窗（因为 LastSeenAtUtc 已更新）

---

## 🐛 常见问题排查

### 问题 1: 离线后没有弹窗

**可能原因**：
1. 没有运行中的计划
2. LastSeenAtUtc 未设置
3. 前端 API 调用失败

**排查步骤**：
1. 检查计划列表，确保有"执行中"状态的计划
2. 打开浏览器开发者工具（F12），查看 Console 是否有错误
3. 检查 Network 标签，确认 `/api/offline/check` 调用成功
4. 查看返回的 JSON 数据，确认 HasOfflineTime 和 HasRunningPlan 为 true

### 问题 2: 执行时长不对（无感继承失败）

**排查步骤**：
1. 记录离线前的 ExecutedSeconds
2. 记录离线时长
3. 检查离线后的 ExecutedSeconds = 离线前 + 离线时长
4. 查看后端日志，确认 OfflineFastForwardEngine.FastForward 被调用

### 问题 3: 心跳不更新

**排查步骤**：
1. 确保有运行中的计划（心跳集成在计划轮询中）
2. 打开开发者工具 Network，观察是否每 2 秒调用 `/api/characters/{id}/heartbeat`
3. 检查 API 响应是否成功（200 OK）

### 问题 4: 收益不合理

**排查步骤**：
1. 检查敌人配置（dummy 的金币和经验掉落）
2. 检查离线时长和模拟时长
3. 计算预期击杀数 = 模拟时长 / TTK（Time To Kill）
4. 验证金币 ≈ 击杀数 × 单个敌人金币

---

## 📊 测试检查清单

使用此清单跟踪测试进度：

- [ ] 测试用例 1: 无离线时间场景
- [ ] 测试用例 2: 短时间离线（无计划）
- [ ] 测试用例 3: 短时间离线（有运行计划）⭐
- [ ] 测试用例 4: 无感继承效果验证 ⭐⭐⭐
- [ ] 测试用例 5: 计划在离线期间完成
- [ ] 测试用例 6: 心跳更新验证
- [ ] 测试用例 7: 长时间离线（12小时上限）
- [ ] 测试用例 8: 弹窗交互

---

## 🎯 关键验证点

### 1. 无感继承（最重要）
- ✅ 离线前的进度被保留
- ✅ 离线计算从当前进度继续
- ✅ 不会重新开始战斗

### 2. 心跳机制
- ✅ 每 2 秒更新一次 LastSeenAtUtc
- ✅ 集成在计划轮询中
- ✅ 失败不影响主流程

### 3. 用户体验
- ✅ 登录时自动检查
- ✅ 弹窗展示清晰
- ✅ 用户可以选择确认或稍后
- ✅ 确认后收益正确发放

### 4. 边界条件
- ✅ 无离线时间不弹窗
- ✅ 无运行计划不弹窗
- ✅ 12 小时上限生效
- ✅ 计划完成自动衔接

---

## 📝 测试报告模板

完成测试后，可以使用以下模板记录结果：

```markdown
## 离线战斗功能测试报告

**测试日期**: YYYY-MM-DD
**测试人**: [Your Name]
**环境**: [Development/Staging/Production]

### 测试结果

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 1. 无离线时间 | ✅/❌ | |
| 2. 离线无计划 | ✅/❌ | |
| 3. 短时间离线 | ✅/❌ | |
| 4. 无感继承 ⭐ | ✅/❌ | |
| 5. 计划完成 | ✅/❌ | |
| 6. 心跳更新 | ✅/❌ | |
| 7. 12小时上限 | ✅/❌ | |
| 8. 弹窗交互 | ✅/❌ | |

### 发现的问题

1. [问题描述]
   - 重现步骤：
   - 预期结果：
   - 实际结果：

### 总体评价

[通过/需修复/待优化]

### 建议

[改进建议]
```

---

**文档结束**

*最后更新: 2025-01-08*
*作者: GitHub Copilot with Solaireshen97*
