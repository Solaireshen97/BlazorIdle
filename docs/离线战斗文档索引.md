# 离线战斗系统文档索引

本目录包含离线战斗系统的完整实施文档。

---

## 📚 文档列表

### 1. 离线暂停恢复功能（最新）⭐
**文件**: `离线暂停恢复功能说明.md` | `OfflinePauseResumeFeature.md`

**适合人群**: 想了解离线玩家任务暂停和恢复机制

**内容**:
- ✅ 离线检测与任务暂停机制
- ✅ 任务状态机（新增 Paused 状态）
- ✅ 暂停与停止的区别
- ✅ 玩家上线时的任务恢复
- ✅ 服务器重启后的任务恢复
- ✅ 配置说明和使用场景
- ✅ 测试建议和故障排查

**阅读时间**: 15分钟

---

### 2. 快速开始（推荐先看）
**文件**: `离线战斗快速开始.md`

**适合人群**: 开发者想快速了解如何实现

**内容**:
- ✅ 5分钟快速了解核心概念
- ✅ 需要新增的代码清单（带代码框架）
- ✅ 实施步骤（按顺序）
- ✅ 测试方法
- ✅ 常见问题

**阅读时间**: 10分钟

---

### 2. 实施总结（中文简化版）
**文件**: `离线战斗系统实施总结.md`

**适合人群**: 想要完整理解但不想读太长文档

**内容**:
- ✅ 核心需求说明
- ✅ 已有组件与缺失组件对比
- ✅ 详细实施步骤（带代码示例）
- ✅ 完整流程示例（带时间轴）
- ✅ 数据模型定义
- ✅ 配置项说明
- ✅ 测试要点
- ✅ 预估工作量

**阅读时间**: 20-30分钟

---

### 3. 流程图文档
**文件**: `离线战斗流程图.md`

**适合人群**: 视觉学习者，需要理解完整流程

**内容**:
- ✅ 用户上线完整流程图
- ✅ 后端离线收益计算详细流程
- ✅ OfflineFastForwardEngine 快进流程
- ✅ 活动计划自动衔接流程
- ✅ 前端用户交互流程
- ✅ 时间轴示例（带真实场景）
- ✅ 边界情况处理

**阅读时间**: 15分钟

---

### 4. 详细实施方案（完整版，英文）
**文件**: `OfflineBattleImplementationPlan.md`

**适合人群**: 架构师、技术负责人

**内容**:
- ✅ 完整需求分析
- ✅ 当前实现状态详细分析
- ✅ 缺失组件清单（带优先级）
- ✅ 分阶段详细实施方案（Phase 1-4）
- ✅ 数据库变更方案
- ✅ API设计（带请求/响应示例）
- ✅ 前端集成方案
- ✅ 测试验证计划
- ✅ 风险与注意事项
- ✅ 实施优先级建议

**阅读时间**: 45-60分钟

---

## 🎯 推荐阅读顺序

### 场景1: 我是开发者，想快速开始实施
1. 📖 先读 `离线战斗快速开始.md` (10分钟)
2. 📖 参考 `离线战斗流程图.md` 理解流程 (15分钟)
3. 💻 开始编码
4. 📖 遇到问题时查阅 `离线战斗系统实施总结.md`

**总时间**: 25分钟阅读 + 实施

---

### 场景2: 我是技术负责人，需要评估工作量
1. 📖 先读 `离线战斗系统实施总结.md` (30分钟)
2. 📖 查看 `OfflineBattleImplementationPlan.md` 的"实施优先级建议"章节
3. 📖 查看"预估工作量"和"风险与注意事项"
4. 💼 制定开发计划

**总时间**: 45分钟

---

### 场景3: 我想全面了解系统设计
1. 📖 先读 `OfflineBattleImplementationPlan.md` 完整版 (60分钟)
2. 📖 结合 `离线战斗流程图.md` 理解流程细节 (15分钟)
3. 📖 参考 `离线战斗系统实施总结.md` 的数据模型和配置
4. 💼 形成完整技术方案

**总时间**: 90分钟

---

## 📋 核心概念速查

### 关键类/服务

| 类名 | 文件位置 | 状态 | 说明 |
|------|---------|------|------|
| `OfflineFastForwardEngine` | `Application/Battles/Offline/` | ❌ 需新增 | 离线快进引擎 |
| `OfflineSettlementService` | `Application/Battles/Offline/Offline.cs` | 🟡 需扩展 | 离线结算服务 |
| `ActivityPlan` | `Domain/Activities/` | ✅ 已完成 | 活动计划模型 |
| `BattleSimulator` | `Application/Battles/` | ✅ 已完成 | 战斗模拟器 |

### 关键API端点

| 端点 | 方法 | 状态 | 说明 |
|------|------|------|------|
| `/api/offline/check` | GET | ❌ 需新增 | 检查离线收益 |
| `/api/offline/apply` | POST | ❌ 需新增 | 应用离线结算 |
| `/api/characters/{id}/heartbeat` | POST | ❌ 需新增 | 更新心跳 |

### 关键前端组件

| 组件 | 文件 | 状态 | 说明 |
|------|------|------|------|
| `OfflineSettlementDialog` | `Components/OfflineSettlementDialog.razor` | ❌ 需新增 | 离线结算弹窗 |
| `ApiClient` 离线方法 | `Services/ApiClient.cs` | ❌ 需扩展 | 离线API调用 |
| `Characters` 离线检查 | `Pages/Characters.razor` | ❌ 需修改 | 集成离线检查 |

---

## 🔧 开发环境要求

- .NET 8.0 SDK
- Entity Framework Core (已配置)
- SQLite (已使用)
- Blazor WebAssembly (已配置)

---

## 📊 数据模型速查

### OfflineFastForwardResult
用于返回离线快进模拟结果

**字段**:
- `CharacterId`: 角色ID
- `PlanId`: 活动计划ID
- `SimulatedSeconds`: 实际模拟时长
- `PlanCompleted`: 计划是否完成
- `Gold`: 金币收益
- `Exp`: 经验收益
- `Loot`: 物品掉落字典

### OfflineCheckResult
用于返回离线检查结果（包含是否有离线时间）

**字段**:
- `HasOfflineTime`: 是否有离线时间
- `OfflineSeconds`: 离线总时长
- `HasRunningPlan`: 是否有运行计划
- `Settlement`: 结算结果（OfflineFastForwardResult）
- `PlanCompleted`: 计划是否完成
- `NextPlanStarted`: 是否启动下一个计划
- `NextPlanId`: 下一个计划ID

---

## ⚙️ 配置速查

**文件**: `appsettings.json`

```json
{
  "Offline": {
    "MaxOfflineSeconds": 43200,  // 12小时上限（可调整）
    "EnableAutoSettlement": true  // 是否启用自动结算
  }
}
```

---

## 🧪 测试检查清单

### 单元测试
- [ ] OfflineFastForwardEngine 时长上限测试
- [ ] 计划剩余时长计算测试
- [ ] Infinite vs Duration 计划测试
- [ ] 计划完成状态判断测试

### 集成测试
- [ ] 完整离线流程测试（创建→下线→上线→领取）
- [ ] 计划未完成继续执行测试
- [ ] 自动衔接下一个计划测试
- [ ] 超过12小时上限测试

### 前端测试
- [ ] 离线弹窗显示正确
- [ ] 收益数据展示正确
- [ ] 点击领取后数据更新
- [ ] 计划完成提示显示

---

## 📞 获取帮助

如果在实施过程中遇到问题：

1. **代码实现问题**: 参考 `离线战斗快速开始.md` 的代码框架
2. **流程理解问题**: 查看 `离线战斗流程图.md`
3. **详细设计问题**: 阅读 `OfflineBattleImplementationPlan.md`
4. **数据模型问题**: 查看 `离线战斗系统实施总结.md` 的数据模型章节

---

## 📈 实施里程碑

### Milestone 1: 后端核心 (2-3天)
- [ ] OfflineFastForwardEngine 实现
- [ ] OfflineSettlementService 扩展
- [ ] API端点添加
- [ ] 单元测试完成

### Milestone 2: 前端集成 (1-2天)
- [ ] OfflineSettlementDialog 组件
- [ ] ApiClient 扩展
- [ ] Characters 页面集成
- [ ] 前端测试完成

### Milestone 3: 测试与优化 (1-2天)
- [ ] 集成测试完成
- [ ] 手动测试验证
- [ ] 性能优化
- [ ] 文档更新

**总预估**: 4-7天

---

## �� 完成标志

系统实施完成的标志：
- ✅ 用户下线后再上线能看到离线收益弹窗
- ✅ 离线收益数据准确（金币、经验、击杀）
- ✅ 点击领取后角色数据正确更新
- ✅ 活动计划状态正确（完成/继续）
- ✅ 如果计划完成，下一个计划自动启动
- ✅ 所有测试通过

---

**祝实施顺利！** 🚀

有任何问题，参考上述文档或联系技术负责人。
