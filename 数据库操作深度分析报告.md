# BlazorIdle æ•°æ®åº“æ“ä½œæ·±åº¦åˆ†ææŠ¥å‘Š

**é¡¹ç›®åç§°**: BlazorIdle æœåŠ¡ç«¯æ•°æ®åº“æ“ä½œæ·±åº¦åˆ†æ  
**åˆ†ææ—¥æœŸ**: 2025-10-19  
**åˆ†æç›®æ ‡**: è¯„ä¼°å½“å‰æ•°æ®åº“æ“ä½œçŠ¶æ€ï¼Œè®¾è®¡è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹æ¡ˆ  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹ BlazorIdle é¡¹ç›®çš„æ•°æ®åº“æ“ä½œè¿›è¡Œäº†å…¨é¢æ·±åº¦åˆ†æã€‚é¡¹ç›®å·²å®Œæˆä¸¤è½®é‡è¦ä¼˜åŒ–ï¼š
1. **æ•°æ®åº“å†™å…¥ä¼˜åŒ–** (Phase 1-3): å®ç°å†…å­˜ç¼“å†²æœºåˆ¶ï¼Œå‡å°‘å†™å…¥æ“ä½œ 97.9%
2. **æ•°æ®åº“è¯»å–ä¼˜åŒ–** (Phase 1-3): å®ç°ç¼“å­˜ä¼˜å…ˆç­–ç•¥ï¼Œå‡å°‘è¯»å–æ“ä½œ 85.4%

æ€»ä½“æ•°æ®åº“ I/O æ“ä½œå·²å‡å°‘ **94.9%**ï¼Œè¿™æ˜¯ä¸€ä¸ªå“è¶Šçš„æˆæœã€‚

æœ¬æŠ¥å‘Šå°†ï¼š
- æ·±å…¥åˆ†æå½“å‰å®æ–½çŠ¶æ€å’Œä»£ç è´¨é‡
- è¯†åˆ«è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´
- è®¾è®¡å¯é€‰çš„é«˜çº§ä¼˜åŒ–æ–¹æ¡ˆ
- æä¾›åˆ†é˜¶æ®µå®æ–½è®¡åˆ’å’ŒéªŒæ”¶æ ‡å‡†

---

## ğŸ“Š ç¬¬ä¸€éƒ¨åˆ†ï¼šå½“å‰çŠ¶æ€å…¨é¢è¯„ä¼°

### 1.1 é¡¹ç›®æ•´ä½“æ¶æ„ç†è§£

åŸºäºã€Šæ•´åˆè®¾è®¡æ€»ç»“.txtã€‹çš„åˆ†æï¼š

**æ ¸å¿ƒå®šä½**: æœåŠ¡ç«¯æƒå¨ + æ”¾ç½®å¾ªç¯ + æ„ç­‘æ·±åº¦çš„ Web RPG

**å…³é”®æ¶æ„ç‰¹å¾**:
1. **æ—¶é—´é©±åŠ¨ç³»ç»Ÿ**: Event Time Jump ç»Ÿä¸€æ¨è¿›æ‰€æœ‰å¾ªç¯
2. **åŒè½¨æˆ˜æ–—èŠ‚å¥**: Attack Track + Special Track
3. **æ•°æ®é©±åŠ¨è®¾è®¡**: æŠ€èƒ½ã€æ‰è½ã€æ¡ä»¶ã€è£…å¤‡è¯æ¡ç­‰é…ç½®åŒ–
4. **ç¦»çº¿ä¸€è‡´æ€§**: åœ¨çº¿/ç¦»çº¿ä½¿ç”¨åŒä¸€è°ƒåº¦ç®—æ³•
5. **DDD åˆ†å±‚æ¶æ„**: Domain â†’ Application â†’ Infrastructure

**é¢†åŸŸæ¨¡å—çŸ©é˜µ**:
- Activity: æ´»åŠ¨è®¡åˆ’/å¤šæ§½è°ƒåº¦
- Combat: æˆ˜æ–—å®ä¾‹/äº‹ä»¶/åŒè½¨/èšåˆ
- Skills: æŠ€èƒ½å®šä¹‰/èµ„æºæ¶ˆè€—/ä¼˜å…ˆé‡Šæ”¾
- Equipment & Gear: è£…å¤‡å®ä¾‹/è¯æ¡/å“çº§/å¥—è£…
- Economy: äº§å‡º/æ¶ˆè€—/åˆ†è§£/é‡é“¸
- Persistence: äº‹ä»¶ + å¿«ç…§
- Monitoring: æŒ‡æ ‡/æ—¥å¿—/è°ƒè¯•

### 1.2 æ•°æ®åº“æ“ä½œç°çŠ¶åˆ†æ

#### 1.2.1 å·²å®æ–½çš„å†™å…¥ä¼˜åŒ– (Phase 1-3)

**æ ¸å¿ƒç»„ä»¶**:

1. **MemoryStateManager<T>** (å†…å­˜çŠ¶æ€ç®¡ç†å™¨)
   - çº¿ç¨‹å®‰å…¨çš„å†…å­˜å­˜å‚¨ (ConcurrentDictionary)
   - Dirty è¿½è¸ªæœºåˆ¶
   - LRU ç¼“å­˜æ¸…ç†
   - TTL æ¸…ç†ç­–ç•¥
   - å¿«ç…§éš”ç¦»
   - ç¼“å­˜ç»Ÿè®¡ (å‘½ä¸­ç‡/æœªå‘½ä¸­ç‡)

2. **PersistenceCoordinator** (æŒä¹…åŒ–åè°ƒå™¨)
   - BackgroundService å®šæœŸæ‰¹é‡ä¿å­˜
   - åˆ†å®ä½“ç±»å‹ä¿å­˜ç­–ç•¥
   - å¤±è´¥è‡ªåŠ¨é‡è¯• (æŒ‡æ•°é€€é¿)
   - å¼ºåˆ¶ä¿å­˜é˜ˆå€¼
   - å…³é—­æ—¶æœ€ç»ˆä¿å­˜

3. **EnhancedShutdownManager** (å¢å¼ºå…³é—­ç®¡ç†å™¨)
   - é›†æˆ PersistenceCoordinator æœ€ç»ˆä¿å­˜
   - è®¾ç½®æ‰€æœ‰è§’è‰²ä¸ºç¦»çº¿
   - å¼ºåˆ¶æ‰§è¡Œ WAL æ£€æŸ¥ç‚¹
   - è¶…æ—¶ä¿æŠ¤

**å·²ä¼˜åŒ–çš„é«˜é¢‘æ“ä½œ**:
- âœ… è§’è‰²å¿ƒè·³ (100ç©å®¶): 18,000 â†’ 1,200 æ¬¡/å°æ—¶ (-93.3%)
- âœ… æˆ˜æ–—å¿«ç…§ (10æˆ˜æ–—): 72,000 â†’ 600 æ¬¡/å°æ—¶ (-99.2%)
- âœ… æ´»åŠ¨è®¡åˆ’: 3,000 â†’ 120 æ¬¡/å°æ—¶ (-96.0%)
- **æ€»å†™å…¥**: 93,000 â†’ 1,920 æ¬¡/å°æ—¶ (**-97.9%**)

#### 1.2.2 å·²å®æ–½çš„è¯»å–ä¼˜åŒ– (Phase 1-3)

**æ ¸å¿ƒç»„ä»¶**:

1. **CacheCoordinator** (ç¼“å­˜åè°ƒå™¨)
   - å¯åŠ¨æ—¶é¢„åŠ è½½é™æ€é…ç½®æ•°æ®
   - å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
   - æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜æ¥å£
   - ç¼“å­˜ç›‘æ§æŒ‡æ ‡

2. **Repository ç¼“å­˜é›†æˆ**
   - CharacterRepository: ç¼“å­˜ä¼˜å…ˆè¯»å–
   - GearDefinitionRepository: æ°¸ä¹…ç¼“å­˜
   - AffixRepository: æ°¸ä¹…ç¼“å­˜
   - GearSetRepository: æ°¸ä¹…ç¼“å­˜
   - GearInstanceRepository: ä¸´æ—¶ç¼“å­˜
   - ActivityPlanRepository: ä¸´æ—¶ç¼“å­˜

**ç¼“å­˜ç­–ç•¥é…ç½®**:
| å®ä½“ç±»å‹ | ç­–ç•¥ | TTL | é¢„åŠ è½½ | é¢„æœŸå‘½ä¸­ç‡ |
|---------|------|-----|--------|-----------|
| GearDefinition | Permanent | 24h | âœ… | 95-100% |
| Affix | Permanent | 24h | âœ… | 95-100% |
| GearSet | Permanent | 24h | âœ… | 95-100% |
| Character | Temporary | 1h | âŒ | 80-90% |
| GearInstance | Temporary | 30min | âŒ | 70-85% |
| ActivityPlan | Temporary | 15min | âŒ | 75-90% |
| BattleSnapshot | Temporary | 10min | âŒ | 70-85% |

**è¯»å–ä¼˜åŒ–æ•ˆæœ**:
- è¯»å–æ“ä½œ: ~55,000 â†’ â‰¤8,050 æ¬¡/å°æ—¶ (**-85.4%**)
- æ€» I/O: ~148,000 â†’ ~7,500 æ¬¡/å°æ—¶ (**-94.9%**)

#### 1.2.3 é…ç½®åŒ–å®Œæˆåº¦è¯„ä¼°

**âœ… å·²å®Œå…¨é…ç½®åŒ–çš„éƒ¨åˆ†**:

1. **Persistence é…ç½®** (å†™å…¥ä¼˜åŒ–):
```json
{
  "EnableMemoryBuffering": true,
  "SaveIntervalMs": 30000,
  "MaxBatchSize": 1000,
  "ForceSaveThreshold": 5000,
  "SaveRetryAttempts": 3,
  "EntitySaveStrategies": {
    "BattleSnapshot": { "SaveIntervalMs": 60000 },
    "CharacterHeartbeat": { "SaveIntervalMs": 300000 },
    "ActivityPlan": { "SaveIntervalMs": 30000 }
  }
}
```

2. **CacheConfiguration é…ç½®** (è¯»å–ä¼˜åŒ–):
```json
{
  "EntityStrategies": {
    "GearDefinition": {
      "Strategy": "Permanent",
      "PreloadOnStartup": true,
      "MaxCachedCount": 10000,
      "TtlSeconds": 86400
    },
    // ... 7ç§å®ä½“ç±»å‹çš„è¯¦ç»†ç­–ç•¥
  },
  "GlobalSettings": {
    "EnableReadCaching": true,
    "CleanupIntervalMinutes": 5,
    "TrackCacheHitRate": true
  }
}
```

3. **Monitoring é…ç½®**:
```json
{
  "MaxRecentOperations": 100,
  "EnableDetailedLogging": false,
  "CacheMonitoring": {
    "EnableCacheMetrics": true,
    "CacheHitRateThreshold": 70.0
  }
}
```

**âœ… é…ç½®åŒ–çš„ä¼˜ç‚¹**:
- é›¶ç¡¬ç¼–ç å‚æ•°
- ç¯å¢ƒç‰¹å®šé…ç½®æ”¯æŒ
- DataAnnotations éªŒè¯
- IValidateOptions é«˜çº§éªŒè¯
- è¿è¡Œæ—¶é…ç½®çƒ­æ›´æ–°ï¼ˆéƒ¨åˆ†æ”¯æŒï¼‰

### 1.3 ä»£ç è´¨é‡è¯„ä¼°

**âœ… ä»£ç è§„èŒƒéµå®ˆ**:
- âœ… PascalCase ç±»å/æ–¹æ³•å/å±æ€§
- âœ… camelCase å±€éƒ¨å˜é‡/å‚æ•°
- âœ… _camelCase ç§æœ‰å­—æ®µ
- âœ… ä¸­è‹±æ–‡åŒè¯­æ³¨é‡Š
- âœ… å®Œæ•´çš„ XML æ–‡æ¡£æ³¨é‡Š
- âœ… éµå¾ª DDD åˆ†å±‚æ¶æ„
- âœ… æ¸…æ™°çš„èŒè´£åˆ†ç¦»

**âœ… æµ‹è¯•è¦†ç›–**:
- 26ä¸ªå•å…ƒæµ‹è¯• (100% é€šè¿‡)
- MemoryStateManager æµ‹è¯• (21ä¸ª)
- CacheCoordinator æµ‹è¯•
- é›†æˆæµ‹è¯•
- è¦†ç›–ç‡ >90%

**âœ… é”™è¯¯å¤„ç†**:
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- åˆç†çš„æ—¥å¿—çº§åˆ« (Trace/Debug/Info/Warning/Error)
- å¤±è´¥é‡è¯•æœºåˆ¶
- Fallback é™çº§æ–¹æ¡ˆ
- è¶…æ—¶ä¿æŠ¤

### 1.4 ç›‘æ§ä¸è¯Šæ–­èƒ½åŠ›

**âœ… å·²å®ç°çš„ç›‘æ§åŠŸèƒ½**:

1. **DatabaseMetricsCollector** (æ•°æ®åº“æŒ‡æ ‡æ”¶é›†å™¨):
   - ä¿å­˜æ“ä½œç»Ÿè®¡ (é¢‘ç‡/è€—æ—¶/æˆåŠŸç‡)
   - æ¸…ç†æ“ä½œç»Ÿè®¡
   - å†…å­˜çŠ¶æ€ç»Ÿè®¡
   - P95/P99 ç™¾åˆ†ä½æ•°
   - æ»‘åŠ¨çª—å£ç»Ÿè®¡

2. **å¥åº·æ£€æŸ¥ API**:
   - `GET /api/database/health` - æ•´ä½“å¥åº·çŠ¶æ€
   - `GET /api/database/metrics` - æ€§èƒ½æŒ‡æ ‡æ‘˜è¦
   - `GET /api/database/status` - è¯¦ç»†çŠ¶æ€ä¿¡æ¯
   - `GET /api/database/memory-state` - å†…å­˜çŠ¶æ€å¿«ç…§
   - `POST /api/database/trigger-save` - è§¦å‘ç«‹å³ä¿å­˜

3. **ç¼“å­˜ç»Ÿè®¡ API**:
   - `GET /api/database/cache-stats` - ç¼“å­˜ç»Ÿè®¡
   - å‘½ä¸­ç‡ç›‘æ§
   - å®ä½“è®¡æ•°
   - Dirty å®ä½“è¿½è¸ª

**ç›‘æ§æŒ‡æ ‡è¦†ç›–**:
| æŒ‡æ ‡ç±»åˆ« | å·²å®ç° | å®Œæ•´æ€§ |
|---------|--------|--------|
| å†™å…¥æ€§èƒ½ | âœ… | 100% |
| è¯»å–æ€§èƒ½ | âœ… | 100% |
| ç¼“å­˜æ•ˆç‡ | âœ… | 100% |
| å†…å­˜ä½¿ç”¨ | âœ… | 90% |
| API å“åº”æ—¶é—´ | âŒ | 0% |
| ä¸šåŠ¡æŒ‡æ ‡ | âŒ | 0% |

### 1.5 è¯†åˆ«çš„ä¼˜åŒ–ç©ºé—´

è™½ç„¶å½“å‰ä¼˜åŒ–å·²è¾¾åˆ°å“è¶Šæ°´å¹³ (94.9% I/O å‡å°‘)ï¼Œä½†ä»æœ‰è¿›ä¸€æ­¥æ”¹è¿›ç©ºé—´ï¼š

#### ç©ºé—´ 1: æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥ â­â­â­
**ç°çŠ¶**: ä»…æ”¯æŒå¯åŠ¨æ—¶é¢„åŠ è½½é™æ€æ•°æ®  
**æ”¹è¿›**: åŸºäºè®¿é—®æ¨¡å¼çš„æ™ºèƒ½é¢„æµ‹å’Œé¢„åŠ è½½  
**æ”¶ç›Š**: è¿›ä¸€æ­¥æå‡ç¼“å­˜å‘½ä¸­ç‡ 5-10%

#### ç©ºé—´ 2: å¤šçº§ç¼“å­˜æ¶æ„ â­â­
**ç°çŠ¶**: å•çº§å†…å­˜ç¼“å­˜  
**æ”¹è¿›**: L1 (çƒ­ç‚¹æ•°æ®) + L2 (æ¸©æ•°æ®) + L3 (å†·æ•°æ®)  
**æ”¶ç›Š**: æ›´ç²¾ç»†çš„å†…å­˜ç®¡ç†ï¼Œé™ä½å†…å­˜æ¶ˆè€— 20-30%

#### ç©ºé—´ 3: åˆ†å¸ƒå¼ç¼“å­˜ â­â­
**ç°çŠ¶**: å•æœºå†…å­˜ç¼“å­˜  
**æ”¹è¿›**: Redis/Memcached åˆ†å¸ƒå¼ç¼“å­˜  
**æ”¶ç›Š**: å¤šæœåŠ¡å™¨éƒ¨ç½²åœºæ™¯ä¸‹çš„ç¼“å­˜å…±äº«

#### ç©ºé—´ 4: æŸ¥è¯¢ä¼˜åŒ– â­â­â­â­
**ç°çŠ¶**: éƒ¨åˆ†æŸ¥è¯¢å¯èƒ½å­˜åœ¨ N+1 é—®é¢˜  
**æ”¹è¿›**: æ‰¹é‡æŸ¥è¯¢ã€Eager Loadingã€æŠ•å½±ä¼˜åŒ–  
**æ”¶ç›Š**: å‡å°‘æŸ¥è¯¢æ¬¡æ•° 30-50%

#### ç©ºé—´ 5: å®æ—¶æ€§èƒ½ç›‘æ§ â­â­â­
**ç°çŠ¶**: åŸºç¡€ç›‘æ§ API  
**æ”¹è¿›**: é›†æˆ Prometheus/Grafanaï¼Œå®æ—¶ç›‘æ§ä»ªè¡¨æ¿  
**æ”¶ç›Š**: å®æ—¶æ€§èƒ½è§‚å¯Ÿå’Œå‘Šè­¦

#### ç©ºé—´ 6: è‡ªé€‚åº”ç¼“å­˜è°ƒä¼˜ â­â­
**ç°çŠ¶**: é™æ€é…ç½®å‚æ•°  
**æ”¹è¿›**: åŸºäºè¿è¡Œæ—¶æ•°æ®è‡ªåŠ¨è°ƒæ•´ TTLã€ç¼“å­˜å¤§å°  
**æ”¶ç›Š**: æ— éœ€æ‰‹åŠ¨è°ƒä¼˜ï¼Œè‡ªåŠ¨ä¼˜åŒ–

#### ç©ºé—´ 7: å¼‚æ­¥æ“ä½œä¼˜åŒ– â­â­â­
**ç°çŠ¶**: éƒ¨åˆ†æ“ä½œå¯èƒ½é˜»å¡  
**æ”¹è¿›**: æ›´æ¿€è¿›çš„å¼‚æ­¥åŒ–ã€å¹¶è¡ŒåŒ–  
**æ”¶ç›Š**: æå‡ååé‡ 20-40%

#### ç©ºé—´ 8: æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– â­â­â­â­
**ç°çŠ¶**: åŸºç¡€ç´¢å¼•  
**æ”¹è¿›**: å¤åˆç´¢å¼•ã€è¦†ç›–ç´¢å¼•ã€åˆ†ææ…¢æŸ¥è¯¢  
**æ”¶ç›Š**: æŸ¥è¯¢æ€§èƒ½æå‡ 50-100%

**ä¼˜åŒ–ç©ºé—´ä¼˜å…ˆçº§è¯„ä¼°**:
1. **é«˜ä¼˜å…ˆçº§ (â­â­â­â­)**: æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•ä¼˜åŒ–
2. **ä¸­ä¼˜å…ˆçº§ (â­â­â­)**: æ™ºèƒ½é¢„åŠ è½½ã€å®æ—¶ç›‘æ§ã€å¼‚æ­¥ä¼˜åŒ–
3. **ä½ä¼˜å…ˆçº§ (â­â­)**: å¤šçº§ç¼“å­˜ã€åˆ†å¸ƒå¼ç¼“å­˜ã€è‡ªé€‚åº”è°ƒä¼˜

---

## ğŸ“ˆ ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®åº“æ“ä½œè¯¦ç»†åˆ†æ

### 2.1 è¯»å–æ“ä½œåˆ†æ

#### 2.1.1 å½“å‰è¯»å–æ“ä½œåˆ†ç±»

**é«˜é¢‘è¯»å–æ“ä½œ** (æ¯ç§’çº§):
1. **è§’è‰²æ•°æ®è¯»å–**:
   - API: `/api/characters/{id}`
   - é¢‘ç‡: æ¯ä¸ªç©å®¶ 2-5 æ¬¡/ç§’ (UI åˆ·æ–°)
   - ä¼˜åŒ–çŠ¶æ€: âœ… å·²ç¼“å­˜ (80-90% å‘½ä¸­ç‡)

2. **æˆ˜æ–—å¿«ç…§è¯»å–**:
   - ç”¨é€”: æ¢å¤æˆ˜æ–—çŠ¶æ€ã€æ˜¾ç¤ºè¿›åº¦
   - é¢‘ç‡: æ¯ä¸ªæˆ˜æ–— 1-2 æ¬¡/ç§’
   - ä¼˜åŒ–çŠ¶æ€: âœ… å·²ç¼“å­˜ (70-85% å‘½ä¸­ç‡)

3. **è£…å¤‡æ•°æ®è¯»å–**:
   - GearDefinition: é™æ€é…ç½®
   - GearInstance: ç©å®¶è£…å¤‡å®ä¾‹
   - é¢‘ç‡: æ¯ä¸ªç©å®¶ 0.5-1 æ¬¡/ç§’
   - ä¼˜åŒ–çŠ¶æ€: âœ… å·²ç¼“å­˜ (90-95% å‘½ä¸­ç‡)

**ä¸­é¢‘è¯»å–æ“ä½œ** (æ¯åˆ†é’Ÿçº§):
1. **æ´»åŠ¨è®¡åˆ’è¯»å–**:
   - API: `/api/activities/{characterId}`
   - é¢‘ç‡: æ¯ä¸ªç©å®¶ 1-5 æ¬¡/åˆ†é’Ÿ
   - ä¼˜åŒ–çŠ¶æ€: âœ… å·²ç¼“å­˜ (75-90% å‘½ä¸­ç‡)

2. **å•†åº—æ•°æ®è¯»å–**:
   - ShopDefinition: é™æ€é…ç½®
   - ShopItems: åŠé™æ€ (å®šæœŸåˆ·æ–°)
   - é¢‘ç‡: æ¯ä¸ªç©å®¶ 1-2 æ¬¡/åˆ†é’Ÿ
   - ä¼˜åŒ–çŠ¶æ€: âœ… å·²ç¼“å­˜ (ShopCacheService)

**ä½é¢‘è¯»å–æ“ä½œ** (æ¯å°æ—¶çº§):
1. **ç”¨æˆ·è®¤è¯**:
   - ç™»å½•éªŒè¯ã€Token åˆ·æ–°
   - é¢‘ç‡: æ¯ç”¨æˆ· 1 æ¬¡/å°æ—¶
   - ä¼˜åŒ–çŠ¶æ€: âŒ æ— ç¼“å­˜ (ä½é¢‘æ— éœ€ä¼˜åŒ–)

2. **ç»Ÿè®¡æŸ¥è¯¢**:
   - æ’è¡Œæ¦œã€æˆå°±ç»Ÿè®¡
   - é¢‘ç‡: ä¸å®šæœŸ
   - ä¼˜åŒ–çŠ¶æ€: âŒ æ— ç¼“å­˜

#### 2.1.2 æ½œåœ¨çš„ N+1 æŸ¥è¯¢é—®é¢˜

**åœºæ™¯ 1: è§’è‰²è£…å¤‡åŠ è½½**
```csharp
// æ½œåœ¨é—®é¢˜ï¼šé€ä¸ªåŠ è½½è£…å¤‡
var character = await _db.Characters.FindAsync(id);
foreach (var slot in character.EquipmentSlots)
{
    var gear = await _gearRepository.GetAsync(slot.GearId); // N+1
}

// ä¼˜åŒ–æ–¹æ¡ˆï¼šæ‰¹é‡åŠ è½½
var gearIds = character.EquipmentSlots.Select(s => s.GearId).ToList();
var gears = await _gearRepository.GetBatchAsync(gearIds); // 1æ¬¡æŸ¥è¯¢
```

**åœºæ™¯ 2: æ´»åŠ¨è®¡åˆ’å…³è”æ•°æ®**
```csharp
// æ½œåœ¨é—®é¢˜ï¼šé€ä¸ªåŠ è½½å…³è”æ•°æ®
var plans = await _db.ActivityPlans.Where(p => p.CharacterId == id).ToListAsync();
foreach (var plan in plans)
{
    plan.Character = await _db.Characters.FindAsync(plan.CharacterId); // N+1
}

// ä¼˜åŒ–æ–¹æ¡ˆï¼šInclude
var plans = await _db.ActivityPlans
    .Include(p => p.Character)
    .Where(p => p.CharacterId == id)
    .ToListAsync(); // 1æ¬¡æŸ¥è¯¢
```

**è¯„ä¼°**: éœ€è¦ä»£ç å®¡æŸ¥ç¡®è®¤æ˜¯å¦å­˜åœ¨ N+1 é—®é¢˜

#### 2.1.3 ç¼“å­˜å‘½ä¸­ç‡æ·±åº¦åˆ†æ

**ç†è®ºæœ€å¤§å‘½ä¸­ç‡**:
- é™æ€æ•°æ® (GearDefinition, Affix): 99.9%
- çƒ­ç‚¹æ•°æ® (åœ¨çº¿è§’è‰²): 95%
- æ´»è·ƒæ•°æ® (æˆ˜æ–—ä¸­è§’è‰²): 90%
- å†·æ•°æ® (ç¦»çº¿è§’è‰²): 60%

**å½“å‰å‘½ä¸­ç‡** (åŸºäºé…ç½®æ¨æµ‹):
- GearDefinition: 95-100% âœ… (å·²è¾¾ç†è®ºä¸Šé™)
- Character: 80-90% ğŸ”¸ (æœ‰æå‡ç©ºé—´)
- GearInstance: 70-85% ğŸ”¸ (æœ‰æå‡ç©ºé—´)
- ActivityPlan: 75-90% ğŸ”¸ (æœ‰æå‡ç©ºé—´)

**æå‡å‘½ä¸­ç‡çš„ç­–ç•¥**:
1. **æ™ºèƒ½é¢„åŠ è½½**: ç™»å½•æ—¶é¢„åŠ è½½ç”¨æˆ·ç›¸å…³æ•°æ®
2. **è®¿é—®æ¨¡å¼å­¦ä¹ **: è®°å½•è®¿é—®æ¨¡å¼ï¼Œé¢„æµ‹ä¸‹æ¬¡è®¿é—®
3. **TTL ä¼˜åŒ–**: æ´»è·ƒç”¨æˆ·å»¶é•¿ TTLï¼Œç¦»çº¿ç”¨æˆ·ç¼©çŸ­ TTL
4. **æ‰¹é‡é¢„çƒ­**: å®šæœŸæ‰¹é‡é¢„çƒ­çƒ­ç‚¹æ•°æ®

### 2.2 å†™å…¥æ“ä½œåˆ†æ

#### 2.2.1 å½“å‰å†™å…¥æ“ä½œåˆ†ç±»

**å·²ä¼˜åŒ–çš„é«˜é¢‘å†™å…¥**:
- âœ… è§’è‰²å¿ƒè·³ (LastSeenAtUtc)
- âœ… æˆ˜æ–—å¿«ç…§ (BattleSnapshot)
- âœ… æ´»åŠ¨è®¡åˆ’çŠ¶æ€æ›´æ–°

**æœªä¼˜åŒ–çš„ä½é¢‘å†™å…¥** (æ— éœ€ä¼˜åŒ–):
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- è£…å¤‡è´­ä¹°
- ç‰©å“ä½¿ç”¨
- æˆ˜æ–—ç»“ç®— (å·²æœ‰æ‰¹é‡æœºåˆ¶)

#### 2.2.2 æ‰¹é‡ä¿å­˜ç­–ç•¥è¯„ä¼°

**å½“å‰ç­–ç•¥**:
| å®ä½“ç±»å‹ | ä¿å­˜é—´éš” | æ‰¹é‡å¤§å° | è¯„ä»· |
|---------|---------|---------|------|
| BattleSnapshot | 60ç§’ | 500 | âœ… ä¼˜ç§€ |
| CharacterHeartbeat | 300ç§’ | 1000 | âœ… ä¼˜ç§€ |
| ActivityPlan | 30ç§’ | 200 | âœ… ä¼˜ç§€ |

**æ½œåœ¨æ”¹è¿›**:
1. **åŠ¨æ€è°ƒæ•´é—´éš”**: æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´ä¿å­˜é—´éš”
2. **ä¼˜å…ˆçº§é˜Ÿåˆ—**: å…³é”®æ•°æ®ä¼˜å…ˆä¿å­˜
3. **å¢é‡ä¿å­˜**: ä»…ä¿å­˜å˜æ›´å­—æ®µ

#### 2.2.3 æ•°æ®ä¸¢å¤±é£é™©è¯„ä¼°

**å½“å‰é£é™©çª—å£**:
- è§’è‰²å¿ƒè·³: æœ€å¤šä¸¢å¤± 300ç§’ (5åˆ†é’Ÿ) åœ¨çº¿æ—¶é—´
- æˆ˜æ–—å¿«ç…§: æœ€å¤šä¸¢å¤± 60ç§’ æˆ˜æ–—è¿›åº¦
- æ´»åŠ¨è®¡åˆ’: æœ€å¤šä¸¢å¤± 30ç§’ è¿›åº¦

**é£é™©è¯„ä¼°**:
- æ”¾ç½®ç±»æ¸¸æˆ: âœ… å¯æ¥å—
- å…³é”®äº¤æ˜“: âœ… ç«‹å³ä¿å­˜ï¼Œæ— é£é™©
- ç”¨æˆ·ä½“éªŒ: âœ… å½±å“æå°

**å¯é€‰æ”¹è¿›**:
- å…³é”®äº‹ä»¶è§¦å‘ç«‹å³ä¿å­˜ (å¦‚ï¼šç¨€æœ‰æ‰è½ã€æˆå°±è§£é”)
- WAL (Write-Ahead Logging) åŒé‡ä¿æŠ¤

### 2.3 å†…å­˜ä½¿ç”¨åˆ†æ

#### 2.3.1 å½“å‰å†…å­˜æ¶ˆè€—ä¼°ç®—

**é…ç½®ä¸Šé™**:
```json
"MemoryCache": {
  "MaxCachedEntities": 100000
}
```

**å®é™…æ¶ˆè€—ä¼°ç®—** (å•å®ä½“å¹³å‡å¤§å°):
| å®ä½“ç±»å‹ | å•ä¸ªå¤§å° | æœ€å¤§æ•°é‡ | æ€»æ¶ˆè€— |
|---------|---------|---------|--------|
| GearDefinition | ~500B | 10,000 | ~5MB |
| Affix | ~1KB | 10,000 | ~10MB |
| GearSet | ~1KB | 1,000 | ~1MB |
| Character | ~5KB | 10,000 | ~50MB |
| GearInstance | ~2KB | 50,000 | ~100MB |
| ActivityPlan | ~1.5KB | 20,000 | ~30MB |
| BattleSnapshot | ~4KB | 5,000 | ~20MB |

**æ€»è®¡**: çº¦ **216 MB** (åœ¨åˆç†èŒƒå›´å†…)

#### 2.3.2 LRU æ¸…ç†ç­–ç•¥è¯„ä¼°

**å½“å‰ç­–ç•¥**:
- ç­–ç•¥: LRU (Least Recently Used)
- ä¿æŠ¤: Dirty å®ä½“ä¸è¢«æ¸…ç†
- è§¦å‘: è¾¾åˆ° MaxCachedEntities ä¸Šé™

**è¯„ä¼°**:
- âœ… ç­–ç•¥åˆç†
- âœ… Dirty ä¿æŠ¤æ­£ç¡®
- ğŸ”¸ å¯ä¼˜åŒ–: åŸºäºå¤§å°æ¸…ç†ï¼Œè€Œéä»…æ•°é‡

**æ”¹è¿›å»ºè®®**:
```csharp
public class MemoryCacheOptions
{
    public int MaxCachedEntities { get; set; } = 100000;
    public long MaxMemoryBytes { get; set; } = 500 * 1024 * 1024; // 500MB
    public EvictionPolicy EvictionPolicy { get; set; } = EvictionPolicy.LRU;
    
    // æ–°å¢ï¼šåŸºäºå¤§å°çš„æ¸…ç†
    public bool EnableSizeBasedEviction { get; set; } = true;
}
```

### 2.4 å¹¶å‘ä¸çº¿ç¨‹å®‰å…¨åˆ†æ

#### 2.4.1 çº¿ç¨‹å®‰å…¨æœºåˆ¶

**å·²å®ç°**:
- âœ… ConcurrentDictionary (æ— é”è¯»å–)
- âœ… ReaderWriterLockSlim (å¿«ç…§éš”ç¦»)
- âœ… Interlocked (åŸå­æ“ä½œ)

**è¯„ä¼°**:
- âœ… çº¿ç¨‹å®‰å…¨ä¿éšœå……åˆ†
- âœ… æ€§èƒ½ä¼˜åŒ–å¾—å½“ (æ— é”è¯»å–)
- âœ… æ— æ˜æ˜¾ç«äº‰æ¡ä»¶

#### 2.4.2 å¹¶å‘æ€§èƒ½

**å½“å‰å¹¶å‘èƒ½åŠ›** (åŸºäºæ¶æ„æ¨æµ‹):
- è¯»å¹¶å‘: é«˜ (æ— é” ConcurrentDictionary)
- å†™å¹¶å‘: ä¸­ç­‰ (Dirty è¿½è¸ªæœ‰é”)
- æ‰¹é‡ä¿å­˜: å•çº¿ç¨‹é¡ºåº

**å¯é€‰æ”¹è¿›**:
1. **å¹¶è¡Œä¿å­˜**: ä¸åŒå®ä½“ç±»å‹å¹¶è¡Œä¿å­˜
2. **åˆ†ç‰‡é”**: é™ä½é”ç²’åº¦
3. **æ— é”ç®—æ³•**: Dirty è¿½è¸ªä½¿ç”¨ CAS

---

## ğŸ¯ ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

åŸºäºä»¥ä¸Šåˆ†æï¼Œè®¾è®¡å¦‚ä¸‹å¯é€‰çš„è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹æ¡ˆã€‚

**é‡è¦è¯´æ˜**: 
- å½“å‰ç³»ç»Ÿå·²è¾¾åˆ°å“è¶Šæ°´å¹³ (94.9% I/O å‡å°‘)
- ä»¥ä¸‹æ–¹æ¡ˆä¸º**å¯é€‰å¢å¼º**ï¼Œéå¿…é¡»
- å»ºè®®æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æ€§å®æ–½

### 3.1 Phase 4: æŸ¥è¯¢ä¼˜åŒ–ä¸ç´¢å¼•å¢å¼º (é«˜ä¼˜å…ˆçº§ â­â­â­â­)

#### ç›®æ ‡
- æ¶ˆé™¤ N+1 æŸ¥è¯¢é—®é¢˜
- ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•
- å‡å°‘æŸ¥è¯¢å“åº”æ—¶é—´ 50%

#### æ ¸å¿ƒä»»åŠ¡

**ä»»åŠ¡ 4.1: ä»£ç å®¡æŸ¥ä¸ N+1 æ£€æµ‹**
- å®¡æŸ¥æ‰€æœ‰ Repository æ–¹æ³•
- ä½¿ç”¨ EF Core æŸ¥è¯¢æ—¥å¿—åˆ†æ
- è¯†åˆ« N+1 æ¨¡å¼
- å·¥å…·: MiniProfiler, EF Core Logging

**ä»»åŠ¡ 4.2: æ‰¹é‡æŸ¥è¯¢æ¥å£**
```csharp
public interface IRepository<T> where T : class, IEntity
{
    // æ–°å¢æ‰¹é‡æŸ¥è¯¢æ¥å£
    Task<IReadOnlyList<T>> GetBatchAsync(
        IEnumerable<Guid> ids, 
        CancellationToken ct = default);
        
    Task<IReadOnlyDictionary<Guid, T>> GetDictionaryAsync(
        IEnumerable<Guid> ids, 
        CancellationToken ct = default);
}
```

**ä»»åŠ¡ 4.3: Include ä¸ ThenInclude ä¼˜åŒ–**
```csharp
// ç¤ºä¾‹ï¼šä¼˜åŒ–è§’è‰²è£…å¤‡åŠ è½½
public async Task<Character?> GetWithEquipmentAsync(Guid id, CancellationToken ct)
{
    return await _db.Characters
        .Include(c => c.EquipmentSlots)
        .ThenInclude(s => s.Gear)
        .ThenInclude(g => g.Affixes)
        .FirstOrDefaultAsync(c => c.Id == id, ct);
}
```

**ä»»åŠ¡ 4.4: ç´¢å¼•åˆ†æä¸ä¼˜åŒ–**

åˆ›å»º `DatabaseIndexOptimization.md`:
```markdown
# å»ºè®®ç´¢å¼•

## Characters è¡¨
- ç°æœ‰ç´¢å¼•: PRIMARY KEY (Id)
- å»ºè®®æ–°å¢:
  - INDEX idx_characters_userid (UserId) -- æŒ‰ç”¨æˆ·æŸ¥è¯¢
  - INDEX idx_characters_lastseen (LastSeenAtUtc) -- ç¦»çº¿æ£€æµ‹
  - INDEX idx_characters_online (IsOnline, LastSeenAtUtc) -- åœ¨çº¿è§’è‰²æŸ¥è¯¢

## ActivityPlans è¡¨
- å»ºè®®æ–°å¢:
  - INDEX idx_activityplans_character (CharacterId, State) -- è§’è‰²æ´»åŠ¨æŸ¥è¯¢
  - INDEX idx_activityplans_state (State, CreatedAt) -- çŠ¶æ€æŸ¥è¯¢
```

**ä»»åŠ¡ 4.5: æŠ•å½±ä¼˜åŒ–**
```csharp
// é¿å…åŠ è½½æ•´ä¸ªå®ä½“ï¼Œä»…æŸ¥è¯¢éœ€è¦çš„å­—æ®µ
public async Task<CharacterSummaryDto> GetSummaryAsync(Guid id, CancellationToken ct)
{
    return await _db.Characters
        .Where(c => c.Id == id)
        .Select(c => new CharacterSummaryDto
        {
            Id = c.Id,
            Name = c.Name,
            Level = c.Level,
            IsOnline = c.IsOnline
        })
        .FirstOrDefaultAsync(ct);
}
```

**é…ç½®åŒ–**:
```json
{
  "QueryOptimization": {
    "EnableBatchQueries": true,
    "DefaultBatchSize": 100,
    "MaxBatchSize": 1000,
    "EnableEagerLoading": true,
    "EnableProjection": true,
    "QueryTimeout": 30
  }
}
```

#### é¢„æœŸæ•ˆæœ
- æ¶ˆé™¤ 90% çš„ N+1 æŸ¥è¯¢
- æŸ¥è¯¢å“åº”æ—¶é—´å‡å°‘ 50-70%
- æ•°æ®åº“ CPU ä½¿ç”¨ç‡é™ä½ 30%

---

### 3.2 Phase 5: æ™ºèƒ½é¢„åŠ è½½ä¸ç¼“å­˜é¢„çƒ­ (ä¸­ä¼˜å…ˆçº§ â­â­â­)

#### ç›®æ ‡
- æå‡ç¼“å­˜å‘½ä¸­ç‡ 5-10%
- å‡å°‘ç™»å½•åçš„"å†·å¯åŠ¨"å»¶è¿Ÿ

#### æ ¸å¿ƒä»»åŠ¡

**ä»»åŠ¡ 5.1: è®¿é—®æ¨¡å¼åˆ†æå™¨**
```csharp
/// <summary>
/// è®¿é—®æ¨¡å¼åˆ†æå™¨ - å­¦ä¹ å’Œé¢„æµ‹æ•°æ®è®¿é—®æ¨¡å¼
/// Access Pattern Analyzer - Learn and predict data access patterns
/// </summary>
public class AccessPatternAnalyzer
{
    // è®°å½•è®¿é—®åºåˆ—
    private readonly ConcurrentDictionary<string, AccessSequence> _patterns = new();
    
    // è®°å½•è®¿é—®äº‹ä»¶
    public void RecordAccess(string entityType, Guid entityId, Guid? relatedId = null)
    {
        // è®°å½•: entityId ä¹‹åé€šå¸¸è®¿é—®å“ªäº›å®ä½“
        // ç”¨äºé¢„æµ‹å’Œé¢„åŠ è½½
    }
    
    // é¢„æµ‹ä¸‹æ¬¡è®¿é—®
    public IEnumerable<Guid> PredictNext(string entityType, Guid currentId)
    {
        // åŸºäºå†å²æ¨¡å¼é¢„æµ‹
        // è¿”å›å¯èƒ½è®¿é—®çš„ entityIds
    }
}
```

**ä»»åŠ¡ 5.2: æ™ºèƒ½é¢„åŠ è½½æœåŠ¡**
```csharp
/// <summary>
/// æ™ºèƒ½é¢„åŠ è½½æœåŠ¡
/// Intelligent Preload Service
/// </summary>
public class IntelligentPreloadService : IHostedService
{
    // ç”¨æˆ·ç™»å½•æ—¶è§¦å‘
    public async Task PreloadUserDataAsync(Guid userId, CancellationToken ct)
    {
        // 1. åŠ è½½è§’è‰²åŸºæœ¬ä¿¡æ¯
        var characters = await _characterRepo.GetByUserIdAsync(userId, ct);
        
        // 2. é¢„åŠ è½½å¸¸ç”¨å…³è”æ•°æ®
        foreach (var character in characters)
        {
            // å¹¶è¡Œé¢„åŠ è½½
            await Task.WhenAll(
                PreloadEquipmentAsync(character.Id, ct),
                PreloadActivityPlansAsync(character.Id, ct),
                PreloadBattleSnapshotAsync(character.Id, ct)
            );
        }
        
        // 3. åŸºäºè®¿é—®æ¨¡å¼é¢„æµ‹å¹¶é¢„åŠ è½½
        var predicted = _patternAnalyzer.PredictNext("Character", character.Id);
        await PreloadPredictedDataAsync(predicted, ct);
    }
}
```

**ä»»åŠ¡ 5.3: å®šæœŸç¼“å­˜é¢„çƒ­**
```csharp
/// <summary>
/// ç¼“å­˜é¢„çƒ­ä»»åŠ¡
/// Cache Warming Task
/// </summary>
public class CacheWarmingTask : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken ct)
    {
        while (!ct.IsCancellationRequested)
        {
            try
            {
                // æ¯å°æ—¶é¢„çƒ­ä¸€æ¬¡çƒ­ç‚¹æ•°æ®
                await Task.Delay(TimeSpan.FromHours(1), ct);
                
                // 1. é¢„çƒ­åœ¨çº¿è§’è‰²æ•°æ®
                await WarmOnlineCharactersAsync(ct);
                
                // 2. é¢„çƒ­çƒ­é—¨è£…å¤‡
                await WarmPopularGearAsync(ct);
                
                // 3. é¢„çƒ­æ´»è·ƒæˆ˜æ–—
                await WarmActiveBattlesAsync(ct);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "ç¼“å­˜é¢„çƒ­å¤±è´¥");
            }
        }
    }
}
```

**é…ç½®åŒ–**:
```json
{
  "IntelligentCache": {
    "EnableAccessPatternAnalysis": true,
    "EnableIntelligentPreload": true,
    "PreloadOnLogin": true,
    "PreloadBatchSize": 50,
    "EnablePeriodicWarming": true,
    "WarmingIntervalHours": 1,
    "WarmOnlineCharactersOnly": true,
    "MaxPatternHistoryDays": 7
  }
}
```

#### é¢„æœŸæ•ˆæœ
- ç¼“å­˜å‘½ä¸­ç‡æå‡ 5-10%
- ç™»å½•åé¦–æ¬¡æ•°æ®è®¿é—®å»¶è¿Ÿé™ä½ 70%
- ç”¨æˆ·ä½“éªŒæ”¹å–„

---

### 3.3 Phase 6: å®æ—¶ç›‘æ§ä¸å¯è§†åŒ– (ä¸­ä¼˜å…ˆçº§ â­â­â­)

#### ç›®æ ‡
- å»ºç«‹å®æ—¶æ€§èƒ½ç›‘æ§
- å¯è§†åŒ–æ•°æ®åº“æ“ä½œ
- åŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆ

#### æ ¸å¿ƒä»»åŠ¡

**ä»»åŠ¡ 6.1: Prometheus é›†æˆ**
```csharp
/// <summary>
/// Prometheus æŒ‡æ ‡å¯¼å‡ºå™¨
/// Prometheus Metrics Exporter
/// </summary>
public class PrometheusMetricsExporter
{
    // æ•°æ®åº“æ“ä½œæŒ‡æ ‡
    private static readonly Counter DbReads = Metrics.CreateCounter(
        "blazoridle_db_reads_total",
        "Total database read operations",
        new CounterConfiguration { LabelNames = new[] { "entity_type", "cache_hit" } }
    );
    
    private static readonly Counter DbWrites = Metrics.CreateCounter(
        "blazoridle_db_writes_total",
        "Total database write operations",
        new CounterConfiguration { LabelNames = new[] { "entity_type", "batch_size" } }
    );
    
    private static readonly Gauge CacheHitRate = Metrics.CreateGauge(
        "blazoridle_cache_hit_rate",
        "Cache hit rate percentage",
        new GaugeConfiguration { LabelNames = new[] { "entity_type" } }
    );
    
    private static readonly Histogram DbQueryDuration = Metrics.CreateHistogram(
        "blazoridle_db_query_duration_seconds",
        "Database query duration in seconds",
        new HistogramConfiguration 
        { 
            LabelNames = new[] { "entity_type", "operation" },
            Buckets = Histogram.ExponentialBuckets(0.001, 2, 10)
        }
    );
}
```

**ä»»åŠ¡ 6.2: Grafana ä»ªè¡¨æ¿é…ç½®**

åˆ›å»º `monitoring/grafana-dashboard.json`:
```json
{
  "dashboard": {
    "title": "BlazorIdle Database Performance",
    "panels": [
      {
        "title": "Database I/O Operations",
        "targets": [
          {
            "expr": "rate(blazoridle_db_reads_total[5m])",
            "legendFormat": "Reads - {{entity_type}}"
          },
          {
            "expr": "rate(blazoridle_db_writes_total[5m])",
            "legendFormat": "Writes - {{entity_type}}"
          }
        ]
      },
      {
        "title": "Cache Hit Rate",
        "targets": [
          {
            "expr": "blazoridle_cache_hit_rate",
            "legendFormat": "{{entity_type}}"
          }
        ]
      },
      {
        "title": "Query Duration P95",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(blazoridle_db_query_duration_seconds_bucket[5m]))",
            "legendFormat": "P95 - {{entity_type}}"
          }
        ]
      }
    ]
  }
}
```

**ä»»åŠ¡ 6.3: å‘Šè­¦è§„åˆ™é…ç½®**

åˆ›å»º `monitoring/alert-rules.yml`:
```yaml
groups:
  - name: database_performance
    interval: 30s
    rules:
      # ç¼“å­˜å‘½ä¸­ç‡å‘Šè­¦
      - alert: LowCacheHitRate
        expr: blazoridle_cache_hit_rate < 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Cache hit rate is below 60%"
          description: "{{ $labels.entity_type }} cache hit rate: {{ $value }}%"
      
      # æ•°æ®åº“æ“ä½œæ¿€å¢å‘Šè­¦
      - alert: HighDatabaseIORate
        expr: rate(blazoridle_db_reads_total[5m]) + rate(blazoridle_db_writes_total[5m]) > 1000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Database I/O rate is abnormally high"
          description: "Current rate: {{ $value }} ops/s"
      
      # æŸ¥è¯¢å»¶è¿Ÿå‘Šè­¦
      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(blazoridle_db_query_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "P95 query duration exceeds 1 second"
          description: "{{ $labels.entity_type }}.{{ $labels.operation }}: {{ $value }}s"
```

**é…ç½®åŒ–**:
```json
{
  "Monitoring": {
    "EnablePrometheus": true,
    "PrometheusPort": 9090,
    "MetricsEndpoint": "/metrics",
    "EnableGrafana": true,
    "GrafanaUrl": "http://localhost:3000",
    "AlertingEnabled": true,
    "AlertWebhookUrl": "https://your-webhook-url"
  }
}
```

#### é¢„æœŸæ•ˆæœ
- å®æ—¶æ€§èƒ½å¯è§†åŒ–
- è‡ªåŠ¨å‘Šè­¦æœºåˆ¶
- å¿«é€Ÿå®šä½æ€§èƒ½é—®é¢˜

---

### 3.4 Phase 7: å¤šçº§ç¼“å­˜æ¶æ„ (ä½ä¼˜å…ˆçº§ â­â­)

#### ç›®æ ‡
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- æ›´ç²¾ç»†çš„ç¼“å­˜ç®¡ç†

#### æ ¸å¿ƒè®¾è®¡

**ä¸‰çº§ç¼“å­˜æ¶æ„**:
```
L1: çƒ­ç‚¹ç¼“å­˜ (Hot Cache)
- å®¹é‡: 10% å®ä½“
- TTL: æ°¸ä¹…æˆ–å¾ˆé•¿ (24h)
- ç”¨é€”: é«˜é¢‘è®¿é—®æ•°æ® (é™æ€é…ç½®ã€åœ¨çº¿è§’è‰²)

L2: æ¸©ç¼“å­˜ (Warm Cache)
- å®¹é‡: 30% å®ä½“
- TTL: ä¸­ç­‰ (1-6h)
- ç”¨é€”: æ´»è·ƒæ•°æ® (æ´»åŠ¨ä¸­è§’è‰²ã€è¿›è¡Œä¸­æˆ˜æ–—)

L3: å†·ç¼“å­˜ (Cold Cache)
- å®¹é‡: 60% å®ä½“
- TTL: çŸ­ (15min-1h)
- ç”¨é€”: å¶å°”è®¿é—®æ•°æ® (ç¦»çº¿è§’è‰²ã€å†å²æ•°æ®)
```

**è‡ªåŠ¨æ™‹å‡/é™çº§**:
- è®¿é—®é¢‘ç‡é«˜ â†’ L3 â†’ L2 â†’ L1
- é•¿æœŸæœªè®¿é—® â†’ L1 â†’ L2 â†’ L3 â†’ æ¸…é™¤

**é…ç½®åŒ–**:
```json
{
  "MultiLevelCache": {
    "EnableMultiLevelCache": false,
    "L1": {
      "MaxPercentage": 10,
      "TtlSeconds": 86400,
      "PromotionThreshold": 100
    },
    "L2": {
      "MaxPercentage": 30,
      "TtlSeconds": 3600,
      "PromotionThreshold": 10,
      "DemotionThreshold": 2
    },
    "L3": {
      "MaxPercentage": 60,
      "TtlSeconds": 900,
      "DemotionThreshold": 0
    }
  }
}
```

---

### 3.5 Phase 8: åˆ†å¸ƒå¼ç¼“å­˜æ”¯æŒ (ä½ä¼˜å…ˆçº§ â­â­)

#### ç›®æ ‡
- æ”¯æŒå¤šæœåŠ¡å™¨éƒ¨ç½²
- ç¼“å­˜å…±äº«

#### æ ¸å¿ƒè®¾è®¡

**Redis é›†æˆ**:
```csharp
public interface IDistributedCacheProvider
{
    Task<T?> GetAsync<T>(string key, CancellationToken ct = default);
    Task SetAsync<T>(string key, T value, TimeSpan? expiry = null, CancellationToken ct = default);
    Task RemoveAsync(string key, CancellationToken ct = default);
}

public class RedisCacheProvider : IDistributedCacheProvider
{
    private readonly IConnectionMultiplexer _redis;
    
    public async Task<T?> GetAsync<T>(string key, CancellationToken ct)
    {
        var db = _redis.GetDatabase();
        var value = await db.StringGetAsync(key);
        return value.HasValue ? JsonSerializer.Deserialize<T>(value!) : default;
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

**é…ç½®åŒ–**:
```json
{
  "DistributedCache": {
    "Provider": "None",  // None | Redis | Memcached
    "Redis": {
      "ConnectionString": "localhost:6379",
      "InstanceName": "BlazorIdle:",
      "DefaultExpiry": 3600,
      "EnableCompression": true
    }
  }
}
```

---

## ğŸ“‹ ç¬¬å››éƒ¨åˆ†ï¼šå®æ–½å»ºè®®ä¸é£é™©è¯„ä¼°

### 4.1 å®æ–½ä¼˜å…ˆçº§å»ºè®®

**å½“å‰ç³»ç»Ÿè¯„ä¼°**: â­â­â­â­â­ (5/5 ä¼˜ç§€)
- æ•°æ®åº“ I/O å‡å°‘ 94.9%
- å®Œå…¨é…ç½®åŒ–
- ä»£ç è´¨é‡é«˜
- æµ‹è¯•è¦†ç›–å……åˆ†

**å®æ–½å»ºè®®**:

#### çŸ­æœŸ (1-2ä¸ªæœˆ) - **å¦‚æœ**ä¸šåŠ¡æœ‰éœ€æ±‚
1. âœ… **Phase 4: æŸ¥è¯¢ä¼˜åŒ–** (â­â­â­â­)
   - æ”¶ç›Šå¤§ï¼Œé£é™©ä½
   - æå‡ 50% æŸ¥è¯¢æ€§èƒ½
   - é€‚åˆå½“å‰é˜¶æ®µ

2. âœ… **Phase 6: ç›‘æ§å¢å¼º** (â­â­â­)
   - ä¾¿äºæ€§èƒ½è§‚å¯Ÿ
   - æå‰å‘ç°é—®é¢˜
   - è¿ç»´ä»·å€¼é«˜

#### ä¸­æœŸ (3-6ä¸ªæœˆ) - **å¯é€‰**
3. ğŸ”¸ **Phase 5: æ™ºèƒ½é¢„åŠ è½½** (â­â­â­)
   - è¿›ä¸€æ­¥ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
   - é€‚åˆç”¨æˆ·é‡å¢é•¿å

#### é•¿æœŸ (6-12ä¸ªæœˆ) - **è§†ä¸šåŠ¡è§„æ¨¡è€Œå®š**
4. ğŸ”¸ **Phase 7: å¤šçº§ç¼“å­˜** (â­â­)
   - ä»…åœ¨å†…å­˜å‹åŠ›å¤§æ—¶è€ƒè™‘

5. ğŸ”¸ **Phase 8: åˆ†å¸ƒå¼ç¼“å­˜** (â­â­)
   - ä»…åœ¨å¤šæœåŠ¡å™¨éƒ¨ç½²æ—¶éœ€è¦

### 4.2 ä¸å»ºè®®å®æ–½çš„åœºæ™¯

**å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå½“å‰ç³»ç»Ÿå·²è¶³å¤Ÿ**:
- âœ… ç”¨æˆ·é‡ < 1000 å¹¶å‘
- âœ… å•æœåŠ¡å™¨éƒ¨ç½²
- âœ… æ•°æ®åº“æ€§èƒ½æ»¡è¶³éœ€æ±‚
- âœ… å†…å­˜ä½¿ç”¨ < 1GB
- âœ… API å“åº”æ—¶é—´ < 200ms

**åŸå› **:
- è¿‡åº¦ä¼˜åŒ–ä¼šå¢åŠ å¤æ‚åº¦
- ç»´æŠ¤æˆæœ¬ä¸Šå‡
- æ”¶ç›Šé€’å‡åŸç†

### 4.3 é£é™©è¯„ä¼°

#### Phase 4: æŸ¥è¯¢ä¼˜åŒ–
| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| å¼•å…¥æ–° Bug | ä½ | ä¸­ | å……åˆ†æµ‹è¯•ã€ç°åº¦å‘å¸ƒ |
| ç´¢å¼•å½±å“å†™å…¥ | ä½ | ä½ | ç›‘æ§å†™å…¥æ€§èƒ½ |
| ä»£ç å¤æ‚åº¦å¢åŠ  | ä¸­ | ä½ | ä»£ç è¯„å®¡ã€æ–‡æ¡£ |

#### Phase 5: æ™ºèƒ½é¢„åŠ è½½
| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| é¢„æµ‹ä¸å‡†ç¡® | ä¸­ | ä½ | A/B æµ‹è¯•éªŒè¯ |
| å†…å­˜æ¶ˆè€—å¢åŠ  | ä¸­ | ä¸­ | é…ç½®é™åˆ¶ã€ç›‘æ§ |
| å®æ–½å¤æ‚åº¦é«˜ | é«˜ | ä¸­ | åˆ†é˜¶æ®µå®æ–½ |

#### Phase 6: ç›‘æ§å¢å¼º
| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| é¢å¤–èµ„æºæ¶ˆè€— | ä½ | ä½ | è½»é‡çº§é‡‡æ · |
| é…ç½®å¤æ‚åº¦ | ä¸­ | ä½ | æä¾›æ¨¡æ¿é…ç½® |

### 4.4 æŠ•å…¥äº§å‡ºåˆ†æ

| Phase | å·¥æ—¶ (äººæ—¥) | æ”¶ç›Š | ROI | å»ºè®® |
|-------|-----------|------|-----|------|
| Phase 4 | 15-20 | æŸ¥è¯¢æ€§èƒ½æå‡ 50% | é«˜ | **æ¨è** |
| Phase 5 | 25-30 | ç¼“å­˜å‘½ä¸­ç‡ +5-10% | ä¸­ | å¯é€‰ |
| Phase 6 | 10-15 | è¿ç»´æ•ˆç‡æå‡ | é«˜ | **æ¨è** |
| Phase 7 | 30-40 | å†…å­˜ä¼˜åŒ– 20-30% | ä½ | ä¸æ¨è |
| Phase 8 | 40-50 | å¤šæœåŠ¡å™¨æ”¯æŒ | ä½-ä¸­ | è§†éœ€æ±‚ |

---

## ğŸ“ ç¬¬äº”éƒ¨åˆ†ï¼šæœ€ä½³å®è·µä¸å»ºè®®

### 5.1 é…ç½®ç®¡ç†æœ€ä½³å®è·µ

#### 5.1.1 ç¯å¢ƒç‰¹å®šé…ç½®

**å¼€å‘ç¯å¢ƒ** (`appsettings.Development.json`):
```json
{
  "Persistence": {
    "EnableMemoryBuffering": true,
    "SaveIntervalMs": 10000  // æ›´çŸ­é—´éš”ï¼Œä¾¿äºæµ‹è¯•
  },
  "Monitoring": {
    "EnableDetailedLogging": true  // è¯¦ç»†æ—¥å¿—
  }
}
```

**ç”Ÿäº§ç¯å¢ƒ** (`appsettings.Production.json`):
```json
{
  "Persistence": {
    "EnableMemoryBuffering": true,
    "SaveIntervalMs": 30000  // æ ‡å‡†é—´éš”
  },
  "Monitoring": {
    "EnableDetailedLogging": false  // å…³é—­è¯¦ç»†æ—¥å¿—
  }
}
```

**æµ‹è¯•ç¯å¢ƒ** (`appsettings.Testing.json`):
```json
{
  "Persistence": {
    "EnableMemoryBuffering": false,  // ç¦ç”¨ç¼“å†²ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
    "SaveIntervalMs": 0
  }
}
```

#### 5.1.2 é…ç½®éªŒè¯

**å¯åŠ¨æ—¶éªŒè¯**:
```csharp
services.AddOptions<PersistenceOptions>()
    .Bind(configuration.GetSection("Persistence"))
    .ValidateDataAnnotations()
    .ValidateOnStart();  // å¯åŠ¨æ—¶éªŒè¯ï¼Œå¿«é€Ÿå¤±è´¥
```

**è‡ªå®šä¹‰éªŒè¯å™¨**:
```csharp
public class PersistenceOptionsValidator : IValidateOptions<PersistenceOptions>
{
    public ValidateOptionsResult Validate(string? name, PersistenceOptions options)
    {
        if (options.SaveIntervalMs < 1000 && options.EnableMemoryBuffering)
        {
            return ValidateOptionsResult.Fail(
                "ä¿å­˜é—´éš”è¿‡çŸ­ (< 1s) å¯èƒ½å½±å“æ€§èƒ½ï¼Œå»ºè®® >= 10000ms");
        }
        
        return ValidateOptionsResult.Success;
    }
}
```

### 5.2 ç›‘æ§æœ€ä½³å®è·µ

#### 5.2.1 å…³é”®æŒ‡æ ‡ç›‘æ§

**å¿…é¡»ç›‘æ§**:
- âœ… ç¼“å­˜å‘½ä¸­ç‡ (åº” >= 70%)
- âœ… æ•°æ®åº“ I/O é¢‘ç‡ (åº”æ˜¾è‘—ä½äºä¼˜åŒ–å‰)
- âœ… å†…å­˜ä½¿ç”¨é‡ (åº” < é…ç½®ä¸Šé™)
- âœ… API P95 å“åº”æ—¶é—´ (åº” < 200ms)

**æ¨èç›‘æ§**:
- ğŸ”¸ Dirty å®ä½“æ•°é‡ (åº” < ForceSaveThreshold)
- ğŸ”¸ ä¿å­˜æ“ä½œè€—æ—¶ (åº” < 1s)
- ğŸ”¸ æ¸…ç†æ“ä½œé¢‘ç‡
- ğŸ”¸ æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡

#### 5.2.2 å‘Šè­¦é˜ˆå€¼å»ºè®®

```json
{
  "Alerting": {
    "CacheHitRate": {
      "WarningThreshold": 70,
      "CriticalThreshold": 50
    },
    "MemoryUsage": {
      "WarningThresholdMB": 400,
      "CriticalThresholdMB": 800
    },
    "DatabaseIORate": {
      "WarningThreshold": 100,  // æ¬¡/ç§’
      "CriticalThreshold": 500
    },
    "ApiP95Latency": {
      "WarningThresholdMs": 200,
      "CriticalThresholdMs": 500
    }
  }
}
```

### 5.3 æµ‹è¯•ç­–ç•¥å»ºè®®

#### 5.3.1 å•å…ƒæµ‹è¯•

**å¿…é¡»è¦†ç›–**:
- âœ… MemoryStateManager æ ¸å¿ƒåŠŸèƒ½
- âœ… CacheCoordinator é¢„åŠ è½½é€»è¾‘
- âœ… PersistenceCoordinator æ‰¹é‡ä¿å­˜
- âœ… Repository ç¼“å­˜é€»è¾‘

**ç¤ºä¾‹**:
```csharp
[Fact]
public async Task GetAsync_CacheHit_ShouldNotAccessDatabase()
{
    // Arrange
    var entity = new Character { Id = Guid.NewGuid() };
    _memoryManager.Add(entity);
    
    // Act
    var result = await _repository.GetAsync(entity.Id);
    
    // Assert
    Assert.Equal(entity, result);
    _dbMock.Verify(db => db.Set<Character>().FindAsync(It.IsAny<object[]>()), Times.Never);
}
```

#### 5.3.2 é›†æˆæµ‹è¯•

**å¿…é¡»è¦†ç›–**:
- âœ… å®Œæ•´çš„è¯»å†™æµç¨‹
- âœ… ä¼˜é›…å…³é—­ä¿å­˜
- âœ… ç¼“å­˜å¤±æ•ˆæœºåˆ¶
- âœ… å¹¶å‘åœºæ™¯

#### 5.3.3 æ€§èƒ½æµ‹è¯•

**åŸºå‡†æµ‹è¯•**:
```csharp
[Benchmark]
public async Task CachedRead()
{
    for (int i = 0; i < 1000; i++)
    {
        await _repository.GetAsync(_testIds[i % _testIds.Length]);
    }
}

[Benchmark]
public async Task DirectRead()
{
    for (int i = 0; i < 1000; i++)
    {
        await _db.Characters.FindAsync(_testIds[i % _testIds.Length]);
    }
}
```

**è´Ÿè½½æµ‹è¯•**:
- æ¨¡æ‹Ÿ 100 å¹¶å‘ç”¨æˆ·
- æŒç»­ 10 åˆ†é’Ÿ
- éªŒè¯å†…å­˜ä¸æ³„æ¼
- éªŒè¯æ€§èƒ½ç¨³å®š

### 5.4 è¿ç»´å»ºè®®

#### 5.4.1 æ—¥å¸¸ç»´æŠ¤

**æ¯æ—¥æ£€æŸ¥**:
- æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡æŠ¥å‘Š
- æ£€æŸ¥é”™è¯¯æ—¥å¿—
- ç›‘æ§å†…å­˜ä½¿ç”¨è¶‹åŠ¿

**æ¯å‘¨æ£€æŸ¥**:
- åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
- å®¡æŸ¥æ•°æ®åº“ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- è¯„ä¼°é…ç½®å‚æ•°æ˜¯å¦éœ€è¦è°ƒæ•´

**æ¯æœˆæ£€æŸ¥**:
- æ€§èƒ½å¯¹æ¯”åˆ†æ
- å®¹é‡è§„åˆ’è¯„ä¼°
- ä¼˜åŒ–æ•ˆæœå¤ç›˜

#### 5.4.2 æ•…éšœæ’æŸ¥

**ç¼“å­˜å‘½ä¸­ç‡ä½**:
1. æ£€æŸ¥ TTL é…ç½®æ˜¯å¦è¿‡çŸ­
2. æ£€æŸ¥ç¼“å­˜å®¹é‡æ˜¯å¦ä¸è¶³
3. åˆ†æè®¿é—®æ¨¡å¼æ˜¯å¦åˆ†æ•£
4. è€ƒè™‘å¢åŠ é¢„åŠ è½½

**å†…å­˜ä½¿ç”¨é«˜**:
1. æ£€æŸ¥ MaxCachedEntities é…ç½®
2. æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
3. è€ƒè™‘å¯ç”¨æ›´æ¿€è¿›çš„æ¸…ç†ç­–ç•¥
4. åˆ†æ Dirty å®ä½“æ•°é‡

**ä¿å­˜å»¶è¿Ÿ**:
1. æ£€æŸ¥ SaveIntervalMs é…ç½®
2. æ£€æŸ¥æ•°æ®åº“å†™å…¥æ€§èƒ½
3. æ£€æŸ¥ Dirty å®ä½“æ•°é‡æ˜¯å¦è¿‡å¤š
4. è€ƒè™‘å¢åŠ  MaxBatchSize

---

## ğŸ“Š ç¬¬å…­éƒ¨åˆ†ï¼šæ€»ç»“ä¸å»ºè®®

### 6.1 å½“å‰ç³»ç»Ÿè¯„ä¼°

**æ€»ä½“è¯„åˆ†**: â­â­â­â­â­ (5/5 ä¼˜ç§€)

**ä¼˜åŠ¿**:
1. âœ… **å“è¶Šçš„æ€§èƒ½**: æ•°æ®åº“ I/O å‡å°‘ 94.9%
2. âœ… **å®Œå…¨é…ç½®åŒ–**: é›¶ç¡¬ç¼–ç ï¼Œçµæ´»å¯è°ƒ
3. âœ… **é«˜ä»£ç è´¨é‡**: è§„èŒƒã€æµ‹è¯•ã€æ–‡æ¡£é½å…¨
4. âœ… **ç¨³å¥çš„æ¶æ„**: DDD åˆ†å±‚ï¼ŒèŒè´£æ¸…æ™°
5. âœ… **å‘åå…¼å®¹**: å¯éšæ—¶å…³é—­ä¼˜åŒ–å›æ»š

**å½“å‰ç³»ç»Ÿå·²éå¸¸æˆç†Ÿï¼Œæ— æ˜æ˜¾ç¼ºé™·**

### 6.2 è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

#### å»ºè®®å®æ–½ (å¦‚æœ‰ä¸šåŠ¡éœ€æ±‚)
1. **Phase 4: æŸ¥è¯¢ä¼˜åŒ–** - æ¶ˆé™¤ N+1ï¼Œä¼˜åŒ–ç´¢å¼•
2. **Phase 6: ç›‘æ§å¢å¼º** - Prometheus + Grafana

#### å¯é€‰å®æ–½ (è§†ä¸šåŠ¡è§„æ¨¡)
3. **Phase 5: æ™ºèƒ½é¢„åŠ è½½** - æå‡ç”¨æˆ·ä½“éªŒ

#### ä¸å»ºè®®å®æ–½ (æ”¶ç›Šä½ã€å¤æ‚åº¦é«˜)
4. **Phase 7: å¤šçº§ç¼“å­˜** - é™¤éå†…å­˜å‹åŠ›å¾ˆå¤§
5. **Phase 8: åˆ†å¸ƒå¼ç¼“å­˜** - é™¤éå¤šæœåŠ¡å™¨éƒ¨ç½²

### 6.3 æœ€ç»ˆå»ºè®®

**æ ¸å¿ƒå»ºè®®**: 
> **å½“å‰ç³»ç»Ÿå·²è¾¾åˆ°å“è¶Šæ°´å¹³ (94.9% I/O å‡å°‘)ï¼Œå»ºè®®ä¿æŒç°çŠ¶ï¼Œä¸“æ³¨äºä¸šåŠ¡åŠŸèƒ½å¼€å‘ã€‚**

**å¦‚æœå¿…é¡»ä¼˜åŒ–**:
1. å…ˆå®æ–½ Phase 6 (ç›‘æ§å¢å¼º) - äº†è§£çœŸå®æ€§èƒ½ç“¶é¢ˆ
2. åŸºäºç›‘æ§æ•°æ®å†³å®šæ˜¯å¦éœ€è¦ Phase 4 (æŸ¥è¯¢ä¼˜åŒ–)
3. é¿å…è¿‡åº¦ä¼˜åŒ– - æ”¶ç›Šé€’å‡ï¼Œå¤æ‚åº¦é€’å¢

**ä¼˜åŒ–çš„é»„é‡‘æ³•åˆ™**:
- æµ‹é‡ (Measure) > ä¼˜åŒ– (Optimize) > éªŒè¯ (Verify)
- å…ˆç›‘æ§ï¼Œå†ä¼˜åŒ–
- åŸºäºæ•°æ®å†³ç­–ï¼Œè€Œéå‡è®¾

---

## ğŸ“š é™„å½•

### é™„å½• A: æœ¯è¯­è¡¨

| æœ¯è¯­ | ä¸­æ–‡ | è¯´æ˜ |
|------|------|------|
| Cache Hit Rate | ç¼“å­˜å‘½ä¸­ç‡ | ä»ç¼“å­˜æˆåŠŸè·å–æ•°æ®çš„æ¯”ä¾‹ |
| N+1 Query | N+1 æŸ¥è¯¢é—®é¢˜ | å¾ªç¯ä¸­é€ä¸ªæŸ¥è¯¢å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ |
| TTL | ç”Ÿå­˜æ—¶é—´ | Time To Liveï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´ |
| LRU | æœ€è¿‘æœ€å°‘ä½¿ç”¨ | Least Recently Usedï¼Œç¼“å­˜æ¸…ç†ç­–ç•¥ |
| Dirty Tracking | è„è¿½è¸ª | è¿½è¸ªå·²ä¿®æ”¹ä½†æœªä¿å­˜çš„å®ä½“ |
| WAL | é¢„å†™æ—¥å¿— | Write-Ahead Loggingï¼Œæ•°æ®åº“æŒä¹…åŒ–æœºåˆ¶ |
| P95/P99 | ç¬¬95/99ç™¾åˆ†ä½ | æ€§èƒ½æŒ‡æ ‡ï¼Œ95%/99%çš„è¯·æ±‚å“åº”æ—¶é—´ |
| DDD | é¢†åŸŸé©±åŠ¨è®¾è®¡ | Domain-Driven Design |
| ROI | æŠ•èµ„å›æŠ¥ç‡ | Return On Investment |

### é™„å½• B: å‚è€ƒæ–‡æ¡£

**é¡¹ç›®æ–‡æ¡£**:
1. `æ•´åˆè®¾è®¡æ€»ç»“.txt` - é¡¹ç›®æ€»ä½“æ¶æ„ (546è¡Œ)
2. `æ•°æ®åº“ä¼˜åŒ–-å½“å‰å®æ–½çŠ¶æ€æ€»ç»“.md` - å†™å…¥ä¼˜åŒ–æ€»ç»“
3. `æ•°æ®åº“è¯»å–ä¼˜åŒ–é¡¹ç›®-å®Œæ•´éªŒæ”¶æŠ¥å‘Š.md` - è¯»å–ä¼˜åŒ–æ€»ç»“
4. `æ•°æ®åº“ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸Šä¸­ä¸‹ç¯‡.md` - è¯¦ç»†å®æ–½æ–¹æ¡ˆ

**å¤–éƒ¨èµ„æº**:
1. EF Core æ€§èƒ½ä¼˜åŒ–: https://docs.microsoft.com/en-us/ef/core/performance/
2. ASP.NET Core ç¼“å­˜: https://docs.microsoft.com/en-us/aspnet/core/performance/caching/
3. Prometheus ç›‘æ§: https://prometheus.io/docs/
4. Grafana ä»ªè¡¨æ¿: https://grafana.com/docs/

### é™„å½• C: é…ç½®å‚æ•°å¿«é€Ÿå‚è€ƒ

**å†™å…¥ä¼˜åŒ–é…ç½®** (`Persistence`):
```json
{
  "EnableMemoryBuffering": true,      // ä¸»å¼€å…³
  "SaveIntervalMs": 30000,            // é»˜è®¤ä¿å­˜é—´éš”
  "MaxBatchSize": 1000,               // æ‰¹é‡å¤§å°
  "ForceSaveThreshold": 5000,         // å¼ºåˆ¶ä¿å­˜é˜ˆå€¼
  "SaveRetryAttempts": 3              // é‡è¯•æ¬¡æ•°
}
```

**è¯»å–ä¼˜åŒ–é…ç½®** (`CacheConfiguration`):
```json
{
  "GlobalSettings": {
    "EnableReadCaching": true,        // ä¸»å¼€å…³
    "CleanupIntervalMinutes": 5,      // æ¸…ç†é—´éš”
    "TrackCacheHitRate": true         // è¿½è¸ªå‘½ä¸­ç‡
  }
}
```

**ç›‘æ§é…ç½®** (`Monitoring`):
```json
{
  "MaxRecentOperations": 100,         // ä¿ç•™æ“ä½œè®°å½•æ•°
  "EnableDetailedLogging": false,     // è¯¦ç»†æ—¥å¿—
  "CacheMonitoring": {
    "EnableCacheMetrics": true,       // å¯ç”¨ç¼“å­˜æŒ‡æ ‡
    "CacheHitRateThreshold": 70.0     // å‘½ä¸­ç‡é˜ˆå€¼
  }
}
```

---

**æŠ¥å‘Šç»“æŸ**

**ç¼–åˆ¶**: Database Optimization Team  
**å®¡æ ¸**: å¾…å®¡æ ¸  
**æ‰¹å‡†**: å¾…æ‰¹å‡†  
**æ—¥æœŸ**: 2025-10-19
