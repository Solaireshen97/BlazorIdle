# BlazorIdle 项目进度与未来规划文档

**文档版本**: 1.0  
**生成日期**: 2025年1月  
**基于设计文档**: 整合设计总结.txt (V3.1)

---

## 📋 目录

1. [项目概览](#项目概览)
2. [核心系统实现状态](#核心系统实现状态)
3. [已完成功能详解](#已完成功能详解)
4. [缺失功能分析](#缺失功能分析)
5. [阶段性开发路线图](#阶段性开发路线图)
6. [技术债务与优化机会](#技术债务与优化机会)
7. [优先级建议](#优先级建议)
8. [总结](#总结)

---

## 项目概览

### 愿景
构建一款"服务端权威 + 放置循环 + 构筑深度"的 Web RPG 游戏，特点包括：
- 基于时间驱动的事件调度系统
- 双轨战斗节奏（Attack + Special Track）
- 职业资源差异化机制
- 离线收益一致性模拟
- 数据驱动的可扩展设计

### 技术栈
- **前端**: Blazor WebAssembly
- **后端**: ASP.NET Core (C#)
- **数据库**: SQLite (Entity Framework Core)
- **架构**: 领域驱动设计 (DDD) + 事件驱动

### 当前状态评估

| 维度 | 完成度 | 说明 |
|------|--------|------|
| **核心战斗系统** | 🟢 75% | 事件调度、双轨机制、技能系统已实现 |
| **职业系统** | 🟢 60% | 基础职业、资源桶、Buff系统完成 |
| **装备系统** | 🔴 10% | 仅有基础属性，缺失Tier/Affix/套装 |
| **活动计划** | 🔴 0% | 完全缺失多槽位活动调度 |
| **地图/区域** | 🔴 0% | 无地图解锁与区域系统 |
| **离线收益** | 🔴 0% | 无快进模拟引擎 |
| **经济系统** | 🔴 5% | 无分解/重铸/监控机制 |
| **多角色系统** | 🔴 0% | 无Roster管理 |
| **任务/声望** | 🔴 0% | 完全缺失 |
| **配置管理** | 🔴 0% | 无版本化与热更新 |

**总体完成度估算**: 约 **25-30%**

---

## 核心系统实现状态

### ✅ 已实现 (Phase 1-2 部分)

#### 1. 事件调度核心 ⭐⭐⭐
**状态**: ✅ 完成

**实现文件**:
- `Domain/Combat/GameClock.cs` - 逻辑时钟
- `Domain/Combat/EventScheduler.cs` - 优先队列调度器
- `Domain/Combat/IGameEvent.cs` - 事件接口

**功能**:
- ✅ 基于优先队列的时间跳跃调度
- ✅ 单调递增逻辑时钟
- ✅ 事件接口与生命周期管理

**符合设计**: 100% - 完全按照设计文档实现

---

#### 2. 双轨战斗系统 ⭐⭐⭐
**状态**: ✅ 完成

**实现文件**:
- `Domain/Combat/TrackState.cs` - 轨道状态
- `Domain/Combat/AttackTickEvent.cs` - 普通攻击事件
- `Domain/Combat/SpecialPulseEvent.cs` - 特殊轨道脉冲
- `Application/Battles/BattleRunner.cs` - 战斗运行器

**功能**:
- ✅ Attack Track（受急速影响）
- ✅ Special Track（独立节奏）
- ✅ 急速系数动态调整
- ✅ 双轨独立触发机制

**关键代码特征**:
```csharp
var attackTrack = new TrackState(TrackType.Attack, battle.AttackIntervalSeconds, 0);
var specialTrack = new TrackState(TrackType.Special, battle.SpecialIntervalSeconds, ...);
```

**符合设计**: 95% - 核心机制完整，缺少部分高级配置

---

#### 3. 资源桶系统 ⭐⭐⭐
**状态**: ✅ 完成

**实现文件**:
- `Domain/Combat/Resources/ResourceBucket.cs` - 资源桶
- `Domain/Combat/Resources/OverflowPolicy.cs` - 溢出策略枚举
- `Domain/Combat/Resources/ResourceSet.cs` - 资源集合管理

**功能**:
- ✅ 基础资源增减（Current/Max）
- ✅ 三种溢出策略（Clamp/Convert/Ignore）
- ✅ 转换机制（溢出→Buff/其他资源）
- ✅ 统计反馈（AppliedDelta/ConversionCount）

**溢出转换示例**:
```csharp
// Convert模式：溢出37点，转换单位20 → 产生1次转换
OverflowPolicy.Convert, convertUnit: 20, conversionTag: "战意buff"
```

**符合设计**: 100% - 完全实现设计需求

---

#### 4. 技能与自动施放 ⭐⭐
**状态**: ✅ 基本完成

**实现文件**:
- `Domain/Combat/Skills/SkillDefinition.cs` - 技能定义
- `Domain/Combat/Skills/SkillRuntime.cs` - 技能运行态（冷却/充能）
- `Domain/Combat/Skills/SkillSlot.cs` - 技能槽位
- `Domain/Combat/Skills/AutoCastEngine.cs` - 自动施放引擎

**功能**:
- ✅ 多充能机制（MaxCharges支持）
- ✅ 充能恢复Tick
- ✅ 技能槽位优先级（1→4顺序）
- ✅ 基础自动施放逻辑
- ✅ 施法时间与引导机制
- ✅ 打断返还充能

**充能系统特性**:
- 支持单充能（传统CD）和多充能
- 充能恢复链式触发
- 打断时返还充能

**符合设计**: 85% - 核心完成，缺少高级条件表达式策略

---

#### 5. Buff 系统 ⭐⭐
**状态**: ✅ 完成

**实现文件**:
- `Domain/Combat/Buffs/BuffDefinition.cs` - Buff定义
- `Domain/Combat/Buffs/BuffInstance.cs` - Buff实例
- `Domain/Combat/Buffs/BuffManager.cs` - Buff管理器
- `Domain/Combat/Buffs/BuffAggregate.cs` - Buff聚合器（属性叠加）
- `Domain/Combat/Buffs/BuffStackPolicy.cs` - 叠加策略

**功能**:
- ✅ Buff生命周期（添加/刷新/过期）
- ✅ 叠加策略（Replace/Stack/Extend等）
- ✅ 属性修饰聚合（Additive/Multiplicative）
- ✅ 周期性效果（DoT/HoT）

**符合设计**: 90% - 功能完整，待优化统计输出

---

#### 6. 战斗段聚合 (CombatSegment) ⭐⭐
**状态**: ✅ 完成

**实现文件**:
- `Domain/Combat/SegmentCollector.cs` - 段收集器
- `CombatSegment` 类定义

**功能**:
- ✅ 事件计数阈值触发（默认200）
- ✅ 时间阈值触发（默认5秒）
- ✅ 伤害按来源统计（DamageBySource）
- ✅ 伤害按类型统计（DamageByType - Physical/Magical）
- ✅ 资源流水统计（ResourceFlow）
- ✅ 标签计数器（TagCounters - 用于转换统计）

**符合设计**: 95% - 核心完整，缺少RNG种子范围记录

---

#### 7. 职业模块化 ⭐⭐
**状态**: ✅ 基础完成

**实现文件**:
- `Domain/Combat/Professions/IProfessionModule.cs` - 职业接口
- `Domain/Combat/Professions/WarriorProfession.cs` - 战士实现
- `Domain/Combat/Professions/RangerProfession.cs` - 游侠实现

**功能**:
- ✅ 职业插件化架构
- ✅ 自定义资源桶配置
- ✅ 专属技能注册
- ✅ 战斗初始化钩子

**已实现职业**:
- 战士（Warrior）- 怒气机制
- 游侠（Ranger）- 集中值机制

**符合设计**: 70% - 基础框架完成，需要更多职业和特色机制

---

#### 8. RNG 可控系统 ⭐
**状态**: ✅ 完成

**实现文件**:
- `Domain/Combat/Rng/RngContext.cs` - 随机上下文

**功能**:
- ✅ 种子初始化
- ✅ 序列推进
- ✅ 可回放性

**符合设计**: 80% - 基础完成，缺少Segment级别种子范围记录

---

#### 9. Proc系统（触发效果） ⭐
**状态**: ✅ 完成

**实现文件**:
- `Domain/Combat/Procs/ProcDefinition.cs` - Proc定义
- `Domain/Combat/Procs/ProcRuntime.cs` - Proc运行态
- `Domain/Combat/Procs/ProcManager.cs` - Proc管理器

**功能**:
- ✅ RPPM（每分钟真实触发次数）机制
- ✅ 多种触发类型（OnHit/OnCrit/OnCast等）
- ✅ 冷却管理
- ✅ 动作执行（伤害/治疗/Buff等）

**符合设计**: 85% - 高级特性完整

---

#### 10. 敌人系统 ⭐
**状态**: ✅ 基础完成

**实现文件**:
- `Domain/Combat/Enemies/EnemyDefinition.cs` - 敌人定义
- `Domain/Combat/Enemies/EncounterGroup.cs` - 遭遇战组
- `Domain/Combat/Enemies/EnemyRegistry.cs` - 敌人注册表
- `Domain/Combat/Encounter.cs` - 遭遇战实例

**功能**:
- ✅ 敌人数据定义
- ✅ HP管理
- ✅ 死亡检测
- ✅ Overkill统计

**符合设计**: 60% - 基础完成，缺少怪物池与区域关联

---

### ❌ 未实现 (Phase 3-12)

#### 1. 活动计划系统（多槽调度） 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- ActivitySlot（3-5个槽位）
- ActivityPlan（战斗/采集/制作等类型）
- LimitSpec（Count/Duration/Infinite限制）
- 状态机（Pending→Running→Completed）
- 队列自动衔接

**影响**: 无法实现多任务并行与离线计划队列

---

#### 2. 离线快进引擎 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- OfflineFastForwardEngine
- 离线时长上限（12小时）
- 使用相同事件调度算法
- Segment批量生成
- 奖励包汇总

**影响**: 无法提供离线收益，严重影响放置游戏体验

---

#### 3. 地图与区域系统 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- MapRegion（区域定义）
- 怪物池（monsterPool）
- 解锁条件表达式
- 区域图关系（RegionGraph）

**影响**: 无进程感与内容引导

---

#### 4. 条件解锁DSL 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- ConditionExpr（表达式解析）
- 依赖跟踪
- 缓存与失效机制
- DSL示例：`AND(level>=20, reputation.factionA>=300)`

**影响**: 无法实现复杂解锁逻辑与进度门槛

---

#### 5. 装备强化系统 🔴
**状态**: ❌ 仅有占位

**当前状态**: Character中有基础属性（Strength/Agility等），但无装备实例

**设计需求**:
- GearDefinition/GearInstance
- Tier系统（T1/T2/T3）
- Affix词条系统
- 套装（SetBonus）
- 分解服务（DisenchantService）
- 重铸服务（ReforgeService/RerollService）

**影响**: 构筑深度严重不足

---

#### 6. 经济循环 🔴
**状态**: ❌ 无监控与闭环

**设计需求**:
- 产出渠道（战斗/采集/任务）
- 消耗槽位（升级/重铸/消耗品）
- 材料分层（Tier材料）
- 监控指标（gold_in_out_ratio等）
- MetricsCollector

**影响**: 无法控制通胀与游戏经济健康度

---

#### 7. 任务与声望系统 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- Quest定义与状态机
- 声望派系（Reputation/Faction）
- 日常/周常重置
- 奖励发放

**影响**: 缺少内容引导与长期目标

---

#### 8. 多角色Roster 🔴
**状态**: ❌ 完全缺失

**当前状态**: 虽有Character实体，但无Roster管理

**设计需求**:
- Roster槽位管理（最多5个）
- 槽位解锁条件
- 角色切换逻辑
- 后台活动继续推进

**影响**: 单角色体验单薄

---

#### 9. 消耗品系统 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- ConsumableLoadout（2通用+2战斗槽）
- UsePolicy（触发条件）
- 自动使用逻辑

---

#### 10. 组队与副本 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- DungeonRun
- DungeonSegment
- 持续挂机策略
- 产出递减（Diminishing）

---

#### 11. 配置版本化 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- ConfigBundle
- VersionPin
- 热更新流程
- 配置Diff报告

**影响**: 无法安全更新游戏数据

---

#### 12. 监控与调试面板 🔴
**状态**: ❌ 完全缺失

**设计需求**:
- MetricsCollector
- DebugSnapshotBuilder
- 实时指标（DPS/资源溢出率/技能跳过率）

**影响**: 无法诊断性能与平衡性问题

---

#### 13. 持久化事件溯源 🔴
**状态**: ⚠️ 部分实现

**当前状态**: 
- ✅ 有BattleRecord持久化
- ❌ 无EventStream
- ❌ 无CharacterSnapshot

**设计需求**:
- EventLog（append-only）
- 快照策略（每N分钟）
- 重放流程

---

## 已完成功能详解

### 1. 战斗事件循环架构 🏗️

**实现质量**: ⭐⭐⭐⭐⭐

这是整个游戏的核心基础，实现质量很高：

```csharp
// BattleRunner.cs 核心循环
while (scheduler.Count > 0)
{
    context.Buffs.Tick(clock.CurrentTime);        // Buff过期检查
    SyncTrackHaste(context);                      // 急速同步
    
    var ev = scheduler.PopNext();                 // 取最早事件
    clock.AdvanceTo(ev.ExecuteAt);                // 时间跳跃
    ev.Execute(context);                          // 执行事件
    
    collector.Tick(clock.CurrentTime);            // 统计更新
    
    if (collector.ShouldFlush(clock.CurrentTime)) // 段聚合
        segments.Add(collector.Flush(clock.CurrentTime));
}
```

**优点**:
- ✅ 确定性时间推进（可回放）
- ✅ 性能优异（O(log n)调度）
- ✅ 模块化事件处理
- ✅ 自动段聚合

---

### 2. 资源转换机制 💧

**实现质量**: ⭐⭐⭐⭐⭐

资源桶的Convert策略实现优雅：

```csharp
// ResourceBucket.cs
case OverflowPolicy.Convert:
    if (ConvertUnit > 0 && ConversionTag != null)
    {
        conversions = overflow / ConvertUnit;  // 完整单位转换
        Current = Max;                         // 保持上限
    }
```

**应用场景**:
- 怒气溢出 → 战意Buff层数
- 能量溢出 → 护盾吸收值
- 碎片溢出 → 特殊资源

---

### 3. 多充能技能 ⚡

**实现质量**: ⭐⭐⭐⭐

充能恢复链式触发实现精巧：

```csharp
// SkillRuntime.cs - TickRecharge
while (NextChargeReadyAt.HasValue && now >= NextChargeReadyAt.Value)
{
    Charges = Math.Min(Definition.MaxCharges, Charges + 1);
    if (Charges < Definition.MaxCharges)
        NextChargeReadyAt = NextChargeReadyAt.Value + _rechargeStepSeconds;
    else
        NextChargeReadyAt = null; // 满充能停止
}
```

**特性**:
- ✅ 支持单充能（传统CD）
- ✅ 支持多充能（2-3层）
- ✅ 打断返还充能
- ✅ 施法消耗时机可配置

---

### 4. Buff叠加聚合器 📈

**实现质量**: ⭐⭐⭐⭐

BuffAggregate提供灵活的属性修饰：

```csharp
// 叠加公式：final = clamp(((base + ΣAdditive) * Π(1+Mult)) + ΣFinalAdd)
public double ApplyToBaseDamage(double baseValue)
{
    var add = AdditiveStats.GetValueOrDefault("damage", 0);
    var mult = MultiplicativeStats.GetValueOrDefault("damage_mult", 0);
    var finalAdd = FinalAdditiveStats.GetValueOrDefault("damage_final", 0);
    
    return Math.Max(0, ((baseValue + add) * (1 + mult)) + finalAdd);
}
```

**优点**:
- ✅ 清晰的优先级（加法→乘法→最终加法）
- ✅ 支持Clamp防溢出
- ✅ 多Buff自动聚合

---

## 缺失功能分析

### 🔴 高优先级缺失（影响核心体验）

#### 1. 离线快进系统 ⛔
**紧急度**: ⭐⭐⭐⭐⭐

**影响**:
- 放置游戏的核心特性缺失
- 玩家离线无收益，严重影响留存
- 与设计愿景不符

**所需工作量**: 中等（3-5天）

**依赖**:
- ✅ EventScheduler已有
- ✅ BattleRunner可复用
- ❌ 需要ActivityPlan系统配合

**实现建议**:
```csharp
public class OfflineFastForwardEngine
{
    public OfflineResult Simulate(
        Character character,
        double offlineSeconds,      // 离线时长（上限12h）
        ActivityPlan lastActivity)  // 最后活动状态
    {
        var capSeconds = Math.Min(offlineSeconds, 12 * 3600);
        var battleRunner = new BattleRunner();
        
        // 使用相同的事件调度逻辑
        var segments = battleRunner.RunForDuration(...);
        
        return new OfflineResult
        {
            SegmentsGenerated = segments,
            GoldEarned = ...,
            ExperienceGained = ...
        };
    }
}
```

---

#### 2. 活动计划系统 ⛔
**紧急度**: ⭐⭐⭐⭐⭐

**影响**:
- 玩家只能单任务战斗
- 无法队列多个活动
- 离线系统无法实现

**所需工作量**: 中等（4-6天）

**关键结构**:
```csharp
public class ActivitySlot
{
    public int SlotIndex { get; init; }
    public Guid? CurrentPlanId { get; set; }
    public List<ActivityPlan> Queue { get; } = new();
}

public class ActivityPlan
{
    public Guid Id { get; init; }
    public ActivityType Type { get; init; }      // Combat/Gather/Craft
    public LimitSpec Limit { get; init; }        // Count/Duration/Infinite
    public PlanState State { get; set; }         // Pending/Running/Completed
    public Dictionary<string, object> Payload { get; init; } // 活动参数
}
```

---

#### 3. 装备强化生态 ⛔
**紧急度**: ⭐⭐⭐⭐

**影响**:
- 构筑深度不足
- 缺少长期追求目标
- 经济循环无消耗端

**所需工作量**: 大（7-10天）

**子系统**:
- GearInstance（装备实例）
- Affix生成器（词条随机）
- Tier升级服务
- Reroll服务（词条重置）
- Disenchant服务（分解）

**实现优先级**:
1. GearInstance + 基础Affix（3天）
2. 分解与材料系统（2天）
3. Tier升级（2天）
4. Reroll机制（2天）
5. 套装系统（1天）

---

#### 4. 地图与区域 ⛔
**紧急度**: ⭐⭐⭐⭐

**影响**:
- 内容平坦，无进度感
- 怪物选择单调
- 无探索引导

**所需工作量**: 中等（5-7天）

**核心组件**:
```csharp
public class MapRegion
{
    public string Id { get; init; }
    public (int min, int max) LevelRange { get; init; }
    public List<EnemyPoolEntry> MonsterPool { get; init; }
    public string? UnlockConditionExpr { get; init; }  // 需条件DSL支持
}

public class RegionGraph
{
    public Dictionary<string, List<string>> Adjacencies { get; init; }
}
```

---

### 🟡 中优先级缺失（影响可玩性）

#### 5. 条件解锁DSL ⚠️
**紧急度**: ⭐⭐⭐

**依赖于**: 地图、多角色、装备解锁等多个系统

**所需工作量**: 中等（4-5天）

**示例实现**:
```csharp
// 表达式解析器
public class ConditionExpr
{
    public string Id { get; init; }
    public string Raw { get; init; }           // "AND(level>=20, quest.completed('Q123'))"
    public List<string> Dependencies { get; init; }  // ["level", "quest.Q123"]
    
    public bool Evaluate(ConditionContext ctx)
    {
        // AST解析与执行
    }
}

// 缓存层
public class ConditionCache
{
    private Dictionary<string, bool> _resultCache = new();
    private Dictionary<string, List<string>> _depIndex = new();
    
    public void Invalidate(string depKey)
    {
        // 失效相关条件结果
    }
}
```

---

#### 6. 任务系统 ⚠️
**紧急度**: ⭐⭐⭐

**影响**:
- 无引导流程
- 缺少内容串联

**所需工作量**: 中等（5-6天）

---

#### 7. 多角色Roster ⚠️
**紧急度**: ⭐⭐⭐

**影响**:
- 单角色体验单薄
- 职业特色无法充分体验

**所需工作量**: 小（2-3天）

---

### 🟢 低优先级缺失（锦上添花）

#### 8. 配置版本化 ℹ️
**紧急度**: ⭐⭐

**建议**: 初期可用简单版本号管理，后期重构

---

#### 9. 监控面板 ℹ️
**紧急度**: ⭐⭐

**建议**: 初期用日志，后期添加可视化面板

---

#### 10. 组队与副本 ℹ️
**紧急度**: ⭐

**建议**: 后期社交功能，先完善单人体验

---

## 阶段性开发路线图

基于设计文档的Phase Plan（第25章），结合当前实现状态，调整后的路线图如下：

### ✅ Phase 1-2（已完成 - 75%）
**时间**: 已投入约2-3个月  
**目标**: 战斗核心骨架

**交付**:
- ✅ GameClock, EventScheduler
- ✅ AttackTrack, SpecialTrack
- ✅ ResourceBucket, OverflowPolicy
- ✅ AutoCastEngine, SkillSlot
- ✅ BuffManager, BuffAggregate
- ✅ CombatSegment聚合

**剩余工作**:
- ⚠️ RNG种子范围记录（1天）
- ⚠️ 职业扩展（法师/盗贼等，3-5天）

---

### 🚧 Phase 3（进行中 - 建议优先）
**预计时间**: 4-6周  
**目标**: 活动调度统一

**核心交付**:
- ❌ ActivitySlot（3-5槽位）
- ❌ ActivityPlan状态机
- ❌ 活动类型扩展（Combat/Gather/Craft）
- ❌ 队列自动衔接逻辑

**依赖**: 无，可立即开始

**里程碑**:
1. Week 1-2: 基础数据结构与状态机
2. Week 3-4: 战斗活动集成
3. Week 5-6: 采集/制作活动占位 + 测试

---

### 🔜 Phase 4（高优先级 - 必须完成）
**预计时间**: 3-4周  
**目标**: 离线快进 + CombatSegment完善

**核心交付**:
- ❌ OfflineFastForwardEngine
- ❌ 离线上限配置（12小时）
- ❌ Segment批量生成优化
- ⚠️ RNG种子范围记录（补充Phase2遗漏）

**依赖**: Phase 3（ActivityPlan系统）

**里程碑**:
1. Week 1: OfflineEngine基础实现
2. Week 2: 与ActivityPlan集成
3. Week 3: 分段防卡顿优化
4. Week 4: 测试与调优

---

### 🔜 Phase 5（高优先级 - 内容扩展）
**预计时间**: 5-6周  
**目标**: 条件引擎 + 地图/区域基础

**核心交付**:
- ❌ ConditionExpr解析器
- ❌ ConditionCache缓存层
- ❌ MapRegion定义
- ❌ RegionGraph关系
- ❌ 区域怪物池随机

**依赖**: 无（可与Phase 4并行开发条件引擎部分）

**里程碑**:
1. Week 1-2: 条件DSL设计与解析器
2. Week 3-4: MapRegion数据结构 + 初始区域数据
3. Week 5: RegionGraph实现
4. Week 6: UI集成与测试

---

### 🔜 Phase 6（高优先级 - 核心玩法）
**预计时间**: 7-10周  
**目标**: 装备扩展（Tier/Affix/分解/重铸）

**核心交付**:
- ❌ GearDefinition/GearInstance
- ❌ Affix词条系统
- ❌ Tier升级（T1→T2→T3）
- ❌ Disenchant服务（分解）
- ❌ Reroll服务（词条重置）
- ❌ SetBonus套装系统

**依赖**: Phase 5（区域系统提供装备掉落场景）

**里程碑**:
1. Week 1-3: GearInstance + 基础Affix生成
2. Week 4-5: 分解与材料系统
3. Week 6-7: Tier升级服务
4. Week 8-9: Reroll机制
5. Week 10: 套装系统

---

### 🔜 Phase 7（中优先级）
**预计时间**: 3-4周  
**目标**: Buff运行态完善 + 资源溢出Convert

**核心交付**:
- ⚠️ BuffInstance生命周期完善（80%已完成）
- ⚠️ Convert触发Buff实例
- ❌ 资源溢出→Buff的自动化流程

**依赖**: Phase 6（可能需要装备Proc触发）

---

### 🔜 Phase 8（中优先级 - 经济闭环）
**预计时间**: 4-5周  
**目标**: 经济监控 & 指标埋点

**核心交付**:
- ❌ MetricsCollector
- ❌ EconomyEvents（金币/材料流水）
- ❌ 产出/消耗监控
- ❌ 通胀控制机制

**依赖**: Phase 6（装备系统提供消耗端）

---

### 🔜 Phase 9（中优先级 - 开发工具）
**预计时间**: 2-3周  
**目标**: Debug面板API

**核心交付**:
- ❌ DebugSnapshotBuilder
- ❌ 实时Track/Resource/Buff状态查看
- ❌ 战斗日志回放

**依赖**: Phase 8（集成Metrics数据）

---

### 🔜 Phase 10（中优先级 - 运维支持）
**预计时间**: 3-4周  
**目标**: Config版本化/热更 & VersionPin

**核心交付**:
- ❌ ConfigBundle
- ❌ VersionPin机制
- ❌ 热更新流程
- ❌ 配置Diff报告

**依赖**: 前期可使用简单版本号管理

---

### 🔜 Phase 11（低优先级 - 内容拓展）
**预计时间**: 5-6周  
**目标**: 职业增强 / 特殊区域事件

**核心交付**:
- ❌ 更多职业（法师/盗贼/牧师等）
- ❌ 职业特色机制深化
- ❌ 区域事件系统
- ❌ 稀有怪/精英怪

**依赖**: Phase 5-6（区域与装备系统）

---

### 🔜 Phase 12（低优先级 - 未来拓展）
**预计时间**: 待评估  
**目标**: 高级玩法（赛季/排行/社交）

**核心交付**:
- ❌ 赛季系统草案
- ❌ 排行榜
- ❌ 组队/副本系统
- ❌ 公会系统（长期）

**依赖**: 核心玩法完善后再考虑

---

## 技术债务与优化机会

### 🔧 代码质量问题

#### 1. 命名空间混乱 ⚠️
**问题**: 
- `BlazorWebGame.Domain.Combat` 与 `BlazorIdle.Server.Domain.Combat` 混用
- GameClock/EventScheduler在`BlazorWebGame`命名空间

**影响**: 代码可读性差，引用容易出错

**修复建议**: 统一命名空间为`BlazorIdle.Server.Domain.*`

**工作量**: 小（1天）

---

#### 2. 持久化层耦合 ⚠️
**问题**: 设计文档24章提到"Domain / Persistence分层混用实体/领域"

**影响**: 
- 领域模型被持久化关注污染
- 难以切换存储方案

**修复建议**:
```csharp
// 当前: Character直接用于EF
public class Character { ... }

// 建议: 分离
public class Character { ... }                    // Domain
public class CharacterEntity { ... }              // Persistence
public static class CharacterMapper { ... }       // Mapping
```

**工作量**: 中等（3-5天）

---

#### 3. RNG种子范围缺失 ⚠️
**问题**: CombatSegment未记录`rngSeedStart/rngSeedEnd`

**影响**: 
- 无法回放特定Segment
- 反作弊能力不足

**修复建议**:
```csharp
public class CombatSegment
{
    // 新增字段
    public long RngSeedStart { get; set; }
    public long RngSeedEnd { get; set; }
}
```

**工作量**: 小（1天）

---

### ⚡ 性能优化机会

#### 1. 对象池 💡
**场景**: 高频事件对象（AttackTickEvent等）

**当前**: 每次new，触发GC

**优化方案**:
```csharp
public class EventPool<T> where T : IGameEvent, new()
{
    private Stack<T> _pool = new();
    
    public T Rent() => _pool.Count > 0 ? _pool.Pop() : new T();
    public void Return(T obj) => _pool.Push(obj);
}
```

**预期提升**: 减少GC 30-50%

**工作量**: 中等（2-3天）

---

#### 2. Segment预分配 💡
**场景**: SegmentCollector的Dictionary频繁扩容

**优化方案**: 初始化时预分配容量

**预期提升**: 减少内存分配 20%

**工作量**: 小（1天）

---

#### 3. 批量事件调度 💡
**场景**: 多个同时间事件（如多个Buff同时过期）

**优化方案**: 
```csharp
public void ScheduleBatch(IEnumerable<IGameEvent> events)
{
    foreach (var ev in events)
        _pq.Enqueue(ev, ev.ExecuteAt);
}
```

**预期提升**: 减少调度开销 10-15%

**工作量**: 小（1天）

---

### 🏗️ 架构改进建议

#### 1. 引入Domain Events Bus 💡
**目的**: 解耦模块间通信

**当前问题**: 
- 资源溢出→Buff添加 逻辑耦合
- 装备变更→属性重算 手动触发

**改进方案**:
```csharp
public interface IDomainEventBus
{
    void Publish<T>(T ev) where T : IDomainEvent;
    void Subscribe<T>(Action<T> handler) where T : IDomainEvent;
}

// 示例事件
public record ResourceOverflowEvent(string ResourceId, int OverflowAmount);
public record EquipmentChangedEvent(Guid CharacterId, GearSlot Slot);
```

**收益**:
- ✅ 模块解耦
- ✅ 易于添加新功能（如监控、日志）
- ✅ 支持事件溯源

**工作量**: 中等（3-4天）

---

#### 2. 配置数据驱动 💡
**当前问题**: 
- 技能定义硬编码在职业模块
- 敌人数据散落各处

**改进方案**:
```csharp
// skills.json
{
  "warrior_slash": {
    "id": "warrior_slash",
    "baseDamage": 50,
    "cooldown": 3.0,
    "costs": [{"resource": "rage", "amount": 20}]
  }
}

// 加载器
public class ConfigLoader
{
    public Dictionary<string, SkillDefinition> LoadSkills(string path);
}
```

**收益**:
- ✅ 数据与代码分离
- ✅ 支持热更新
- ✅ 策划友好

**工作量**: 大（5-7天）

---

## 优先级建议

基于影响度与依赖关系，建议开发顺序：

### 🔥 立即开始（Q1 2025）

1. **Phase 3: ActivityPlan系统** (4-6周)
   - 理由：离线系统的前置依赖
   - 影响：解锁核心玩法

2. **Phase 4: 离线快进** (3-4周)
   - 理由：放置游戏核心特性
   - 影响：玩家留存关键

3. **修复技术债务**（并行进行）
   - 命名空间统一（1天）
   - RNG种子范围记录（1天）

---

### 🎯 短期目标（Q2 2025）

4. **Phase 5: 条件引擎 + 地图系统** (5-6周)
   - 理由：内容扩展基础
   - 影响：进度感与引导

5. **Phase 6: 装备系统** (7-10周)
   - 理由：构筑深度核心
   - 影响：长期目标与经济闭环

---

### 📅 中期目标（Q3-Q4 2025）

6. **Phase 7: Buff运行态完善** (3-4周)
7. **Phase 8: 经济监控** (4-5周)
8. **Phase 9: Debug面板** (2-3周)
9. **Phase 10: 配置版本化** (3-4周)

---

### 🔮 长期目标（2026+）

10. **Phase 11: 职业扩展 + 特殊事件**
11. **Phase 12: 赛季/社交系统**

---

## 总结

### 🎉 已取得的成就

BlazorIdle项目已经完成了**坚实的技术基础**：

1. ✅ **事件驱动架构** - 优秀的调度与时间推进机制
2. ✅ **双轨战斗** - 独特的节奏设计实现完整
3. ✅ **资源系统** - 灵活的ResourceBucket与溢出策略
4. ✅ **技能系统** - 多充能机制与自动施放
5. ✅ **Buff系统** - 完善的叠加与聚合逻辑
6. ✅ **职业模块化** - 可扩展的插件架构

**核心战斗循环已经可玩**，并且代码质量较高。

---

### 🚨 关键瓶颈

当前阻碍游戏体验的三大缺失：

1. ❌ **离线快进系统** - 放置游戏的灵魂
2. ❌ **活动计划系统** - 多任务与队列管理
3. ❌ **装备强化生态** - 构筑深度与长期目标

这三个系统缺失导致游戏仅是**战斗演示Demo**，尚未成为完整的游戏循环。

---

### 🎯 下一步行动建议

#### 立即行动（本月）:
1. **启动Phase 3** - ActivityPlan系统开发
2. **修复命名空间** - 清理技术债务
3. **补充RNG种子记录** - 完善追溯能力

#### 近期目标（3个月内）:
1. 完成ActivityPlan系统
2. 实现离线快进引擎
3. 开始地图与区域系统

#### 中期愿景（6个月内）:
1. 装备系统完整实现
2. 经济闭环建立
3. 内容扩展（多职业/多区域）

---

### 📊 完成度评估

| 层级 | 完成度 | 说明 |
|------|--------|------|
| **核心框架** | 🟢 90% | 事件调度、时钟、调度器完善 |
| **战斗系统** | 🟢 75% | 双轨、资源、技能、Buff完整 |
| **内容系统** | 🟡 15% | 缺少地图、任务、装备强化 |
| **经济循环** | 🔴 5% | 仅有占位，无闭环 |
| **元系统** | 🔴 0% | 离线、多角色、配置管理全缺失 |
| **运维工具** | 🔴 0% | 监控、调试、热更新全缺失 |

**总体评估**: 约 **28%** 完成度

---

### 💡 最后的话

BlazorIdle项目的**技术基座已经非常扎实**，设计文档也非常完善。接下来的关键是**快速补齐核心玩法系统**，特别是：

1. **离线快进** - 让放置游戏真正"放置"
2. **活动系统** - 让玩家有事可做
3. **装备强化** - 让玩家有目标可追

完成这三个系统后，游戏将从**技术Demo**蜕变为**可玩的Alpha版本**。

建议采用**敏捷开发**方式，每2-3周发布一个可玩版本，快速迭代与验证设计。

祝项目成功！🚀

---

**文档维护**: 建议每完成一个Phase后更新本文档的完成度
**下次更新**: Phase 3完成后（预计2-3个月后）
