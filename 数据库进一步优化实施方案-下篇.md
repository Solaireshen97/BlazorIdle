# BlazorIdle 数据库进一步优化实施方案 - 下篇

**项目名称**: BlazorIdle 数据库进一步优化  
**方案版本**: 1.0  
**编制日期**: 2025-10-19  
**适用范围**: Phase 6 - 实时监控与可视化

---

## 📋 文档说明

本文档是《数据库操作深度分析报告》的配套实施方案（下篇）：
- **上篇**: Phase 4 - 查询优化与索引增强
- **中篇**: Phase 5 - 智能预加载与缓存预热
- **下篇 (本文档)**: Phase 6 - 实时监控与可视化

**重要提示**: 
- **强烈推荐实施** Phase 6，是了解系统真实性能的基础
- 建议优先级: Phase 6 > Phase 4 > Phase 5
- 实施难度低，收益高

---

## 🎯 Phase 6: 实时监控与可视化

### 目标与预期效果

**优化目标**:
1. 建立实时性能监控体系
2. 可视化数据库操作和缓存效率
3. 及时发现和定位性能瓶颈
4. 支持数据驱动的优化决策

**预期效果**:
- ✅ 实时监控所有数据库操作
- ✅ Grafana 仪表板可视化展示
- ✅ 自动告警机制
- ✅ 性能问题发现时间缩短 90%

**优先级**: ⭐⭐⭐⭐ (高优先级，强烈推荐)

**工时估算**: 10-15 人日

**风险级别**: 低

---

## 📊 阶段规划

### 总体分为 5 个子阶段

| 阶段 | 任务 | 工时 | 风险 | 优先级 |
|------|------|------|------|--------|
| 6.1 | Prometheus 集成与指标导出 | 3-4 天 | 低 | P0 |
| 6.2 | Grafana 仪表板设计与配置 | 3-4 天 | 低 | P0 |
| 6.3 | 告警规则配置 | 2-3 天 | 低 | P0 |
| 6.4 | 集成测试与验证 | 2-3 天 | 低 | P0 |
| 6.5 | 文档与培训 | 1-2 天 | 低 | P1 |

**总工时**: 11-16 天

---

## 📈 阶段 6.1: Prometheus 集成与指标导出

### 6.1.1 安装 Prometheus

**Docker Compose 配置**:

**文件**: `/monitoring/docker-compose.yml`

```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: blazoridle-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    restart: unless-stopped
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: blazoridle-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - monitoring

volumes:
  prometheus-data:
  grafana-data:

networks:
  monitoring:
    driver: bridge
```

**Prometheus 配置**:

**文件**: `/monitoring/prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'blazoridle-monitor'

# 告警规则文件
rule_files:
  - 'alert-rules.yml'

# Alertmanager 配置（可选）
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets: ['alertmanager:9093']

# 抓取目标配置
scrape_configs:
  # BlazorIdle 服务端
  - job_name: 'blazoridle-server'
    static_configs:
      - targets: ['host.docker.internal:5000']
    metrics_path: '/metrics'
    scrape_interval: 10s
```

### 6.1.2 集成 Prometheus .NET 客户端

**安装 NuGet 包**:

```bash
dotnet add package prometheus-net.AspNetCore
```

**配置 Program.cs**:

```csharp
using Prometheus;

var builder = WebApplication.CreateBuilder(args);

// ... 其他服务配置

var app = builder.Build();

// 启用 Prometheus 指标
app.UseMetricServer(); // 默认端点 /metrics
app.UseHttpMetrics();  // HTTP 请求指标

// ... 其他中间件

app.Run();
```

### 6.1.3 定义自定义指标

**文件**: `BlazorIdle.Server/Infrastructure/Monitoring/PrometheusMetrics.cs`

```csharp
using Prometheus;

namespace BlazorIdle.Server.Infrastructure.Monitoring;

/// <summary>
/// Prometheus 指标定义
/// Prometheus metrics definitions
/// </summary>
public static class PrometheusMetrics
{
    // ===== 数据库操作指标 =====
    
    /// <summary>
    /// 数据库读取操作计数器
    /// Database read operations counter
    /// </summary>
    public static readonly Counter DbReads = Metrics.CreateCounter(
        "blazoridle_db_reads_total",
        "Total number of database read operations",
        new CounterConfiguration
        {
            LabelNames = new[] { "entity_type", "cache_hit" }
        }
    );
    
    /// <summary>
    /// 数据库写入操作计数器
    /// Database write operations counter
    /// </summary>
    public static readonly Counter DbWrites = Metrics.CreateCounter(
        "blazoridle_db_writes_total",
        "Total number of database write operations",
        new CounterConfiguration
        {
            LabelNames = new[] { "entity_type", "batch_size" }
        }
    );
    
    /// <summary>
    /// 数据库查询时长直方图
    /// Database query duration histogram
    /// </summary>
    public static readonly Histogram DbQueryDuration = Metrics.CreateHistogram(
        "blazoridle_db_query_duration_seconds",
        "Database query duration in seconds",
        new HistogramConfiguration
        {
            LabelNames = new[] { "entity_type", "operation" },
            Buckets = Histogram.ExponentialBuckets(0.001, 2, 10) // 1ms ~ 512ms
        }
    );
    
    // ===== 缓存效率指标 =====
    
    /// <summary>
    /// 缓存命中率
    /// Cache hit rate
    /// </summary>
    public static readonly Gauge CacheHitRate = Metrics.CreateGauge(
        "blazoridle_cache_hit_rate",
        "Cache hit rate percentage (0-100)",
        new GaugeConfiguration
        {
            LabelNames = new[] { "entity_type" }
        }
    );
    
    /// <summary>
    /// 缓存大小（实体数量）
    /// Cache size (number of entities)
    /// </summary>
    public static readonly Gauge CacheSize = Metrics.CreateGauge(
        "blazoridle_cache_size",
        "Number of entities currently in cache",
        new GaugeConfiguration
        {
            LabelNames = new[] { "entity_type" }
        }
    );
    
    /// <summary>
    /// Dirty 实体数量
    /// Number of dirty entities
    /// </summary>
    public static readonly Gauge DirtyEntitiesCount = Metrics.CreateGauge(
        "blazoridle_dirty_entities_count",
        "Number of dirty entities pending save",
        new GaugeConfiguration
        {
            LabelNames = new[] { "entity_type" }
        }
    );
    
    // ===== 持久化操作指标 =====
    
    /// <summary>
    /// 批量保存操作计数器
    /// Batch save operations counter
    /// </summary>
    public static readonly Counter BatchSaves = Metrics.CreateCounter(
        "blazoridle_batch_saves_total",
        "Total number of batch save operations",
        new CounterConfiguration
        {
            LabelNames = new[] { "entity_type", "success" }
        }
    );
    
    /// <summary>
    /// 批量保存时长直方图
    /// Batch save duration histogram
    /// </summary>
    public static readonly Histogram BatchSaveDuration = Metrics.CreateHistogram(
        "blazoridle_batch_save_duration_seconds",
        "Batch save operation duration in seconds",
        new HistogramConfiguration
        {
            LabelNames = new[] { "entity_type" },
            Buckets = Histogram.ExponentialBuckets(0.01, 2, 10) // 10ms ~ 5.12s
        }
    );
    
    // ===== 业务指标 =====
    
    /// <summary>
    /// 在线玩家数量
    /// Number of online players
    /// </summary>
    public static readonly Gauge OnlinePlayers = Metrics.CreateGauge(
        "blazoridle_online_players",
        "Number of currently online players"
    );
    
    /// <summary>
    /// 活跃战斗数量
    /// Number of active battles
    /// </summary>
    public static readonly Gauge ActiveBattles = Metrics.CreateGauge(
        "blazoridle_active_battles",
        "Number of currently active battles"
    );
}
```

### 6.1.4 集成指标到 Repository

**更新 RepositoryBase**:

```csharp
public override async Task<T?> GetAsync(Guid id, CancellationToken ct = default)
{
    using (PrometheusMetrics.DbQueryDuration
        .WithLabels(typeof(T).Name, "get")
        .NewTimer())
    {
        var result = await base_GetAsync(id, ct);
        
        // 记录读取指标
        var cacheHit = result != null && WasFromCache(id);
        PrometheusMetrics.DbReads
            .WithLabels(typeof(T).Name, cacheHit ? "true" : "false")
            .Inc();
        
        return result;
    }
}
```

**更新 PersistenceCoordinator**:

```csharp
private async Task SaveEntitiesAsync<T>(
    IMemoryStateManager<T> manager,
    string entityType,
    CancellationToken ct) where T : class, IEntity
{
    var dirtyEntities = manager.GetDirtyEntities().ToList();
    if (dirtyEntities.Count == 0)
        return;
    
    // 记录 Dirty 数量
    PrometheusMetrics.DirtyEntitiesCount
        .WithLabels(entityType)
        .Set(dirtyEntities.Count);
    
    using (PrometheusMetrics.BatchSaveDuration
        .WithLabels(entityType)
        .NewTimer())
    {
        try
        {
            // 保存逻辑...
            await SaveToDatabase(dirtyEntities, ct);
            
            // 成功
            PrometheusMetrics.BatchSaves
                .WithLabels(entityType, "true")
                .Inc();
        }
        catch (Exception ex)
        {
            // 失败
            PrometheusMetrics.BatchSaves
                .WithLabels(entityType, "false")
                .Inc();
            
            throw;
        }
    }
}
```

### 6.1.5 验证 Prometheus 指标

```bash
# 1. 启动 Prometheus
cd monitoring
docker-compose up -d prometheus

# 2. 访问 Prometheus UI
http://localhost:9090

# 3. 查询指标示例
blazoridle_db_reads_total
blazoridle_cache_hit_rate
blazoridle_db_query_duration_seconds
```

---

## 📊 阶段 6.2: Grafana 仪表板设计

### 6.2.1 安装并配置 Grafana

```bash
# 启动 Grafana (已在 docker-compose.yml 中配置)
docker-compose up -d grafana

# 访问 Grafana UI
http://localhost:3000
# 默认用户名/密码: admin/admin
```

### 6.2.2 配置 Prometheus 数据源

**文件**: `/monitoring/grafana/provisioning/datasources/prometheus.yml`

```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
```

### 6.2.3 仪表板设计

**文件**: `/monitoring/grafana/dashboards/database-performance.json`

```json
{
  "dashboard": {
    "title": "BlazorIdle Database Performance",
    "uid": "blazoridle-db-perf",
    "timezone": "browser",
    "schemaVersion": 16,
    "version": 1,
    "refresh": "10s",
    
    "panels": [
      {
        "id": 1,
        "title": "Database I/O Operations (Rate)",
        "type": "graph",
        "gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "rate(blazoridle_db_reads_total{cache_hit='false'}[5m])",
            "legendFormat": "Reads (Cache Miss) - {{entity_type}}"
          },
          {
            "expr": "rate(blazoridle_db_reads_total{cache_hit='true'}[5m])",
            "legendFormat": "Reads (Cache Hit) - {{entity_type}}"
          },
          {
            "expr": "rate(blazoridle_db_writes_total[5m])",
            "legendFormat": "Writes - {{entity_type}}"
          }
        ],
        "yaxes": [
          { "format": "ops", "label": "Operations/sec" }
        ]
      },
      
      {
        "id": 2,
        "title": "Cache Hit Rate by Entity Type",
        "type": "graph",
        "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "blazoridle_cache_hit_rate",
            "legendFormat": "{{entity_type}}"
          }
        ],
        "yaxes": [
          { "format": "percent", "label": "Hit Rate (%)", "min": 0, "max": 100 }
        ],
        "alert": {
          "conditions": [
            {
              "evaluator": { "params": [60], "type": "lt" },
              "operator": { "type": "and" },
              "query": { "params": ["A", "5m", "now"] },
              "reducer": { "params": [], "type": "avg" },
              "type": "query"
            }
          ],
          "name": "Low Cache Hit Rate Alert"
        }
      },
      
      {
        "id": 3,
        "title": "Query Duration (P95)",
        "type": "graph",
        "gridPos": { "x": 0, "y": 8, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(blazoridle_db_query_duration_seconds_bucket[5m]))",
            "legendFormat": "P95 - {{entity_type}}.{{operation}}"
          }
        ],
        "yaxes": [
          { "format": "s", "label": "Duration (seconds)" }
        ]
      },
      
      {
        "id": 4,
        "title": "Cache Size & Dirty Entities",
        "type": "graph",
        "gridPos": { "x": 12, "y": 8, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "blazoridle_cache_size",
            "legendFormat": "Cache Size - {{entity_type}}"
          },
          {
            "expr": "blazoridle_dirty_entities_count",
            "legendFormat": "Dirty - {{entity_type}}"
          }
        ],
        "yaxes": [
          { "format": "short", "label": "Count" }
        ]
      },
      
      {
        "id": 5,
        "title": "Batch Save Duration (P99)",
        "type": "graph",
        "gridPos": { "x": 0, "y": 16, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "histogram_quantile(0.99, rate(blazoridle_batch_save_duration_seconds_bucket[5m]))",
            "legendFormat": "P99 - {{entity_type}}"
          }
        ],
        "yaxes": [
          { "format": "s", "label": "Duration (seconds)" }
        ]
      },
      
      {
        "id": 6,
        "title": "Online Players & Active Battles",
        "type": "stat",
        "gridPos": { "x": 12, "y": 16, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "blazoridle_online_players",
            "legendFormat": "Online Players"
          },
          {
            "expr": "blazoridle_active_battles",
            "legendFormat": "Active Battles"
          }
        ]
      }
    ]
  }
}
```

### 6.2.4 仪表板预览

访问仪表板:
```
http://localhost:3000/d/blazoridle-db-perf/blazoridle-database-performance
```

---

## 🚨 阶段 6.3: 告警规则配置

### 6.3.1 Prometheus 告警规则

**文件**: `/monitoring/alert-rules.yml`

```yaml
groups:
  - name: database_performance
    interval: 30s
    rules:
      # 缓存命中率低于阈值
      - alert: LowCacheHitRate
        expr: blazoridle_cache_hit_rate < 60
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Cache hit rate is below 60%"
          description: "{{ $labels.entity_type }} cache hit rate: {{ $value }}%"
      
      # 数据库 I/O 操作激增
      - alert: HighDatabaseIORate
        expr: |
          sum(rate(blazoridle_db_reads_total{cache_hit='false'}[5m])) +
          sum(rate(blazoridle_db_writes_total[5m])) > 100
        for: 5m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database I/O rate is abnormally high"
          description: "Current I/O rate: {{ $value }} ops/s (threshold: 100 ops/s)"
      
      # 查询延迟过高
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95, 
            rate(blazoridle_db_query_duration_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "P95 query duration exceeds 1 second"
          description: "{{ $labels.entity_type }}.{{ $labels.operation }}: {{ $value }}s"
      
      # Dirty 实体过多
      - alert: TooManyDirtyEntities
        expr: blazoridle_dirty_entities_count > 5000
        for: 10m
        labels:
          severity: warning
          component: persistence
        annotations:
          summary: "Too many dirty entities pending save"
          description: "{{ $labels.entity_type }}: {{ $value }} dirty entities"
      
      # 批量保存失败率过高
      - alert: HighBatchSaveFailureRate
        expr: |
          sum(rate(blazoridle_batch_saves_total{success='false'}[5m])) /
          sum(rate(blazoridle_batch_saves_total[5m])) > 0.1
        for: 5m
        labels:
          severity: critical
          component: persistence
        annotations:
          summary: "Batch save failure rate exceeds 10%"
          description: "Failure rate: {{ $value | humanizePercentage }}"
```

### 6.3.2 Grafana 告警通知

**配置邮件通知**:

**文件**: `/monitoring/grafana/provisioning/notifiers/email.yml`

```yaml
notifiers:
  - name: email-notifier
    type: email
    uid: email1
    settings:
      addresses: "admin@example.com"
      singleEmail: true
    is_default: true
```

**配置 Slack 通知**:

```yaml
notifiers:
  - name: slack-notifier
    type: slack
    uid: slack1
    settings:
      url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
      recipient: "#alerts"
      username: "BlazorIdle Monitor"
```

---

## ✅ 阶段 6.4: 集成测试与验证

### 6.4.1 测试计划

**测试场景**:
1. 正常负载下的指标采集
2. 高负载下的指标采集
3. 缓存命中率变化监控
4. 告警触发测试

### 6.4.2 负载测试脚本

**文件**: `/tests/load-test/database-load-test.js` (k6)

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 }, // 爬升到100虚拟用户
    { duration: '5m', target: 100 }, // 保持100虚拟用户
    { duration: '2m', target: 0 },   // 降至0
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'], // P95 < 200ms
  },
};

const BASE_URL = 'http://localhost:5000';

export default function () {
  // 模拟用户登录
  let loginRes = http.post(`${BASE_URL}/api/auth/login`, JSON.stringify({
    username: `user${__VU}`,
    password: 'password123'
  }), {
    headers: { 'Content-Type': 'application/json' },
  });
  
  check(loginRes, { 'login successful': (r) => r.status === 200 });
  
  if (loginRes.status === 200) {
    let token = loginRes.json('token');
    
    // 模拟查询角色
    let characterRes = http.get(`${BASE_URL}/api/characters`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });
    
    check(characterRes, { 'get characters successful': (r) => r.status === 200 });
    
    sleep(1);
    
    // 模拟查询装备
    let gearRes = http.get(`${BASE_URL}/api/gear`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });
    
    check(gearRes, { 'get gear successful': (r) => r.status === 200 });
  }
  
  sleep(Math.random() * 3);
}
```

**运行负载测试**:

```bash
k6 run tests/load-test/database-load-test.js
```

### 6.4.3 验证清单

- [ ] Prometheus 成功采集指标
- [ ] Grafana 仪表板正常显示
- [ ] 所有面板数据准确
- [ ] 告警规则正常触发
- [ ] 告警通知正常发送
- [ ] 负载测试通过
- [ ] 性能指标符合预期

---

## 📚 阶段 6.5: 文档与培训

### 6.5.1 运维文档

**文件**: `/docs/monitoring/operations-guide.md`

```markdown
# BlazorIdle 监控运维指南

## 日常检查清单

### 每日检查
- [ ] 检查 Grafana 仪表板，确认无异常
- [ ] 检查缓存命中率（应 >= 70%）
- [ ] 检查数据库 I/O 率（应 < 100 ops/s）
- [ ] 检查告警历史

### 每周检查
- [ ] 审查性能趋势
- [ ] 分析慢查询日志
- [ ] 评估缓存策略调整需求

## 常见告警处理

### LowCacheHitRate
**原因**: 缓存命中率低于 60%
**影响**: 数据库负载增加
**处理**:
1. 检查 TTL 配置是否过短
2. 检查缓存容量是否不足
3. 分析访问模式是否发生变化
4. 考虑增加预加载

### HighDatabaseIORate
**原因**: 数据库 I/O 超过 100 ops/s
**影响**: 性能下降，可能影响用户体验
**处理**:
1. 检查是否有突发流量
2. 检查缓存是否正常工作
3. 检查是否有 N+1 查询
4. 考虑增加缓存容量或优化查询

### SlowDatabaseQueries
**原因**: P95 查询时间 > 1秒
**影响**: 用户体验差
**处理**:
1. 分析慢查询日志
2. 检查数据库索引
3. 检查是否需要查询优化
4. 考虑增加缓存

## 配置参数调优

### 缓存命中率不足
```json
{
  "CacheConfiguration": {
    "EntityStrategies": {
      "Character": {
        "TtlSeconds": 7200  // 增加 TTL
      }
    }
  }
}
```

### 内存不足
```json
{
  "MemoryCache": {
    "MaxCachedEntities": 50000  // 减少缓存容量
  }
}
```
```

---

## 📋 配置参数总览

```json
{
  "Monitoring": {
    "EnablePrometheus": true,
    "PrometheusPort": 9090,
    "MetricsEndpoint": "/metrics",
    "EnableGrafana": true,
    "GrafanaUrl": "http://localhost:3000",
    "AlertingEnabled": true,
    "AlertEmailRecipients": "admin@example.com",
    "AlertSlackWebhook": "https://hooks.slack.com/services/..."
  }
}
```

---

## ✅ 验收标准

- [ ] Prometheus 已安装并正常运行
- [ ] Grafana 已安装并正常运行
- [ ] 所有指标正常采集并显示
- [ ] 仪表板设计完整且美观
- [ ] 告警规则已配置并测试通过
- [ ] 告警通知已配置并测试通过
- [ ] 负载测试通过，性能符合预期
- [ ] 运维文档完整
- [ ] 团队已接受培训

---

## 🎉 总结

Phase 6 实时监控与可视化是数据库优化的重要组成部分：

**核心价值**:
1. **实时观察**: 了解系统真实性能
2. **数据驱动**: 基于数据做优化决策
3. **快速响应**: 及时发现和处理问题
4. **持续改进**: 监控 → 分析 → 优化 → 验证

**实施建议**:
- ✅ **优先实施**: 比 Phase 4/5 更重要
- ✅ **先监控再优化**: 避免盲目优化
- ✅ **持续迭代**: 监控是长期工程

---

**文档状态**: 下篇完成  
**系列完成**: 上中下篇全部完成  
**预计完成时间**: Phase 6 全部完成需 10-15 人日
