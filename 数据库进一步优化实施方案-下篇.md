# BlazorIdle æ•°æ®åº“è¿›ä¸€æ­¥ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸‹ç¯‡

**é¡¹ç›®åç§°**: BlazorIdle æ•°æ®åº“è¿›ä¸€æ­¥ä¼˜åŒ–  
**æ–¹æ¡ˆç‰ˆæœ¬**: 1.0  
**ç¼–åˆ¶æ—¥æœŸ**: 2025-10-19  
**é€‚ç”¨èŒƒå›´**: Phase 6 - å®æ—¶ç›‘æ§ä¸å¯è§†åŒ–

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯ã€Šæ•°æ®åº“æ“ä½œæ·±åº¦åˆ†ææŠ¥å‘Šã€‹çš„é…å¥—å®æ–½æ–¹æ¡ˆï¼ˆä¸‹ç¯‡ï¼‰ï¼š
- **ä¸Šç¯‡**: Phase 4 - æŸ¥è¯¢ä¼˜åŒ–ä¸ç´¢å¼•å¢å¼º
- **ä¸­ç¯‡**: Phase 5 - æ™ºèƒ½é¢„åŠ è½½ä¸ç¼“å­˜é¢„çƒ­
- **ä¸‹ç¯‡ (æœ¬æ–‡æ¡£)**: Phase 6 - å®æ—¶ç›‘æ§ä¸å¯è§†åŒ–

**é‡è¦æç¤º**: 
- **å¼ºçƒˆæ¨èå®æ–½** Phase 6ï¼Œæ˜¯äº†è§£ç³»ç»ŸçœŸå®æ€§èƒ½çš„åŸºç¡€
- å»ºè®®ä¼˜å…ˆçº§: Phase 6 > Phase 4 > Phase 5
- å®æ–½éš¾åº¦ä½ï¼Œæ”¶ç›Šé«˜

---

## ğŸ¯ Phase 6: å®æ—¶ç›‘æ§ä¸å¯è§†åŒ–

### ç›®æ ‡ä¸é¢„æœŸæ•ˆæœ

**ä¼˜åŒ–ç›®æ ‡**:
1. å»ºç«‹å®æ—¶æ€§èƒ½ç›‘æ§ä½“ç³»
2. å¯è§†åŒ–æ•°æ®åº“æ“ä½œå’Œç¼“å­˜æ•ˆç‡
3. åŠæ—¶å‘ç°å’Œå®šä½æ€§èƒ½ç“¶é¢ˆ
4. æ”¯æŒæ•°æ®é©±åŠ¨çš„ä¼˜åŒ–å†³ç­–

**é¢„æœŸæ•ˆæœ**:
- âœ… å®æ—¶ç›‘æ§æ‰€æœ‰æ•°æ®åº“æ“ä½œ
- âœ… Grafana ä»ªè¡¨æ¿å¯è§†åŒ–å±•ç¤º
- âœ… è‡ªåŠ¨å‘Šè­¦æœºåˆ¶
- âœ… æ€§èƒ½é—®é¢˜å‘ç°æ—¶é—´ç¼©çŸ­ 90%

**ä¼˜å…ˆçº§**: â­â­â­â­ (é«˜ä¼˜å…ˆçº§ï¼Œå¼ºçƒˆæ¨è)

**å·¥æ—¶ä¼°ç®—**: 10-15 äººæ—¥

**é£é™©çº§åˆ«**: ä½

---

## ğŸ“Š é˜¶æ®µè§„åˆ’

### æ€»ä½“åˆ†ä¸º 5 ä¸ªå­é˜¶æ®µ

| é˜¶æ®µ | ä»»åŠ¡ | å·¥æ—¶ | é£é™© | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| 6.1 | Prometheus é›†æˆä¸æŒ‡æ ‡å¯¼å‡º | 3-4 å¤© | ä½ | P0 |
| 6.2 | Grafana ä»ªè¡¨æ¿è®¾è®¡ä¸é…ç½® | 3-4 å¤© | ä½ | P0 |
| 6.3 | å‘Šè­¦è§„åˆ™é…ç½® | 2-3 å¤© | ä½ | P0 |
| 6.4 | é›†æˆæµ‹è¯•ä¸éªŒè¯ | 2-3 å¤© | ä½ | P0 |
| 6.5 | æ–‡æ¡£ä¸åŸ¹è®­ | 1-2 å¤© | ä½ | P1 |

**æ€»å·¥æ—¶**: 11-16 å¤©

---

## ğŸ“ˆ é˜¶æ®µ 6.1: Prometheus é›†æˆä¸æŒ‡æ ‡å¯¼å‡º

### 6.1.1 å®‰è£… Prometheus

**Docker Compose é…ç½®**:

**æ–‡ä»¶**: `/monitoring/docker-compose.yml`

```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: blazoridle-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    restart: unless-stopped
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: blazoridle-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - monitoring

volumes:
  prometheus-data:
  grafana-data:

networks:
  monitoring:
    driver: bridge
```

**Prometheus é…ç½®**:

**æ–‡ä»¶**: `/monitoring/prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'blazoridle-monitor'

# å‘Šè­¦è§„åˆ™æ–‡ä»¶
rule_files:
  - 'alert-rules.yml'

# Alertmanager é…ç½®ï¼ˆå¯é€‰ï¼‰
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets: ['alertmanager:9093']

# æŠ“å–ç›®æ ‡é…ç½®
scrape_configs:
  # BlazorIdle æœåŠ¡ç«¯
  - job_name: 'blazoridle-server'
    static_configs:
      - targets: ['host.docker.internal:5000']
    metrics_path: '/metrics'
    scrape_interval: 10s
```

### 6.1.2 é›†æˆ Prometheus .NET å®¢æˆ·ç«¯

**å®‰è£… NuGet åŒ…**:

```bash
dotnet add package prometheus-net.AspNetCore
```

**é…ç½® Program.cs**:

```csharp
using Prometheus;

var builder = WebApplication.CreateBuilder(args);

// ... å…¶ä»–æœåŠ¡é…ç½®

var app = builder.Build();

// å¯ç”¨ Prometheus æŒ‡æ ‡
app.UseMetricServer(); // é»˜è®¤ç«¯ç‚¹ /metrics
app.UseHttpMetrics();  // HTTP è¯·æ±‚æŒ‡æ ‡

// ... å…¶ä»–ä¸­é—´ä»¶

app.Run();
```

### 6.1.3 å®šä¹‰è‡ªå®šä¹‰æŒ‡æ ‡

**æ–‡ä»¶**: `BlazorIdle.Server/Infrastructure/Monitoring/PrometheusMetrics.cs`

```csharp
using Prometheus;

namespace BlazorIdle.Server.Infrastructure.Monitoring;

/// <summary>
/// Prometheus æŒ‡æ ‡å®šä¹‰
/// Prometheus metrics definitions
/// </summary>
public static class PrometheusMetrics
{
    // ===== æ•°æ®åº“æ“ä½œæŒ‡æ ‡ =====
    
    /// <summary>
    /// æ•°æ®åº“è¯»å–æ“ä½œè®¡æ•°å™¨
    /// Database read operations counter
    /// </summary>
    public static readonly Counter DbReads = Metrics.CreateCounter(
        "blazoridle_db_reads_total",
        "Total number of database read operations",
        new CounterConfiguration
        {
            LabelNames = new[] { "entity_type", "cache_hit" }
        }
    );
    
    /// <summary>
    /// æ•°æ®åº“å†™å…¥æ“ä½œè®¡æ•°å™¨
    /// Database write operations counter
    /// </summary>
    public static readonly Counter DbWrites = Metrics.CreateCounter(
        "blazoridle_db_writes_total",
        "Total number of database write operations",
        new CounterConfiguration
        {
            LabelNames = new[] { "entity_type", "batch_size" }
        }
    );
    
    /// <summary>
    /// æ•°æ®åº“æŸ¥è¯¢æ—¶é•¿ç›´æ–¹å›¾
    /// Database query duration histogram
    /// </summary>
    public static readonly Histogram DbQueryDuration = Metrics.CreateHistogram(
        "blazoridle_db_query_duration_seconds",
        "Database query duration in seconds",
        new HistogramConfiguration
        {
            LabelNames = new[] { "entity_type", "operation" },
            Buckets = Histogram.ExponentialBuckets(0.001, 2, 10) // 1ms ~ 512ms
        }
    );
    
    // ===== ç¼“å­˜æ•ˆç‡æŒ‡æ ‡ =====
    
    /// <summary>
    /// ç¼“å­˜å‘½ä¸­ç‡
    /// Cache hit rate
    /// </summary>
    public static readonly Gauge CacheHitRate = Metrics.CreateGauge(
        "blazoridle_cache_hit_rate",
        "Cache hit rate percentage (0-100)",
        new GaugeConfiguration
        {
            LabelNames = new[] { "entity_type" }
        }
    );
    
    /// <summary>
    /// ç¼“å­˜å¤§å°ï¼ˆå®ä½“æ•°é‡ï¼‰
    /// Cache size (number of entities)
    /// </summary>
    public static readonly Gauge CacheSize = Metrics.CreateGauge(
        "blazoridle_cache_size",
        "Number of entities currently in cache",
        new GaugeConfiguration
        {
            LabelNames = new[] { "entity_type" }
        }
    );
    
    /// <summary>
    /// Dirty å®ä½“æ•°é‡
    /// Number of dirty entities
    /// </summary>
    public static readonly Gauge DirtyEntitiesCount = Metrics.CreateGauge(
        "blazoridle_dirty_entities_count",
        "Number of dirty entities pending save",
        new GaugeConfiguration
        {
            LabelNames = new[] { "entity_type" }
        }
    );
    
    // ===== æŒä¹…åŒ–æ“ä½œæŒ‡æ ‡ =====
    
    /// <summary>
    /// æ‰¹é‡ä¿å­˜æ“ä½œè®¡æ•°å™¨
    /// Batch save operations counter
    /// </summary>
    public static readonly Counter BatchSaves = Metrics.CreateCounter(
        "blazoridle_batch_saves_total",
        "Total number of batch save operations",
        new CounterConfiguration
        {
            LabelNames = new[] { "entity_type", "success" }
        }
    );
    
    /// <summary>
    /// æ‰¹é‡ä¿å­˜æ—¶é•¿ç›´æ–¹å›¾
    /// Batch save duration histogram
    /// </summary>
    public static readonly Histogram BatchSaveDuration = Metrics.CreateHistogram(
        "blazoridle_batch_save_duration_seconds",
        "Batch save operation duration in seconds",
        new HistogramConfiguration
        {
            LabelNames = new[] { "entity_type" },
            Buckets = Histogram.ExponentialBuckets(0.01, 2, 10) // 10ms ~ 5.12s
        }
    );
    
    // ===== ä¸šåŠ¡æŒ‡æ ‡ =====
    
    /// <summary>
    /// åœ¨çº¿ç©å®¶æ•°é‡
    /// Number of online players
    /// </summary>
    public static readonly Gauge OnlinePlayers = Metrics.CreateGauge(
        "blazoridle_online_players",
        "Number of currently online players"
    );
    
    /// <summary>
    /// æ´»è·ƒæˆ˜æ–—æ•°é‡
    /// Number of active battles
    /// </summary>
    public static readonly Gauge ActiveBattles = Metrics.CreateGauge(
        "blazoridle_active_battles",
        "Number of currently active battles"
    );
}
```

### 6.1.4 é›†æˆæŒ‡æ ‡åˆ° Repository

**æ›´æ–° RepositoryBase**:

```csharp
public override async Task<T?> GetAsync(Guid id, CancellationToken ct = default)
{
    using (PrometheusMetrics.DbQueryDuration
        .WithLabels(typeof(T).Name, "get")
        .NewTimer())
    {
        var result = await base_GetAsync(id, ct);
        
        // è®°å½•è¯»å–æŒ‡æ ‡
        var cacheHit = result != null && WasFromCache(id);
        PrometheusMetrics.DbReads
            .WithLabels(typeof(T).Name, cacheHit ? "true" : "false")
            .Inc();
        
        return result;
    }
}
```

**æ›´æ–° PersistenceCoordinator**:

```csharp
private async Task SaveEntitiesAsync<T>(
    IMemoryStateManager<T> manager,
    string entityType,
    CancellationToken ct) where T : class, IEntity
{
    var dirtyEntities = manager.GetDirtyEntities().ToList();
    if (dirtyEntities.Count == 0)
        return;
    
    // è®°å½• Dirty æ•°é‡
    PrometheusMetrics.DirtyEntitiesCount
        .WithLabels(entityType)
        .Set(dirtyEntities.Count);
    
    using (PrometheusMetrics.BatchSaveDuration
        .WithLabels(entityType)
        .NewTimer())
    {
        try
        {
            // ä¿å­˜é€»è¾‘...
            await SaveToDatabase(dirtyEntities, ct);
            
            // æˆåŠŸ
            PrometheusMetrics.BatchSaves
                .WithLabels(entityType, "true")
                .Inc();
        }
        catch (Exception ex)
        {
            // å¤±è´¥
            PrometheusMetrics.BatchSaves
                .WithLabels(entityType, "false")
                .Inc();
            
            throw;
        }
    }
}
```

### 6.1.5 éªŒè¯ Prometheus æŒ‡æ ‡

```bash
# 1. å¯åŠ¨ Prometheus
cd monitoring
docker-compose up -d prometheus

# 2. è®¿é—® Prometheus UI
http://localhost:9090

# 3. æŸ¥è¯¢æŒ‡æ ‡ç¤ºä¾‹
blazoridle_db_reads_total
blazoridle_cache_hit_rate
blazoridle_db_query_duration_seconds
```

---

## ğŸ“Š é˜¶æ®µ 6.2: Grafana ä»ªè¡¨æ¿è®¾è®¡

### 6.2.1 å®‰è£…å¹¶é…ç½® Grafana

```bash
# å¯åŠ¨ Grafana (å·²åœ¨ docker-compose.yml ä¸­é…ç½®)
docker-compose up -d grafana

# è®¿é—® Grafana UI
http://localhost:3000
# é»˜è®¤ç”¨æˆ·å/å¯†ç : admin/admin
```

### 6.2.2 é…ç½® Prometheus æ•°æ®æº

**æ–‡ä»¶**: `/monitoring/grafana/provisioning/datasources/prometheus.yml`

```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
```

### 6.2.3 ä»ªè¡¨æ¿è®¾è®¡

**æ–‡ä»¶**: `/monitoring/grafana/dashboards/database-performance.json`

```json
{
  "dashboard": {
    "title": "BlazorIdle Database Performance",
    "uid": "blazoridle-db-perf",
    "timezone": "browser",
    "schemaVersion": 16,
    "version": 1,
    "refresh": "10s",
    
    "panels": [
      {
        "id": 1,
        "title": "Database I/O Operations (Rate)",
        "type": "graph",
        "gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "rate(blazoridle_db_reads_total{cache_hit='false'}[5m])",
            "legendFormat": "Reads (Cache Miss) - {{entity_type}}"
          },
          {
            "expr": "rate(blazoridle_db_reads_total{cache_hit='true'}[5m])",
            "legendFormat": "Reads (Cache Hit) - {{entity_type}}"
          },
          {
            "expr": "rate(blazoridle_db_writes_total[5m])",
            "legendFormat": "Writes - {{entity_type}}"
          }
        ],
        "yaxes": [
          { "format": "ops", "label": "Operations/sec" }
        ]
      },
      
      {
        "id": 2,
        "title": "Cache Hit Rate by Entity Type",
        "type": "graph",
        "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "blazoridle_cache_hit_rate",
            "legendFormat": "{{entity_type}}"
          }
        ],
        "yaxes": [
          { "format": "percent", "label": "Hit Rate (%)", "min": 0, "max": 100 }
        ],
        "alert": {
          "conditions": [
            {
              "evaluator": { "params": [60], "type": "lt" },
              "operator": { "type": "and" },
              "query": { "params": ["A", "5m", "now"] },
              "reducer": { "params": [], "type": "avg" },
              "type": "query"
            }
          ],
          "name": "Low Cache Hit Rate Alert"
        }
      },
      
      {
        "id": 3,
        "title": "Query Duration (P95)",
        "type": "graph",
        "gridPos": { "x": 0, "y": 8, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(blazoridle_db_query_duration_seconds_bucket[5m]))",
            "legendFormat": "P95 - {{entity_type}}.{{operation}}"
          }
        ],
        "yaxes": [
          { "format": "s", "label": "Duration (seconds)" }
        ]
      },
      
      {
        "id": 4,
        "title": "Cache Size & Dirty Entities",
        "type": "graph",
        "gridPos": { "x": 12, "y": 8, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "blazoridle_cache_size",
            "legendFormat": "Cache Size - {{entity_type}}"
          },
          {
            "expr": "blazoridle_dirty_entities_count",
            "legendFormat": "Dirty - {{entity_type}}"
          }
        ],
        "yaxes": [
          { "format": "short", "label": "Count" }
        ]
      },
      
      {
        "id": 5,
        "title": "Batch Save Duration (P99)",
        "type": "graph",
        "gridPos": { "x": 0, "y": 16, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "histogram_quantile(0.99, rate(blazoridle_batch_save_duration_seconds_bucket[5m]))",
            "legendFormat": "P99 - {{entity_type}}"
          }
        ],
        "yaxes": [
          { "format": "s", "label": "Duration (seconds)" }
        ]
      },
      
      {
        "id": 6,
        "title": "Online Players & Active Battles",
        "type": "stat",
        "gridPos": { "x": 12, "y": 16, "w": 12, "h": 8 },
        "targets": [
          {
            "expr": "blazoridle_online_players",
            "legendFormat": "Online Players"
          },
          {
            "expr": "blazoridle_active_battles",
            "legendFormat": "Active Battles"
          }
        ]
      }
    ]
  }
}
```

### 6.2.4 ä»ªè¡¨æ¿é¢„è§ˆ

è®¿é—®ä»ªè¡¨æ¿:
```
http://localhost:3000/d/blazoridle-db-perf/blazoridle-database-performance
```

---

## ğŸš¨ é˜¶æ®µ 6.3: å‘Šè­¦è§„åˆ™é…ç½®

### 6.3.1 Prometheus å‘Šè­¦è§„åˆ™

**æ–‡ä»¶**: `/monitoring/alert-rules.yml`

```yaml
groups:
  - name: database_performance
    interval: 30s
    rules:
      # ç¼“å­˜å‘½ä¸­ç‡ä½äºé˜ˆå€¼
      - alert: LowCacheHitRate
        expr: blazoridle_cache_hit_rate < 60
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Cache hit rate is below 60%"
          description: "{{ $labels.entity_type }} cache hit rate: {{ $value }}%"
      
      # æ•°æ®åº“ I/O æ“ä½œæ¿€å¢
      - alert: HighDatabaseIORate
        expr: |
          sum(rate(blazoridle_db_reads_total{cache_hit='false'}[5m])) +
          sum(rate(blazoridle_db_writes_total[5m])) > 100
        for: 5m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database I/O rate is abnormally high"
          description: "Current I/O rate: {{ $value }} ops/s (threshold: 100 ops/s)"
      
      # æŸ¥è¯¢å»¶è¿Ÿè¿‡é«˜
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95, 
            rate(blazoridle_db_query_duration_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "P95 query duration exceeds 1 second"
          description: "{{ $labels.entity_type }}.{{ $labels.operation }}: {{ $value }}s"
      
      # Dirty å®ä½“è¿‡å¤š
      - alert: TooManyDirtyEntities
        expr: blazoridle_dirty_entities_count > 5000
        for: 10m
        labels:
          severity: warning
          component: persistence
        annotations:
          summary: "Too many dirty entities pending save"
          description: "{{ $labels.entity_type }}: {{ $value }} dirty entities"
      
      # æ‰¹é‡ä¿å­˜å¤±è´¥ç‡è¿‡é«˜
      - alert: HighBatchSaveFailureRate
        expr: |
          sum(rate(blazoridle_batch_saves_total{success='false'}[5m])) /
          sum(rate(blazoridle_batch_saves_total[5m])) > 0.1
        for: 5m
        labels:
          severity: critical
          component: persistence
        annotations:
          summary: "Batch save failure rate exceeds 10%"
          description: "Failure rate: {{ $value | humanizePercentage }}"
```

### 6.3.2 Grafana å‘Šè­¦é€šçŸ¥

**é…ç½®é‚®ä»¶é€šçŸ¥**:

**æ–‡ä»¶**: `/monitoring/grafana/provisioning/notifiers/email.yml`

```yaml
notifiers:
  - name: email-notifier
    type: email
    uid: email1
    settings:
      addresses: "admin@example.com"
      singleEmail: true
    is_default: true
```

**é…ç½® Slack é€šçŸ¥**:

```yaml
notifiers:
  - name: slack-notifier
    type: slack
    uid: slack1
    settings:
      url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
      recipient: "#alerts"
      username: "BlazorIdle Monitor"
```

---

## âœ… é˜¶æ®µ 6.4: é›†æˆæµ‹è¯•ä¸éªŒè¯

### 6.4.1 æµ‹è¯•è®¡åˆ’

**æµ‹è¯•åœºæ™¯**:
1. æ­£å¸¸è´Ÿè½½ä¸‹çš„æŒ‡æ ‡é‡‡é›†
2. é«˜è´Ÿè½½ä¸‹çš„æŒ‡æ ‡é‡‡é›†
3. ç¼“å­˜å‘½ä¸­ç‡å˜åŒ–ç›‘æ§
4. å‘Šè­¦è§¦å‘æµ‹è¯•

### 6.4.2 è´Ÿè½½æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `/tests/load-test/database-load-test.js` (k6)

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 }, // çˆ¬å‡åˆ°100è™šæ‹Ÿç”¨æˆ·
    { duration: '5m', target: 100 }, // ä¿æŒ100è™šæ‹Ÿç”¨æˆ·
    { duration: '2m', target: 0 },   // é™è‡³0
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'], // P95 < 200ms
  },
};

const BASE_URL = 'http://localhost:5000';

export default function () {
  // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•
  let loginRes = http.post(`${BASE_URL}/api/auth/login`, JSON.stringify({
    username: `user${__VU}`,
    password: 'password123'
  }), {
    headers: { 'Content-Type': 'application/json' },
  });
  
  check(loginRes, { 'login successful': (r) => r.status === 200 });
  
  if (loginRes.status === 200) {
    let token = loginRes.json('token');
    
    // æ¨¡æ‹ŸæŸ¥è¯¢è§’è‰²
    let characterRes = http.get(`${BASE_URL}/api/characters`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });
    
    check(characterRes, { 'get characters successful': (r) => r.status === 200 });
    
    sleep(1);
    
    // æ¨¡æ‹ŸæŸ¥è¯¢è£…å¤‡
    let gearRes = http.get(`${BASE_URL}/api/gear`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });
    
    check(gearRes, { 'get gear successful': (r) => r.status === 200 });
  }
  
  sleep(Math.random() * 3);
}
```

**è¿è¡Œè´Ÿè½½æµ‹è¯•**:

```bash
k6 run tests/load-test/database-load-test.js
```

### 6.4.3 éªŒè¯æ¸…å•

- [ ] Prometheus æˆåŠŸé‡‡é›†æŒ‡æ ‡
- [ ] Grafana ä»ªè¡¨æ¿æ­£å¸¸æ˜¾ç¤º
- [ ] æ‰€æœ‰é¢æ¿æ•°æ®å‡†ç¡®
- [ ] å‘Šè­¦è§„åˆ™æ­£å¸¸è§¦å‘
- [ ] å‘Šè­¦é€šçŸ¥æ­£å¸¸å‘é€
- [ ] è´Ÿè½½æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æŒ‡æ ‡ç¬¦åˆé¢„æœŸ

---

## ğŸ“š é˜¶æ®µ 6.5: æ–‡æ¡£ä¸åŸ¹è®­

### 6.5.1 è¿ç»´æ–‡æ¡£

**æ–‡ä»¶**: `/docs/monitoring/operations-guide.md`

```markdown
# BlazorIdle ç›‘æ§è¿ç»´æŒ‡å—

## æ—¥å¸¸æ£€æŸ¥æ¸…å•

### æ¯æ—¥æ£€æŸ¥
- [ ] æ£€æŸ¥ Grafana ä»ªè¡¨æ¿ï¼Œç¡®è®¤æ— å¼‚å¸¸
- [ ] æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡ï¼ˆåº” >= 70%ï¼‰
- [ ] æ£€æŸ¥æ•°æ®åº“ I/O ç‡ï¼ˆåº” < 100 ops/sï¼‰
- [ ] æ£€æŸ¥å‘Šè­¦å†å²

### æ¯å‘¨æ£€æŸ¥
- [ ] å®¡æŸ¥æ€§èƒ½è¶‹åŠ¿
- [ ] åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
- [ ] è¯„ä¼°ç¼“å­˜ç­–ç•¥è°ƒæ•´éœ€æ±‚

## å¸¸è§å‘Šè­¦å¤„ç†

### LowCacheHitRate
**åŸå› **: ç¼“å­˜å‘½ä¸­ç‡ä½äº 60%
**å½±å“**: æ•°æ®åº“è´Ÿè½½å¢åŠ 
**å¤„ç†**:
1. æ£€æŸ¥ TTL é…ç½®æ˜¯å¦è¿‡çŸ­
2. æ£€æŸ¥ç¼“å­˜å®¹é‡æ˜¯å¦ä¸è¶³
3. åˆ†æè®¿é—®æ¨¡å¼æ˜¯å¦å‘ç”Ÿå˜åŒ–
4. è€ƒè™‘å¢åŠ é¢„åŠ è½½

### HighDatabaseIORate
**åŸå› **: æ•°æ®åº“ I/O è¶…è¿‡ 100 ops/s
**å½±å“**: æ€§èƒ½ä¸‹é™ï¼Œå¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ
**å¤„ç†**:
1. æ£€æŸ¥æ˜¯å¦æœ‰çªå‘æµé‡
2. æ£€æŸ¥ç¼“å­˜æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. æ£€æŸ¥æ˜¯å¦æœ‰ N+1 æŸ¥è¯¢
4. è€ƒè™‘å¢åŠ ç¼“å­˜å®¹é‡æˆ–ä¼˜åŒ–æŸ¥è¯¢

### SlowDatabaseQueries
**åŸå› **: P95 æŸ¥è¯¢æ—¶é—´ > 1ç§’
**å½±å“**: ç”¨æˆ·ä½“éªŒå·®
**å¤„ç†**:
1. åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
2. æ£€æŸ¥æ•°æ®åº“ç´¢å¼•
3. æ£€æŸ¥æ˜¯å¦éœ€è¦æŸ¥è¯¢ä¼˜åŒ–
4. è€ƒè™‘å¢åŠ ç¼“å­˜

## é…ç½®å‚æ•°è°ƒä¼˜

### ç¼“å­˜å‘½ä¸­ç‡ä¸è¶³
```json
{
  "CacheConfiguration": {
    "EntityStrategies": {
      "Character": {
        "TtlSeconds": 7200  // å¢åŠ  TTL
      }
    }
  }
}
```

### å†…å­˜ä¸è¶³
```json
{
  "MemoryCache": {
    "MaxCachedEntities": 50000  // å‡å°‘ç¼“å­˜å®¹é‡
  }
}
```
```

---

## ğŸ“‹ é…ç½®å‚æ•°æ€»è§ˆ

```json
{
  "Monitoring": {
    "EnablePrometheus": true,
    "PrometheusPort": 9090,
    "MetricsEndpoint": "/metrics",
    "EnableGrafana": true,
    "GrafanaUrl": "http://localhost:3000",
    "AlertingEnabled": true,
    "AlertEmailRecipients": "admin@example.com",
    "AlertSlackWebhook": "https://hooks.slack.com/services/..."
  }
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] Prometheus å·²å®‰è£…å¹¶æ­£å¸¸è¿è¡Œ
- [ ] Grafana å·²å®‰è£…å¹¶æ­£å¸¸è¿è¡Œ
- [ ] æ‰€æœ‰æŒ‡æ ‡æ­£å¸¸é‡‡é›†å¹¶æ˜¾ç¤º
- [ ] ä»ªè¡¨æ¿è®¾è®¡å®Œæ•´ä¸”ç¾è§‚
- [ ] å‘Šè­¦è§„åˆ™å·²é…ç½®å¹¶æµ‹è¯•é€šè¿‡
- [ ] å‘Šè­¦é€šçŸ¥å·²é…ç½®å¹¶æµ‹è¯•é€šè¿‡
- [ ] è´Ÿè½½æµ‹è¯•é€šè¿‡ï¼Œæ€§èƒ½ç¬¦åˆé¢„æœŸ
- [ ] è¿ç»´æ–‡æ¡£å®Œæ•´
- [ ] å›¢é˜Ÿå·²æ¥å—åŸ¹è®­

---

## ğŸ‰ æ€»ç»“

Phase 6 å®æ—¶ç›‘æ§ä¸å¯è§†åŒ–æ˜¯æ•°æ®åº“ä¼˜åŒ–çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼š

**æ ¸å¿ƒä»·å€¼**:
1. **å®æ—¶è§‚å¯Ÿ**: äº†è§£ç³»ç»ŸçœŸå®æ€§èƒ½
2. **æ•°æ®é©±åŠ¨**: åŸºäºæ•°æ®åšä¼˜åŒ–å†³ç­–
3. **å¿«é€Ÿå“åº”**: åŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
4. **æŒç»­æ”¹è¿›**: ç›‘æ§ â†’ åˆ†æ â†’ ä¼˜åŒ– â†’ éªŒè¯

**å®æ–½å»ºè®®**:
- âœ… **ä¼˜å…ˆå®æ–½**: æ¯” Phase 4/5 æ›´é‡è¦
- âœ… **å…ˆç›‘æ§å†ä¼˜åŒ–**: é¿å…ç›²ç›®ä¼˜åŒ–
- âœ… **æŒç»­è¿­ä»£**: ç›‘æ§æ˜¯é•¿æœŸå·¥ç¨‹

---

**æ–‡æ¡£çŠ¶æ€**: ä¸‹ç¯‡å®Œæˆ  
**ç³»åˆ—å®Œæˆ**: ä¸Šä¸­ä¸‹ç¯‡å…¨éƒ¨å®Œæˆ  
**é¢„è®¡å®Œæˆæ—¶é—´**: Phase 6 å…¨éƒ¨å®Œæˆéœ€ 10-15 äººæ—¥
