# BlazorIdle 服务端功能实现验收文档

**项目名称**: BlazorIdle - Web放置RPG游戏  
**文档类型**: 验收标准与测试清单  
**文档版本**: 1.0  
**创建日期**: 2025-10-15  
**状态**: 待实施验收

---

## 📋 文档说明

本文档配合《服务端未实现功能分析与优化方案.md》使用，提供详细的验收标准、测试用例和验收流程。

---

## 目录

1. [验收总则](#验收总则)
2. [上篇验收详细清单](#上篇验收详细清单)
3. [中篇验收详细清单](#中篇验收详细清单)
4. [下篇验收详细清单](#下篇验收详细清单)
5. [性能验收标准](#性能验收标准)
6. [安全验收标准](#安全验收标准)
7. [验收流程](#验收流程)
8. [验收报告模板](#验收报告模板)

---

## 验收总则

### 1.1 验收分级

| 级别 | 名称 | 要求 | 不通过后果 |
|------|------|------|-----------|
| **P0** | 必须项 | 100%完成，0缺陷 | 阻塞上线 |
| **P1** | 重要项 | ≥90%完成，无高危缺陷 | 需修复后上线 |
| **P2** | 一般项 | ≥70%完成，无中危缺陷 | 可后续迭代修复 |

### 1.2 验收原则

1. **功能优先**：核心功能必须正常工作
2. **质量保证**：代码质量、测试覆盖率达标
3. **性能达标**：关键性能指标符合要求
4. **安全可靠**：无安全漏洞，数据可靠
5. **文档完善**：代码注释、使用文档完整

### 1.3 验收参与者

- **开发负责人**：提交验收申请，演示功能
- **测试负责人**：执行测试用例，记录问题
- **产品负责人**：验证业务逻辑，确认需求
- **技术负责人**：审查代码质量，评估技术债务

---

## 上篇验收详细清单

### Phase 1: 双轨战斗节奏系统

#### 功能验收

**测试用例1.1：AttackTrack独立触发**（P0）
```
前置条件：创建角色，开始战斗
测试步骤：
1. 观察战斗日志中的AttackTickEvent
2. 记录AttackTrack的触发间隔
3. 验证间隔是否受急速属性影响

预期结果：
- AttackTrack按配置的BaseAttackSpeed触发
- 急速+10%时，触发间隔缩短约10%
- 触发时间戳递增

验收标准：
✅ 触发间隔计算正确（误差<5%）
✅ 急速影响生效
```

**测试用例1.2：SpecialTrack独立触发**（P0）
```
前置条件：创建角色，开始战斗
测试步骤：
1. 观察战斗日志中的SpecialPulseEvent
2. 记录SpecialTrack的触发间隔
3. 添加急速属性，验证不受影响

预期结果：
- SpecialTrack按职业配置的周期触发
- 急速属性不影响SpecialTrack间隔
- 战士5秒一次，法师3秒一次

验收标准：
✅ 触发周期符合职业配置
✅ 不受急速影响
```

**测试用例1.3：PauseWhenNoEnemies**（P1）
```
前置条件：配置PauseWhenNoEnemies=true
测试步骤：
1. 开始战斗，击杀所有敌人
2. 观察Track是否暂停
3. 新敌人刷新后，Track是否恢复

预期结果：
- 无敌人时，Track暂停（不再调度事件）
- 新敌人出现时，Track恢复
- 恢复后第一次触发时间正确

验收标准：
✅ 暂停机制生效
✅ 恢复时间计算正确
```

#### 质量验收

**代码质量检查1.1：单元测试覆盖率**（P0）
```bash
# 执行测试并生成覆盖率报告
dotnet test --collect:"XPlat Code Coverage"

# 检查覆盖率
报告位置：TestResults/*/coverage.cobertura.xml

验收标准：
✅ AttackTrackState类覆盖率≥90%
✅ SpecialTrackState类覆盖率≥90%
✅ 相关Event类覆盖率≥85%
```

**代码质量检查1.2：性能测试**（P1）
```bash
# 性能测试：1000次Track更新
var stopwatch = Stopwatch.StartNew();
for (int i = 0; i < 1000; i++) {
    track.UpdateNextTrigger(currentTime);
}
stopwatch.Stop();

验收标准：
✅ 平均每次更新<0.1ms
✅ 总耗时<100ms
```

**代码质量检查1.3：兼容性测试**（P0）
```
测试场景：
1. 旧战斗数据迁移到新Track系统
2. 现有战斗功能不受影响
3. 离线战斗正常工作

验收标准：
✅ 所有现有测试通过
✅ 无回归Bug
```

---

### Phase 2: 资源桶与溢出系统

#### 功能验收

**测试用例2.1：多资源支持**（P0）
```
前置条件：配置3种资源（怒气、碎片、专注层）
测试步骤：
1. 创建战士角色，验证怒气资源存在
2. 创建法师角色，验证碎片资源存在
3. 添加/消耗资源，验证计算正确

预期结果：
- 每个角色有正确的资源类型
- Add/Consume方法正常工作
- 资源不会变成负数

验收标准：
✅ 至少支持3种资源类型
✅ 资源操作计算正确
✅ 边界条件处理正确（0/max）
```

**测试用例2.2：Clamp策略**（P0）
```
前置条件：碎片资源max=5, OverflowPolicy=Clamp
测试步骤：
1. 碎片当前值=4
2. 添加3个碎片
3. 观察结果

预期结果：
- 碎片值=5（max）
- 溢出的2个碎片被截断
- 无异常抛出

验收标准：
✅ 值正确截断为max
✅ 溢出部分丢弃
```

**测试用例2.3：Convert策略**（P0）
```
前置条件：怒气max=100, OverflowPolicy=Convert, Ratio=20
测试步骤：
1. 怒气当前值=95
2. 添加25怒气
3. 观察怒气值和生成的Buff

预期结果：
- 怒气值=100
- 溢出20怒气
- 生成1层"战意"Buff（20/20=1）
- 剩余的5怒气被丢弃

验收标准：
✅ 溢出正确转换为Buff
✅ 转换比例正确
✅ Buff层数正确
```

**测试用例2.4：资源配置化**（P1）
```
前置条件：修改appsettings.json中的资源配置
测试步骤：
1. 修改怒气max为150
2. 修改转换比例为30
3. 重启服务，验证新配置生效

预期结果：
- 怒气上限变为150
- 溢出30才转换1层Buff

验收标准：
✅ 配置即时生效
✅ 无需修改代码
```

#### 质量验收

**性能测试2.1：资源查找性能**（P1）
```csharp
// 测试：10000次资源查找
var stopwatch = Stopwatch.StartNew();
for (int i = 0; i < 10000; i++) {
    var rage = resourceSet.GetResource("rage");
}
stopwatch.Stop();

验收标准：
✅ 平均每次查找<0.01ms（使用Dictionary）
✅ 总耗时<100ms
```

**内存测试2.2：无内存泄漏**（P0）
```
测试场景：
1. 创建1000个角色
2. 每个角色进行100次资源操作
3. 观察内存增长

验收标准：
✅ 内存增长线性且可预测
✅ GC后内存恢复正常
✅ 无引用无法释放的情况
```

---

### Phase 3: 职业差异化配置

#### 功能验收

**测试用例3.1：战士职业**（P0）
```
职业配置：
- PrimaryResource: "rage" (max=100)
- SecondaryResource: "focus_stacks" (max=3)
- SpecialTrackInterval: 5.0
- AttackGeneration: +1 rage per attack
- SpecialGeneration: +1 focus per pulse

测试步骤：
1. 创建战士角色
2. 开始战斗，攻击10次
3. 观察资源变化

预期结果：
- 每次攻击+1怒气
- 每5秒+1专注层
- 怒气满100时触发溢出转换

验收标准：
✅ 资源生成规则正确
✅ Special Track周期5秒
✅ 溢出转换为"战意"Buff
```

**测试用例3.2：法师职业**（P0）
```
职业配置：
- PrimaryResource: "shard" (max=5)
- SecondaryResource: "frost_stacks" (max=10)
- SpecialTrackInterval: 3.0
- AttackGeneration: +1 shard per attack
- SpecialGeneration: +1 frost_stack per pulse
- StackBonus: AttackSpeed +2% per stack

测试步骤：
1. 创建法师角色
2. 开始战斗，等待30秒
3. 观察攻速提升

预期结果：
- 每次攻击+1碎片
- 每3秒+1冰冷血脉层
- 10层时攻速+20%

验收标准：
✅ 碎片上限5个
✅ Special Track周期3秒
✅ 叠加Buff正确影响攻速
```

**测试用例3.3：职业切换**（P1）
```
测试步骤：
1. 创建战士角色，战斗一段时间
2. 切换为法师职业
3. 观察资源是否正确重置

预期结果：
- 怒气清空，变为碎片
- 专注层清空，变为冰冷血脉层
- Track周期改变（5秒→3秒）

验收标准：
✅ 资源正确切换
✅ Track周期更新
✅ 无遗留状态干扰
```

#### 质量验收

**游戏平衡性测试3.1**（P1）
```
测试场景：
同等级的战士和法师，击杀同一怪物

测试指标：
- 击杀时间差异<20%
- DPS差异<15%
- 生存能力相当

验收标准：
✅ 无明显职业优劣
✅ 各有特色和玩法差异
```

---

### Phase 4: 战斗段聚合优化

#### 功能验收

**测试用例4.1：事件数阈值flush**（P0）
```
前置条件：配置EVENT_THRESHOLD=200
测试步骤：
1. 开始离线战斗
2. 观察Segment生成时机
3. 统计每个Segment的事件数

预期结果：
- 事件数达到200时自动flush
- 或时间达到5秒时flush
- Segment中事件数≤200

验收标准：
✅ flush时机正确
✅ 事件数不超过阈值
```

**测试用例4.2：聚合信息完整**（P0）
```
测试步骤：
1. 生成一个CombatSegment
2. 检查聚合字段

预期字段：
- StartTime, EndTime
- EventCount
- DamageBySource: {skillId → totalDmg}
- ResourceFlow: {resourceId → gained}
- BuffUptime: {buffId → seconds}
- RngSeedStart, RngSeedEnd

验收标准：
✅ 所有聚合字段存在
✅ 数据准确
```

**测试用例4.3：存储优化效果**（P0）
```
对比测试：
1. 旧版本：存储全部事件
2. 新版本：存储聚合数据

测试场景：10小时离线战斗

预期结果：
- 旧版本：约50MB
- 新版本：约15MB
- 减少约70%

验收标准：
✅ 存储大小减少≥30%
✅ 数据完整性保持
```

---

### Phase 5: 敌人技能AI增强

#### 功能验收

**测试用例5.1：技能优先级**（P0）
```
敌人配置：
- Skill1: 优先级3, CD=5s
- Skill2: 优先级2, CD=8s
- Skill3: 优先级1, CD=3s

测试步骤：
1. 开始战斗
2. 记录敌人技能释放顺序
3. 验证优先级逻辑

预期结果：
- CD都好的情况下，优先释放Skill1
- Skill1在CD时，释放Skill2
- 都在CD时，释放Skill3

验收标准：
✅ 优先级逻辑正确
✅ CD管理正确
```

**测试用例5.2：施放条件**（P1）
```
技能配置：
- Skill: "强力一击"
- Condition: "hp_below_percent=50"
- Priority: 10

测试步骤：
1. 敌人HP>50%，观察不释放
2. 敌人HP降至50%以下，观察释放

预期结果：
- 条件不满足时，跳过该技能
- 条件满足时，按优先级释放

验收标准：
✅ 条件判断正确
✅ 战斗难度提升合理
```

---

## 中篇验收详细清单

### Phase 6: 装备词条重置系统

#### 功能验收

**测试用例6.1：词条重新生成**（P0）
```
前置条件：一件带3个词条的装备
测试步骤：
1. 记录原词条
2. 执行Reroll
3. 验证词条已变化

预期结果：
- 词条完全重新生成
- 词条数量保持不变
- 词条在允许池中

验收标准：
✅ 词条重新随机生成
✅ 稀有度权重正确
```

**测试用例6.2：成本递增**（P0）
```
配置：BaseCost=100, IncreaseRate=0.1
测试步骤：
1. 第1次Reroll，记录成本
2. 第2次Reroll，记录成本
3. 第10次Reroll，记录成本

预期结果：
- 第1次：100金币
- 第2次：110金币（100 * 1.1）
- 第10次：200金币（100 * 2.0）

验收标准：
✅ 成本按公式递增
✅ 金币正确扣除
```

**测试用例6.3：保底机制**（P0）
```
配置：PityThreshold=10
测试步骤：
1. 连续Reroll 10次
2. 检查第10次是否出稀有词条

预期结果：
- 第10次必定出现至少1个稀有词条
- 保底计数正确重置

验收标准：
✅ 保底生效
✅ 玩家体验良好
```

#### 质量验收

**经济平衡性测试6.1**（P1）
```
测试场景：
模拟100个玩家各Reroll 100次

统计指标：
- 平均成本：10,000金币
- 平均获得稀有词条：15个
- 金币消耗与收益比：合理

验收标准：
✅ 成本增长不会过快导致玩家放弃
✅ 稀有词条获得率合理
```

---

### Phase 7: 经济监控与指标收集

#### 功能验收

**测试用例7.1：经济事件记录**（P0）
```
测试场景：
1. 击杀怪物获得金币
2. 购买商店物品
3. Reroll装备
4. 分解装备

验收标准：
✅ 所有事件被正确记录
✅ 金额准确
✅ 时间戳正确
```

**测试用例7.2：查询API**（P0）
```
API: GET /api/debug/economy-flow/{characterId}?days=7
测试步骤：
1. 调用API
2. 检查返回数据

预期返回：
```json
{
  "goldGained": 50000,
  "goldSpent": 35000,
  "goldInOutRatio": 1.43,
  "goldSourceBreakdown": {
    "battle": 40000,
    "quest": 5000,
    "disenchant": 5000
  },
  "goldSinkBreakdown": {
    "reroll": 15000,
    "shop": 10000,
    "reforge": 10000
  }
}
```

验收标准：
✅ API响应<500ms
✅ 数据准确
✅ 格式正确
```

**测试用例7.3：监控仪表板**（P1）
```
前端功能：
- 显示金币流入/流出图表
- 显示材料库存
- 显示经济健康度指标

验收标准：
✅ 图表可视化清晰
✅ 数据实时更新
✅ 交互友好
```

---

### Phase 8: 材料分层体系

#### 功能验收

**测试用例8.1：材料分层**（P0）
```
配置：
- Tier 1: Level 1-10
- Tier 2: Level 11-20
- Tier 3: Level 21-30

测试步骤：
1. Level 5角色击杀怪物
2. Level 15角色击杀怪物
3. Level 25角色击杀怪物

预期结果：
- Level 5掉落：皮革碎片、铁矿石
- Level 15掉落：厚实皮革、钢锭
- Level 25掉落：硬化皮革、秘银锭

验收标准：
✅ 掉落材料匹配角色等级
✅ 不会掉落跨Tier材料
```

**测试用例8.2：材料用途**（P0）
```
测试场景：
1. 重铸T1装备消耗T1材料
2. 重铸T2装备消耗T2材料
3. 词条重置消耗对应Tier材料

验收标准：
✅ 材料消耗逻辑正确
✅ Tier对应清晰
```

---

### Phase 9: 消耗品自动使用系统

#### 功能验收

**测试用例9.1：OnBattleStart策略**（P0）
```
配置：
- Slot1: "力量药剂", UsePolicy=OnBattleStart

测试步骤：
1. 配置Loadout
2. 开始战斗
3. 观察Buff是否应用

预期结果：
- 战斗第1秒自动使用药剂
- 获得"力量"Buff
- 库存-1

验收标准：
✅ 自动使用生效
✅ 时机正确
```

**测试用例9.2：OnHpBelowPercent策略**（P0）
```
配置：
- Slot: "治疗药剂", UsePolicy=OnHpBelowPercent, Threshold=30

测试步骤：
1. 战斗中HP降至50%，观察不使用
2. HP降至30%以下，观察自动使用

预期结果：
- HP>30%时不使用
- HP≤30%时自动使用
- 立即回复HP

验收标准：
✅ 触发阈值正确
✅ 治疗效果生效
```

**测试用例9.3：冷却管理**（P1）
```
配置：药剂冷却60秒
测试步骤：
1. 使用药剂
2. 30秒后HP再次低于阈值
3. 观察是否使用

预期结果：
- 冷却期内不使用
- 冷却结束后自动使用

验收标准：
✅ 冷却计时正确
✅ 不会浪费药剂
```

---

## 下篇验收详细清单

### Phase 10: 条件/解锁DSL引擎

#### 功能验收

**测试用例10.1：基本运算符**（P0）
```
测试表达式：
1. "level >= 20"
2. "level >= 20 AND gold >= 1000"
3. "quest_completed('main_01') OR quest_completed('main_02')"
4. "NOT quest_completed('main_01')"

测试步骤：
1. 创建角色，设置level=20, gold=500
2. 求值表达式1：预期true
3. 求值表达式2：预期false
4. 完成任务main_01
5. 求值表达式3：预期true
6. 求值表达式4：预期false

验收标准：
✅ 所有运算符正确求值
✅ 优先级正确
```

**测试用例10.2：函数调用**（P0）
```
支持函数：
- quest_completed(questId)
- reputation(factionId)
- has_item(itemId)
- equipped_tier(tier)

测试步骤：
1. 表达式："reputation('faction_a') >= 300"
2. 设置角色声望=350
3. 求值

预期结果：
- 正确解析函数调用
- 参数传递正确
- 返回值准确

验收标准：
✅ 至少支持5种函数
✅ 函数求值正确
```

**测试用例10.3：缓存策略**（P0）
```
测试步骤：
1. 求值表达式100次
2. 修改角色level
3. 再求值100次

统计指标：
- 第一轮：缓存命中率0%
- 第二轮：缓存命中率100%
- 修改后：缓存失效，重新求值

验收标准：
✅ 缓存命中率>80%
✅ 失效机制正确
```

#### 质量验收

**性能测试10.1**（P0）
```csharp
// 测试：1000次求值
var expr = "level >= 20 AND reputation('faction_a') >= 300";
var stopwatch = Stopwatch.StartNew();
for (int i = 0; i < 1000; i++) {
    var result = evaluator.Evaluate(expr, character);
}
stopwatch.Stop();

验收标准：
✅ 平均每次求值<5ms
✅ 总耗时<5000ms
```

---

### Phase 11: 地图/区域系统

#### 功能验收

**测试用例11.1：区域解锁**（P0）
```
区域配置：
- Region1: "新手村", UnlockCondition="level >= 1"
- Region2: "幽暗森林", UnlockCondition="level >= 10"
- Region3: "火焰山", UnlockCondition="level >= 20 AND quest_completed('main_forest')"

测试步骤：
1. Level 1角色：只能看到新手村
2. Level 10角色：可以看到幽暗森林
3. Level 20但未完成任务：看不到火焰山
4. Level 20且完成任务：可以看到火焰山

验收标准：
✅ 解锁条件正确判断
✅ 前端显示一致
```

**测试用例11.2：怪物池随机**（P0）
```
区域配置：
MonsterPool: [
  {EnemyId: "slime", Weight: 100},
  {EnemyId: "goblin", Weight: 50},
  {EnemyId: "wolf", Weight: 30}
]

测试步骤：
1. 在该区域挂机100次战斗
2. 统计遇到的怪物类型

预期结果：
- 史莱姆：约55次（100/(100+50+30)*100）
- 哥布林：约28次
- 狼：约17次

验收标准：
✅ 权重随机正确（误差<10%）
✅ 所有怪物都有机会遇到
```

**测试用例11.3：推荐区域**（P1）
```
功能：根据角色等级推荐合适区域

测试步骤：
1. Level 5角色：推荐新手村
2. Level 15角色：推荐幽暗森林
3. Level 25角色：推荐火焰山

验收标准：
✅ 推荐逻辑合理
✅ 前端显示清晰
```

---

### Phase 12: 任务系统

#### 功能验收

**测试用例12.1：主线任务链**（P0）
```
任务链：
1. "初入江湖" → 2. "首次战斗" → 3. "装备强化" → 4. "探索森林"

测试步骤：
1. 完成任务1
2. 任务2自动解锁
3. 跳过任务2，尝试接任务3
4. 预期：无法接取任务3（缺少前置）

验收标准：
✅ 任务链顺序强制
✅ 前置任务检查正确
```

**测试用例12.2：任务目标追踪**（P0）
```
任务："森林守护者"
目标：
- 击杀史莱姆 0/10
- 击杀哥布林 0/5
- 收集绿色药剂 0/3

测试步骤：
1. 击杀2只史莱姆
2. 击杀1只哥布林
3. 获得1瓶绿色药剂
4. 检查进度

预期结果：
- 击杀史莱姆 2/10
- 击杀哥布林 1/5
- 收集绿色药剂 1/3

验收标准：
✅ 进度实时更新
✅ 多目标并行追踪
```

**测试用例12.3：日常任务刷新**（P0）
```
日常任务：每日04:00重置

测试步骤：
1. 今天完成日常任务
2. 等待至04:00
3. 检查任务状态

预期结果：
- 任务进度重置为0
- 可再次接取
- 奖励可再次领取

验收标准：
✅ 刷新时间准确
✅ 状态重置正确
```

**测试用例12.4：任务奖励**（P1）
```
任务："装备收集者"
奖励：
- 金币：1000
- 经验：500
- 物品：["高级治疗药剂"x3]
- 声望：faction_a +50

测试步骤：
1. 完成任务
2. 领取奖励
3. 检查角色变化

预期结果：
- 金币+1000
- 经验+500
- 库存+3瓶药剂
- faction_a声望+50

验收标准：
✅ 所有奖励正确发放
✅ 无重复领取
```

---

### Phase 13: 声望系统

#### 功能验收

**测试用例13.1：声望计算**（P0）
```
派系：faction_a
等级定义：
- 中立：0-299
- 友善：300-999
- 尊敬：1000-2999
- 崇敬：3000-5999
- 崇拜：6000+

测试步骤：
1. 初始声望=0，等级=中立
2. +300声望，等级=友善
3. +700声望（累计1000），等级=尊敬
4. 检查等级判定

验收标准：
✅ 等级判定正确
✅ 阈值边界处理正确
```

**测试用例13.2：声望奖励**（P0）
```
派系：faction_a
等级奖励：
- 友善：解锁商店1
- 尊敬：解锁商店2，折扣5%
- 崇敬：解锁商店3，折扣10%
- 崇拜：解锁商店4，折扣15%

测试步骤：
1. 达到友善，检查商店1是否解锁
2. 达到尊敬，检查商店2解锁且折扣生效
3. 购买物品，验证折扣计算

预期结果：
- 商店逐步解锁
- 折扣正确应用
- 价格计算准确

验收标准：
✅ 奖励自动解锁
✅ 折扣计算正确
```

**测试用例13.3：多派系独立**（P1）
```
派系：faction_a, faction_b
测试步骤：
1. 提升faction_a声望
2. 检查faction_b声望不变

验收标准：
✅ 派系声望独立管理
✅ 不会相互影响
```

---

### Phase 14: 多角色Roster增强

#### 功能验收

**测试用例14.1：槽位解锁**（P0）
```
槽位配置：
- Slot 1: 默认解锁
- Slot 2: level >= 10 AND gold >= 1000
- Slot 3: level >= 20 AND quest_completed('main_forest')
- Slot 4: level >= 30 AND reputation('faction_a') >= 1000
- Slot 5: level >= 40 AND gold >= 10000

测试步骤：
1. 新账号：只有Slot 1可用
2. Level 10且1000金币：Slot 2解锁
3. 依次满足条件，解锁Slot 3-5

验收标准：
✅ 解锁条件正确
✅ 金币正确扣除（如需）
✅ 前端显示更新
```

**测试用例14.2：后台推进**（P0）
```
测试场景：
- 角色A：活跃，正在战斗
- 角色B：非活跃，活动计划中
- 角色C：非活跃，活动计划中

测试步骤：
1. 切换到角色A
2. 10分钟后，检查角色B和C的进度

预期结果：
- 角色B的活动继续推进
- 角色C的活动继续推进
- 奖励正确累积

验收标准：
✅ 后台推进正常
✅ 性能无明显影响
✅ 切换角色时立即看到进度
```

---

### Phase 15: 监控与调试系统

#### 功能验收

**测试用例15.1：战斗指标**（P0）
```
指标：
- segment_events_per_min
- avg_events_per_segment
- resource_overflow_rate

测试步骤：
1. 进行10分钟战斗
2. 调用监控API
3. 检查指标数据

验收标准：
✅ 指标计算正确
✅ 数据可查询
```

**测试用例15.2：Debug API**（P1）
```
API: GET /api/debug/battle-state/{characterId}
返回：
```json
{
  "characterId": 123,
  "currentTime": 123.45,
  "attackTrack": {
    "nextTriggerAt": 124.0
  },
  "specialTrack": {
    "nextTriggerAt": 125.0
  },
  "resources": {
    "rage": {"current": 85, "max": 100}
  },
  "activeBuffs": [
    {"id": "战意", "stacks": 2, "expireAt": 133.45}
  ]
}
```

验收标准：
✅ 返回实时状态
✅ 数据格式正确
✅ 响应时间<200ms
```

---

## 性能验收标准

### 5.1 API响应时间

| API类型 | 中位数 | P95 | P99 | 超时 |
|---------|--------|-----|-----|------|
| 读取API | <300ms | <800ms | <1.5s | 5s |
| 写入API | <500ms | <1s | <2s | 10s |
| 查询API（复杂） | <800ms | <2s | <3s | 15s |

**测试工具**：JMeter / k6  
**负载**：100并发用户，持续10分钟

### 5.2 战斗性能

| 场景 | 指标 | 目标 |
|------|------|------|
| 步进战斗 | 每步耗时 | <50ms |
| 离线战斗（1小时） | 总耗时 | <3s |
| 离线战斗（10小时） | 总耗时 | <30s |
| Segment生成 | 平均耗时 | <10ms |

### 5.3 内存占用

| 场景 | 内存占用 |
|------|---------|
| 服务启动 | <200MB |
| 100在线角色 | <500MB |
| 1000在线角色 | <2GB |
| 长期运行（24小时） | 无泄漏，增长<10% |

### 5.4 数据库性能

| 操作 | 平均耗时 | P95 |
|------|---------|-----|
| 角色查询 | <50ms | <100ms |
| 装备查询 | <30ms | <80ms |
| 战斗记录查询 | <80ms | <150ms |
| 事务提交 | <100ms | <200ms |

---

## 安全验收标准

### 6.1 身份认证

**测试用例S1：JWT验证**（P0）
```
测试步骤：
1. 无Token访问受保护API → 401
2. 过期Token访问 → 401
3. 篡改Token访问 → 401
4. 有效Token访问 → 200

验收标准：
✅ 所有API正确验证Token
✅ 错误响应代码准确
```

### 6.2 权限控制

**测试用例S2：角色权限**（P0）
```
测试步骤：
1. 用户A尝试访问用户B的角色 → 403
2. 用户A访问自己的角色 → 200

验收标准：
✅ 横向越权被阻止
✅ 权限检查全面
```

### 6.3 输入验证

**测试用例S3：SQL注入防护**（P0）
```
测试输入：
- Username: "admin' OR '1'='1"
- ItemId: "1; DROP TABLE users--"

验收标准：
✅ 所有输入经过验证
✅ 使用参数化查询
✅ 无SQL注入风险
```

**测试用例S4：XSS防护**（P0）
```
测试输入：
- CharacterName: "<script>alert('xss')</script>"
- Message: "<img src=x onerror=alert(1)>"

验收标准：
✅ 输入被转义或拒绝
✅ 输出编码正确
✅ 无XSS风险
```

### 6.4 数据完整性

**测试用例S5：金币修改检测**（P0）
```
测试场景：
1. 正常途径获得金币 → 记录日志
2. 尝试直接修改数据库金币 → 检测并回滚

验收标准：
✅ 所有金币变动有日志
✅ 异常变动可追溯
```

---

## 验收流程

### 7.1 验收阶段

```
阶段1：开发自测（开发负责人）
  ├─ 本地测试
  ├─ 单元测试
  └─ 功能自检

阶段2：测试验收（测试负责人）
  ├─ 功能测试
  ├─ 性能测试
  ├─ 安全测试
  └─ 兼容性测试

阶段3：产品验收（产品负责人）
  ├─ 业务逻辑验证
  ├─ 用户体验评估
  └─ 内容完整性检查

阶段4：技术验收（技术负责人）
  ├─ 代码Review
  ├─ 架构评审
  ├─ 技术债务评估
  └─ 文档检查

阶段5：最终验收（项目负责人）
  ├─ 综合评估
  ├─ 上线决策
  └─ 签署验收报告
```

### 7.2 验收会议议程

**时长**：2-3小时  
**参与者**：全体相关人员

**议程**：
1. **开场**（5分钟）
   - 验收目标说明
   - 议程介绍

2. **功能演示**（30分钟）
   - 开发负责人演示核心功能
   - 逐Phase展示
   - 亮点说明

3. **测试报告**（20分钟）
   - 测试负责人汇报
   - 通过率统计
   - 问题清单

4. **代码质量**（15分钟）
   - 测试覆盖率
   - 静态分析结果
   - 技术债务

5. **性能报告**（15分钟）
   - 性能测试结果
   - 关键指标展示
   - 优化建议

6. **讨论与决策**（30分钟）
   - 问题讨论
   - 风险评估
   - 验收决策

7. **总结**（5分钟）
   - 验收结论
   - 后续计划
   - 签署报告

### 7.3 验收决策标准

**通过验收**：
- ✅ P0项100%完成
- ✅ P1项≥90%完成
- ✅ 无高危缺陷
- ✅ 性能达标
- ✅ 安全无风险

**条件通过**：
- ⚠️ P0项100%完成
- ⚠️ P1项80-90%完成
- ⚠️ 有中危缺陷但有修复计划
- ⚠️ 性能基本达标
- 需在指定时间内修复后上线

**不通过验收**：
- ❌ P0项<100%
- ❌ 有高危缺陷
- ❌ 性能严重不达标
- ❌ 安全存在风险

---

## 验收报告模板

请参考《服务端未实现功能分析与优化方案.md》第10.6节的详细模板。

---

## 附录

### A. 缺陷优先级定义

| 级别 | 名称 | 定义 | 响应时间 |
|------|------|------|----------|
| **P0** | 阻塞 | 核心功能无法使用，无workaround | 立即修复 |
| **P1** | 严重 | 重要功能受影响，有workaround | 24小时内 |
| **P2** | 一般 | 次要功能受影响 | 3天内 |
| **P3** | 轻微 | 体验问题，不影响功能 | 下个迭代 |

### B. 测试工具清单

- **单元测试**：xUnit
- **性能测试**：JMeter / k6
- **API测试**：Postman / REST Client
- **代码覆盖率**：Coverlet
- **静态分析**：Roslyn Analyzers
- **安全扫描**：OWASP ZAP

### C. 验收文档清单

1. [x] 功能测试报告
2. [x] 性能测试报告
3. [x] 安全测试报告
4. [x] 代码质量报告
5. [x] 用户验收报告
6. [x] 技术验收报告
7. [x] 最终验收报告

---

**文档结束**

**创建日期**: 2025-10-15  
**文档版本**: 1.0  
**总页数**: 50+页  
**配套文档**: 《服务端未实现功能分析与优化方案.md》
