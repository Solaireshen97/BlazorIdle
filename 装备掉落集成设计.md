# 装备掉落系统集成设计

## 概述

本文档描述如何将装备生成系统与现有经济系统集成，实现装备掉落功能。

## 当前状态

### 已完成
1. ✅ 装备生成服务 (`GearGenerationService`) - 可以基于 `GearDefinition` 生成装备实例
2. ✅ 装备定义种子数据 - 13个装备定义已就绪
3. ✅ 经济系统框架 - `EconomyRegistry`, `LootTable`, `EconomyCalculator`
4. ✅ 集成测试 - 验证装备生成和管理流程

### 待完成
1. ❌ 将装备定义注册到 `EconomyRegistry`
2. ❌ 扩展 `LootEntry` 支持装备类型物品
3. ❌ 在战斗奖励中生成装备实例
4. ❌ 将装备实例添加到背包

## 设计方案

### 方案1: 装备作为特殊物品类型

#### 优点
- 与现有物品系统保持一致
- 利用现有的掉落概率机制
- 代码变更最小

#### 实现步骤

1. **扩展 LootEntry 支持装备生成参数**

```csharp
public sealed class LootEntry
{
    // 现有字段...
    public double DropChance { get; init; } = 0.0;
    public string ItemId { get; init; } = "";
    public int QuantityMin { get; init; } = 1;
    public int QuantityMax { get; init; } = 1;
    public int Rolls { get; init; } = 1;
    
    // 新增：装备相关字段
    public ItemType ItemType { get; init; } = ItemType.Material; // Material, Gear, etc.
    public string? GearDefinitionId { get; init; } = null; // 装备定义ID
}

public enum ItemType
{
    Material,  // 材料
    Gear,      // 装备
    Consumable // 消耗品（未来）
}
```

2. **在 EconomyRegistry 注册装备定义为物品**

```csharp
// EconomyRegistry 初始化时
static EconomyRegistry()
{
    // 现有物品...
    
    // 注册装备定义为可掉落物品
    RegisterGearDefinitions();
}

private static void RegisterGearDefinitions()
{
    // 从种子数据或数据库加载装备定义
    var gearDefinitions = GetAllGearDefinitions();
    
    foreach (var gearDef in gearDefinitions)
    {
        AddItem(new ItemDefinition(
            id: $"gear_{gearDef.Id}",
            name: gearDef.Name,
            description: $"装备定义: {gearDef.Name}"
        ));
    }
}
```

3. **创建装备掉落表**

```csharp
// 普通怪物掉落表
AddLoot(new LootTable("loot_gear_common", new[]
{
    new LootEntry 
    { 
        ItemId = "weapon_iron_sword",
        ItemType = ItemType.Gear,
        GearDefinitionId = "weapon_iron_sword",
        DropChance = 0.10, 
        QuantityMin = 1, 
        QuantityMax = 1,
        Rolls = 1 
    },
    new LootEntry 
    { 
        ItemId = "helm_cloth_basic",
        ItemType = ItemType.Gear,
        GearDefinitionId = "helm_cloth_basic",
        DropChance = 0.08,
        QuantityMin = 1,
        QuantityMax = 1,
        Rolls = 1
    }
}));

// Boss掉落表（高品质装备）
AddLoot(new LootTable("loot_gear_boss", new[]
{
    new LootEntry 
    { 
        ItemId = "weapon_twohand_sword",
        ItemType = ItemType.Gear,
        GearDefinitionId = "weapon_twohand_sword",
        DropChance = 0.30,
        QuantityMin = 1,
        QuantityMax = 1,
        Rolls = 1
    }
}));
```

4. **扩展 RewardGrantService 处理装备掉落**

```csharp
public async Task GrantRewardsAsync(
    Guid characterId, 
    RewardSummary rewards, 
    CancellationToken ct = default)
{
    // 1. 处理金币和经验（现有逻辑）
    // ...
    
    // 2. 处理物品掉落
    foreach (var (itemId, quantity) in rewards.Items)
    {
        var itemType = DetermineItemType(itemId);
        
        switch (itemType)
        {
            case ItemType.Material:
                // 现有材料处理逻辑
                await GrantMaterialAsync(characterId, itemId, quantity, ct);
                break;
                
            case ItemType.Gear:
                // 新增装备处理逻辑
                await GrantGearAsync(characterId, itemId, quantity, ct);
                break;
        }
    }
}

private async Task GrantGearAsync(
    Guid characterId, 
    string gearDefinitionId, 
    double quantity, 
    CancellationToken ct)
{
    // 1. 获取装备定义
    var gearDef = await _gearDefRepo.GetByIdAsync(gearDefinitionId, ct);
    if (gearDef == null) return;
    
    // 2. 获取角色等级
    var character = await _characterRepo.GetByIdAsync(characterId, ct);
    if (character == null) return;
    
    // 3. 生成装备实例
    for (int i = 0; i < (int)quantity; i++)
    {
        var gear = await _gearGenService.GenerateAsync(gearDef, character.Level, ct);
        gear.CharacterId = characterId;
        
        // 4. 保存到数据库
        await _gearInstanceRepo.CreateAsync(gear, ct);
        
        // 5. 创建背包记录
        var inventoryItem = new InventoryItem
        {
            CharacterId = characterId,
            ItemId = $"gear_instance_{gear.Id}",
            ItemType = "gear",
            Quantity = 1,
            Data = gear.Id.ToString() // 存储 GearInstance ID
        };
        await _inventoryRepo.AddAsync(inventoryItem, ct);
    }
}
```

### 方案2: 独立的装备掉落系统

创建完全独立的装备掉落机制，不与物品系统混合。

#### 优点
- 装备系统完全独立
- 可以有更复杂的装备掉落逻辑（如品质权重、词条过滤等）

#### 缺点
- 需要维护两套掉落系统
- 代码重复较多

**建议采用方案1**，保持系统一致性。

## 实施计划

### Phase 1.4: 装备掉落集成

1. **Task 1.4.1**: 扩展 `LootEntry` 支持装备类型（2小时）
   - 添加 `ItemType` 枚举
   - 添加 `GearDefinitionId` 字段
   - 更新相关文档

2. **Task 1.4.2**: 在 `EconomyRegistry` 注册装备（1小时）
   - 创建装备注册方法
   - 为所有装备定义创建掉落表
   - 更新敌人经济配置

3. **Task 1.4.3**: 实现 `RewardGrantService` 装备掉落逻辑（3小时）
   - 创建 `GrantGearAsync` 方法
   - 集成 `GearGenerationService`
   - 处理背包添加

4. **Task 1.4.4**: 创建集成测试（2小时）
   - 测试装备掉落流程
   - 测试装备生成并添加到背包
   - 测试不同敌人掉落不同装备

## 测试验证

### 单元测试
```csharp
[Fact]
public async Task RewardGrantService_ShouldGenerateGearFromLoot()
{
    // Arrange
    var lootEntry = new LootEntry
    {
        ItemId = "weapon_iron_sword",
        ItemType = ItemType.Gear,
        GearDefinitionId = "weapon_iron_sword",
        DropChance = 1.0, // 100% 掉落用于测试
        QuantityMin = 1,
        QuantityMax = 1
    };
    
    // Act
    var rewards = await CalculateRewards(characterId, new[] { lootEntry });
    await GrantRewards(characterId, rewards);
    
    // Assert
    var inventory = await GetInventory(characterId);
    Assert.Contains(inventory, item => item.ItemType == "gear");
    
    var gearId = Guid.Parse(inventory.First().Data);
    var gear = await GetGearInstance(gearId);
    Assert.NotNull(gear);
    Assert.Equal("weapon_iron_sword", gear.DefinitionId);
}
```

### 集成测试
```csharp
[Fact]
public async Task CompleteBattleAndReceiveGear_ShouldWork()
{
    // Arrange - 创建角色和战斗
    var character = CreateTestCharacter();
    var battle = CreateTestBattle(enemyId: "elite_goblin");
    
    // Act - 完成战斗
    await CompleteBattle(battle);
    
    // Assert - 检查装备掉落
    var inventory = await GetInventory(character.Id);
    var gearItems = inventory.Where(i => i.ItemType == "gear").ToList();
    
    // 验证至少掉落一件装备（根据掉落率）
    Assert.NotEmpty(gearItems);
}
```

## 风险与注意事项

1. **性能考虑**
   - 装备生成比材料掉落复杂，需要考虑性能影响
   - 建议：批量生成装备时使用异步处理

2. **数据一致性**
   - 确保装备实例和背包记录保持一致
   - 使用事务处理装备生成和背包添加

3. **内存占用**
   - 装备实例包含较多字段（词条、属性等）
   - 建议：定期清理未装备的低品质装备

4. **向后兼容**
   - 不影响现有材料掉落系统
   - 保持 `LootEntry` 的默认行为

## 后续扩展

1. **装备过滤器**: 根据角色职业/等级过滤可掉落装备
2. **品质权重**: 不同敌人掉落不同品质装备的概率
3. **套装掉落**: Boss专属套装掉落
4. **掉落通知**: 前端实时显示装备掉落

---

**文档版本**: 1.0  
**创建日期**: 2025-10-11  
**状态**: 设计完成，待实施
