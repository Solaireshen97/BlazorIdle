# 战斗信息传输优化报告

## 概述

本次优化主要针对游戏战斗系统的前后端信息传输进行了增强，使前端能够实时显示当前战斗中玩家和怪物的血量、攻击进度等关键信息。对于地下城模式，还额外显示了怪物数量和波次信息。

## 实施时间
2025年（实际日期根据系统时间）

## 修改范围

### 后端修改（.NET/C#）

#### 1. 数据传输对象（DTO）增强

##### 文件：`BlazorIdle.Server/Application/Battles/Step/StepBattleCoordinator.cs`

**新增 DTO 类：`EnemyHealthStatusDto`**
```csharp
public sealed class EnemyHealthStatusDto
{
    public string EnemyId { get; set; } = "dummy";
    public string EnemyName { get; set; } = "";
    public int CurrentHp { get; set; }
    public int MaxHp { get; set; }
    public double HpPercent { get; set; }
    public bool IsDead { get; set; }
}
```

**扩展 `StepBattleStatusDto` 类，添加字段：**
- `PlayerMaxHp` (int): 玩家最大血量，基于耐力计算（耐力 × 10）
- `PlayerHpPercent` (double): 玩家当前血量百分比，默认1.0（满血）
- `Enemies` (List<EnemyHealthStatusDto>): 敌人血量状态列表
- `NextAttackAt` (double?): 下次普通攻击时间
- `NextSpecialAt` (double?): 下次特殊攻击时间
- `CurrentTime` (double): 当前战斗时间

#### 2. 战斗协调器逻辑更新

##### 文件：`BlazorIdle.Server/Application/Battles/Step/StepBattleCoordinator.cs`

**修改 `Start()` 方法签名**
- 新增参数：`stamina` (int) - 角色耐力值，默认为10

**更新 `GetStatus()` 方法**
- 计算玩家最大血量：`playerMaxHp = stamina * 10`
- 遍历战斗上下文中的敌人群组或单个敌人，收集血量信息
- 从攻击轨道（TrackState）中提取下次攻击时间
- 填充所有新增字段到返回的状态DTO

核心代码逻辑：
```csharp
// 计算玩家血量
int playerMaxHp = rb.Stamina * 10;

// 收集敌人血量状态
var enemyHealthList = new List<EnemyHealthStatusDto>();
if (ctx2.EncounterGroup != null)
{
    foreach (var enc in ctx2.EncounterGroup.All)
    {
        enemyHealthList.Add(new EnemyHealthStatusDto
        {
            EnemyId = enc.Enemy.Id,
            EnemyName = enc.Enemy.Name,
            CurrentHp = enc.CurrentHp,
            MaxHp = enc.Enemy.MaxHp,
            HpPercent = enc.Enemy.MaxHp > 0 ? (double)enc.CurrentHp / enc.Enemy.MaxHp : 0,
            IsDead = enc.IsDead
        });
    }
}

// 获取攻击进度
foreach (var track in ctx2.Tracks)
{
    if (track.TrackType == Domain.Combat.TrackType.Attack)
        nextAttackAt = track.NextTriggerAt;
    else if (track.TrackType == Domain.Combat.TrackType.Special)
        nextSpecialAt = track.NextTriggerAt;
}
```

#### 3. 运行中战斗数据结构

##### 文件：`BlazorIdle.Server/Application/Battles/Step/RunningBattle.cs`

**新增属性：**
- `Stamina` (int): 存储角色的耐力值

**更新构造函数：**
- 添加 `stamina` 参数（默认值10）
- 在初始化时保存耐力值

#### 4. API 控制器

##### 文件：`BlazorIdle.Server/Api/StepBattlesController.cs`

**更新 `Start()` 方法：**
- 从数据库加载的角色对象中获取 `Stamina` 值
- 将耐力值传递给协调器的 `Start()` 方法

### 前端修改（Blazor/C#）

#### 1. API 模型同步

##### 文件：`BlazorIdle/Services/ApiModels.cs`

**新增类：`EnemyHealthStatusDto`**
- 与后端DTO完全匹配

**扩展 `StepStatusResponse` 类：**
- 添加与后端 `StepBattleStatusDto` 相同的新字段

#### 2. UI 界面增强

##### 文件：`BlazorIdle/Pages/Characters.razor`

**在 Step 战斗状态显示区域新增：**

1. **战斗实况板块** - 包含以下内容：

   a. **玩家血量条**
   - 绿色渐变背景 (#4caf50 → #81c784)
   - 显示当前血量/最大血量和百分比
   - 响应式进度条动画（transition: width 0.3s）

   b. **敌人状态列表**
   - 对于地下城模式，显示 [波次 | 轮次 | 怪物数]
   - 对于普通模式，显示 [怪物数]
   - 每个敌人显示：
     * 名称（死亡时显示💀标记）
     * 红色渐变血量条 (#f44336 → #e57373)
     * 当前血量/最大血量和百分比
   - 最多显示5个敌人，超过则提示"...还有 X 个敌人"

   c. **攻击进度条**
   - 普通攻击：蓝色渐变 (#2196f3 → #64b5f6)
   - 特殊攻击：橙色渐变 (#ff9800 → #ffb74d)
   - 显示倒计时或"就绪"状态

**在活动计划战斗状态显示区域：**
- 添加简化版敌人血量显示（最多显示3个）
- 显示地下城波次和轮次信息

### 测试代码

#### 文件：`tests/BlazorIdle.Tests/BattleInfoTransmissionTests.cs`

**创建了4个单元测试：**

1. `GetStatus_ReturnsPlayerMaxHp_BasedOnStamina`
   - 验证玩家最大血量正确计算（耐力 × 10）
   - 验证血量百分比为1.0（满血）

2. `GetStatus_ReturnsEnemyHealthList_ForMultipleEnemies`
   - 验证多怪物战斗时正确返回所有敌人信息
   - 验证每个敌人的字段完整性和数值合理性

3. `GetStatus_ReturnsAttackProgressInfo`
   - 验证返回下次攻击时间信息
   - 验证当前战斗时间字段

4. `GetStatus_DungeonMode_ReturnsWaveAndMonsterCount`
   - 验证地下城模式下的波次和轮次信息
   - 验证敌人列表非空

**测试结果：** ✅ 4/4 测试通过

## 技术细节

### 血量计算公式
- **玩家最大血量** = 耐力 (Stamina) × 10
- **敌人血量百分比** = 当前血量 (CurrentHp) ÷ 最大血量 (MaxHp)

### 攻击进度获取
从战斗引擎的 `TrackState` 列表中筛选：
- `TrackType.Attack` → 普通攻击轨道
- `TrackType.Special` → 特殊攻击轨道

### 多怪物支持
- 通过 `BattleContext.EncounterGroup` 支持多个敌人
- 通过 `BattleContext.Encounter` 支持单个敌人
- 代码自动兼容两种情况

### UI 响应式设计
- 使用 Flexbox 布局保证自适应
- 进度条使用 CSS transition 实现平滑动画
- 渐变色提升视觉效果

## 代码风格保持

本次修改遵循了项目现有的代码风格：
- ✅ 使用 `sealed` 关键字密封 DTO 类
- ✅ 属性初始化器使用 `= new()` 语法
- ✅ 中文注释与原有注释风格一致
- ✅ 命名规范遵循 C# 约定（PascalCase）
- ✅ 前端组件使用内联样式（与现有代码一致）

## 向后兼容性

所有新增字段均为：
- 后端：可空类型或带默认值
- 前端：可选渲染（使用 `@if` 条件）

**不影响现有功能：**
- 旧版本前端仍可正常调用 API（忽略新字段）
- 新增参数均有默认值（`stamina = 10`）

## 构建与部署

### 构建状态
```
Build succeeded.
    0 Warning(s)
    0 Error(s)
Time Elapsed 00:00:03.08
```

### 测试状态
```
Test Run Successful.
Total tests: 4
     Passed: 4
 Total time: 0.7385 Seconds
```

## 性能影响

### 数据量增加评估
- 每次状态查询新增数据：
  - 玩家信息：~20 bytes (2个 int + 1个 double)
  - 每个敌人：~100 bytes (字符串 + 数值)
  - 攻击进度：~16 bytes (2个 double?)
- 对于3个敌人的战斗：~336 bytes
- **影响评估：** 可忽略不计（< 1KB）

### 计算复杂度
- O(n) 遍历敌人列表，n 通常 ≤ 10
- O(m) 遍历攻击轨道，m 固定为2
- **影响评估：** 可忽略不计

## 未来扩展建议

1. **玩家受伤机制**
   - 当游戏引入玩家受伤机制时，只需更新 `PlayerHpPercent` 的计算逻辑
   - 无需修改前端显示代码

2. **更多攻击轨道**
   - 如果添加更多攻击类型，只需在前端添加对应的进度条渲染
   - 后端已支持遍历所有轨道

3. **性能优化**
   - 可考虑只返回变化的敌人信息（增量更新）
   - 前端可实现血量变化动画效果

4. **增强显示**
   - 添加伤害飘字效果
   - 添加血量变化历史图表
   - 显示预估击杀时间

## 相关文件清单

### 修改的文件
1. `BlazorIdle.Server/Api/StepBattlesController.cs`
2. `BlazorIdle.Server/Application/Battles/Step/RunningBattle.cs`
3. `BlazorIdle.Server/Application/Battles/Step/StepBattleCoordinator.cs`
4. `BlazorIdle/Pages/Characters.razor`
5. `BlazorIdle/Services/ApiModels.cs`

### 新增的文件
1. `tests/BlazorIdle.Tests/BattleInfoTransmissionTests.cs`

### 总计
- 修改：5 个文件
- 新增：1 个文件
- 总行数变化：约 +450 行

## 验证清单

- [x] 后端编译通过
- [x] 前端编译通过
- [x] 单元测试全部通过（4/4）
- [x] 代码风格与原有代码一致
- [x] 向后兼容性保证
- [x] 中文注释和文档完整
- [ ] 手动测试前端显示效果（待用户验证）
- [ ] 性能测试（待用户验证）

## 结论

本次优化成功实现了战斗信息的增强显示，包括：
- ✅ 玩家血量显示（基于耐力计算）
- ✅ 实时敌人血量列表（支持多怪物）
- ✅ 攻击进度条显示
- ✅ 地下城波次和数量信息

所有修改均通过编译和单元测试，代码风格保持一致，具有良好的向后兼容性。前端UI设计简洁美观，信息展示清晰直观。

## 截图说明

由于是纯后端开发环境，无法生成实际UI截图。建议用户在浏览器中测试时关注以下显示效果：

1. **战斗状态页面** - 查看"⚔️ 战斗实况"区域
2. **玩家血量条** - 绿色渐变，显示数值
3. **敌人血量列表** - 红色渐变，支持多个敌人
4. **攻击进度条** - 蓝色（普攻）和橙色（特攻）
5. **地下城信息** - 波次、轮次、怪物数量标签

---

**报告生成时间：** 2025年
**开发者：** GitHub Copilot
**项目：** BlazorIdle
