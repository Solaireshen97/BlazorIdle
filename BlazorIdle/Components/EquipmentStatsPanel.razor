@* è£…å¤‡ç»Ÿè®¡é¢æ¿ - æ˜¾ç¤ºè£…å¤‡ç³»ç»Ÿçš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ *@
@using BlazorIdle.Client.Services
@using BlazorIdle.Shared.Models

<div class="equipment-stats-panel" style="margin-top: 16px; padding: 16px; background: #f9f9f9; border-radius: 4px; border: 1px solid #ddd;">
    <h6 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold;">ğŸ“Š è£…å¤‡ç»Ÿè®¡</h6>
    
    @if (EquipmentSlots.Count == 0)
    {
        <div style="text-align: center; padding: 20px; color: #999;">
            <em>æš‚æ— è£…å¤‡æ•°æ®</em>
        </div>
    }
    else
    {
        @* è£…å¤‡æ¦‚è§ˆ *@
        <div class="stats-section" style="margin-bottom: 16px;">
            <div style="font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #555;">
                ğŸ’ è£…å¤‡æ¦‚è§ˆ
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                <div class="stat-item" style="padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                    <div style="color: #666;">å·²è£…å¤‡</div>
                    <div style="font-size: 16px; font-weight: bold; color: #2196f3;">@EquippedCount / @TotalSlots</div>
                </div>
                <div class="stat-item" style="padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                    <div style="color: #666;">ç©ºæ§½ä½</div>
                    <div style="font-size: 16px; font-weight: bold; color: #ff9800;">@EmptySlots</div>
                </div>
                <div class="stat-item" style="padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                    <div style="color: #666;">å¹³å‡ç‰©å“ç­‰çº§</div>
                    <div style="font-size: 16px; font-weight: bold; color: #9c27b0;">@AverageItemLevel.ToString("F1")</div>
                </div>
                <div class="stat-item" style="padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                    <div style="color: #666;">å¹³å‡å“çº§</div>
                    <div style="font-size: 16px; font-weight: bold; color: #4caf50;">T@AverageTier.ToString("F1")</div>
                </div>
            </div>
        </div>
        
        @* å“è´¨åˆ†å¸ƒ *@
        <div class="stats-section" style="margin-bottom: 16px;">
            <div style="font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #555;">
                ğŸ’ å“è´¨åˆ†å¸ƒ
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 6px; font-size: 11px;">
                @foreach (var rarity in RarityDistribution.OrderByDescending(r => GetRarityOrder(r.Key)))
                {
                    <div class="rarity-item" style="padding: 6px; background: @GetRarityBgColor(rarity.Key); border-radius: 4px; text-align: center;">
                        <div style="color: white; font-weight: bold; font-size: 10px;">@rarity.Key</div>
                        <div style="color: white; font-size: 14px; font-weight: bold;">@rarity.Value</div>
                    </div>
                }
            </div>
        </div>
        
        @* å¥—è£…ç»Ÿè®¡ *@
        @if (SetBonuses.Count > 0)
        {
            <div class="stats-section">
                <div style="font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #555;">
                    âœ¨ å¥—è£…æ•ˆæœ
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px; font-size: 11px;">
                    @foreach (var set in SetBonuses)
                    {
                        <div style="padding: 6px; background: white; border-radius: 4px; border-left: 3px solid #4caf50;">
                            <div style="font-weight: bold; color: #2e7d32;">@set.SetName (@set.PieceCount/ä»¶)</div>
                            @if (set.ActiveBonuses.Count > 0)
                            {
                                <div style="color: #666; margin-top: 2px;">
                                    æ¿€æ´»: @string.Join(", ", set.ActiveBonuses)
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
        
        @* æŠ¤ç”²ç±»å‹ç»Ÿè®¡ *@
        @if (ArmorTypes.Count > 0)
        {
            <div class="stats-section" style="margin-top: 16px;">
                <div style="font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #555;">
                    ğŸ›¡ï¸ æŠ¤ç”²ç±»å‹
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 6px; font-size: 11px;">
                    @foreach (var armor in ArmorTypes)
                    {
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center; border: 1px solid #e0e0e0;">
                            <div style="color: #666; font-size: 10px;">@armor.Key</div>
                            <div style="font-weight: bold; color: #1976d2;">@armor.Value</div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    /// <summary>è£…å¤‡æ§½åˆ—è¡¨</summary>
    [Parameter] public List<EquipmentSlotDto> EquipmentSlots { get; set; } = new();
    
    /// <summary>æ€»æ§½ä½æ•°</summary>
    private int TotalSlots => EquipmentSlots.Count;
    
    /// <summary>å·²è£…å¤‡æ•°é‡</summary>
    private int EquippedCount => EquipmentSlots.Count(s => s.Item != null);
    
    /// <summary>ç©ºæ§½ä½æ•°é‡</summary>
    private int EmptySlots => TotalSlots - EquippedCount;
    
    /// <summary>å¹³å‡ç‰©å“ç­‰çº§</summary>
    private double AverageItemLevel
    {
        get
        {
            var items = EquipmentSlots.Where(s => s.Item != null).Select(s => s.Item!).ToList();
            return items.Count > 0 ? items.Average(i => i.ItemLevel) : 0;
        }
    }
    
    /// <summary>å¹³å‡å“çº§</summary>
    private double AverageTier
    {
        get
        {
            var items = EquipmentSlots.Where(s => s.Item != null).Select(s => s.Item!).ToList();
            return items.Count > 0 ? items.Average(i => i.Tier) : 0;
        }
    }
    
    /// <summary>å“è´¨åˆ†å¸ƒ</summary>
    private Dictionary<string, int> RarityDistribution
    {
        get
        {
            return EquipmentSlots
                .Where(s => s.Item != null)
                .GroupBy(s => s.Item!.Rarity)
                .ToDictionary(g => g.Key, g => g.Count());
        }
    }
    
    /// <summary>å¥—è£…ç»Ÿè®¡</summary>
    private List<SetBonusInfo> SetBonuses
    {
        get
        {
            // ç®€åŒ–ç‰ˆï¼šç»Ÿè®¡æ¯ä¸ªå¥—è£…çš„è£…å¤‡æ•°é‡
            var setSummary = EquipmentSlots
                .Where(s => s.Item != null && !string.IsNullOrEmpty(s.Item!.SetId))
                .GroupBy(s => s.Item!.SetId)
                .Select(g => new SetBonusInfo
                {
                    SetName = g.Key ?? "",
                    PieceCount = g.Count(),
                    ActiveBonuses = GetActiveBonuses(g.Count())
                })
                .Where(s => s.PieceCount >= 2) // åªæ˜¾ç¤ºè‡³å°‘2ä»¶å¥—çš„å¥—è£…
                .ToList();
            
            return setSummary;
        }
    }
    
    /// <summary>æŠ¤ç”²ç±»å‹ç»Ÿè®¡</summary>
    private Dictionary<string, int> ArmorTypes
    {
        get
        {
            return EquipmentSlots
                .Where(s => s.Item != null && !string.IsNullOrEmpty(s.Item!.ArmorType))
                .GroupBy(s => s.Item!.ArmorType)
                .ToDictionary(g => g.Key ?? "æœªçŸ¥", g => g.Count());
        }
    }
    
    /// <summary>è·å–å“è´¨èƒŒæ™¯è‰²</summary>
    private string GetRarityBgColor(string rarity)
    {
        return rarity switch
        {
            "æ™®é€š" => "#9e9e9e",
            "ä¼˜ç§€" => "#4caf50",
            "ç²¾è‰¯" => "#2196f3",
            "å²è¯—" => "#9c27b0",
            "ä¼ è¯´" => "#ff9800",
            _ => "#757575"
        };
    }
    
    /// <summary>è·å–å“è´¨æ’åºæƒé‡</summary>
    private int GetRarityOrder(string rarity)
    {
        return rarity switch
        {
            "ä¼ è¯´" => 5,
            "å²è¯—" => 4,
            "ç²¾è‰¯" => 3,
            "ä¼˜ç§€" => 2,
            "æ™®é€š" => 1,
            _ => 0
        };
    }
    
    /// <summary>è·å–æ¿€æ´»çš„å¥—è£…æ•ˆæœ</summary>
    private List<string> GetActiveBonuses(int pieceCount)
    {
        var bonuses = new List<string>();
        if (pieceCount >= 2) bonuses.Add("2ä»¶å¥—");
        if (pieceCount >= 4) bonuses.Add("4ä»¶å¥—");
        if (pieceCount >= 6) bonuses.Add("6ä»¶å¥—");
        return bonuses;
    }
    
    /// <summary>å¥—è£…å¥–åŠ±ä¿¡æ¯</summary>
    private class SetBonusInfo
    {
        public string SetName { get; set; } = "";
        public int PieceCount { get; set; }
        public List<string> ActiveBonuses { get; set; } = new();
    }
}
