@using BlazorIdle.Client.Services

@* BuffçŠ¶æ€æ ç»„ä»¶ *@
@if (Buffs != null && Buffs.Count > 0)
{
    <div class="buff-bar-panel" style="margin-top: 12px;">
        <h6 style="margin-bottom: 8px;">
            @if (IsDebuffBar)
            {
                <span>ğŸ˜ˆ å‡ç›Šæ•ˆæœ</span>
            }
            else
            {
                <span>ğŸ­ å¢ç›Šæ•ˆæœ</span>
            }
        </h6>
        
        <div class="buff-icons" style="display: flex; flex-wrap: wrap; gap: 8px;">
            @foreach (var buff in Buffs)
            {
                <div class="buff-icon" 
                     title="@GetBuffTooltip(buff)"
                     style="position: relative; width: 48px; height: 48px; border: 2px solid @(buff.IsDebuff ? "#f44336" : "#4caf50"); border-radius: 6px; background: @(buff.IsDebuff ? "#ffebee" : "#e8f5e9"); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: help;">
                    
                    <!-- Buffå›¾æ ‡ -->
                    <div style="font-size: 20px;">@buff.Icon</div>
                    
                    <!-- å±‚æ•°æ˜¾ç¤º -->
                    @if (buff.MaxStacks > 1)
                    {
                        <div style="position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; border-radius: 3px; padding: 0 4px; font-size: 10px; font-weight: bold;">
                            @buff.Stacks
                        </div>
                    }
                    
                    <!-- å€’è®¡æ—¶æ˜¾ç¤º -->
                    <div style="position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 9px; color: #666; font-weight: bold;">
                        @FormatRemainingTime(buff.RemainingSeconds)
                    </div>
                </div>
            }
        </div>
        
        @if (ShowBuffNames)
        {
            <!-- Buffåç§°åˆ—è¡¨ï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰ -->
            <div style="margin-top: 6px; font-size: 11px; color: #666;">
                @string.Join(", ", Buffs.Select(b => b.Name))
            </div>
        }
    </div>
}

@code {
    /// <summary>Buffåˆ—è¡¨</summary>
    [Parameter] public List<BuffStatusDto>? Buffs { get; set; }
    
    /// <summary>æ˜¯å¦ä¸ºå‡ç›Šæ•ˆæœæ ï¼ˆtrue=å‡ç›Šï¼Œfalse=å¢ç›Šï¼‰</summary>
    [Parameter] public bool IsDebuffBar { get; set; } = false;
    
    /// <summary>æ˜¯å¦æ˜¾ç¤ºBuffåç§°</summary>
    [Parameter] public bool ShowBuffNames { get; set; } = false;
    
    /// <summary>æ ¼å¼åŒ–å‰©ä½™æ—¶é—´</summary>
    private string FormatRemainingTime(double seconds)
    {
        if (seconds >= 3600) // >= 1å°æ—¶
            return "âˆ";
        else if (seconds >= 60) // >= 1åˆ†é’Ÿ
            return $"{(int)(seconds / 60)}m";
        else if (seconds > 0)
            return $"{seconds:0.0}s";
        else
            return "0s";
    }
    
    /// <summary>ç”ŸæˆBuffæç¤ºä¿¡æ¯</summary>
    private string GetBuffTooltip(BuffStatusDto buff)
    {
        var tooltip = $"{buff.Icon} {buff.Name}\n";
        
        if (buff.MaxStacks > 1)
            tooltip += $"å±‚æ•°: {buff.Stacks}/{buff.MaxStacks}\n";
        
        tooltip += $"å‰©ä½™: {buff.RemainingSeconds:0.0}ç§’";
        
        if (!string.IsNullOrEmpty(buff.Source))
            tooltip += $"\næ¥æº: {buff.Source}";
        
        return tooltip;
    }
}
