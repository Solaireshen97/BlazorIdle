@using BlazorIdle.Client.Services

@* Buff状态栏组件 *@
@if (Buffs != null && Buffs.Count > 0)
{
    <div class="buff-bar-panel" style="margin-top: 12px;">
        <h6 style="margin-bottom: 8px;">
            @if (IsDebuffBar)
            {
                <span>😈 减益效果</span>
            }
            else
            {
                <span>🎭 增益效果</span>
            }
        </h6>
        
        <div class="buff-icons" style="display: flex; flex-wrap: wrap; gap: 8px;">
            @foreach (var buff in Buffs)
            {
                <div class="buff-icon" 
                     title="@GetBuffTooltip(buff)"
                     style="position: relative; width: 48px; height: 48px; border: 2px solid @(buff.IsDebuff ? "#f44336" : "#4caf50"); border-radius: 6px; background: @(buff.IsDebuff ? "#ffebee" : "#e8f5e9"); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: help;">
                    
                    <!-- Buff图标 -->
                    <div style="font-size: 20px;">@buff.Icon</div>
                    
                    <!-- 层数显示 -->
                    @if (buff.MaxStacks > 1)
                    {
                        <div style="position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; border-radius: 3px; padding: 0 4px; font-size: 10px; font-weight: bold;">
                            @buff.Stacks
                        </div>
                    }
                    
                    <!-- 倒计时显示 -->
                    <div style="position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 9px; color: #666; font-weight: bold;">
                        @FormatRemainingTime(buff.RemainingSeconds)
                    </div>
                </div>
            }
        </div>
        
        @if (ShowBuffNames)
        {
            <!-- Buff名称列表（可选显示） -->
            <div style="margin-top: 6px; font-size: 11px; color: #666;">
                @string.Join(", ", Buffs.Select(b => b.Name))
            </div>
        }
    </div>
}

@code {
    /// <summary>Buff列表</summary>
    [Parameter] public List<BuffStatusDto>? Buffs { get; set; }
    
    /// <summary>是否为减益效果栏（true=减益，false=增益）</summary>
    [Parameter] public bool IsDebuffBar { get; set; } = false;
    
    /// <summary>是否显示Buff名称</summary>
    [Parameter] public bool ShowBuffNames { get; set; } = false;
    
    /// <summary>格式化剩余时间</summary>
    private string FormatRemainingTime(double seconds)
    {
        if (seconds >= 3600) // >= 1小时
            return "∞";
        else if (seconds >= 60) // >= 1分钟
            return $"{(int)(seconds / 60)}m";
        else if (seconds > 0)
            return $"{seconds:0.0}s";
        else
            return "0s";
    }
    
    /// <summary>生成Buff提示信息</summary>
    private string GetBuffTooltip(BuffStatusDto buff)
    {
        var tooltip = $"{buff.Icon} {buff.Name}\n";
        
        if (buff.MaxStacks > 1)
            tooltip += $"层数: {buff.Stacks}/{buff.MaxStacks}\n";
        
        tooltip += $"剩余: {buff.RemainingSeconds:0.0}秒";
        
        if (!string.IsNullOrEmpty(buff.Source))
            tooltip += $"\n来源: {buff.Source}";
        
        return tooltip;
    }
}
