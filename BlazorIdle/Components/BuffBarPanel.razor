@using BlazorIdle.Client.Services

@* BuffçŠ¶æ€æ é¢æ¿ç»„ä»¶ *@
@if (Buffs != null && Buffs.Count > 0)
{
    <div class="buff-bar-panel" style="margin-top: 12px; padding: 8px; background: @BackgroundColor; border-radius: 4px; border: 1px solid @BorderColor;">
        <h6 style="margin: 0 0 8px 0; font-size: 13px;">@Title</h6>
        <div class="buff-list" style="display: flex; flex-wrap: wrap; gap: 6px;">
            @foreach (var buff in Buffs)
            {
                var iconBg = buff.IsDebuff ? "#ffebee" : "#e8f5e9";
                var iconBorder = buff.IsDebuff ? "#ef5350" : "#66bb6a";
                
                <div class="buff-item" 
                     style="position: relative; width: 42px; height: 42px; background: @iconBg; border: 2px solid @iconBorder; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: help;"
                     title="@GetBuffTooltip(buff)">
                    
                    @* Buffå›¾æ ‡ *@
                    <div style="font-size: 18px;">@GetBuffIcon(buff.Id)</div>
                    
                    @* å±‚æ•°æ˜¾ç¤º *@
                    @if (buff.Stacks > 1)
                    {
                        <div style="position: absolute; bottom: 2px; right: 3px; font-size: 9px; font-weight: bold; color: #333; background: rgba(255,255,255,0.8); padding: 0 3px; border-radius: 2px;">
                            @buff.Stacks
                        </div>
                    }
                    
                    @* å€’è®¡æ—¶æ˜¾ç¤º *@
                    @if (buff.RemainingSeconds > 0 && buff.RemainingSeconds < 999)
                    {
                        <div style="position: absolute; top: 2px; left: 2px; font-size: 8px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.6); padding: 1px 3px; border-radius: 2px;">
                            @FormatTime(buff.RemainingSeconds)
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    /// <summary>Buffåˆ—è¡¨</summary>
    [Parameter] public List<BuffStatusDto> Buffs { get; set; } = new();
    
    /// <summary>æ ‡é¢˜</summary>
    [Parameter] public string Title { get; set; } = "ğŸ­ å¢ç›Šæ•ˆæœ";
    
    /// <summary>èƒŒæ™¯é¢œè‰²</summary>
    [Parameter] public string BackgroundColor { get; set; } = "#f9fbe7";
    
    /// <summary>è¾¹æ¡†é¢œè‰²</summary>
    [Parameter] public string BorderColor { get; set; } = "#dce775";
    
    /// <summary>è·å–Buffå›¾æ ‡ï¼ˆä½¿ç”¨emojiï¼‰</summary>
    private string GetBuffIcon(string buffId)
    {
        return buffId.ToLowerInvariant() switch
        {
            // æˆ˜å£«Buff
            "berserk" => "ğŸ’ª",
            "warrior_expose_armor" => "ğŸ›¡ï¸",
            "warrior_precision" => "âš¡",
            "expose armor" => "ğŸ›¡ï¸",
            "precision" => "âš¡",
            
            // æ¸¸ä¾ Buff
            "ranger_bleed" => "ğŸ”¥",
            "ranger_hunters_mark" => "ğŸ¯",
            "ranger_sharpsight" => "ğŸ‘ï¸",
            "focus_flow" => "ğŸŒŠ",
            "ranger bleed" => "ğŸ”¥",
            "hunter's mark" => "ğŸ¯",
            "sharpsight" => "ğŸ‘ï¸",
            "focus flow" => "ğŸŒŠ",
            
            // æ•ŒäººBuff
            "enrage" => "ğŸ˜¡",
            "poison" => "â˜ ï¸",
            "regeneration" => "ğŸ’š",
            
            // é»˜è®¤å›¾æ ‡
            _ => "âœ¨"
        };
    }
    
    /// <summary>æ ¼å¼åŒ–å€’è®¡æ—¶</summary>
    private string FormatTime(double seconds)
    {
        if (seconds < 10)
            return $"{seconds:0.0}";
        else if (seconds < 60)
            return $"{(int)seconds}";
        else
            return $"{(int)(seconds / 60)}m";
    }
    
    /// <summary>è·å–Buffæç¤ºæ–‡æœ¬</summary>
    private string GetBuffTooltip(BuffStatusDto buff)
    {
        var tooltip = $"{buff.Name}\n";
        
        if (buff.Stacks > 1)
            tooltip += $"å±‚æ•°: {buff.Stacks}/{buff.MaxStacks}\n";
        
        if (buff.RemainingSeconds > 0 && buff.RemainingSeconds < 999)
            tooltip += $"å‰©ä½™: {buff.RemainingSeconds:0.0}ç§’\n";
        else if (buff.RemainingSeconds >= 999)
            tooltip += "æŒç»­æ—¶é—´: æ°¸ä¹…\n";
        
        return tooltip.TrimEnd();
    }
}
