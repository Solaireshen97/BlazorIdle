@* è£…å¤‡å¢å¼ºé¢æ¿ç»„ä»¶ - ç”¨äºè£…å¤‡åˆ†è§£å’Œé‡é“¸ *@
@using BlazorIdle.Client.Services
@using BlazorIdle.Services
@inject ApiClient Api

<!-- ç¡®è®¤å¯¹è¯æ¡† -->
<ConfirmDialog 
    Show="@showConfirmDialog"
    Title="@confirmTitle"
    Message="@confirmMessage"
    WarningText="@confirmWarning"
    Type="@confirmType"
    OnConfirm="@OnConfirmAction"
    OnCancel="@OnCancelAction" />

<div class="panel" style="margin-top: 16px;">
    <h4>âš’ï¸ è£…å¤‡å¢å¼º</h4>
    
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }
    
    @if (IsLoading)
    {
        <p style="color: #666;">åŠ è½½ä¸­...</p>
    }
    else
    {
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs" style="margin-bottom: 16px; border-bottom: 2px solid #ddd;">
            <button class="@GetTabClass(EnhancementTab.Disenchant)" @onclick="() => SelectTab(EnhancementTab.Disenchant)">
                ğŸ”® è£…å¤‡åˆ†è§£
            </button>
            <button class="@GetTabClass(EnhancementTab.Reforge)" @onclick="() => SelectTab(EnhancementTab.Reforge)">
                âš¡ è£…å¤‡é‡é“¸
            </button>
        </div>

        <!-- è£…å¤‡åˆ†è§£æ ‡ç­¾ -->
        @if (CurrentTab == EnhancementTab.Disenchant)
        {
            <div class="tab-content">
                <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                    ğŸ’¡ æç¤ºï¼šå°†ä¸éœ€è¦çš„è£…å¤‡åˆ†è§£ä¸ºææ–™ï¼Œç”¨äºé‡é“¸å…¶ä»–è£…å¤‡ã€‚
                </p>

                @if (InventoryItems.Count == 0)
                {
                    <p style="color: #999; font-style: italic;">èƒŒåŒ…ä¸­æ²¡æœ‰å¯åˆ†è§£çš„è£…å¤‡</p>
                }
                else
                {
                    <div class="items-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        @foreach (var item in InventoryItems)
                        {
                            var isSelected = SelectedDisenchantIds.Contains(item.Id);
                            var cardClass = isSelected ? "item-card selected" : "item-card";
                            <div class="@cardClass" @key="item.Id" @onclick="() => ToggleDisenchantSelection(item.Id)" style="cursor: pointer; padding: 12px; border: 2px solid @(isSelected ? "#007bff" : "#ddd"); border-radius: 4px; background: @(isSelected ? "#e7f3ff" : "white"); transition: all 0.2s;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 24px;">@(item.Icon ?? "?")</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 13px; color: @GetRarityColor(item.Rarity);">@item.Name</div>
                                        <div style="font-size: 11px; color: #666;">ç­‰çº§ @item.ItemLevel</div>
                                    </div>
                                </div>
                                @if (DisenchantPreviews.ContainsKey(item.Id))
                                {
                                    <div style="font-size: 11px; color: #28a745; margin-top: 4px;">
                                        @foreach (var mat in DisenchantPreviews[item.Id].Materials)
                                        {
                                            <div>â€¢ @mat.Key x@mat.Value</div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn btn-primary" @onclick="DisenchantSelected" disabled="@(SelectedDisenchantIds.Count == 0 || IsBusy)">
                            ğŸ”® åˆ†è§£é€‰ä¸­çš„è£…å¤‡ (@SelectedDisenchantIds.Count)
                        </button>
                        @if (SelectedDisenchantIds.Count > 0)
                        {
                            <button class="btn btn-secondary" @onclick="ClearDisenchantSelection" disabled="@IsBusy">
                                æ¸…é™¤é€‰æ‹©
                            </button>
                        }
                    </div>
                }
            </div>
        }

        <!-- è£…å¤‡é‡é“¸æ ‡ç­¾ -->
        @if (CurrentTab == EnhancementTab.Reforge)
        {
            <div class="tab-content">
                <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                    ğŸ’¡ æç¤ºï¼šæ¶ˆè€—ææ–™æå‡è£…å¤‡å“çº§ï¼Œå¢å¼ºè£…å¤‡å±æ€§ã€‚
                </p>

                @if (EquippedItems.Count == 0)
                {
                    <p style="color: #999; font-style: italic;">å½“å‰æ²¡æœ‰å·²è£…å¤‡çš„ç‰©å“</p>
                }
                else
                {
                    <div class="items-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;">
                        @foreach (var item in EquippedItems)
                        {
                            <div class="item-card" @key="item.Id" style="padding: 12px; border: 2px solid #ddd; border-radius: 4px; background: white;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 24px;">@(item.Icon ?? "?")</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 13px; color: @GetRarityColor(item.Rarity);">@item.Name</div>
                                        <div style="font-size: 11px; color: #666;">å“çº§ T@item.TierLevel | ç­‰çº§ @item.ItemLevel</div>
                                        <div style="font-size: 11px; color: #666;">@item.SlotName</div>
                                    </div>
                                </div>
                                
                                @if (ReforgePreviews.ContainsKey(item.Id))
                                {
                                    var preview = ReforgePreviews[item.Id];
                                    @if (preview.CanReforge)
                                    {
                                        <div style="font-size: 11px; background: #f0f8ff; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                            <div style="font-weight: 600; color: #007bff; margin-bottom: 4px;">T@preview.CurrentTier â†’ T@preview.NextTier</div>
                                            <div style="color: #666; margin-bottom: 4px;">æˆæœ¬:</div>
                                            @foreach (var cost in preview.Cost)
                                            {
                                                <div style="color: #d9534f;">â€¢ @cost.Key x@cost.Value</div>
                                            }
                                        </div>
                                        <button class="btn btn-sm btn-success" @onclick="() => ReforgeItem(item.Id)" disabled="@IsBusy" style="width: 100%; font-size: 12px;">
                                            âš¡ é‡é“¸
                                        </button>
                                    }
                                    else
                                    {
                                        <div style="font-size: 11px; color: #999; font-style: italic;">@preview.Message</div>
                                    }
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => LoadReforgePreview(item.Id)" disabled="@IsBusy" style="width: 100%; font-size: 12px;">
                                        æŸ¥çœ‹é‡é“¸é¢„è§ˆ
                                    </button>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .tabs button {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }

    .tabs button:hover {
        color: #007bff;
    }

    .tabs button.active {
        color: #007bff;
        border-bottom-color: #007bff;
    }

    .item-card {
        transition: transform 0.1s, box-shadow 0.1s;
    }

    .item-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .item-card.selected {
        box-shadow: 0 0 0 2px #007bff;
    }
</style>

@code {
    [Parameter]
    public Guid CharacterId { get; set; }

    [Parameter]
    public bool IsLoading { get; set; }

    [Parameter]
    public string ErrorMessage { get; set; } = "";

    [Parameter]
    public List<InventoryItemDto> InventoryItems { get; set; } = new();

    [Parameter]
    public List<EquippedItemDto> EquippedItems { get; set; } = new();

    [Parameter]
    public EventCallback OnItemsChanged { get; set; }

    [Parameter]
    public ToastNotification? ToastNotification { get; set; }

    /// <summary>æ ‡ç­¾é¡µæšä¸¾</summary>
    private enum EnhancementTab
    {
        Disenchant,
        Reforge
    }

    private EnhancementTab CurrentTab = EnhancementTab.Disenchant;
    private bool IsBusy = false;
    private HashSet<Guid> SelectedDisenchantIds = new();
    private Dictionary<Guid, DisenchantPreviewResponse> DisenchantPreviews = new();
    private Dictionary<Guid, ReforgePreviewResponse> ReforgePreviews = new();
    
    // ç¡®è®¤å¯¹è¯æ¡†çŠ¶æ€
    private bool showConfirmDialog = false;
    private string confirmTitle = "";
    private string confirmMessage = "";
    private string confirmWarning = "";
    private ConfirmDialog.DialogType confirmType = ConfirmDialog.DialogType.Warning;
    private Func<Task>? pendingAction = null;

    /// <summary>é€‰æ‹©æ ‡ç­¾é¡µ</summary>
    private void SelectTab(EnhancementTab tab)
    {
        CurrentTab = tab;
        StateHasChanged();
    }

    /// <summary>è·å–æ ‡ç­¾æŒ‰é’®æ ·å¼</summary>
    private string GetTabClass(EnhancementTab tab)
    {
        return CurrentTab == tab ? "active" : "";
    }

    /// <summary>è·å–ç¨€æœ‰åº¦é¢œè‰²</summary>
    private string GetRarityColor(string rarity)
    {
        return rarity?.ToLower() switch
        {
            "common" => "#9d9d9d",
            "rare" => "#0070dd",
            "epic" => "#a335ee",
            "legendary" => "#ff8000",
            _ => "#333"
        };
    }

    /// <summary>åˆ‡æ¢åˆ†è§£é€‰æ‹©</summary>
    private async Task ToggleDisenchantSelection(Guid itemId)
    {
        if (SelectedDisenchantIds.Contains(itemId))
        {
            SelectedDisenchantIds.Remove(itemId);
        }
        else
        {
            SelectedDisenchantIds.Add(itemId);
            // åŠ è½½åˆ†è§£é¢„è§ˆ
            if (!DisenchantPreviews.ContainsKey(itemId))
            {
                await LoadDisenchantPreview(itemId);
            }
        }
        StateHasChanged();
    }

    /// <summary>æ¸…é™¤åˆ†è§£é€‰æ‹©</summary>
    private void ClearDisenchantSelection()
    {
        SelectedDisenchantIds.Clear();
        StateHasChanged();
    }

    /// <summary>åŠ è½½åˆ†è§£é¢„è§ˆ</summary>
    private async Task LoadDisenchantPreview(Guid itemId)
    {
        try
        {
            var preview = await Api.PreviewDisenchantAsync(itemId);
            if (preview != null)
            {
                DisenchantPreviews[itemId] = preview;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"åŠ è½½åˆ†è§£é¢„è§ˆå¤±è´¥: {ex.Message}");
        }
    }

    /// <summary>åˆ†è§£é€‰ä¸­çš„è£…å¤‡ï¼ˆå¸¦ç¡®è®¤ï¼‰</summary>
    private void DisenchantSelected()
    {
        if (SelectedDisenchantIds.Count == 0) return;

        var itemCount = SelectedDisenchantIds.Count;
        confirmTitle = "ç¡®è®¤åˆ†è§£";
        confirmMessage = $"ç¡®å®šè¦åˆ†è§£é€‰ä¸­çš„ {itemCount} ä»¶è£…å¤‡å—ï¼Ÿ";
        confirmWarning = "åˆ†è§£åçš„è£…å¤‡å°†æ— æ³•æ¢å¤ï¼Œä½†ä¼šè·å¾—ææ–™ã€‚";
        confirmType = ConfirmDialog.DialogType.Warning;
        pendingAction = PerformDisenchant;
        showConfirmDialog = true;
    }

    /// <summary>æ‰§è¡Œåˆ†è§£æ“ä½œ</summary>
    private async Task PerformDisenchant()
    {
        if (SelectedDisenchantIds.Count == 0) return;

        try
        {
            IsBusy = true;
            var result = await Api.DisenchantBatchAsync(CharacterId, SelectedDisenchantIds.ToList());
            
            if (result != null)
            {
                // æ¸…é™¤é€‰æ‹©
                var processedCount = result.SuccessCount;
                SelectedDisenchantIds.Clear();
                DisenchantPreviews.Clear();
                
                // æ˜¾ç¤ºToasté€šçŸ¥
                if (result.SuccessCount > 0)
                {
                    var materialsSummary = string.Join(", ", result.TotalMaterials.Select(m => $"{m.Key} x{m.Value}"));
                    ToastNotification?.ShowSuccess(
                        $"æˆåŠŸåˆ†è§£ {result.SuccessCount} ä»¶è£…å¤‡ï¼Œè·å¾—: {materialsSummary}",
                        "åˆ†è§£æˆåŠŸ"
                    );
                }
                
                if (result.FailCount > 0)
                {
                    ToastNotification?.ShowWarning(
                        $"{result.FailCount} ä»¶è£…å¤‡åˆ†è§£å¤±è´¥",
                        "éƒ¨åˆ†å¤±è´¥"
                    );
                }
                
                // é€šçŸ¥çˆ¶ç»„ä»¶åˆ·æ–°
                if (OnItemsChanged.HasDelegate)
                {
                    await OnItemsChanged.InvokeAsync();
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            ToastNotification?.ShowError($"åˆ†è§£è£…å¤‡å¤±è´¥: {ex.Message}", "é”™è¯¯");
            Console.WriteLine($"åˆ†è§£è£…å¤‡å¤±è´¥: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }

    /// <summary>åŠ è½½é‡é“¸é¢„è§ˆ</summary>
    private async Task LoadReforgePreview(Guid itemId)
    {
        try
        {
            IsBusy = true;
            var preview = await Api.PreviewReforgeAsync(itemId);
            if (preview != null)
            {
                ReforgePreviews[itemId] = preview;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"åŠ è½½é‡é“¸é¢„è§ˆå¤±è´¥: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }

    /// <summary>é‡é“¸è£…å¤‡ï¼ˆå¸¦ç¡®è®¤ï¼‰</summary>
    private void ReforgeItem(Guid itemId)
    {
        if (!ReforgePreviews.TryGetValue(itemId, out var preview) || !preview.CanReforge)
            return;

        var item = EquippedItems.FirstOrDefault(i => i.Id == itemId);
        if (item == null) return;

        var costSummary = string.Join(", ", preview.Cost.Select(c => $"{c.Key} x{c.Value}"));
        
        confirmTitle = "ç¡®è®¤é‡é“¸";
        confirmMessage = $"ç¡®å®šè¦é‡é“¸ {item.Name} å—ï¼Ÿ\n\nå“çº§: T{preview.CurrentTier} â†’ T{preview.NextTier}\næˆæœ¬: {costSummary}";
        confirmWarning = "é‡é“¸å°†æ¶ˆè€—ææ–™ï¼Œè¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„ææ–™ã€‚";
        confirmType = ConfirmDialog.DialogType.Primary;
        pendingAction = () => PerformReforge(itemId);
        showConfirmDialog = true;
    }

    /// <summary>æ‰§è¡Œé‡é“¸æ“ä½œ</summary>
    private async Task PerformReforge(Guid itemId)
    {
        try
        {
            IsBusy = true;
            var result = await Api.ReforgeItemAsync(CharacterId, itemId);
            
            if (result != null && result.Success)
            {
                // æ¸…é™¤é¢„è§ˆç¼“å­˜
                ReforgePreviews.Remove(itemId);
                
                // æ˜¾ç¤ºToasté€šçŸ¥
                var newTier = result.Gear?.TierLevel ?? 0;
                ToastNotification?.ShowSuccess(
                    $"æˆåŠŸå°†è£…å¤‡é‡é“¸è‡³ T{newTier}",
                    "é‡é“¸æˆåŠŸ"
                );
                
                // é€šçŸ¥çˆ¶ç»„ä»¶åˆ·æ–°
                if (OnItemsChanged.HasDelegate)
                {
                    await OnItemsChanged.InvokeAsync();
                }
                
                StateHasChanged();
            }
            else if (result != null)
            {
                ToastNotification?.ShowError(result.Message ?? "é‡é“¸å¤±è´¥", "é”™è¯¯");
            }
        }
        catch (Exception ex)
        {
            ToastNotification?.ShowError($"é‡é“¸è£…å¤‡å¤±è´¥: {ex.Message}", "é”™è¯¯");
            Console.WriteLine($"é‡é“¸è£…å¤‡å¤±è´¥: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }

    /// <summary>ç¡®è®¤å¯¹è¯æ¡†ç¡®è®¤å›è°ƒ</summary>
    private async Task OnConfirmAction()
    {
        showConfirmDialog = false;
        if (pendingAction != null)
        {
            await pendingAction();
            pendingAction = null;
        }
    }

    /// <summary>ç¡®è®¤å¯¹è¯æ¡†å–æ¶ˆå›è°ƒ</summary>
    private void OnCancelAction()
    {
        showConfirmDialog = false;
        pendingAction = null;
    }

    /// <summary>ç®€åŒ–çš„èƒŒåŒ…ç‰©å“DTO</summary>
    public class InventoryItemDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string? Icon { get; set; }
        public string Rarity { get; set; } = "";
        public int ItemLevel { get; set; }
    }

    /// <summary>ç®€åŒ–çš„å·²è£…å¤‡ç‰©å“DTO</summary>
    public class EquippedItemDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string? Icon { get; set; }
        public string Rarity { get; set; } = "";
        public int ItemLevel { get; set; }
        public int TierLevel { get; set; }
        public string SlotName { get; set; } = "";
    }
}
