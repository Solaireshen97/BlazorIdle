@using BlazorIdle.Client.Services
@using BlazorIdle.Shared.Models

@* è£…å¤‡é¢æ¿ç»„ä»¶ - Step 5: è£…å¤‡ç³»ç»ŸUIé¢„ç•™ + Phase 6: è£…å¤‡å¯¹æ¯”å’Œé™åˆ¶æç¤º *@
<div class="equipment-panel" style="margin-top: 16px; padding: 16px; background: @BackgroundColor; border-radius: 4px; border: 1px solid @BorderColor;">
    <h6 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold;">ğŸ’ @Title</h6>
    
    @if (IsLoading)
    {
        <div style="text-align: center; padding: 20px; color: #999;">
            <em>åŠ è½½ä¸­...</em>
        </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div style="padding: 12px; background: #ffebee; border: 1px solid #ef5350; border-radius: 4px; color: #c62828;">
            âš ï¸ @ErrorMessage
        </div>
    }
    else
    {
        @* è£…å¤‡æ§½å¸ƒå±€ - 17æ§½ä½ç³»ç»Ÿ *@
        <div class="equipment-slots" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 16px;">
            @* ç¬¬ä¸€è¡Œï¼šç©º - å¤´éƒ¨ - ç©º *@
            <div></div>
            @RenderSlot("head", "å¤´éƒ¨", "ğŸª–")
            <div></div>

            @* ç¬¬äºŒè¡Œï¼šè‚©éƒ¨ - é¢ˆéƒ¨ - èƒŒéƒ¨ *@
            @RenderSlot("shoulder", "è‚©éƒ¨", "ğŸ½")
            @RenderSlot("neck", "é¢ˆéƒ¨", "ğŸ“¿")
            @RenderSlot("back", "èƒŒéƒ¨", "ğŸ§¥")

            @* ç¬¬ä¸‰è¡Œï¼šä¸»æ‰‹ - èƒ¸éƒ¨ - å‰¯æ‰‹ *@
            @RenderSlot("mainhand", "ä¸»æ‰‹", "âš”ï¸")
            @RenderSlot("chest", "èƒ¸éƒ¨", "ğŸ›¡ï¸")
            @RenderSlot("offhand", "å‰¯æ‰‹", "ğŸ”°")

            @* ç¬¬å››è¡Œï¼šæ‰‹è…• - è…°éƒ¨ - æ‰‹å¥— *@
            @RenderSlot("wrist", "æ‰‹è…•", "âŒš")
            @RenderSlot("waist", "è…°éƒ¨", "ğŸ—ï¸")
            @RenderSlot("hands", "æ‰‹å¥—", "ğŸ§¤")

            @* ç¬¬äº”è¡Œï¼šç©º - è…¿éƒ¨ - ç©º *@
            <div></div>
            @RenderSlot("legs", "è…¿éƒ¨", "ğŸ¦µ")
            <div></div>

            @* ç¬¬å…­è¡Œï¼šæˆ’æŒ‡1 - è„šéƒ¨ - æˆ’æŒ‡2 *@
            @RenderSlot("finger1", "æˆ’æŒ‡1", "ğŸ’")
            @RenderSlot("feet", "è„šéƒ¨", "ğŸ‘¢")
            @RenderSlot("finger2", "æˆ’æŒ‡2", "ğŸ’")

            @* ç¬¬ä¸ƒè¡Œï¼šç©º - é¥°å“æ§½ - ç©º *@
            <div></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                @RenderSlot("trinket1", "é¥°å“1", "âœ¨")
                @RenderSlot("trinket2", "é¥°å“2", "âœ¨")
            </div>
            <div></div>
        </div>

        @* æ€»å±æ€§é¢æ¿ - å¢å¼ºç‰ˆ *@
        <div class="equipment-stats" style="padding: 12px; background: #f5f5f5; border-radius: 4px; border: 1px solid #e0e0e0;">
            <div style="font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #555;">ğŸ“Š æ€»å±æ€§</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                @* æ”»å‡»å±æ€§ *@
                <div style="display: flex; justify-content: space-between;">
                    <span>âš”ï¸ æ”»å‡»åŠ›:</span>
                    <span style="font-weight: bold; color: #d32f2f;">@GetStatValue("AttackPower")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ”® æ³•æœ¯å¼ºåº¦:</span>
                    <span style="font-weight: bold; color: #7b1fa2;">@GetStatValue("SpellPower")</span>
                </div>
                
                @* é˜²å¾¡å±æ€§ *@
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ›¡ï¸ æŠ¤ç”²:</span>
                    <span style="font-weight: bold; color: #1976d2;">@GetStatValue("Armor")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ”° æ ¼æŒ¡ç‡:</span>
                    <span style="font-weight: bold; color: #0277bd;">@GetStatPercentDisplay("BlockChance")</span>
                </div>
                
                @* é€Ÿåº¦ä¸æš´å‡» *@
                <div style="display: flex; justify-content: space-between;">
                    <span>âš¡ æ€¥é€Ÿ:</span>
                    <span style="font-weight: bold; color: #f57c00;">@GetStatPercent("HastePercent")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ’¥ æš´å‡»:</span>
                    <span style="font-weight: bold; color: #c2185b;">@GetStatPercent("CritChance")</span>
                </div>
                
                @* æ”»å‡»é€Ÿåº¦ï¼ˆå¦‚æœæœ‰æ­¦å™¨ï¼‰ *@
                @if (!string.IsNullOrEmpty(WeaponInfo) && GetAttackSpeed() > 0)
                {
                    <div style="display: flex; justify-content: space-between;">
                        <span>â±ï¸ æ”»å‡»é€Ÿåº¦:</span>
                        <span style="font-weight: bold; color: #ff6f00;">@GetAttackSpeedDisplay()</span>
                    </div>
                }
                
                @* å…¶ä»–å±æ€§ *@
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ’ª åŠ›é‡:</span>
                    <span style="font-weight: bold; color: #d84315;">@GetStatValue("Strength")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ¯ æ•æ·:</span>
                    <span style="font-weight: bold; color: #388e3c;">@GetStatValue("Agility")</span>
                </div>
                
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ§  æ™ºåŠ›:</span>
                    <span style="font-weight: bold; color: #1976d2;">@GetStatValue("Intellect")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>â¤ï¸ è€åŠ›:</span>
                    <span style="font-weight: bold; color: #e53935;">@GetStatValue("Stamina")</span>
                </div>
            </div>
            
            @* æ­¦å™¨ä¿¡æ¯å’ŒDPS *@
            @if (!string.IsNullOrEmpty(WeaponInfo) || GetEstimatedDps() > 0)
            {
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0; font-size: 11px;">
                    @if (!string.IsNullOrEmpty(WeaponInfo))
                    {
                        <div style="color: #666; margin-bottom: 4px;">
                            ğŸ—¡ï¸ @WeaponInfo
                        </div>
                    }
                    @if (GetEstimatedDps() > 0)
                    {
                        <div style="color: #d32f2f; font-weight: bold;">
                            âš”ï¸ é¢„ä¼°DPS: @GetFormattedDps()
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    /// <summary>è§’è‰²ID</summary>
    [Parameter] public Guid CharacterId { get; set; }
    
    /// <summary>æ ‡é¢˜</summary>
    [Parameter] public string Title { get; set; } = "è£…å¤‡ä¸å±æ€§";
    
    /// <summary>èƒŒæ™¯é¢œè‰²</summary>
    [Parameter] public string BackgroundColor { get; set; } = "#fff8e1";
    
    /// <summary>è¾¹æ¡†é¢œè‰²</summary>
    [Parameter] public string BorderColor { get; set; } = "#ffb74d";
    
    /// <summary>æ˜¯å¦æ­£åœ¨åŠ è½½</summary>
    [Parameter] public bool IsLoading { get; set; }
    
    /// <summary>é”™è¯¯æ¶ˆæ¯</summary>
    [Parameter] public string ErrorMessage { get; set; } = "";
    
    /// <summary>è£…å¤‡æ§½åˆ—è¡¨</summary>
    [Parameter] public List<EquipmentSlotDto> Slots { get; set; } = new();
    
    /// <summary>æ€»å±æ€§</summary>
    [Parameter] public Dictionary<string, double> TotalStats { get; set; } = new();
    
    /// <summary>æ­¦å™¨ä¿¡æ¯æ˜¾ç¤º</summary>
    [Parameter] public string WeaponInfo { get; set; } = "";
    
    /// <summary>è§’è‰²èŒä¸šï¼ˆç”¨äºèŒä¸šé™åˆ¶æ£€æŸ¥ï¼‰</summary>
    [Parameter] public Profession CharacterProfession { get; set; }
    
    /// <summary>è§’è‰²ç­‰çº§ï¼ˆç”¨äºç­‰çº§é™åˆ¶æ£€æŸ¥ï¼‰</summary>
    [Parameter] public int CharacterLevel { get; set; }
    
    /// <summary>è£…å¤‡å¯¹æ¯”æœåŠ¡ï¼ˆå¯é€‰ï¼Œç”¨äºæ˜¾ç¤ºå¯¹æ¯”ä¿¡æ¯ï¼‰</summary>
    private EquipmentComparisonService? _comparisonService = new();
    
    /// <summary>è£…å¤‡é™åˆ¶è¾…åŠ©æœåŠ¡ï¼ˆç”¨äºæ£€æŸ¥èŒä¸šå’Œç­‰çº§é™åˆ¶ï¼‰</summary>
    private EquipmentRestrictionHelper? _restrictionHelper = new();
    
    /// <summary>DPSè®¡ç®—æœåŠ¡ï¼ˆç”¨äºæ˜¾ç¤ºæˆ˜æ–—è¾“å‡ºï¼‰</summary>
    private DpsCalculatorService? _dpsCalculator = new();

    /// <summary>æ¸²æŸ“å•ä¸ªè£…å¤‡æ§½</summary>
    private RenderFragment RenderSlot(string slotType, string slotName, string defaultIcon) => builder =>
    {
        var slot = Slots.FirstOrDefault(s => s.SlotType == slotType);
        var hasItem = slot?.Item != null;
        
        // æ£€æŸ¥è£…å¤‡é™åˆ¶
        bool canEquip = true;
        if (hasItem && _restrictionHelper != null)
        {
            var restriction = _restrictionHelper.CheckRestrictions(slot!.Item!, CharacterProfession, CharacterLevel);
            canEquip = restriction.CanEquip;
        }
        
        // æ ¹æ®é™åˆ¶æƒ…å†µè°ƒæ•´é¢œè‰²
        var bgColor = hasItem ? (canEquip ? "#e8f5e9" : "#ffebee") : "#fafafa";
        var borderColor = hasItem ? (canEquip ? "#66bb6a" : "#f44336") : "#e0e0e0";
        var icon = hasItem ? (slot!.Item!.Icon ?? defaultIcon) : defaultIcon;
        var itemName = hasItem ? slot!.Item!.Name : slotName;
        var opacity = hasItem ? "1.0" : "0.4";

        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "equipment-slot");
        builder.AddAttribute(2, "style", $"position: relative; padding: 8px; background: {bgColor}; border: 2px solid {borderColor}; border-radius: 6px; text-align: center; cursor: pointer; opacity: {opacity}; min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center;");
        builder.AddAttribute(3, "title", hasItem ? GetItemTooltipWithComparison(slot!.Item!, slotType) : $"ç©º - {slotName}");

        // å›¾æ ‡
        builder.OpenElement(4, "div");
        builder.AddAttribute(5, "style", "font-size: 24px; margin-bottom: 2px;");
        builder.AddContent(6, icon);
        builder.CloseElement();

        // åç§°
        builder.OpenElement(7, "div");
        builder.AddAttribute(8, "style", "font-size: 9px; color: #555; font-weight: bold; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;");
        builder.AddContent(9, itemName);
        builder.CloseElement();

        // å“è´¨æ ‡ç­¾ï¼ˆå¦‚æœæœ‰è£…å¤‡ï¼‰
        if (hasItem)
        {
            var rarityColor = GetRarityColor(slot!.Item!.Rarity);
            builder.OpenElement(10, "div");
            builder.AddAttribute(11, "style", $"position: absolute; top: 2px; right: 2px; font-size: 8px; padding: 1px 4px; background: {rarityColor}; color: white; border-radius: 2px; font-weight: bold;");
            builder.AddContent(12, GetRarityText(slot!.Item!.Rarity));
            builder.CloseElement();
        }
        
        // é™åˆ¶çŠ¶æ€æ ‡è¯†ï¼ˆå¦‚æœæœ‰è£…å¤‡ä¸”æ— æ³•è£…å¤‡ï¼‰
        if (hasItem && !canEquip && _restrictionHelper != null)
        {
            builder.OpenElement(13, "div");
            builder.AddAttribute(14, "style", "position: absolute; top: 2px; left: 2px; font-size: 12px; color: #f44336; background: rgba(255,255,255,0.8); border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-weight: bold;");
            builder.AddContent(15, _restrictionHelper.GetRestrictionIcon(false));
            builder.CloseElement();
        }

        builder.CloseElement();
    };

    /// <summary>è·å–å±æ€§å€¼</summary>
    private string GetStatValue(string statId)
    {
        if (TotalStats.TryGetValue(statId, out var value))
        {
            return value > 0 ? $"+{value:F0}" : "0";
        }
        return "0";
    }

    /// <summary>è·å–ç™¾åˆ†æ¯”å±æ€§å€¼</summary>
    private string GetStatPercent(string statId)
    {
        if (TotalStats.TryGetValue(statId, out var value))
        {
            return value > 0 ? $"+{value * 100:F1}%" : "0%";
        }
        return "0%";
    }

    /// <summary>è·å–å“è´¨é¢œè‰²</summary>
    private string GetRarityColor(string rarity)
    {
        return rarity switch
        {
            "Common" => "#9e9e9e",
            "Rare" => "#2196f3",
            "Epic" => "#9c27b0",
            "Legendary" => "#ff9800",
            _ => "#9e9e9e"
        };
    }

    /// <summary>è·å–å“è´¨æ–‡æœ¬</summary>
    private string GetRarityText(string rarity)
    {
        return rarity switch
        {
            "Common" => "æ™®é€š",
            "Rare" => "ç¨€æœ‰",
            "Epic" => "å²è¯—",
            "Legendary" => "ä¼ è¯´",
            _ => "æœªçŸ¥"
        };
    }

    /// <summary>è·å–è£…å¤‡æç¤ºä¿¡æ¯</summary>
    private string GetItemTooltip(GearInstanceDto item)
    {
        var tooltip = $"{item.Name}\n";
        tooltip += $"å“è´¨: {GetRarityText(item.Rarity)} (T{item.Tier})\n";
        tooltip += $"ç‰©å“ç­‰çº§: {item.ItemLevel}\n";
        tooltip += $"è£…å¤‡è¯„åˆ†: {item.QualityScore}\n";
        
        // æ˜¾ç¤ºæŠ¤ç”²ç±»å‹ï¼ˆå¦‚æœæœ‰ï¼‰
        if (!string.IsNullOrEmpty(item.ArmorType) && item.ArmorType != "None")
        {
            tooltip += $"æŠ¤ç”²ç±»å‹: {GetArmorTypeName(item.ArmorType)}\n";
        }
        
        // æ˜¾ç¤ºæ­¦å™¨ç±»å‹å’Œæ”»å‡»é€Ÿåº¦ï¼ˆå¦‚æœæœ‰ï¼‰
        if (!string.IsNullOrEmpty(item.WeaponType) && item.WeaponType != "None")
        {
            tooltip += $"æ­¦å™¨ç±»å‹: {GetWeaponTypeName(item.WeaponType)}\n";
            
            // è®¡ç®—è¯¥æ­¦å™¨çš„æ”»å‡»é€Ÿåº¦
            if (_dpsCalculator != null)
            {
                var testStats = new Dictionary<string, double>(TotalStats);
                var dpsResult = _dpsCalculator.CalculateDps(testStats, item.WeaponType);
                if (dpsResult.AttackInterval > 0)
                {
                    var attackSpeed = 1.0 / dpsResult.AttackInterval;
                    tooltip += $"æ”»å‡»é€Ÿåº¦: {attackSpeed:F2}/ç§’ ({dpsResult.AttackInterval:F2}ç§’é—´éš”)\n";
                }
            }
        }
        
        // æ£€æŸ¥èŒä¸šå’Œç­‰çº§é™åˆ¶ï¼ˆå¦‚æœæœ‰é™åˆ¶è¾…åŠ©æœåŠ¡ï¼‰
        if (_restrictionHelper != null)
        {
            var restriction = _restrictionHelper.CheckRestrictions(item, CharacterProfession, CharacterLevel);
            if (!restriction.CanEquip)
            {
                tooltip += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
                tooltip += _restrictionHelper.GenerateRestrictionTooltip(restriction) + "\n";
            }
        }
        
        if (item.Stats.Count > 0)
        {
            tooltip += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nè£…å¤‡å±æ€§:\n";
            foreach (var stat in item.Stats.OrderByDescending(s => Math.Abs(s.Value)))
            {
                var displayValue = IsPercentageStat(stat.Key) 
                    ? $"+{stat.Value * 100:F1}%" 
                    : $"+{stat.Value:F0}";
                tooltip += $"  {GetStatDisplayName(stat.Key)}: {displayValue}\n";
            }
        }
        
        if (item.Affixes.Count > 0)
        {
            tooltip += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nç‰¹æ®Šè¯æ¡:\n";
            foreach (var affix in item.Affixes)
            {
                tooltip += $"  â€¢ {affix.DisplayText}\n";
            }
        }
        
        // å¦‚æœæ˜¯æ­¦å™¨ï¼Œæ˜¾ç¤ºé¢„ä¼°å•ä»¶DPS
        if (!string.IsNullOrEmpty(item.WeaponType) && item.WeaponType != "None" && _dpsCalculator != null)
        {
            var testStats = new Dictionary<string, double>(TotalStats);
            foreach (var (key, value) in item.Stats)
            {
                testStats[key] = testStats.GetValueOrDefault(key, 0) + value;
            }
            var dpsResult = _dpsCalculator.CalculateDps(testStats, item.WeaponType);
            if (dpsResult.TotalDps > 0)
            {
                tooltip += $"\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš”ï¸ è£…å¤‡æ­¤æ­¦å™¨DPS: {_dpsCalculator.FormatDps(dpsResult.TotalDps)}\n";
            }
        }
        
        return tooltip;
    }
    
    /// <summary>è·å–æŠ¤ç”²ç±»å‹æ˜¾ç¤ºåç§°</summary>
    private string GetArmorTypeName(string armorType)
    {
        return armorType switch
        {
            "Cloth" => "å¸ƒç”²",
            "Leather" => "çš®ç”²",
            "Mail" => "é”ç”²",
            "Plate" => "æ¿ç”²",
            _ => armorType
        };
    }
    
    /// <summary>è·å–æ­¦å™¨ç±»å‹æ˜¾ç¤ºåç§°</summary>
    private string GetWeaponTypeName(string weaponType)
    {
        return weaponType switch
        {
            "Sword" => "å•æ‰‹å‰‘",
            "Dagger" => "åŒ•é¦–",
            "Axe" => "å•æ‰‹æ–§",
            "Mace" => "å•æ‰‹é”¤",
            "Fist" => "æ‹³å¥—",
            "Wand" => "é­”æ–",
            "TwoHandSword" => "åŒæ‰‹å‰‘",
            "TwoHandAxe" => "åŒæ‰‹æ–§",
            "TwoHandMace" => "åŒæ‰‹é”¤",
            "Staff" => "æ³•æ–",
            "Polearm" => "é•¿æŸ„æ­¦å™¨",
            "Bow" => "å¼“",
            "Crossbow" => "å¼©",
            "Gun" => "æªæ¢°",
            "Shield" => "ç›¾ç‰Œ",
            _ => weaponType
        };
    }
    
    /// <summary>è·å–å±æ€§æ˜¾ç¤ºåç§°</summary>
    private string GetStatDisplayName(string statId)
    {
        return statId switch
        {
            "AttackPower" => "æ”»å‡»åŠ›",
            "SpellPower" => "æ³•æœ¯å¼ºåº¦",
            "Armor" => "æŠ¤ç”²",
            "CritChance" => "æš´å‡»ç‡",
            "CritRating" => "æš´å‡»ç­‰çº§",
            "HastePercent" => "æ€¥é€Ÿ",
            "Haste" => "æ€¥é€Ÿç­‰çº§",
            "Strength" => "åŠ›é‡",
            "Agility" => "æ•æ·",
            "Intellect" => "æ™ºåŠ›",
            "Stamina" => "è€åŠ›",
            "BlockChance" => "æ ¼æŒ¡ç‡",
            _ => statId
        };
    }
    
    /// <summary>åˆ¤æ–­æ˜¯å¦ä¸ºç™¾åˆ†æ¯”å±æ€§</summary>
    private bool IsPercentageStat(string statId)
    {
        return statId switch
        {
            "CritChance" or "HastePercent" or "BlockChance" => true,
            _ => false
        };
    }
    
    /// <summary>
    /// è·å–è£…å¤‡å¯¹æ¯”æç¤ºä¿¡æ¯ï¼ˆå¢å¼ºç‰ˆï¼Œæ˜¾ç¤ºä¸å½“å‰è£…å¤‡çš„å·®å¼‚ï¼‰
    /// </summary>
    /// <param name="item">è£…å¤‡å®ä¾‹</param>
    /// <param name="slotType">æ§½ä½ç±»å‹ï¼Œç”¨äºæŸ¥æ‰¾å½“å‰è£…å¤‡</param>
    /// <returns>å¸¦å¯¹æ¯”ä¿¡æ¯çš„Tooltip</returns>
    private string GetItemTooltipWithComparison(GearInstanceDto item, string slotType)
    {
        var tooltip = GetItemTooltip(item);
        
        // å¦‚æœæ²¡æœ‰å¯¹æ¯”æœåŠ¡ï¼Œè¿”å›åŸºç¡€tooltip
        if (_comparisonService == null)
        {
            return tooltip;
        }
        
        // æŸ¥æ‰¾å½“å‰æ§½ä½çš„è£…å¤‡
        var currentSlot = Slots.FirstOrDefault(s => s.SlotType == slotType);
        var currentItem = currentSlot?.Item;
        
        // å¦‚æœå½“å‰æ§½ä½æ²¡æœ‰è£…å¤‡ï¼Œæˆ–è€…å°±æ˜¯åŒä¸€ä»¶è£…å¤‡ï¼Œä¸æ˜¾ç¤ºå¯¹æ¯”
        if (currentItem == null || currentItem.Id == item.Id)
        {
            return tooltip;
        }
        
        // è¿›è¡Œå¯¹æ¯”ï¼ˆä¼ å…¥å…¨éƒ¨å±æ€§ä»¥ä¾¿è®¡ç®—DPSï¼‰
        var comparison = _comparisonService.Compare(currentItem, item, TotalStats);
        
        // æ·»åŠ å¯¹æ¯”ä¿¡æ¯
        tooltip += "\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
        tooltip += $"ğŸ“Š ä¸å½“å‰è£…å¤‡å¯¹æ¯”:\n";
        tooltip += $"è¯„åˆ†: {(comparison.QualityScoreDifference >= 0 ? "+" : "")}{comparison.QualityScoreDifference}\n";
        tooltip += $"ç‰©å“ç­‰çº§: {(comparison.ItemLevelDifference >= 0 ? "+" : "")}{comparison.ItemLevelDifference}\n";
        
        if (comparison.StatDifferences.Count > 0)
        {
            tooltip += "\nå±æ€§å˜åŒ–:\n";
            foreach (var (statId, difference) in comparison.StatDifferences.OrderByDescending(x => Math.Abs(x.Value)))
            {
                var arrow = difference > 0 ? "â†‘" : "â†“";
                var displayValue = _comparisonService.GetDifferenceDisplayText(statId, difference, false);
                var statName = _comparisonService.GetStatDisplayName(statId);
                tooltip += $"  {arrow} {statName}: {displayValue}\n";
            }
        }
        
        // å¦‚æœæ˜¯æ­¦å™¨ï¼Œæ˜¾ç¤ºDPSå˜åŒ–
        if (comparison.HasWeaponChange && _dpsCalculator != null)
        {
            tooltip += $"\nâš”ï¸ DPSå˜åŒ–: {_dpsCalculator.FormatDpsDifference(comparison.DpsDifference, true, GetEstimatedDps())}\n";
        }
        
        tooltip += $"\næ€»ä½“è¯„ä¼°: {(comparison.IsUpgrade ? "âœ“ å‡çº§" : "âœ— é™çº§")}";
        
        return tooltip;
    }
    
    /// <summary>
    /// è®¡ç®—é¢„ä¼°DPS
    /// </summary>
    private double GetEstimatedDps()
    {
        if (_dpsCalculator == null || TotalStats == null || TotalStats.Count == 0)
        {
            return 0;
        }
        
        var dpsResult = _dpsCalculator.CalculateDps(TotalStats, WeaponInfo);
        return dpsResult.TotalDps;
    }
    
    /// <summary>
    /// è·å–æ ¼å¼åŒ–çš„DPSæ˜¾ç¤º
    /// </summary>
    private string GetFormattedDps()
    {
        if (_dpsCalculator == null)
        {
            return "0";
        }
        
        var dps = GetEstimatedDps();
        return _dpsCalculator.FormatDps(dps);
    }
    
    /// <summary>
    /// è·å–æ”»å‡»é€Ÿåº¦ï¼ˆæ¯ç§’æ”»å‡»æ¬¡æ•°ï¼‰
    /// </summary>
    private double GetAttackSpeed()
    {
        if (_dpsCalculator == null || TotalStats == null || TotalStats.Count == 0)
        {
            return 0;
        }
        
        var dpsResult = _dpsCalculator.CalculateDps(TotalStats, WeaponInfo);
        if (dpsResult.AttackInterval > 0)
        {
            return 1.0 / dpsResult.AttackInterval;
        }
        
        return 0;
    }
    
    /// <summary>
    /// è·å–æ”»å‡»é€Ÿåº¦æ˜¾ç¤º
    /// </summary>
    private string GetAttackSpeedDisplay()
    {
        var attackSpeed = GetAttackSpeed();
        if (attackSpeed > 0)
        {
            return $"{attackSpeed:F2}/ç§’";
        }
        return "0/ç§’";
    }
    
    /// <summary>
    /// è·å–ç™¾åˆ†æ¯”å±æ€§å€¼æ˜¾ç¤ºï¼ˆå¢å¼ºç‰ˆï¼ŒåŒ…å«é¢å¤–ä¿¡æ¯ï¼‰
    /// </summary>
    private string GetStatPercentDisplay(string statId)
    {
        if (TotalStats.TryGetValue(statId, out var value))
        {
            if (value <= 0)
            {
                return "0%";
            }
            
            var percentText = $"+{value * 100:F1}%";
            
            // å¦‚æœæ˜¯æ ¼æŒ¡ç‡ï¼Œæ·»åŠ å‡ä¼¤è¯´æ˜
            if (statId == "BlockChance" && value > 0)
            {
                // æ ¼æŒ¡å‡ä¼¤30%
                var blockReduction = 30.0;
                var effectiveReduction = value * blockReduction;
                percentText += $" (å‡ä¼¤{effectiveReduction:F1}%)";
            }
            
            return percentText;
        }
        return "0%";
    }
}
