@using BlazorIdle.Client.Services

@* è£…å¤‡é¢æ¿ç»„ä»¶ - Step 5: è£…å¤‡ç³»ç»ŸUIé¢„ç•™ *@
<div class="equipment-panel" style="margin-top: 16px; padding: 16px; background: @BackgroundColor; border-radius: 4px; border: 1px solid @BorderColor;">
    <h6 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold;">ğŸ’ @Title</h6>
    
    @if (IsLoading)
    {
        <div style="text-align: center; padding: 20px; color: #999;">
            <em>åŠ è½½ä¸­...</em>
        </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div style="padding: 12px; background: #ffebee; border: 1px solid #ef5350; border-radius: 4px; color: #c62828;">
            âš ï¸ @ErrorMessage
        </div>
    }
    else
    {
        @* è£…å¤‡æ§½å¸ƒå±€ - Phase 6: æ‰©å±•ä¸º17ä¸ªæ§½ä½ *@
        <div class="equipment-slots" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 16px;">
            @* ç¬¬ä¸€è¡Œï¼šé¡¹é“¾ - å¤´ç›” - æŠ¤è‚© *@
            @RenderSlot("Neck", "é¡¹é“¾", "ğŸ“¿")
            @RenderSlot("Head", "å¤´ç›”", "ğŸª–")
            @RenderSlot("Shoulder", "æŠ¤è‚©", "ğŸ½")

            @* ç¬¬äºŒè¡Œï¼šä¸»æ‰‹ - èƒ¸ç”² - å‰¯æ‰‹/åŒæ‰‹ *@
            @RenderSlot("MainHand", "ä¸»æ‰‹", "âš”ï¸")
            @RenderSlot("Chest", "èƒ¸ç”²", "ğŸ›¡ï¸")
            @RenderSlotWithDualMode("OffHand", "TwoHand", "å‰¯æ‰‹/åŒæ‰‹", "ğŸ”°", "âš”ï¸")

            @* ç¬¬ä¸‰è¡Œï¼šæŠ¤è…• - è…°å¸¦ - æ‰‹å¥— *@
            @RenderSlot("Wrist", "æŠ¤è…•", "âŒš")
            @RenderSlot("Waist", "è…°å¸¦", "ğŸ—ï¸")
            @RenderSlot("Hands", "æ‰‹å¥—", "ğŸ§¤")

            @* ç¬¬å››è¡Œï¼šæˆ’æŒ‡1 - æŠ¤è…¿ - æˆ’æŒ‡2 *@
            @RenderSlot("Finger1", "æˆ’æŒ‡1", "ğŸ’")
            @RenderSlot("Legs", "æŠ¤è…¿", "ğŸ¦µ")
            @RenderSlot("Finger2", "æˆ’æŒ‡2", "ğŸ’")

            @* ç¬¬äº”è¡Œï¼šé¥°å“1 - é‹å­ - é¥°å“2 *@
            @RenderSlot("Trinket1", "é¥°å“1", "ğŸ”®")
            @RenderSlot("Feet", "é‹å­", "ğŸ‘¢")
            @RenderSlot("Trinket2", "é¥°å“2", "ğŸ”®")

            @* ç¬¬å…­è¡Œï¼šç©º - æŠ«é£ - ç©º *@
            <div></div>
            @RenderSlot("Back", "æŠ«é£", "ğŸ§¥")
            <div></div>
        </div>

        @* æ€»å±æ€§é¢æ¿ - Phase 6: å¢å¼ºæ˜¾ç¤º *@
        <div class="equipment-stats" style="padding: 12px; background: #f5f5f5; border-radius: 4px; border: 1px solid #e0e0e0;">
            <div style="font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #555;">ğŸ“Š è£…å¤‡æ€»å±æ€§</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>âš”ï¸ æ”»å‡»åŠ›:</span>
                    <span style="font-weight: bold; color: #d32f2f;">@GetStatValue("AttackPower")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ”® æ³•æœ¯å¼ºåº¦:</span>
                    <span style="font-weight: bold; color: #9c27b0;">@GetStatValue("SpellPower")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ›¡ï¸ æŠ¤ç”²:</span>
                    <span style="font-weight: bold; color: #1976d2;">@GetStatValue("Armor")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ’ª åŠ›é‡:</span>
                    <span style="font-weight: bold; color: #e65100;">@GetStatValue("Strength")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸƒ æ•æ·:</span>
                    <span style="font-weight: bold; color: #558b2f;">@GetStatValue("Agility")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ§  æ™ºåŠ›:</span>
                    <span style="font-weight: bold; color: #283593;">@GetStatValue("Intellect")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>â¤ï¸ è€åŠ›:</span>
                    <span style="font-weight: bold; color: #c62828;">@GetStatValue("Stamina")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>âš¡ æ€¥é€Ÿ:</span>
                    <span style="font-weight: bold; color: #f57c00;">@GetStatPercent("HastePercent")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ’¥ æš´å‡»:</span>
                    <span style="font-weight: bold; color: #7b1fa2;">@GetStatPercent("CritChance")</span>
                </div>
            </div>
        </div>
    }
</div>

@code {
    /// <summary>è§’è‰²ID</summary>
    [Parameter] public Guid CharacterId { get; set; }
    
    /// <summary>æ ‡é¢˜</summary>
    [Parameter] public string Title { get; set; } = "è£…å¤‡ä¸å±æ€§";
    
    /// <summary>èƒŒæ™¯é¢œè‰²</summary>
    [Parameter] public string BackgroundColor { get; set; } = "#fff8e1";
    
    /// <summary>è¾¹æ¡†é¢œè‰²</summary>
    [Parameter] public string BorderColor { get; set; } = "#ffb74d";
    
    /// <summary>æ˜¯å¦æ­£åœ¨åŠ è½½</summary>
    [Parameter] public bool IsLoading { get; set; }
    
    /// <summary>é”™è¯¯æ¶ˆæ¯</summary>
    [Parameter] public string ErrorMessage { get; set; } = "";
    
    /// <summary>è£…å¤‡æ§½åˆ—è¡¨</summary>
    [Parameter] public List<EquipmentSlotDto> Slots { get; set; } = new();
    
    /// <summary>æ€»å±æ€§</summary>
    [Parameter] public Dictionary<string, double> TotalStats { get; set; } = new();

    /// <summary>æ¸²æŸ“å•ä¸ªè£…å¤‡æ§½</summary>
    private RenderFragment RenderSlot(string slotType, string slotName, string defaultIcon) => builder =>
    {
        var slot = Slots.FirstOrDefault(s => s.SlotType == slotType);
        var hasItem = slot?.Item != null;
        var bgColor = hasItem ? "#e8f5e9" : "#fafafa";
        var borderColor = hasItem ? "#66bb6a" : "#e0e0e0";
        var icon = hasItem ? (slot!.Item!.Icon ?? defaultIcon) : defaultIcon;
        var itemName = hasItem ? slot!.Item!.Name : slotName;
        var opacity = hasItem ? "1.0" : "0.4";

        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "equipment-slot");
        builder.AddAttribute(2, "style", $"position: relative; padding: 8px; background: {bgColor}; border: 2px solid {borderColor}; border-radius: 6px; text-align: center; cursor: pointer; opacity: {opacity}; min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center;");
        builder.AddAttribute(3, "title", hasItem ? GetItemTooltip(slot!.Item!) : $"ç©º - {slotName}");

        // å›¾æ ‡
        builder.OpenElement(4, "div");
        builder.AddAttribute(5, "style", "font-size: 24px; margin-bottom: 2px;");
        builder.AddContent(6, icon);
        builder.CloseElement();

        // åç§°
        builder.OpenElement(7, "div");
        builder.AddAttribute(8, "style", "font-size: 9px; color: #555; font-weight: bold; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;");
        builder.AddContent(9, itemName);
        builder.CloseElement();

        // å“è´¨æ ‡ç­¾ï¼ˆå¦‚æœæœ‰è£…å¤‡ï¼‰
        if (hasItem)
        {
            var rarityColor = GetRarityColor(slot!.Item!.Rarity);
            builder.OpenElement(10, "div");
            builder.AddAttribute(11, "style", $"position: absolute; top: 2px; right: 2px; font-size: 8px; padding: 1px 4px; background: {rarityColor}; color: white; border-radius: 2px; font-weight: bold;");
            builder.AddContent(12, GetRarityText(slot!.Item!.Rarity));
            builder.CloseElement();
        }

        builder.CloseElement();
    };

    /// <summary>æ¸²æŸ“åŒæ¨¡å¼æ§½ä½ï¼ˆå‰¯æ‰‹/åŒæ‰‹æ­¦å™¨ï¼‰</summary>
    private RenderFragment RenderSlotWithDualMode(string slotType1, string slotType2, string slotName, string defaultIcon1, string defaultIcon2) => builder =>
    {
        // ä¼˜å…ˆæ£€æŸ¥åŒæ‰‹æ­¦å™¨
        var twoHandSlot = Slots.FirstOrDefault(s => s.SlotType == slotType2);
        var offHandSlot = Slots.FirstOrDefault(s => s.SlotType == slotType1);
        
        // å¦‚æœè£…å¤‡äº†åŒæ‰‹æ­¦å™¨ï¼Œæ˜¾ç¤ºåŒæ‰‹æ­¦å™¨
        if (twoHandSlot?.Item != null)
        {
            var slot = twoHandSlot;
            var bgColor = "#ffe8e8"; // åŒæ‰‹æ­¦å™¨ç‰¹æ®ŠèƒŒæ™¯è‰²
            var borderColor = "#ff5252";
            var icon = slot.Item!.Icon ?? defaultIcon2;
            var itemName = slot.Item!.Name;

            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "equipment-slot");
            builder.AddAttribute(2, "style", $"position: relative; padding: 8px; background: {bgColor}; border: 2px solid {borderColor}; border-radius: 6px; text-align: center; cursor: pointer; min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center;");
            builder.AddAttribute(3, "title", GetItemTooltip(slot.Item!) + "\n(åŒæ‰‹æ­¦å™¨å ç”¨å‰¯æ‰‹ä½)");

            builder.OpenElement(4, "div");
            builder.AddAttribute(5, "style", "font-size: 24px; margin-bottom: 2px;");
            builder.AddContent(6, icon);
            builder.CloseElement();

            builder.OpenElement(7, "div");
            builder.AddAttribute(8, "style", "font-size: 9px; color: #555; font-weight: bold; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;");
            builder.AddContent(9, itemName);
            builder.CloseElement();

            var rarityColor = GetRarityColor(slot.Item!.Rarity);
            builder.OpenElement(10, "div");
            builder.AddAttribute(11, "style", $"position: absolute; top: 2px; right: 2px; font-size: 8px; padding: 1px 4px; background: {rarityColor}; color: white; border-radius: 2px; font-weight: bold;");
            builder.AddContent(12, GetRarityText(slot.Item!.Rarity));
            builder.CloseElement();

            builder.CloseElement();
        }
        // å¦åˆ™æ˜¾ç¤ºå‰¯æ‰‹æ§½ä½
        else
        {
            var slot = offHandSlot;
            var hasItem = slot?.Item != null;
            var bgColor = hasItem ? "#e8f5e9" : "#fafafa";
            var borderColor = hasItem ? "#66bb6a" : "#e0e0e0";
            var icon = hasItem ? (slot!.Item!.Icon ?? defaultIcon1) : defaultIcon1;
            var itemName = hasItem ? slot!.Item!.Name : "å‰¯æ‰‹";
            var opacity = hasItem ? "1.0" : "0.4";

            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "equipment-slot");
            builder.AddAttribute(2, "style", $"position: relative; padding: 8px; background: {bgColor}; border: 2px solid {borderColor}; border-radius: 6px; text-align: center; cursor: pointer; opacity: {opacity}; min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center;");
            builder.AddAttribute(3, "title", hasItem ? GetItemTooltip(slot!.Item!) : "ç©º - å‰¯æ‰‹");

            builder.OpenElement(4, "div");
            builder.AddAttribute(5, "style", "font-size: 24px; margin-bottom: 2px;");
            builder.AddContent(6, icon);
            builder.CloseElement();

            builder.OpenElement(7, "div");
            builder.AddAttribute(8, "style", "font-size: 9px; color: #555; font-weight: bold; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;");
            builder.AddContent(9, itemName);
            builder.CloseElement();

            if (hasItem)
            {
                var rarityColor = GetRarityColor(slot!.Item!.Rarity);
                builder.OpenElement(10, "div");
                builder.AddAttribute(11, "style", $"position: absolute; top: 2px; right: 2px; font-size: 8px; padding: 1px 4px; background: {rarityColor}; color: white; border-radius: 2px; font-weight: bold;");
                builder.AddContent(12, GetRarityText(slot!.Item!.Rarity));
                builder.CloseElement();
            }

            builder.CloseElement();
        }
    };

    /// <summary>è·å–å±æ€§å€¼</summary>
    private string GetStatValue(string statId)
    {
        if (TotalStats.TryGetValue(statId, out var value))
        {
            return value > 0 ? $"+{value:F0}" : "0";
        }
        return "0";
    }

    /// <summary>è·å–ç™¾åˆ†æ¯”å±æ€§å€¼</summary>
    private string GetStatPercent(string statId)
    {
        if (TotalStats.TryGetValue(statId, out var value))
        {
            return value > 0 ? $"+{value * 100:F1}%" : "0%";
        }
        return "0%";
    }

    /// <summary>è·å–å“è´¨é¢œè‰²</summary>
    private string GetRarityColor(string rarity)
    {
        return rarity switch
        {
            "Common" => "#9e9e9e",
            "Rare" => "#2196f3",
            "Epic" => "#9c27b0",
            "Legendary" => "#ff9800",
            _ => "#9e9e9e"
        };
    }

    /// <summary>è·å–å“è´¨æ–‡æœ¬</summary>
    private string GetRarityText(string rarity)
    {
        return rarity switch
        {
            "Common" => "æ™®é€š",
            "Rare" => "ç¨€æœ‰",
            "Epic" => "å²è¯—",
            "Legendary" => "ä¼ è¯´",
            _ => "æœªçŸ¥"
        };
    }

    /// <summary>è·å–è£…å¤‡æç¤ºä¿¡æ¯</summary>
    private string GetItemTooltip(GearInstanceDto item)
    {
        var tooltip = $"{item.Name}\n";
        tooltip += $"å“è´¨: {GetRarityText(item.Rarity)} (T{item.Tier})\n";
        tooltip += $"ç‰©å“ç­‰çº§: {item.ItemLevel}\n";
        
        // Phase 6: æ˜¾ç¤ºæŠ¤ç”²ç±»å‹
        if (!string.IsNullOrEmpty(item.ArmorType) && item.ArmorType != "None")
        {
            tooltip += $"æŠ¤ç”²ç±»å‹: {GetArmorTypeText(item.ArmorType)}\n";
        }
        
        // Phase 6: æ˜¾ç¤ºæ­¦å™¨ç±»å‹å’Œæ”»å‡»é€Ÿåº¦
        if (!string.IsNullOrEmpty(item.WeaponType) && item.WeaponType != "None")
        {
            tooltip += $"æ­¦å™¨ç±»å‹: {GetWeaponTypeText(item.WeaponType)}\n";
            if (item.AttackSpeed.HasValue)
            {
                tooltip += $"æ”»å‡»é€Ÿåº¦: {item.AttackSpeed.Value:F1}ç§’\n";
            }
        }
        
        // Phase 6: æ˜¾ç¤ºç­‰çº§éœ€æ±‚
        if (item.RequiredLevel > 1)
        {
            tooltip += $"éœ€è¦ç­‰çº§: {item.RequiredLevel}\n";
        }
        
        tooltip += $"è£…å¤‡è¯„åˆ†: {item.QualityScore}\n";
        
        if (item.Stats.Count > 0)
        {
            tooltip += "\nå±æ€§:\n";
            foreach (var stat in item.Stats)
            {
                tooltip += $"  {stat.Key}: +{stat.Value:F0}\n";
            }
        }
        
        if (item.Affixes.Count > 0)
        {
            tooltip += "\nè¯æ¡:\n";
            foreach (var affix in item.Affixes)
            {
                tooltip += $"  {affix.DisplayText}\n";
            }
        }
        
        if (!string.IsNullOrEmpty(item.SetId))
        {
            tooltip += $"\nå¥—è£…: {item.SetId}\n";
        }
        
        return tooltip;
    }

    /// <summary>è·å–æŠ¤ç”²ç±»å‹æ–‡æœ¬</summary>
    private string GetArmorTypeText(string armorType)
    {
        return armorType switch
        {
            "Cloth" => "å¸ƒç”²",
            "Leather" => "çš®ç”²",
            "Mail" => "é”ç”²",
            "Plate" => "æ¿ç”²",
            "None" => "æ— æŠ¤ç”²",
            _ => armorType
        };
    }

    /// <summary>è·å–æ­¦å™¨ç±»å‹æ–‡æœ¬</summary>
    private string GetWeaponTypeText(string weaponType)
    {
        return weaponType switch
        {
            "Sword" => "å•æ‰‹å‰‘",
            "Axe" => "å•æ‰‹æ–§",
            "Mace" => "å•æ‰‹é”¤",
            "Dagger" => "åŒ•é¦–",
            "Fist" => "æ‹³å¥—",
            "Wand" => "é­”æ–",
            "Staff" => "æ³•æ–",
            "TwoHandSword" => "åŒæ‰‹å‰‘",
            "TwoHandAxe" => "åŒæ‰‹æ–§",
            "TwoHandMace" => "åŒæ‰‹é”¤",
            "Polearm" => "é•¿æŸ„æ­¦å™¨",
            "Bow" => "å¼“",
            "Crossbow" => "å¼©",
            "Gun" => "æªæ¢°",
            "Shield" => "ç›¾ç‰Œ",
            "None" => "æ— ",
            _ => weaponType
        };
    }
}
