@using BlazorIdle.Client.Services

@* æŠ€èƒ½çŠ¶æ€æ é¢æ¿ç»„ä»¶ - Step 4: æŠ€èƒ½ç³»ç»ŸUI *@
@if (Skills != null && Skills.Count > 0)
{
    <div class="skill-status-panel" style="margin-top: 12px; padding: 8px; background: @BackgroundColor; border-radius: 4px; border: 1px solid @BorderColor;">
        <h6 style="margin: 0 0 8px 0; font-size: 13px;">@Title</h6>
        <div class="skill-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
            @foreach (var skill in Skills)
            {
                var slotBg = skill.IsReady ? "#e8f5e9" : "#f5f5f5";
                var slotBorder = skill.IsReady ? "#66bb6a" : "#bdbdbd";
                var iconOpacity = skill.IsReady ? "1.0" : "0.5";
                
                <div class="skill-slot" 
                     style="position: relative; width: 60px; height: 70px; background: @slotBg; border: 2px solid @slotBorder; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: help; opacity: @iconOpacity;"
                     title="@GetSkillTooltip(skill)">
                    
                    @* æ§½ä½ç¼–å· *@
                    <div style="position: absolute; top: 2px; left: 4px; font-size: 10px; font-weight: bold; color: #666; background: rgba(255,255,255,0.7); padding: 1px 4px; border-radius: 2px;">
                        @skill.SlotIndex
                    </div>
                    
                    @* æŠ€èƒ½å›¾æ ‡ *@
                    <div style="font-size: 24px; margin-bottom: 4px;">@GetSkillIcon(skill.Id)</div>
                    
                    @* æŠ€èƒ½åç§°ï¼ˆç¼©å†™ï¼‰ *@
                    <div style="font-size: 9px; font-weight: bold; color: #333; text-align: center; max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        @GetSkillShortName(skill.Name)
                    </div>
                    
                    @* å†·å´å€’è®¡æ—¶ *@
                    @if (!skill.IsReady && skill.CooldownRemaining > 0)
                    {
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">
                            @FormatCooldown(skill.CooldownRemaining)
                        </div>
                    }
                    
                    @* å……èƒ½å±‚æ•°æ˜¾ç¤º *@
                    @if (skill.MaxCharges > 1)
                    {
                        <div style="position: absolute; bottom: 2px; right: 3px; font-size: 10px; font-weight: bold; color: #333; background: rgba(255,255,255,0.9); padding: 1px 4px; border-radius: 2px;">
                            @skill.CurrentCharges/@skill.MaxCharges
                        </div>
                    }
                    
                    @* å°±ç»ªæŒ‡ç¤ºå™¨ *@
                    @if (skill.IsReady)
                    {
                        <div style="position: absolute; top: 2px; right: 3px; font-size: 14px;">âœ“</div>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    /// <summary>æŠ€èƒ½åˆ—è¡¨</summary>
    [Parameter] public List<SkillStatusDto> Skills { get; set; } = new();
    
    /// <summary>æ ‡é¢˜</summary>
    [Parameter] public string Title { get; set; } = "âš”ï¸ æŠ€èƒ½çŠ¶æ€";
    
    /// <summary>èƒŒæ™¯é¢œè‰²</summary>
    [Parameter] public string BackgroundColor { get; set; } = "#fff3e0";
    
    /// <summary>è¾¹æ¡†é¢œè‰²</summary>
    [Parameter] public string BorderColor { get; set; } = "#ffb74d";
    
    /// <summary>è·å–æŠ€èƒ½å›¾æ ‡ï¼ˆä½¿ç”¨emojiï¼‰</summary>
    private string GetSkillIcon(string skillId)
    {
        return skillId.ToLowerInvariant() switch
        {
            // æˆ˜å£«æŠ€èƒ½
            "heroic_strike" => "ğŸ—¡ï¸",
            "shield_wall" => "ğŸ›¡ï¸",
            "charge" => "âš¡",
            "execute" => "ğŸ’¥",
            "whirlwind" => "ğŸŒ€",
            
            // æ¸¸ä¾ æŠ€èƒ½
            "aimed_shot" => "ğŸ¯",
            "multi_shot" => "ğŸ¹",
            "rapid_fire" => "ğŸ’¨",
            "serpent_sting" => "ğŸ",
            "arcane_shot" => "âœ¨",
            
            // é»˜è®¤å›¾æ ‡
            _ => "âš”ï¸"
        };
    }
    
    /// <summary>è·å–æŠ€èƒ½ç¼©å†™åç§°</summary>
    private string GetSkillShortName(string fullName)
    {
        // å¦‚æœåç§°å¤ªé•¿ï¼Œåªæ˜¾ç¤ºå‰å‡ ä¸ªå­—
        if (fullName.Length > 8)
            return fullName.Substring(0, 7) + "..";
        return fullName;
    }
    
    /// <summary>æ ¼å¼åŒ–å†·å´æ—¶é—´</summary>
    private string FormatCooldown(double seconds)
    {
        if (seconds < 1)
            return $"{seconds:0.0}";
        else if (seconds < 10)
            return $"{(int)Math.Ceiling(seconds)}";
        else if (seconds < 60)
            return $"{(int)seconds}";
        else
            return $"{(int)(seconds / 60)}m";
    }
    
    /// <summary>è·å–æŠ€èƒ½æç¤ºæ–‡æœ¬</summary>
    private string GetSkillTooltip(SkillStatusDto skill)
    {
        var tooltip = $"{skill.Name}\n";
        tooltip += $"æ§½ä½: {skill.SlotIndex} | ä¼˜å…ˆçº§: {skill.Priority}\n";
        
        if (skill.CostResourceId != null && skill.CostAmount > 0)
            tooltip += $"æ¶ˆè€—: {skill.CostAmount} {skill.CostResourceId}\n";
        
        tooltip += $"ä¼¤å®³: {skill.BaseDamage}\n";
        
        if (skill.MaxCharges > 1)
            tooltip += $"å……èƒ½: {skill.CurrentCharges}/{skill.MaxCharges}\n";
        
        if (skill.IsReady)
            tooltip += "çŠ¶æ€: å°±ç»ª âœ“";
        else
            tooltip += $"å†·å´: {skill.CooldownRemaining:0.0}ç§’";
        
        return tooltip;
    }
}
