@using BlazorIdle.Client.Services
@using BlazorIdle.Shared.Models

@* ç©å®¶çŠ¶æ€é¢æ¿ç»„ä»¶ *@
<div class="player-status-panel">
    <h6>ğŸ‘¤ ç©å®¶çŠ¶æ€</h6>
    
    <!-- èŒä¸šå’Œç­‰çº§ -->
    <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 20px;">@GetProfessionIcon(Profession)</span>
        <span><b>@CharacterName</b></span>
        @if (BattleDurationSeconds.HasValue)
        {
            <span style="margin-left: auto; color: #666; font-size: 12px;">
                â±ï¸ @FormatDuration(BattleDurationSeconds.Value)
            </span>
        }
    </div>
    
    <!-- è¡€é‡æ¡ -->
    <div style="margin-bottom: 12px;">
        <div style="display: flex; align-items: center; margin-bottom: 4px;">
            <span style="min-width: 60px; font-size: 13px;"><b>HP:</b></span>
            <div style="flex: 1; background: #e0e0e0; height: 24px; border-radius: 4px; overflow: hidden; position: relative;">
                <div style="background: linear-gradient(90deg, #4caf50, #81c784); height: 100%; width: @(HpPercent * 100)%; transition: width 0.12s linear;"></div>
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: #000; font-weight: bold; font-size: 12px;">
                    @CurrentHp / @MaxHp (@((HpPercent * 100).ToString("0"))%)
                </span>
            </div>
        </div>
    </div>
    
    <!-- æ”»å‡»è¿›åº¦ -->
    @if (ShowAttackProgress && (NextAttackAt.HasValue || NextSpecialAt.HasValue))
    {
        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #ddd;">
            <div style="margin-bottom: 6px; font-size: 13px;"><b>âš”ï¸ æ”»å‡»èŠ‚å¥</b></div>
            
            @if (NextAttackAt.HasValue)
            {
                var attackTime = NextAttackAt.Value - CurrentTime;
                <div style="display: flex; align-items: center; margin-bottom: 4px;">
                    <span style="min-width: 80px; font-size: 11px;">æ™®é€šæ”»å‡»:</span>
                    <div style="flex: 1; background: #e0e0e0; height: 16px; border-radius: 3px; overflow: hidden; position: relative;">
                        <div style="background: linear-gradient(90deg, #2196f3, #64b5f6); height: 100%; width: @(AttackProgress * 100)%; transition: width 0.1s;"></div>
                        <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: #000; font-size: 10px;">
                            @(attackTime > 0 ? $"{attackTime:0.00}s" : "å°±ç»ª")
                        </span>
                    </div>
                </div>
            }
            
            @if (NextSpecialAt.HasValue)
            {
                var specialTime = NextSpecialAt.Value - CurrentTime;
                <div style="display: flex; align-items: center;">
                    <span style="min-width: 80px; font-size: 11px;">ç‰¹æ®Šæ”»å‡»:</span>
                    <div style="flex: 1; background: #e0e0e0; height: 16px; border-radius: 3px; overflow: hidden; position: relative;">
                        <div style="background: linear-gradient(90deg, #ff9800, #ffb74d); height: 100%; width: @(SpecialProgress * 100)%; transition: width 0.1s;"></div>
                        <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: #000; font-size: 10px;">
                            @(specialTime > 0 ? $"{specialTime:0.00}s" : "å°±ç»ª")
                        </span>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    /// <summary>è§’è‰²åç§°</summary>
    [Parameter] public string CharacterName { get; set; } = "";
    
    /// <summary>èŒä¸š</summary>
    [Parameter] public Profession Profession { get; set; }
    
    /// <summary>å½“å‰è¡€é‡</summary>
    [Parameter] public int CurrentHp { get; set; }
    
    /// <summary>æœ€å¤§è¡€é‡</summary>
    [Parameter] public int MaxHp { get; set; }
    
    /// <summary>è¡€é‡ç™¾åˆ†æ¯”</summary>
    [Parameter] public double HpPercent { get; set; } = 1.0;
    
    /// <summary>æˆ˜æ–—æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰</summary>
    [Parameter] public double? BattleDurationSeconds { get; set; }
    
    /// <summary>æ˜¯å¦æ˜¾ç¤ºæ”»å‡»è¿›åº¦</summary>
    [Parameter] public bool ShowAttackProgress { get; set; } = false;
    
    /// <summary>ä¸‹æ¬¡æ™®é€šæ”»å‡»æ—¶é—´</summary>
    [Parameter] public double? NextAttackAt { get; set; }
    
    /// <summary>ä¸‹æ¬¡ç‰¹æ®Šæ”»å‡»æ—¶é—´</summary>
    [Parameter] public double? NextSpecialAt { get; set; }
    
    /// <summary>å½“å‰æˆ˜æ–—æ—¶é—´</summary>
    [Parameter] public double CurrentTime { get; set; }
    
    /// <summary>æ™®é€šæ”»å‡»è¿›åº¦ï¼ˆ0-1ï¼‰</summary>
    [Parameter] public double AttackProgress { get; set; }
    
    /// <summary>ç‰¹æ®Šæ”»å‡»è¿›åº¦ï¼ˆ0-1ï¼‰</summary>
    [Parameter] public double SpecialProgress { get; set; }
    
    private string GetProfessionIcon(Profession profession)
    {
        return profession switch
        {
            Profession.Warrior => "âš”ï¸",
            Profession.Ranger => "ğŸ¹",
            _ => "ğŸ‘¤"
        };
    }
    
    private string FormatDuration(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.TotalHours >= 1)
            return $"{(int)ts.TotalHours}h{ts.Minutes}m{ts.Seconds}s";
        else if (ts.TotalMinutes >= 1)
            return $"{ts.Minutes}m{ts.Seconds}s";
        else
            return $"{ts.Seconds}s";
    }
}
