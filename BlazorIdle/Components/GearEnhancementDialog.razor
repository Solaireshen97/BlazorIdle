@using BlazorIdle.Client.Services
@using BlazorIdle.Shared.Models
@inject ApiClient Api

@* Phase 7: è£…å¤‡å¢å¼ºå¯¹è¯æ¡† - åˆ†è§£å’Œé‡é“¸åŠŸèƒ½ *@
@if (IsVisible)
{
    <div class="enhancement-dialog-overlay" @onclick="OnOverlayClick">
        <div class="enhancement-dialog" @onclick:stopPropagation="true">
            @* å¯¹è¯æ¡†å¤´éƒ¨ *@
            <div class="dialog-header">
                <h3 style="margin: 0; font-size: 16px; font-weight: bold;">
                    @(EnhancementType == "disenchant" ? "âš™ï¸ è£…å¤‡åˆ†è§£" : "ğŸ”¨ è£…å¤‡é‡é“¸")
                </h3>
                <button class="close-button" @onclick="OnClose" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">Ã—</button>
            </div>

            @* å¯¹è¯æ¡†ä¸»ä½“ *@
            <div class="dialog-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                @if (IsLoading)
                {
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 32px; margin-bottom: 12px;">â³</div>
                        <em>åŠ è½½ä¸­...</em>
                    </div>
                }
                else if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div style="padding: 16px; background: #ffebee; border: 1px solid #ef5350; border-radius: 4px; color: #c62828;">
                        <div style="font-weight: bold; margin-bottom: 8px;">âš ï¸ é”™è¯¯</div>
                        @ErrorMessage
                    </div>
                    <div style="margin-top: 16px; text-align: right;">
                        <button class="btn-secondary" @onclick="OnClose">å…³é—­</button>
                    </div>
                }
                else if (!string.IsNullOrEmpty(SuccessMessage))
                {
                    <div style="padding: 16px; background: #e8f5e9; border: 1px solid #66bb6a; border-radius: 4px; color: #2e7d32;">
                        <div style="font-weight: bold; margin-bottom: 8px;">âœ… æˆåŠŸ</div>
                        @SuccessMessage
                    </div>
                    <div style="margin-top: 16px; text-align: right;">
                        <button class="btn-primary" @onclick="OnClose">ç¡®å®š</button>
                    </div>
                }
                else if (EnhancementType == "disenchant")
                {
                    @* åˆ†è§£é¢„è§ˆç•Œé¢ *@
                    <div class="disenchant-preview">
                        @if (GearInfo != null)
                        {
                            <div class="gear-info" style="padding: 16px; background: #f5f5f5; border-radius: 4px; margin-bottom: 20px;">
                                <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #555;">
                                    @GearInfo.Icon @GearInfo.Name
                                </div>
                                <div style="font-size: 12px; color: #777;">
                                    å“è´¨: @GearInfo.Rarity | ç‰©å“ç­‰çº§: @GearInfo.ItemLevel
                                </div>
                            </div>
                        }

                        @if (DisenchantPreview != null && DisenchantPreview.Materials.Any())
                        {
                            <div class="materials-section">
                                <h4 style="font-size: 14px; font-weight: bold; margin-bottom: 12px; color: #555;">ğŸ“¦ åˆ†è§£äº§å‡º</h4>
                                <div class="materials-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                    @foreach (var material in DisenchantPreview.Materials)
                                    {
                                        <div class="material-item" style="padding: 12px; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px;">
                                            <div style="font-size: 12px; color: #777; margin-bottom: 4px;">@GetMaterialDisplayName(material.Key)</div>
                                            <div style="font-size: 16px; font-weight: bold; color: #1976d2;">Ã—@material.Value</div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="warning-section" style="margin-top: 20px; padding: 12px; background: #fff3e0; border: 1px solid #ff9800; border-radius: 4px; color: #e65100;">
                                <strong>âš ï¸ è­¦å‘Š:</strong> åˆ†è§£åè£…å¤‡å°†æ°¸ä¹…æ¶ˆå¤±ï¼Œæ— æ³•æ¢å¤ï¼
                            </div>

                            <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                                <button class="btn-secondary" @onclick="OnClose">å–æ¶ˆ</button>
                                <button class="btn-danger" @onclick="OnConfirmDisenchant" disabled="@IsProcessing">
                                    @(IsProcessing ? "å¤„ç†ä¸­..." : "ç¡®è®¤åˆ†è§£")
                                </button>
                            </div>
                        }
                        else
                        {
                            <div style="text-align: center; padding: 20px; color: #999;">
                                æ— æ³•é¢„è§ˆåˆ†è§£äº§å‡º
                            </div>
                        }
                    </div>
                }
                else if (EnhancementType == "reforge")
                {
                    @* é‡é“¸é¢„è§ˆç•Œé¢ *@
                    <div class="reforge-preview">
                        @if (GearInfo != null)
                        {
                            <div class="gear-info" style="padding: 16px; background: #f5f5f5; border-radius: 4px; margin-bottom: 20px;">
                                <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #555;">
                                    @GearInfo.Icon @GearInfo.Name
                                </div>
                                <div style="font-size: 12px; color: #777;">
                                    å“è´¨: @GearInfo.Rarity | ç‰©å“ç­‰çº§: @GearInfo.ItemLevel
                                </div>
                            </div>
                        }

                        @if (ReforgePreview != null)
                        {
                            @if (!ReforgePreview.CanReforge)
                            {
                                <div style="padding: 16px; background: #ffebee; border: 1px solid #ef5350; border-radius: 4px; color: #c62828; margin-bottom: 16px;">
                                    <strong>æ— æ³•é‡é“¸:</strong> @ReforgePreview.Message
                                </div>
                                <div style="text-align: right;">
                                    <button class="btn-secondary" @onclick="OnClose">å…³é—­</button>
                                </div>
                            }
                            else
                            {
                                <div class="tier-info" style="margin-bottom: 20px;">
                                    <h4 style="font-size: 14px; font-weight: bold; margin-bottom: 12px; color: #555;">ğŸ”¨ å“çº§æå‡</h4>
                                    <div style="display: flex; align-items: center; gap: 16px; font-size: 18px; font-weight: bold;">
                                        <span style="color: #1976d2;">T@ReforgePreview.CurrentTier</span>
                                        <span style="color: #999;">â†’</span>
                                        <span style="color: #2e7d32;">T@ReforgePreview.NextTier</span>
                                    </div>
                                </div>

                                <div class="cost-section" style="margin-bottom: 20px;">
                                    <h4 style="font-size: 14px; font-weight: bold; margin-bottom: 12px; color: #555;">ğŸ’° é‡é“¸æˆæœ¬</h4>
                                    <div class="cost-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                        @foreach (var cost in ReforgePreview.Cost)
                                        {
                                            <div class="cost-item" style="padding: 12px; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px;">
                                                <div style="font-size: 12px; color: #777; margin-bottom: 4px;">@GetMaterialDisplayName(cost.Key)</div>
                                                <div style="font-size: 16px; font-weight: bold; color: #d32f2f;">-@cost.Value</div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="stats-comparison" style="margin-bottom: 20px;">
                                    <h4 style="font-size: 14px; font-weight: bold; margin-bottom: 12px; color: #555;">ğŸ“Š å±æ€§å¯¹æ¯”</h4>
                                    <div style="display: grid; gap: 8px;">
                                        @foreach (var stat in ReforgePreview.CurrentStats)
                                        {
                                            var nextValue = ReforgePreview.NextStats.GetValueOrDefault(stat.Key, stat.Value);
                                            var diff = nextValue - stat.Value;
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 12px;">
                                                <span style="color: #555;">@GetStatDisplayName(stat.Key)</span>
                                                <span style="color: #1976d2; font-weight: bold;">@stat.Value.ToString("F1")</span>
                                                <span style="color: #999;">â†’</span>
                                                <span style="color: #2e7d32; font-weight: bold;">@nextValue.ToString("F1")</span>
                                                <span style="color: #2e7d32; font-weight: bold;">(+@diff.ToString("F1"))</span>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="info-section" style="margin-bottom: 20px; padding: 12px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; color: #0d47a1; font-size: 12px;">
                                    <strong>â„¹ï¸ æç¤º:</strong> é‡é“¸ä¼šæå‡è£…å¤‡å“çº§ï¼Œå¢å¼ºæ‰€æœ‰å±æ€§ï¼Œä½†ä¼šæ¶ˆè€—ææ–™ã€‚
                                </div>

                                <div class="action-buttons" style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button class="btn-secondary" @onclick="OnClose">å–æ¶ˆ</button>
                                    <button class="btn-primary" @onclick="OnConfirmReforge" disabled="@IsProcessing">
                                        @(IsProcessing ? "å¤„ç†ä¸­..." : "ç¡®è®¤é‡é“¸")
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <div style="text-align: center; padding: 20px; color: #999;">
                                æ— æ³•é¢„è§ˆé‡é“¸ä¿¡æ¯
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

<style>
    .enhancement-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease-out;
    }

    .enhancement-dialog {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease-out;
    }

    .dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #f5f5f5;
    }

    .close-button:hover {
        color: #000 !important;
    }

    .btn-primary {
        padding: 10px 20px;
        background: #1976d2;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-primary:hover:not(:disabled) {
        background: #1565c0;
    }

    .btn-primary:disabled {
        background: #bdbdbd;
        cursor: not-allowed;
    }

    .btn-secondary {
        padding: 10px 20px;
        background: #757575;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-secondary:hover {
        background: #616161;
    }

    .btn-danger {
        padding: 10px 20px;
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-danger:hover:not(:disabled) {
        background: #c62828;
    }

    .btn-danger:disabled {
        background: #bdbdbd;
        cursor: not-allowed;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

@code {
    /// <summary>
    /// æ˜¯å¦æ˜¾ç¤ºå¯¹è¯æ¡†
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// å¢å¼ºç±»å‹: "disenchant" æˆ– "reforge"
    /// </summary>
    [Parameter]
    public string EnhancementType { get; set; } = "disenchant";

    /// <summary>
    /// è§’è‰²ID
    /// </summary>
    [Parameter]
    public Guid CharacterId { get; set; }

    /// <summary>
    /// è£…å¤‡å®ä¾‹ID
    /// </summary>
    [Parameter]
    public Guid GearInstanceId { get; set; }

    /// <summary>
    /// è£…å¤‡åŸºæœ¬ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    /// </summary>
    [Parameter]
    public GearBasicInfo? GearInfo { get; set; }

    /// <summary>
    /// å…³é—­å›è°ƒ
    /// </summary>
    [Parameter]
    public EventCallback OnCloseCallback { get; set; }

    /// <summary>
    /// æˆåŠŸå›è°ƒ
    /// </summary>
    [Parameter]
    public EventCallback OnSuccessCallback { get; set; }

    private bool IsLoading { get; set; }
    private bool IsProcessing { get; set; }
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }
    private DisenchantPreviewResponse? DisenchantPreview { get; set; }
    private ReforgePreviewResponse? ReforgePreview { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && GearInstanceId != Guid.Empty)
        {
            await LoadPreviewAsync();
        }
    }

    /// <summary>
    /// åŠ è½½é¢„è§ˆä¿¡æ¯
    /// </summary>
    private async Task LoadPreviewAsync()
    {
        IsLoading = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            if (EnhancementType == "disenchant")
            {
                DisenchantPreview = await Api.PreviewDisenchantAsync(GearInstanceId);
            }
            else if (EnhancementType == "reforge")
            {
                ReforgePreview = await Api.PreviewReforgeAsync(GearInstanceId);
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"åŠ è½½é¢„è§ˆå¤±è´¥: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    /// <summary>
    /// ç¡®è®¤åˆ†è§£
    /// </summary>
    private async Task OnConfirmDisenchant()
    {
        IsProcessing = true;
        ErrorMessage = null;

        try
        {
            var result = await Api.DisenchantItemAsync(CharacterId, GearInstanceId);
            
            if (result?.Success == true)
            {
                SuccessMessage = $"åˆ†è§£æˆåŠŸï¼è·å¾—: {FormatMaterials(result.Materials)}";
                await Task.Delay(100);
                await OnSuccessCallback.InvokeAsync();
            }
            else
            {
                ErrorMessage = result?.Message ?? "åˆ†è§£å¤±è´¥";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"åˆ†è§£å¤±è´¥: {ex.Message}";
        }
        finally
        {
            IsProcessing = false;
        }
    }

    /// <summary>
    /// ç¡®è®¤é‡é“¸
    /// </summary>
    private async Task OnConfirmReforge()
    {
        IsProcessing = true;
        ErrorMessage = null;

        try
        {
            var result = await Api.ReforgeItemAsync(CharacterId, GearInstanceId);
            
            if (result?.Success == true)
            {
                SuccessMessage = $"é‡é“¸æˆåŠŸï¼è£…å¤‡å“çº§å·²æå‡";
                await Task.Delay(100);
                await OnSuccessCallback.InvokeAsync();
            }
            else
            {
                ErrorMessage = result?.Message ?? "é‡é“¸å¤±è´¥";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"é‡é“¸å¤±è´¥: {ex.Message}";
        }
        finally
        {
            IsProcessing = false;
        }
    }

    /// <summary>
    /// å…³é—­å¯¹è¯æ¡†
    /// </summary>
    private async Task OnClose()
    {
        await OnCloseCallback.InvokeAsync();
    }

    /// <summary>
    /// ç‚¹å‡»é®ç½©å±‚å…³é—­
    /// </summary>
    private async Task OnOverlayClick()
    {
        if (!IsProcessing)
        {
            await OnClose();
        }
    }

    /// <summary>
    /// è·å–ææ–™æ˜¾ç¤ºåç§°
    /// </summary>
    private string GetMaterialDisplayName(string materialId)
    {
        return materialId switch
        {
            "dust" => "âœ¨ å¥¥æœ¯ä¹‹å°˜",
            "essence" => "ğŸ’ é­”æ³•ç²¾å",
            "crystal" => "ğŸ”® å¥¥æœ¯æ°´æ™¶",
            "shard" => "ğŸ’  çµé­‚ç¢ç‰‡",
            _ => materialId
        };
    }

    /// <summary>
    /// è·å–å±æ€§æ˜¾ç¤ºåç§°
    /// </summary>
    private string GetStatDisplayName(string statId)
    {
        return statId switch
        {
            "AttackPower" => "âš”ï¸ æ”»å‡»åŠ›",
            "SpellPower" => "ğŸ”® æ³•æœ¯å¼ºåº¦",
            "Armor" => "ğŸ›¡ï¸ æŠ¤ç”²",
            "Strength" => "ğŸ’ª åŠ›é‡",
            "Agility" => "ğŸƒ æ•æ·",
            "Intelligence" => "ğŸ§  æ™ºåŠ›",
            "Stamina" => "â¤ï¸ è€åŠ›",
            "CritChance" => "ğŸ’¥ æš´å‡»ç‡",
            "HastePercent" => "âš¡ æ€¥é€Ÿ",
            "BlockChance" => "ğŸ”° æ ¼æŒ¡ç‡",
            _ => statId
        };
    }

    /// <summary>
    /// æ ¼å¼åŒ–ææ–™åˆ—è¡¨
    /// </summary>
    private string FormatMaterials(Dictionary<string, int> materials)
    {
        return string.Join(", ", materials.Select(m => $"{GetMaterialDisplayName(m.Key)} Ã—{m.Value}"));
    }

    /// <summary>
    /// è£…å¤‡åŸºæœ¬ä¿¡æ¯
    /// </summary>
    public class GearBasicInfo
    {
        public string Name { get; set; } = "";
        public string Icon { get; set; } = "âš”ï¸";
        public string Rarity { get; set; } = "";
        public int ItemLevel { get; set; }
    }
}
