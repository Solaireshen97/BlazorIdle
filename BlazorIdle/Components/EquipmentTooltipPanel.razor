@* è£…å¤‡è¯¦æƒ…æµ®çª—ç»„ä»¶ - æ˜¾ç¤ºè£…å¤‡çš„è¯¦ç»†ä¿¡æ¯ *@
@using BlazorIdle.Client.Services
@using BlazorIdle.Shared.Models

@if (Item != null && IsVisible)
{
    <div class="equipment-tooltip" style="position: fixed; left: @PositionX; top: @PositionY; z-index: 10000; background: white; border: 2px solid @GetRarityColor(Item.Rarity); border-radius: 6px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 250px; max-width: 350px; font-size: 12px;">
        @* è£…å¤‡åç§°å’Œå“è´¨ *@
        <div style="font-size: 14px; font-weight: bold; color: @GetRarityColor(Item.Rarity); margin-bottom: 8px; border-bottom: 2px solid @GetRarityColor(Item.Rarity); padding-bottom: 6px;">
            @Item.Icon @Item.Name
        </div>
        
        @* åŸºæœ¬ä¿¡æ¯ *@
        <div style="margin-bottom: 8px; color: #555;">
            <div><b>å“è´¨:</b> <span style="color: @GetRarityColor(Item.Rarity);">@GetRarityText(Item.Rarity)</span> (T@Item.Tier)</div>
            <div><b>ç‰©å“ç­‰çº§:</b> @Item.ItemLevel</div>
            <div><b>è£…å¤‡è¯„åˆ†:</b> <span style="color: #ff9800;">@Item.QualityScore</span></div>
            
            @* æŠ¤ç”²ç±»å‹ *@
            @if (!string.IsNullOrEmpty(Item.ArmorType) && Item.ArmorType != "None")
            {
                <div><b>æŠ¤ç”²ç±»å‹:</b> @GetArmorTypeName(Item.ArmorType)</div>
            }
            
            @* æ­¦å™¨ç±»å‹ *@
            @if (!string.IsNullOrEmpty(Item.WeaponType) && Item.WeaponType != "None")
            {
                <div><b>æ­¦å™¨ç±»å‹:</b> @GetWeaponTypeName(Item.WeaponType)</div>
            }
            
            @* å¥—è£… *@
            @if (!string.IsNullOrEmpty(Item.SetId))
            {
                <div><b>å¥—è£…:</b> <span style="color: #4caf50;">@Item.SetId</span></div>
            }
        </div>
        
        @* å±æ€§ *@
        @if (Item.Stats.Count > 0)
        {
            <div style="margin-bottom: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                <div style="font-weight: bold; margin-bottom: 4px; color: #333;">âš¡ å±æ€§</div>
                @foreach (var stat in Item.Stats.OrderByDescending(s => s.Value))
                {
                    var displayValue = IsPercentageStat(stat.Key) 
                        ? $"+{stat.Value * 100:F1}%" 
                        : $"+{stat.Value:F0}";
                    <div style="color: #28a745; padding: 2px 0;">
                        â€¢ @GetStatDisplayName(stat.Key): <b>@displayValue</b>
                    </div>
                }
            </div>
        }
        
        @* è¯æ¡ *@
        @if (Item.Affixes.Count > 0)
        {
            <div style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px;">
                <div style="font-weight: bold; margin-bottom: 4px; color: #1976d2;">ğŸ’ è¯æ¡</div>
                @foreach (var affix in Item.Affixes)
                {
                    <div style="color: #0277bd; padding: 2px 0;">
                        â€¢ @affix.DisplayText
                    </div>
                }
            </div>
        }
        
        @* é™åˆ¶æç¤º *@
        @if (ShowRestrictions && RestrictionMessage != null)
        {
            <div style="margin-top: 8px; padding: 8px; background: #ffebee; border-radius: 4px; border-left: 3px solid #f44336;">
                <div style="font-weight: bold; margin-bottom: 4px; color: #c62828;">âš ï¸ è£…å¤‡é™åˆ¶</div>
                <div style="color: #d32f2f; font-size: 11px; white-space: pre-line;">@RestrictionMessage</div>
            </div>
        }
        
        @* å¯¹æ¯”ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ *@
        @if (ComparisonItem != null)
        {
            <div style="margin-top: 8px; padding: 8px; background: #fff3e0; border-radius: 4px; border-left: 3px solid #ff9800;">
                <div style="font-weight: bold; margin-bottom: 4px; color: #e65100;">ğŸ“Š ä¸å½“å‰è£…å¤‡å¯¹æ¯”</div>
                @foreach (var comparison in GetStatComparisons())
                {
                    var color = comparison.Diff > 0 ? "#4caf50" : (comparison.Diff < 0 ? "#f44336" : "#666");
                    var arrow = comparison.Diff > 0 ? "â†‘" : (comparison.Diff < 0 ? "â†“" : "=");
                    <div style="color: @color; font-size: 11px; padding: 2px 0;">
                        @arrow @comparison.StatName: @comparison.DiffText
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    /// <summary>è¦æ˜¾ç¤ºçš„è£…å¤‡</summary>
    [Parameter] public GearInstanceDto? Item { get; set; }
    
    /// <summary>æ˜¯å¦æ˜¾ç¤ºæµ®çª—</summary>
    [Parameter] public bool IsVisible { get; set; }
    
    /// <summary>æµ®çª—Xåæ ‡</summary>
    [Parameter] public string PositionX { get; set; } = "0px";
    
    /// <summary>æµ®çª—Yåæ ‡</summary>
    [Parameter] public string PositionY { get; set; } = "0px";
    
    /// <summary>æ˜¯å¦æ˜¾ç¤ºé™åˆ¶ä¿¡æ¯</summary>
    [Parameter] public bool ShowRestrictions { get; set; } = true;
    
    /// <summary>é™åˆ¶æç¤ºæ¶ˆæ¯</summary>
    [Parameter] public string? RestrictionMessage { get; set; }
    
    /// <summary>å¯¹æ¯”è£…å¤‡ï¼ˆç”¨äºæ˜¾ç¤ºå·®å¼‚ï¼‰</summary>
    [Parameter] public GearInstanceDto? ComparisonItem { get; set; }
    
    /// <summary>è·å–å“è´¨é¢œè‰²</summary>
    private string GetRarityColor(string rarity)
    {
        return rarity switch
        {
            "Common" or "æ™®é€š" => "#9e9e9e",
            "Rare" or "ç¨€æœ‰" or "ä¼˜ç§€" => "#2196f3",
            "Epic" or "å²è¯—" or "ç²¾è‰¯" => "#9c27b0",
            "Legendary" or "ä¼ è¯´" => "#ff9800",
            _ => "#9e9e9e"
        };
    }
    
    /// <summary>è·å–å“è´¨æ–‡æœ¬</summary>
    private string GetRarityText(string rarity)
    {
        return rarity switch
        {
            "Common" => "æ™®é€š",
            "Rare" => "ç¨€æœ‰",
            "Epic" => "å²è¯—",
            "Legendary" => "ä¼ è¯´",
            "æ™®é€š" or "ä¼˜ç§€" or "ç²¾è‰¯" or "ä¼ è¯´" => rarity,
            _ => "æœªçŸ¥"
        };
    }
    
    /// <summary>è·å–æŠ¤ç”²ç±»å‹æ˜¾ç¤ºåç§°</summary>
    private string GetArmorTypeName(string armorType)
    {
        return armorType switch
        {
            "Cloth" => "å¸ƒç”²",
            "Leather" => "çš®ç”²",
            "Mail" => "é”ç”²",
            "Plate" => "æ¿ç”²",
            _ => armorType
        };
    }
    
    /// <summary>è·å–æ­¦å™¨ç±»å‹æ˜¾ç¤ºåç§°</summary>
    private string GetWeaponTypeName(string weaponType)
    {
        return weaponType switch
        {
            "Sword" => "å•æ‰‹å‰‘",
            "Dagger" => "åŒ•é¦–",
            "Axe" => "å•æ‰‹æ–§",
            "Mace" => "å•æ‰‹é”¤",
            "Staff" => "æ³•æ–",
            "Wand" => "é­”æ–",
            "Bow" => "å¼“",
            "Crossbow" => "å¼©",
            "Gun" => "æª",
            "TwoHandSword" => "åŒæ‰‹å‰‘",
            "TwoHandAxe" => "åŒæ‰‹æ–§",
            "TwoHandMace" => "åŒæ‰‹é”¤",
            "Polearm" => "é•¿æŸ„æ­¦å™¨",
            "Fist" => "æ‹³å¥—",
            "Shield" => "ç›¾ç‰Œ",
            _ => weaponType
        };
    }
    
    /// <summary>åˆ¤æ–­æ˜¯å¦ä¸ºç™¾åˆ†æ¯”å±æ€§</summary>
    private bool IsPercentageStat(string statId)
    {
        var percentageStats = new[] { "CritChance", "HastePercent", "BlockChance", "DodgeChance", "ParryChance" };
        return percentageStats.Contains(statId);
    }
    
    /// <summary>è·å–å±æ€§æ˜¾ç¤ºåç§°</summary>
    private string GetStatDisplayName(string statId)
    {
        return statId switch
        {
            "AttackPower" => "æ”»å‡»åŠ›",
            "SpellPower" => "æ³•æœ¯å¼ºåº¦",
            "Armor" => "æŠ¤ç”²",
            "Strength" => "åŠ›é‡",
            "Agility" => "æ•æ·",
            "Intellect" => "æ™ºåŠ›",
            "Stamina" => "è€åŠ›",
            "CritChance" => "æš´å‡»ç‡",
            "HastePercent" => "æ€¥é€Ÿ",
            "BlockChance" => "æ ¼æŒ¡ç‡",
            "DodgeChance" => "èº²é—ªç‡",
            "ParryChance" => "æ‹›æ¶ç‡",
            _ => statId
        };
    }
    
    /// <summary>è·å–å±æ€§å¯¹æ¯”ä¿¡æ¯</summary>
    private List<StatComparison> GetStatComparisons()
    {
        if (Item == null || ComparisonItem == null)
            return new List<StatComparison>();
        
        var comparisons = new List<StatComparison>();
        
        // è·å–æ‰€æœ‰å±æ€§çš„å¹¶é›†
        var allStats = Item.Stats.Keys.Union(ComparisonItem.Stats.Keys).Distinct();
        
        foreach (var statId in allStats)
        {
            var newValue = Item.Stats.TryGetValue(statId, out var nv) ? nv : 0;
            var oldValue = ComparisonItem.Stats.TryGetValue(statId, out var ov) ? ov : 0;
            var diff = newValue - oldValue;
            
            if (Math.Abs(diff) > 0.01) // åªæ˜¾ç¤ºæœ‰å·®å¼‚çš„å±æ€§
            {
                var isPercent = IsPercentageStat(statId);
                var diffText = isPercent 
                    ? $"{(diff > 0 ? "+" : "")}{diff * 100:F1}%" 
                    : $"{(diff > 0 ? "+" : "")}{diff:F0}";
                
                comparisons.Add(new StatComparison
                {
                    StatName = GetStatDisplayName(statId),
                    Diff = diff,
                    DiffText = diffText
                });
            }
        }
        
        return comparisons.OrderByDescending(c => Math.Abs(c.Diff)).ToList();
    }
    
    /// <summary>å±æ€§å¯¹æ¯”ä¿¡æ¯</summary>
    private class StatComparison
    {
        public string StatName { get; set; } = "";
        public double Diff { get; set; }
        public string DiffText { get; set; } = "";
    }
}
