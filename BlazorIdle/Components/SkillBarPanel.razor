@using BlazorIdle.Client.Services

@* æŠ€èƒ½æ é¢æ¿ç»„ä»¶ *@
@if (Skills != null && Skills.Count > 0)
{
    <div class="skill-bar-panel" style="margin-top: 12px; padding: 8px; background: @BackgroundColor; border-radius: 4px; border: 1px solid @BorderColor;">
        <h6 style="margin: 0 0 8px 0; font-size: 13px;">@Title</h6>
        <div class="skill-list" style="display: flex; flex-wrap: wrap; gap: 6px;">
            @foreach (var skill in Skills.OrderBy(s => s.Priority))
            {
                var isReady = skill.IsReady;
                var iconBg = isReady ? "#e3f2fd" : "#f5f5f5";
                var iconBorder = isReady ? "#42a5f5" : "#bdbdbd";
                
                <div class="skill-item" 
                     style="position: relative; width: 48px; height: 48px; background: @iconBg; border: 2px solid @iconBorder; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: help;"
                     title="@GetSkillTooltip(skill)">
                    
                    @* æŠ€èƒ½å›¾æ ‡ *@
                    <div style="font-size: 20px;">@GetSkillIcon(skill.Id)</div>
                    
                    @* å……èƒ½å±‚æ•°æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰ *@
                    @if (skill.MaxCharges.HasValue && skill.MaxCharges.Value > 1)
                    {
                        <div style="position: absolute; bottom: 2px; right: 3px; font-size: 9px; font-weight: bold; color: #333; background: rgba(255,255,255,0.9); padding: 0 3px; border-radius: 2px;">
                            @skill.CurrentCharges/@skill.MaxCharges
                        </div>
                    }
                    
                    @* å†·å´å€’è®¡æ—¶æ˜¾ç¤º *@
                    @if (!isReady && skill.RemainingCooldown > 0)
                    {
                        <div style="position: absolute; top: 2px; left: 2px; font-size: 8px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 1px 3px; border-radius: 2px;">
                            @FormatCooldown(skill.RemainingCooldown)
                        </div>
                    }
                    
                    @* å°±ç»ªæ ‡è®° *@
                    @if (isReady)
                    {
                        <div style="position: absolute; top: 2px; left: 2px; font-size: 8px; font-weight: bold; color: #fff; background: rgba(76,175,80,0.9); padding: 1px 3px; border-radius: 2px;">
                            å°±ç»ª
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    /// <summary>æŠ€èƒ½åˆ—è¡¨</summary>
    [Parameter] public List<SkillStatusDto> Skills { get; set; } = new();
    
    /// <summary>æ ‡é¢˜</summary>
    [Parameter] public string Title { get; set; } = "ğŸ¯ æŠ€èƒ½çŠ¶æ€";
    
    /// <summary>èƒŒæ™¯é¢œè‰²</summary>
    [Parameter] public string BackgroundColor { get; set; } = "#e8eaf6";
    
    /// <summary>è¾¹æ¡†é¢œè‰²</summary>
    [Parameter] public string BorderColor { get; set; } = "#9fa8da";
    
    /// <summary>è·å–æŠ€èƒ½å›¾æ ‡ï¼ˆä½¿ç”¨emojiï¼‰</summary>
    private string GetSkillIcon(string skillId)
    {
        return skillId.ToLowerInvariant() switch
        {
            // æˆ˜å£«æŠ€èƒ½
            "heroic_strike" => "ğŸ—¡ï¸",
            "shield_bash" => "ğŸ›¡ï¸",
            "whirlwind" => "ğŸŒ€",
            "charge" => "âš¡",
            "mortal_strike" => "ğŸ’¥",
            "execute" => "ğŸ’€",
            
            // æ¸¸ä¾ æŠ€èƒ½
            "power_shot" => "ğŸ¹",
            "bleed_shot" => "ğŸ”¥",
            "quick_shot" => "ğŸ’¨",
            "aimed_shot" => "ğŸ¯",
            "multi_shot" => "ğŸŒŸ",
            "explosive_shot" => "ğŸ’£",
            
            // é»˜è®¤å›¾æ ‡
            _ => "âš”ï¸"
        };
    }
    
    /// <summary>æ ¼å¼åŒ–å†·å´æ—¶é—´</summary>
    private string FormatCooldown(double seconds)
    {
        if (seconds < 10)
            return $"{seconds:0.1}";
        else if (seconds < 60)
            return $"{(int)seconds}";
        else
            return $"{(int)(seconds / 60)}m";
    }
    
    /// <summary>è·å–æŠ€èƒ½æç¤ºæ–‡æœ¬</summary>
    private string GetSkillTooltip(SkillStatusDto skill)
    {
        var tooltip = $"{skill.Name}\n";
        
        // æ¶ˆè€—
        if (!string.IsNullOrEmpty(skill.CostResourceId))
        {
            var resourceName = skill.CostResourceId switch
            {
                "rage" => "æ€’æ°”",
                "focus" => "é›†ä¸­",
                "mana" => "æ³•åŠ›",
                _ => skill.CostResourceId
            };
            tooltip += $"æ¶ˆè€—: {skill.CostAmount} {resourceName}\n";
        }
        
        // å†·å´
        tooltip += $"å†·å´: {skill.CooldownSeconds:0.0}ç§’\n";
        
        // çŠ¶æ€
        if (skill.IsReady)
        {
            tooltip += "çŠ¶æ€: å°±ç»ª âœ“";
        }
        else
        {
            tooltip += $"çŠ¶æ€: å†·å´ä¸­ ({skill.RemainingCooldown:0.1}ç§’)";
        }
        
        // å……èƒ½ä¿¡æ¯
        if (skill.MaxCharges.HasValue && skill.MaxCharges.Value > 1)
        {
            tooltip += $"\nå……èƒ½: {skill.CurrentCharges}/{skill.MaxCharges}";
        }
        
        return tooltip;
    }
}
