# BlazorIdle æ•°æ®åº“æ“ä½œä¼˜åŒ–æ–¹æ¡ˆåˆ†ææ–‡æ¡£

**é¡¹ç›®**: BlazorIdle æ•°æ®åº“æ“ä½œä¼˜åŒ–  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-17  
**çŠ¶æ€**: éœ€æ±‚åˆ†æå®Œæˆ - å¾…å®¡æ ¸

---

## ğŸ“‹ ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [ç°çŠ¶åˆ†æ](#ç°çŠ¶åˆ†æ)
3. [é—®é¢˜è¯Šæ–­](#é—®é¢˜è¯Šæ–­)
4. [ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡](#ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡)
5. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
6. [é…ç½®è®¾è®¡](#é…ç½®è®¾è®¡)
7. [é£é™©è¯„ä¼°](#é£é™©è¯„ä¼°)
8. [æ€§èƒ½é¢„æœŸ](#æ€§èƒ½é¢„æœŸ)

---

## æ‰§è¡Œæ‘˜è¦

### èƒŒæ™¯
å½“å‰ BlazorIdle æœåŠ¡ç«¯ç³»ç»Ÿä¸­ï¼Œæ•°æ®åº“æ“ä½œè¿‡äºé¢‘ç¹ï¼Œæ¯æ¬¡çŠ¶æ€å˜æ›´éƒ½ä¼šç«‹å³å†™å…¥æ•°æ®åº“ï¼Œå¯¼è‡´ï¼š
- æ•°æ®åº“ I/O å‹åŠ›è¿‡å¤§
- å¯èƒ½çš„æ€§èƒ½ç“¶é¢ˆ
- SQLite WAL æ–‡ä»¶è†¨èƒ€
- å¹¶å‘å†²çªé£é™©å¢åŠ 

### æ ¸å¿ƒé—®é¢˜
ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°ä»¥ä¸‹é«˜é¢‘æ•°æ®åº“æ“ä½œï¼š
1. **æˆ˜æ–—å¿«ç…§ä¿å­˜**ï¼šæ¯ 500ms ä¿å­˜ä¸€æ¬¡ï¼ˆStepBattleHostedServiceï¼‰
2. **æ´»åŠ¨è®¡åˆ’æ›´æ–°**ï¼šå®æ—¶æ›´æ–°çŠ¶æ€å’Œè¿›åº¦
3. **è§’è‰²å¿ƒè·³**ï¼šç©å®¶åœ¨çº¿æ—¶é¢‘ç¹æ›´æ–° LastSeenAtUtc
4. **æˆ˜æ–—ç»“ç®—**ï¼šæ¯æ¬¡å‡»æ€æ•Œäººåç«‹å³ä¿å­˜å¥–åŠ±
5. **è£…å¤‡å˜æ›´**ï¼šæ¯æ¬¡è£…å¤‡æ“ä½œç«‹å³ä¿å­˜
6. **ç¦»çº¿æ£€æµ‹**ï¼šæ¯ 30s æ‰«æå¹¶æ›´æ–°ç©å®¶çŠ¶æ€

### ä¼˜åŒ–ç›®æ ‡
1. **å†…å­˜ä¼˜å…ˆ**ï¼šæ‰€æœ‰æ“ä½œä¼˜å…ˆåœ¨å†…å­˜ä¸­æ‰§è¡Œ
2. **æ‰¹é‡ä¿å­˜**ï¼šå®šæœŸæ‰¹é‡å†™å…¥æ•°æ®åº“ï¼ˆå¯é…ç½®é—´éš”ï¼‰
3. **ä¼˜é›…å…³é—­**ï¼šæœåŠ¡å™¨å…³é—­æ—¶è§¦å‘æœ€ç»ˆä¿å­˜ï¼Œå¹¶è®¾ç½®æ‰€æœ‰åœ¨çº¿è§’è‰²ä¸ºç¦»çº¿
4. **é…ç½®åŒ–**ï¼šæ‰€æœ‰å‚æ•°é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†ï¼Œä¸å†™æ­»
5. **æ•°æ®å®‰å…¨**ï¼šç¡®ä¿å…³é”®æ•°æ®ä¸ä¸¢å¤±
6. **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰ API æ¥å£ä¸å˜

### é¢„æœŸæ•ˆæœ
- æ•°æ®åº“å†™å…¥æ¬¡æ•°å‡å°‘ **80-95%**
- æ•°æ®åº“ I/O å‹åŠ›é™ä½ **70-90%**
- å¹¶å‘å†²çªå‡å°‘ **90%+**
- ç³»ç»Ÿå“åº”é€Ÿåº¦æå‡ **20-40%**

---

## ç°çŠ¶åˆ†æ

### å½“å‰æ¶æ„æ¦‚è§ˆ

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
API Controllers
    â†“
Application Services â†â†’ [ç«‹å³ä¿å­˜] â†’ DbContext â†’ SQLite
    â†“
Domain Entities
```

### æ•°æ®åº“æ“ä½œç»Ÿè®¡

#### é«˜é¢‘å†™å…¥æ“ä½œï¼ˆæŒ‰é¢‘ç‡æ’åºï¼‰

| æ“ä½œç±»å‹ | å½“å‰é¢‘ç‡ | è§¦å‘ä½ç½® | SaveChangesæ¬¡æ•°/å°æ—¶ |
|---------|---------|---------|---------------------|
| æˆ˜æ–—å¿«ç…§ä¿å­˜ | æ¯ 500ms | StepBattleSnapshotService | 7,200 |
| æ´»åŠ¨è®¡åˆ’è¿›åº¦ | å®æ—¶ | ActivityPlanService | ~1,000-5,000 |
| è§’è‰²å¿ƒè·³ | æ¯æ¬¡å®¢æˆ·ç«¯å¿ƒè·³ | CharactersController.Heartbeat | ~600-1,200 |
| æˆ˜æ–—ç»“ç®—è®°å½• | æ¯æ¬¡æˆ˜æ–—ç»“æŸ | StepBattleFinalizer | ~100-500 |
| ç¦»çº¿æ£€æµ‹æ›´æ–° | æ¯ 30s | OfflineDetectionService | ~120 |
| è£…å¤‡å˜æ›´ | ç”¨æˆ·æ“ä½œè§¦å‘ | EquipmentController | ~50-200 |
| å•†åº—è´­ä¹° | ç”¨æˆ·æ“ä½œè§¦å‘ | ShopController | ~10-50 |

**æ€»è®¡ï¼šæ¯å°æ—¶çº¦ 9,000-14,000 æ¬¡æ•°æ®åº“å†™å…¥**

#### æ•°æ®åº“æ“ä½œä»£ç ä½ç½®

**1. StepBattleSnapshotServiceï¼ˆæˆ˜æ–—å¿«ç…§ï¼‰**
```
ä½ç½®ï¼šApplication/Battles/Step/StepBattleSnapshotService.cs
é¢‘ç‡ï¼šæ¯ 500ms
æ“ä½œï¼š_db.RunningBattleSnapshots.Add() + SaveChangesAsync()
å½±å“ï¼šæ¯ä¸ªæ´»è·ƒæˆ˜æ–— 7,200 æ¬¡/å°æ—¶
```

**2. CharactersController.Heartbeatï¼ˆè§’è‰²å¿ƒè·³ï¼‰**
```
ä½ç½®ï¼šApi/CharactersController.cs:353
é¢‘ç‡ï¼šå®¢æˆ·ç«¯å¿ƒè·³ï¼ˆçº¦ 10-20ç§’ä¸€æ¬¡ï¼‰
æ“ä½œï¼šcharacter.LastSeenAtUtc = DateTime.UtcNow + SaveChangesAsync()
å½±å“ï¼šæ¯ä¸ªåœ¨çº¿ç©å®¶ 180-360 æ¬¡/å°æ—¶
```

**3. ActivityPlanRepositoryï¼ˆæ´»åŠ¨è®¡åˆ’ï¼‰**
```
ä½ç½®ï¼šInfrastructure/Persistence/Repositories/ActivityPlanRepository.cs
é¢‘ç‡ï¼šæ´»åŠ¨çŠ¶æ€å˜æ›´æ—¶
æ“ä½œï¼šUpdateAsync() â†’ SaveChangesAsync()
å½±å“ï¼šå–å†³äºæ´»åŠ¨åˆ‡æ¢é¢‘ç‡
```

**4. BattleRepositoryï¼ˆæˆ˜æ–—è®°å½•ï¼‰**
```
ä½ç½®ï¼šInfrastructure/Persistence/Repositories/BattleRepository.cs
é¢‘ç‡ï¼šæˆ˜æ–—å¼€å§‹/ç»“æŸæ—¶
æ“ä½œï¼šAddAsync() / UpdateRewardsAsync() â†’ SaveChangesAsync()
å½±å“ï¼šæ¯ä¸ªæˆ˜æ–— 2 æ¬¡ï¼ˆå¼€å§‹+ç»“æŸï¼‰
```

**5. OfflineDetectionServiceï¼ˆç¦»çº¿æ£€æµ‹ï¼‰**
```
ä½ç½®ï¼šServices/OfflineDetectionService.cs
é¢‘ç‡ï¼šæ¯ 30s æ‰«æä¸€æ¬¡
æ“ä½œï¼šæ‰¹é‡æ›´æ–° IsOnline çŠ¶æ€ + SaveChangesAsync()
å½±å“ï¼š120 æ¬¡/å°æ—¶ Ã— ç¦»çº¿ç©å®¶æ•°é‡
```

### å·²æœ‰çš„ä¼˜åŒ–æªæ–½

âœ… **å·²å®æ–½**ï¼š
1. **DatabaseRetryPolicy**ï¼šé‡è¯•æœºåˆ¶å¤„ç† SQLite é”å®šï¼ˆæœ€å¤š 5 æ¬¡é‡è¯•ï¼‰
2. **GracefulShutdownCoordinator**ï¼šåŸºç¡€çš„ä¼˜é›…å…³é—­ï¼ˆ2ç§’ç¼“å†²ï¼‰
3. **WAL æ£€æŸ¥ç‚¹**ï¼šDbContext Dispose æ—¶æ‰§è¡Œæ£€æŸ¥ç‚¹
4. **è¿æ¥é…ç½®ä¼˜åŒ–**ï¼šShared Cache + 30s Timeout

âš ï¸ **ä¸è¶³ä¹‹å¤„**ï¼š
1. æ²¡æœ‰å†…å­˜ç¼“å†²å±‚ï¼Œæ‰€æœ‰æ“ä½œç«‹å³å†™å…¥
2. ä¼˜é›…å…³é—­åªæœ‰ 2 ç§’ç¼“å†²ï¼Œä¸ä¿è¯æ•°æ®å®Œæ•´æ€§
3. æ²¡æœ‰æ‰¹é‡ä¿å­˜æœºåˆ¶
4. æ²¡æœ‰åœ¨å…³é—­æ—¶å°†æ‰€æœ‰ç©å®¶è®¾ä¸ºç¦»çº¿
5. å‚æ•°ç¡¬ç¼–ç ï¼Œä¸æ˜“è°ƒæ•´

---

## é—®é¢˜è¯Šæ–­

### ä¸»è¦é—®é¢˜ç‚¹

#### 1. æˆ˜æ–—å¿«ç…§ä¿å­˜è¿‡äºé¢‘ç¹ âš ï¸âš ï¸âš ï¸

**ç°çŠ¶**ï¼š
```csharp
// StepBattleHostedService.cs
protected override async Task ExecuteAsync(CancellationToken stoppingToken)
{
    while (!stoppingToken.IsCancellationRequested)
    {
        await Task.Delay(500, stoppingToken);  // æ¯ 500ms ä¸€æ¬¡
        await _snapshotService.SaveAllRunningBattleSnapshotsAsync(stoppingToken);
    }
}
```

**é—®é¢˜**ï¼š
- æ¯ä¸ªæ´»è·ƒæˆ˜æ–—æ¯å°æ—¶ 7,200 æ¬¡å†™å…¥
- 10 ä¸ªå¹¶å‘æˆ˜æ–— = 72,000 æ¬¡/å°æ—¶
- SQLite å•çº¿ç¨‹å†™å…¥ç‰¹æ€§å¯¼è‡´ä¸¥é‡ç“¶é¢ˆ

**å½±å“**ï¼š
- æ•°æ®åº“é”ç­‰å¾…æ—¶é—´å¢åŠ 
- WAL æ–‡ä»¶å¿«é€Ÿå¢é•¿
- ç£ç›˜ I/O å‹åŠ›å¤§

#### 2. è§’è‰²å¿ƒè·³æ›´æ–°é¢‘ç¹ âš ï¸âš ï¸

**ç°çŠ¶**ï¼š
```csharp
// CharactersController.cs:Heartbeat
character.LastSeenAtUtc = DateTime.UtcNow;
await DatabaseRetryPolicy.SaveChangesWithRetryAsync(_db);
```

**é—®é¢˜**ï¼š
- æ¯ä¸ªåœ¨çº¿ç©å®¶æ¯ 10-20 ç§’æ›´æ–°ä¸€æ¬¡
- 100 ä¸ªåœ¨çº¿ç©å®¶ = 18,000-36,000 æ¬¡/å°æ—¶
- LastSeenAtUtc åªç”¨äºç¦»çº¿æ£€æµ‹ï¼ˆ60ç§’é˜ˆå€¼ï¼‰ï¼Œä¸éœ€è¦å®æ—¶ç²¾ç¡®

**ä¼˜åŒ–ç©ºé—´**ï¼š
- å¿ƒè·³å¯ä»¥åªæ›´æ–°å†…å­˜
- 60ç§’ç²¾åº¦è¶³å¤Ÿï¼Œä¸éœ€è¦æ¯ 10 ç§’ä¿å­˜

#### 3. æ´»åŠ¨è®¡åˆ’çŠ¶æ€æ›´æ–°é¢‘ç¹ âš ï¸

**ç°çŠ¶**ï¼š
- æ´»åŠ¨çŠ¶æ€å˜æ›´ï¼ˆPending â†’ Running â†’ Completedï¼‰ç«‹å³ä¿å­˜
- è¿›åº¦æ›´æ–°ï¼ˆå‰©ä½™æ—¶é—´ã€è®¡æ•°å™¨ï¼‰å®æ—¶ä¿å­˜

**é—®é¢˜**ï¼š
- çŸ­æ—¶æ´»åŠ¨ï¼ˆå¦‚ 10 ç§’æˆ˜æ–—ï¼‰é¢‘ç¹è§¦å‘çŠ¶æ€å˜æ›´
- ä¸å¿…è¦çš„ä¸­é—´çŠ¶æ€æŒä¹…åŒ–

#### 4. ä¼˜é›…å…³é—­æœºåˆ¶ä¸å®Œå–„ âš ï¸âš ï¸

**ç°çŠ¶**ï¼š
```csharp
// GracefulShutdownCoordinator.cs
_appLifetime.ApplicationStopping.Register(() =>
{
    _shutdownCts.Cancel();
    Thread.Sleep(2000);  // ä»… 2 ç§’
});
```

**é—®é¢˜**ï¼š
- 2 ç§’å¯èƒ½ä¸å¤Ÿä¿å­˜æ‰€æœ‰æ•°æ®
- æ²¡æœ‰æ˜ç¡®çš„ä¿å­˜æµç¨‹
- æ²¡æœ‰å°†åœ¨çº¿ç©å®¶è®¾ä¸ºç¦»çº¿
- æ²¡æœ‰ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆçš„æœºåˆ¶

#### 5. ç¼ºå°‘é…ç½®åŒ– âš ï¸

**ç°çŠ¶**ï¼š
- å¿«ç…§ä¿å­˜é—´éš”ç¡¬ç¼–ç ä¸º 500ms
- å¿ƒè·³é—´éš”å®¢æˆ·ç«¯å†³å®šï¼ˆ10-20sï¼‰
- ç¦»çº¿æ£€æµ‹é—´éš”ç¡¬ç¼–ç ä¸º 30s
- ä¼˜é›…å…³é—­è¶…æ—¶ç¡¬ç¼–ç ä¸º 2s

**é—®é¢˜**ï¼š
- æ— æ³•æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´
- æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒæ— æ³•ä½¿ç”¨ä¸åŒé…ç½®
- æ€§èƒ½è°ƒä¼˜å›°éš¾

### æ ¹æœ¬åŸå› åˆ†æ

```
æ ¹æœ¬åŸå›  1: æ¶æ„è®¾è®¡ç¼ºå°‘ç¼“å†²å±‚
    â†“
ç›´æ¥æ˜ å°„ï¼šå†…å­˜çŠ¶æ€å˜æ›´ â†’ ç«‹å³æ•°æ®åº“å†™å…¥
    â†“
ç»“æœï¼šé¢‘ç¹ I/O + å¹¶å‘å†²çª

æ ¹æœ¬åŸå›  2: æœªåŒºåˆ†"å…³é”®æ•°æ®"å’Œ"å¯å»¶è¿Ÿæ•°æ®"
    â†“
æ‰€æœ‰æ•°æ®ä¸€è§†åŒä»ï¼Œç«‹å³æŒä¹…åŒ–
    â†“
ç»“æœï¼šä¸å¿…è¦çš„å†™å…¥å‹åŠ›

æ ¹æœ¬åŸå›  3: ç¼ºå°‘æ‰¹é‡æäº¤æœºåˆ¶
    â†“
é€æ¡ä¿å­˜ï¼Œæ— æ³•åˆ©ç”¨æ‰¹å¤„ç†ä¼˜åŠ¿
    â†“
ç»“æœï¼šæ•ˆç‡ä½ä¸‹

æ ¹æœ¬åŸå›  4: å…³é—­æµç¨‹ä¸å®Œå–„
    â†“
ç¼ºå°‘æ˜ç¡®çš„"ä¿å­˜æ£€æŸ¥ç‚¹"
    â†“
ç»“æœï¼šæ•°æ®ä¸¢å¤±é£é™© + çŠ¶æ€ä¸ä¸€è‡´
```

---

## ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

#### 1. åˆ†å±‚ç¼“å†²ç­–ç•¥

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
API Controllers
    â†“
Application Services
    â†“
[å†…å­˜çŠ¶æ€ç®¡ç†å±‚] â† æ–°å¢ï¼
    â†“ (å®šæœŸæ‰¹é‡)
æŒä¹…åŒ–åè°ƒå™¨
    â†“
DbContext â†’ SQLite
```

#### 2. æ•°æ®åˆ†ç±»ç­–ç•¥

**ç«‹å³æŒä¹…åŒ–ï¼ˆCritical Dataï¼‰**ï¼š
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- è£…å¤‡è´­ä¹°ï¼ˆèŠ±è´¹çœŸå®è´§å¸ï¼‰
- å…³é”®é…ç½®å˜æ›´

**å®šæœŸæŒä¹…åŒ–ï¼ˆNormal Dataï¼‰**ï¼š
- æˆ˜æ–—å¿«ç…§
- æ´»åŠ¨è®¡åˆ’è¿›åº¦
- è§’è‰²å¿ƒè·³
- ç»æµäº‹ä»¶è®°å½•

**å…³é—­æ—¶æŒä¹…åŒ–ï¼ˆDelayed Dataï¼‰**ï¼š
- ç»Ÿè®¡æ•°æ®
- éå…³é”®ç¼“å­˜

#### 3. æ‰¹é‡ä¿å­˜æœºåˆ¶

```
æ¯ä¸ªå®šæœŸä¿å­˜å‘¨æœŸï¼š
1. æ”¶é›†æ‰€æœ‰å˜æ›´çš„å®ä½“
2. ä½¿ç”¨ DbContext ChangeTracker æ‰¹é‡æäº¤
3. å•æ¬¡äº‹åŠ¡å®Œæˆæ‰€æœ‰å†™å…¥
4. æ¸…ç†å·²ä¿å­˜çš„æ ‡è®°
```

### æ–¹æ¡ˆæ¶æ„

#### ç»„ä»¶è®¾è®¡

**1. å†…å­˜çŠ¶æ€ç®¡ç†å™¨ï¼ˆMemoryStateManagerï¼‰**

èŒè´£ï¼š
- ç»´æŠ¤æ‰€æœ‰å®ä½“çš„å†…å­˜å‰¯æœ¬
- è·Ÿè¸ªå˜æ›´ï¼ˆDirty Trackingï¼‰
- æä¾›æŸ¥è¯¢æ¥å£ï¼ˆåŒæ­¥è¯»å–ï¼‰
- æ ‡è®°éœ€è¦æŒä¹…åŒ–çš„å®ä½“

ç‰¹æ€§ï¼š
- çº¿ç¨‹å®‰å…¨ï¼ˆConcurrentDictionaryï¼‰
- æ”¯æŒå¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰
- å˜æ›´é˜Ÿåˆ—ï¼ˆChange Queueï¼‰

**2. æŒä¹…åŒ–åè°ƒå™¨ï¼ˆPersistenceCoordinatorï¼‰**

èŒè´£ï¼š
- å®šæœŸæ‰¹é‡ä¿å­˜ï¼ˆPeriodic Flushï¼‰
- æŒ‰ä¼˜å…ˆçº§ä¿å­˜ï¼ˆPriority Queueï¼‰
- å…³é—­æ—¶å¼ºåˆ¶ä¿å­˜ï¼ˆShutdown Flushï¼‰
- ä¿å­˜å¤±è´¥é‡è¯•

ç‰¹æ€§ï¼š
- åå°ä»»åŠ¡ï¼ˆBackgroundServiceï¼‰
- å¯é…ç½®é—´éš”
- äº‹åŠ¡ç®¡ç†
- é”™è¯¯æ¢å¤

**3. å…³é—­ç®¡ç†å™¨ï¼ˆShutdownManagerï¼‰**

èŒè´£ï¼š
- ç›‘å¬å…³é—­ä¿¡å·
- è§¦å‘æœ€ç»ˆä¿å­˜
- ç­‰å¾…æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡å®Œæˆ
- å°†æ‰€æœ‰åœ¨çº¿ç©å®¶è®¾ä¸ºç¦»çº¿
- è®°å½•å…³é—­çŠ¶æ€

ç‰¹æ€§ï¼š
- è¶…æ—¶ä¿æŠ¤ï¼ˆTimeout Protectionï¼‰
- å¼ºåˆ¶ä¿å­˜ï¼ˆForce Flushï¼‰
- ä¼˜é›…é™çº§ï¼ˆGraceful Degradationï¼‰

#### æ•°æ®æµè®¾è®¡

```
æ­£å¸¸è¿è¡Œæ—¶ï¼š
å®¢æˆ·ç«¯ â†’ API â†’ æ›´æ–°å†…å­˜çŠ¶æ€ â†’ æ ‡è®°Dirty
                                    â†“
                        [åå°] æ¯ N ç§’æ‰¹é‡ä¿å­˜

å…³é—­æ—¶ï¼š
å…³é—­ä¿¡å· â†’ ShutdownManager
              â†“
          1. åœæ­¢æ¥å—æ–°è¯·æ±‚
          2. ç­‰å¾…å½“å‰è¯·æ±‚å®Œæˆ
          3. æ‰¹é‡ä¿å­˜æ‰€æœ‰ Dirty æ•°æ®
          4. è®¾ç½®æ‰€æœ‰è§’è‰²ä¸ºç¦»çº¿
          5. æ‰§è¡Œ WAL æ£€æŸ¥ç‚¹
          6. å…³é—­æ•°æ®åº“è¿æ¥
```

### å®æ–½ç­–ç•¥

#### Phase 1: åŸºç¡€è®¾æ–½ï¼ˆä¸Šç¯‡ï¼‰

**ç›®æ ‡**ï¼šå»ºç«‹å†…å­˜ç¼“å†²å’Œæ‰¹é‡ä¿å­˜åŸºç¡€è®¾æ–½

**æ ¸å¿ƒä»»åŠ¡**ï¼š
1. åˆ›å»º MemoryStateManager
2. å®ç° PersistenceCoordinator
3. å¢å¼º ShutdownManager
4. æ·»åŠ é…ç½®æ”¯æŒ

**ä¸æ”¹å˜**ï¼š
- ç°æœ‰ API æ¥å£
- æ•°æ®æ¨¡å‹
- ä¸šåŠ¡é€»è¾‘

**å·¥ä½œé‡**ï¼š6-8 å¤©

#### Phase 2: é€æ­¥è¿ç§»ï¼ˆä¸­ç¯‡ï¼‰

**ç›®æ ‡**ï¼šå°†ç°æœ‰é«˜é¢‘æ“ä½œè¿ç§»åˆ°æ–°æ¶æ„

**è¿ç§»é¡ºåº**ï¼ˆæŒ‰å½±å“å’Œé£é™©æ’åºï¼‰ï¼š
1. è§’è‰²å¿ƒè·³ï¼ˆä½é£é™©ï¼Œé«˜æ”¶ç›Šï¼‰
2. æˆ˜æ–—å¿«ç…§ï¼ˆé«˜é£é™©ï¼Œé«˜æ”¶ç›Šï¼‰
3. æ´»åŠ¨è®¡åˆ’è¿›åº¦ï¼ˆä¸­é£é™©ï¼Œä¸­æ”¶ç›Šï¼‰
4. å…¶ä»–æ“ä½œï¼ˆä½é£é™©ï¼Œä½æ”¶ç›Šï¼‰

**ç­–ç•¥**ï¼š
- æ¯ä¸ªæ¨¡å—ç‹¬ç«‹è¿ç§»å’Œæµ‹è¯•
- ä¿ç•™å›é€€æœºåˆ¶ï¼ˆé…ç½®å¼€å…³ï¼‰
- ç°åº¦å‘å¸ƒï¼ˆé€æ­¥æ‰©å¤§èŒƒå›´ï¼‰

**å·¥ä½œé‡**ï¼š8-12 å¤©

#### Phase 3: ä¼˜åŒ–å’Œå®Œå–„ï¼ˆä¸‹ç¯‡ï¼‰

**ç›®æ ‡**ï¼šæ€§èƒ½è°ƒä¼˜ã€ç›‘æ§å’Œæ–‡æ¡£

**æ ¸å¿ƒä»»åŠ¡**ï¼š
1. æ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜
2. ç›‘æ§æŒ‡æ ‡åŸ‹ç‚¹
3. æ–‡æ¡£å®Œå–„
4. è¿ç»´å·¥å…·ï¼ˆæ‰‹åŠ¨è§¦å‘ä¿å­˜ã€æŸ¥çœ‹å†…å­˜çŠ¶æ€ç­‰ï¼‰

**å·¥ä½œé‡**ï¼š4-6 å¤©

---

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç±»è®¾è®¡

#### 1. MemoryStateManager<T>

```csharp
/// <summary>
/// å†…å­˜çŠ¶æ€ç®¡ç†å™¨ - ç®¡ç†å®ä½“çš„å†…å­˜å‰¯æœ¬å’Œå˜æ›´è·Ÿè¸ª
/// </summary>
public class MemoryStateManager<T> where T : class
{
    // å†…å­˜å­˜å‚¨ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    private readonly ConcurrentDictionary<Guid, T> _store;
    
    // å˜æ›´è¿½è¸ªï¼ˆDirty Setï¼‰
    private readonly ConcurrentDictionary<Guid, DateTime> _dirtyEntities;
    
    // è¯»å†™é”ï¼ˆä¿æŠ¤å¿«ç…§æ“ä½œï¼‰
    private readonly ReaderWriterLockSlim _lock;
    
    /// <summary>
    /// è·å–å®ä½“ï¼ˆå…ˆæŸ¥å†…å­˜ï¼Œæœªå‘½ä¸­åˆ™ä»æ•°æ®åº“åŠ è½½ï¼‰
    /// </summary>
    public async Task<T?> GetAsync(Guid id, CancellationToken ct = default);
    
    /// <summary>
    /// æ›´æ–°å®ä½“ï¼ˆä»…æ›´æ–°å†…å­˜ï¼Œæ ‡è®°ä¸º Dirtyï¼‰
    /// </summary>
    public void Update(Guid id, T entity);
    
    /// <summary>
    /// è·å–æ‰€æœ‰ Dirty å®ä½“ï¼ˆç”¨äºæ‰¹é‡ä¿å­˜ï¼‰
    /// </summary>
    public IEnumerable<T> GetDirtyEntities();
    
    /// <summary>
    /// æ¸…é™¤ Dirty æ ‡è®°ï¼ˆä¿å­˜æˆåŠŸåè°ƒç”¨ï¼‰
    /// </summary>
    public void ClearDirty(IEnumerable<Guid> ids);
    
    /// <summary>
    /// è·å–æ‰€æœ‰å®ä½“å¿«ç…§ï¼ˆç”¨äºå…³é—­æ—¶ä¿å­˜ï¼‰
    /// </summary>
    public IReadOnlyDictionary<Guid, T> GetSnapshot();
}
```

#### 2. PersistenceCoordinator

```csharp
/// <summary>
/// æŒä¹…åŒ–åè°ƒå™¨ - è´Ÿè´£å®šæœŸæ‰¹é‡ä¿å­˜å’Œå…³é—­æ—¶å¼ºåˆ¶ä¿å­˜
/// </summary>
public class PersistenceCoordinator : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly PersistenceOptions _options;
    private readonly ILogger<PersistenceCoordinator> _logger;
    
    // å„ç±»å‹å®ä½“çš„çŠ¶æ€ç®¡ç†å™¨
    private readonly MemoryStateManager<Character> _characterManager;
    private readonly MemoryStateManager<RunningBattleSnapshotRecord> _battleSnapshotManager;
    private readonly MemoryStateManager<ActivityPlan> _activityPlanManager;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            await Task.Delay(_options.SaveIntervalMs, stoppingToken);
            await PeriodicSaveAsync(stoppingToken);
        }
        
        // å…³é—­æ—¶æœ€ç»ˆä¿å­˜
        await FinalSaveAsync();
    }
    
    /// <summary>
    /// å®šæœŸä¿å­˜ - æ‰¹é‡æäº¤æ‰€æœ‰ Dirty å®ä½“
    /// </summary>
    private async Task PeriodicSaveAsync(CancellationToken ct);
    
    /// <summary>
    /// æœ€ç»ˆä¿å­˜ - å…³é—­æ—¶å¼ºåˆ¶ä¿å­˜æ‰€æœ‰æ•°æ®
    /// </summary>
    private async Task FinalSaveAsync();
    
    /// <summary>
    /// æ‰¹é‡ä¿å­˜å®ä½“
    /// </summary>
    private async Task BatchSaveAsync<T>(
        IEnumerable<T> entities, 
        GameDbContext db,
        CancellationToken ct) where T : class;
}
```

#### 3. EnhancedShutdownManager

```csharp
/// <summary>
/// å¢å¼ºçš„å…³é—­ç®¡ç†å™¨ - åè°ƒä¼˜é›…å…³é—­æµç¨‹
/// </summary>
public class EnhancedShutdownManager : IHostedService
{
    private readonly IHostApplicationLifetime _appLifetime;
    private readonly PersistenceCoordinator _persistenceCoordinator;
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ShutdownOptions _options;
    private readonly ILogger<EnhancedShutdownManager> _logger;
    
    public Task StartAsync(CancellationToken cancellationToken)
    {
        _appLifetime.ApplicationStopping.Register(OnShutdown);
        return Task.CompletedTask;
    }
    
    private void OnShutdown()
    {
        _logger.LogWarning("æœåŠ¡å™¨å…³é—­å¼€å§‹...");
        
        try
        {
            // 1. è§¦å‘åè°ƒå™¨æœ€ç»ˆä¿å­˜
            var saveTask = _persistenceCoordinator.FinalSaveAsync();
            
            // 2. è®¾ç½®æ‰€æœ‰åœ¨çº¿è§’è‰²ä¸ºç¦»çº¿
            var offlineTask = SetAllCharactersOfflineAsync();
            
            // 3. ç­‰å¾…ä»»åŠ¡å®Œæˆï¼ˆå¸¦è¶…æ—¶ï¼‰
            Task.WaitAll(
                new[] { saveTask, offlineTask },
                TimeSpan.FromSeconds(_options.ShutdownTimeoutSeconds)
            );
            
            _logger.LogInformation("æœåŠ¡å™¨å…³é—­æµç¨‹å®Œæˆ");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å…³é—­æµç¨‹å‡ºé”™");
        }
    }
    
    /// <summary>
    /// å°†æ‰€æœ‰åœ¨çº¿è§’è‰²è®¾ç½®ä¸ºç¦»çº¿
    /// </summary>
    private async Task SetAllCharactersOfflineAsync()
    {
        using var scope = _scopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
        
        var onlineCharacters = await db.Characters
            .Where(c => c.IsOnline)
            .ToListAsync();
            
        foreach (var character in onlineCharacters)
        {
            character.IsOnline = false;
            character.LastSeenAtUtc = DateTime.UtcNow;
        }
        
        await db.SaveChangesAsync();
        
        _logger.LogInformation(
            "å·²å°† {Count} ä¸ªåœ¨çº¿è§’è‰²è®¾ç½®ä¸ºç¦»çº¿", 
            onlineCharacters.Count
        );
    }
    
    public Task StopAsync(CancellationToken cancellationToken) 
        => Task.CompletedTask;
}
```

### æ¥å£é€‚é…å™¨

ä¸ºäº†ä¿æŒç°æœ‰ä»£ç å…¼å®¹ï¼Œéœ€è¦åˆ›å»ºé€‚é…å™¨ï¼š

```csharp
/// <summary>
/// è§’è‰²ä»“å‚¨é€‚é…å™¨ - é€æ˜åœ°ä½¿ç”¨å†…å­˜ç®¡ç†å™¨
/// </summary>
public class CharacterRepositoryAdapter : ICharacterRepository
{
    private readonly MemoryStateManager<Character> _memoryManager;
    private readonly GameDbContext _db;
    
    public async Task<Character?> GetAsync(Guid id, CancellationToken ct = default)
    {
        // å…ˆæŸ¥å†…å­˜ï¼Œæœªå‘½ä¸­åˆ™æŸ¥æ•°æ®åº“å¹¶åŠ è½½åˆ°å†…å­˜
        return await _memoryManager.GetAsync(id, ct);
    }
    
    // å…¶ä»–æ–¹æ³•...
}
```

### çº¿ç¨‹å®‰å…¨è®¾è®¡

#### å¹¶å‘è®¿é—®ç­–ç•¥

**è¯»æ“ä½œ**ï¼š
```csharp
// æ— é”è¯»å–ï¼ˆConcurrentDictionary ä¿è¯çº¿ç¨‹å®‰å…¨ï¼‰
var character = _memoryManager.Get(id);
```

**å†™æ“ä½œ**ï¼š
```csharp
// ConcurrentDictionary.AddOrUpdate æä¾›åŸå­æ€§
_memoryManager.Update(id, character);
```

**æ‰¹é‡æ“ä½œ**ï¼š
```csharp
// ä½¿ç”¨è¯»å†™é”ä¿æŠ¤å¿«ç…§æ“ä½œ
_lock.EnterReadLock();
try
{
    var snapshot = _store.ToArray();
    // å¤„ç†å¿«ç…§
}
finally
{
    _lock.ExitReadLock();
}
```

---

## é…ç½®è®¾è®¡

### é…ç½®æ–‡ä»¶ç»“æ„

```json
// appsettings.json
{
  "Persistence": {
    // æ˜¯å¦å¯ç”¨å†…å­˜ç¼“å†²ï¼ˆå¯ç”¨äºå›é€€ï¼‰
    "EnableMemoryBuffering": true,
    
    // å®šæœŸä¿å­˜é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    "SaveIntervalMs": 30000,  // 30ç§’
    
    // æ‰¹é‡ä¿å­˜å¤§å°é™åˆ¶
    "MaxBatchSize": 1000,
    
    // å¼ºåˆ¶ä¿å­˜é˜ˆå€¼ï¼ˆDirty å®ä½“æ•°é‡ï¼‰
    "ForceSaveThreshold": 5000,
    
    // ä¿å­˜å¤±è´¥é‡è¯•æ¬¡æ•°
    "SaveRetryAttempts": 3,
    
    // ä¸åŒå®ä½“ç±»å‹çš„ä¿å­˜ç­–ç•¥
    "EntitySaveStrategies": {
      // æˆ˜æ–—å¿«ç…§ï¼šæ¯åˆ†é’Ÿä¿å­˜ä¸€æ¬¡ï¼ˆè€Œä¸æ˜¯æ¯ 500msï¼‰
      "BattleSnapshot": {
        "SaveIntervalMs": 60000,
        "MaxBatchSize": 500
      },
      // è§’è‰²å¿ƒè·³ï¼šæ¯ 5 åˆ†é’Ÿä¿å­˜ä¸€æ¬¡ï¼ˆå¤Ÿç”¨äºç¦»çº¿æ£€æµ‹ï¼‰
      "CharacterHeartbeat": {
        "SaveIntervalMs": 300000,
        "MaxBatchSize": 1000
      },
      // æ´»åŠ¨è®¡åˆ’ï¼šæ¯ 30 ç§’ä¿å­˜ä¸€æ¬¡
      "ActivityPlan": {
        "SaveIntervalMs": 30000,
        "MaxBatchSize": 200
      }
    }
  },
  
  "Shutdown": {
    // ä¼˜é›…å…³é—­è¶…æ—¶ï¼ˆç§’ï¼‰
    "ShutdownTimeoutSeconds": 30,
    
    // æ˜¯å¦åœ¨å…³é—­æ—¶è®¾ç½®æ‰€æœ‰è§’è‰²ä¸ºç¦»çº¿
    "SetCharactersOfflineOnShutdown": true,
    
    // æ˜¯å¦åœ¨å…³é—­æ—¶å¼ºåˆ¶æ‰§è¡Œ WAL æ£€æŸ¥ç‚¹
    "ForceWalCheckpointOnShutdown": true,
    
    // å…³é—­æ—¶ä¿å­˜é‡è¯•æ¬¡æ•°
    "ShutdownSaveRetryAttempts": 5
  },
  
  "MemoryCache": {
    // å†…å­˜ç¼“å­˜æœ€å¤§å®ä½“æ•°ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
    "MaxCachedEntities": 100000,
    
    // è¶…è¿‡é˜ˆå€¼æ—¶çš„æ¸…ç†ç­–ç•¥ï¼ˆLRU / TTLï¼‰
    "EvictionPolicy": "LRU",
    
    // TTLï¼ˆç§’ï¼Œä»…å½“ EvictionPolicy = TTLï¼‰
    "TimeToLiveSeconds": 3600
  },
  
  "Monitoring": {
    // æ˜¯å¦å¯ç”¨æ€§èƒ½ç›‘æ§
    "EnablePerformanceMonitoring": true,
    
    // ç›‘æ§æŒ‡æ ‡è®°å½•é—´éš”ï¼ˆç§’ï¼‰
    "MetricsIntervalSeconds": 60,
    
    // ç›‘æ§çš„æŒ‡æ ‡
    "TrackedMetrics": [
      "DatabaseSavesPerMinute",
      "DirtyEntitiesCount",
      "MemoryCacheSize",
      "BatchSaveDurationMs",
      "SaveFailureCount"
    ]
  }
}
```

### é…ç½®ç±»å®šä¹‰

```csharp
/// <summary>
/// æŒä¹…åŒ–é…ç½®é€‰é¡¹
/// </summary>
public class PersistenceOptions
{
    public bool EnableMemoryBuffering { get; set; } = true;
    public int SaveIntervalMs { get; set; } = 30000;
    public int MaxBatchSize { get; set; } = 1000;
    public int ForceSaveThreshold { get; set; } = 5000;
    public int SaveRetryAttempts { get; set; } = 3;
    public Dictionary<string, EntitySaveStrategy> EntitySaveStrategies { get; set; } = new();
}

/// <summary>
/// å®ä½“ä¿å­˜ç­–ç•¥
/// </summary>
public class EntitySaveStrategy
{
    public int SaveIntervalMs { get; set; }
    public int MaxBatchSize { get; set; }
}

/// <summary>
/// å…³é—­é…ç½®é€‰é¡¹
/// </summary>
public class ShutdownOptions
{
    public int ShutdownTimeoutSeconds { get; set; } = 30;
    public bool SetCharactersOfflineOnShutdown { get; set; } = true;
    public bool ForceWalCheckpointOnShutdown { get; set; } = true;
    public int ShutdownSaveRetryAttempts { get; set; } = 5;
}

/// <summary>
/// å†…å­˜ç¼“å­˜é…ç½®é€‰é¡¹
/// </summary>
public class MemoryCacheOptions
{
    public int MaxCachedEntities { get; set; } = 100000;
    public string EvictionPolicy { get; set; } = "LRU";
    public int TimeToLiveSeconds { get; set; } = 3600;
}
```

### é…ç½®æ³¨å†Œ

```csharp
// Program.cs
builder.Services.Configure<PersistenceOptions>(
    builder.Configuration.GetSection("Persistence"));
    
builder.Services.Configure<ShutdownOptions>(
    builder.Configuration.GetSection("Shutdown"));
    
builder.Services.Configure<MemoryCacheOptions>(
    builder.Configuration.GetSection("MemoryCache"));
```

---

## é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©

#### é£é™© 1: å†…å­˜æº¢å‡º âš ï¸âš ï¸âš ï¸

**é£é™©æè¿°**ï¼š
- é•¿æ—¶é—´è¿è¡Œå¯¼è‡´å†…å­˜ä¸­ç´¯ç§¯å¤§é‡å®ä½“
- å¹¶å‘ç©å®¶æ•°è¿‡å¤šï¼ˆå¦‚æ´»åŠ¨é«˜å³°æœŸï¼‰

**å½±å“**ï¼š
- å†…å­˜ä¸è¶³å¯¼è‡´æœåŠ¡å´©æºƒ
- GC å‹åŠ›å¢å¤§ï¼Œæ€§èƒ½ä¸‹é™

**ç¼“è§£æªæ–½**ï¼š
1. é…ç½® MaxCachedEntities é™åˆ¶
2. å®æ–½ LRU æ¸…ç†ç­–ç•¥
3. ç›‘æ§å†…å­˜ä½¿ç”¨ï¼Œè¾¾åˆ°é˜ˆå€¼è§¦å‘å¼ºåˆ¶ä¿å­˜
4. ä¸ºä¸å¸¸è®¿é—®çš„å®ä½“è®¾ç½® TTL

**ç›‘æ§æŒ‡æ ‡**ï¼š
- å†…å­˜ä½¿ç”¨ç‡
- GC é¢‘ç‡å’Œæ—¶é•¿
- ç¼“å­˜å‘½ä¸­ç‡

#### é£é™© 2: æ•°æ®ä¸¢å¤± âš ï¸âš ï¸

**é£é™©æè¿°**ï¼š
- æœåŠ¡å™¨å¼‚å¸¸å´©æºƒï¼ˆå¦‚ OOMã€è¿›ç¨‹è¢« kill -9ï¼‰
- æœªä¿å­˜çš„å†…å­˜æ•°æ®ä¸¢å¤±

**å½±å“**ï¼š
- ç©å®¶è¿›åº¦å›é€€
- ç”¨æˆ·ä½“éªŒä¸‹é™

**ç¼“è§£æªæ–½**ï¼š
1. å…³é”®æ“ä½œï¼ˆè´­ä¹°ã€é‡è¦å¥–åŠ±ï¼‰ç«‹å³æŒä¹…åŒ–
2. å®šæœŸä¿å­˜é—´éš”ä¸å®œè¿‡é•¿ï¼ˆå»ºè®® 30-60 ç§’ï¼‰
3. å®æ–½ Write-Ahead Logï¼ˆå¯é€‰ï¼Œå¢åŠ å¤æ‚åº¦ï¼‰
4. å®šæœŸå¤‡ä»½æ•°æ®åº“

**æ¥å—åº¦**ï¼š
- å¯¹äºæ”¾ç½®ç±»æ¸¸æˆï¼Œ30-60 ç§’çš„æ•°æ®ä¸¢å¤±é£é™©æ˜¯å¯æ¥å—çš„
- å…³é”®äº¤æ˜“ä¸å—å½±å“

#### é£é™© 3: å¹¶å‘å†²çª âš ï¸

**é£é™©æè¿°**ï¼š
- æ‰¹é‡ä¿å­˜æ—¶ä¸å…¶ä»–å†™å…¥æ“ä½œå†²çª
- å†…å­˜çŠ¶æ€ä¸æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´

**å½±å“**ï¼š
- ä¿å­˜å¤±è´¥éœ€è¦é‡è¯•
- å¯èƒ½çš„æ•°æ®ä¸ä¸€è‡´

**ç¼“è§£æªæ–½**ï¼š
1. ä½¿ç”¨ä¹è§‚é”ï¼ˆTimestamp / Versionï¼‰
2. ä¿å­˜å¤±è´¥æ—¶é‡æ–°åŠ è½½å¹¶é‡è¯•
3. éš”ç¦»å…³é”®æ“ä½œçš„äº‹åŠ¡
4. å®šæœŸä¿å­˜ä¼˜å…ˆçº§ä½äºç”¨æˆ·è¯·æ±‚

**ç›‘æ§æŒ‡æ ‡**ï¼š
- å†²çªé‡è¯•æ¬¡æ•°
- ä¿å­˜å¤±è´¥ç‡

#### é£é™© 4: è¿ç§»å¤æ‚åº¦ âš ï¸âš ï¸

**é£é™©æè¿°**ï¼š
- å¤§é‡ç°æœ‰ä»£ç éœ€è¦é€‚é…
- å¯èƒ½å¼•å…¥æ–°çš„ Bug

**å½±å“**ï¼š
- å¼€å‘å‘¨æœŸå»¶é•¿
- æµ‹è¯•å·¥ä½œé‡å¢åŠ 

**ç¼“è§£æªæ–½**ï¼š
1. åˆ†é˜¶æ®µè¿ç§»ï¼ˆæŒ‰æ¨¡å—ï¼‰
2. ä¿ç•™å›é€€å¼€å…³ï¼ˆEnableMemoryBufferingï¼‰
3. å……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. ç°åº¦å‘å¸ƒï¼ˆå…ˆå°èŒƒå›´éªŒè¯ï¼‰

### ä¸šåŠ¡é£é™©

#### é£é™© 5: ç¦»çº¿æ£€æµ‹ä¸å‡†ç¡® âš ï¸

**é£é™©æè¿°**ï¼š
- å¿ƒè·³ä¸å†å®æ—¶ä¿å­˜ï¼ŒLastSeenAtUtc å¯èƒ½å»¶è¿Ÿæ›´æ–°
- ç¦»çº¿æ£€æµ‹å¯èƒ½æœ‰ 30-60 ç§’è¯¯å·®

**å½±å“**ï¼š
- ç©å®¶å·²ç¦»çº¿ä½†ç³»ç»Ÿåˆ¤æ–­ä¸ºåœ¨çº¿
- å½±å“ç¦»çº¿æ”¶ç›Šè®¡ç®—

**ç¼“è§£æªæ–½**ï¼š
1. ç¦»çº¿æ£€æµ‹é˜ˆå€¼ç›¸åº”å¢åŠ ï¼ˆä» 60s â†’ 120sï¼‰
2. å¿ƒè·³ä¿å­˜é—´éš”ä¸å®œè¿‡é•¿ï¼ˆå»ºè®® 5 åˆ†é’Ÿï¼‰
3. å†…å­˜ä¸­ä¿æŒæœ€æ–°çš„å¿ƒè·³æ—¶é—´ï¼Œä»…æŒä¹…åŒ–å»¶è¿Ÿ

**å½±å“è¯„ä¼°**ï¼š
- å¯¹æ¸¸æˆä½“éªŒå½±å“æå°
- ç¦»çº¿æ”¶ç›Šè®¡ç®—æœ‰ 1-2 åˆ†é’Ÿè¯¯å·®å±äºå¯æ¥å—èŒƒå›´

---

## æ€§èƒ½é¢„æœŸ

### æ•°æ®åº“å†™å…¥æ¬¡æ•°å¯¹æ¯”

#### ä¼˜åŒ–å‰ï¼ˆå½“å‰ï¼‰

| åœºæ™¯ | æ¯å°æ—¶å†™å…¥æ¬¡æ•° |
|-----|--------------|
| 1 ä¸ªæ´»è·ƒæˆ˜æ–— | 7,200 |
| 10 ä¸ªæ´»è·ƒæˆ˜æ–— | 72,000 |
| 100 ä¸ªåœ¨çº¿ç©å®¶ï¼ˆå¿ƒè·³ï¼‰ | 18,000 |
| æ´»åŠ¨è®¡åˆ’æ›´æ–° | 3,000 |
| å…¶ä»–æ“ä½œ | 1,000 |
| **æ€»è®¡** | **~101,200 æ¬¡** |

#### ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰

| åœºæ™¯ | æ¯å°æ—¶å†™å…¥æ¬¡æ•° | å‡å°‘æ¯”ä¾‹ |
|-----|--------------|---------|
| æˆ˜æ–—å¿«ç…§ï¼ˆæ¯åˆ†é’Ÿä¿å­˜ï¼‰ | 60 | **-99.2%** |
| 100 ä¸ªåœ¨çº¿ç©å®¶ï¼ˆæ¯ 5 åˆ†é’Ÿä¿å­˜ï¼‰ | 1,200 | **-93.3%** |
| æ´»åŠ¨è®¡åˆ’ï¼ˆæ¯ 30 ç§’ä¿å­˜ï¼‰ | 120 | **-96.0%** |
| å…¶ä»–æ“ä½œ | 1,000 | 0% |
| **æ€»è®¡** | **~2,380 æ¬¡** | **-97.6%** |

### æ€§èƒ½æå‡é¢„æœŸ

#### æ•°æ®åº“ I/O

```
å†™å…¥ååé‡æå‡ï¼š
å½“å‰ï¼š~28 æ¬¡/ç§’ï¼ˆå³°å€¼ ~50 æ¬¡/ç§’ï¼‰
ä¼˜åŒ–åï¼š~0.7 æ¬¡/ç§’ï¼ˆå³°å€¼ ~3 æ¬¡/ç§’ï¼‰
æå‡ï¼š40-50 å€
```

#### å“åº”æ—¶é—´

```
API å“åº”æ—¶é—´ï¼ˆP95ï¼‰ï¼š
å½“å‰ï¼š200-500msï¼ˆé«˜è´Ÿè½½æ—¶ï¼‰
ä¼˜åŒ–åï¼š50-100msï¼ˆé¢„æœŸï¼‰
æ”¹å–„ï¼š50-80%
```

#### SQLite WAL æ–‡ä»¶å¤§å°

```
WAL æ–‡ä»¶å¢é•¿é€Ÿåº¦ï¼š
å½“å‰ï¼š1-2 MB/å°æ—¶
ä¼˜åŒ–åï¼š0.05-0.1 MB/å°æ—¶
å‡å°‘ï¼š90-95%
```

#### å¹¶å‘èƒ½åŠ›

```
æ”¯æŒçš„å¹¶å‘æˆ˜æ–—æ•°ï¼š
å½“å‰ï¼š10-20 ä¸ªï¼ˆæ€§èƒ½å¼€å§‹ä¸‹é™ï¼‰
ä¼˜åŒ–åï¼š50-100 ä¸ªï¼ˆé¢„æœŸï¼‰
æå‡ï¼š3-5 å€
```

### èµ„æºæ¶ˆè€—é¢„æœŸ

#### å†…å­˜

```
é¢å¤–å†…å­˜æ¶ˆè€—ï¼š
- MemoryStateManager: ~50-100 MB
- Dirty è¿½è¸ª: ~10-20 MB
- æ€»è®¡: ~60-120 MB

å¯¹æ¯”ï¼šèŠ‚çœçš„ I/O ç­‰å¾…è¿œè¶…å†…å­˜æˆæœ¬
```

#### CPU

```
CPU ä½¿ç”¨ç‡ï¼š
- æ‰¹é‡ä¿å­˜é¢å¤–å¼€é”€: <5%
- I/O ç­‰å¾…å‡å°‘èŠ‚çœ: 10-20%
- å‡€èŠ‚çœ: 5-15%
```

---

## é™„å½•ï¼šå…³é”®ä»£ç ç‰‡æ®µ

### 1. MemoryStateManager æ ¸å¿ƒé€»è¾‘

```csharp
public class MemoryStateManager<T> where T : class, IEntity
{
    private readonly ConcurrentDictionary<Guid, T> _store = new();
    private readonly ConcurrentDictionary<Guid, DateTime> _dirty = new();
    private readonly GameDbContext _db;
    
    public async Task<T?> GetAsync(Guid id, CancellationToken ct = default)
    {
        // å…ˆæŸ¥å†…å­˜
        if (_store.TryGetValue(id, out var entity))
            return entity;
            
        // æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
        entity = await _db.Set<T>().FindAsync(new object[] { id }, ct);
        if (entity != null)
        {
            _store.TryAdd(id, entity);
        }
        return entity;
    }
    
    public void Update(Guid id, T entity)
    {
        _store.AddOrUpdate(id, entity, (_, __) => entity);
        _dirty.TryAdd(id, DateTime.UtcNow);
    }
    
    public IEnumerable<(Guid Id, T Entity)> GetDirtyEntities()
    {
        foreach (var (id, _) in _dirty)
        {
            if (_store.TryGetValue(id, out var entity))
                yield return (id, entity);
        }
    }
    
    public void ClearDirty(IEnumerable<Guid> ids)
    {
        foreach (var id in ids)
        {
            _dirty.TryRemove(id, out _);
        }
    }
}
```

### 2. PersistenceCoordinator æ‰¹é‡ä¿å­˜

```csharp
private async Task PeriodicSaveAsync(CancellationToken ct)
{
    using var scope = _scopeFactory.CreateScope();
    var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
    
    try
    {
        // è·å–æ‰€æœ‰ Dirty å®ä½“
        var dirtyCharacters = _characterManager.GetDirtyEntities().ToList();
        var dirtySnapshots = _battleSnapshotManager.GetDirtyEntities().ToList();
        var dirtyPlans = _activityPlanManager.GetDirtyEntities().ToList();
        
        if (!dirtyCharacters.Any() && !dirtySnapshots.Any() && !dirtyPlans.Any())
            return; // æ— éœ€ä¿å­˜
            
        _logger.LogInformation(
            "å¼€å§‹æ‰¹é‡ä¿å­˜ï¼š{Characters} è§’è‰², {Snapshots} å¿«ç…§, {Plans} è®¡åˆ’",
            dirtyCharacters.Count, dirtySnapshots.Count, dirtyPlans.Count
        );
        
        // æ‰¹é‡é™„åŠ åˆ° DbContext
        foreach (var (id, character) in dirtyCharacters)
        {
            db.Characters.Update(character);
        }
        foreach (var (id, snapshot) in dirtySnapshots)
        {
            db.RunningBattleSnapshots.Update(snapshot);
        }
        foreach (var (id, plan) in dirtyPlans)
        {
            db.ActivityPlans.Update(plan);
        }
        
        // å•æ¬¡æäº¤
        await db.SaveChangesAsync(ct);
        
        // æ¸…é™¤ Dirty æ ‡è®°
        _characterManager.ClearDirty(dirtyCharacters.Select(x => x.Id));
        _battleSnapshotManager.ClearDirty(dirtySnapshots.Select(x => x.Id));
        _activityPlanManager.ClearDirty(dirtyPlans.Select(x => x.Id));
        
        _logger.LogInformation("æ‰¹é‡ä¿å­˜å®Œæˆ");
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "æ‰¹é‡ä¿å­˜å¤±è´¥");
        // é‡è¯•é€»è¾‘...
    }
}
```

### 3. å…³é—­æ—¶è®¾ç½®æ‰€æœ‰è§’è‰²ç¦»çº¿

```csharp
private async Task SetAllCharactersOfflineAsync()
{
    using var scope = _scopeFactory.CreateScope();
    var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
    
    var sw = Stopwatch.StartNew();
    
    // æ‰¹é‡æ›´æ–°ï¼ˆä½¿ç”¨ ExecuteUpdateAsync for better performanceï¼‰
    int updatedCount = await db.Characters
        .Where(c => c.IsOnline)
        .ExecuteUpdateAsync(setters => setters
            .SetProperty(c => c.IsOnline, false)
            .SetProperty(c => c.LastSeenAtUtc, DateTime.UtcNow)
        );
    
    sw.Stop();
    
    _logger.LogInformation(
        "å·²å°† {Count} ä¸ªåœ¨çº¿è§’è‰²è®¾ç½®ä¸ºç¦»çº¿ï¼ˆè€—æ—¶ {ElapsedMs}msï¼‰",
        updatedCount, sw.ElapsedMilliseconds
    );
}
```

---

## æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **å¤§å¹…å‡å°‘æ•°æ®åº“å‹åŠ›**ï¼šå†™å…¥æ¬¡æ•°å‡å°‘ 97.6%
2. **æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦**ï¼šAPI å“åº”æ—¶é—´æ”¹å–„ 50-80%
3. **å¢å¼ºå¹¶å‘èƒ½åŠ›**ï¼šæ”¯æŒ 3-5 å€çš„å¹¶å‘æˆ˜æ–—æ•°
4. **æ”¹å–„æ•°æ®å®‰å…¨**ï¼šä¼˜é›…å…³é—­ä¿è¯æ•°æ®å®Œæ•´æ€§
5. **çµæ´»å¯é…ç½®**ï¼šæ‰€æœ‰å‚æ•°å¯é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´

### å®æ–½ä¼˜å…ˆçº§

| é˜¶æ®µ | ä¼˜å…ˆçº§ | æ ¸å¿ƒä»»åŠ¡ | å·¥ä½œé‡ |
|-----|-------|---------|--------|
| ä¸Šç¯‡ | P0 | åŸºç¡€è®¾æ–½å»ºè®¾ | 6-8 å¤© |
| ä¸­ç¯‡ | P1 | é«˜é¢‘æ“ä½œè¿ç§» | 8-12 å¤© |
| ä¸‹ç¯‡ | P2 | ä¼˜åŒ–å’Œå®Œå–„ | 4-6 å¤© |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

âœ… **ç«‹å³å¯åš**ï¼š
1. è¯„å®¡æœ¬æ–¹æ¡ˆï¼Œç¡®è®¤æŠ€æœ¯è·¯çº¿
2. ç¡®å®šå®æ–½æ—¶é—´è¡¨
3. å‡†å¤‡å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ

ğŸ“‹ **çŸ­æœŸè®¡åˆ’**ï¼ˆ1-2 å‘¨ï¼‰ï¼š
1. å¯åŠ¨ä¸Šç¯‡å®æ–½ï¼šå»ºè®¾åŸºç¡€è®¾æ–½
2. ç¼–å†™å•å…ƒæµ‹è¯•
3. è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•

ğŸš€ **ä¸­é•¿æœŸè§„åˆ’**ï¼ˆ3-4 å‘¨ï¼‰ï¼š
1. å®Œæˆä¸­ç¯‡è¿ç§»
2. è¿›è¡Œå‹åŠ›æµ‹è¯•
3. å®Œæˆä¸‹ç¯‡ä¼˜åŒ–å’Œæ–‡æ¡£

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… éœ€æ±‚åˆ†æå®Œæˆ  
**ç­‰å¾…å®¡æ ¸**ï¼šè¯·å®¡é˜…å¹¶åé¦ˆ  
**é¢„æœŸå®¡æ ¸æ—¶é—´**ï¼š1-2 ä¸ªå·¥ä½œæ—¥  
**è”ç³»æ–¹å¼**ï¼šGitHub Issue / Pull Request Comments
