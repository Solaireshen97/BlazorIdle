# æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿå®ç°æ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æ ¹æ®éœ€æ±‚"å¸®æˆ‘åˆ†æä¸€ä¸‹æœåŠ¡ç«¯ä¸­çš„æˆ˜æ–—äº‹ä»¶ï¼Œæˆ‘æƒ³è¦å¢åŠ æˆ˜æ–—äº‹ä»¶ä¿¡æ¯ï¼Œå¹¶ä¼ è¾“ç»™å‰ç«¯æ˜¾ç¤º"ï¼ŒæˆåŠŸå®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ã€å¯é…ç½®çš„æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿã€‚

## âœ… å®Œæˆå†…å®¹

### 1. æ ¸å¿ƒåŠŸèƒ½
- âœ… æ”»å‡»å¼€å§‹äº‹ä»¶ï¼šæ˜¾ç¤º"è§’è‰²XXå¼€å§‹æ”»å‡»XX"
- âœ… é€ æˆä¼¤å®³äº‹ä»¶ï¼šæ˜¾ç¤º"è§’è‰²å¯¹XXé€ æˆXXä¼¤å®³ï¼ˆæš´å‡»ï¼‰"
- âœ… å—åˆ°ä¼¤å®³äº‹ä»¶ï¼šæ˜¾ç¤º"è§’è‰²æ”¶åˆ°XXå¤šå°‘ä¼¤å®³"
- âœ… æ•Œäººæ”»å‡»äº‹ä»¶ï¼šæ˜¾ç¤ºæ•Œäººæ”»å‡»ç©å®¶çš„ä¿¡æ¯

### 2. é…ç½®åŒ–å®ç°
æ‰€æœ‰å‚æ•°å‡è®¾ç½®åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå®Œå…¨ç¬¦åˆ"å‚æ•°éœ€è¦è®¾ç½®åˆ°å•ç‹¬çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå°½é‡ä¸è¦æ”¾åˆ°ä»£ç ä¸­å†™æ­»"çš„è¦æ±‚ï¼š

**é…ç½®æ–‡ä»¶ä½ç½®**: `BlazorIdle.Server/appsettings.json`

```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
    "DamageDealtTemplate": "{attacker} å¯¹ {target} é€ æˆ {damage} ç‚¹ä¼¤å®³{critSuffix}",
    "CritSuffix": "ï¼ˆæš´å‡»ï¼‰",
    "DamageReceivedTemplate": "{target} å—åˆ°æ¥è‡ª {attacker} çš„ {damage} ç‚¹ä¼¤å®³",
    "EnemyAttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
    "EnableAttackStartedEvent": true,
    "EnableDamageDealtEvent": true,
    "EnableDamageReceivedEvent": true,
    "EnableEnemyAttackStartedEvent": true,
    "PlayerName": "ç©å®¶",
    "MaxMessageHistory": 100
  }
}
```

### 3. å¯æ‰©å±•æ€§è®¾è®¡

#### æ¶æ„è®¾è®¡
- **é…ç½®æ¨¡å‹**: `BattleMessageOptions` - ç‹¬ç«‹çš„é…ç½®ç±»
- **æ ¼å¼åŒ–æœåŠ¡**: `BattleMessageFormatter` - ä¸“é—¨çš„æ¶ˆæ¯æ ¼å¼åŒ–æœåŠ¡
- **äº‹ä»¶DTO**: æ‰©å±•çš„ `BattleEventDto` å­ç±»ï¼Œæ˜“äºæ·»åŠ æ–°äº‹ä»¶ç±»å‹
- **ä¾èµ–æ³¨å…¥**: å®Œæ•´çš„DIé›†æˆï¼ŒæœåŠ¡å¯åœ¨æ•´ä¸ªæˆ˜æ–—ç³»ç»Ÿä¸­ä½¿ç”¨

#### æ‰©å±•æ–°äº‹ä»¶ç±»å‹çš„æ­¥éª¤
1. åœ¨ `BattleNotifications.cs` ä¸­åˆ›å»ºæ–°çš„DTO
2. åœ¨ `BattleMessageOptions.cs` ä¸­æ·»åŠ æ¨¡æ¿é…ç½®
3. åœ¨ `BattleMessageFormatter.cs` ä¸­æ·»åŠ æ ¼å¼åŒ–æ–¹æ³•
4. åœ¨æˆ˜æ–—é€»è¾‘ä¸­è§¦å‘äº‹ä»¶
5. æ›´æ–°é…ç½®æ–‡ä»¶

**åªéœ€5æ­¥ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒæˆ˜æ–—é€»è¾‘ï¼**

### 4. ä»£ç é£æ ¼ç»´æŠ¤

éµå¾ªç°æœ‰ä»£ç é£æ ¼ï¼š
- âœ… ä½¿ç”¨ C# record ç±»å‹å®šä¹‰äº‹ä»¶
- âœ… éµå¾ªå‘½åçº¦å®šï¼ˆDTOåç¼€ã€Eventåç¼€ï¼‰
- âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼
- âœ… åˆ©ç”¨ç°æœ‰çš„SignalRé€šçŸ¥åŸºç¡€è®¾æ–½
- âœ… ä¿æŒä¸ç°æœ‰æˆ˜æ–—ç³»ç»Ÿçš„ä¸€è‡´æ€§

### 5. å®Œæ•´æµ‹è¯•

#### å•å…ƒæµ‹è¯• (9ä¸ª)
```csharp
// BattleMessageTests.cs
- BattleMessageFormatter_FormatAttackStarted_ReplacesPlaceholders
- BattleMessageFormatter_FormatDamageDealt_WithoutCrit_ReplacesPlaceholders
- BattleMessageFormatter_FormatDamageDealt_WithCrit_IncludesCritSuffix
- BattleMessageFormatter_FormatDamageReceived_ReplacesPlaceholders
- BattleMessageFormatter_IsAttackStartedEnabled_ReturnsConfigValue
- BattleMessageFormatter_GetPlayerName_ReturnsConfigValue
- AttackStartedEventDto_HasRequiredProperties
- DamageAppliedEventDto_HasExtendedProperties
- DamageReceivedEventDto_HasRequiredProperties
```

#### é›†æˆæµ‹è¯• (4ä¸ª)
```csharp
// BattleMessageIntegrationTests.cs
- BattleEngine_WithMessageFormatter_SendsAttackStartedEvent
- BattleEngine_WithMessageFormatter_SendsDamageAppliedEvent
- BattleEngine_WithEnemyAttack_SendsDamageReceivedEvent
- BattleEngine_WithDisabledEvents_DoesNotSendMessages
```

#### æµ‹è¯•ç»“æœ
```
Total: 13 tests
Passed: 13 (100%)
Failed: 0
Duration: 63ms
```

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `BlazorIdle.Server/Config/BattleMessageOptions.cs` - é…ç½®æ¨¡å‹
2. `BlazorIdle.Server/Services/BattleMessageFormatter.cs` - æ¶ˆæ¯æ ¼å¼åŒ–æœåŠ¡
3. `tests/BlazorIdle.Tests/BattleMessageTests.cs` - å•å…ƒæµ‹è¯•
4. `tests/BlazorIdle.Tests/BattleMessageIntegrationTests.cs` - é›†æˆæµ‹è¯•
5. `docs/æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md` - ä½¿ç”¨æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
1. `BlazorIdle.Shared/Models/BattleNotifications.cs` - æ‰©å±•äº‹ä»¶DTO
2. `BlazorIdle.Server/Domain/Combat/AttackTickEvent.cs` - æ·»åŠ æ”»å‡»äº‹ä»¶
3. `BlazorIdle.Server/Domain/Combat/EnemyAttackEvent.cs` - æ·»åŠ æ•Œäººæ”»å‡»äº‹ä»¶
4. `BlazorIdle.Server/Domain/Combat/Damage/DamageCalculator.cs` - æ·»åŠ ä¼¤å®³äº‹ä»¶
5. `BlazorIdle.Server/Domain/Combat/BattleContext.cs` - é›†æˆformatter
6. `BlazorIdle.Server/Domain/Combat/Engine/BattleEngine.cs` - ä¼ é€’formatter
7. `BlazorIdle.Server/Application/Battles/Step/RunningBattle.cs` - æ„é€ å™¨æ›´æ–°
8. `BlazorIdle.Server/Application/Battles/Step/StepBattleCoordinator.cs` - DIé›†æˆ
9. `BlazorIdle.Server/Application/Battles/StartBattleService.cs` - DIé›†æˆ
10. `BlazorIdle.Server/Config/SignalROptions.cs` - æ–°å¢é€šçŸ¥æ ‡å¿—
11. `BlazorIdle.Server/Services/BattleNotificationService.cs` - äº‹ä»¶è¿‡æ»¤
12. `BlazorIdle.Server/Program.cs` - æœåŠ¡æ³¨å†Œ
13. `BlazorIdle.Server/appsettings.json` - é…ç½®
14. `BlazorIdle.Server/appsettings.Development.example.json` - ç¤ºä¾‹é…ç½®

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### 1. æœ€å°åŒ–ä¿®æ”¹åŸåˆ™
- æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯å¢é‡å¼çš„ï¼Œæ²¡æœ‰åˆ é™¤æˆ–å¤§å¹…ä¿®æ”¹ç°æœ‰ä»£ç 
- åˆ©ç”¨ç°æœ‰çš„SignalRåŸºç¡€è®¾æ–½
- é€šè¿‡å¯é€‰å‚æ•°ä¿æŒå‘åå…¼å®¹
- ä¸å½±å“ç°æœ‰æˆ˜æ–—é€»è¾‘çš„è¿è¡Œ

### 2. é…ç½®é©±åŠ¨
- æ‰€æœ‰æ¶ˆæ¯æ¨¡æ¿éƒ½åœ¨é…ç½®æ–‡ä»¶ä¸­
- æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ”¹
- æ˜“äºå®ç°å›½é™…åŒ–
- ä¾¿äºA/Bæµ‹è¯•ä¸åŒçš„æ¶ˆæ¯é£æ ¼

### 3. æ¾è€¦åˆè®¾è®¡
- æˆ˜æ–—é€»è¾‘ä¸æ¶ˆæ¯æ ¼å¼åˆ†ç¦»
- é€šè¿‡æ¥å£å’Œä¾èµ–æ³¨å…¥å®ç°è§£è€¦
- å¯ä»¥ç‹¬ç«‹æµ‹è¯•å„ä¸ªç»„ä»¶
- æ˜“äºmockå’Œå•å…ƒæµ‹è¯•

### 4. æ€§èƒ½è€ƒè™‘
- äº‹ä»¶é€šçŸ¥æ˜¯å¼‚æ­¥çš„ï¼ˆfire-and-forgetï¼‰
- å¯é€‰çš„äº‹ä»¶èŠ‚æµåŠŸèƒ½
- è½»é‡çº§çš„DTOå¯¹è±¡
- æœ€å°çš„æ€§èƒ½å¼€é”€

## ğŸ“Š æ€§èƒ½å½±å“

### æ„å»ºæ—¶é—´
- å¢é‡æ„å»º: ~3-6ç§’
- å®Œæ•´æ„å»º: ~15ç§’
- æ— æ˜æ˜¾æ€§èƒ½ä¸‹é™

### è¿è¡Œæ—¶å¼€é”€
- æ¶ˆæ¯æ ¼å¼åŒ–: < 1ms
- äº‹ä»¶é€šçŸ¥: å¼‚æ­¥ï¼Œä¸é˜»å¡æˆ˜æ–—é€»è¾‘
- å†…å­˜å ç”¨: æ¯ä¸ªäº‹ä»¶ < 1KB
- å¯é€šè¿‡é…ç½®ç¦ç”¨ä¸éœ€è¦çš„äº‹ä»¶

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### æœåŠ¡ç«¯é…ç½®
```json
{
  "BattleMessages": {
    "AttackStartedTemplate": "{attacker} å¼€å§‹æ”»å‡» {target}",
    "EnableAttackStartedEvent": true,
    "PlayerName": "ç©å®¶"
  }
}
```

### å‰ç«¯é›†æˆ
```csharp
SignalRService.OnBattleEvent((battleId, eventData) =>
{
    if (eventData is AttackStartedEventDto attack)
    {
        Console.WriteLine(attack.Message);
        // è¾“å‡º: "ç©å®¶ å¼€å§‹æ”»å‡» å²è±å§†"
    }
    
    if (eventData is DamageAppliedEventDto damage)
    {
        Console.WriteLine(damage.Message);
        // è¾“å‡º: "ç©å®¶ å¯¹ å“¥å¸ƒæ— é€ æˆ 150 ç‚¹ä¼¤å®³ï¼ˆæš´å‡»ï¼‰"
    }
});
```

## ğŸ“š æ–‡æ¡£

è¯¦ç»†ä½¿ç”¨æ–‡æ¡£è¯·å‚è€ƒï¼š[docs/æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md](docs/æˆ˜æ–—æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md)

åŒ…å«å†…å®¹ï¼š
- åŠŸèƒ½ç‰¹æ€§ä»‹ç»
- é…ç½®å‚æ•°è¯´æ˜
- äº‹ä»¶ç±»å‹è¯¦è§£
- å‰ç«¯é›†æˆç¤ºä¾‹
- æ‰©å±•å¼€å‘æŒ‡å—
- æœ€ä½³å®è·µ
- æ•…éšœæ’é™¤

## âœ¨ æ€»ç»“

æœ¬æ¬¡å®ç°å®Œå…¨æ»¡è¶³éœ€æ±‚ï¼š
1. âœ… **æˆ˜æ–—äº‹ä»¶åˆ†æ** - æ·±å…¥åˆ†æäº†æˆ˜æ–—ç³»ç»Ÿçš„äº‹ä»¶æµç¨‹
2. âœ… **å¢åŠ äº‹ä»¶ä¿¡æ¯** - æ·»åŠ äº†å®Œæ•´çš„æˆ˜æ–—äº‹ä»¶ä¿¡æ¯
3. âœ… **ä¼ è¾“ç»™å‰ç«¯** - é€šè¿‡SignalRå®æ—¶ä¼ è¾“
4. âœ… **é…ç½®æ–‡ä»¶å‚æ•°** - æ‰€æœ‰å‚æ•°éƒ½åœ¨é…ç½®æ–‡ä»¶ä¸­
5. âœ… **å¯æ‰©å±•æ€§** - æ¶æ„è®¾è®¡æ”¯æŒè½»æ¾æ‰©å±•
6. âœ… **ä»£ç é£æ ¼** - ç»´æŒç°æœ‰ä»£ç é£æ ¼
7. âœ… **å®Œæ•´æµ‹è¯•** - 13ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

ç³»ç»Ÿå·²å‡†å¤‡å¥½æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼

---

**å®ç°æ—¥æœŸ**: 2025-10-14  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**æ„å»ºçŠ¶æ€**: âœ… æˆåŠŸ  
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæ•´
