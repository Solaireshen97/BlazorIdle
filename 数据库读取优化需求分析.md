# BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ– - éœ€æ±‚åˆ†æä¸æ–¹æ¡ˆè®¾è®¡

**é¡¹ç›®**: BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-19  
**çŠ¶æ€**: éœ€æ±‚åˆ†æå®Œæˆ - å¾…å®¡æ ¸

---

## ğŸ“‹ ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [å½“å‰å®æ–½çŠ¶æ€å›é¡¾](#å½“å‰å®æ–½çŠ¶æ€å›é¡¾)
3. [æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ](#æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ)
4. [é—®é¢˜è¯Šæ–­ä¸ä¼˜åŒ–ç›®æ ‡](#é—®é¢˜è¯Šæ–­ä¸ä¼˜åŒ–ç›®æ ‡)
5. [ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡](#ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡)
6. [æŠ€æœ¯æ¶æ„è®¾è®¡](#æŠ€æœ¯æ¶æ„è®¾è®¡)
7. [é…ç½®æ–¹æ¡ˆè®¾è®¡](#é…ç½®æ–¹æ¡ˆè®¾è®¡)
8. [é£é™©è¯„ä¼°ä¸åº”å¯¹](#é£é™©è¯„ä¼°ä¸åº”å¯¹)
9. [æ€§èƒ½é¢„æœŸ](#æ€§èƒ½é¢„æœŸ)

---

## æ‰§è¡Œæ‘˜è¦

### èƒŒæ™¯

BlazorIdle é¡¹ç›®å·²å®Œæˆæ•°æ®åº“**å†™å…¥æ“ä½œ**çš„ä¼˜åŒ–ï¼ˆPhase 1-3ï¼‰ï¼Œé€šè¿‡å†…å­˜ç¼“å†²æœºåˆ¶æˆåŠŸå°†æ•°æ®åº“å†™å…¥æ¬¡æ•°å‡å°‘äº† **97.9%**ã€‚ä½†æ˜¯ï¼Œæ•°æ®åº“**è¯»å–æ“ä½œ**ä»ç„¶é¢‘ç¹ä¸”ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **é¢‘ç¹çš„æ•°æ®åº“æŸ¥è¯¢**ï¼šæ¯æ¬¡éœ€è¦æ•°æ®éƒ½ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
2. **é‡å¤è¯»å–ç›¸åŒæ•°æ®**ï¼šç›¸åŒçš„å®ä½“åœ¨çŸ­æ—¶é—´å†…è¢«å¤šæ¬¡æŸ¥è¯¢
3. **æ€§èƒ½ç“¶é¢ˆ**ï¼šæ•°æ®åº“ I/O æˆä¸ºç³»ç»Ÿå“åº”é€Ÿåº¦çš„é™åˆ¶å› ç´ 
4. **ç¼“å­˜ç¼ºå¤±**ï¼šå½“å‰ MemoryStateManager ä»…æœåŠ¡äºå†™å…¥ä¼˜åŒ–ï¼Œè¯»å–è·¯å¾„æœªå……åˆ†åˆ©ç”¨

### æ ¸å¿ƒéœ€æ±‚

æ ¹æ®é¡¹ç›®éœ€æ±‚ï¼š
> "å„é¡¹ä¿¡æ¯ä¸åº”è¯¥å®æ—¶è¯»å–æ•°æ®åº“çš„éƒ¨åˆ†ï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­æ“ä½œï¼Œæˆ‘çš„æƒ³æ³•æ˜¯éœ€è¦è¯»å–çš„ä¿¡æ¯åœ¨å†…å­˜ä¸­æ²¡æœ‰çš„æ—¶å€™æ‰è¯»å–æ•°æ®åº“"

éœ€è¦å®ç°**å†…å­˜ä¼˜å…ˆçš„è¯»å–ç­–ç•¥**ï¼š
1. **å†…å­˜ä¼˜å…ˆ**ï¼šæ‰€æœ‰è¯»å–æ“ä½œå…ˆæŸ¥å†…å­˜ç¼“å­˜
2. **æ‡’åŠ è½½**ï¼šå†…å­˜æœªå‘½ä¸­æ—¶æ‰ä»æ•°æ®åº“åŠ è½½
3. **æ™ºèƒ½ç¼“å­˜**ï¼šæ ¹æ®è®¿é—®æ¨¡å¼è‡ªåŠ¨ç®¡ç†ç¼“å­˜
4. **é…ç½®åŒ–**ï¼šæ‰€æœ‰å‚æ•°å¯é…ç½®ï¼Œä¸å†™æ­»åœ¨ä»£ç ä¸­
5. **æ— ç¼é›†æˆ**ï¼šä¿æŒç°æœ‰ Repository æ¥å£ä¸å˜

### ä¼˜åŒ–ç›®æ ‡

1. **å‡å°‘æ•°æ®åº“è¯»å–**ï¼šé¢„æœŸå‡å°‘ 70-90% çš„æ•°æ®åº“æŸ¥è¯¢
2. **æå‡å“åº”é€Ÿåº¦**ï¼šAPI å“åº”æ—¶é—´æ”¹å–„ 30-50%
3. **é™ä½ I/O å‹åŠ›**ï¼šæ•°æ®åº“è´Ÿè½½é™ä½ 60-80%
4. **æé«˜å¹¶å‘èƒ½åŠ›**ï¼šæ”¯æŒæ›´å¤šå¹¶å‘ç”¨æˆ·
5. **ä¿æŒæ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿è¯»å–åˆ°æœ€æ–°çš„æ•°æ®

### æ–¹æ¡ˆæ¦‚è¿°

é‡‡ç”¨**ç»Ÿä¸€çš„å†…å­˜ä¼˜å…ˆè¯»å–æ¶æ„**ï¼Œåœ¨ç°æœ‰ MemoryStateManager åŸºç¡€ä¸Šæ‰©å±•ï¼š

```
è¯»å–è¯·æ±‚ â†’ Repository â†’ MemoryStateManager
                            â†“ (ç¼“å­˜å‘½ä¸­)
                         è¿”å›å†…å­˜æ•°æ®
                            â†“ (ç¼“å­˜æœªå‘½ä¸­)
                         æŸ¥è¯¢æ•°æ®åº“ â†’ åŠ è½½åˆ°å†…å­˜ â†’ è¿”å›æ•°æ®
```

---

## å½“å‰å®æ–½çŠ¶æ€å›é¡¾

### å·²å®Œæˆçš„å†™å…¥ä¼˜åŒ–

#### Phase 1: åŸºç¡€è®¾æ–½ âœ…
- âœ… MemoryStateManager<T> - å†…å­˜çŠ¶æ€ç®¡ç†å™¨
- âœ… PersistenceCoordinator - æ‰¹é‡ä¿å­˜åè°ƒå™¨
- âœ… EnhancedShutdownManager - ä¼˜é›…å…³é—­ç®¡ç†
- âœ… é…ç½®ç³»ç»Ÿ (PersistenceOptions, MemoryCacheOptions, ShutdownOptions)

#### Phase 2: é«˜é¢‘å†™å…¥ä¼˜åŒ– âœ…
- âœ… è§’è‰²å¿ƒè·³ (CharactersController.Heartbeat)
- âœ… æˆ˜æ–—å¿«ç…§ (StepBattleSnapshotService)
- âœ… æ´»åŠ¨è®¡åˆ’ (ActivityPlanRepository)

#### Phase 3: ç›‘æ§ä¸è¯Šæ–­ âœ…
- âœ… DatabaseMetricsCollector - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- âœ… DatabaseHealthController - å¥åº·æ£€æŸ¥ API
- âœ… MonitoringOptions - ç›‘æ§é…ç½®

### å½“å‰å†™å…¥ä¼˜åŒ–æˆæœ

| æ“ä½œç±»å‹ | ä¼˜åŒ–å‰ (æ¬¡/å°æ—¶) | ä¼˜åŒ–å (æ¬¡/å°æ—¶) | å‡å°‘æ¯”ä¾‹ |
|---------|----------------|----------------|---------|
| è§’è‰²å¿ƒè·³ | 18,000 | 1,200 | 93.3% |
| æˆ˜æ–—å¿«ç…§ | 72,000 | 600 | 99.2% |
| æ´»åŠ¨è®¡åˆ’ | 3,000 | 120 | 96.0% |
| **æ€»è®¡** | **93,000** | **1,920** | **97.9%** |

### ç°æœ‰åŸºç¡€è®¾æ–½å¯å¤ç”¨æ€§

âœ… **MemoryStateManager<T>** å·²å…·å¤‡è¯»å–èƒ½åŠ›ï¼š
```csharp
public async Task<T?> GetAsync(Guid id, CancellationToken ct = default)
{
    // å…ˆæŸ¥å†…å­˜
    if (_store.TryGetValue(id, out var entity))
    {
        UpdateAccessTime(id);  // LRU æ”¯æŒ
        return entity;
    }
    
    // å†…å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
    entity = await db.Set<T>().FindAsync(new object[] { id }, ct);
    
    if (entity != null)
    {
        _store.TryAdd(id, entity);  // è‡ªåŠ¨ç¼“å­˜
        UpdateAccessTime(id);
    }
    
    return entity;
}
```

**å…³é”®å‘ç°**ï¼š
- âœ… å†…å­˜ä¼˜å…ˆè¯»å–é€»è¾‘å·²å®ç°
- âœ… LRU ç¼“å­˜æ·˜æ±°ç­–ç•¥å·²å°±ç»ª
- âœ… çº¿ç¨‹å®‰å…¨ä¿è¯
- âš ï¸ **ä½†æœªè¢« Repository å±‚å……åˆ†åˆ©ç”¨**

---

## æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ

### å½“å‰è¯»å–æ“ä½œç»Ÿè®¡

é€šè¿‡ä»£ç å®¡æŸ¥ï¼Œè¯†åˆ«å‡ºä»¥ä¸‹ä¸»è¦æ•°æ®åº“è¯»å–åœºæ™¯ï¼š

#### 1. è§’è‰²æ•°æ®è¯»å– (Character)

**CharacterRepository.GetAsync**
```csharp
// ä½ç½®ï¼šInfrastructure/Persistence/Repositories/CharacterRepository.cs
public Task<Character?> GetAsync(Guid id, CancellationToken ct = default) =>
    _db.Characters.FirstOrDefaultAsync(c => c.Id == id, ct);
```

**è°ƒç”¨åœºæ™¯**ï¼š
- API ç«¯ç‚¹éªŒè¯è§’è‰²å­˜åœ¨æ€§
- æˆ˜æ–—æœåŠ¡åŠ è½½è§’è‰²å±æ€§
- è£…å¤‡æœåŠ¡æ£€æŸ¥è§’è‰²è£…å¤‡
- æ´»åŠ¨æœåŠ¡æ£€æŸ¥è§’è‰²çŠ¶æ€

**ä¼°ç®—é¢‘ç‡**ï¼šæ¯ä¸ªåœ¨çº¿ç©å®¶æ¯åˆ†é’Ÿ 5-20 æ¬¡ â†’ **300-1,200 æ¬¡/å°æ—¶/ç©å®¶**

#### 2. æˆ˜æ–—å¿«ç…§è¯»å– (RunningBattleSnapshotRecord)

**è°ƒç”¨åœºæ™¯**ï¼š
- å®¢æˆ·ç«¯è¯·æ±‚æˆ˜æ–—çŠ¶æ€åˆ·æ–°
- æˆ˜æ–—æ¢å¤ï¼ˆç©å®¶é‡æ–°è¿æ¥ï¼‰
- ç¦»çº¿æ”¶ç›Šè®¡ç®—

**ä¼°ç®—é¢‘ç‡**ï¼šæ¯ä¸ªæ´»è·ƒæˆ˜æ–—æ¯ç§’ 1-2 æ¬¡ â†’ **3,600-7,200 æ¬¡/å°æ—¶/æˆ˜æ–—**

#### 3. æ´»åŠ¨è®¡åˆ’è¯»å– (ActivityPlan)

**ActivityPlanRepository.GetAsync**
```csharp
public Task<ActivityPlan?> GetAsync(Guid id, CancellationToken ct = default) =>
    _db.ActivityPlans.FirstOrDefaultAsync(p => p.Id == id, ct);
```

**è°ƒç”¨åœºæ™¯**ï¼š
- æ´»åŠ¨çŠ¶æ€æ£€æŸ¥
- æ´»åŠ¨åˆ‡æ¢é€»è¾‘
- è¿›åº¦æŸ¥è¯¢

**ä¼°ç®—é¢‘ç‡**ï¼šæ¯ä¸ªè§’è‰²æ¯åˆ†é’Ÿ 2-5 æ¬¡ â†’ **120-300 æ¬¡/å°æ—¶/è§’è‰²**

#### 4. è£…å¤‡æ•°æ®è¯»å– (GearInstance)

**GearInstanceRepository æ–¹æ³•**ï¼š
- `GetByIdAsync` - æŒ‰ ID æŸ¥è¯¢
- `GetByCharacterIdAsync` - æŸ¥è¯¢è§’è‰²æ‰€æœ‰è£…å¤‡
- `GetEquippedBySlotAsync` - æŸ¥è¯¢å·²è£…å¤‡ç‰©å“

**è°ƒç”¨åœºæ™¯**ï¼š
- è£…å¤‡ç®¡ç†ç•Œé¢åŠ è½½
- æˆ˜æ–—å±æ€§è®¡ç®—
- è£…å¤‡æ“ä½œï¼ˆç©¿æˆ´ã€å¸ä¸‹ã€æ¯”è¾ƒï¼‰

**ä¼°ç®—é¢‘ç‡**ï¼šæ¯ä¸ªè§’è‰²æ¯æ¬¡æ“ä½œ 3-10 æ¬¡æŸ¥è¯¢ â†’ **100-500 æ¬¡/å°æ—¶/è§’è‰²**

#### 5. é…ç½®æ•°æ®è¯»å–ï¼ˆä½é¢‘ä½†é‡å¤ï¼‰

**GearDefinitionRepository, AffixRepository, GearSetRepository**
```csharp
public Task<GearDefinition?> GetByIdAsync(Guid id, CancellationToken ct = default) =>
    _db.GearDefinitions.FirstOrDefaultAsync(g => g.Id == id, ct);

public Task<List<Affix>> GetAllAsync(CancellationToken ct = default) =>
    _db.Affixes.ToListAsync(ct);
```

**è°ƒç”¨åœºæ™¯**ï¼š
- è£…å¤‡ç”Ÿæˆ
- å±æ€§è®¡ç®—
- UI æ˜¾ç¤º

**ç‰¹ç‚¹**ï¼š
- æ•°æ®ç›¸å¯¹é™æ€ï¼ˆé…ç½®æ•°æ®ï¼‰
- è¢«å¤§é‡é‡å¤è¯»å–
- **æœ€é€‚åˆç¼“å­˜**

**ä¼°ç®—é¢‘ç‡**ï¼šæ¯ç§é…ç½®æ•°æ®æ¯åˆ†é’Ÿè¢«æŸ¥è¯¢ 10-50 æ¬¡

### è¯»å–æ“ä½œæ€»è®¡

ä»¥ **100 ä¸ªåœ¨çº¿ç©å®¶ + 10 ä¸ªæ´»è·ƒæˆ˜æ–—** ä¸ºåŸºå‡†ï¼š

| æ•°æ®ç±»å‹ | ä¼°ç®—é¢‘ç‡ (æ¬¡/å°æ—¶) | æ˜¯å¦é€‚åˆç¼“å­˜ | ä¼˜å…ˆçº§ |
|---------|-------------------|-------------|--------|
| Character | 30,000 - 120,000 | âœ… æ˜¯ | ğŸ”¥ é«˜ |
| BattleSnapshot | 36,000 - 72,000 | âœ… æ˜¯ | ğŸ”¥ é«˜ |
| ActivityPlan | 12,000 - 30,000 | âœ… æ˜¯ | ğŸ”¥ é«˜ |
| GearInstance | 10,000 - 50,000 | âœ… æ˜¯ | âš ï¸ ä¸­ |
| GearDefinition | 5,000 - 20,000 | âœ…âœ… å¼ºçƒˆæ¨è | ğŸ”¥ é«˜ |
| Affix | 3,000 - 10,000 | âœ…âœ… å¼ºçƒˆæ¨è | ğŸ”¥ é«˜ |
| GearSet | 1,000 - 3,000 | âœ…âœ… å¼ºçƒˆæ¨è | âš ï¸ ä¸­ |
| **æ€»è®¡** | **97,000 - 305,000** | - | - |

**å…³é”®å‘ç°**ï¼š
- ğŸ“Š æ¯å°æ—¶çº¦ **10ä¸‡-30ä¸‡æ¬¡** æ•°æ®åº“è¯»å–
- ğŸ¯ **é…ç½®æ•°æ®**ï¼ˆGearDefinition, Affix, GearSetï¼‰é‡å¤è¯»å–ç‡æé«˜
- ğŸ¯ **è¿è¡Œæ€æ•°æ®**ï¼ˆCharacter, BattleSnapshot, ActivityPlanï¼‰å·²æœ‰éƒ¨åˆ†åœ¨ MemoryStateManager ä¸­

---

## é—®é¢˜è¯Šæ–­ä¸ä¼˜åŒ–ç›®æ ‡

### ä¸»è¦é—®é¢˜

#### 1. Repository å±‚æœªåˆ©ç”¨ MemoryStateManager âš ï¸âš ï¸âš ï¸

**é—®é¢˜æè¿°**ï¼š
- MemoryStateManager å·²å®ç°å†…å­˜ä¼˜å…ˆè¯»å–
- ä½† Repository ç›´æ¥æŸ¥è¯¢ DbContext
- **å†™å…¥**ä½¿ç”¨ MemoryStateManagerï¼Œ**è¯»å–**ç›´æ¥è®¿é—®æ•°æ®åº“
- å¯¼è‡´æ•°æ®ä¸ä¸€è‡´é£é™©å’Œæ€§èƒ½æµªè´¹

**ç¤ºä¾‹**ï¼š
```csharp
// CharacterRepository.GetAsync - å½“å‰å®ç°
public Task<Character?> GetAsync(Guid id, CancellationToken ct = default) =>
    _db.Characters.FirstOrDefaultAsync(c => c.Id == id, ct);  // âŒ ç›´æ¥æŸ¥æ•°æ®åº“

// MemoryStateManager.GetAsync - å·²å­˜åœ¨ä½†æœªè¢«ä½¿ç”¨
public async Task<T?> GetAsync(Guid id, CancellationToken ct = default)
{
    if (_store.TryGetValue(id, out var entity))
        return entity;  // âœ… å†…å­˜å‘½ä¸­
    // ... æ•°æ®åº“åŠ è½½é€»è¾‘
}
```

#### 2. é…ç½®æ•°æ®ç¼ºå°‘ä¸“ç”¨ç¼“å­˜ âš ï¸âš ï¸

**é—®é¢˜æè¿°**ï¼š
- GearDefinition, Affix, GearSet ç­‰é…ç½®æ•°æ®åŸºæœ¬ä¸å˜
- å´æ¯æ¬¡éƒ½ä»æ•°æ®åº“æŸ¥è¯¢
- æ²¡æœ‰åº”ç”¨çº§ç¼“å­˜

**å½±å“**ï¼š
- å¤§é‡æ— æ„ä¹‰çš„é‡å¤æŸ¥è¯¢
- æ•°æ®åº“ I/O æµªè´¹

#### 3. åˆ—è¡¨æŸ¥è¯¢å’Œå¤æ‚æŸ¥è¯¢æœªä¼˜åŒ– âš ï¸

**é—®é¢˜æè¿°**ï¼š
- `GetByCharacterIdAsync(Guid characterId)` - æŸ¥è¯¢è§’è‰²çš„æ‰€æœ‰è£…å¤‡
- `GetEquippedBySlotAsync(Guid characterId, EquipmentSlot slot)` - æ¡ä»¶æŸ¥è¯¢
- è¿™ç±»æŸ¥è¯¢æ— æ³•ç›´æ¥ç”¨ç®€å•çš„ ID ç¼“å­˜

**éœ€è¦**ï¼š
- æŸ¥è¯¢ç»“æœç¼“å­˜
- å¤±æ•ˆç­–ç•¥

#### 4. æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜ âš ï¸

**é—®é¢˜æè¿°**ï¼š
- å†™å…¥èµ°å†…å­˜ç¼“å†²ï¼ˆå»¶è¿Ÿä¿å­˜ï¼‰
- è¯»å–ç›´æ¥æŸ¥æ•°æ®åº“
- å¯èƒ½è¯»åˆ°"æ—§"æ•°æ®ï¼ˆæœªåŠæ—¶ä¿å­˜çš„æ›´æ–°ï¼‰

**ç¤ºä¾‹åœºæ™¯**ï¼š
```
1. ç”¨æˆ·è£…å¤‡ç‰©å“ â†’ æ›´æ–° MemoryStateManagerï¼ˆDirtyï¼Œæœªä¿å­˜ï¼‰
2. ç«‹å³æŸ¥è¯¢è£…å¤‡åˆ—è¡¨ â†’ ç›´æ¥æŸ¥æ•°æ®åº“ â†’ è¯»åˆ°æ—§æ•°æ®ï¼ˆæœªè£…å¤‡ï¼‰
3. ç”¨æˆ·çœ‹åˆ°è£…å¤‡å¤±è´¥
```

### ä¼˜åŒ–ç›®æ ‡ï¼ˆè¯¦ç»†ï¼‰

#### ç›®æ ‡ 1ï¼šç»Ÿä¸€è¯»å†™è·¯å¾„ ğŸ¯

**è¦æ±‚**ï¼š
- Repository è¯»å†™éƒ½ä½¿ç”¨ MemoryStateManager
- ä¿è¯è¯»å†™ä¸€è‡´æ€§
- é¿å…"è¯»æ—§æ•°æ®"é—®é¢˜

**æœŸæœ›æ•ˆæœ**ï¼š
- æ•°æ®ä¸€è‡´æ€§é—®é¢˜è§£å†³
- è¯»å–æ€§èƒ½æå‡ï¼ˆå¤§éƒ¨åˆ†å‘½ä¸­å†…å­˜ï¼‰

#### ç›®æ ‡ 2ï¼šé…ç½®æ•°æ®å…¨å±€ç¼“å­˜ ğŸ¯

**è¦æ±‚**ï¼š
- GearDefinition, Affix, GearSet ç­‰é…ç½®æ•°æ®
- åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½åˆ°å†…å­˜
- ä½¿ç”¨ç‹¬ç«‹çš„é…ç½®ç¼“å­˜æœåŠ¡

**æœŸæœ›æ•ˆæœ**ï¼š
- é…ç½®æ•°æ®è¯»å–å‡å°‘ **95%+**
- å‡ ä¹é›¶æ•°æ®åº“æŸ¥è¯¢

#### ç›®æ ‡ 3ï¼šæ”¯æŒå¤æ‚æŸ¥è¯¢ç¼“å­˜ ğŸ¯

**è¦æ±‚**ï¼š
- æ”¯æŒåˆ—è¡¨æŸ¥è¯¢ç»“æœç¼“å­˜
- æ”¯æŒæ¡ä»¶æŸ¥è¯¢ç¼“å­˜
- æ™ºèƒ½å¤±æ•ˆç­–ç•¥

**æœŸæœ›æ•ˆæœ**ï¼š
- åˆ—è¡¨æŸ¥è¯¢å‡å°‘ **60-80%**

#### ç›®æ ‡ 4ï¼šå®Œå…¨é…ç½®åŒ– ğŸ¯

**è¦æ±‚**ï¼š
- æ‰€æœ‰ç¼“å­˜å‚æ•°åœ¨é…ç½®æ–‡ä»¶
- æ”¯æŒåˆ†å®ä½“ç±»å‹é…ç½®
- è¿è¡Œæ—¶å¯è°ƒæ•´

**æœŸæœ›æ•ˆæœ**ï¼š
- æ˜“äºè°ƒä¼˜
- ä¸åŒç¯å¢ƒå·®å¼‚åŒ–é…ç½®

#### ç›®æ ‡ 5ï¼šç›‘æ§ä¸è¯Šæ–­ ğŸ¯

**è¦æ±‚**ï¼š
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- è¯»å–æ€§èƒ½æŒ‡æ ‡
- å¤±æ•ˆé¢‘ç‡ç›‘æ§

**æœŸæœ›æ•ˆæœ**ï¼š
- å¯è§‚æµ‹æ€§
- ä¼˜åŒ–ä¾æ®

---

## ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚ (Controllers/Services)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Repository å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Character    â”‚  â”‚ BattleSnapshotâ”‚  â”‚ ActivityPlan â”‚      â”‚
â”‚  â”‚ Repository   â”‚  â”‚ Repository    â”‚  â”‚ Repository   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                   â”‚
          â†“                  â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç»Ÿä¸€ç¼“å­˜å±‚ (Cache Abstraction)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         ReadThroughCacheManager<T>                    â”‚  â”‚
â”‚  â”‚  - å†…å­˜ä¼˜å…ˆè¯»å–                                         â”‚  â”‚
â”‚  â”‚  - è‡ªåŠ¨åŠ è½½ç¼ºå¤±æ•°æ®                                      â”‚  â”‚
â”‚  â”‚  - LRU æ·˜æ±°                                            â”‚  â”‚
â”‚  â”‚  - æŸ¥è¯¢ç»“æœç¼“å­˜                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                       â”‚
          â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MemoryStateManager<T> â”‚              â”‚ConfigurationCache    â”‚
â”‚ (è¿è¡Œæ€æ•°æ®)          â”‚              â”‚ (é™æ€é…ç½®æ•°æ®)        â”‚
â”‚ - Character          â”‚              â”‚ - GearDefinition    â”‚
â”‚ - BattleSnapshot     â”‚              â”‚ - Affix             â”‚
â”‚ - ActivityPlan       â”‚              â”‚ - GearSet           â”‚
â”‚ - GearInstance       â”‚              â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                     â”‚
           â†“                                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®åº“å±‚ (GameDbContext)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 1. ReadThroughCacheManager<T>

**èŒè´£**ï¼š
- ç»Ÿä¸€çš„è¯»å–ç¼“å­˜ç®¡ç†å™¨
- å°è£…"å…ˆæŸ¥å†…å­˜ï¼Œæœªå‘½ä¸­å†æŸ¥æ•°æ®åº“"é€»è¾‘
- æ”¯æŒå•ä¸ªå®ä½“å’Œåˆ—è¡¨æŸ¥è¯¢
- è‡ªåŠ¨å¤±æ•ˆç®¡ç†

**æ¥å£å®šä¹‰**ï¼š
```csharp
public interface IReadThroughCacheManager<T> where T : class, IEntity
{
    // å•å®ä½“è¯»å–ï¼ˆå†…å­˜ä¼˜å…ˆï¼‰
    Task<T?> GetByIdAsync(Guid id, CancellationToken ct = default);
    
    // åˆ—è¡¨æŸ¥è¯¢ï¼ˆå¸¦ç¼“å­˜ï¼‰
    Task<List<T>> GetListAsync(
        Expression<Func<T, bool>> predicate,
        string cacheKey,
        CancellationToken ct = default);
    
    // æ‰‹åŠ¨æ·»åŠ /æ›´æ–°ç¼“å­˜
    void AddOrUpdate(T entity);
    
    // æ‰‹åŠ¨å¤±æ•ˆ
    void Invalidate(Guid id);
    void InvalidateList(string cacheKey);
    void InvalidateAll();
    
    // ç»Ÿè®¡
    CacheStatistics GetStatistics();
}
```

**å®ç°è¦ç‚¹**ï¼š
- å†…éƒ¨ä½¿ç”¨ MemoryStateManager<T> å­˜å‚¨å•å®ä½“
- ä½¿ç”¨ IMemoryCache å­˜å‚¨æŸ¥è¯¢ç»“æœ
- å¤±æ•ˆç­–ç•¥ï¼š
  - å•å®ä½“å¤±æ•ˆï¼šå®ä½“æ›´æ–°/åˆ é™¤æ—¶
  - åˆ—è¡¨å¤±æ•ˆï¼šç›¸å…³å®ä½“å˜æ›´æ—¶
  - å®šæ—¶å¤±æ•ˆï¼šé…ç½® TTL

#### 2. ConfigurationCacheService

**èŒè´£**ï¼š
- ä¸“é—¨ç¼“å­˜é…ç½®æ•°æ®ï¼ˆGearDefinition, Affix, GearSetï¼‰
- åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½
- æ”¯æŒçƒ­é‡è½½ï¼ˆå¯é€‰ï¼‰

**æ¥å£å®šä¹‰**ï¼š
```csharp
public interface IConfigurationCacheService
{
    // é¢„åŠ è½½æ‰€æœ‰é…ç½®
    Task PreloadAsync(CancellationToken ct = default);
    
    // è·å– GearDefinition
    Task<GearDefinition?> GetGearDefinitionAsync(Guid id);
    Task<List<GearDefinition>> GetAllGearDefinitionsAsync();
    Task<List<GearDefinition>> GetGearDefinitionsBySlotAsync(EquipmentSlot slot);
    
    // è·å– Affix
    Task<Affix?> GetAffixAsync(Guid id);
    Task<List<Affix>> GetAllAffixesAsync();
    
    // è·å– GearSet
    Task<GearSet?> GetGearSetAsync(Guid id);
    Task<List<GearSet>> GetAllGearSetsAsync();
    
    // é‡æ–°åŠ è½½
    Task ReloadAsync(CancellationToken ct = default);
}
```

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ ConcurrentDictionary å­˜å‚¨
- æ”¯æŒæŒ‰ ID æŸ¥è¯¢å’ŒæŒ‰æ¡ä»¶æŸ¥è¯¢
- æä¾›"å…¨éƒ¨åŠ è½½"æ–¹æ³•ç”¨äºé¢„çƒ­
- å¯é€‰çš„å®šæ—¶åˆ·æ–°æœºåˆ¶

#### 3. å¢å¼ºçš„ Repository å®ç°

**æ”¹é€ æ–¹å‘**ï¼š
- æ‰€æœ‰è¯»å–æ“ä½œå§”æ‰˜ç»™ ReadThroughCacheManager
- å†™å…¥æ“ä½œç»§ç»­ä½¿ç”¨ MemoryStateManagerï¼ˆå·²æœ‰ï¼‰
- ä¿æŒæ¥å£ä¸å˜

**ç¤ºä¾‹æ”¹é€ **ï¼š
```csharp
// CharacterRepository - æ”¹é€ å
public class CharacterRepository : ICharacterRepository
{
    private readonly IReadThroughCacheManager<Character> _cacheManager;
    
    public CharacterRepository(IReadThroughCacheManager<Character> cacheManager)
    {
        _cacheManager = cacheManager;
    }
    
    public Task<Character?> GetAsync(Guid id, CancellationToken ct = default) =>
        _cacheManager.GetByIdAsync(id, ct);  // âœ… å†…å­˜ä¼˜å…ˆ
}
```

---

## æŠ€æœ¯æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. API å±‚ (Controllers)                                   â”‚
â”‚    - ä¸æ„ŸçŸ¥ç¼“å­˜                                           â”‚
â”‚    - ç»§ç»­è°ƒç”¨ Repository                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Repository å±‚ (Data Access)                           â”‚
â”‚    - æ”¹é€ ï¼šä½¿ç”¨ ReadThroughCacheManager                   â”‚
â”‚    - å¯¹å¤–æ¥å£ä¿æŒä¸å˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç¼“å­˜å±‚ (Cache Abstraction)                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ ReadThrough          â”‚  â”‚ Configuration        â”‚   â”‚
â”‚    â”‚ CacheManager<T>      â”‚  â”‚ CacheService         â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å­˜å‚¨å±‚ (Storage)                                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ MemoryStateManager   â”‚  â”‚ IMemoryCache         â”‚   â”‚
â”‚    â”‚ (å•å®ä½“)              â”‚  â”‚ (æŸ¥è¯¢ç»“æœ)            â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ•°æ®æºå±‚ (Data Source)                                 â”‚
â”‚    - GameDbContext                                       â”‚
â”‚    - SQLite Database                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè®¾è®¡

#### è¯»å–æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
    â†“
Controller
    â†“
Repository.GetAsync(id)
    â†“
ReadThroughCacheManager.GetByIdAsync(id)
    â†“
    â”œâ”€â†’ æ£€æŸ¥ MemoryStateManager
    â”‚   â”œâ”€â†’ [ç¼“å­˜å‘½ä¸­] â†’ è¿”å›æ•°æ® âœ…
    â”‚   â””â”€â†’ [ç¼“å­˜æœªå‘½ä¸­]
    â”‚           â†“
    â”‚       æŸ¥è¯¢æ•°æ®åº“
    â”‚           â†“
    â”‚       åŠ è½½åˆ° MemoryStateManager
    â”‚           â†“
    â”‚       è¿”å›æ•°æ® âœ…
    â”‚
    â””â†’ è®°å½•ç¼“å­˜ç»Ÿè®¡ï¼ˆå‘½ä¸­ç‡ã€å“åº”æ—¶é—´ï¼‰
```

#### å†™å…¥æµç¨‹ï¼ˆå·²æœ‰ï¼Œä¿æŒä¸å˜ï¼‰

```
ç”¨æˆ·è¯·æ±‚
    â†“
Controller
    â†“
Repository.UpdateAsync(entity)
    â†“
MemoryStateManager.Update(entity)
    â†“
æ ‡è®°ä¸º Dirtyï¼ˆä¸ç«‹å³ä¿å­˜ï¼‰
    â†“
PersistenceCoordinator å®šæœŸæ‰¹é‡ä¿å­˜
    â†“
æ•°æ®åº“å†™å…¥ âœ…
```

#### é…ç½®æ•°æ®è¯»å–æµç¨‹

```
åº”ç”¨å¯åŠ¨
    â†“
ConfigurationCacheService.PreloadAsync()
    â†“
ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰é…ç½®
    â†“
å­˜å‚¨åˆ°å†…å­˜ (ConcurrentDictionary)
    â†“
-------- è¿è¡Œæ—¶ --------
    â†“
Repository.GetGearDefinitionAsync(id)
    â†“
ConfigurationCacheService.GetGearDefinitionAsync(id)
    â†“
ä»å†…å­˜è¿”å›ï¼ˆä¸æŸ¥æ•°æ®åº“ï¼‰âœ…
```

### å¤±æ•ˆç­–ç•¥è®¾è®¡

#### å•å®ä½“å¤±æ•ˆ

**è§¦å‘æ¡ä»¶**ï¼š
- å®ä½“æ›´æ–°ï¼ˆUpdateï¼‰
- å®ä½“åˆ é™¤ï¼ˆDeleteï¼‰

**æ“ä½œ**ï¼š
```csharp
// æ›´æ–°å®ä½“æ—¶
_memoryStateManager.Update(entity);  // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
_cacheManager.Invalidate(entity.Id);  // å¤±æ•ˆç›¸å…³æŸ¥è¯¢ç¼“å­˜

// åˆ é™¤å®ä½“æ—¶
_memoryStateManager.Remove(entity.Id);
_cacheManager.Invalidate(entity.Id);
```

#### åˆ—è¡¨æŸ¥è¯¢å¤±æ•ˆ

**ç­–ç•¥ 1ï¼šå…³è”å¤±æ•ˆ**
- ç»´æŠ¤ "å®ä½“ ID â†’ æŸ¥è¯¢ Key" æ˜ å°„
- å®ä½“å˜æ›´æ—¶å¤±æ•ˆæ‰€æœ‰ç›¸å…³æŸ¥è¯¢

**ç­–ç•¥ 2ï¼šTTL å¤±æ•ˆ**
- æŸ¥è¯¢ç»“æœè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ 30sï¼‰
- è‡ªåŠ¨è¿‡æœŸåˆ·æ–°

**ç­–ç•¥ 3ï¼šç‰ˆæœ¬å·å¤±æ•ˆ**
- å®ä½“ç±»å‹ç»´æŠ¤ç‰ˆæœ¬å·
- æŸ¥è¯¢æ—¶æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦åŒ¹é…

**æ¨èç»„åˆ**ï¼šTTLï¼ˆä¸»ï¼‰ + å…³è”å¤±æ•ˆï¼ˆè¾…ï¼‰

#### é…ç½®æ•°æ®åˆ·æ–°

**ç­–ç•¥**ï¼š
- é»˜è®¤ï¼šåº”ç”¨å¯åŠ¨åŠ è½½ï¼Œè¿è¡ŒæœŸä¸åˆ·æ–°
- å¯é€‰ï¼šå®šæ—¶åˆ·æ–°ï¼ˆå¦‚æ¯å°æ—¶ï¼‰
- æ‰‹åŠ¨ï¼šæä¾› ReloadAsync API

### å¹¶å‘æ§åˆ¶è®¾è®¡

#### è¯»å†™å¹¶å‘

**åœºæ™¯**ï¼šä¸€ä¸ªçº¿ç¨‹è¯»å–ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å†™å…¥åŒä¸€å®ä½“

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ ConcurrentDictionaryï¼ˆå·²æœ‰ï¼‰
- è¯»å–è·å–å¿«ç…§ï¼ˆå€¼ç±»å‹æˆ–ä¸å¯å˜å¯¹è±¡ï¼‰
- å†™å…¥ä½¿ç”¨ CASï¼ˆCompare-And-Swapï¼‰æˆ–é”

#### å¤šçº¿ç¨‹è¯»å–

**åœºæ™¯**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶è¯»å–åŒä¸€ä¸ªç¼“å­˜æœªå‘½ä¸­çš„å®ä½“

**é—®é¢˜**ï¼š
- å¯èƒ½å¯¼è‡´å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢
- "ç¼“å­˜é›ªå´©"

**è§£å†³æ–¹æ¡ˆ**ï¼š
```csharp
// ä½¿ç”¨ SemaphoreSlim é˜²æ­¢é‡å¤åŠ è½½
private readonly ConcurrentDictionary<Guid, SemaphoreSlim> _loadingLocks = new();

public async Task<T?> GetByIdAsync(Guid id, CancellationToken ct)
{
    // å…ˆæŸ¥ç¼“å­˜
    if (_cache.TryGetValue(id, out var entity))
        return entity;
    
    // è·å–æˆ–åˆ›å»ºåŠ è½½é”
    var loadLock = _loadingLocks.GetOrAdd(id, _ => new SemaphoreSlim(1, 1));
    
    await loadLock.WaitAsync(ct);
    try
    {
        // åŒé‡æ£€æŸ¥ï¼ˆå¯èƒ½åœ¨ç­‰å¾…æœŸé—´å·²è¢«å…¶ä»–çº¿ç¨‹åŠ è½½ï¼‰
        if (_cache.TryGetValue(id, out entity))
            return entity;
        
        // ä»æ•°æ®åº“åŠ è½½
        entity = await LoadFromDatabaseAsync(id, ct);
        
        if (entity != null)
            _cache.TryAdd(id, entity);
        
        return entity;
    }
    finally
    {
        loadLock.Release();
    }
}
```

---

## é…ç½®æ–¹æ¡ˆè®¾è®¡

### é…ç½®ç»“æ„

åœ¨ `appsettings.json` ä¸­æ–°å¢ `ReadCache` é…ç½®èŠ‚ï¼š

```json
{
  "ReadCache": {
    // å…¨å±€å¼€å…³
    "EnableReadCache": true,
    
    // é»˜è®¤ç¼“å­˜é…ç½®
    "DefaultCacheOptions": {
      "MaxCachedEntities": 10000,
      "EvictionPolicy": "LRU",
      "TimeToLiveSeconds": 600,
      "EnableStatistics": true
    },
    
    // åˆ†å®ä½“ç±»å‹é…ç½®
    "EntityCacheOptions": {
      "Character": {
        "MaxCachedEntities": 5000,
        "TimeToLiveSeconds": 300,
        "PreloadOnStartup": false
      },
      "RunningBattleSnapshotRecord": {
        "MaxCachedEntities": 1000,
        "TimeToLiveSeconds": 120,
        "PreloadOnStartup": false
      },
      "ActivityPlan": {
        "MaxCachedEntities": 2000,
        "TimeToLiveSeconds": 180,
        "PreloadOnStartup": false
      },
      "GearInstance": {
        "MaxCachedEntities": 10000,
        "TimeToLiveSeconds": 600,
        "PreloadOnStartup": false
      }
    },
    
    // é…ç½®æ•°æ®ç¼“å­˜
    "ConfigurationCache": {
      "EnablePreload": true,
      "RefreshIntervalMinutes": 0,
      "Entities": {
        "GearDefinition": {
          "PreloadOnStartup": true,
          "TimeToLiveSeconds": -1
        },
        "Affix": {
          "PreloadOnStartup": true,
          "TimeToLiveSeconds": -1
        },
        "GearSet": {
          "PreloadOnStartup": true,
          "TimeToLiveSeconds": -1
        }
      }
    },
    
    // æŸ¥è¯¢ç»“æœç¼“å­˜
    "QueryResultCache": {
      "EnableCache": true,
      "MaxCachedQueries": 1000,
      "DefaultTTLSeconds": 30,
      "EvictionPolicy": "LRU"
    },
    
    // æ€§èƒ½ä¸ç›‘æ§
    "Performance": {
      "EnableMetrics": true,
      "MetricsWindowMinutes": 10,
      "LogCacheMissWarning": true,
      "CacheMissWarningThreshold": 0.5
    },
    
    // å¹¶å‘æ§åˆ¶
    "Concurrency": {
      "EnableLoadDeduplication": true,
      "MaxConcurrentLoads": 100
    }
  }
}
```

### é…ç½®ç±»å®šä¹‰

#### ReadCacheOptions

```csharp
/// <summary>
/// è¯»å–ç¼“å­˜æ€»ä½“é…ç½®
/// Read cache overall configuration
/// </summary>
public class ReadCacheOptions
{
    /// <summary>
    /// æ˜¯å¦å¯ç”¨è¯»å–ç¼“å­˜
    /// Enable read cache
    /// </summary>
    public bool EnableReadCache { get; set; } = true;
    
    /// <summary>
    /// é»˜è®¤ç¼“å­˜é…ç½®
    /// Default cache options
    /// </summary>
    public EntityCacheConfig DefaultCacheOptions { get; set; } = new();
    
    /// <summary>
    /// åˆ†å®ä½“ç±»å‹é…ç½®
    /// Entity-specific cache options
    /// </summary>
    public Dictionary<string, EntityCacheConfig> EntityCacheOptions { get; set; } = new();
    
    /// <summary>
    /// é…ç½®æ•°æ®ç¼“å­˜é€‰é¡¹
    /// Configuration cache options
    /// </summary>
    public ConfigurationCacheConfig ConfigurationCache { get; set; } = new();
    
    /// <summary>
    /// æŸ¥è¯¢ç»“æœç¼“å­˜é€‰é¡¹
    /// Query result cache options
    /// </summary>
    public QueryResultCacheConfig QueryResultCache { get; set; } = new();
    
    /// <summary>
    /// æ€§èƒ½ä¸ç›‘æ§é…ç½®
    /// Performance and monitoring configuration
    /// </summary>
    public PerformanceConfig Performance { get; set; } = new();
    
    /// <summary>
    /// å¹¶å‘æ§åˆ¶é…ç½®
    /// Concurrency control configuration
    /// </summary>
    public ConcurrencyConfig Concurrency { get; set; } = new();
}
```

#### EntityCacheConfig

```csharp
/// <summary>
/// å•ä¸ªå®ä½“ç±»å‹çš„ç¼“å­˜é…ç½®
/// Cache configuration for a single entity type
/// </summary>
public class EntityCacheConfig
{
    /// <summary>
    /// æœ€å¤§ç¼“å­˜å®ä½“æ•°é‡
    /// Maximum number of cached entities
    /// </summary>
    [Range(100, 1000000)]
    public int MaxCachedEntities { get; set; } = 10000;
    
    /// <summary>
    /// ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ-1 è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ
    /// Time to live in seconds, -1 means never expire
    /// </summary>
    [Range(-1, 86400)]
    public int TimeToLiveSeconds { get; set; } = 600;
    
    /// <summary>
    /// æ·˜æ±°ç­–ç•¥ï¼šLRU, LFU, FIFO
    /// Eviction policy: LRU, LFU, FIFO
    /// </summary>
    public string EvictionPolicy { get; set; } = "LRU";
    
    /// <summary>
    /// æ˜¯å¦åœ¨åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½
    /// Whether to preload on application startup
    /// </summary>
    public bool PreloadOnStartup { get; set; } = false;
    
    /// <summary>
    /// æ˜¯å¦å¯ç”¨ç»Ÿè®¡
    /// Enable statistics
    /// </summary>
    public bool EnableStatistics { get; set; } = true;
}
```

#### ConfigurationCacheConfig

```csharp
/// <summary>
/// é…ç½®æ•°æ®ç¼“å­˜é…ç½®
/// Configuration data cache configuration
/// </summary>
public class ConfigurationCacheConfig
{
    /// <summary>
    /// æ˜¯å¦å¯ç”¨é¢„åŠ è½½
    /// Enable preload
    /// </summary>
    public bool EnablePreload { get; set; } = true;
    
    /// <summary>
    /// åˆ·æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ï¼Œ0 è¡¨ç¤ºä¸åˆ·æ–°
    /// Refresh interval in minutes, 0 means no refresh
    /// </summary>
    [Range(0, 1440)]
    public int RefreshIntervalMinutes { get; set; } = 0;
    
    /// <summary>
    /// å„é…ç½®å®ä½“çš„ç¼“å­˜é…ç½®
    /// Cache configuration for each configuration entity
    /// </summary>
    public Dictionary<string, ConfigEntityCacheConfig> Entities { get; set; } = new();
}
```

### é…ç½®éªŒè¯

```csharp
// åœ¨ Program.cs æˆ– DependencyInjection ä¸­æ³¨å†Œ
services.AddOptions<ReadCacheOptions>()
    .Bind(configuration.GetSection("ReadCache"))
    .ValidateDataAnnotations()
    .ValidateOnStart();
```

### é…ç½®çƒ­æ›´æ–°ï¼ˆå¯é€‰ï¼‰

```csharp
services.Configure<ReadCacheOptions>(
    configuration.GetSection("ReadCache"));

// ä½¿ç”¨ IOptionsMonitor æ”¯æŒçƒ­æ›´æ–°
public class ReadThroughCacheManager<T>
{
    private readonly IOptionsMonitor<ReadCacheOptions> _optionsMonitor;
    
    public ReadThroughCacheManager(IOptionsMonitor<ReadCacheOptions> optionsMonitor)
    {
        _optionsMonitor = optionsMonitor;
        
        // ç›‘å¬é…ç½®å˜æ›´
        _optionsMonitor.OnChange(options =>
        {
            // åº”ç”¨æ–°é…ç½®
            ApplyNewConfiguration(options);
        });
    }
}
```

---

## é£é™©è¯„ä¼°ä¸åº”å¯¹

### é£é™©çŸ©é˜µ

| é£é™© | æ¦‚ç‡ | å½±å“ | ç­‰çº§ | åº”å¯¹ç­–ç•¥ |
|-----|------|------|------|---------|
| æ•°æ®ä¸€è‡´æ€§é—®é¢˜ | ä¸­ | é«˜ | ğŸ”´ é«˜ | ç»Ÿä¸€è¯»å†™è·¯å¾„ï¼Œå¼ºåˆ¶ä½¿ç”¨ç¼“å­˜ç®¡ç†å™¨ |
| ç¼“å­˜ç©¿é€ | ä½ | ä¸­ | âš ï¸ ä¸­ | ç©ºå€¼ç¼“å­˜ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ |
| ç¼“å­˜é›ªå´© | ä½ | é«˜ | âš ï¸ ä¸­ | åŠ è½½é”ï¼ŒTTL éšæœºåŒ– |
| å†…å­˜æº¢å‡º | ä¸­ | é«˜ | ğŸ”´ é«˜ | ä¸¥æ ¼çš„å®¹é‡é™åˆ¶ï¼ŒLRU æ·˜æ±° |
| æ€§èƒ½é€€åŒ– | ä½ | ä¸­ | âš ï¸ ä¸­ | é…ç½®å¼€å…³ï¼Œå¯å›æ»š |
| å®æ–½å¤æ‚åº¦ | ä¸­ | ä¸­ | âš ï¸ ä¸­ | åˆ†é˜¶æ®µå®æ–½ï¼Œå……åˆ†æµ‹è¯• |

### é£é™©åº”å¯¹è¯¦è§£

#### 1. æ•°æ®ä¸€è‡´æ€§é—®é¢˜ ğŸ”´

**é£é™©æè¿°**ï¼š
- ç¼“å­˜ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¸åŒæ­¥
- å¹¶å‘æ›´æ–°å¯¼è‡´è„è¯»

**åº”å¯¹æªæ–½**ï¼š
1. **ç»Ÿä¸€è¯»å†™è·¯å¾„**
   - å¼ºåˆ¶æ‰€æœ‰è¯»å†™éƒ½é€šè¿‡ç¼“å­˜ç®¡ç†å™¨
   - ç¦æ­¢ç›´æ¥è®¿é—® DbContext
   
2. **å†™å…¥æ—¶æ›´æ–°ç¼“å­˜**
   ```csharp
   public async Task UpdateAsync(T entity)
   {
       // æ›´æ–°å†…å­˜
       _memoryStateManager.Update(entity);
       
       // åŒæ­¥æ›´æ–°ç¼“å­˜
       _cacheManager.AddOrUpdate(entity);
       
       // æ ‡è®°ä¸º Dirtyï¼ˆå»¶è¿Ÿä¿å­˜ï¼‰
   }
   ```

3. **è¯»å–æœ€æ–°æ•°æ®**
   - ä¼˜å…ˆè¯»å– MemoryStateManagerï¼ˆåŒ…å«æœªä¿å­˜çš„æ›´æ–°ï¼‰
   - å†è¯»å–æ•°æ®åº“

4. **ç‰ˆæœ¬å·æœºåˆ¶**
   - å®ä½“æ·»åŠ  Version å­—æ®µ
   - æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·

#### 2. ç¼“å­˜ç©¿é€ âš ï¸

**é£é™©æè¿°**ï¼š
- æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®
- ç»•è¿‡ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“

**åº”å¯¹æªæ–½**ï¼š
1. **ç©ºå€¼ç¼“å­˜**
   ```csharp
   // ç¼“å­˜ null ç»“æœ
   if (entity == null)
   {
       _cache.Set(id, CacheEntry.Null(), TimeSpan.FromMinutes(5));
   }
   ```

2. **å¸ƒéš†è¿‡æ»¤å™¨**ï¼ˆå¯é€‰ï¼‰
   - é¢„å…ˆåŠ è½½æ‰€æœ‰å­˜åœ¨çš„ ID
   - å¿«é€Ÿåˆ¤æ–­ ID æ˜¯å¦å­˜åœ¨

#### 3. ç¼“å­˜é›ªå´© âš ï¸

**é£é™©æè¿°**ï¼š
- å¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆ
- ç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“

**åº”å¯¹æªæ–½**ï¼š
1. **åŠ è½½é”ï¼ˆå·²è®¾è®¡ï¼‰**
   - é˜²æ­¢åŒä¸€æ•°æ®è¢«å¤šæ¬¡åŠ è½½
   
2. **TTL éšæœºåŒ–**
   ```csharp
   var ttl = baseT TL + Random.Next(0, 60);  // åŸºç¡€TTL + 0-60ç§’éšæœº
   ```

3. **åˆ†æ‰¹é¢„çƒ­**
   - åº”ç”¨å¯åŠ¨æ—¶åˆ†æ‰¹åŠ è½½çƒ­æ•°æ®

#### 4. å†…å­˜æº¢å‡º ğŸ”´

**é£é™©æè¿°**ï¼š
- ç¼“å­˜æ— é™å¢é•¿
- å¯¼è‡´ OutOfMemoryException

**åº”å¯¹æªæ–½**ï¼š
1. **ä¸¥æ ¼çš„å®¹é‡é™åˆ¶**
   - é…ç½® MaxCachedEntities
   - è¾¾åˆ°é™åˆ¶æ—¶å¼ºåˆ¶æ·˜æ±°

2. **LRU è‡ªåŠ¨æ·˜æ±°**
   - å·²å®ç°ï¼Œç»§ç»­ä½¿ç”¨

3. **ç›‘æ§ä¸å‘Šè­¦**
   - ç›‘æ§ç¼“å­˜å¤§å°
   - è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 80%ï¼‰å‘Šè­¦

4. **åˆ†çº§ç¼“å­˜**
   - çƒ­æ•°æ®ï¼šå†…å­˜ç¼“å­˜
   - æ¸©æ•°æ®ï¼šæœ¬åœ°æ–‡ä»¶ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
   - å†·æ•°æ®ï¼šä»…æ•°æ®åº“

#### 5. æ€§èƒ½é€€åŒ– âš ï¸

**é£é™©æè¿°**ï¼š
- ç¼“å­˜ç®¡ç†å¼€é”€å¤§äºæ”¶ç›Š
- ç³»ç»Ÿåè€Œå˜æ…¢

**åº”å¯¹æªæ–½**ï¼š
1. **é…ç½®å¼€å…³**
   - `EnableReadCache = false` å¯ç«‹å³å›æ»š
   
2. **A/B æµ‹è¯•**
   - éƒ¨åˆ†æœåŠ¡å™¨å¯ç”¨ï¼Œå¯¹æ¯”æ€§èƒ½

3. **åŸºå‡†æµ‹è¯•**
   - ä¼˜åŒ–å‰åæ€§èƒ½å¯¹æ¯”
   - ç¡®ä¿æœ‰æå‡

4. **é™çº§æœºåˆ¶**
   - ç¼“å­˜æœåŠ¡å¼‚å¸¸æ—¶è‡ªåŠ¨é™çº§åˆ°ç›´æ¥æŸ¥æ•°æ®åº“

---

## æ€§èƒ½é¢„æœŸ

### è¯»å–æ€§èƒ½æ”¹å–„é¢„æœŸ

åŸºäºå½“å‰åˆ†æï¼ˆæ¯å°æ—¶ 10ä¸‡-30ä¸‡æ¬¡è¯»å–ï¼‰ï¼š

| åœºæ™¯ | ä¼˜åŒ–å‰ (æ¬¡/å°æ—¶) | ç¼“å­˜å‘½ä¸­ç‡ | ä¼˜åŒ–å (æ¬¡/å°æ—¶) | å‡å°‘æ¯”ä¾‹ |
|-----|----------------|-----------|----------------|---------|
| Character è¯»å– | 30,000 - 120,000 | 85% | 4,500 - 18,000 | 85% |
| BattleSnapshot è¯»å– | 36,000 - 72,000 | 80% | 7,200 - 14,400 | 80% |
| ActivityPlan è¯»å– | 12,000 - 30,000 | 85% | 1,800 - 4,500 | 85% |
| GearInstance è¯»å– | 10,000 - 50,000 | 75% | 2,500 - 12,500 | 75% |
| **é…ç½®æ•°æ®è¯»å–** | 9,000 - 33,000 | **98%** | **180 - 660** | **98%** |
| **æ€»è®¡** | **97,000 - 305,000** | **~85%** | **16,180 - 50,060** | **~83-84%** |

**å…³é”®æŒ‡æ ‡**ï¼š
- âœ… æ•°æ®åº“è¯»å–å‡å°‘ **83-84%**
- âœ… é…ç½®æ•°æ®è¯»å–å‡å°‘ **98%**
- âœ… æ€»ä½“æ•°æ®åº“ I/O å‡å°‘ **80%+**

### å“åº”æ—¶é—´æ”¹å–„é¢„æœŸ

| æ“ä½œç±»å‹ | ä¼˜åŒ–å‰ P95 | ä¼˜åŒ–å P95 | æ”¹å–„ |
|---------|----------|----------|------|
| è§’è‰²ä¿¡æ¯æŸ¥è¯¢ | 50ms | 5ms | -90% |
| è£…å¤‡åˆ—è¡¨åŠ è½½ | 80ms | 15ms | -81% |
| æˆ˜æ–—çŠ¶æ€åˆ·æ–° | 30ms | 8ms | -73% |
| é…ç½®æ•°æ®æŸ¥è¯¢ | 20ms | <1ms | -95%+ |

**é¢„æœŸå¹³å‡å“åº”æ—¶é—´**ï¼š
- API æ€»ä½“å“åº”æ—¶é—´æ”¹å–„ **30-50%**
- æ•°æ®åº“å¯†é›†æ“ä½œæ”¹å–„ **60-80%**

### ç³»ç»Ÿå®¹é‡æ”¹å–„é¢„æœŸ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|-------|--------|------|
| æœ€å¤§å¹¶å‘ç”¨æˆ· | 100-200 | 300-500 | 2-3x |
| æ•°æ®åº“è¿æ¥æ± å‹åŠ› | é«˜ | ä½ | -70% |
| CPU ä½¿ç”¨ç‡ | ä¸­ | ä½ | -20% |
| å†…å­˜ä½¿ç”¨ | 200MB | 350MB | +75MB |

### èµ„æºæ¶ˆè€—é¢„æœŸ

#### å†…å­˜æ¶ˆè€—ä¼°ç®—

**åŸºç¡€å†…å­˜**ï¼š
- MemoryStateManager ç°æœ‰æ¶ˆè€—ï¼š~50MBï¼ˆå·²æœ‰ï¼‰
- ReadCache æ–°å¢æ¶ˆè€—ï¼š
  - Character (5,000 ä¸ª Ã— 2KB) = 10MB
  - BattleSnapshot (1,000 ä¸ª Ã— 5KB) = 5MB
  - ActivityPlan (2,000 ä¸ª Ã— 1KB) = 2MB
  - GearInstance (10,000 ä¸ª Ã— 3KB) = 30MB
  - é…ç½®æ•°æ® (3,000 ä¸ª Ã— 2KB) = 6MB
  - æŸ¥è¯¢ç»“æœç¼“å­˜ (1,000 ä¸ª Ã— 5KB) = 5MB
  - **æ€»è®¡**ï¼š~58MB

**å†…å­˜ä¸Šé™**ï¼ˆé…ç½®ä¿æŠ¤ï¼‰ï¼š
- MaxCachedEntities é™åˆ¶
- LRU æ·˜æ±°ä¿è¯ä¸æº¢å‡º
- é¢„æœŸå³°å€¼ï¼š~100MB

**ç»“è®º**ï¼šå†…å­˜å¢åŠ å¯æ¥å—ï¼ˆ+50-100MBï¼‰ï¼Œæ”¶ç›Šè¿œå¤§äºæˆæœ¬

---

## ä¸‹ä¸€æ­¥ï¼šå®æ–½æ–¹æ¡ˆ

æœ¬éœ€æ±‚åˆ†ææ–‡æ¡£å®Œæˆåï¼Œå°†ç”Ÿæˆä»¥ä¸‹å®æ–½æ–‡æ¡£ï¼š

1. **æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸Šç¯‡** ï¼ˆåŸºç¡€è®¾æ–½ï¼‰
   - ReadThroughCacheManager å®ç°
   - ConfigurationCacheService å®ç°
   - é…ç½®ç±»å®šä¹‰
   - ä¾èµ–æ³¨å…¥é…ç½®

2. **æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸­ç¯‡** ï¼ˆRepository æ”¹é€ ï¼‰
   - CharacterRepository æ”¹é€ 
   - BattleSnapshotRepository æ”¹é€ 
   - ActivityPlanRepository æ”¹é€ 
   - GearInstanceRepository æ”¹é€ 
   - é…ç½®æ•°æ® Repository æ”¹é€ 

3. **æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸‹ç¯‡** ï¼ˆç›‘æ§ä¸éªŒè¯ï¼‰
   - ç¼“å­˜ç»Ÿè®¡æ”¶é›†
   - æ€§èƒ½æŒ‡æ ‡ç›‘æ§
   - å¥åº·æ£€æŸ¥ API
   - æµ‹è¯•éªŒè¯

4. **æ•°æ®åº“è¯»å–ä¼˜åŒ–éªŒæ”¶æ–‡æ¡£**
   - åŠŸèƒ½éªŒæ”¶æ ‡å‡†
   - æ€§èƒ½éªŒæ”¶æ ‡å‡†
   - æµ‹è¯•ç”¨ä¾‹
   - å›æ»šé¢„æ¡ˆ

---

## æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **æ€§èƒ½æå‡**ï¼šæ•°æ®åº“è¯»å–å‡å°‘ **83-84%**ï¼Œå“åº”æ—¶é—´æ”¹å–„ **30-50%**
2. **å¯æ‰©å±•æ€§**ï¼šå¹¶å‘èƒ½åŠ›æå‡ **2-3å€**
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šç»Ÿä¸€è¯»å†™è·¯å¾„ï¼Œé¿å…è„è¯»
4. **å®Œå…¨é…ç½®åŒ–**ï¼šæ‰€æœ‰å‚æ•°å¯è°ƒï¼Œä¸å†™æ­»
5. **å‘åå…¼å®¹**ï¼šRepository æ¥å£ä¸å˜ï¼ŒAPI å±‚æ— æ„ŸçŸ¥
6. **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„ç¼“å­˜ç»Ÿè®¡å’Œç›‘æ§

### æŠ€æœ¯äº®ç‚¹

1. **ç»Ÿä¸€çš„ç¼“å­˜æŠ½è±¡**ï¼šReadThroughCacheManager å°è£…å¤æ‚æ€§
2. **åˆ†å±‚ç¼“å­˜ç­–ç•¥**ï¼šè¿è¡Œæ€æ•°æ® + é…ç½®æ•°æ® + æŸ¥è¯¢ç»“æœ
3. **æ™ºèƒ½å¤±æ•ˆæœºåˆ¶**ï¼šTTL + å…³è”å¤±æ•ˆ + ç‰ˆæœ¬å·
4. **å¹¶å‘æ§åˆ¶**ï¼šåŠ è½½é”é˜²æ­¢ç¼“å­˜é›ªå´©
5. **å†…å­˜ä¿æŠ¤**ï¼šä¸¥æ ¼é™åˆ¶ + LRU æ·˜æ±°

### å®æ–½è·¯å¾„

**Phase 1**ï¼šåŸºç¡€è®¾æ–½ï¼ˆ2-3å¤©ï¼‰
- ReadThroughCacheManager
- ConfigurationCacheService
- é…ç½®ç³»ç»Ÿ

**Phase 2**ï¼šRepository æ”¹é€ ï¼ˆ3-4å¤©ï¼‰
- æ ¸å¿ƒ Repositoryï¼ˆCharacter, BattleSnapshot, ActivityPlanï¼‰
- é…ç½®æ•°æ® Repository
- è£…å¤‡ç›¸å…³ Repository

**Phase 3**ï¼šç›‘æ§ä¸ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰
- ç¼“å­˜ç»Ÿè®¡
- æ€§èƒ½ç›‘æ§
- æµ‹è¯•éªŒè¯

**æ€»å·¥æ—¶**ï¼š7-10 å¤©

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… éœ€æ±‚åˆ†æå®Œæˆ  
**ä¸‹ä¸€æ­¥**ï¼šç”Ÿæˆè¯¦ç»†å®æ–½æ–¹æ¡ˆï¼ˆä¸Šä¸­ä¸‹ç¯‡ï¼‰å’ŒéªŒæ”¶æ–‡æ¡£  
**æœ€åæ›´æ–°**ï¼š2025-10-19
