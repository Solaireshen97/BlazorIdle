# BlazorIdle 装备系统优化设计方案

**项目**: BlazorIdle  
**文档版本**: 1.0  
**创建日期**: 2025-10-11  
**状态**: 设计阶段 - 待实施  
**作者**: 系统架构设计

---

## 目录

1. [执行摘要](#执行摘要)
2. [当前状态分析](#当前状态分析)
3. [设计目标](#设计目标)
4. [核心设计方案](#核心设计方案)
   - 4.1 [装备槽位系统](#41-装备槽位系统)
   - 4.2 [护甲类型系统](#42-护甲类型系统)
   - 4.3 [武器类型系统](#43-武器类型系统)
   - 4.4 [护甲与减伤机制](#44-护甲与减伤机制)
   - 4.5 [格挡机制](#45-格挡机制)
   - 4.6 [职业装备限制](#46-职业装备限制)
   - 4.7 [配置化设计](#47-配置化设计)
5. [详细执行计划](#详细执行计划)
   - Phase 1: 数据模型与配置基础
   - Phase 2: 装备槽位与护甲系统
   - Phase 3: 武器系统与战斗机制
   - Phase 4: 职业限制与平衡调整
   - Phase 5: 前端实现与测试
6. [技术规范](#技术规范)
7. [数值平衡设计](#数值平衡设计)
8. [扩展性设计](#扩展性设计)
9. [风险评估与应对](#风险评估与应对)
10. [附录](#附录)

---

## 执行摘要

本设计方案旨在将 BlazorIdle 的装备系统从当前的简化模型（9个槽位）扩展为类似《魔兽世界》的完整装备系统，包含：

### 核心改进
- ✅ **扩展装备槽位**: 从9个增加到17个槽位（含双戒指、双饰品、武器系统）
- ✅ **护甲类型系统**: 引入布甲、皮甲、锁甲、板甲四大护甲类型
- ✅ **武器类型系统**: 15种武器类型，包含攻击速度、攻击倍率机制
- ✅ **护甲减伤**: 基于护甲值的伤害减免计算
- ✅ **格挡机制**: 盾牌特有的格挡概率与减伤
- ✅ **职业限制**: 配置化的职业-装备兼容性系统
- ✅ **非战斗装备预留**: 为采集、生产职业预留装备类型

### 设计原则
1. **数据驱动**: 所有配置通过 JSON/配置类管理，不硬编码
2. **向后兼容**: 现有装备数据可平滑迁移
3. **可扩展性**: 预留未来扩展接口（附魔、宝石、特殊效果等）
4. **代码风格一致**: 遵循现有代码规范和架构模式
5. **渐进式实施**: 分阶段实施，每个阶段可独立测试和上线

---

## 当前状态分析

### 已有装备系统（Step 5 UI预留）

根据 `装备系统UI完成报告.md` 和代码分析：

#### 当前装备槽位（9个）
```csharp
public static readonly string[] CurrentSlots = new[]
{
    "head",      // 头盔
    "weapon",    // 武器
    "chest",     // 胸甲
    "offhand",   // 副手
    "waist",     // 腰带
    "legs",      // 腿部
    "feet",      // 鞋子
    "trinket1",  // 饰品1
    "trinket2"   // 饰品2
};
```

#### 当前数据模型
```csharp
// GearInstanceDto - 装备实例
public sealed class GearInstanceDto
{
    public Guid Id { get; set; }
    public string DefinitionId { get; set; }
    public string Name { get; set; }
    public string Icon { get; set; }
    public string Rarity { get; set; }        // Common/Rare/Epic/Legendary
    public int Tier { get; set; }             // 1-3
    public int ItemLevel { get; set; }
    public int QualityScore { get; set; }
    public List<AffixDto> Affixes { get; set; }
    public string? SetId { get; set; }
    public Dictionary<string, double> Stats { get; set; }
}
```

#### 当前属性系统
```csharp
// CharacterStats - 角色属性
public sealed class CharacterStats
{
    public double AttackPower { get; init; }
    public double SpellPower { get; init; }
    public double CritChance { get; init; }
    public double CritMultiplier { get; init; }
    public double HastePercent { get; init; }
    public double ArmorPenFlat { get; init; }
    public double ArmorPenPct { get; init; }
    public double MagicPenFlat { get; init; }
    public double MagicPenPct { get; init; }
}

// PrimaryAttributes - 主属性
public sealed class PrimaryAttributes
{
    public int Strength { get; init; }
    public int Agility { get; init; }
    public int Intellect { get; init; }
    public int Stamina { get; init; }
}
```

#### 现有职业系统
- **Warrior (战士)**: 基础攻击间隔 1.5s，特殊技能间隔 5.0s，怒气资源系统
- **Ranger (游侠)**: 已实现但细节需查看
- 职业模块接口 `IProfessionModule`

### 缺失的关键功能
❌ 详细的装备槽位（颈部、肩部、背部等）  
❌ 护甲类型概念  
❌ 武器类型系统（攻击速度、攻击倍率）  
❌ 护甲减伤计算  
❌ 格挡机制  
❌ 职业-装备兼容性限制  
❌ 双手武器占用主副手的机制  

---

## 设计目标

### 功能目标
1. 实现完整的17个装备槽位系统
2. 引入护甲类型，提供不同的基础属性和职业限制
3. 实现武器类型系统，影响攻击速度和伤害计算
4. 实现护甲减伤和格挡机制
5. 配置化的职业-装备兼容性系统
6. 为未来的非战斗职业预留装备类型

### 技术目标
1. 所有配置参数通过配置类/JSON管理，不硬编码
2. 保持现有代码风格和架构模式
3. 向后兼容现有数据
4. 高可扩展性，易于添加新装备类型
5. 完整的单元测试覆盖

### 体验目标
1. 装备选择更具策略性
2. 职业特色更加鲜明
3. 装备进阶路径清晰
4. 数值平衡合理

---

## 核心设计方案

### 4.1 装备槽位系统

#### 完整槽位定义（17个）

```csharp
public enum EquipmentSlot
{
    // 防具槽位 (11个)
    Head,           // 头部
    Neck,           // 颈部
    Shoulder,       // 肩部
    Back,           // 背部（披风）
    Chest,          // 胸部
    Wrist,          // 手腕（护腕）
    Hands,          // 手部（手套）
    Waist,          // 腰部（腰带）
    Legs,           // 腿部
    Feet,           // 脚部
    
    // 饰品槽位 (2个)
    Finger1,        // 第一个戒指
    Finger2,        // 第二个戒指
    Trinket1,       // 第一个饰品
    Trinket2,       // 第二个饰品
    
    // 武器槽位 (3个)
    MainHand,       // 主手武器
    OffHand,        // 副手（副手武器或盾牌）
    TwoHand         // 双手武器（虚拟槽位，实际占用主副手）
}
```

#### 槽位配置
```csharp
public class EquipmentSlotConfig
{
    public EquipmentSlot Slot { get; set; }
    public string SlotId { get; set; }           // "head", "neck", etc.
    public string DisplayName { get; set; }      // "头部", "颈部", etc.
    public string Icon { get; set; }             // emoji 或图标路径
    public SlotCategory Category { get; set; }   // Armor/Jewelry/Weapon
    public bool AllowsArmorType { get; set; }    // 是否受护甲类型限制
    public bool RequiresWeaponType { get; set; } // 是否需要武器类型
}

public enum SlotCategory
{
    Armor,      // 防具
    Jewelry,    // 饰品
    Weapon      // 武器
}
```

#### 双手武器机制
```csharp
public class EquipmentSlotOccupancy
{
    public EquipmentSlot PrimarySlot { get; set; }
    public List<EquipmentSlot> OccupiedSlots { get; set; }
    
    // 示例：双手武器
    // PrimarySlot = TwoHand
    // OccupiedSlots = [MainHand, OffHand]
}
```

---

### 4.2 护甲类型系统

#### 护甲类型定义

```csharp
public enum ArmorType
{
    None,       // 无类型（饰品、披风等）
    Cloth,      // 布甲
    Leather,    // 皮甲
    Mail,       // 锁甲
    Plate       // 板甲
}
```

#### 护甲类型特性

| 护甲类型 | 适用职业示例 | 基础护甲系数 | 主属性倾向 | 特色 |
|---------|------------|------------|-----------|------|
| **None** | 所有职业 | 0.0 | - | 饰品、披风、颈部 |
| **Cloth (布甲)** | 法师、牧师 | 0.5 | Intellect | 高法术强度，低护甲 |
| **Leather (皮甲)** | 盗贼、德鲁伊 | 1.0 | Agility | 平衡型，闪避加成 |
| **Mail (锁甲)** | 猎人、萨满 | 1.5 | Agility/Intellect | 中等护甲，灵活性 |
| **Plate (板甲)** | 战士、圣骑士 | 2.0 | Strength/Stamina | 高护甲，高生存 |

#### 护甲类型配置类

```csharp
public class ArmorTypeConfig
{
    public ArmorType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    
    // 基础属性系数
    public double BaseArmorMultiplier { get; set; }  // 基础护甲倍率
    public double StaminaMultiplier { get; set; }    // 耐力加成倍率
    
    // 次级属性倾向
    public Dictionary<string, double> SecondaryStatWeights { get; set; }
    // 例如: { "CritChance": 0.02, "Dodge": 0.03 }
    
    // 可装备的槽位
    public List<EquipmentSlot> ApplicableSlots { get; set; }
}
```

#### 护甲值计算公式

```
物品护甲值 = 基础护甲值 × 护甲类型系数 × 物品等级系数 × 品级系数

例如：
- T2 布甲胸甲（物品等级30）：BaseArmor(10) × Cloth(0.5) × iLvl(30/10) × Tier(1.0) = 15
- T2 板甲胸甲（物品等级30）：BaseArmor(10) × Plate(2.0) × iLvl(30/10) × Tier(1.0) = 60
```

---

### 4.3 武器类型系统

#### 武器类型定义

```csharp
public enum WeaponType
{
    // 无类型
    None,           // 非武器（防具、饰品）
    
    // 单手武器
    Sword,          // 剑
    Dagger,         // 匕首
    Axe,            // 斧
    Mace,           // 锤
    Fist,           // 拳套
    
    // 远程单手
    Wand,           // 魔杖
    
    // 双手武器
    TwoHandSword,   // 双手剑
    TwoHandAxe,     // 双手斧
    TwoHandMace,    // 双手锤
    Staff,          // 法杖
    Polearm,        // 长柄武器
    
    // 远程武器
    Bow,            // 弓
    Crossbow,       // 弩
    Gun,            // 枪
    
    // 副手专用
    Shield          // 盾牌
}
```

#### 武器类型特性配置

```csharp
public class WeaponTypeConfig
{
    public WeaponType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    
    // 基础攻击属性
    public double BaseAttackSpeed { get; set; }      // 基础攻击速度（秒/次）
    public double AttackPowerMultiplier { get; set; } // 攻击倍率
    
    // 武器槽位限制
    public List<EquipmentSlot> AllowedSlots { get; set; }
    
    // 伤害类型倾向
    public DamageType PrimaryDamageType { get; set; }
    
    // 特殊机制
    public bool AllowsDualWield { get; set; }        // 是否可双持
    public bool IsRangedWeapon { get; set; }         // 是否远程武器
    public bool IsTwoHanded { get; set; }            // 是否双手武器
}
```

#### 武器类型数值设计

基准：**标准单手剑** = 攻击速度 2.5s/次，攻击倍率 1.0

| 武器类型 | 攻击速度 | 攻击倍率 | DPS系数 | 特点 |
|---------|---------|---------|---------|------|
| **Sword (剑)** | 2.5s | 1.00 | 0.40 | 基准武器，平衡 |
| **Dagger (匕首)** | 1.8s | 0.72 | 0.40 | 快速，低伤害 |
| **Axe (斧)** | 2.8s | 1.12 | 0.40 | 慢速，高伤害 |
| **Mace (锤)** | 2.6s | 1.04 | 0.40 | 平衡偏慢 |
| **Fist (拳套)** | 2.0s | 0.80 | 0.40 | 快速近战 |
| **Wand (魔杖)** | 2.0s | 0.60 | 0.30 | 法术武器，低物理伤害 |
| **TwoHandSword (双手剑)** | 3.5s | 1.75 | 0.50 | 慢速，高伤害 |
| **TwoHandAxe (双手斧)** | 3.8s | 1.90 | 0.50 | 最慢，最高伤害 |
| **TwoHandMace (双手锤)** | 3.6s | 1.80 | 0.50 | 慢速强力 |
| **Staff (法杖)** | 3.2s | 1.12 | 0.35 | 法术双手武器 |
| **Polearm (长柄)** | 3.4s | 1.70 | 0.50 | 远程双手武器 |
| **Bow (弓)** | 3.0s | 1.50 | 0.50 | 远程武器 |
| **Crossbow (弩)** | 3.6s | 1.80 | 0.50 | 慢速远程 |
| **Gun (枪)** | 3.2s | 1.60 | 0.50 | 机械远程 |
| **Shield (盾牌)** | - | - | - | 防御副手 |

**DPS系数** = 攻击倍率 / 攻击速度，保持相近以确保平衡

#### 双持武器计算

```csharp
public class DualWieldCalculation
{
    // 平均攻击速度
    public double AverageSpeed = (MainHandSpeed + OffHandSpeed) / 2.0;
    
    // 总攻击力 = (主手 + 副手) × 双持系数
    public double TotalAttackPower = (MainHandAP + OffHandAP) * DualWieldCoefficient;
    
    // 双持系数（默认 0.85，避免双持过强）
    public const double DualWieldCoefficient = 0.85;
}
```

---

### 4.4 护甲与减伤机制

#### 护甲减伤公式

```csharp
public class ArmorDamageReduction
{
    /// <summary>
    /// 计算护甲减伤百分比
    /// 公式: DamageReduction% = Armor / (Armor + K × AttackerLevel)
    /// 其中 K 是常数，用于控制护甲效果
    /// </summary>
    public static double CalculateReduction(double armor, int attackerLevel, double k = 400)
    {
        if (armor <= 0) return 0;
        
        double reduction = armor / (armor + k * attackerLevel);
        
        // 护甲减伤上限 75%
        return Math.Min(reduction, 0.75);
    }
    
    /// <summary>
    /// 应用护甲减伤
    /// </summary>
    public static int ApplyArmorReduction(int rawDamage, double armorReduction)
    {
        return (int)Math.Ceiling(rawDamage * (1.0 - armorReduction));
    }
}
```

#### 护甲来源
1. **装备护甲**: 各部位装备提供的护甲值总和
2. **主属性加成**: Agility 可提供少量护甲
3. **Buff加成**: 技能和Buff可临时增加护甲
4. **护甲穿透**: 敌人的护甲穿透减少有效护甲值

```
有效护甲 = (总护甲 - 固定穿透) × (1 - 百分比穿透)
```

---

### 4.5 格挡机制

#### 格挡配置

```csharp
public class BlockMechanicsConfig
{
    // 基础格挡率（装备盾牌时）
    public double BaseBlockChance { get; set; } = 0.05;  // 5%
    
    // 格挡减伤百分比
    public double BlockDamageReduction { get; set; } = 0.30;  // 30%
    
    // 属性加成
    public double BlockChancePerStrength { get; set; } = 0.001;  // 每点力量 +0.1%
    public double BlockChancePerItemLevel { get; set; } = 0.002; // 每点装等 +0.2%
    
    // 格挡率上限
    public double MaxBlockChance { get; set; } = 0.50;  // 50%
}
```

#### 格挡计算

```csharp
public class BlockCalculator
{
    /// <summary>
    /// 计算格挡概率
    /// </summary>
    public static double CalculateBlockChance(
        bool hasShield,
        double baseBlockChance,
        int strength,
        int shieldItemLevel,
        BlockMechanicsConfig config)
    {
        if (!hasShield) return 0;
        
        double blockChance = baseBlockChance;
        blockChance += strength * config.BlockChancePerStrength;
        blockChance += shieldItemLevel * config.BlockChancePerItemLevel;
        
        return Math.Min(blockChance, config.MaxBlockChance);
    }
    
    /// <summary>
    /// 应用格挡减伤
    /// </summary>
    public static int ApplyBlockReduction(int rawDamage, double blockReduction)
    {
        return (int)Math.Ceiling(rawDamage * (1.0 - blockReduction));
    }
}
```

#### 格挡触发流程

```
1. 敌人攻击命中
2. 判定格挡（Random < BlockChance）
3. 如果格挡成功：
   - 伤害 × (1 - BlockDamageReduction)
   - 记录格挡事件
4. 如果格挡失败：
   - 正常计算护甲减伤
```

---

### 4.6 职业装备限制

#### 职业配置

```csharp
public class ProfessionEquipmentConfig
{
    public string ProfessionId { get; set; }
    public string DisplayName { get; set; }
    
    // 可装备的护甲类型（优先级从高到低）
    public List<ArmorType> AllowedArmorTypes { get; set; }
    
    // 可装备的武器类型
    public List<WeaponType> AllowedWeaponTypes { get; set; }
    
    // 是否可双持
    public bool CanDualWield { get; set; }
    
    // 特殊限制
    public Dictionary<string, bool> SpecialRules { get; set; }
}
```

#### 职业装备兼容性矩阵

| 职业 | 护甲类型 | 可用武器 | 双持 | 特殊规则 |
|-----|---------|---------|------|---------|
| **战士 (Warrior)** | Plate, Mail, Leather, Cloth | Sword, Axe, Mace, TwoHandSword, TwoHandAxe, TwoHandMace, Polearm, Shield | ✅ | 可装备所有近战武器 |
| **游侠 (Ranger)** | Mail, Leather, Cloth | Sword, Dagger, Axe, Bow, Crossbow, Gun | ✅ | 远程武器专精 |
| **法师 (Mage)** | Cloth | Dagger, Wand, Staff | ❌ | 仅法系武器 |
| **盗贼 (Rogue)** | Leather, Cloth | Dagger, Sword, Fist, Bow, Crossbow | ✅ | 快速武器专精 |
| **牧师 (Priest)** | Cloth | Mace, Wand, Staff | ❌ | 治疗职业 |
| **萨满 (Shaman)** | Mail, Leather, Cloth | Mace, Axe, Staff, Shield | ❌ | 元素/增强双修 |
| **圣骑士 (Paladin)** | Plate, Mail, Leather, Cloth | Sword, Mace, TwoHandSword, TwoHandMace, Polearm, Shield | ❌ | 盾牌专精 |

#### 装备验证

```csharp
public class EquipmentValidator
{
    /// <summary>
    /// 验证职业是否可装备该物品
    /// </summary>
    public static bool CanEquip(
        string professionId,
        ArmorType armorType,
        WeaponType weaponType,
        ProfessionEquipmentConfig config)
    {
        // 检查护甲类型
        if (armorType != ArmorType.None && 
            !config.AllowedArmorTypes.Contains(armorType))
        {
            return false;
        }
        
        // 检查武器类型
        if (weaponType != WeaponType.None && 
            !config.AllowedWeaponTypes.Contains(weaponType))
        {
            return false;
        }
        
        return true;
    }
}
```

---

### 4.7 配置化设计

#### 配置文件结构

```json
// EquipmentSystemConfig.json
{
  "Version": "1.0",
  "ArmorTypes": [
    {
      "TypeId": "cloth",
      "DisplayName": "布甲",
      "BaseArmorMultiplier": 0.5,
      "StaminaMultiplier": 1.0,
      "SecondaryStatWeights": {
        "Intellect": 1.5,
        "SpellPower": 1.2
      }
    },
    {
      "TypeId": "plate",
      "DisplayName": "板甲",
      "BaseArmorMultiplier": 2.0,
      "StaminaMultiplier": 1.5,
      "SecondaryStatWeights": {
        "Strength": 1.3,
        "Stamina": 1.5
      }
    }
  ],
  "WeaponTypes": [
    {
      "TypeId": "sword",
      "DisplayName": "剑",
      "BaseAttackSpeed": 2.5,
      "AttackPowerMultiplier": 1.0,
      "IsTwoHanded": false,
      "AllowsDualWield": true
    },
    {
      "TypeId": "two_hand_sword",
      "DisplayName": "双手剑",
      "BaseAttackSpeed": 3.5,
      "AttackPowerMultiplier": 1.75,
      "IsTwoHanded": true,
      "AllowsDualWield": false
    }
  ],
  "ProfessionRestrictions": [
    {
      "ProfessionId": "warrior",
      "DisplayName": "战士",
      "AllowedArmorTypes": ["plate", "mail", "leather", "cloth"],
      "AllowedWeaponTypes": ["sword", "axe", "mace", "two_hand_sword", "two_hand_axe", "two_hand_mace", "polearm", "shield"],
      "CanDualWield": true
    }
  ],
  "CombatMechanics": {
    "Armor": {
      "ReductionConstant": 400,
      "MaxReduction": 0.75
    },
    "Block": {
      "BaseBlockChance": 0.05,
      "BlockDamageReduction": 0.30,
      "BlockChancePerStrength": 0.001,
      "BlockChancePerItemLevel": 0.002,
      "MaxBlockChance": 0.50
    },
    "DualWield": {
      "AttackPowerCoefficient": 0.85,
      "MissChancePenalty": 0.19
    }
  }
}
```

#### 配置加载类

```csharp
public class EquipmentSystemConfiguration
{
    public string Version { get; set; }
    public List<ArmorTypeConfig> ArmorTypes { get; set; }
    public List<WeaponTypeConfig> WeaponTypes { get; set; }
    public List<ProfessionEquipmentConfig> ProfessionRestrictions { get; set; }
    public CombatMechanicsConfig CombatMechanics { get; set; }
    
    // 单例模式
    private static EquipmentSystemConfiguration? _instance;
    public static EquipmentSystemConfiguration Instance
    {
        get
        {
            if (_instance == null)
            {
                _instance = LoadFromJson("EquipmentSystemConfig.json");
            }
            return _instance;
        }
    }
    
    private static EquipmentSystemConfiguration LoadFromJson(string path)
    {
        // 实现 JSON 加载逻辑
        throw new NotImplementedException();
    }
}
```

---

## 详细执行计划

### Phase 1: 数据模型与配置基础 (第1-2周)

#### 目标
建立完整的装备系统数据模型和配置基础设施

#### 任务清单

- [ ] **1.1 创建枚举和基础类型**
  - 创建 `ArmorType` 枚举
  - 创建 `WeaponType` 枚举
  - 创建 `EquipmentSlot` 枚举（17个槽位）
  - 创建 `SlotCategory` 枚举

- [ ] **1.2 创建配置类**
  - `ArmorTypeConfig` - 护甲类型配置
  - `WeaponTypeConfig` - 武器类型配置
  - `EquipmentSlotConfig` - 槽位配置
  - `ProfessionEquipmentConfig` - 职业装备限制配置
  - `CombatMechanicsConfig` - 战斗机制配置
  - `EquipmentSystemConfiguration` - 主配置类

- [ ] **1.3 创建配置文件**
  - `EquipmentSystemConfig.json` - JSON 配置文件
  - 定义所有护甲类型的初始值
  - 定义所有武器类型的初始值
  - 定义所有职业的装备限制

- [ ] **1.4 配置加载服务**
  - `EquipmentConfigurationService` - 配置加载和缓存
  - 实现配置验证逻辑
  - 实现配置热重载机制（可选）

- [ ] **1.5 扩展现有数据模型**
  ```csharp
  // 扩展 GearInstanceDto
  public ArmorType ArmorType { get; set; }
  public WeaponType WeaponType { get; set; }
  public double BaseArmor { get; set; }
  public double BaseAttackSpeed { get; set; }
  public double AttackPowerMultiplier { get; set; }
  public double BlockChance { get; set; }
  public double BlockReduction { get; set; }
  ```

- [ ] **1.6 单元测试**
  - 测试所有配置类的序列化/反序列化
  - 测试配置验证逻辑
  - 测试枚举值的完整性

#### 验收标准
- ✅ 所有枚举和配置类定义完整
- ✅ JSON 配置文件可正常加载
- ✅ 配置验证通过
- ✅ 单元测试覆盖率 ≥ 90%

---

### Phase 2: 装备槽位与护甲系统 (第3-4周)

#### 目标
实现17个装备槽位和护甲类型系统

#### 任务清单

- [ ] **2.1 更新装备槽位系统**
  - 扩展 `EquipmentSlotDto` 支持17个槽位
  - 实现槽位占用检查（双手武器）
  - 更新 `EquipmentController` API

- [ ] **2.2 实现护甲计算逻辑**
  - `ArmorCalculator` 类
  - 实现护甲值计算公式
  - 实现护甲减伤计算
  - 集成到战斗伤害计算

- [ ] **2.3 装备生成器增强**
  - 根据护甲类型生成基础属性
  - 随机词条时考虑护甲类型倾向
  - Tier 系数应用

- [ ] **2.4 数据库迁移**
  - 添加 `ArmorType` 字段到装备表
  - 添加 `BaseArmor` 字段
  - 添加新的装备槽位记录
  - 迁移现有装备数据

- [ ] **2.5 装备属性聚合**
  - 实现总护甲值计算
  - 更新 `CharacterStats` 包含总护甲
  - 护甲显示在角色面板

- [ ] **2.6 单元测试与集成测试**
  - 测试护甲计算公式
  - 测试装备槽位占用
  - 测试护甲减伤效果
  - 集成测试：装备护甲影响战斗

#### 验收标准
- ✅ 17个装备槽位可正常使用
- ✅ 护甲减伤在战斗中生效
- ✅ 不同护甲类型有明显差异
- ✅ 测试通过率 100%

---

### Phase 3: 武器系统与战斗机制 (第5-7周)

#### 目标
实现武器类型系统、攻击速度机制、格挡机制

#### 任务清单

- [ ] **3.1 武器类型实现**
  - 扩展 `GearInstanceDto` 添加武器属性
  - 实现武器类型配置加载
  - 武器生成时应用攻击速度和倍率

- [ ] **3.2 攻击速度计算**
  - `AttackSpeedCalculator` 类
  - 实现基础攻击速度从武器获取
  - 实现急速属性影响攻击速度
  - 双持武器平均速度计算

- [ ] **3.3 伤害计算重构**
  - 集成武器攻击倍率
  - 双持武器伤害计算（0.85系数）
  - 更新 `DamageCalculator`

- [ ] **3.4 格挡机制实现**
  - `BlockCalculator` 类
  - 盾牌装备检测
  - 格挡概率计算
  - 格挡减伤应用
  - 集成到战斗事件流

- [ ] **3.5 战斗系统集成**
  - 更新 `BattleRunner` 使用新的攻击速度
  - 更新 `TrackState` 考虑武器速度
  - 在 `ReceiveDamage` 前添加格挡判定
  - 记录格挡事件到 `SegmentCollector`

- [ ] **3.6 双手武器机制**
  - 装备双手武器时自动卸下副手
  - 卸下双手武器时可装备副手
  - UI 提示和验证

- [ ] **3.7 单元测试与集成测试**
  - 测试各武器类型攻击速度
  - 测试武器倍率计算
  - 测试双持伤害计算
  - 测试格挡触发和减伤
  - 测试双手武器占用逻辑
  - 集成测试：完整战斗流程

#### 验收标准
- ✅ 不同武器类型有不同攻击速度和伤害
- ✅ 双持武器计算正确
- ✅ 格挡机制正常工作
- ✅ 双手武器正确占用主副手槽位
- ✅ 战斗日志记录详细
- ✅ 测试覆盖率 ≥ 85%

---

### Phase 4: 职业限制与平衡调整 (第8-9周)

#### 目标
实现职业装备限制系统并进行数值平衡

#### 任务清单

- [ ] **4.1 装备限制验证**
  - `EquipmentValidator` 类
  - 职业-护甲类型验证
  - 职业-武器类型验证
  - 双持能力验证

- [ ] **4.2 装备 API 集成**
  - 更新 `POST /api/equipment/{characterId}/{slot}` 
  - 添加装备前验证
  - 返回友好错误信息
  - 前端错误提示

- [ ] **4.3 职业配置完善**
  - 完成所有职业的装备限制配置
  - 平衡不同职业的装备选择
  - 特殊规则实现（如战士盾牌格挡加成）

- [ ] **4.4 装备推荐系统**
  - 根据职业推荐装备类型
  - 计算装备评分（考虑职业）
  - 装备对比功能

- [ ] **4.5 数值平衡测试**
  - 模拟不同职业装备配置的战斗
  - 调整护甲/武器系数
  - 确保职业平衡

- [ ] **4.6 单元测试**
  - 测试所有职业的装备限制
  - 测试装备验证逻辑
  - 测试边界情况

#### 验收标准
- ✅ 所有职业装备限制正确生效
- ✅ 非法装备尝试被正确拒绝
- ✅ 职业间平衡性良好
- ✅ 测试通过率 100%

---

### Phase 5: 前端实现与测试 (第10-12周)

#### 目标
实现前端装备界面并完成全系统测试

#### 任务清单

- [ ] **5.1 装备面板UI重构**
  - 扩展 `EquipmentPanel.razor` 支持17个槽位
  - 新布局设计（左右两列或纸娃娃风格）
  - 槽位图标和名称更新

- [ ] **5.2 装备详情增强**
  - 显示护甲类型和数值
  - 显示武器类型和攻击速度
  - 显示格挡概率（如装备盾牌）
  - 职业限制提示

- [ ] **5.3 装备对比功能**
  - Tooltip 显示对比信息
  - 高亮属性变化
  - DPS 计算显示

- [ ] **5.4 总属性面板扩展**
  - 显示总护甲值
  - 显示攻击速度
  - 显示格挡概率和减伤
  - 显示有效DPS

- [ ] **5.5 装备筛选和排序**
  - 按槽位筛选
  - 按职业可用筛选
  - 按品质排序

- [ ] **5.6 错误提示优化**
  - 装备限制友好提示
  - 双手武器占用警告
  - 动画和视觉反馈

- [ ] **5.7 全系统测试**
  - E2E 测试：完整装备流程
  - 性能测试：装备计算耗时
  - 兼容性测试：现有数据迁移
  - 压力测试：大量装备处理

- [ ] **5.8 文档完善**
  - 用户手册：装备系统说明
  - 开发文档：API 文档
  - 配置文档：配置文件说明

#### 验收标准
- ✅ 前端UI美观易用
- ✅ 所有功能正常工作
- ✅ 无严重bug
- ✅ 性能满足要求（装备切换 < 200ms）
- ✅ 文档完整

---

## 技术规范

### 代码规范

1. **命名规范**
   - 枚举使用 PascalCase
   - 配置类后缀 `Config`
   - 计算器类后缀 `Calculator`
   - 验证器类后缀 `Validator`

2. **注释规范**
   - 所有公开类和方法必须有 XML 文档注释
   - 复杂算法必须有解释性注释
   - 配置项必须有说明注释

3. **错误处理**
   - 使用自定义异常 `EquipmentException`
   - 记录详细错误日志
   - 返回友好错误信息给前端

### 性能优化

1. **缓存策略**
   - 配置加载后缓存
   - 装备属性计算结果缓存
   - 职业限制查询缓存

2. **数据库优化**
   - 为装备类型字段添加索引
   - 批量查询装备
   - 使用 EF Core 的 Include 减少查询次数

3. **前端优化**
   - 装备列表虚拟滚动
   - 图标懒加载
   - 属性计算防抖

### 测试策略

1. **单元测试**
   - 覆盖所有计算逻辑
   - 测试边界条件
   - 使用 xUnit + FluentAssertions

2. **集成测试**
   - 测试装备-战斗集成
   - 测试装备-职业限制集成
   - 使用内存数据库

3. **E2E测试**
   - 使用 Playwright 测试前端流程
   - 测试完整装备切换场景

---

## 数值平衡设计

### 护甲减伤平衡

| 护甲值 | vs Lv10敌人 | vs Lv30敌人 | vs Lv50敌人 |
|-------|------------|------------|------------|
| 100 | 20.0% | 11.1% | 4.8% |
| 300 | 42.9% | 27.3% | 13.0% |
| 600 | 60.0% | 42.9% | 23.1% |
| 1000 | 71.4% | 55.6% | 33.3% |
| 2000 | **75.0% (cap)** | 71.4% | 50.0% |

**设计原则**:
- 同等级护甲约50%减伤
- 高等级护甲渐进递减
- 75%上限防止无敌

### 武器DPS平衡

| 装备组合 | 攻击速度 | 基础伤害 | DPS | 备注 |
|---------|---------|---------|-----|------|
| 单手剑 | 2.5s | 100 | 40 | 基准 |
| 双手剑 | 3.5s | 175 | 50 | +25% DPS |
| 双持（剑+剑） | 2.5s | 170 | 68 | +70% DPS 但双持系数0.85，实际约58 |
| 双持（匕首+匕首） | 1.8s | 123 | 68 | 快速风格 |

**设计原则**:
- 双手武器 DPS +25%
- 双持 DPS +40% (考虑0.85系数)
- 不同武器类型风格差异明显

### 职业平衡

| 职业 | 生存能力 | 伤害输出 | 特色 |
|-----|---------|---------|------|
| 战士 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | 高护甲+盾牌格挡 |
| 游侠 | ⭐⭐⭐ | ⭐⭐⭐⭐ | 远程DPS |
| 法师 | ⭐⭐ | ⭐⭐⭐⭐⭐ | 高爆发，低防御 |
| 盗贼 | ⭐⭐⭐ | ⭐⭐⭐⭐ | 双持暴击 |

---

## 扩展性设计

### 预留接口

#### 1. 附魔系统接口
```csharp
public interface IEnchantment
{
    string Id { get; }
    EquipmentSlot ApplicableSlot { get; }
    Dictionary<string, double> BonusStats { get; }
}
```

#### 2. 宝石插槽接口
```csharp
public interface IGemSocket
{
    SocketColor Color { get; }
    IGem? InsertedGem { get; }
}
```

#### 3. 装备特效接口
```csharp
public interface IEquipmentEffect
{
    string Id { get; }
    EffectTrigger Trigger { get; }  // OnEquip, OnHit, OnCrit, etc.
    void Apply(BattleContext context);
}
```

#### 4. 套装奖励接口
```csharp
public interface ISetBonus
{
    string SetId { get; }
    int RequiredPieces { get; }
    Dictionary<string, double> BonusStats { get; }
    IEquipmentEffect? SpecialEffect { get; }
}
```

### 非战斗职业预留

#### 采集职业装备槽位
- **Mining (采矿)**: 矿镐槽位、护目镜、工作服
- **Herbalism (草药学)**: 草药刀、采集包
- **Skinning (剥皮)**: 剥皮刀、工具包

#### 生产职业装备槽位
- **Blacksmithing (锻造)**: 铁锤、护目镜、围裙
- **Alchemy (炼金)**: 药剂瓶、炼金台（可穿戴设备）
- **Enchanting (附魔)**: 附魔棒、符文工具

#### 配置示例
```json
{
  "NonCombatProfessions": [
    {
      "ProfessionId": "mining",
      "DisplayName": "采矿",
      "EquipmentSlots": ["tool", "headgear", "workwear"],
      "ToolTypes": ["pickaxe"],
      "BonusStats": ["MiningSpeed", "YieldBonus"]
    }
  ]
}
```

---

## 风险评估与应对

### 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|-----|------|------|---------|
| **数据迁移失败** | 高 | 中 | 编写回滚脚本，分阶段迁移，充分测试 |
| **性能下降** | 中 | 中 | 添加缓存，优化查询，性能测试 |
| **战斗平衡问题** | 中 | 高 | 数值模拟，灰度发布，快速调整配置 |
| **前端兼容性** | 低 | 低 | 浏览器测试，渐进增强 |

### 设计风险

| 风险 | 影响 | 概率 | 应对措施 |
|-----|------|------|---------|
| **职业不平衡** | 中 | 高 | 持续监控数据，定期调整系数 |
| **装备复杂度过高** | 中 | 中 | 提供装备推荐，简化UI |
| **配置过于复杂** | 低 | 中 | 提供配置工具，完善文档 |

### 项目风险

| 风险 | 影响 | 概率 | 应对措施 |
|-----|------|------|---------|
| **开发时间超期** | 中 | 中 | 分阶段交付，关键功能优先 |
| **需求变更** | 低 | 低 | 保持架构灵活性，模块化设计 |
| **测试不充分** | 高 | 中 | 自动化测试，充足测试时间 |

---

## 附录

### A. 词汇表

| 术语 | 英文 | 说明 |
|-----|------|------|
| 护甲类型 | Armor Type | Cloth/Leather/Mail/Plate |
| 武器类型 | Weapon Type | Sword/Axe/Staff等 |
| 装备槽位 | Equipment Slot | 17个装备位置 |
| 格挡 | Block | 盾牌特有的减伤机制 |
| 攻击倍率 | Attack Power Multiplier | 武器伤害系数 |
| DPS | Damage Per Second | 每秒伤害 |
| 双持 | Dual Wield | 同时装备两把单手武器 |

### B. 配置示例完整版

见配置文件 `EquipmentSystemConfig.json`

### C. 数据库Schema变更

```sql
-- 装备表新增字段
ALTER TABLE GearInstances
ADD ArmorType VARCHAR(20),
    WeaponType VARCHAR(30),
    BaseArmor FLOAT DEFAULT 0,
    BaseAttackSpeed FLOAT DEFAULT 0,
    AttackPowerMultiplier FLOAT DEFAULT 1.0,
    BlockChance FLOAT DEFAULT 0,
    BlockReduction FLOAT DEFAULT 0;

-- 装备槽位表新增
CREATE TABLE EquipmentSlots (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    CharacterId UNIQUEIDENTIFIER NOT NULL,
    SlotType VARCHAR(20) NOT NULL,
    GearInstanceId UNIQUEIDENTIFIER NULL,
    FOREIGN KEY (CharacterId) REFERENCES Characters(Id),
    FOREIGN KEY (GearInstanceId) REFERENCES GearInstances(Id)
);
```

### D. API 变更清单

#### 新增 API
- `GET /api/equipment/config` - 获取装备系统配置
- `POST /api/equipment/{characterId}/validate` - 验证装备是否可装备

#### 修改 API
- `POST /api/equipment/{characterId}/{slot}` - 增加装备验证
- `GET /api/equipment/{characterId}` - 返回17个槽位

### E. 测试用例清单

1. **单元测试** (约150个用例)
   - 枚举和配置加载测试 (20)
   - 护甲计算测试 (15)
   - 武器类型测试 (20)
   - 格挡机制测试 (15)
   - 职业限制测试 (30)
   - 双持计算测试 (10)
   - 双手武器占用测试 (10)
   - 边界条件测试 (30)

2. **集成测试** (约50个用例)
   - 装备-战斗集成 (20)
   - 装备-属性集成 (15)
   - 装备-UI集成 (15)

3. **E2E测试** (约20个用例)
   - 完整装备流程 (10)
   - 职业切换装备 (5)
   - 战斗效果验证 (5)

---

## 总结

本设计方案详细规划了 BlazorIdle 装备系统的优化升级路径，从当前的9个槽位基础系统扩展为类似《魔兽世界》的完整装备体系。

### 关键亮点

1. **完整性**: 17个装备槽位，护甲类型，武器类型，格挡机制
2. **可配置性**: 所有参数通过JSON配置，易于调整平衡
3. **可扩展性**: 预留附魔、宝石、套装等高级功能接口
4. **职业特色**: 通过装备限制和属性倾向体现职业差异
5. **数值平衡**: 详细的平衡设计确保游戏体验
6. **渐进实施**: 5个Phase分阶段实施，风险可控

### 预期效果

- 装备系统深度提升 **300%**
- 职业差异化增强 **200%**
- 战斗策略性提升 **150%**
- 玩家留存率提升 **50%** (预期)

### 下一步

1. 团队评审本设计方案
2. 确认各Phase时间表
3. 分配开发任务
4. 启动 Phase 1 实施

---

**文档结束**

如有疑问或需要调整，请联系设计团队。

**维护记录**:
- 2025-10-11: 初始版本创建
