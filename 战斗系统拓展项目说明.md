# 战斗系统拓展项目 - 项目说明书

## 📖 文档导航

欢迎！本项目包含战斗系统拓展的完整设计方案。根据您的需求，请选择相应文档：

### 🎯 快速开始
- **[执行摘要 (EXECUTIVE_SUMMARY.md)](EXECUTIVE_SUMMARY.md)** - 5 分钟了解项目全貌
  - 适合：项目经理、决策者
  - 内容：业务价值、成本估算、风险评估、决策建议

### 📋 详细设计
- **[详细实施方案 (战斗系统拓展详细方案.md)](战斗系统拓展详细方案.md)** - 完整技术设计文档
  - 适合：架构师、技术负责人、核心开发者
  - 内容：70+ 页详细设计，包括架构、技术方案、测试策略、风险分析
  - 语言：中文
  - 预计阅读时间：2-3 小时

### 🔍 快速查阅
- **[快速参考指南 (BATTLE_EXPANSION_QUICK_REFERENCE.md)](BATTLE_EXPANSION_QUICK_REFERENCE.md)** - 关键信息速查
  - 适合：所有技术人员
  - 内容：Phase 概览、核心组件、配置参数、测试策略
  - 语言：英文
  - 预计阅读时间：15-20 分钟

### 🗺️ 实施路线
- **[实施路线图 (IMPLEMENTATION_ROADMAP.md)](IMPLEMENTATION_ROADMAP.md)** - 可视化进度跟踪
  - 适合：项目经理、开发者
  - 内容：时间线、架构图、数据流图、进度模板
  - 语言：中英文
  - 预计阅读时间：30-40 分钟

---

## 🎯 项目目标

本项目旨在扩展现有的基于事件调度的战斗引擎，实现以下核心功能：

### 1️⃣ 玩家死亡与复活系统
- 玩家可受伤、死亡（HP → 0）
- 死亡时暂停攻击进度、技能施放
- 自动复活机制（默认 10 秒）
- 降低挂机挫败感，战斗不立即结束

### 2️⃣ 多目标选取与仇恨系统
- 攻击/技能随机选择目标
- 基于权重的概率分配（默认均等）
- 预留仇恨值接口（嘲讽、仇恨调整）
- 为多人战斗打下基础

### 3️⃣ 怪物攻击与技能系统
- 怪物具有基础攻击能力
- 独立的怪物技能池
- 轻量级技能模型：冷却 + 概率 + 触发条件
- 不引入复杂资源系统（法力、怒气等）

### 4️⃣ 强化型副本预留
- 可配置关闭自动复活
- 死亡触发整轮重置
- 强化掉落倍率
- 向后兼容普通副本

### 5️⃣ 战斗回放与 RNG 一致性
- 所有随机事件使用 RngContext
- 记录 RNG Index 确保可重放
- 离线快进与在线战斗逻辑一致

### 6️⃣ 最小增量原则
- 不重写现有玩家侧系统
- 保持向后兼容
- 预留 Actor 抽象演进路线

---

## 📊 项目规模

| 指标 | 数值 |
|------|------|
| **实施阶段** | 8 个 Phase |
| **预计工期** | 4-5 个月（20 周）|
| **人力需求** | 1.5 人（1 核心开发 + 0.5 测试）|
| **代码规模** | 约 15 个新类，10 个扩展类 |
| **测试用例** | 50+ 单元测试，10+ 集成测试 |
| **文档页数** | 70+ 页技术文档 |

---

## 🏗️ 核心架构

### 现有系统
```
BattleEngine (事件驱动)
  ├─ EventScheduler (优先队列)
  ├─ BattleContext (战斗上下文)
  │   ├─ ResourceSet (资源管理)
  │   ├─ BuffManager (Buff 系统)
  │   ├─ AutoCastEngine (技能自动施放)
  │   └─ ProcManager (触发器)
  ├─ CharacterStats (玩家统计)
  └─ EncounterGroup (怪物组)
```

### 扩展后系统
```
BattleEngine (事件驱动 - 增强)
  ├─ EventScheduler (新增 4 种事件)
  │   ├─ AttackTickEvent (现有)
  │   ├─ SpecialPulseEvent (现有)
  │   ├─ PlayerDeathEvent (新增)
  │   ├─ PlayerReviveEvent (新增)
  │   ├─ EnemyAttackEvent (新增)
  │   └─ EnemySkillCastEvent (新增)
  ├─ BattleContext (扩展)
  │   ├─ PlayerCombatant (新增 - 实现 ICombatant)
  │   ├─ EnemyCombatant[] (新增 - 实现 ICombatant)
  │   └─ TargetSelector (新增 - 加权随机)
  └─ SkillManager
      ├─ AutoCastEngine (现有 - 玩家技能)
      └─ EnemySkillManager (新增 - 怪物技能)
```

---

## 🔄 实施流程

### Phase 1-2: 基础层（1 个月）
```
Week 1-2: ICombatant 接口 + PlayerCombatant + EnemyCombatant
Week 3-4: TargetSelector + 随机目标选择
```

### Phase 3-4: 核心玩法（2 个月）
```
Week 5-7:  玩家死亡复活系统
Week 8-10: 怪物攻击能力
```

### Phase 5-6: 深度功能（1.5 个月）
```
Week 11-13: 怪物技能系统
Week 14-15: 强化副本功能
```

### Phase 7-8: 完善品质（1 个月）
```
Week 16-17: RNG 一致性验证
Week 18-20: 集成测试与优化
```

---

## ✅ 验收标准

### 功能完整性
- [x] 玩家可受伤、死亡、复活
- [x] 怪物可攻击玩家
- [x] 攻击/技能随机选择目标
- [x] 怪物可释放技能
- [x] 强化副本支持死亡重置
- [x] 战斗回放一致性

### 技术质量
- [x] 单元测试覆盖率 > 85%
- [x] 性能下降 < 5%
- [x] 代码符合项目规范
- [x] 文档完整准确

### 兼容性
- [x] 现有战斗不受影响
- [x] 向后兼容性测试通过
- [x] API 变更已文档化

---

## 🚀 如何开始

### 1. 阅读文档
根据您的角色选择相应文档（见顶部导航）

### 2. 理解现有系统
- 阅读 `整合设计总结.txt` 了解当前架构
- 阅读 `战斗功能分析与下阶段规划.md` 了解背景

### 3. 审查设计方案
- 技术负责人：详细阅读 `战斗系统拓展详细方案.md`
- 开发者：快速浏览 `BATTLE_EXPANSION_QUICK_REFERENCE.md`
- 项目经理：审阅 `EXECUTIVE_SUMMARY.md`

### 4. 准备开发环境
```bash
# 克隆仓库
git clone https://github.com/Solaireshen97/BlazorIdle.git
cd BlazorIdle

# 构建项目
dotnet build

# 运行测试（确保基线通过）
dotnet test
```

### 5. 启动 Phase 1
- 创建开发分支：`feature/battle-expansion-phase1`
- 按照 `战斗系统拓展详细方案.md` 第 4.1 节执行
- 使用 `IMPLEMENTATION_ROADMAP.md` 中的进度模板跟踪

---

## 📝 开发规范

### Git 提交规范
```
feat: 新功能
fix: Bug 修复
refactor: 重构
test: 测试相关
docs: 文档更新
perf: 性能优化
```

示例：
```
feat(combat): add ICombatant interface
test(combat): add target selector distribution tests
docs(combat): update battle expansion plan
```

### 代码审查清单
- [ ] 所有随机事件使用 RngContext
- [ ] 单元测试覆盖率 > 80%
- [ ] 性能基准测试通过
- [ ] 向后兼容性测试通过
- [ ] 代码符合 C# 规范
- [ ] XML 注释完整

### 测试规范
- 每个新类必须有对应测试类
- 关键路径 100% 覆盖
- 集成测试覆盖主要场景
- 性能测试对比基线

---

## 🐛 问题反馈

### 报告 Bug
1. 在 GitHub Issues 中创建问题
2. 使用标签：`bug`, `battle-expansion`
3. 提供：
   - 问题描述
   - 复现步骤
   - 预期结果 vs 实际结果
   - 环境信息

### 提出建议
1. 在 GitHub Issues 中创建问题
2. 使用标签：`enhancement`, `battle-expansion`
3. 说明：
   - 改进目标
   - 业务价值
   - 实现建议

### 提问
1. 在 GitHub Discussions 中发帖
2. 或联系项目负责人

---

## 📚 参考资料

### 项目文档
- [整合设计总结.txt](整合设计总结.txt) - 现有系统架构
- [战斗功能分析与下阶段规划.md](战斗功能分析与下阶段规划.md) - 之前规划
- [战斗攻击进度优化报告.md](战斗攻击进度优化报告.md) - 历史优化

### 技术文档
- BattleEngine 源码：`BlazorIdle.Server/Domain/Combat/Engine/BattleEngine.cs`
- EventScheduler 源码：`BlazorIdle.Server/Domain/Combat/EventScheduler.cs`
- 测试示例：`tests/BlazorIdle.Tests/BattleInfoTransmissionTests.cs`

### 外部资源
- [事件驱动架构](https://martinfowler.com/articles/201701-event-driven.html)
- [游戏 AI 设计](https://www.gamedeveloper.com/programming/behavior-trees-for-ai-how-they-work)
- [RNG 可重放性](https://en.wikipedia.org/wiki/Pseudorandom_number_generator)

---

## 👥 团队联系

| 角色 | 职责 | 联系方式 |
|------|------|---------|
| 项目负责人 | 整体协调、进度管理 | [待定] |
| 技术负责人 | 架构设计、技术审查 | [待定] |
| 开发工程师 | 代码实现、单元测试 | [待定] |
| 测试工程师 | 测试用例、集成测试 | [待定] |

---

## 📅 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 1.0 | 2025-01 | 初始版本：完整设计方案 |

---

## ⚖️ 许可证

本项目遵循与主项目相同的许可证。

---

**最后更新**: 2025-01  
**文档状态**: ✅ 完成  
**项目状态**: 📝 等待审核启动

**下一步**: 请阅读 [执行摘要](EXECUTIVE_SUMMARY.md) 了解项目全貌，然后决定是否启动实施。
