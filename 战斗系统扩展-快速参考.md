# æˆ˜æ–—ç³»ç»Ÿæ‰©å±• - å¿«é€Ÿå‚è€ƒ

**çŠ¶æ€**: è®¾è®¡é˜¶æ®µå®Œæˆ âœ…  
**è¯¦ç»†æ–‡æ¡£**: 
- æˆ˜æ–—ç³»ç»Ÿæ‰©å±•-åˆ†é˜¶æ®µå®æ–½æ–¹æ¡ˆ.md (å®Œæ•´è®¾è®¡)
- æˆ˜æ–—ç³»ç»Ÿæ‰©å±•-æ¶æ„å›¾è§£.md (æ¶æ„å›¾)

---

## ğŸ¯ å››å¤§æ ¸å¿ƒåŠŸèƒ½

| # | åŠŸèƒ½ | ç›®çš„ | ä¼˜å…ˆçº§ |
|---|------|------|--------|
| 1 | **ç©å®¶å¤æ´»æœºåˆ¶** | æ­»äº¡å10ç§’è‡ªåŠ¨å¤æ´»ï¼Œé™ä½æŒ«è´¥æ„Ÿ | P0 |
| 2 | **æ™ºèƒ½ç›®æ ‡é€‰å–** | å¤šæ€ªç‰©æ—¶éšæœºé€‰æ‹©ï¼Œé¢„ç•™å˜²è®½æ¥å£ | P1 |
| 3 | **Enhanced Dungeon** | é«˜éš¾åº¦æ¨¡å¼ï¼šç¦ç”¨å¤æ´»+å¼ºåŒ–æ‰è½ | P2 |
| 4 | **æ€ªç‰©æ”»å‡»ä¸æŠ€èƒ½** | æ€ªç‰©ä¼šåå‡»ï¼Œä½¿ç”¨ç®€åŒ–æŠ€èƒ½ç³»ç»Ÿ | P1 |

---

## ğŸ“… å®æ–½æ—¶é—´è¡¨

```
Week 1
â”œâ”€ Day 1-5:  é˜¶æ®µ1 - ç©å®¶å¤æ´»æœºåˆ¶
â”‚             â”œâ”€ PlayerState ç±»
â”‚             â”œâ”€ PlayerRevivalEvent
â”‚             â”œâ”€ å—ä¼¤é€»è¾‘
â”‚             â””â”€ å•å…ƒæµ‹è¯•
â”‚
â””â”€ Day 6-8:  é˜¶æ®µ2 - ç›®æ ‡é€‰å–ä¼˜åŒ–
              â”œâ”€ ThreatWeight å±æ€§
              â”œâ”€ TargetSelector ç±»
              â””â”€ å•å…ƒæµ‹è¯•

Week 2
â”œâ”€ Day 9-10: é˜¶æ®µ3 - Enhanced Dungeoné…ç½®
â”‚             â”œâ”€ BattleMeta æ‰©å±•
â”‚             â”œâ”€ BattleFailureEvent
â”‚             â””â”€ æ–‡æ¡£
â”‚
â”œâ”€ Day 11-18: é˜¶æ®µ4 - æ€ªç‰©æ”»å‡»ä¸æŠ€èƒ½
â”‚             â”œâ”€ EnemyDefinition æ‰©å±•
â”‚             â”œâ”€ MonsterAttackTickEvent
â”‚             â”œâ”€ MonsterSkillDefinition
â”‚             â”œâ”€ MonsterSkillSystem
â”‚             â””â”€ å®Œæ•´æµ‹è¯•

Week 3
â”œâ”€ Day 19-21: é˜¶æ®µ5 - é›†æˆæµ‹è¯•
â”‚             â”œâ”€ ç«¯åˆ°ç«¯æµ‹è¯•
â”‚             â”œâ”€ æ€§èƒ½æµ‹è¯•
â”‚             â””â”€ å›å½’æµ‹è¯•
â”‚
â””â”€ Day 22-23: æ–‡æ¡£å®¡æŸ¥
              â””â”€ å®æ–½å®ŒæˆæŠ¥å‘Š
```

---

## ğŸ—ï¸ æ–°å¢æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä»£ç  (9ä¸ªæ–°æ–‡ä»¶)

```
BlazorIdle.Server/Domain/Combat/
â”œâ”€ PlayerState.cs                  â­ ç©å®¶çŠ¶æ€ç®¡ç†
â”œâ”€ PlayerRevivalEvent.cs           â­ å¤æ´»äº‹ä»¶
â”œâ”€ BattleFailureEvent.cs           â­ æˆ˜æ–—å¤±è´¥äº‹ä»¶
â”œâ”€ TargetSelector.cs               â­ ç›®æ ‡é€‰å–å™¨
â”œâ”€ MonsterAttackTickEvent.cs       â­ æ€ªç‰©æ”»å‡»äº‹ä»¶
â”œâ”€ MonsterSkillDefinition.cs       â­ æ€ªç‰©æŠ€èƒ½å®šä¹‰
â”œâ”€ MonsterSkillSystem.cs           â­ æ€ªç‰©æŠ€èƒ½ç®¡ç†å™¨
â”œâ”€ MonsterSkillCheckEvent.cs       â­ æŠ€èƒ½æ£€æŸ¥äº‹ä»¶
â””â”€ SkillEffect.cs                  â­ æŠ€èƒ½æ•ˆæœå®šä¹‰
```

### æµ‹è¯•æ–‡ä»¶ (6ä¸ªæ–°æ–‡ä»¶)

```
tests/BlazorIdle.Tests/
â”œâ”€ PlayerRevivalTests.cs
â”œâ”€ TargetSelectionTests.cs
â”œâ”€ MonsterAttackTests.cs
â”œâ”€ MonsterSkillTests.cs
â”œâ”€ EnhancedDungeonTests.cs
â””â”€ CombatSystemRegressionTests.cs
```

### ä¿®æ”¹æ–‡ä»¶ (6ä¸ªç°æœ‰æ–‡ä»¶)

```
ä¿®æ”¹:
â”œâ”€ BattleContext.cs                (+PlayerState å­—æ®µ)
â”œâ”€ BattleEngine.cs                 (+æ€ªç‰©åˆå§‹åŒ–)
â”œâ”€ Encounter.cs                    (+ThreatWeight, +SkillSystem)
â”œâ”€ AttackTickEvent.cs              (+ç©å®¶æ­»äº¡æ£€æŸ¥, +éšæœºç›®æ ‡)
â”œâ”€ DamageCalculator.cs             (+ApplyDamageToPlayer)
â””â”€ EnemyDefinition.cs              (+æ”»å‡»å±æ€§, +æŠ€èƒ½æ± )

é…ç½®:
â””â”€ BattleMeta.cs                   (+å¤æ´»/Enhancedé…ç½®)

æ•°æ®:
â””â”€ EnemyRegistry.cs                (+ç¤ºä¾‹æ€ªç‰©å®šä¹‰)
```

---

## âš™ï¸ é…ç½®æ ‡å¿—é€ŸæŸ¥

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `EnablePlayerDeath` | `false` | å¯ç”¨ç©å®¶æ­»äº¡æœºåˆ¶ |
| `PlayerRevivalDelaySeconds` | `10.0` | å¤æ´»å»¶è¿Ÿ(ç§’) |
| `UseWeightedTargetSelection` | `false` | å¯ç”¨åŠ æƒç›®æ ‡é€‰å– |
| `AllowAutoRevival` | `true` | å…è®¸è‡ªåŠ¨å¤æ´» |
| `EnhancedDungeonMode` | `false` | Enhancedæ¨¡å¼ |
| `EnhancedDropMultiplier` | `1.0` | Enhancedæ‰è½å€ç‡ |

### å…¸å‹é…ç½®ç»„åˆ

```csharp
// 1. å‘åå…¼å®¹ï¼ˆé»˜è®¤ï¼‰
var meta = new BattleMeta(); // æ‰€æœ‰æ–°åŠŸèƒ½å…³é—­

// 2. æ ‡å‡†æˆ˜æ–—
var meta = new BattleMeta
{
    EnablePlayerDeath = true,
    UseWeightedTargetSelection = false
};

// 3. Enhanced Dungeon
var meta = new BattleMeta
{
    EnablePlayerDeath = true,
    AllowAutoRevival = false,
    EnhancedDungeonMode = true,
    EnhancedDropMultiplier = 2.5
};
```

---

## ğŸ” å…³é”®ç±»é€ŸæŸ¥

### PlayerState

```csharp
public class PlayerState
{
    public int CurrentHp { get; }
    public int MaxHp { get; }
    public bool IsDead => CurrentHp <= 0;
    public double? DeathTime { get; }
    public double? RevivalTime { get; }
    
    public void TakeDamage(int amount, double now)
    public void Revive(double now)
}
```

### TargetSelector

```csharp
public static class TargetSelector
{
    // ç­‰æ¦‚ç‡éšæœº
    public static Encounter? SelectRandomTarget(
        EncounterGroup group, RngContext rng)
    
    // åŠ æƒéšæœº
    public static Encounter? SelectWeightedRandomTarget(
        EncounterGroup group, RngContext rng)
}
```

### MonsterSkillDefinition

```csharp
public class MonsterSkillDefinition
{
    public string Id { get; }
    public double Cooldown { get; }
    public TriggerType Trigger { get; }
    public double TriggerProbability { get; }
    public SkillEffect Effect { get; }
}

public enum TriggerType
{
    OnCooldown,      // å†·å´å¥½äº†å°±ç”¨
    OnHpThreshold,   // è¡€é‡ä½äºé˜ˆå€¼
    OnPlayerAttack   // ç©å®¶æ”»å‡»æ—¶æ¦‚ç‡è§¦å‘
}
```

---

## ğŸ§ª æµ‹è¯•é‡ç‚¹

### 1. RNGä¸€è‡´æ€§æµ‹è¯•

```csharp
[Fact]
public void Same_Seed_Produces_Same_Battle()
{
    var seed = 12345UL;
    
    var battle1 = RunBattle(seed);
    var battle2 = RunBattle(seed);
    
    Assert.Equal(battle1.Context.Rng.Index, battle2.Context.Rng.Index);
    Assert.Equal(battle1.TotalDamage, battle2.TotalDamage);
}
```

### 2. ç©å®¶å¤æ´»æµ‹è¯•

```csharp
[Fact]
public void Player_Revives_After_Death()
{
    // è®©ç©å®¶æ­»äº¡
    // æ¨è¿›æ—¶é—´10ç§’
    // éªŒè¯å¤æ´»
}
```

### 3. ç›®æ ‡é€‰å–åˆ†å¸ƒæµ‹è¯•

```csharp
[Fact]
public void Random_Target_Has_Equal_Distribution()
{
    // 3ä¸ªæ•Œäººï¼Œæ”»å‡»1000æ¬¡
    // ç»Ÿè®¡æ¯ä¸ªæ•Œäººè¢«æ”»å‡»æ¬¡æ•°
    // éªŒè¯åˆ†å¸ƒ â‰ˆ 33.3% Â± 5%
}
```

### 4. æ€ªç‰©æ”»å‡»æµ‹è¯•

```csharp
[Fact]
public void Monster_Attacks_At_Regular_Intervals()
{
    // æ€ªç‰© AttackInterval = 2.0s
    // è¿è¡Œ10ç§’
    // éªŒè¯ç©å®¶å—åˆ°çº¦5æ¬¡æ”»å‡»
}
```

---

## âš ï¸ é£é™©æ£€æŸ¥æ¸…å•

### å¼€å‘å‰

- [ ] ç¡®è®¤æ‰€æœ‰æ–°é…ç½®é¡¹é»˜è®¤å€¼ä¸º"å…³é—­"æˆ–"æ—§è¡Œä¸º"
- [ ] ç¡®è®¤ç°æœ‰å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] å»ºç«‹æ€§èƒ½åŸºå‡†æµ‹è¯•

### å¼€å‘ä¸­

- [ ] æ¯æ¬¡æ·»åŠ  `context.Rng.Next*()` éƒ½é€šè¿‡å›æ”¾æµ‹è¯•
- [ ] æ¯æ¬¡ä¿®æ”¹äº‹ä»¶é€»è¾‘éƒ½æ£€æŸ¥ç©å®¶/æ€ªç‰©æ­»äº¡è¾¹ç•Œæƒ…å†µ
- [ ] æ¯æ¬¡æäº¤è¿è¡Œå›å½’æµ‹è¯•

### å¼€å‘å

- [ ] æ€§èƒ½æµ‹è¯•: ç¦»çº¿å¿«è¿›å¼€é”€ < 10%
- [ ] å›å½’æµ‹è¯•: æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
- [ ] RNGæµ‹è¯•: ç›¸åŒç§å­äº§ç”Ÿç›¸åŒç»“æœ
- [ ] å‘åå…¼å®¹: æ—§é…ç½®æˆ˜æ–—è¡Œä¸ºä¸å˜

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

| é˜¶æ®µ | éªŒæ”¶æ¡ä»¶ |
|------|---------|
| é˜¶æ®µ1 | âœ… ç©å®¶æ­»äº¡å10ç§’è‡ªåŠ¨å¤æ´» |
|       | âœ… æ­»äº¡æ—¶æ”»å‡»è¿›åº¦æš‚åœ |
|       | âœ… å¤æ´»åæ”»å‡»è¿›åº¦æ¢å¤ |
|       | âœ… RNGä¸€è‡´æ€§æµ‹è¯•é€šè¿‡ |
| é˜¶æ®µ2 | âœ… å¤šæ€ªç‰©æ—¶éšæœºé€‰æ‹©ç›®æ ‡ |
|       | âœ… æ¦‚ç‡åˆ†å¸ƒç¬¦åˆé¢„æœŸ |
|       | âœ… ThreatWeightæ¥å£å¯ç”¨ |
| é˜¶æ®µ3 | âœ… Enhancedæ¨¡å¼ç¦ç”¨å¤æ´»æˆåŠŸ |
|       | âœ… æ­»äº¡è§¦å‘BattleFailure |
|       | âœ… æ‰è½å€ç‡æ­£ç¡®åº”ç”¨ |
| é˜¶æ®µ4 | âœ… æ€ªç‰©å®šæœŸæ”»å‡»ç©å®¶ |
|       | âœ… æ€ªç‰©æŠ€èƒ½æŒ‰å†·å´è§¦å‘ |
|       | âœ… æŠ€èƒ½æ¦‚ç‡ç¬¦åˆé…ç½® |
|       | âœ… å‘åå…¼å®¹: AttackPower=0 ä¸æ”»å‡» |
| é˜¶æ®µ5 | âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ |
|       | âœ… é›†æˆæµ‹è¯•é€šè¿‡ |
|       | âœ… æ€§èƒ½æµ‹è¯•è¾¾æ ‡ |
|       | âœ… å›å½’æµ‹è¯•é€šè¿‡ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é˜…è¯»å®Œæ•´è®¾è®¡

```bash
# è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ
cat æˆ˜æ–—ç³»ç»Ÿæ‰©å±•-åˆ†é˜¶æ®µå®æ–½æ–¹æ¡ˆ.md

# æ¶æ„å›¾è§£
cat æˆ˜æ–—ç³»ç»Ÿæ‰©å±•-æ¶æ„å›¾è§£.md
```

### 2. åˆ›å»ºåˆ†æ”¯

```bash
git checkout -b feature/battle-system-expansion
```

### 3. å¼€å§‹é˜¶æ®µ1

```bash
# åˆ›å»ºç¬¬ä¸€ä¸ªæ–‡ä»¶
touch BlazorIdle.Server/Domain/Combat/PlayerState.cs

# å®ç° PlayerState ç±»
# å‚è€ƒè®¾è®¡æ–‡æ¡£ "é˜¶æ®µ1: ç©å®¶å¤æ´»æœºåˆ¶"
```

### 4. æäº¤å¹¶æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
dotnet test

# æäº¤æ›´æ”¹
git add .
git commit -m "Phase 1: Add PlayerState class"
```

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

- **è®¾è®¡æ–‡æ¡£**: æˆ˜æ–—ç³»ç»Ÿæ‰©å±•-åˆ†é˜¶æ®µå®æ–½æ–¹æ¡ˆ.md
- **æ¶æ„å›¾**: æˆ˜æ–—ç³»ç»Ÿæ‰©å±•-æ¶æ„å›¾è§£.md
- **é—®é¢˜åé¦ˆ**: åˆ›å»º GitHub Issue

---

## âœ… å®ŒæˆçŠ¶æ€

- [x] éœ€æ±‚åˆ†æ
- [x] æ¶æ„è®¾è®¡
- [x] è¯¦ç»†æ–¹æ¡ˆ
- [x] æ¶æ„å›¾è§£
- [x] å¿«é€Ÿå‚è€ƒ
- [ ] é˜¶æ®µ1å®æ–½ (å¾…å¯åŠ¨)
- [ ] é˜¶æ®µ2å®æ–½
- [ ] é˜¶æ®µ3å®æ–½
- [ ] é˜¶æ®µ4å®æ–½
- [ ] é˜¶æ®µ5å®æ–½
- [ ] æ–‡æ¡£å®¡æŸ¥

**å½“å‰çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œç­‰å¾…å®æ–½æ‰¹å‡† ğŸš¦

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-09  
**æœ€åæ›´æ–°**: 2025-01-09

