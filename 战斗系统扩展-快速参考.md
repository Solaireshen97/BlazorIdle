# 战斗系统扩展 - 快速参考

**状态**: 设计阶段完成 ✅  
**详细文档**: 
- 战斗系统扩展-分阶段实施方案.md (完整设计)
- 战斗系统扩展-架构图解.md (架构图)

---

## 🎯 四大核心功能

| # | 功能 | 目的 | 优先级 |
|---|------|------|--------|
| 1 | **玩家复活机制** | 死亡后10秒自动复活，降低挫败感 | P0 |
| 2 | **智能目标选取** | 多怪物时随机选择，预留嘲讽接口 | P1 |
| 3 | **Enhanced Dungeon** | 高难度模式：禁用复活+强化掉落 | P2 |
| 4 | **怪物攻击与技能** | 怪物会反击，使用简化技能系统 | P1 |

---

## 📅 实施时间表

```
Week 1
├─ Day 1-5:  阶段1 - 玩家复活机制
│             ├─ PlayerState 类
│             ├─ PlayerRevivalEvent
│             ├─ 受伤逻辑
│             └─ 单元测试
│
└─ Day 6-8:  阶段2 - 目标选取优化
              ├─ ThreatWeight 属性
              ├─ TargetSelector 类
              └─ 单元测试

Week 2
├─ Day 9-10: 阶段3 - Enhanced Dungeon配置
│             ├─ BattleMeta 扩展
│             ├─ BattleFailureEvent
│             └─ 文档
│
├─ Day 11-18: 阶段4 - 怪物攻击与技能
│             ├─ EnemyDefinition 扩展
│             ├─ MonsterAttackTickEvent
│             ├─ MonsterSkillDefinition
│             ├─ MonsterSkillSystem
│             └─ 完整测试

Week 3
├─ Day 19-21: 阶段5 - 集成测试
│             ├─ 端到端测试
│             ├─ 性能测试
│             └─ 回归测试
│
└─ Day 22-23: 文档审查
              └─ 实施完成报告
```

---

## 🏗️ 新增文件清单

### 核心代码 (9个新文件)

```
BlazorIdle.Server/Domain/Combat/
├─ PlayerState.cs                  ⭐ 玩家状态管理
├─ PlayerRevivalEvent.cs           ⭐ 复活事件
├─ BattleFailureEvent.cs           ⭐ 战斗失败事件
├─ TargetSelector.cs               ⭐ 目标选取器
├─ MonsterAttackTickEvent.cs       ⭐ 怪物攻击事件
├─ MonsterSkillDefinition.cs       ⭐ 怪物技能定义
├─ MonsterSkillSystem.cs           ⭐ 怪物技能管理器
├─ MonsterSkillCheckEvent.cs       ⭐ 技能检查事件
└─ SkillEffect.cs                  ⭐ 技能效果定义
```

### 测试文件 (6个新文件)

```
tests/BlazorIdle.Tests/
├─ PlayerRevivalTests.cs
├─ TargetSelectionTests.cs
├─ MonsterAttackTests.cs
├─ MonsterSkillTests.cs
├─ EnhancedDungeonTests.cs
└─ CombatSystemRegressionTests.cs
```

### 修改文件 (6个现有文件)

```
修改:
├─ BattleContext.cs                (+PlayerState 字段)
├─ BattleEngine.cs                 (+怪物初始化)
├─ Encounter.cs                    (+ThreatWeight, +SkillSystem)
├─ AttackTickEvent.cs              (+玩家死亡检查, +随机目标)
├─ DamageCalculator.cs             (+ApplyDamageToPlayer)
└─ EnemyDefinition.cs              (+攻击属性, +技能池)

配置:
└─ BattleMeta.cs                   (+复活/Enhanced配置)

数据:
└─ EnemyRegistry.cs                (+示例怪物定义)
```

---

## ⚙️ 配置标志速查

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `EnablePlayerDeath` | `false` | 启用玩家死亡机制 |
| `PlayerRevivalDelaySeconds` | `10.0` | 复活延迟(秒) |
| `UseWeightedTargetSelection` | `false` | 启用加权目标选取 |
| `AllowAutoRevival` | `true` | 允许自动复活 |
| `EnhancedDungeonMode` | `false` | Enhanced模式 |
| `EnhancedDropMultiplier` | `1.0` | Enhanced掉落倍率 |

### 典型配置组合

```csharp
// 1. 向后兼容（默认）
var meta = new BattleMeta(); // 所有新功能关闭

// 2. 标准战斗
var meta = new BattleMeta
{
    EnablePlayerDeath = true,
    UseWeightedTargetSelection = false
};

// 3. Enhanced Dungeon
var meta = new BattleMeta
{
    EnablePlayerDeath = true,
    AllowAutoRevival = false,
    EnhancedDungeonMode = true,
    EnhancedDropMultiplier = 2.5
};
```

---

## 🔍 关键类速查

### PlayerState

```csharp
public class PlayerState
{
    public int CurrentHp { get; }
    public int MaxHp { get; }
    public bool IsDead => CurrentHp <= 0;
    public double? DeathTime { get; }
    public double? RevivalTime { get; }
    
    public void TakeDamage(int amount, double now)
    public void Revive(double now)
}
```

### TargetSelector

```csharp
public static class TargetSelector
{
    // 等概率随机
    public static Encounter? SelectRandomTarget(
        EncounterGroup group, RngContext rng)
    
    // 加权随机
    public static Encounter? SelectWeightedRandomTarget(
        EncounterGroup group, RngContext rng)
}
```

### MonsterSkillDefinition

```csharp
public class MonsterSkillDefinition
{
    public string Id { get; }
    public double Cooldown { get; }
    public TriggerType Trigger { get; }
    public double TriggerProbability { get; }
    public SkillEffect Effect { get; }
}

public enum TriggerType
{
    OnCooldown,      // 冷却好了就用
    OnHpThreshold,   // 血量低于阈值
    OnPlayerAttack   // 玩家攻击时概率触发
}
```

---

## 🧪 测试重点

### 1. RNG一致性测试

```csharp
[Fact]
public void Same_Seed_Produces_Same_Battle()
{
    var seed = 12345UL;
    
    var battle1 = RunBattle(seed);
    var battle2 = RunBattle(seed);
    
    Assert.Equal(battle1.Context.Rng.Index, battle2.Context.Rng.Index);
    Assert.Equal(battle1.TotalDamage, battle2.TotalDamage);
}
```

### 2. 玩家复活测试

```csharp
[Fact]
public void Player_Revives_After_Death()
{
    // 让玩家死亡
    // 推进时间10秒
    // 验证复活
}
```

### 3. 目标选取分布测试

```csharp
[Fact]
public void Random_Target_Has_Equal_Distribution()
{
    // 3个敌人，攻击1000次
    // 统计每个敌人被攻击次数
    // 验证分布 ≈ 33.3% ± 5%
}
```

### 4. 怪物攻击测试

```csharp
[Fact]
public void Monster_Attacks_At_Regular_Intervals()
{
    // 怪物 AttackInterval = 2.0s
    // 运行10秒
    // 验证玩家受到约5次攻击
}
```

---

## ⚠️ 风险检查清单

### 开发前

- [ ] 确认所有新配置项默认值为"关闭"或"旧行为"
- [ ] 确认现有单元测试全部通过
- [ ] 建立性能基准测试

### 开发中

- [ ] 每次添加 `context.Rng.Next*()` 都通过回放测试
- [ ] 每次修改事件逻辑都检查玩家/怪物死亡边界情况
- [ ] 每次提交运行回归测试

### 开发后

- [ ] 性能测试: 离线快进开销 < 10%
- [ ] 回归测试: 所有现有测试通过
- [ ] RNG测试: 相同种子产生相同结果
- [ ] 向后兼容: 旧配置战斗行为不变

---

## 📊 验收标准

| 阶段 | 验收条件 |
|------|---------|
| 阶段1 | ✅ 玩家死亡后10秒自动复活 |
|       | ✅ 死亡时攻击进度暂停 |
|       | ✅ 复活后攻击进度恢复 |
|       | ✅ RNG一致性测试通过 |
| 阶段2 | ✅ 多怪物时随机选择目标 |
|       | ✅ 概率分布符合预期 |
|       | ✅ ThreatWeight接口可用 |
| 阶段3 | ✅ Enhanced模式禁用复活成功 |
|       | ✅ 死亡触发BattleFailure |
|       | ✅ 掉落倍率正确应用 |
| 阶段4 | ✅ 怪物定期攻击玩家 |
|       | ✅ 怪物技能按冷却触发 |
|       | ✅ 技能概率符合配置 |
|       | ✅ 向后兼容: AttackPower=0 不攻击 |
| 阶段5 | ✅ 所有单元测试通过 |
|       | ✅ 集成测试通过 |
|       | ✅ 性能测试达标 |
|       | ✅ 回归测试通过 |

---

## 🚀 快速开始

### 1. 阅读完整设计

```bash
# 详细设计方案
cat 战斗系统扩展-分阶段实施方案.md

# 架构图解
cat 战斗系统扩展-架构图解.md
```

### 2. 创建分支

```bash
git checkout -b feature/battle-system-expansion
```

### 3. 开始阶段1

```bash
# 创建第一个文件
touch BlazorIdle.Server/Domain/Combat/PlayerState.cs

# 实现 PlayerState 类
# 参考设计文档 "阶段1: 玩家复活机制"
```

### 4. 提交并测试

```bash
# 运行测试
dotnet test

# 提交更改
git add .
git commit -m "Phase 1: Add PlayerState class"
```

---

## 📞 联系与支持

- **设计文档**: 战斗系统扩展-分阶段实施方案.md
- **架构图**: 战斗系统扩展-架构图解.md
- **问题反馈**: 创建 GitHub Issue

---

## ✅ 完成状态

- [x] 需求分析
- [x] 架构设计
- [x] 详细方案
- [x] 架构图解
- [x] 快速参考
- [ ] 阶段1实施 (待启动)
- [ ] 阶段2实施
- [ ] 阶段3实施
- [ ] 阶段4实施
- [ ] 阶段5实施
- [ ] 文档审查

**当前状态**: 设计完成，等待实施批准 🚦

---

**文档版本**: 1.0  
**创建日期**: 2025-01-09  
**最后更新**: 2025-01-09

