# 战斗系统拓展详细实施方案

## 文档信息
- **版本**: 1.0
- **日期**: 2025-01
- **作者**: 战斗系统架构设计
- **状态**: 待审核实施方案

---

## 目录
1. [当前系统架构分析](#1-当前系统架构分析)
2. [需求分析与设计目标](#2-需求分析与设计目标)
3. [整体架构设计](#3-整体架构设计)
4. [分阶段实施计划](#4-分阶段实施计划)
5. [关键技术设计](#5-关键技术设计)
6. [测试策略](#6-测试策略)
7. [风险评估与缓解](#7-风险评估与缓解)
8. [演进路线图](#8-演进路线图)

---

## 1. 当前系统架构分析

### 1.1 现有战斗系统核心组件

#### 战斗引擎 (BattleEngine)
- **事件驱动架构**: 基于 EventScheduler 和优先队列的时间跳跃机制
- **双轨战斗节奏**: 
  - AttackTrack: 普通攻击轨道（受攻速/急速影响）
  - SpecialTrack: 特殊轨道（职业特性节奏）
- **多怪物支持**: 通过 EncounterGroup 管理多个 Encounter
- **RNG 可重放**: RngContext 记录 seed 和 Index，支持战斗回放

#### 战斗上下文 (BattleContext)
- **职业模块**: IProfessionModule 接口实现职业差异化
- **资源系统**: ResourceSet 管理战斗资源
- **Buff 管理**: BuffManager 处理增益/减益效果
- **技能自动施放**: AutoCastEngine 按优先级自动释放技能
- **伤害计算**: DamageCalculator 处理伤害减免、穿透等

#### 目标管理
- **当前实现**: EncounterGroup.PrimaryAlive() 固定选择第一个存活目标
- **切换机制**: 当前目标死亡后自动切换到下一个存活目标
- **缺失**: 没有仇恨系统，没有随机目标选择

#### 玩家状态
- **当前机制**: 玩家不受伤害，PlayerHpPercent 始终为 1.0
- **死亡处理**: 无玩家死亡逻辑
- **Stamina**: 仅用于计算显示血量（10 HP per Stamina）

### 1.2 现有怪物系统

#### 怪物定义 (EnemyDefinition)
```csharp
public class EnemyDefinition
{
    public string Id { get; }
    public string Name { get; }
    public int Level { get; }
    public int MaxHp { get; }
    public double Armor { get; }
    public double MagicResist { get; }
    public double VulnerabilityPhysical { get; }
    public double VulnerabilityMagic { get; }
    public double VulnerabilityTrue { get; }
}
```

**当前状态**: 怪物是"木桩"，只有防御属性，没有攻击能力

### 1.3 战斗模式

1. **Duration**: 固定时长战斗
2. **Continuous**: 持续模式，怪物死亡后刷新
3. **DungeonSingle**: 单次副本（波次序列）
4. **DungeonLoop**: 循环副本

### 1.4 离线战斗

- **OfflineFastForwardEngine**: 复用在线战斗引擎
- **CombatSegment**: 聚合战斗事件，减少存储
- **BattleState**: 支持战斗状态恢复

### 1.5 现有问题与缺失

| 功能模块 | 当前状态 | 缺失项 |
|---------|---------|--------|
| 玩家死亡 | 无 | 死亡检测、复活计时、状态暂停 |
| 目标选取 | 固定首个存活 | 随机选择、仇恨系统、概率分配 |
| 怪物攻击 | 无 | 攻击轨道、伤害计算、目标选取 |
| 怪物技能 | 无 | 技能定义、冷却管理、触发条件 |
| 强化副本 | 无 | 关闭复活开关、重置机制 |
| Actor抽象 | 无 | 玩家/怪物统一接口 |

---

## 2. 需求分析与设计目标

### 2.1 功能需求

#### R1: 玩家死亡与复活系统
- **R1.1**: 玩家受到伤害，HP 降至 0 时进入死亡状态
- **R1.2**: 死亡时暂停玩家攻击进度、特殊轨道、技能施放
- **R1.3**: 进入"复活计时"，默认 10 秒后自动复活
- **R1.4**: 复活后恢复满血，重新开始攻击循环
- **R1.5**: 怪物在无存活玩家时暂停攻击
- **R1.6**: 降低挂机挫败感，不立即结束战斗

#### R2: 多目标选取与仇恨系统
- **R2.1**: 怪物每次攻击随机选择一个玩家目标（当前单人，预留多人）
- **R2.2**: 玩家每次攻击/技能随机选择一个怪物目标
- **R2.3**: 多目标情况下，每个目标有均等被攻击概率（基础仇恨）
- **R2.4**: 预留仇恨值接口，支持未来嘲讽/仇恨调整
- **R2.5**: 仇恨值影响被选中概率，不是绝对锁定

#### R3: 强化型地下城预留
- **R3.1**: 副本配置项：是否允许自动复活（默认允许）
- **R3.2**: 禁用复活时，玩家死亡触发整轮重置
- **R3.3**: 强化副本提供更高掉落倍率/特殊奖励
- **R3.4**: 保持接口向后兼容

#### R4: 怪物攻击与技能系统
- **R4.1**: 怪物具有基础攻击能力（类似玩家普攻）
- **R4.2**: 怪物拥有自己的技能池（与玩家技能池分离）
- **R4.3**: 技能模型：冷却 + 概率 + 触发类型（CD就绪/血量阈值/战斗时长）
- **R4.4**: 不引入复杂资源系统（法力、怒气等）
- **R4.5**: 轻量级设计，易于配置

#### R5: 战斗回放与 RNG 一致性
- **R5.1**: 所有随机事件（目标选取、技能触发）使用 RngContext
- **R5.2**: 在事件调度前后记录 RNG Index
- **R5.3**: 保证战斗可回放，相同 seed 产生相同结果
- **R5.4**: 离线快进与在线战斗使用相同逻辑

#### R6: 最小增量原则
- **R6.1**: 不重写现有玩家侧系统（AutoCast / Buff / Proc）
- **R6.2**: 渐进式演进，保持向后兼容
- **R6.3**: 为未来 Actor 抽象预留接口
- **R6.4**: 单元测试覆盖新功能

### 2.2 非功能需求

- **性能**: 离线快进效率不受影响
- **可测试性**: 所有新功能可单元测试
- **可配置性**: 通过数据驱动配置，无需修改代码
- **可扩展性**: 预留多人战斗、高级技能接口
- **兼容性**: 现有战斗不受影响，可平滑升级

---

## 3. 整体架构设计

### 3.1 核心抽象层次

```
┌─────────────────────────────────────────────────┐
│         BattleEngine (事件调度核心)               │
│  - EventScheduler (优先队列)                     │
│  - GameClock (时间管理)                          │
│  - RngContext (随机数生成)                       │
└───────────────┬─────────────────────────────────┘
                │
        ┌───────┴────────┐
        │                │
┌───────▼──────┐  ┌──────▼──────┐
│ Combatant    │  │ TargetPool  │
│ (战斗单位)    │  │ (目标池)     │
└──────┬───────┘  └─────────────┘
       │
   ┌───┴────┐
   │        │
┌──▼──┐  ┌─▼───┐
│Player│  │Enemy│
│ Actor│  │Actor│
└──────┘  └─────┘
```

### 3.2 Combatant 接口设计

```csharp
/// <summary>
/// 战斗单位抽象接口（玩家和怪物的共同基础）
/// 未来可统一为 Actor，当前保持最小侵入
/// </summary>
public interface ICombatant
{
    string Id { get; }
    string Name { get; }
    
    // 生命值
    int CurrentHp { get; }
    int MaxHp { get; }
    bool IsDead { get; }
    
    // 战斗状态
    CombatantState State { get; } // Alive, Dead, Reviving
    double? DeathTime { get; }
    double? ReviveAt { get; }
    
    // 仇恨/目标权重
    double ThreatWeight { get; set; } // 默认 1.0，嘲讽可提高
    
    // 伤害接口
    int ReceiveDamage(int amount, DamageType type, double now);
    
    // 状态查询
    bool CanBeTargeted(); // 存活且可被选中
    bool CanAct(); // 存活且可执行动作
}
```

### 3.3 玩家扩展 (PlayerCombatant)

```csharp
public class PlayerCombatant : ICombatant
{
    // 现有 CharacterStats
    public CharacterStats Stats { get; }
    
    // 复活配置
    public double ReviveDurationSeconds { get; set; } = 10.0;
    public bool AutoReviveEnabled { get; set; } = true;
    
    // 状态机
    public CombatantState State { get; private set; }
    
    // 暂停/恢复攻击进度
    public void PauseAttackProgress();
    public void ResumeAttackProgress();
    
    // 死亡/复活
    public void OnDeath(double now);
    public void OnRevive(double now);
}
```

### 3.4 怪物扩展 (EnemyCombatant)

```csharp
public class EnemyCombatant : ICombatant
{
    public EnemyDefinition Definition { get; }
    
    // 攻击轨道（类似玩家）
    public TrackState? AttackTrack { get; set; }
    
    // 技能池（可选）
    public List<EnemySkillSlot> Skills { get; } = new();
    
    // 基础攻击伤害
    public int BaseDamage { get; set; }
    public DamageType AttackDamageType { get; set; }
    
    // 目标选取
    public ICombatant? CurrentTarget { get; set; }
}
```

### 3.5 目标选取管理器 (TargetSelector)

```csharp
/// <summary>
/// 目标选取管理器：基于仇恨权重的随机目标选择
/// </summary>
public class TargetSelector
{
    private readonly RngContext _rng;
    
    /// <summary>
    /// 从目标池中随机选择一个目标
    /// </summary>
    /// <param name="candidates">候选目标列表</param>
    /// <returns>选中的目标，如果无可选目标返回 null</returns>
    public ICombatant? SelectTarget(IEnumerable<ICombatant> candidates)
    {
        var available = candidates.Where(c => c.CanBeTargeted()).ToList();
        if (available.Count == 0) return null;
        
        // 计算总权重
        double totalWeight = available.Sum(c => c.ThreatWeight);
        
        // 随机选择
        double roll = _rng.NextDouble() * totalWeight;
        double cumulative = 0;
        
        foreach (var candidate in available)
        {
            cumulative += candidate.ThreatWeight;
            if (roll <= cumulative)
                return candidate;
        }
        
        return available.Last(); // 保底
    }
}
```

### 3.6 怪物技能定义 (EnemySkillDefinition)

```csharp
/// <summary>
/// 怪物技能定义：轻量级，无复杂资源
/// </summary>
public class EnemySkillDefinition
{
    public string Id { get; }
    public string Name { get; }
    
    // 冷却
    public double CooldownSeconds { get; }
    
    // 触发条件
    public TriggerType Trigger { get; } // OnCooldownReady, OnHpBelow, OnCombatTimeElapsed
    public double TriggerValue { get; } // 血量阈值 (0.0-1.0) 或时长 (秒)
    
    // 触发概率（可选，默认 1.0 必定触发）
    public double ActivationChance { get; } = 1.0;
    
    // 效果
    public SkillEffectType Effect { get; } // Damage, ApplyBuff, Heal, Summon
    public int EffectValue { get; }
    public DamageType DamageType { get; }
    public string? BuffId { get; }
    
    // 多目标（可选）
    public int MaxTargets { get; } = 1;
}

public enum TriggerType
{
    OnCooldownReady,    // CD就绪即释放
    OnHpBelow,          // 血量低于阈值时触发
    OnCombatTimeElapsed // 战斗开始 X 秒后触发
}

public enum SkillEffectType
{
    Damage,
    ApplyBuff,
    Heal,
    Summon // 未来扩展
}
```

### 3.7 事件扩展

新增事件类型：

```csharp
// 玩家死亡事件
public record PlayerDeathEvent(double ExecuteAt, PlayerCombatant Player) : IGameEvent;

// 玩家复活事件
public record PlayerReviveEvent(double ExecuteAt, PlayerCombatant Player) : IGameEvent;

// 怪物攻击事件（类似 AttackTickEvent）
public record EnemyAttackEvent(double ExecuteAt, EnemyCombatant Enemy, TrackState Track) : IGameEvent;

// 怪物技能释放事件
public record EnemySkillCastEvent(double ExecuteAt, EnemyCombatant Enemy, EnemySkillDefinition Skill) : IGameEvent;
```

---

## 4. 分阶段实施计划

### Phase 1: 基础架构准备（Week 1-2）

#### 目标
- 建立 Combatant 抽象层
- 不影响现有战斗逻辑
- 为后续功能打下基础

#### 任务清单
- [x] **P1.1**: 定义 `ICombatant` 接口
  - 生命值、状态、仇恨权重
  - 伤害接收、状态查询方法
  - ✅ 已完成 (2025-01)
  
- [x] **P1.2**: 创建 `CombatantState` 枚举
  - `Alive`, `Dead`, `Reviving`
  - ✅ 已完成 (2025-01)
  
- [x] **P1.3**: 创建 `PlayerCombatant` 包装类
  - 包装现有 CharacterStats
  - 实现 ICombatant 接口
  - 初始状态始终为 Alive，HP 不变（兼容现有逻辑）
  - ✅ 已完成 (2025-01)
  
- [x] **P1.4**: 创建 `EnemyCombatant` 包装类
  - 包装现有 Encounter
  - 实现 ICombatant 接口
  - ✅ 已完成 (2025-01)
  
- [x] **P1.5**: 更新 BattleContext
  - 添加 `PlayerCombatant Player { get; }`
  - 保持现有 Encounter/EncounterGroup 不变
  - ✅ 已完成 (2025-01)
  
- [x] **P1.6**: 单元测试
  - 测试 Combatant 创建与状态查询
  - 测试现有战斗不受影响
  - ✅ 已完成 (14/14 测试通过)

#### 交付物
- ✅ `ICombatant.cs` - 战斗单位统一接口
- ✅ `CombatantState.cs` - 战斗状态枚举
- ✅ `PlayerCombatant.cs` - 玩家战斗单位包装
- ✅ `EnemyCombatant.cs` - 敌人战斗单位包装
- ✅ `CombatantTests.cs` - 完整单元测试套件

#### 验收标准
- ✅ 所有现有测试通过
- ✅ 新增 Combatant 层不影响战斗逻辑
- ✅ 代码覆盖率 > 80% (14/14 测试通过)

#### 完成状态
**状态**: ✅ 已完成 (2025-01)
**实施人员**: Solaireshen97 + GitHub Copilot
**提交哈希**: ca6a78e

---

### Phase 2: 目标选取系统（Week 3-4）

#### 目标
- 实现基于权重的随机目标选择
- 支持玩家攻击随机选怪
- 预留怪物攻击随机选玩家（当前单人，接口完整）

#### 任务清单
- [x] **P2.1**: 创建 `TargetSelector` 类 ✅ **已完成 (2025-01)**
  - 实现加权随机选择算法
  - 使用 RngContext 保证可重放
  
- [x] **P2.2**: 在 BattleContext 中添加 TargetSelector ✅ **已完成 (2025-01)**
  - `public TargetSelector TargetSelector { get; }`
  
- [x] **P2.3**: 更新攻击事件 (AttackTickEvent) ✅ **已完成 (2025-01)**
  - 不再固定使用 `Context.Encounter`
  - 调用 `TargetSelector.SelectTarget(Context.GetAllEnemyCombatants())`
  - 如果无目标，跳过攻击
  
- [x] **P2.4**: 更新技能释放 (AutoCastEngine) ✅ **已完成 (2025-01)**
  - 单体技能随机选择目标
  - AoE 技能保持现有逻辑（SelectAlive）
  
- [x] **P2.5**: 添加 ThreatWeight 配置 ✅ **已完成 (2025-01)**
  - EnemyCombatant 默认权重 1.0
  - 预留 Buff 调整权重接口（嘲讽 +5.0 等）
  
- [x] **P2.6**: 单元测试 ✅ **已完成 (2025-01)**
  - 测试随机目标选择分布（统计验证）✅
  - 测试无可用目标时行为 ✅
  - 测试权重调整影响概率 ✅
  - 测试 RNG 可重放性 ✅
  - 共 11 个测试用例全部通过

#### 交付物
- `TargetSelector.cs`
- 更新 `AttackTickEvent.cs`
- 更新 `AutoCastEngine.cs`
- `TargetSelectorTests.cs`

#### 验收标准
- ✅ 多怪物战斗中，攻击随机分配，统计分布符合预期（±15% 容差）
- ✅ 相同 seed 战斗结果一致（100 次验证通过）
- ✅ 性能无明显下降（加权随机选择为 O(n) 复杂度）

#### 实施完成报告 (2025-01)
**状态**: ✅ **Phase 2 已完成**

**实现文件**:
1. `BlazorIdle.Server/Domain/Combat/TargetSelector.cs` (新增 51 行)
   - 实现基于权重的随机目标选择算法
   - 使用 RngContext 保证可重放性
   
2. `BlazorIdle.Server/Domain/Combat/BattleContext.cs` (修改)
   - 添加 `TargetSelector` 属性
   - 添加 `GetAllEnemyCombatants()` 辅助方法
   
3. `BlazorIdle.Server/Domain/Combat/AttackTickEvent.cs` (修改)
   - 使用 TargetSelector 随机选择攻击目标
   - 无可用目标时跳过攻击
   
4. `BlazorIdle.Server/Domain/Combat/Skills/AutoCastEngine.cs` (修改)
   - 单体技能使用 TargetSelector 随机选择目标
   - AoE 技能保持现有逻辑
   
5. `tests/BlazorIdle.Tests/TargetSelectorTests.cs` (新增 380 行)
   - 11 个单元测试全部通过
   - 覆盖基础选择、权重分布、RNG 可重放性、边界情况

**验证结果**:
- ✅ 等权重分布测试通过 (33.3% ±15%)
- ✅ 不等权重分布测试通过 (75%/25% ±15%)
- ✅ 高仇恨权重测试通过 (83.3%/16.7% ±15%)
- ✅ RNG 可重放性验证通过 (相同 seed 产生相同序列)
- ✅ 死亡单位不被选中
- ✅ 零权重单位不被选中
- ✅ 无可用目标返回 null

**向后兼容性**: ✅ Phase 1 的 14 个测试全部通过

**下一步**: Phase 3 - 玩家死亡与复活系统

---

### Phase 3: 玩家死亡与复活（Week 5-7）

#### 目标
- 玩家可受伤、死亡
- 实现复活计时机制
- 死亡时暂停玩家动作

#### 任务清单
- [ ] **P3.1**: 扩展 PlayerCombatant
  - 添加 `int CurrentHp`, `int MaxHp`
  - 基于 Stamina 计算 MaxHp（10 HP per Stamina）
  - 实现 `ReceiveDamage` 方法
  
- [ ] **P3.2**: 实现死亡检测
  - HP <= 0 时触发死亡
  - 状态转换 Alive → Dead
  - 调度 `PlayerReviveEvent`
  
- [ ] **P3.3**: 创建 PlayerDeathEvent
  - 暂停玩家所有 Track（设置极大的 NextTriggerAt）
  - 取消玩家技能施放
  - 标记为 Dead 状态
  
- [ ] **P3.4**: 创建 PlayerReviveEvent
  - 恢复满血
  - 状态转换 Dead → Alive
  - 恢复 Track 到当前时间（重新开始攻击循环）
  
- [ ] **P3.5**: 更新 AttackTickEvent
  - 检查玩家是否存活 (`Player.CanAct()`)
  - 死亡时不生成攻击伤害
  
- [ ] **P3.6**: 更新 SpecialPulseEvent
  - 检查玩家状态
  
- [ ] **P3.7**: 更新 BattleEngine 结束条件
  - 玩家死亡不立即结束战斗
  - 等待复活后继续战斗
  - 仅当时长耗尽或怪物全灭时结束
  
- [ ] **P3.8**: 配置复活时长
  - 默认 10 秒
  - 支持副本配置覆盖
  
- [ ] **P3.9**: UI 状态同步
  - 更新 StepBattleStatusDto
  - 添加玩家当前 HP、复活倒计时
  
- [ ] **P3.10**: 单元测试
  - 测试玩家受伤、死亡、复活流程
  - 测试死亡时暂停攻击
  - 测试复活后恢复攻击
  - 测试战斗不立即结束

#### 交付物
- 更新 `PlayerCombatant.cs`
- `PlayerDeathEvent.cs`
- `PlayerReviveEvent.cs`
- 更新 `AttackTickEvent.cs`
- 更新 `BattleEngine.cs`
- 更新 `StepBattleStatusDto.cs`
- `PlayerDeathReviveTests.cs`

#### 验收标准
- 玩家可以死亡并自动复活
- 死亡时攻击暂停，复活后恢复
- 战斗不因玩家死亡而结束
- UI 正确显示玩家 HP 和复活倒计时

---

### Phase 4: 怪物攻击能力（Week 8-10）

#### 目标
- 怪物可以攻击玩家
- 玩家受到伤害
- 怪物攻击使用 Track 机制

#### 任务清单
- [ ] **P4.1**: 扩展 EnemyDefinition
  - 添加 `int BaseDamage`
  - 添加 `DamageType AttackDamageType`
  - 添加 `double AttackIntervalSeconds`（攻击间隔）
  
- [ ] **P4.2**: 初始化怪物攻击轨道
  - 在 BattleEngine 创建时，为每个怪物创建 AttackTrack
  - 调度第一个 EnemyAttackEvent
  
- [ ] **P4.3**: 创建 EnemyAttackEvent
  - 类似 AttackTickEvent，但作用于怪物
  - 使用 TargetSelector 选择玩家目标（当前单人，直接选玩家）
  - 计算伤害（基础值，不考虑暴击/穿透，保持简单）
  - 调用 `Player.ReceiveDamage`
  
- [ ] **P4.4**: 怪物无可攻击目标时暂停
  - 检查是否有存活玩家 (`Player.CanBeTargeted()`)
  - 如果所有玩家死亡，暂停怪物攻击 Track
  - 玩家复活时，恢复怪物攻击 Track
  
- [ ] **P4.5**: 伤害平衡调整
  - 配置怪物基础伤害，确保玩家不会瞬间死亡
  - 建议：怪物伤害 = 玩家最大 HP / (复活时长 × 2)
  - 示例：200 HP, 10s 复活 → 怪物约 10 DPS
  
- [ ] **P4.6**: 单元测试
  - 测试怪物可以攻击玩家
  - 测试玩家受伤、HP 减少
  - 测试玩家死亡后怪物暂停攻击
  - 测试玩家复活后怪物恢复攻击

#### 交付物
- 更新 `EnemyDefinition.cs`
- 更新 `EnemyCombatant.cs`
- `EnemyAttackEvent.cs`
- 更新 `BattleEngine.cs`
- 更新 `EnemyRegistry.cs`（配置怪物攻击属性）
- `EnemyAttackTests.cs`

#### 验收标准
- 怪物可以攻击玩家并造成伤害
- 玩家 HP 正确减少
- 所有玩家死亡时怪物暂停攻击
- 玩家复活后怪物恢复攻击

---

### Phase 5: 怪物技能系统（Week 11-13）

#### 目标
- 怪物可以释放技能
- 技能基于冷却和触发条件
- 轻量级设计，不引入资源系统

#### 任务清单
- [ ] **P5.1**: 定义 EnemySkillDefinition
  - Id, Name, CooldownSeconds
  - TriggerType, TriggerValue, ActivationChance
  - EffectType, EffectValue, DamageType, BuffId
  - MaxTargets
  
- [ ] **P5.2**: 创建 EnemySkillSlot
  - 包装 EnemySkillDefinition
  - 管理冷却状态（类似 SkillSlot）
  
- [ ] **P5.3**: 创建 EnemySkillManager
  - 管理怪物技能槽列表
  - 检查技能触发条件
  - 调度技能释放事件
  
- [ ] **P5.4**: 创建 EnemySkillCastEvent
  - 执行技能效果（伤害/Buff/治疗）
  - 使用 TargetSelector 选择目标
  - 更新冷却时间
  
- [ ] **P5.5**: 集成到 BattleEngine
  - 为配置了技能的怪物初始化 EnemySkillManager
  - 在事件循环中检查技能触发
  
- [ ] **P5.6**: 配置示例技能
  - "重击"：10s CD，造成 2 倍伤害
  - "愤怒"：HP < 30% 时触发，增加攻击力 Buff
  - "治疗"：战斗 30s 后触发，恢复 50% HP（仅一次）
  
- [ ] **P5.7**: 单元测试
  - 测试技能冷却管理
  - 测试技能触发条件（HP 阈值、时长）
  - 测试技能效果（伤害、Buff）
  - 测试随机触发概率

#### 交付物
- `EnemySkillDefinition.cs`
- `EnemySkillSlot.cs`
- `EnemySkillManager.cs`
- `EnemySkillCastEvent.cs`
- 更新 `BattleEngine.cs`
- 更新 `EnemyRegistry.cs`（配置技能）
- `EnemySkillTests.cs`

#### 验收标准
- 怪物可以释放配置的技能
- 技能冷却正确工作
- 触发条件正确判断
- 技能效果正确应用

---

### Phase 6: 强化型地下城预留（Week 14-15）

#### 目标
- 支持禁用自动复活的副本模式
- 玩家死亡时触发整轮重置
- 强化掉落机制

#### 任务清单
- [ ] **P6.1**: 扩展 DungeonDefinition
  - 添加 `bool AllowAutoRevive`（默认 true）
  - 添加 `double EnhancedDropMultiplier`（默认 1.0）
  - 添加 `bool ResetOnPlayerDeath`（默认 false）
  
- [ ] **P6.2**: 更新 PlayerCombatant
  - 添加 `bool AutoReviveAllowed` 属性
  - 由副本配置控制
  
- [ ] **P6.3**: 更新 PlayerDeathEvent
  - 检查 `AutoReviveAllowed`
  - 如果禁用，不调度 PlayerReviveEvent
  - 触发副本重置逻辑
  
- [ ] **P6.4**: 实现副本重置机制
  - 标记战斗失败
  - 重置波次进度
  - 清空已击杀统计
  - 玩家重生（可选：返回起点）
  
- [ ] **P6.5**: 强化掉落倍率
  - 在 EconomyCalculator 中应用倍率
  - 仅对启用 ResetOnPlayerDeath 的副本生效
  
- [ ] **P6.6**: UI 提示
  - 显示副本是否允许复活
  - 死亡时显示重置提示
  
- [ ] **P6.7**: 单元测试
  - 测试禁用复活模式
  - 测试玩家死亡触发重置
  - 测试强化掉落计算
  - 测试向后兼容（普通副本不受影响）

#### 交付物
- 更新 `DungeonDefinition.cs`
- 更新 `PlayerCombatant.cs`
- 更新 `PlayerDeathEvent.cs`
- 更新 `BattleEngine.cs`
- 更新 `EconomyCalculator.cs`
- `EnhancedDungeonTests.cs`

#### 验收标准
- 强化副本可以禁用自动复活
- 玩家死亡正确触发重置
- 强化掉落倍率正确应用
- 普通副本行为不变

---

### Phase 7: RNG 一致性与战斗回放（Week 16-17）

#### 目标
- 确保所有随机事件使用 RngContext
- 记录 RNG Index 变化
- 验证战斗可回放

#### 任务清单
- [ ] **P7.1**: 审计所有随机事件
  - 目标选取
  - 技能触发概率
  - 暴击判定
  - 伤害浮动（如果实现）
  
- [ ] **P7.2**: 在 CombatSegment 中记录 RNG 范围
  - `long RngIndexStart`
  - `long RngIndexEnd`
  
- [ ] **P7.3**: 实现战斗回放工具
  - 输入：seed, 战斗配置, 时长
  - 输出：战斗结果, Segment 列表
  - 验证相同 seed 产生相同结果
  
- [ ] **P7.4**: 离线快进验证
  - 对比在线战斗和离线快进结果
  - 确保一致性（允许浮点误差）
  
- [ ] **P7.5**: 单元测试
  - 测试相同 seed 战斗结果一致
  - 测试不同 seed 结果不同
  - 测试离线与在线一致性
  - 测试 RNG Index 记录正确

#### 交付物
- 更新所有随机事件使用 RngContext
- 更新 `CombatSegment.cs`
- `BattleReplayTests.cs`

#### 验收标准
- 相同 seed 战斗结果 100% 一致
- 离线快进与在线战斗结果一致
- RNG Index 正确记录

---

### Phase 8: 集成测试与优化（Week 18-20）

#### 目标
- 端到端集成测试
- 性能优化
- 文档完善

#### 任务清单
- [ ] **P8.1**: 端到端测试
  - 完整副本战斗（多波次，玩家死亡复活）
  - 强化副本（死亡重置）
  - 离线战斗
  - 多怪物随机目标选择
  
- [ ] **P8.2**: 性能基准测试
  - 对比扩展前后性能
  - 优化热点路径
  - 确保离线快进效率
  
- [ ] **P8.3**: 负载测试
  - 多个并发战斗
  - 长时间持续战斗
  
- [ ] **P8.4**: 文档更新
  - 更新架构文档
  - 编写怪物配置指南
  - 编写技能配置指南
  - 更新 API 文档
  
- [ ] **P8.5**: 代码审查与重构
  - 清理临时代码
  - 统一命名规范
  - 补充注释
  
- [ ] **P8.6**: 最终验收测试
  - 所有单元测试通过
  - 集成测试通过
  - 性能指标达标
  - 文档完整

#### 交付物
- `IntegrationTests.cs`
- `PerformanceTests.cs`
- 更新设计文档
- 配置指南文档

#### 验收标准
- 所有测试通过，覆盖率 > 85%
- 性能下降 < 5%
- 文档完整，可供其他开发者使用
- 所有需求完成

---

## 5. 关键技术设计

### 5.1 玩家死亡与复活状态机

```
     [Alive]
        │
        │ HP <= 0
        ▼
     [Dead] ───────────────┐
        │                  │
        │ AutoRevive=true  │ AutoRevive=false
        ▼                  │
  [Reviving]              │
   (倒计时)                │
        │                  │
        │ Time expired     │
        ▼                  ▼
     [Alive]         [BattleFailed]
```

### 5.2 怪物攻击目标选择算法

```csharp
public ICombatant? SelectTarget(IEnumerable<ICombatant> candidates)
{
    var available = candidates
        .Where(c => c.CanBeTargeted())
        .ToList();
        
    if (available.Count == 0) return null;
    
    // 加权随机
    double totalWeight = available.Sum(c => c.ThreatWeight);
    double roll = _rng.NextDouble() * totalWeight;
    double cumulative = 0;
    
    foreach (var c in available)
    {
        cumulative += c.ThreatWeight;
        if (roll <= cumulative) return c;
    }
    
    return available.Last();
}
```

**示例**：
- 3 个怪物，权重均为 1.0
- 总权重 = 3.0
- roll ∈ [0, 3)
- 怪物 1: [0, 1) → 33.3%
- 怪物 2: [1, 2) → 33.3%
- 怪物 3: [2, 3) → 33.3%

**扩展（嘲讽）**：
- 嘲讽 Buff 设置 ThreatWeight = 5.0
- 其他怪物权重 1.0
- 总权重 = 5.0 + 1.0 + 1.0 = 7.0
- 嘲讽目标: [0, 5) → 71.4%
- 其他目标: [5, 6), [6, 7) → 各 14.3%

### 5.3 怪物技能触发检查

```csharp
public bool ShouldTrigger(EnemySkillDefinition skill, EnemyCombatant enemy, double now)
{
    // 检查冷却
    if (!skill.IsReady(now)) return false;
    
    // 检查触发条件
    switch (skill.Trigger)
    {
        case TriggerType.OnCooldownReady:
            // CD 就绪即可触发
            break;
            
        case TriggerType.OnHpBelow:
            double hpPercent = (double)enemy.CurrentHp / enemy.MaxHp;
            if (hpPercent > skill.TriggerValue) return false;
            break;
            
        case TriggerType.OnCombatTimeElapsed:
            double elapsed = now - _combatStartTime;
            if (elapsed < skill.TriggerValue) return false;
            // 只触发一次
            if (skill.HasTriggered) return false;
            break;
    }
    
    // 概率检查
    if (skill.ActivationChance < 1.0)
    {
        if (!_rng.NextBool(skill.ActivationChance))
            return false;
    }
    
    return true;
}
```

### 5.4 攻击进度暂停与恢复

```csharp
public class TrackState
{
    private double? _pausedAt;
    private double _pausedRemaining;
    
    public void Pause(double now)
    {
        if (_pausedAt.HasValue) return; // 已暂停
        
        _pausedRemaining = NextTriggerAt - now;
        _pausedAt = now;
        NextTriggerAt = double.MaxValue; // 永不触发
    }
    
    public void Resume(double now)
    {
        if (!_pausedAt.HasValue) return; // 未暂停
        
        NextTriggerAt = now + _pausedRemaining;
        _pausedAt = null;
    }
}
```

### 5.5 强化副本重置机制

```csharp
public void OnPlayerDeathInEnhancedDungeon(PlayerCombatant player, double now)
{
    if (_dungeon.AllowAutoRevive)
    {
        // 正常复活流程
        ScheduleRevive(player, now + player.ReviveDurationSeconds);
        return;
    }
    
    // 触发重置
    _battleFailed = true;
    Collector.OnTag("dungeon_reset_on_death", 1);
    
    // 清理战斗状态
    _provider.Reset();
    _currentWaveIndex = 0;
    _killCounts.Clear();
    
    // 重生玩家（满血）
    player.CurrentHp = player.MaxHp;
    player.State = CombatantState.Alive;
    
    // 重置怪物
    var initialWave = _provider.GetInitialWave();
    Context.ResetEncounterGroup(initialWave);
    
    // 重置时间？还是继续计时？（根据需求决定）
    // 建议：继续计时，但重置波次进度
}
```

---

## 6. 测试策略

### 6.1 单元测试覆盖

| 模块 | 测试内容 | 目标覆盖率 |
|------|---------|-----------|
| TargetSelector | 随机选择分布、权重影响、边界情况 | > 90% |
| PlayerCombatant | 受伤、死亡、复活、状态转换 | > 95% |
| EnemyCombatant | 攻击、技能、目标选取 | > 90% |
| EnemySkillManager | 技能触发、冷却、条件判断 | > 90% |
| TrackState | 暂停、恢复、时间计算 | > 95% |

### 6.2 集成测试场景

1. **场景 1：单怪战斗，玩家死亡复活**
   - 怪物持续攻击玩家
   - 玩家 HP 降至 0
   - 进入复活倒计时
   - 10 秒后自动复活
   - 继续战斗直到怪物死亡

2. **场景 2：多怪战斗，随机目标选择**
   - 3 个怪物
   - 玩家攻击随机选择目标
   - 统计 1000 次攻击分布（应接近 33.3%）

3. **场景 3：怪物技能释放**
   - 怪物配置 "重击" 技能（10s CD）
   - 战斗 30 秒，验证技能释放 3 次
   - 验证技能伤害正确应用

4. **场景 4：强化副本死亡重置**
   - 配置禁用复活的副本
   - 玩家死亡
   - 验证战斗重置（波次归零，击杀清空）
   - 验证玩家重生

5. **场景 5：RNG 一致性**
   - 相同 seed 运行战斗两次
   - 对比所有事件时间、伤害值、目标选择
   - 验证完全一致

6. **场景 6：离线快进一致性**
   - 在线战斗 60 秒
   - 离线快进 60 秒（相同配置、seed）
   - 对比最终结果（击杀数、掉落、经验）

### 6.3 性能测试

```csharp
[Benchmark]
public void Baseline_CurrentBattle_60Seconds()
{
    var engine = CreateBattleEngine(mode: StepBattleMode.Duration);
    engine.Advance(60.0);
}

[Benchmark]
public void Extended_WithPlayerDeath_60Seconds()
{
    var engine = CreateExtendedBattleEngine();
    engine.Advance(60.0);
}

[Benchmark]
public void Extended_WithEnemySkills_60Seconds()
{
    var engine = CreateBattleEngineWithEnemySkills();
    engine.Advance(60.0);
}
```

**目标**：
- 扩展后性能下降 < 5%
- 离线快进速度 > 100x 实时

---

## 7. 风险评估与缓解

### 7.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| RNG 一致性破坏 | 中 | 高 | 严格代码审查，强制使用 RngContext，回放测试 |
| 性能下降 | 中 | 中 | 提前基准测试，优化热点，批量处理 |
| 死亡复活逻辑复杂 | 低 | 中 | 清晰状态机设计，充分单元测试 |
| 现有系统兼容性 | 低 | 高 | 最小侵入原则，保持现有接口，向后兼容测试 |

### 7.2 进度风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 需求变更 | 中 | 中 | 预留扩展接口，模块化设计，快速迭代 |
| 测试用例不足 | 低 | 高 | TDD 开发，每个 Phase 强制测试，代码审查 |
| 集成延期 | 中 | 中 | Phase 独立交付，提前暴露集成问题 |

### 7.3 缓解策略

1. **持续集成**：每个 Phase 完成立即合并主分支，避免大规模冲突
2. **增量发布**：新功能通过配置开关控制，可灰度发布
3. **回滚预案**：保持向后兼容，必要时可回退到旧逻辑
4. **监控告警**：部署后监控战斗耗时、RNG 分布异常

---

## 8. 演进路线图

### 短期（Phase 1-4，3 个月）
- ✅ Combatant 抽象层
- ✅ 随机目标选取
- ✅ 玩家死亡复活
- ✅ 怪物攻击能力

**里程碑**：玩家可以死亡并复活，怪物可以攻击玩家

### 中期（Phase 5-6，2 个月）
- ✅ 怪物技能系统
- ✅ 强化副本预留

**里程碑**：怪物拥有技能，副本支持多种模式

### 长期（Phase 7-8，1 个月）
- ✅ RNG 一致性验证
- ✅ 性能优化
- ✅ 文档完善

**里程碑**：系统稳定，可扩展，文档完整

### 未来演进（6 个月+）

1. **Actor 统一抽象**
   - 将 PlayerCombatant 和 EnemyCombatant 重构为 Actor
   - 统一技能系统（玩家和怪物共享 SkillDefinition）
   - 统一 Buff 系统

2. **多人战斗**
   - 支持多玩家组队
   - 真正的仇恨系统
   - 职业分工（坦克、治疗、DPS）

3. **高级技能**
   - 怪物资源系统（可选）
   - 技能链/连击
   - 位置/距离机制

4. **AI 增强**
   - 怪物行为树
   - 技能优先级逻辑
   - 动态难度调整

5. **战斗回放与分享**
   - 完整战斗录制
   - 伤害统计可视化
   - 社区分享

---

## 附录 A: 数据模型示例

### A.1 怪物配置示例

```csharp
public static class EnemyRegistry
{
    public static EnemyDefinition GoblinWarrior => new EnemyDefinition(
        id: "goblin_warrior",
        name: "哥布林战士",
        level: 5,
        maxHp: 150,
        armor: 20,
        magicResist: 0.1,
        baseDamage: 8,
        attackDamageType: DamageType.Physical,
        attackIntervalSeconds: 2.0,
        skills: new[]
        {
            new EnemySkillDefinition(
                id: "heavy_strike",
                name: "重击",
                cooldownSeconds: 10.0,
                trigger: TriggerType.OnCooldownReady,
                activationChance: 1.0,
                effect: SkillEffectType.Damage,
                effectValue: 16, // 2x 伤害
                damageType: DamageType.Physical
            )
        }
    );
    
    public static EnemyDefinition BossOgre => new EnemyDefinition(
        id: "boss_ogre",
        name: "食人魔首领",
        level: 10,
        maxHp: 800,
        armor: 50,
        magicResist: 0.2,
        baseDamage: 20,
        attackDamageType: DamageType.Physical,
        attackIntervalSeconds: 3.0,
        skills: new[]
        {
            // 愤怒：HP < 30% 触发，提升攻击力
            new EnemySkillDefinition(
                id: "enrage",
                name: "狂怒",
                cooldownSeconds: 0,
                trigger: TriggerType.OnHpBelow,
                triggerValue: 0.3,
                activationChance: 1.0,
                effect: SkillEffectType.ApplyBuff,
                buffId: "enrage_buff" // +50% 攻击力，持续 20s
            ),
            
            // 震地：战斗 30s 触发一次，AoE 伤害
            new EnemySkillDefinition(
                id: "ground_slam",
                name: "震地打击",
                cooldownSeconds: 0,
                trigger: TriggerType.OnCombatTimeElapsed,
                triggerValue: 30.0,
                activationChance: 1.0,
                effect: SkillEffectType.Damage,
                effectValue: 50,
                damageType: DamageType.Physical,
                maxTargets: 10 // 全体伤害
            )
        }
    );
}
```

### A.2 强化副本配置示例

```csharp
public static class DungeonRegistry
{
    public static DungeonDefinition NormalDungeon => new DungeonDefinition(
        id: "dungeon_goblin_cave",
        name: "哥布林洞穴",
        waves: new[]
        {
            new Wave(new[] { EnemyRegistry.GoblinWarrior, EnemyRegistry.GoblinWarrior }),
            new Wave(new[] { EnemyRegistry.GoblinWarrior, EnemyRegistry.GoblinWarrior, EnemyRegistry.GoblinWarrior }),
            new Wave(new[] { EnemyRegistry.BossOgre })
        },
        allowAutoRevive: true, // 普通模式：允许复活
        resetOnPlayerDeath: false
    );
    
    public static DungeonDefinition EnhancedDungeon => new DungeonDefinition(
        id: "enhanced_goblin_cave",
        name: "哥布林洞穴（强化）",
        waves: new[]
        {
            new Wave(new[] { EnemyRegistry.GoblinWarrior, EnemyRegistry.GoblinWarrior }),
            new Wave(new[] { EnemyRegistry.GoblinWarrior, EnemyRegistry.GoblinWarrior, EnemyRegistry.GoblinWarrior }),
            new Wave(new[] { EnemyRegistry.BossOgre })
        },
        allowAutoRevive: false, // 强化模式：禁用复活
        resetOnPlayerDeath: true, // 死亡重置
        enhancedDropMultiplier: 2.0, // 掉落翻倍
        goldMultiplier: 1.5,
        expMultiplier: 1.5
    );
}
```

---

## 附录 B: API 变更清单

### B.1 新增 API

```csharp
// GET /api/battles/step/{battleId}/status
// 响应新增字段
{
    "playerCurrentHp": 150,
    "playerMaxHp": 200,
    "playerState": "Alive", // Alive, Dead, Reviving
    "playerReviveAt": null, // 复活时间（如果死亡）
    "enemies": [
        {
            "id": "goblin_warrior_1",
            "name": "哥布林战士",
            "currentHp": 80,
            "maxHp": 150,
            "isDead": false,
            "isAttacking": true, // 新增：是否正在攻击
            "nextAttackAt": 12.5 // 新增：下次攻击时间
        }
    ]
}
```

### B.2 兼容性说明

- 现有 API 保持不变，新增字段可选
- 老客户端可以忽略新字段
- 新客户端优先使用新字段

---

## 附录 C: 配置参数参考

| 参数 | 默认值 | 说明 | 可调整范围 |
|------|--------|------|-----------|
| PlayerReviveDurationSeconds | 10.0 | 玩家复活时长 | 5.0 - 30.0 |
| EnemyBaseDamage | 计算值 | 怪物基础伤害 | 1 - 1000 |
| EnemyAttackIntervalSeconds | 2.0 | 怪物攻击间隔 | 0.5 - 10.0 |
| ThreatWeightDefault | 1.0 | 默认仇恨权重 | 0.1 - 10.0 |
| ThreatWeightTaunt | 5.0 | 嘲讽仇恨权重 | 2.0 - 100.0 |
| SkillActivationChance | 1.0 | 技能触发概率 | 0.0 - 1.0 |
| EnhancedDropMultiplier | 2.0 | 强化副本掉落倍率 | 1.0 - 5.0 |

---

## 结论

本方案提供了一套完整的战斗系统拓展计划，分 8 个阶段逐步实施：

1. **Phase 1-2**: 打下抽象基础（Combatant, TargetSelector）
2. **Phase 3-4**: 实现核心玩法（玩家死亡复活，怪物攻击）
3. **Phase 5-6**: 增加深度（怪物技能，强化副本）
4. **Phase 7-8**: 完善品质（RNG 一致性，性能优化，文档）

设计遵循以下原则：
- ✅ **最小侵入**：不重写现有系统，保持向后兼容
- ✅ **渐进演进**：分阶段实施，每阶段可独立验证
- ✅ **数据驱动**：通过配置扩展，降低代码修改
- ✅ **可测试性**：完整的单元测试和集成测试
- ✅ **可扩展性**：预留 Actor 抽象、多人战斗接口

预计总工期：**4-5 个月**（20 周）

下一步：审核方案 → 开始 Phase 1 实施

---

**文档版本**: 1.0  
**最后更新**: 2025-01  
**待办事项**: 等待审核和批准
