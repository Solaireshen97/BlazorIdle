# æˆ˜æ–—ç³»ç»Ÿæ‰©å±• - æ¶æ„å›¾è§£

**ç‰ˆæœ¬**: 1.0  
**é…å¥—æ–‡æ¡£**: æˆ˜æ–—ç³»ç»Ÿæ‰©å±•-åˆ†é˜¶æ®µå®æ–½æ–¹æ¡ˆ.md

---

## ç›®å½•

1. [å½“å‰æ¶æ„](#å½“å‰æ¶æ„)
2. [æ‰©å±•åæ¶æ„](#æ‰©å±•åæ¶æ„)
3. [äº‹ä»¶æµç¨‹å›¾](#äº‹ä»¶æµç¨‹å›¾)
4. [ç±»å…³ç³»å›¾](#ç±»å…³ç³»å›¾)
5. [æ•°æ®æµå›¾](#æ•°æ®æµå›¾)

---

## å½“å‰æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BattleEngine                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Clock: GameClock                                         â”‚
â”‚  â€¢ Scheduler: EventScheduler (PriorityQueue)                â”‚
â”‚  â€¢ Context: BattleContext                                   â”‚
â”‚  â€¢ Segments: List<CombatSegment>                            â”‚
â”‚  â€¢ Completed/Killed flags                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ contains
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BattleContext                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Stats: CharacterStats (ç©å®¶å±æ€§)                         â”‚
â”‚  â€¢ Encounter: Encounter (å½“å‰ç›®æ ‡)                          â”‚
â”‚  â€¢ EncounterGroup: EncounterGroup (å¤šæ€ª)                    â”‚
â”‚  â€¢ AutoCaster: AutoCastEngine (æŠ€èƒ½)                        â”‚
â”‚  â€¢ Buffs: BuffManager                                       â”‚
â”‚  â€¢ Procs: ProcManager                                       â”‚
â”‚  â€¢ Rng: RngContext (å¯é‡æ”¾éšæœº)                             â”‚
â”‚  â€¢ Tracks: List<TrackState> (æ”»å‡»/ç‰¹æ®Šè½¨é“)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ attacks
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EncounterGroup                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ All: List<Encounter> (å¤šä¸ªæ•Œäºº)                          â”‚
â”‚  â€¢ PrimaryAlive() â†’ è¿”å›ç¬¬ä¸€ä¸ªå­˜æ´»æ•Œäºº                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ contains
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Encounter                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Enemy: EnemyDefinition (é™æ€å®šä¹‰)                        â”‚
â”‚  â€¢ CurrentHp: int (å½“å‰è¡€é‡)                                â”‚
â”‚  â€¢ IsDead: bool (æ˜¯å¦æ­»äº¡)                                  â”‚
â”‚  â€¢ ApplyDamage(amount) (å—åˆ°ä¼¤å®³)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ definition
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EnemyDefinition                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Id, Name, Level                                          â”‚
â”‚  â€¢ MaxHp, Armor, MagicResist                                â”‚
â”‚  â€¢ Vulnerability (æ˜“ä¼¤)                                      â”‚
â”‚  ğŸ“Œ å½“å‰æ˜¯"æœ¨æ¡©"ï¼šåªèƒ½è¢«æ”»å‡»ï¼Œä¸ä¼šåå‡»                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å½“å‰äº‹ä»¶ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IGameEvent     â”‚  (æ¥å£)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–³
         â”‚ implements
         â”‚
         â”œâ”€â”€â”€ AttackTickEvent (ç©å®¶æ™®æ”»)
         â”œâ”€â”€â”€ SpecialPulseEvent (ç‰¹æ®Šèµ„æºç”Ÿæˆ)
         â”œâ”€â”€â”€ SkillCastEvent (æŠ€èƒ½é‡Šæ”¾)
         â”œâ”€â”€â”€ BuffExpireEvent (Buffè¿‡æœŸ)
         â””â”€â”€â”€ ProcPulseEvent (è§¦å‘æ•ˆæœæ£€æŸ¥)
```

### å½“å‰æˆ˜æ–—æµç¨‹

```
[æˆ˜æ–—å¼€å§‹]
    â”‚
    â”œâ”€ åˆå§‹åŒ– Context
    â”œâ”€ åˆ›å»º TrackState (Attack/Special)
    â”œâ”€ è°ƒåº¦åˆå§‹äº‹ä»¶
    â”‚
    â–¼
[äº‹ä»¶å¾ªç¯] â—„â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
    â”œâ”€ å–å‡ºä¸‹ä¸€äº‹ä»¶ (ä¼˜å…ˆé˜Ÿåˆ—)
    â”œâ”€ æ¨è¿›æ—¶é’Ÿåˆ°äº‹ä»¶æ—¶é—´
    â”œâ”€ è®°å½• RNG Index (å‰)
    â”œâ”€ æ‰§è¡Œäº‹ä»¶
    â”‚   â”œâ”€ AttackTick â†’ å¯¹æ•Œäººé€ æˆä¼¤å®³
    â”‚   â”œâ”€ å°è¯•è‡ªåŠ¨é‡Šæ”¾æŠ€èƒ½
    â”‚   â””â”€ è°ƒåº¦ä¸‹ä¸€æ¬¡æ”»å‡»
    â”œâ”€ è®°å½• RNG Index (å)
    â”œâ”€ æ£€æŸ¥æ•Œäººæ˜¯å¦å…¨ç­
    â”‚   â”œâ”€ æ˜¯ â†’ [æˆ˜æ–—ç»“æŸ]
    â”‚   â””â”€ å¦ â†’ â”˜ (ç»§ç»­å¾ªç¯)
    â”‚
    â–¼
[æˆ˜æ–—ç»“æŸ]
```

---

## æ‰©å±•åæ¶æ„

### æ–°å¢æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BattleContext                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã€åŸæœ‰å­—æ®µ...ã€‘                                             â”‚
â”‚  âœ¨ + Player: PlayerState (ç©å®¶çŠ¶æ€) ã€æ–°å¢ã€‘               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ has
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PlayerState ã€æ–°å¢ã€‘                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ CurrentHp: int (å½“å‰è¡€é‡)                                â”‚
â”‚  â€¢ MaxHp: int (æœ€å¤§è¡€é‡ = Stamina * 10)                     â”‚
â”‚  â€¢ IsDead: bool (æ˜¯å¦æ­»äº¡)                                  â”‚
â”‚  â€¢ DeathTime: double? (æ­»äº¡æ—¶é—´)                            â”‚
â”‚  â€¢ RevivalTime: double? (å¤æ´»æ—¶é—´)                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  + TakeDamage(amount, now) (å—åˆ°ä¼¤å®³)                       â”‚
â”‚  + Revive(now) (å¤æ´»)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Encounter                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã€åŸæœ‰å­—æ®µ...ã€‘                                             â”‚
â”‚  âœ¨ + ThreatWeight: double = 1.0 (ä»‡æ¨æƒé‡) ã€æ–°å¢ã€‘        â”‚
â”‚  âœ¨ + SkillSystem: MonsterSkillSystem? ã€æ–°å¢ã€‘             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  ã€åŸæœ‰æ–¹æ³•...ã€‘                                             â”‚
â”‚  âœ¨ + ModifyThreatWeight(multiplier) ã€æ–°å¢ã€‘               â”‚
â”‚  âœ¨ + InitializeSkills(context, now) ã€æ–°å¢ã€‘               â”‚
â”‚  âœ¨ + Heal(amount) ã€æ–°å¢ã€‘                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EnemyDefinition                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã€åŸæœ‰å­—æ®µ...ã€‘                                             â”‚
â”‚  âœ¨ + AttackPower: int = 0 (æ”»å‡»åŠ›) ã€æ–°å¢ã€‘                â”‚
â”‚  âœ¨ + AttackInterval: double = 2.0 (æ”»å‡»é—´éš”) ã€æ–°å¢ã€‘      â”‚
â”‚  âœ¨ + AttackDamageType: DamageType ã€æ–°å¢ã€‘                 â”‚
â”‚  âœ¨ + Skills: List<MonsterSkillDefinition> ã€æ–°å¢ã€‘         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–°å¢äº‹ä»¶ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IGameEvent     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–³
         â”‚
         â”œâ”€â”€â”€ âš¡ PlayerRevivalEvent ã€æ–°å¢ã€‘
         â”œâ”€â”€â”€ âš¡ BattleFailureEvent ã€æ–°å¢ã€‘
         â”œâ”€â”€â”€ âš¡ MonsterAttackTickEvent ã€æ–°å¢ã€‘
         â””â”€â”€â”€ âš¡ MonsterSkillCheckEvent ã€æ–°å¢ã€‘
```

### æ–°å¢å·¥å…·ç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TargetSelector ã€æ–°å¢ã€‘                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  + SelectRandomTarget(group, rng)                           â”‚
â”‚    â†’ ç­‰æ¦‚ç‡éšæœºé€‰æ‹©å­˜æ´»æ•Œäºº                                  â”‚
â”‚  + SelectWeightedRandomTarget(group, rng)                   â”‚
â”‚    â†’ åŸºäº ThreatWeight åŠ æƒéšæœºé€‰æ‹©                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MonsterSkillSystem ã€æ–°å¢ã€‘                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Monster: Encounter (æ‰€å±æ€ªç‰©)                            â”‚
â”‚  â€¢ Cooldowns: Dictionary<skillId, readyTime>                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  + Initialize(context, now) (åˆå§‹åŒ–)                        â”‚
â”‚  + TryTriggerSkill(context, skill, now) (å°è¯•è§¦å‘)          â”‚
â”‚  - ExecuteSkill(context, skill, now) (æ‰§è¡ŒæŠ€èƒ½)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MonsterSkillDefinition ã€æ–°å¢ã€‘                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Id, Name (æ ‡è¯†å’Œåç§°)                                     â”‚
â”‚  â€¢ Cooldown: double (å†·å´æ—¶é—´)                              â”‚
â”‚  â€¢ Trigger: TriggerType (è§¦å‘ç±»å‹)                          â”‚
â”‚    - OnCooldown (å†·å´å¥½äº†å°±ç”¨)                              â”‚
â”‚    - OnHpThreshold (è¡€é‡ä½äºé˜ˆå€¼)                           â”‚
â”‚    - OnPlayerAttack (ç©å®¶æ”»å‡»æ—¶æ¦‚ç‡è§¦å‘)                    â”‚
â”‚  â€¢ TriggerProbability: double (è§¦å‘æ¦‚ç‡ 0~1)                â”‚
â”‚  â€¢ Effect: SkillEffect (æŠ€èƒ½æ•ˆæœ)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº‹ä»¶æµç¨‹å›¾

### ç©å®¶å¤æ´»æµç¨‹

```
[ç©å®¶è¢«æ€ªç‰©æ”»å‡»]
        â”‚
        â–¼
    è¡€é‡ > 0?
    â”œâ”€ æ˜¯ â†’ [ç»§ç»­æˆ˜æ–—]
    â””â”€ å¦ â†’ [ç©å®¶æ­»äº¡]
              â”‚
              â”œâ”€ è®°å½• DeathTime
              â”œâ”€ æ‰“æ ‡ç­¾ "player_died"
              â”‚
              â–¼
        AllowAutoRevival?
        â”œâ”€ æ˜¯ â†’ [è°ƒåº¦å¤æ´»äº‹ä»¶]
        â”‚        â”‚
        â”‚        â”œâ”€ ExecuteAt = now + 10ç§’
        â”‚        â”‚
        â”‚        â–¼
        â”‚    [PlayerRevivalEvent]
        â”‚        â”‚
        â”‚        â”œâ”€ Player.Revive(now)
        â”‚        â”œâ”€ æ¢å¤æ»¡è¡€
        â”‚        â”œâ”€ é‡æ–°è°ƒåº¦æ”»å‡»äº‹ä»¶
        â”‚        â”‚
        â”‚        â–¼
        â”‚    [ç»§ç»­æˆ˜æ–—]
        â”‚
        â””â”€ å¦ â†’ [è°ƒåº¦å¤±è´¥äº‹ä»¶]
                 â”‚
                 â–¼
             [BattleFailureEvent]
                 â”‚
                 â”œâ”€ æ ‡è®° Failed = true
                 â””â”€ [æˆ˜æ–—ç»“æŸ]
```

### éšæœºç›®æ ‡é€‰å–æµç¨‹

```
[ç©å®¶æ”»å‡»è§¦å‘]
        â”‚
        â–¼
    è·å–å­˜æ´»æ•Œäººåˆ—è¡¨
        â”‚
        â”œâ”€ æ— å­˜æ´» â†’ [ä¸æ”»å‡»ï¼Œä¸è°ƒåº¦ä¸‹æ¬¡]
        â”‚
        â”œâ”€ åªæœ‰1ä¸ª â†’ [ç›´æ¥æ”»å‡»]
        â”‚
        â””â”€ å¤šä¸ª â†’ [éšæœºé€‰æ‹©]
                    â”‚
                    â–¼
              UseWeightedSelection?
              â”œâ”€ æ˜¯ â†’ [åŠ æƒéšæœº]
              â”‚        â”‚
              â”‚        â”œâ”€ è®¡ç®—æ€»æƒé‡ = Î£(ThreatWeight)
              â”‚        â”œâ”€ Roll = Rng.NextDouble() * æ€»æƒé‡
              â”‚        â”œâ”€ ç´¯åŠ æƒé‡ç›´åˆ° > Roll
              â”‚        â””â”€ è¿”å›å¯¹åº”æ•Œäºº
              â”‚
              â””â”€ å¦ â†’ [ç­‰æ¦‚ç‡éšæœº]
                       â”‚
                       â”œâ”€ index = Rng.NextInt(0, count)
                       â””â”€ è¿”å› enemies[index]
                â”‚
                â–¼
        [å¯¹é€‰ä¸­ç›®æ ‡é€ æˆä¼¤å®³]
```

### æ€ªç‰©æ”»å‡»æµç¨‹

```
[æ€ªç‰©åˆå§‹åŒ–] (å¦‚æœ AttackPower > 0)
        â”‚
        â”œâ”€ è°ƒåº¦åˆæ¬¡æ”»å‡»
        â”‚   ExecuteAt = now + AttackInterval
        â”‚
        â–¼
[MonsterAttackTickEvent]
        â”‚
        â”œâ”€ æ€ªç‰©å­˜æ´»? â”€â”€â”€â”€â”
        â”‚   å¦ â†’ [ç»“æŸ]  â”‚
        â”‚                â”‚
        â”œâ”€ ç©å®¶å­˜æ´»? <â”€â”€â”€â”˜
        â”‚   å¦ â†’ [ä¸æ”»å‡»ï¼Œç­‰å¾…å¤æ´»]
        â”‚
        â”œâ”€ è®¡ç®—ä¼¤å®³ = Monster.AttackPower
        â”œâ”€ ApplyDamageToPlayer(...)
        â”‚   â”‚
        â”‚   â””â”€> å¯èƒ½è§¦å‘ç©å®¶æ­»äº¡/å¤æ´»
        â”‚
        â”œâ”€ è°ƒåº¦ä¸‹ä¸€æ¬¡æ”»å‡»
        â”‚   ExecuteAt = now + AttackInterval
        â”‚
        â””â”€> [å¾ªç¯]
```

### æ€ªç‰©æŠ€èƒ½æµç¨‹

```
[æ€ªç‰©åˆå§‹åŒ–] (å¦‚æœæœ‰æŠ€èƒ½)
        â”‚
        â”œâ”€ åˆ›å»º MonsterSkillSystem
        â”œâ”€ ä¸ºæ¯ä¸ªæŠ€èƒ½åˆå§‹åŒ–å†·å´
        â”‚
        â–¼
    æŠ€èƒ½è§¦å‘ç±»å‹?
    â”‚
    â”œâ”€ OnCooldown
    â”‚   â”‚
    â”‚   â””â”€> [è°ƒåº¦ MonsterSkillCheckEvent]
    â”‚           â”‚ æ¯ Cooldown ç§’è§¦å‘ä¸€æ¬¡
    â”‚           â”‚
    â”‚           â–¼
    â”‚       [æ£€æŸ¥æ¦‚ç‡]
    â”‚           â”‚
    â”‚           â”œâ”€ Roll = Rng.NextDouble()
    â”‚           â”œâ”€ Roll < TriggerProbability?
    â”‚           â”‚   â”œâ”€ æ˜¯ â†’ [æ‰§è¡ŒæŠ€èƒ½]
    â”‚           â”‚   â””â”€ å¦ â†’ [è·³è¿‡]
    â”‚           â”‚
    â”‚           â””â”€> [è°ƒåº¦ä¸‹æ¬¡æ£€æŸ¥]
    â”‚
    â”œâ”€ OnHpThreshold
    â”‚   â”‚
    â”‚   â””â”€> [åœ¨ ApplyDamage åæ£€æŸ¥]
    â”‚           â”‚
    â”‚           â”œâ”€ Hp% < Threshold?
    â”‚           â”‚   â”œâ”€ æ˜¯ â†’ [å°è¯•è§¦å‘]
    â”‚           â”‚   â””â”€ å¦ â†’ [è·³è¿‡]
    â”‚
    â””â”€ OnPlayerAttack
        â”‚
        â””â”€> [åœ¨ AttackTickEvent åæ£€æŸ¥]
                â”‚
                â”œâ”€ æ£€æŸ¥å†·å´å’Œæ¦‚ç‡
                â””â”€ [å¯èƒ½è§¦å‘]
```

---

## ç±»å…³ç³»å›¾

### æ ¸å¿ƒç±»å…³ç³»

```
           BattleEngine
                â”‚
                â”‚ has
                â–¼
          BattleContext
          â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
          â”‚           â”‚
       hasâ”‚        hasâ”‚
          â”‚           â”‚
          â–¼           â–¼
     PlayerState  EncounterGroup
          â”‚           â”‚
          â”‚           â”‚ contains
          â”‚           â–¼
          â”‚       Encounter â”€â”€â”€â”
          â”‚           â”‚        â”‚has
          â”‚           â”‚has     â”‚
          â”‚           â–¼        â–¼
          â”‚     EnemyDefinition  MonsterSkillSystem
          â”‚           â”‚              â”‚
          â”‚           â”‚has            â”‚manages
          â”‚           â–¼              â–¼
          â”‚  MonsterSkillDefinition  Cooldowns
          â”‚
          â”‚ can take damage from
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº‹ä»¶å…³ç³»

```
      EventScheduler
            â”‚
            â”‚ schedules
            â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ IGameEventâ”‚ (æ¥å£)
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–³
            â”‚
            â”œâ”€ AttackTickEvent
            â”‚   â”‚
            â”‚   â”œâ”€ uses â†’ TargetSelector
            â”‚   â””â”€ may trigger â†’ PlayerState.TakeDamage
            â”‚
            â”œâ”€ PlayerRevivalEvent
            â”‚   â”‚
            â”‚   â””â”€ calls â†’ PlayerState.Revive
            â”‚
            â”œâ”€ MonsterAttackTickEvent
            â”‚   â”‚
            â”‚   â””â”€ calls â†’ PlayerState.TakeDamage
            â”‚
            â””â”€ MonsterSkillCheckEvent
                â”‚
                â””â”€ triggers â†’ MonsterSkillSystem.TryTriggerSkill
```

---

## æ•°æ®æµå›¾

### ä¼¤å®³æ•°æ®æµ

```
ç©å®¶ â”€â”€â”€â”€â”€â”€â”€â”€> æ•Œäºº
    AttackTick
    SkillCast
         â”‚
         â”œâ”€> TargetSelector.SelectTarget(Rng)
         â”‚        â”‚
         â”‚        â””â”€> è¿”å› Encounter
         â”‚
         â”œâ”€> DamageCalculator.ApplyDamage(context, target, amount)
         â”‚        â”‚
         â”‚        â”œâ”€> target.CurrentHp -= amount
         â”‚        â”œâ”€> SegmentCollector.OnTag("damage", amount)
         â”‚        â”‚
         â”‚        â””â”€> target.IsDead?
         â”‚                 â”œâ”€ æ˜¯ â†’ TryRetargetPrimary
         â”‚                 â””â”€ å¦ â†’ ç»§ç»­


æ•Œäºº â”€â”€â”€â”€â”€â”€â”€â”€> ç©å®¶
    MonsterAttackTick
    MonsterSkillCast
         â”‚
         â”œâ”€> DamageCalculator.ApplyDamageToPlayer(context, amount)
         â”‚        â”‚
         â”‚        â”œâ”€> Player.CurrentHp -= amount
         â”‚        â”œâ”€> SegmentCollector.OnTag("player_damage", amount)
         â”‚        â”‚
         â”‚        â””â”€> Player.IsDead?
         â”‚                 â”œâ”€ æ˜¯ â†’ è°ƒåº¦ PlayerRevivalEvent
         â”‚                 â”‚       æˆ– BattleFailureEvent
         â”‚                 â””â”€ å¦ â†’ ç»§ç»­
```

### RNGæ•°æ®æµ

```
[æˆ˜æ–—å¼€å§‹]
     â”‚
     â”œâ”€ åˆå§‹åŒ– RngContext(seed)
     â”‚       â”‚
     â”‚       â””â”€> Index = 0
     â”‚
     â–¼
[äº‹ä»¶æ‰§è¡Œ]
     â”‚
     â”œâ”€ è®°å½• Index (å‰) â†’ Segment
     â”‚
     â”œâ”€ æ‰§è¡Œäº‹ä»¶
     â”‚   â”‚
     â”‚   â”œâ”€ æš´å‡»åˆ¤å®š â†’ Rng.NextBool(chance) â†’ Index++
     â”‚   â”œâ”€ ç›®æ ‡é€‰å– â†’ Rng.NextInt(0, count) â†’ Index++
     â”‚   â”œâ”€ æŠ€èƒ½æ¦‚ç‡ â†’ Rng.NextDouble() â†’ Index++
     â”‚   â””â”€ ... (ä»»ä½•éšæœºæ“ä½œ)
     â”‚
     â”œâ”€ è®°å½• Index (å) â†’ Segment
     â”‚
     â””â”€> [ä¸‹ä¸€ä¸ªäº‹ä»¶]
```

### é…ç½®æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BattleMeta  â”‚ (é…ç½®)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ EnablePlayerDeath = true
â”‚ â€¢ PlayerRevivalDelaySeconds = 10.0
â”‚ â€¢ UseWeightedTargetSelection = false
â”‚ â€¢ AllowAutoRevival = true
â”‚ â€¢ EnhancedDungeonMode = false
â”‚ â€¢ EnhancedDropMultiplier = 1.0
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ passed to
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚BattleEngine â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ read by
        â–¼
    æˆ˜æ–—é€»è¾‘åˆ†æ”¯
        â”‚
        â”œâ”€> PlayerState.TakeDamage()
        â”‚   â””â”€> æ£€æŸ¥ AllowAutoRevival
        â”‚
        â”œâ”€> AttackTickEvent
        â”‚   â””â”€> æ£€æŸ¥ UseWeightedTargetSelection
        â”‚
        â””â”€> DropCalculator
            â””â”€> åº”ç”¨ EnhancedDropMultiplier
```

---

## é…ç½®å¯ç”¨çŸ©é˜µ

| é…ç½®ç»„åˆ | ç©å®¶æ­»äº¡ | ç›®æ ‡é€‰å– | Enhancedæ¨¡å¼ | æ€ªç‰©æ”»å‡» | ç”¨é€” |
|---------|---------|---------|-------------|---------|------|
| é»˜è®¤ | âŒ | å›ºå®š | âŒ | âŒ | å‘åå…¼å®¹ (æœ¨æ¡©æ¨¡å¼) |
| åŸºç¡€éš¾åº¦ | âœ… | éšæœº | âŒ | âœ… | æ ‡å‡†æˆ˜æ–— |
| é«˜éš¾åº¦ | âœ… | åŠ æƒ | âŒ | âœ… | éœ€è¦ç­–ç•¥çš„æˆ˜æ–— |
| Enhanced | âœ… | åŠ æƒ | âœ… | âœ… | é«˜é£é™©é«˜å›æŠ¥ |
| æµ‹è¯•æ¨¡å¼ | âŒ | å›ºå®š | âŒ | âœ… | æµ‹è¯•æ€ªç‰©ä¼¤å®³ |

---

## æ€»ç»“

æœ¬æ¶æ„æ‰©å±•éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. âœ… **éä¾µå…¥æ€§**: é€šè¿‡æ–°å¢ç±»å’Œå¯é€‰é…ç½®å®ç°ï¼Œä¸ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
2. âœ… **æ¨¡å—åŒ–**: ç©å®¶çŠ¶æ€ã€ç›®æ ‡é€‰å–ã€æ€ªç‰©ç³»ç»Ÿç›¸äº’ç‹¬ç«‹
3. âœ… **å¯æµ‹è¯•**: æ¯ä¸ªæ¨¡å—å¯å•ç‹¬æµ‹è¯•ï¼ŒRNGå¯æ§
4. âœ… **å¯æ‰©å±•**: ä¸ºæœªæ¥åŠŸèƒ½é¢„ç•™æ¥å£ (ThreatWeight, SkillSystem)
5. âœ… **å‘åå…¼å®¹**: é»˜è®¤è¡Œä¸ºä¿æŒä¸å˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-09  
**é…å¥—æ–‡æ¡£**: æˆ˜æ–—ç³»ç»Ÿæ‰©å±•-åˆ†é˜¶æ®µå®æ–½æ–¹æ¡ˆ.md

