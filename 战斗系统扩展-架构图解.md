# 战斗系统扩展 - 架构图解

**版本**: 1.0  
**配套文档**: 战斗系统扩展-分阶段实施方案.md

---

## 目录

1. [当前架构](#当前架构)
2. [扩展后架构](#扩展后架构)
3. [事件流程图](#事件流程图)
4. [类关系图](#类关系图)
5. [数据流图](#数据流图)

---

## 当前架构

### 核心组件

```
┌─────────────────────────────────────────────────────────────┐
│                        BattleEngine                         │
├─────────────────────────────────────────────────────────────┤
│  • Clock: GameClock                                         │
│  • Scheduler: EventScheduler (PriorityQueue)                │
│  • Context: BattleContext                                   │
│  • Segments: List<CombatSegment>                            │
│  • Completed/Killed flags                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ contains
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       BattleContext                         │
├─────────────────────────────────────────────────────────────┤
│  • Stats: CharacterStats (玩家属性)                         │
│  • Encounter: Encounter (当前目标)                          │
│  • EncounterGroup: EncounterGroup (多怪)                    │
│  • AutoCaster: AutoCastEngine (技能)                        │
│  • Buffs: BuffManager                                       │
│  • Procs: ProcManager                                       │
│  • Rng: RngContext (可重放随机)                             │
│  • Tracks: List<TrackState> (攻击/特殊轨道)                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ attacks
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      EncounterGroup                         │
├─────────────────────────────────────────────────────────────┤
│  • All: List<Encounter> (多个敌人)                          │
│  • PrimaryAlive() → 返回第一个存活敌人                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ contains
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Encounter                           │
├─────────────────────────────────────────────────────────────┤
│  • Enemy: EnemyDefinition (静态定义)                        │
│  • CurrentHp: int (当前血量)                                │
│  • IsDead: bool (是否死亡)                                  │
│  • ApplyDamage(amount) (受到伤害)                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ definition
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      EnemyDefinition                        │
├─────────────────────────────────────────────────────────────┤
│  • Id, Name, Level                                          │
│  • MaxHp, Armor, MagicResist                                │
│  • Vulnerability (易伤)                                      │
│  📌 当前是"木桩"：只能被攻击，不会反击                        │
└─────────────────────────────────────────────────────────────┘
```

### 当前事件类型

```
┌──────────────────┐
│   IGameEvent     │  (接口)
└──────────────────┘
         △
         │ implements
         │
         ├─── AttackTickEvent (玩家普攻)
         ├─── SpecialPulseEvent (特殊资源生成)
         ├─── SkillCastEvent (技能释放)
         ├─── BuffExpireEvent (Buff过期)
         └─── ProcPulseEvent (触发效果检查)
```

### 当前战斗流程

```
[战斗开始]
    │
    ├─ 初始化 Context
    ├─ 创建 TrackState (Attack/Special)
    ├─ 调度初始事件
    │
    ▼
[事件循环] ◄──────┐
    │             │
    ├─ 取出下一事件 (优先队列)
    ├─ 推进时钟到事件时间
    ├─ 记录 RNG Index (前)
    ├─ 执行事件
    │   ├─ AttackTick → 对敌人造成伤害
    │   ├─ 尝试自动释放技能
    │   └─ 调度下一次攻击
    ├─ 记录 RNG Index (后)
    ├─ 检查敌人是否全灭
    │   ├─ 是 → [战斗结束]
    │   └─ 否 → ┘ (继续循环)
    │
    ▼
[战斗结束]
```

---

## 扩展后架构

### 新增核心组件

```
┌─────────────────────────────────────────────────────────────┐
│                       BattleContext                         │
├─────────────────────────────────────────────────────────────┤
│  【原有字段...】                                             │
│  ✨ + Player: PlayerState (玩家状态) 【新增】               │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ has
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       PlayerState 【新增】                   │
├─────────────────────────────────────────────────────────────┤
│  • CurrentHp: int (当前血量)                                │
│  • MaxHp: int (最大血量 = Stamina * 10)                     │
│  • IsDead: bool (是否死亡)                                  │
│  • DeathTime: double? (死亡时间)                            │
│  • RevivalTime: double? (复活时间)                          │
│  ────────────────────────────────────────────────────────── │
│  + TakeDamage(amount, now) (受到伤害)                       │
│  + Revive(now) (复活)                                       │
└─────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────┐
│                         Encounter                           │
├─────────────────────────────────────────────────────────────┤
│  【原有字段...】                                             │
│  ✨ + ThreatWeight: double = 1.0 (仇恨权重) 【新增】        │
│  ✨ + SkillSystem: MonsterSkillSystem? 【新增】             │
│  ────────────────────────────────────────────────────────── │
│  【原有方法...】                                             │
│  ✨ + ModifyThreatWeight(multiplier) 【新增】               │
│  ✨ + InitializeSkills(context, now) 【新增】               │
│  ✨ + Heal(amount) 【新增】                                 │
└─────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────┐
│                      EnemyDefinition                        │
├─────────────────────────────────────────────────────────────┤
│  【原有字段...】                                             │
│  ✨ + AttackPower: int = 0 (攻击力) 【新增】                │
│  ✨ + AttackInterval: double = 2.0 (攻击间隔) 【新增】      │
│  ✨ + AttackDamageType: DamageType 【新增】                 │
│  ✨ + Skills: List<MonsterSkillDefinition> 【新增】         │
└─────────────────────────────────────────────────────────────┘
```

### 新增事件类型

```
┌──────────────────┐
│   IGameEvent     │
└──────────────────┘
         △
         │
         ├─── ⚡ PlayerRevivalEvent 【新增】
         ├─── ⚡ BattleFailureEvent 【新增】
         ├─── ⚡ MonsterAttackTickEvent 【新增】
         └─── ⚡ MonsterSkillCheckEvent 【新增】
```

### 新增工具类

```
┌─────────────────────────────────────────────────────────────┐
│                     TargetSelector 【新增】                  │
├─────────────────────────────────────────────────────────────┤
│  + SelectRandomTarget(group, rng)                           │
│    → 等概率随机选择存活敌人                                  │
│  + SelectWeightedRandomTarget(group, rng)                   │
│    → 基于 ThreatWeight 加权随机选择                         │
└─────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────┐
│                 MonsterSkillSystem 【新增】                  │
├─────────────────────────────────────────────────────────────┤
│  • Monster: Encounter (所属怪物)                            │
│  • Cooldowns: Dictionary<skillId, readyTime>                │
│  ────────────────────────────────────────────────────────── │
│  + Initialize(context, now) (初始化)                        │
│  + TryTriggerSkill(context, skill, now) (尝试触发)          │
│  - ExecuteSkill(context, skill, now) (执行技能)             │
└─────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────┐
│              MonsterSkillDefinition 【新增】                 │
├─────────────────────────────────────────────────────────────┤
│  • Id, Name (标识和名称)                                     │
│  • Cooldown: double (冷却时间)                              │
│  • Trigger: TriggerType (触发类型)                          │
│    - OnCooldown (冷却好了就用)                              │
│    - OnHpThreshold (血量低于阈值)                           │
│    - OnPlayerAttack (玩家攻击时概率触发)                    │
│  • TriggerProbability: double (触发概率 0~1)                │
│  • Effect: SkillEffect (技能效果)                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 事件流程图

### 玩家复活流程

```
[玩家被怪物攻击]
        │
        ▼
    血量 > 0?
    ├─ 是 → [继续战斗]
    └─ 否 → [玩家死亡]
              │
              ├─ 记录 DeathTime
              ├─ 打标签 "player_died"
              │
              ▼
        AllowAutoRevival?
        ├─ 是 → [调度复活事件]
        │        │
        │        ├─ ExecuteAt = now + 10秒
        │        │
        │        ▼
        │    [PlayerRevivalEvent]
        │        │
        │        ├─ Player.Revive(now)
        │        ├─ 恢复满血
        │        ├─ 重新调度攻击事件
        │        │
        │        ▼
        │    [继续战斗]
        │
        └─ 否 → [调度失败事件]
                 │
                 ▼
             [BattleFailureEvent]
                 │
                 ├─ 标记 Failed = true
                 └─ [战斗结束]
```

### 随机目标选取流程

```
[玩家攻击触发]
        │
        ▼
    获取存活敌人列表
        │
        ├─ 无存活 → [不攻击，不调度下次]
        │
        ├─ 只有1个 → [直接攻击]
        │
        └─ 多个 → [随机选择]
                    │
                    ▼
              UseWeightedSelection?
              ├─ 是 → [加权随机]
              │        │
              │        ├─ 计算总权重 = Σ(ThreatWeight)
              │        ├─ Roll = Rng.NextDouble() * 总权重
              │        ├─ 累加权重直到 > Roll
              │        └─ 返回对应敌人
              │
              └─ 否 → [等概率随机]
                       │
                       ├─ index = Rng.NextInt(0, count)
                       └─ 返回 enemies[index]
                │
                ▼
        [对选中目标造成伤害]
```

### 怪物攻击流程

```
[怪物初始化] (如果 AttackPower > 0)
        │
        ├─ 调度初次攻击
        │   ExecuteAt = now + AttackInterval
        │
        ▼
[MonsterAttackTickEvent]
        │
        ├─ 怪物存活? ────┐
        │   否 → [结束]  │
        │                │
        ├─ 玩家存活? <───┘
        │   否 → [不攻击，等待复活]
        │
        ├─ 计算伤害 = Monster.AttackPower
        ├─ ApplyDamageToPlayer(...)
        │   │
        │   └─> 可能触发玩家死亡/复活
        │
        ├─ 调度下一次攻击
        │   ExecuteAt = now + AttackInterval
        │
        └─> [循环]
```

### 怪物技能流程

```
[怪物初始化] (如果有技能)
        │
        ├─ 创建 MonsterSkillSystem
        ├─ 为每个技能初始化冷却
        │
        ▼
    技能触发类型?
    │
    ├─ OnCooldown
    │   │
    │   └─> [调度 MonsterSkillCheckEvent]
    │           │ 每 Cooldown 秒触发一次
    │           │
    │           ▼
    │       [检查概率]
    │           │
    │           ├─ Roll = Rng.NextDouble()
    │           ├─ Roll < TriggerProbability?
    │           │   ├─ 是 → [执行技能]
    │           │   └─ 否 → [跳过]
    │           │
    │           └─> [调度下次检查]
    │
    ├─ OnHpThreshold
    │   │
    │   └─> [在 ApplyDamage 后检查]
    │           │
    │           ├─ Hp% < Threshold?
    │           │   ├─ 是 → [尝试触发]
    │           │   └─ 否 → [跳过]
    │
    └─ OnPlayerAttack
        │
        └─> [在 AttackTickEvent 后检查]
                │
                ├─ 检查冷却和概率
                └─ [可能触发]
```

---

## 类关系图

### 核心类关系

```
           BattleEngine
                │
                │ has
                ▼
          BattleContext
          ┌─────┴─────┐
          │           │
       has│        has│
          │           │
          ▼           ▼
     PlayerState  EncounterGroup
          │           │
          │           │ contains
          │           ▼
          │       Encounter ───┐
          │           │        │has
          │           │has     │
          │           ▼        ▼
          │     EnemyDefinition  MonsterSkillSystem
          │           │              │
          │           │has            │manages
          │           ▼              ▼
          │  MonsterSkillDefinition  Cooldowns
          │
          │ can take damage from
          └─────────────────────────────┘
```

### 事件关系

```
      EventScheduler
            │
            │ schedules
            ▼
      ┌──────────┐
      │ IGameEvent│ (接口)
      └──────────┘
            △
            │
            ├─ AttackTickEvent
            │   │
            │   ├─ uses → TargetSelector
            │   └─ may trigger → PlayerState.TakeDamage
            │
            ├─ PlayerRevivalEvent
            │   │
            │   └─ calls → PlayerState.Revive
            │
            ├─ MonsterAttackTickEvent
            │   │
            │   └─ calls → PlayerState.TakeDamage
            │
            └─ MonsterSkillCheckEvent
                │
                └─ triggers → MonsterSkillSystem.TryTriggerSkill
```

---

## 数据流图

### 伤害数据流

```
玩家 ────────> 敌人
    AttackTick
    SkillCast
         │
         ├─> TargetSelector.SelectTarget(Rng)
         │        │
         │        └─> 返回 Encounter
         │
         ├─> DamageCalculator.ApplyDamage(context, target, amount)
         │        │
         │        ├─> target.CurrentHp -= amount
         │        ├─> SegmentCollector.OnTag("damage", amount)
         │        │
         │        └─> target.IsDead?
         │                 ├─ 是 → TryRetargetPrimary
         │                 └─ 否 → 继续


敌人 ────────> 玩家
    MonsterAttackTick
    MonsterSkillCast
         │
         ├─> DamageCalculator.ApplyDamageToPlayer(context, amount)
         │        │
         │        ├─> Player.CurrentHp -= amount
         │        ├─> SegmentCollector.OnTag("player_damage", amount)
         │        │
         │        └─> Player.IsDead?
         │                 ├─ 是 → 调度 PlayerRevivalEvent
         │                 │       或 BattleFailureEvent
         │                 └─ 否 → 继续
```

### RNG数据流

```
[战斗开始]
     │
     ├─ 初始化 RngContext(seed)
     │       │
     │       └─> Index = 0
     │
     ▼
[事件执行]
     │
     ├─ 记录 Index (前) → Segment
     │
     ├─ 执行事件
     │   │
     │   ├─ 暴击判定 → Rng.NextBool(chance) → Index++
     │   ├─ 目标选取 → Rng.NextInt(0, count) → Index++
     │   ├─ 技能概率 → Rng.NextDouble() → Index++
     │   └─ ... (任何随机操作)
     │
     ├─ 记录 Index (后) → Segment
     │
     └─> [下一个事件]
```

### 配置数据流

```
┌─────────────┐
│ BattleMeta  │ (配置)
├─────────────┤
│ • EnablePlayerDeath = true
│ • PlayerRevivalDelaySeconds = 10.0
│ • UseWeightedTargetSelection = false
│ • AllowAutoRevival = true
│ • EnhancedDungeonMode = false
│ • EnhancedDropMultiplier = 1.0
└─────────────┘
        │
        │ passed to
        ▼
┌─────────────┐
│BattleEngine │
└─────────────┘
        │
        │ read by
        ▼
    战斗逻辑分支
        │
        ├─> PlayerState.TakeDamage()
        │   └─> 检查 AllowAutoRevival
        │
        ├─> AttackTickEvent
        │   └─> 检查 UseWeightedTargetSelection
        │
        └─> DropCalculator
            └─> 应用 EnhancedDropMultiplier
```

---

## 配置启用矩阵

| 配置组合 | 玩家死亡 | 目标选取 | Enhanced模式 | 怪物攻击 | 用途 |
|---------|---------|---------|-------------|---------|------|
| 默认 | ❌ | 固定 | ❌ | ❌ | 向后兼容 (木桩模式) |
| 基础难度 | ✅ | 随机 | ❌ | ✅ | 标准战斗 |
| 高难度 | ✅ | 加权 | ❌ | ✅ | 需要策略的战斗 |
| Enhanced | ✅ | 加权 | ✅ | ✅ | 高风险高回报 |
| 测试模式 | ❌ | 固定 | ❌ | ✅ | 测试怪物伤害 |

---

## 总结

本架构扩展遵循以下原则：

1. ✅ **非侵入性**: 通过新增类和可选配置实现，不修改核心逻辑
2. ✅ **模块化**: 玩家状态、目标选取、怪物系统相互独立
3. ✅ **可测试**: 每个模块可单独测试，RNG可控
4. ✅ **可扩展**: 为未来功能预留接口 (ThreatWeight, SkillSystem)
5. ✅ **向后兼容**: 默认行为保持不变

---

**文档版本**: 1.0  
**创建日期**: 2025-01-09  
**配套文档**: 战斗系统扩展-分阶段实施方案.md

