# BlazorIdle 装备系统完整优化方案 - 上篇

**项目**: BlazorIdle  
**文档类型**: 综合设计方案（整合版）  
**创建日期**: 2025-10-11  
**版本**: 2.0 整合版  
**状态**: 设计阶段 - 待实施  
**文档分册**: 上篇（共三篇）

---

## 📋 文档说明

本文档整合了以下两套优化方案的内容：
1. **装备系统优化方案.md** - 侧重基础装备功能实现（生成、掉落、管理、增强）
2. **装备系统优化设计方案.md** - 侧重高级特性（17槽位、护甲类型、武器系统、职业限制）

整合后形成一套完整的、可分步实施的装备系统优化方案，分为上、中、下三篇：
- **上篇**：概览、架构设计、Phase 1-3（数据模型与核心功能）
- **中篇**：Phase 4-6（前端实现、装备增强、套装系统）
- **下篇**：Phase 7-9（高级功能、测试文档、风险管理）

---

## 📖 目录

### 上篇内容
1. [整合设计概览](#1-整合设计概览)
2. [当前状态全面分析](#2-当前状态全面分析)
3. [设计目标与原则](#3-设计目标与原则)
4. [装备系统完整架构](#4-装备系统完整架构)
5. [数据模型完整设计](#5-数据模型完整设计)
6. [Phase 1: 数据库与领域模型基础](#phase-1-数据库与领域模型基础-第1-2周)
7. [Phase 2: 装备生成与掉落系统](#phase-2-装备生成与掉落系统-第3-4周)
8. [Phase 3: 装备管理与战斗集成](#phase-3-装备管理与战斗集成-第5-6周)

---

## 1. 整合设计概览

### 1.1 整合目标

本方案将两套装备优化方案深度整合，实现以下核心目标：

#### 基础功能目标（来自方案一）
- ✅ 完善服务端装备生成、掉落、装备/卸下、属性计算
- ✅ 集成到战斗系统和经济系统
- ✅ 支持装备增强（分解/重铸/词条重置）
- ✅ 实现前端装备管理和操作界面

#### 高级特性目标（来自方案二）
- ✅ 扩展装备槽位从9个到17个（含双戒指、双饰品、完整武器系统）
- ✅ 引入护甲类型系统（布甲、皮甲、锁甲、板甲）
- ✅ 实现武器类型系统（15种武器类型，攻击速度机制）
- ✅ 实现护甲减伤和格挡机制
- ✅ 实现职业装备限制和平衡

### 1.2 整合优势

通过整合两套方案，我们获得：

1. **完整性** - 从基础数据模型到高级游戏机制的全覆盖
2. **渐进性** - 分9个Phase逐步实施，每个Phase可独立测试和上线
3. **可验证性** - 每个Phase包含前端验证步骤，确保功能可见可用
4. **一致性** - 统一的代码风格、架构原则和实施标准
5. **扩展性** - 为未来功能预留接口（附魔、宝石、特殊效果等）

### 1.3 核心设计亮点

| 设计维度 | 核心亮点 |
|---------|---------|
| **数据驱动** | 所有配置通过JSON管理，支持热重载，无需重新编译 |
| **服务端权威** | 所有装备操作和属性计算在服务端验证，防止作弊 |
| **领域驱动** | 清晰的领域边界（Equipment / Economy / Combat），符合DDD模式 |
| **类WoW设计** | 参考《魔兽世界》成熟的装备系统设计 |
| **性能优化** | 属性计算缓存、懒加载、批量操作支持 |
| **前端友好** | 每个后端功能对应前端验证点，确保用户可感知 |

---

## 2. 当前状态全面分析

### 2.1 已完成的工作

根据项目文档分析，装备系统UI框架已在 **Step 5** 完成：

#### ✅ 已实现部分

**1. 前端UI框架** (`EquipmentPanel.razor`)
- 9个装备槽位UI（头盔/武器/胸甲/副手/腰带/腿部/鞋子/饰品1/饰品2）
- 总属性展示面板
- 品质颜色系统（普通/稀有/史诗/传说）
- 装备槽位布局（3x3网格）

**2. 数据模型定义** (`ApiModels.cs`)
- `EquipmentResponse`: 装备栏响应
- `EquipmentSlotDto`: 装备槽
- `GearInstanceDto`: 装备实例
- `AffixDto`: 装备词条

**3. API接口预留** (`EquipmentController.cs`)
- `GET /api/equipment/{characterId}` - 获取装备栏（返回空槽）
- `POST /api/equipment/{characterId}/{slot}` - 装备物品（返回501）
- `DELETE /api/equipment/{characterId}/{slot}` - 卸下装备（返回501）
- `GET /api/equipment/{characterId}/stats` - 获取装备属性（返回零属性）

**4. 测试覆盖**
- 18个单元测试全部通过
- 覆盖槽位类型、品质、属性等核心功能

### 2.2 缺失的关键功能

#### ❌ 数据层缺失
- 装备定义表（GearDefinition）
- 装备实例表（GearInstance）
- 装备词条系统（Affix / AffixInstance）
- 套装系统（GearSet）
- 护甲类型和武器类型配置

#### ❌ 服务层缺失
- 装备生成逻辑（品质/Tier/词条随机）
- 装备掉落系统（集成到Economy）
- 装备/卸下操作服务
- 装备属性计算与汇总服务
- 装备增强服务（分解/重铸/词条重置）
- 护甲计算和格挡机制

#### ❌ 集成层缺失
- 装备属性注入到 CharacterStats
- 装备属性参与战斗计算
- 装备特效/触发技能
- 职业装备限制验证

### 2.3 可复用的现有系统

#### 1. 经济系统 (`Domain/Combat/Economy/`)
- ✅ `EconomyRegistry`: 物品注册中心
- ✅ `LootTable`: 掉落表系统
- ✅ `EconomyCalculator`: 掉落计算器
- ✅ `RewardGrantService`: 奖励发放服务
- ✅ `InventoryItem`: 背包物品表
- **可扩展**: 将装备作为特殊物品类型集成

#### 2. 战斗系统 (`Domain/Combat/`)
- ✅ `CharacterStats`: 角色属性（攻击/暴击/急速/穿透）
- ✅ `PlayerCombatant`: 玩家战斗单位
- ✅ `StatsBuilder`: 属性构建器
- ✅ `BuffManager`: Buff管理（可用于套装效果）
- **需集成**: 装备属性计算注入到属性构建流程

#### 3. 职业系统 (`Domain/Combat/Professions/`)
- ✅ `IProfessionModule`: 职业模块接口
- ✅ `WarriorModule`: 战士实现
- ✅ `RangerModule`: 游侠实现
- **需扩展**: 职业装备限制配置

---

## 3. 设计目标与原则

### 3.1 综合设计目标

#### 功能目标
1. **完整的装备生命周期**
   - 生成：随机品质、Tier、词条、属性
   - 获取：通过战斗掉落、任务奖励、商店购买
   - 使用：装备/卸下、属性生效、套装激活
   - 增强：分解、重铸、词条重置
   - 管理：背包存储、对比、排序、筛选

2. **完整的装备系统特性**
   - 17个装备槽位（头/颈/肩/背/胸/腕/手/腰/腿/脚/主手/副手/双手/戒指×2/饰品×2）
   - 4种护甲类型（布甲/皮甲/锁甲/板甲），影响减伤
   - 15种武器类型，影响攻击速度和伤害倍率
   - 格挡机制（盾牌特有）
   - 职业装备限制（战士不能穿布甲，法师不能用双手斧等）

3. **完整的战斗集成**
   - 装备属性正确注入角色属性
   - 护甲值影响伤害减免
   - 武器攻击速度影响战斗节奏
   - 格挡概率触发并减伤
   - 套装效果触发特殊Buff

#### 技术目标
1. **服务端权威性** - 所有装备操作在服务端验证和计算
2. **数据驱动** - 配置化管理，支持快速调整和扩展
3. **高性能** - 缓存优化，批量操作，懒加载
4. **可测试性** - 完整的单元测试和集成测试覆盖
5. **可维护性** - 清晰的模块划分，符合SOLID原则

#### 体验目标
1. **直观易用** - 前端界面友好，操作流畅
2. **即时反馈** - 装备操作立即可见，属性变化清晰
3. **深度可玩** - 装备搭配策略丰富，优化空间大
4. **平衡合理** - 不同职业、不同装备类型各有优势

### 3.2 核心设计原则

根据《整合设计总结.txt》第3节架构原则，我们遵循：

#### 1. 服务端权威 (Server Authoritative)
```
✅ 所有装备操作在服务端验证
✅ 装备属性计算在服务端完成
✅ 防止客户端作弊
✅ 掉落表和随机数在服务端控制
```

#### 2. 数据驱动 (Data-Driven)
```
✅ 装备定义配置化（JSON/数据表）
✅ 词条池、掉落表配置化
✅ 护甲类型、武器类型配置化
✅ 职业限制配置化
✅ 便于平衡调整和内容扩展
```

#### 3. 领域驱动设计 (DDD)
```
✅ 清晰的领域边界（Equipment / Economy / Combat）
✅ 聚合根模式（GearInstance 作为聚合根）
✅ 领域事件传播（EquipmentChanged / StatsRecalculated）
✅ 值对象封装（StatModifier, TierLevel, Rarity）
```

#### 4. 可测试性 (Testability)
```
✅ 单元测试覆盖核心逻辑
✅ 可注入依赖（RNG / Repository）
✅ 幂等性保证
✅ 确定性随机（RNGContext）
```

#### 5. 性能优化
```
✅ 属性计算缓存（装备变更时失效）
✅ 懒加载装备数据
✅ 批量操作支持
✅ 数据库索引优化
```

#### 6. 安全性
```
✅ 装备操作限频
✅ 交易验证（防止刷装备）
✅ 装备绑定机制
✅ 审计日志记录
```

---

## 4. 装备系统完整架构

### 4.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Blazor)                        │
├─────────────────────────────────────────────────────────────┤
│  EquipmentPanel.razor    │ InventoryPanel.razor              │
│  GearEnhancementDialog   │ GearComparisonTooltip            │
│  EquipmentApiClient      │ 前端状态管理                       │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTP/SignalR
┌─────────────────────────────────────────────────────────────┐
│                      API层 (Controllers)                      │
├─────────────────────────────────────────────────────────────┤
│  EquipmentController     │ 装备CRUD操作                       │
│  EnhancementController   │ 装备增强操作                       │
│  ValidationMiddleware    │ 请求验证和限频                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    应用服务层 (Services)                      │
├─────────────────────────────────────────────────────────────┤
│  EquipmentService        │ 装备管理核心逻辑                   │
│  GearGenerationService   │ 装备生成算法                       │
│  StatsAggregationService │ 属性聚合计算                       │
│  DisenchantService       │ 分解服务                          │
│  ReforgeService          │ 重铸服务                          │
│  SetBonusService         │ 套装效果服务                       │
│  ArmorCalculator         │ 护甲计算服务                       │
│  BlockCalculator         │ 格挡计算服务                       │
│  EquipmentValidator      │ 装备验证服务                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     领域模型层 (Domain)                       │
├─────────────────────────────────────────────────────────────┤
│  Models:                                                     │
│  - GearDefinition        │ 装备定义（配置）                   │
│  - GearInstance          │ 装备实例（运行时）                 │
│  - Affix/AffixInstance   │ 词条系统                          │
│  - GearSet               │ 套装定义                          │
│  - ArmorTypeConfig       │ 护甲类型配置                       │
│  - WeaponTypeConfig      │ 武器类型配置                       │
│  - ProfessionEquipConfig │ 职业装备限制                       │
│                                                              │
│  Value Objects:                                              │
│  - StatModifier          │ 属性修饰符                         │
│  - TierLevel             │ 品级                              │
│  - Rarity                │ 稀有度                            │
│  - EquipmentSlot         │ 装备槽位枚举                       │
│  - ArmorType             │ 护甲类型枚举                       │
│  - WeaponType            │ 武器类型枚举                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    数据持久层 (Repository)                    │
├─────────────────────────────────────────────────────────────┤
│  IGearDefinitionRepository                                   │
│  IGearInstanceRepository                                     │
│  IAffixRepository                                            │
│  IGearSetRepository                                          │
│  ↓                                                           │
│  GameDbContext (EF Core)                                     │
│  ↓                                                           │
│  PostgreSQL Database                                         │
└─────────────────────────────────────────────────────────────┘

横向集成：
├─ Economy System: 掉落表、奖励发放、材料系统
├─ Combat System: 属性注入、战斗计算、Buff系统
├─ Profession System: 职业限制、职业特性
└─ RNG System: 确定性随机、种子管理
```

### 4.2 模块详细划分

```
BlazorIdle.Server/Domain/Equipment/
├── Models/
│   ├── GearDefinition.cs          # 装备定义（配置数据）
│   ├── GearInstance.cs            # 装备实例（角色持有）
│   ├── Affix.cs                   # 词条定义
│   ├── AffixInstance.cs           # 词条实例
│   ├── GearSet.cs                 # 套装定义
│   ├── ArmorTypeConfig.cs         # 护甲类型配置
│   ├── WeaponTypeConfig.cs        # 武器类型配置
│   ├── EquipmentSlotConfig.cs     # 装备槽位配置
│   ├── ProfessionEquipmentConfig.cs # 职业装备限制
│   └── EquipmentSystemConfiguration.cs # 主配置类
│
├── Enums/
│   ├── EquipmentSlot.cs           # 装备槽位（17个）
│   ├── ArmorType.cs               # 护甲类型（4种）
│   ├── WeaponType.cs              # 武器类型（15种）
│   ├── Rarity.cs                  # 稀有度
│   ├── SlotCategory.cs            # 槽位分类
│   └── ModifierType.cs            # 修饰符类型
│
├── ValueObjects/
│   ├── StatModifier.cs            # 属性修饰符
│   ├── TierLevel.cs               # 品级（T1-T3）
│   ├── StatRange.cs               # 属性范围
│   └── EquipmentSlotOccupancy.cs  # 槽位占用
│
├── Services/
│   ├── GearGenerationService.cs   # 装备生成核心
│   ├── EquipmentService.cs        # 装备管理核心
│   ├── StatsAggregationService.cs # 属性聚合
│   ├── DisenchantService.cs       # 装备分解
│   ├── ReforgeService.cs          # 品级重铸
│   ├── AffixRerollService.cs      # 词条重置
│   ├── SetBonusService.cs         # 套装效果
│   ├── ArmorCalculator.cs         # 护甲计算
│   ├── BlockCalculator.cs         # 格挡计算
│   ├── AttackSpeedCalculator.cs   # 攻速计算
│   ├── EquipmentValidator.cs      # 装备验证
│   ├── EquipmentConfigurationService.cs # 配置加载
│   └── EquipmentCacheService.cs   # 缓存管理
│
├── Repositories/
│   ├── IGearDefinitionRepository.cs
│   ├── IGearInstanceRepository.cs
│   ├── IAffixRepository.cs
│   └── IGearSetRepository.cs
│
└── Events/
    ├── EquipmentChangedEvent.cs   # 装备变更事件
    ├── StatsRecalculatedEvent.cs  # 属性重算事件
    ├── SetBonusActivatedEvent.cs  # 套装激活事件
    └── GearEnhancedEvent.cs       # 装备增强事件
```

### 4.3 核心数据流

#### 装备生成流程
```
掉落触发（战斗/任务）
  ↓
EconomyCalculator 选择装备定义
  ↓
GearGenerationService.Generate()
  ├─ 1. 确定稀有度（加权随机）
  ├─ 2. 确定品级（默认T1）
  ├─ 3. 计算物品等级
  ├─ 4. Roll基础属性（范围内随机）
  ├─ 5. 生成词条
  │   ├─ 根据稀有度决定数量
  │   ├─ 从词条池随机选择
  │   ├─ Roll词条数值
  │   └─ 防止重复词条
  ├─ 6. 应用护甲/武器类型特性
  ├─ 7. 计算装备评分
  └─ 8. 创建GearInstance
  ↓
RewardGrantService 写入背包
  ↓
前端通知（掉落提示）
```

#### 装备装备流程
```
玩家点击装备按钮
  ↓
前端 POST /api/equipment/{characterId}/{slot}
  ↓
EquipmentController 接收请求
  ↓
EquipmentValidator 验证
  ├─ 槽位匹配检查
  ├─ 等级需求检查
  ├─ 职业限制检查
  ├─ 双手武器占用检查
  └─ 背包是否拥有检查
  ↓
EquipmentService.EquipItem()
  ├─ 卸下旧装备（如有）
  ├─ 装备新装备
  ├─ 更新GearInstance状态
  └─ 触发 EquipmentChangedEvent
  ↓
StatsAggregationService 重算属性
  ├─ 聚合所有装备属性
  ├─ 应用套装加成
  ├─ 计算护甲减伤
  ├─ 计算格挡
  └─ 更新CharacterStats
  ↓
返回前端（新装备栏 + 新属性）
  ↓
前端更新UI（装备栏 + 属性面板）
```

#### 战斗属性注入流程
```
战斗开始
  ↓
StatsBuilder.BuildStats(character)
  ├─ 获取基础职业属性
  ├─ 注入装备属性（调用StatsAggregationService）
  │   ├─ 基础属性（攻击/生命/护甲）
  │   ├─ 词条属性（暴击/急速/穿透）
  │   ├─ 套装加成
  │   └─ 护甲减伤系数
  ├─ 应用Buff修饰
  └─ 返回最终CharacterStats
  ↓
BattleEngine 使用最终属性进行战斗
  ├─ 攻击速度来自武器类型
  ├─ 伤害减免应用护甲公式
  ├─ 格挡判定（如有盾牌）
  └─ 套装特效触发
```

---

## 5. 数据模型完整设计

### 5.1 核心实体模型

#### GearDefinition (装备定义 - 配置数据)

```csharp
/// <summary>
/// 装备定义 - 配置数据，定义装备的基础模板
/// </summary>
public class GearDefinition
{
    /// <summary>装备定义ID（唯一标识）</summary>
    public string Id { get; set; } // 例如: "sword_iron", "helmet_steel"
    
    /// <summary>显示名称</summary>
    public string Name { get; set; } // 例如: "铁剑", "钢铁头盔"
    
    /// <summary>图标</summary>
    public string Icon { get; set; } // Emoji 或图标路径
    
    /// <summary>装备槽位</summary>
    public EquipmentSlot Slot { get; set; }
    
    /// <summary>需求等级</summary>
    public int RequiredLevel { get; set; } = 1;
    
    /// <summary>基础属性范围（JSON）</summary>
    /// <example>{"AttackPower": {"Min": 10, "Max": 15}, "Health": {"Min": 50, "Max": 100}}</example>
    public string BaseStatsJson { get; set; }
    
    /// <summary>允许的词条池（JSON）</summary>
    /// <example>["affix_strength", "affix_crit", "affix_haste"]</example>
    public string AllowedAffixPoolJson { get; set; }
    
    /// <summary>稀有度权重（JSON）</summary>
    /// <example>{"Common": 0.6, "Rare": 0.3, "Epic": 0.08, "Legendary": 0.02}</example>
    public string RarityWeightsJson { get; set; }
    
    /// <summary>套装ID（可选）</summary>
    public string? SetId { get; set; }
    
    // ===== 新增：护甲和武器属性 =====
    
    /// <summary>护甲类型</summary>
    public ArmorType ArmorType { get; set; } = ArmorType.None;
    
    /// <summary>武器类型</summary>
    public WeaponType WeaponType { get; set; } = WeaponType.None;
    
    /// <summary>基础护甲值（仅防具）</summary>
    public double BaseArmor { get; set; } = 0;
    
    /// <summary>基础攻击速度（仅武器，秒/次）</summary>
    public double BaseAttackSpeed { get; set; } = 0;
    
    /// <summary>攻击倍率（仅武器）</summary>
    public double AttackPowerMultiplier { get; set; } = 1.0;
    
    /// <summary>格挡概率（仅盾牌）</summary>
    public double BlockChance { get; set; } = 0;
    
    /// <summary>格挡减伤（仅盾牌）</summary>
    public double BlockReduction { get; set; } = 0;
    
    /// <summary>职业限制（JSON数组）</summary>
    /// <example>["Warrior", "Paladin"] - 仅战士和圣骑士可装备</example>
    public string? AllowedProfessionsJson { get; set; }
    
    /// <summary>是否双手武器</summary>
    public bool IsTwoHanded { get; set; } = false;
}
```

#### GearInstance (装备实例 - 运行时数据)

```csharp
/// <summary>
/// 装备实例 - 玩家实际持有的装备，包含随机生成的属性
/// </summary>
public class GearInstance
{
    /// <summary>实例ID</summary>
    public Guid Id { get; set; }
    
    /// <summary>关联的装备定义ID</summary>
    public string DefinitionId { get; set; }
    
    /// <summary>所属角色ID</summary>
    public Guid CharacterId { get; set; }
    
    /// <summary>稀有度（生成时确定）</summary>
    public Rarity Rarity { get; set; }
    
    /// <summary>品级（T1-T3，可重铸提升）</summary>
    public int Tier { get; set; } = 1;
    
    /// <summary>物品等级（影响属性数值）</summary>
    public int ItemLevel { get; set; }
    
    /// <summary>实际属性（JSON）- Roll后的基础属性</summary>
    /// <example>{"AttackPower": 12, "Health": 75}</example>
    public string RolledStatsJson { get; set; }
    
    /// <summary>词条实例列表（JSON）</summary>
    /// <example>[{"AffixId": "affix_strength", "Value": 10}, ...]</example>
    public string AffixInstancesJson { get; set; }
    
    /// <summary>装备评分（综合评价）</summary>
    public int QualityScore { get; set; }
    
    /// <summary>是否已装备</summary>
    public bool IsEquipped { get; set; } = false;
    
    /// <summary>当前槽位（如已装备）</summary>
    public EquipmentSlot? CurrentSlot { get; set; }
    
    /// <summary>是否绑定</summary>
    public bool IsBound { get; set; } = false;
    
    /// <summary>创建时间</summary>
    public DateTime CreatedAt { get; set; }
    
    /// <summary>最后更新时间</summary>
    public DateTime UpdatedAt { get; set; }
    
    // ===== 导航属性 =====
    public GearDefinition Definition { get; set; }
    public Character Character { get; set; }
}
```

#### Affix (词条定义 - 配置数据)

```csharp
/// <summary>
/// 词条定义 - 配置数据，定义可能出现的词条类型
/// </summary>
public class Affix
{
    /// <summary>词条ID</summary>
    public string Id { get; set; } // 例如: "affix_strength", "affix_crit"
    
    /// <summary>显示名称模板</summary>
    /// <example>"+{value} 力量", "+{value}% 暴击"</example>
    public string NameTemplate { get; set; }
    
    /// <summary>影响的属性类型</summary>
    public string StatType { get; set; } // "AttackPower", "CritChance", etc.
    
    /// <summary>修饰符类型</summary>
    public ModifierType ModifierType { get; set; } // Additive / Multiplicative / FinalAdd
    
    /// <summary>数值范围最小值</summary>
    public double MinValue { get; set; }
    
    /// <summary>数值范围最大值</summary>
    public double MaxValue { get; set; }
    
    /// <summary>词条品质（影响出现概率）</summary>
    public int AffixTier { get; set; } = 1;
    
    /// <summary>权重（Roll概率）</summary>
    public double Weight { get; set; } = 1.0;
}
```

#### GearSet (套装定义 - 配置数据)

```csharp
/// <summary>
/// 套装定义 - 配置数据，定义套装效果
/// </summary>
public class GearSet
{
    /// <summary>套装ID</summary>
    public string Id { get; set; } // 例如: "set_warrior_tier1"
    
    /// <summary>套装名称</summary>
    public string Name { get; set; } // 例如: "狂战士套装"
    
    /// <summary>套装描述</summary>
    public string Description { get; set; }
    
    /// <summary>套装件数要求与效果（JSON）</summary>
    /// <example>
    /// {
    ///   "2": {"AttackPower": 10},
    ///   "4": {"AttackPower": 20, "CritChance": 0.05},
    ///   "6": {"AttackPower": 30, "CritChance": 0.10, "SpecialEffect": "berserk"}
    /// }
    /// </example>
    public string BonusesJson { get; set; }
    
    /// <summary>套装图标</summary>
    public string Icon { get; set; }
}
```

### 5.2 枚举定义

#### EquipmentSlot (17个装备槽位)

```csharp
/// <summary>
/// 装备槽位枚举 - 完整17槽位系统
/// </summary>
public enum EquipmentSlot
{
    // ===== 防具槽位 (10个) =====
    Head,           // 头部 - 头盔
    Neck,           // 颈部 - 项链
    Shoulder,       // 肩部 - 肩甲
    Back,           // 背部 - 披风
    Chest,          // 胸部 - 胸甲
    Wrist,          // 手腕 - 护腕
    Hands,          // 手部 - 手套
    Waist,          // 腰部 - 腰带
    Legs,           // 腿部 - 腿甲
    Feet,           // 脚部 - 鞋子
    
    // ===== 饰品槽位 (4个) =====
    Finger1,        // 第一个戒指
    Finger2,        // 第二个戒指
    Trinket1,       // 第一个饰品
    Trinket2,       // 第二个饰品
    
    // ===== 武器槽位 (3个) =====
    MainHand,       // 主手武器
    OffHand,        // 副手武器/盾牌
    TwoHand         // 双手武器（占用MainHand+OffHand）
}
```

#### ArmorType (护甲类型)

```csharp
/// <summary>
/// 护甲类型 - 影响护甲值和职业限制
/// </summary>
public enum ArmorType
{
    None,       // 无类型（饰品、披风等）
    Cloth,      // 布甲 - 法系职业
    Leather,    // 皮甲 - 敏捷职业
    Mail,       // 锁甲 - 混合职业
    Plate       // 板甲 - 力量职业
}
```

#### WeaponType (武器类型)

```csharp
/// <summary>
/// 武器类型 - 影响攻击速度和职业限制
/// </summary>
public enum WeaponType
{
    None,           // 无类型
    
    // 单手武器
    Sword,          // 剑 - 速度：中等
    Dagger,         // 匕首 - 速度：快
    Axe,            // 斧 - 速度：中等
    Mace,           // 锤 - 速度：慢
    Fist,           // 拳套 - 速度：很快
    Wand,           // 魔杖 - 速度：很快（法系）
    
    // 双手武器
    TwoHandSword,   // 双手剑 - 速度：慢
    TwoHandAxe,     // 双手斧 - 速度：很慢
    TwoHandMace,    // 双手锤 - 速度：很慢
    Staff,          // 法杖 - 速度：慢（法系）
    Polearm,        // 长柄武器 - 速度：慢
    
    // 远程武器
    Bow,            // 弓 - 速度：中等
    Crossbow,       // 弩 - 速度：慢
    Gun,            // 枪 - 速度：快
    
    // 副手专用
    Shield          // 盾牌 - 提供格挡
}
```

### 5.3 配置类模型

#### ArmorTypeConfig

```csharp
/// <summary>
/// 护甲类型配置
/// </summary>
public class ArmorTypeConfig
{
    public ArmorType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    
    /// <summary>基础护甲倍率</summary>
    public double BaseArmorMultiplier { get; set; }
    
    /// <summary>耐力加成倍率</summary>
    public double StaminaMultiplier { get; set; }
    
    /// <summary>次级属性权重</summary>
    public Dictionary<string, double> SecondaryStatWeights { get; set; }
    
    /// <summary>可装备的槽位</summary>
    public List<EquipmentSlot> ApplicableSlots { get; set; }
}
```

#### WeaponTypeConfig

```csharp
/// <summary>
/// 武器类型配置
/// </summary>
public class WeaponTypeConfig
{
    public WeaponType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    
    /// <summary>基础攻击速度（秒/次）</summary>
    public double BaseAttackSpeed { get; set; }
    
    /// <summary>攻击倍率</summary>
    public double AttackPowerMultiplier { get; set; }
    
    /// <summary>允许的槽位</summary>
    public List<EquipmentSlot> AllowedSlots { get; set; }
    
    /// <summary>伤害类型倾向</summary>
    public string DamageTypeBias { get; set; } // "Physical", "Magical"
    
    /// <summary>是否双手武器</summary>
    public bool IsTwoHanded { get; set; }
}
```

#### ProfessionEquipmentConfig

```csharp
/// <summary>
/// 职业装备限制配置
/// </summary>
public class ProfessionEquipmentConfig
{
    public string ProfessionId { get; set; } // "Warrior", "Mage", etc.
    public List<ArmorType> AllowedArmorTypes { get; set; }
    public List<WeaponType> AllowedWeaponTypes { get; set; }
    public bool CanDualWield { get; set; } // 是否可双持
    public bool CanUseShields { get; set; } // 是否可用盾牌
}
```

### 5.4 数据库表结构

#### GearDefinitions 表

```sql
CREATE TABLE gear_definitions (
    id VARCHAR(100) PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    icon VARCHAR(50),
    slot VARCHAR(50) NOT NULL,
    required_level INT NOT NULL DEFAULT 1,
    base_stats_json TEXT,
    allowed_affix_pool_json TEXT,
    rarity_weights_json TEXT,
    set_id VARCHAR(100),
    
    -- 新增字段
    armor_type VARCHAR(50) NOT NULL DEFAULT 'None',
    weapon_type VARCHAR(50) NOT NULL DEFAULT 'None',
    base_armor DOUBLE PRECISION DEFAULT 0,
    base_attack_speed DOUBLE PRECISION DEFAULT 0,
    attack_power_multiplier DOUBLE PRECISION DEFAULT 1.0,
    block_chance DOUBLE PRECISION DEFAULT 0,
    block_reduction DOUBLE PRECISION DEFAULT 0,
    allowed_professions_json TEXT,
    is_two_handed BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_gear_def_slot ON gear_definitions(slot);
CREATE INDEX idx_gear_def_armor_type ON gear_definitions(armor_type);
CREATE INDEX idx_gear_def_weapon_type ON gear_definitions(weapon_type);
```

#### GearInstances 表

```sql
CREATE TABLE gear_instances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    definition_id VARCHAR(100) NOT NULL REFERENCES gear_definitions(id),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    rarity VARCHAR(50) NOT NULL,
    tier INT NOT NULL DEFAULT 1,
    item_level INT NOT NULL,
    rolled_stats_json TEXT NOT NULL,
    affix_instances_json TEXT,
    quality_score INT NOT NULL,
    is_equipped BOOLEAN DEFAULT FALSE,
    current_slot VARCHAR(50),
    is_bound BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_gear_inst_char ON gear_instances(character_id);
CREATE INDEX idx_gear_inst_def ON gear_instances(definition_id);
CREATE INDEX idx_gear_inst_equipped ON gear_instances(character_id, is_equipped);
CREATE INDEX idx_gear_inst_slot ON gear_instances(character_id, current_slot) WHERE is_equipped = TRUE;
```

#### AffixDefinitions 表

```sql
CREATE TABLE affix_definitions (
    id VARCHAR(100) PRIMARY KEY,
    name_template VARCHAR(200) NOT NULL,
    stat_type VARCHAR(50) NOT NULL,
    modifier_type VARCHAR(50) NOT NULL,
    min_value DOUBLE PRECISION NOT NULL,
    max_value DOUBLE PRECISION NOT NULL,
    affix_tier INT NOT NULL DEFAULT 1,
    weight DOUBLE PRECISION NOT NULL DEFAULT 1.0,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_affix_stat_type ON affix_definitions(stat_type);
CREATE INDEX idx_affix_tier ON affix_definitions(affix_tier);
```

#### GearSets 表

```sql
CREATE TABLE gear_sets (
    id VARCHAR(100) PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    bonuses_json TEXT NOT NULL,
    icon VARCHAR(50),
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

---

## Phase 1: 数据库与领域模型基础 (第1-2周)

### 阶段目标

建立装备系统的数据基础和领域模型，包括数据库表、实体类、配置类和种子数据。

### 详细任务清单

#### Task 1.1: 创建枚举和基础类型 ✅

**优先级**: 🔴 高  
**预计时间**: 2小时  
**依赖**: 无

**实施步骤**:

1. 创建 `BlazorIdle.Server/Domain/Equipment/Enums/` 目录

2. 创建 `EquipmentSlot.cs` (17个槽位)
```csharp
namespace BlazorIdle.Server.Domain.Equipment.Enums;

/// <summary>装备槽位枚举 - 完整17槽位系统</summary>
public enum EquipmentSlot
{
    // 防具槽位 (10个)
    Head, Neck, Shoulder, Back, Chest,
    Wrist, Hands, Waist, Legs, Feet,
    
    // 饰品槽位 (4个)
    Finger1, Finger2, Trinket1, Trinket2,
    
    // 武器槽位 (3个)
    MainHand, OffHand, TwoHand
}
```

3. 创建 `ArmorType.cs`
```csharp
/// <summary>护甲类型</summary>
public enum ArmorType
{
    None, Cloth, Leather, Mail, Plate
}
```

4. 创建 `WeaponType.cs` (15种武器)
```csharp
/// <summary>武器类型</summary>
public enum WeaponType
{
    None,
    // 单手
    Sword, Dagger, Axe, Mace, Fist, Wand,
    // 双手
    TwoHandSword, TwoHandAxe, TwoHandMace, Staff, Polearm,
    // 远程
    Bow, Crossbow, Gun,
    // 副手专用
    Shield
}
```

5. 创建 `Rarity.cs`
```csharp
/// <summary>稀有度</summary>
public enum Rarity
{
    Common,     // 普通 - 白色
    Rare,       // 稀有 - 蓝色
    Epic,       // 史诗 - 紫色
    Legendary   // 传说 - 橙色
}
```

6. 创建 `ModifierType.cs`
```csharp
/// <summary>修饰符类型</summary>
public enum ModifierType
{
    Additive,       // 加法
    Multiplicative, // 乘法
    FinalAdd        // 最终加法
}
```

7. 创建 `SlotCategory.cs`
```csharp
/// <summary>槽位分类</summary>
public enum SlotCategory
{
    Armor,    // 防具
    Jewelry,  // 饰品
    Weapon    // 武器
}
```

**前端验证点**: 无（纯后端枚举）

**验收标准**:
- ✅ 所有枚举定义完整
- ✅ 使用 XML 文档注释
- ✅ 编译通过无警告

---

#### Task 1.2: 创建配置类 ✅

**优先级**: 🔴 高  
**预计时间**: 4小时  
**依赖**: Task 1.1

**实施步骤**:

1. 创建 `BlazorIdle.Server/Domain/Equipment/Models/` 目录

2. 创建 `ArmorTypeConfig.cs`
```csharp
namespace BlazorIdle.Server.Domain.Equipment.Models;

/// <summary>护甲类型配置</summary>
public class ArmorTypeConfig
{
    public ArmorType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    public double BaseArmorMultiplier { get; set; }
    public double StaminaMultiplier { get; set; }
    public Dictionary<string, double> SecondaryStatWeights { get; set; } = new();
    public List<EquipmentSlot> ApplicableSlots { get; set; } = new();
}
```

3. 创建 `WeaponTypeConfig.cs`
```csharp
/// <summary>武器类型配置</summary>
public class WeaponTypeConfig
{
    public WeaponType Type { get; set; }
    public string TypeId { get; set; }
    public string DisplayName { get; set; }
    public double BaseAttackSpeed { get; set; }
    public double AttackPowerMultiplier { get; set; }
    public List<EquipmentSlot> AllowedSlots { get; set; } = new();
    public string DamageTypeBias { get; set; } = "Physical";
    public bool IsTwoHanded { get; set; }
}
```

4. 创建 `EquipmentSlotConfig.cs`
```csharp
/// <summary>装备槽位配置</summary>
public class EquipmentSlotConfig
{
    public EquipmentSlot Slot { get; set; }
    public string SlotId { get; set; }
    public string DisplayName { get; set; }
    public string Icon { get; set; }
    public SlotCategory Category { get; set; }
    public bool AllowsArmorType { get; set; }
    public bool RequiresWeaponType { get; set; }
}
```

5. 创建 `ProfessionEquipmentConfig.cs`
```csharp
/// <summary>职业装备限制配置</summary>
public class ProfessionEquipmentConfig
{
    public string ProfessionId { get; set; }
    public List<ArmorType> AllowedArmorTypes { get; set; } = new();
    public List<WeaponType> AllowedWeaponTypes { get; set; } = new();
    public bool CanDualWield { get; set; }
    public bool CanUseShields { get; set; }
}
```

6. 创建 `EquipmentSystemConfiguration.cs` (主配置类)
```csharp
/// <summary>装备系统主配置类</summary>
public class EquipmentSystemConfiguration
{
    public List<ArmorTypeConfig> ArmorTypes { get; set; } = new();
    public List<WeaponTypeConfig> WeaponTypes { get; set; } = new();
    public List<EquipmentSlotConfig> Slots { get; set; } = new();
    public List<ProfessionEquipmentConfig> ProfessionRestrictions { get; set; } = new();
    
    // 战斗机制配置
    public double ArmorDamageReductionBase { get; set; } = 0.06;
    public double MaxArmorDamageReduction { get; set; } = 0.75;
    public double DefaultBlockReduction { get; set; } = 0.30;
}
```

**前端验证点**: 无（纯后端配置类）

**验收标准**:
- ✅ 所有配置类定义完整
- ✅ 使用 XML 文档注释
- ✅ 提供合理的默认值
- ✅ 支持 JSON 序列化/反序列化

---

#### Task 1.3: 创建JSON配置文件 ✅

**优先级**: 🔴 高  
**预计时间**: 3小时  
**依赖**: Task 1.2

**实施步骤**:

1. 创建 `BlazorIdle.Server/Configuration/EquipmentSystemConfig.json`

2. 定义护甲类型配置
```json
{
  "ArmorTypes": [
    {
      "Type": "Cloth",
      "TypeId": "cloth",
      "DisplayName": "布甲",
      "BaseArmorMultiplier": 0.5,
      "StaminaMultiplier": 0.8,
      "SecondaryStatWeights": {
        "Intellect": 1.5,
        "SpellPower": 1.2
      },
      "ApplicableSlots": ["Head", "Shoulder", "Chest", "Wrist", "Hands", "Waist", "Legs", "Feet"]
    },
    {
      "Type": "Leather",
      "TypeId": "leather",
      "DisplayName": "皮甲",
      "BaseArmorMultiplier": 1.0,
      "StaminaMultiplier": 1.0,
      "SecondaryStatWeights": {
        "Agility": 1.5,
        "Dodge": 0.03
      },
      "ApplicableSlots": ["Head", "Shoulder", "Chest", "Wrist", "Hands", "Waist", "Legs", "Feet"]
    },
    {
      "Type": "Mail",
      "TypeId": "mail",
      "DisplayName": "锁甲",
      "BaseArmorMultiplier": 1.5,
      "StaminaMultiplier": 1.2,
      "SecondaryStatWeights": {
        "Agility": 1.0,
        "Intellect": 1.0
      },
      "ApplicableSlots": ["Head", "Shoulder", "Chest", "Wrist", "Hands", "Waist", "Legs", "Feet"]
    },
    {
      "Type": "Plate",
      "TypeId": "plate",
      "DisplayName": "板甲",
      "BaseArmorMultiplier": 2.0,
      "StaminaMultiplier": 1.5,
      "SecondaryStatWeights": {
        "Strength": 1.5,
        "Stamina": 1.2
      },
      "ApplicableSlots": ["Head", "Shoulder", "Chest", "Wrist", "Hands", "Waist", "Legs", "Feet"]
    }
  ],
  
  "WeaponTypes": [
    {
      "Type": "Sword",
      "TypeId": "sword",
      "DisplayName": "剑",
      "BaseAttackSpeed": 2.0,
      "AttackPowerMultiplier": 1.0,
      "AllowedSlots": ["MainHand", "OffHand"],
      "DamageTypeBias": "Physical",
      "IsTwoHanded": false
    },
    {
      "Type": "Dagger",
      "TypeId": "dagger",
      "DisplayName": "匕首",
      "BaseAttackSpeed": 1.5,
      "AttackPowerMultiplier": 0.8,
      "AllowedSlots": ["MainHand", "OffHand"],
      "DamageTypeBias": "Physical",
      "IsTwoHanded": false
    },
    {
      "Type": "TwoHandSword",
      "TypeId": "two_hand_sword",
      "DisplayName": "双手剑",
      "BaseAttackSpeed": 3.0,
      "AttackPowerMultiplier": 2.0,
      "AllowedSlots": ["TwoHand"],
      "DamageTypeBias": "Physical",
      "IsTwoHanded": true
    },
    {
      "Type": "Shield",
      "TypeId": "shield",
      "DisplayName": "盾牌",
      "BaseAttackSpeed": 0,
      "AttackPowerMultiplier": 0,
      "AllowedSlots": ["OffHand"],
      "DamageTypeBias": "Physical",
      "IsTwoHanded": false
    }
    // ... 其他武器类型
  ],
  
  "ProfessionRestrictions": [
    {
      "ProfessionId": "Warrior",
      "AllowedArmorTypes": ["Leather", "Mail", "Plate"],
      "AllowedWeaponTypes": ["Sword", "Axe", "Mace", "TwoHandSword", "TwoHandAxe", "TwoHandMace", "Polearm", "Shield"],
      "CanDualWield": true,
      "CanUseShields": true
    },
    {
      "ProfessionId": "Mage",
      "AllowedArmorTypes": ["Cloth"],
      "AllowedWeaponTypes": ["Staff", "Wand"],
      "CanDualWield": false,
      "CanUseShields": false
    }
    // ... 其他职业
  ]
}
```

3. 更新 `appsettings.json` 添加配置路径
```json
{
  "EquipmentSystem": {
    "ConfigurationFile": "Configuration/EquipmentSystemConfig.json"
  }
}
```

**前端验证点**: 无（纯配置文件）

**验收标准**:
- ✅ JSON格式正确，可正常解析
- ✅ 所有护甲类型配置完整
- ✅ 所有武器类型配置完整（至少5种）
- ✅ 所有职业限制配置完整（至少2个职业）

---

*(继续后续Task...由于篇幅限制，完整的Phase 1-3内容将在文档中继续)*

### Phase 1 验收总结

**完成标准**:
- ✅ 所有枚举、配置类、数据库表创建完成
- ✅ 种子数据正确加载
- ✅ 配置服务可正常加载JSON配置
- ✅ 单元测试覆盖率 ≥ 90%
- ✅ 数据库迁移成功执行

**前端验证**:
- 暂无（Phase 1纯后端基础设施）

**下一步**:
- 进入Phase 2: 装备生成与掉落系统

---

*（上篇到此结束，中篇将继续Phase 2-3的详细实施步骤和前端验证）*

**文档版本**: 2.0  
**最后更新**: 2025-10-11  
**维护团队**: BlazorIdle开发团队  

---

### 相关文档

- **中篇**: [装备系统完整优化方案-中篇.md](装备系统完整优化方案-中篇.md)
- **下篇**: [装备系统完整优化方案-下篇.md](装备系统完整优化方案-下篇.md)
- **参考**: [整合设计总结.txt](整合设计总结.txt)
