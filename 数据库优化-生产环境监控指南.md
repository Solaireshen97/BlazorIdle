# æ•°æ®åº“ä¼˜åŒ– - ç”Ÿäº§ç¯å¢ƒç›‘æ§æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-18  
**çŠ¶æ€**: ç”Ÿäº§ç¯å¢ƒç›‘æ§æŒ‡å—  
**é€‚ç”¨èŒƒå›´**: Phase 2 å®Œæˆåçš„ç”Ÿäº§ç¯å¢ƒç›‘æ§

---

## ğŸ“‹ ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [å…³é”®ç›‘æ§æŒ‡æ ‡](#å…³é”®ç›‘æ§æŒ‡æ ‡)
3. [ç›‘æ§æ–¹æ³•](#ç›‘æ§æ–¹æ³•)
4. [é¢„æœŸæ€§èƒ½åŸºçº¿](#é¢„æœŸæ€§èƒ½åŸºçº¿)
5. [å¼‚å¸¸æ£€æµ‹](#å¼‚å¸¸æ£€æµ‹)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
7. [æ€§èƒ½è°ƒä¼˜](#æ€§èƒ½è°ƒä¼˜)

---

## æ‰§è¡Œæ‘˜è¦

### å½“å‰çŠ¶æ€
âœ… **Phase 1 & 2 å·²å®Œæˆ**  
âœ… **å†…å­˜ç¼“å†²å·²å¯ç”¨** (`EnableMemoryBuffering: true`)  
âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡** (14/14)  

### ç›‘æ§ç›®æ ‡
- éªŒè¯97.9%çš„æ•°æ®åº“å†™å…¥å‡å°‘æ˜¯å¦å®ç°
- ç¡®è®¤ç³»ç»Ÿç¨³å®šæ€§å’Œæ€§èƒ½æ”¹å–„
- è¯†åˆ«å¹¶è§£å†³ä»»ä½•å¼‚å¸¸æƒ…å†µ
- æ”¶é›†æ•°æ®ç”¨äºè¿›ä¸€æ­¥ä¼˜åŒ–

---

## å…³é”®ç›‘æ§æŒ‡æ ‡

### 1. æ•°æ®åº“å†™å…¥é¢‘ç‡

**é‡è¦æ€§**: â­â­â­â­â­ æœ€å…³é”®æŒ‡æ ‡

**ç›‘æ§æ–¹æ³•**:
```bash
# æ–¹æ³• 1: ç›‘æ§ WAL æ–‡ä»¶å¤§å°å˜åŒ–
watch -n 5 'ls -lh /path/to/gamedata.db-wal'

# æ–¹æ³• 2: ä½¿ç”¨ SQLite å†…ç½®å·¥å…·
sqlite3 gamedata.db "PRAGMA wal_checkpoint(PASSIVE);"
```

**é¢„æœŸå€¼**:
- ä¼˜åŒ–å‰: WAL æ–‡ä»¶æ¯åˆ†é’Ÿå¢é•¿ ~30-50KB
- ä¼˜åŒ–å: WAL æ–‡ä»¶æ¯åˆ†é’Ÿå¢é•¿ <2KB
- **æ”¹å–„: 95%+**

**å‘Šè­¦é˜ˆå€¼**:
- âš ï¸ WARNING: WAL å¢é•¿é€Ÿåº¦ >10KB/min
- ğŸš¨ CRITICAL: WAL å¢é•¿é€Ÿåº¦ >20KB/min

---

### 2. å†…å­˜ä½¿ç”¨æƒ…å†µ

**é‡è¦æ€§**: â­â­â­â­

**ç›‘æ§æ–¹æ³•**:
```bash
# ç›‘æ§è¿›ç¨‹å†…å­˜ä½¿ç”¨
watch -n 10 'ps aux | grep BlazorIdle.Server | grep -v grep'

# æˆ–ä½¿ç”¨ dotnet-counters
dotnet-counters monitor --process-id <pid> System.Runtime
```

**é¢„æœŸå€¼**:
- ä¼˜åŒ–å‰: ~200-300MB
- ä¼˜åŒ–å: ~250-400MB
- **å¢é•¿: +50-150MB (å¯æ¥å—)**

**å‘Šè­¦é˜ˆå€¼**:
- âš ï¸ WARNING: å†…å­˜ä½¿ç”¨ >500MB
- ğŸš¨ CRITICAL: å†…å­˜ä½¿ç”¨ >800MB æˆ–æŒç»­å¢é•¿

**å…³é”®å­æŒ‡æ ‡**:
- GC Heap Size: åº”ä¿æŒç¨³å®š
- GC Frequency: ä¸åº”æ˜¾è‘—å¢åŠ 
- Gen 2 Collections: åº”ä¿æŒä½é¢‘

---

### 3. API å“åº”æ—¶é—´

**é‡è¦æ€§**: â­â­â­â­

**ç›‘æ§ç«¯ç‚¹**:
1. **å¿ƒè·³æ¥å£**: `POST /api/characters/{id}/heartbeat`
2. **æˆ˜æ–—çŠ¶æ€**: `GET /api/battles/step/{id}`
3. **æ´»åŠ¨è®¡åˆ’**: `GET /api/activities/plans`

**é¢„æœŸå€¼**:

| ç«¯ç‚¹ | ä¼˜åŒ–å‰ P95 | ä¼˜åŒ–å P95 | æ”¹å–„ |
|------|-----------|-----------|------|
| Heartbeat | ~150-300ms | <100ms | 40-60% |
| Battle Status | ~100-200ms | <80ms | 30-40% |
| Activity Plans | ~80-150ms | <60ms | 25-40% |

**ç›‘æ§æ–¹æ³•**:
```bash
# ä½¿ç”¨ Apache Bench è¿›è¡Œç®€å•æµ‹è¯•
ab -n 100 -c 10 http://localhost:5000/api/characters/{id}/heartbeat

# æˆ–ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬è®°å½•å“åº”æ—¶é—´
```

**å‘Šè­¦é˜ˆå€¼**:
- âš ï¸ WARNING: P95 å“åº”æ—¶é—´å›å‡åˆ°ä¼˜åŒ–å‰æ°´å¹³
- ğŸš¨ CRITICAL: P95 å“åº”æ—¶é—´è¶…è¿‡ä¼˜åŒ–å‰æ°´å¹³ 20%

---

### 4. æŒä¹…åŒ–åè°ƒå™¨ç»Ÿè®¡

**é‡è¦æ€§**: â­â­â­â­â­

**ç›‘æ§æ–¹æ³•**:
æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„ PersistenceCoordinator è¾“å‡ºï¼š

```bash
# å®æ—¶æŸ¥çœ‹ä¿å­˜ç»Ÿè®¡
tail -f /path/to/logs/app.log | grep "PersistenceCoordinator"
```

**é¢„æœŸæ—¥å¿—è¾“å‡º**:
```
[INFO] æŒä¹…åŒ–åè°ƒå™¨å·²å¯åŠ¨ï¼Œä¿å­˜é—´éš”ï¼š30000ms
[INFO] å¼€å§‹æ‰¹é‡ä¿å­˜ï¼šCharacters(5), BattleSnapshots(3), ActivityPlans(2)
[INFO] æ‰¹é‡ä¿å­˜å®Œæˆï¼Œè€—æ—¶ï¼š45msï¼ŒæˆåŠŸï¼š10ï¼Œå¤±è´¥ï¼š0
[INFO] ç»Ÿè®¡ä¿¡æ¯ï¼š
  - æ€»dirtyå®ä½“ï¼š10
  - Characters: 5 ä¸ª (ä¿å­˜é—´éš”ï¼š300000ms)
  - BattleSnapshots: 3 ä¸ª (ä¿å­˜é—´éš”ï¼š60000ms)
  - ActivityPlans: 2 ä¸ª (ä¿å­˜é—´éš”ï¼š30000ms)
```

**å…³é”®æŒ‡æ ‡**:
- æ‰¹é‡ä¿å­˜é¢‘ç‡: æ¯30-60ç§’ä¸€æ¬¡
- æ¯æ‰¹å®ä½“æ•°: é€šå¸¸ 5-20 ä¸ª
- ä¿å­˜è€—æ—¶: <100ms
- å¤±è´¥ç‡: 0%

**å‘Šè­¦é˜ˆå€¼**:
- âš ï¸ WARNING: ä¿å­˜è€—æ—¶ >200ms
- âš ï¸ WARNING: å•æ‰¹å®ä½“æ•° >100 (å¯èƒ½æœ‰å†…å­˜æ³„æ¼)
- ğŸš¨ CRITICAL: ä¿å­˜å¤±è´¥ç‡ >1%
- ğŸš¨ CRITICAL: ä¿å­˜è€—æ—¶ >500ms

---

### 5. Dirty å®ä½“è®¡æ•°

**é‡è¦æ€§**: â­â­â­

**ç›‘æ§æ–¹æ³•**:
é€šè¿‡æ—¥å¿—æˆ–è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š

```csharp
// å¯é€‰ï¼šæ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹
[HttpGet("health/memory-state")]
public IActionResult GetMemoryState()
{
    var characterManager = _serviceProvider.GetService<IMemoryStateManager<Character>>();
    var snapshotManager = _serviceProvider.GetService<IMemoryStateManager<RunningBattleSnapshotRecord>>();
    var planManager = _serviceProvider.GetService<IMemoryStateManager<ActivityPlan>>();
    
    return Ok(new {
        characters = new { total = characterManager?.Count, dirty = characterManager?.DirtyCount },
        snapshots = new { total = snapshotManager?.Count, dirty = snapshotManager?.DirtyCount },
        plans = new { total = planManager?.Count, dirty = planManager?.DirtyCount }
    });
}
```

**é¢„æœŸå€¼**:
- Characters Dirty: é€šå¸¸ 5-20 (æ´»è·ƒç©å®¶æ•°)
- BattleSnapshots Dirty: é€šå¸¸ 5-15 (å¹¶å‘æˆ˜æ–—æ•°)
- ActivityPlans Dirty: é€šå¸¸ 2-10

**å‘Šè­¦é˜ˆå€¼**:
- âš ï¸ WARNING: ä»»ä¸€ç±»å‹ Dirty å®ä½“ >100
- ğŸš¨ CRITICAL: ä»»ä¸€ç±»å‹ Dirty å®ä½“ >500 æˆ–æŒç»­å¢é•¿

---

### 6. æœåŠ¡å™¨å…³é—­è¡Œä¸º

**é‡è¦æ€§**: â­â­â­â­â­

**éªŒè¯æ–¹æ³•**:
å®šæœŸæ‰§è¡Œä¼˜é›…å…³é—­æµ‹è¯•ï¼ˆæ¯å‘¨ä¸€æ¬¡ï¼‰ï¼š

```bash
# 1. å¯åŠ¨æœåŠ¡å™¨å¹¶æ¨¡æ‹Ÿç”¨æˆ·æ´»åŠ¨
dotnet run --project BlazorIdle.Server

# 2. å‘é€ SIGTERM ä¿¡å·ï¼ˆä¼˜é›…å…³é—­ï¼‰
kill -TERM <pid>

# 3. è§‚å¯Ÿæ—¥å¿—è¾“å‡º
```

**é¢„æœŸæ—¥å¿—**:
```
[INFO] æ”¶åˆ°å…³é—­ä¿¡å·...
[INFO] EnhancedShutdownManager å¼€å§‹æ‰§è¡Œ...
[INFO] æŒä¹…åŒ–åè°ƒå™¨è§¦å‘æœ€ç»ˆä¿å­˜...
[INFO] æ‰¹é‡ä¿å­˜ï¼šCharacters(12), BattleSnapshots(5), ActivityPlans(3)
[INFO] æ‰¹é‡ä¿å­˜å®Œæˆï¼Œè€—æ—¶ï¼š78ms
[INFO] å·²å°† 12 ä¸ªåœ¨çº¿è§’è‰²è®¾ç½®ä¸ºç¦»çº¿
[INFO] å¼ºåˆ¶æ‰§è¡Œ WAL æ£€æŸ¥ç‚¹...
[INFO] WAL æ£€æŸ¥ç‚¹å®Œæˆ
[INFO] ä¼˜é›…å…³é—­å®Œæˆï¼Œæ€»è€—æ—¶ï¼š2.3ç§’
```

**éªŒè¯ç‚¹**:
- âœ… æ‰€æœ‰ Dirty å®ä½“å·²ä¿å­˜
- âœ… æ‰€æœ‰åœ¨çº¿è§’è‰² `IsOnline = false`
- âœ… WAL æ£€æŸ¥ç‚¹å·²æ‰§è¡Œ
- âœ… æ€»è€—æ—¶ <30ç§’

**å‘Šè­¦**:
- ğŸš¨ CRITICAL: å…³é—­è¶…æ—¶ï¼ˆ>30ç§’ï¼‰
- ğŸš¨ CRITICAL: æœ‰è§’è‰²ä»æ˜¾ç¤ºåœ¨çº¿
- ğŸš¨ CRITICAL: æœ‰æ•°æ®æœªä¿å­˜

---

## ç›‘æ§æ–¹æ³•

### æ–¹æ³• 1: æ—¥å¿—ç›‘æ§ï¼ˆæ¨èï¼‰

**é…ç½®æ—¥å¿—çº§åˆ«**:
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "BlazorIdle.Server.Infrastructure.DatabaseOptimization": "Information",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  }
}
```

**å®æ—¶ç›‘æ§å‘½ä»¤**:
```bash
# ç›‘æ§æ‰€æœ‰æ•°æ®åº“ä¼˜åŒ–ç›¸å…³æ—¥å¿—
tail -f logs/app.log | grep -E "MemoryStateManager|PersistenceCoordinator|EnhancedShutdownManager"

# ç›‘æ§æ‰¹é‡ä¿å­˜äº‹ä»¶
tail -f logs/app.log | grep "æ‰¹é‡ä¿å­˜"

# ç›‘æ§é”™è¯¯å’Œè­¦å‘Š
tail -f logs/app.log | grep -E "WARNING|ERROR|CRITICAL"
```

---

### æ–¹æ³• 2: SQLite æŸ¥è¯¢ç›‘æ§

**æ•°æ®åº“å†™å…¥é¢‘ç‡**:
```sql
-- æŸ¥çœ‹æœ€è¿‘æ›´æ–°æ—¶é—´
SELECT 
    'Characters' as Table,
    COUNT(*) as TotalRows,
    MAX(LastSeenAtUtc) as LastUpdate
FROM Characters
UNION ALL
SELECT 
    'RunningBattleSnapshots',
    COUNT(*),
    MAX(UpdatedAtUtc)
FROM RunningBattleSnapshots
UNION ALL
SELECT 
    'ActivityPlans',
    COUNT(*),
    MAX(UpdatedAt)
FROM ActivityPlans;
```

**æ£€æŸ¥ç¦»çº¿çŠ¶æ€**:
```sql
-- éªŒè¯å…³é—­åæ‰€æœ‰è§’è‰²ç¦»çº¿
SELECT Id, Name, IsOnline, LastSeenAtUtc
FROM Characters
WHERE IsOnline = 1;
-- åº”è¿”å› 0 è¡Œï¼ˆå…³é—­åï¼‰
```

---

### æ–¹æ³• 3: æ€§èƒ½è®¡æ•°å™¨ï¼ˆé«˜çº§ï¼‰

å¦‚æœéœ€è¦æ›´è¯¦ç»†çš„ç›‘æ§ï¼Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰æ€§èƒ½è®¡æ•°å™¨ï¼š

```csharp
// åœ¨ PersistenceCoordinator ä¸­æ·»åŠ 
private static readonly Counter SaveOperationsCounter = 
    Metrics.CreateCounter("db_save_operations_total", "Total database save operations");
    
private static readonly Histogram SaveDurationHistogram = 
    Metrics.CreateHistogram("db_save_duration_seconds", "Database save operation duration");

private static readonly Gauge DirtyEntitiesGauge = 
    Metrics.CreateGauge("memory_dirty_entities", "Number of dirty entities in memory");
```

ç„¶åä½¿ç”¨ Prometheus + Grafana è¿›è¡Œå¯è§†åŒ–ç›‘æ§ã€‚

---

## é¢„æœŸæ€§èƒ½åŸºçº¿

### å…¸å‹è´Ÿè½½åœºæ™¯

**åœºæ™¯ 1: ä½è´Ÿè½½ï¼ˆ10-20åœ¨çº¿ç©å®¶ï¼‰**
- æ•°æ®åº“å†™å…¥: ~200-400æ¬¡/å°æ—¶
- å†…å­˜ä½¿ç”¨: ~250-300MB
- API P95å»¶è¿Ÿ: <50ms
- æ‰¹é‡ä¿å­˜é¢‘ç‡: æ¯30-60ç§’

**åœºæ™¯ 2: ä¸­è´Ÿè½½ï¼ˆ50-100åœ¨çº¿ç©å®¶ï¼‰**
- æ•°æ®åº“å†™å…¥: ~800-1,500æ¬¡/å°æ—¶
- å†…å­˜ä½¿ç”¨: ~300-400MB
- API P95å»¶è¿Ÿ: <80ms
- æ‰¹é‡ä¿å­˜é¢‘ç‡: æ¯30ç§’

**åœºæ™¯ 3: é«˜è´Ÿè½½ï¼ˆ100-200åœ¨çº¿ç©å®¶ï¼‰**
- æ•°æ®åº“å†™å…¥: ~1,500-3,000æ¬¡/å°æ—¶
- å†…å­˜ä½¿ç”¨: ~400-500MB
- API P95å»¶è¿Ÿ: <100ms
- æ‰¹é‡ä¿å­˜é¢‘ç‡: æ¯30ç§’

---

## å¼‚å¸¸æ£€æµ‹

### å¼‚å¸¸ç±»å‹ 1: å†…å­˜æŒç»­å¢é•¿

**ç—‡çŠ¶**:
- å†…å­˜ä½¿ç”¨æŒç»­ä¸Šå‡ï¼Œä¸å›è½
- GC é¢‘ç‡å¢åŠ ä½†å†…å­˜ä¸é‡Šæ”¾

**å¯èƒ½åŸå› **:
1. ç¼“å­˜å®ä½“è¿‡å¤šï¼Œæœªæ­£å¸¸æ¸…ç†
2. LRU æ¸…ç†ç­–ç•¥æœªç”Ÿæ•ˆ
3. äº‹ä»¶è®¢é˜…æœªå–æ¶ˆå¯¼è‡´å†…å­˜æ³„æ¼

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ç¼“å­˜å®ä½“æ•°é‡
curl http://localhost:5000/health/memory-state

# 2. æŸ¥çœ‹æ—¥å¿—ä¸­çš„ LRU æ¸…ç†äº‹ä»¶
grep "LRUæ¸…ç†" logs/app.log | tail -20

# 3. æ£€æŸ¥ MaxCachedEntities é…ç½®
grep -A 3 "MemoryCache" appsettings.json
```

**è§£å†³æ–¹æ¡ˆ**:
- é™ä½ `MaxCachedEntities` å€¼
- æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸å¤§é‡çš„å®ä½“ç¼“å­˜
- é‡å¯æœåŠ¡å™¨é‡Šæ”¾å†…å­˜

---

### å¼‚å¸¸ç±»å‹ 2: ä¿å­˜å¤±è´¥

**ç—‡çŠ¶**:
- æ—¥å¿—ä¸­å‡ºç°"ä¿å­˜å¤±è´¥"é”™è¯¯
- Dirty å®ä½“æ•°æŒç»­å¢åŠ 

**å¯èƒ½åŸå› **:
1. æ•°æ®åº“é”å®š
2. ç£ç›˜ç©ºé—´ä¸è¶³
3. æ•°æ®éªŒè¯å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep -A 10 "ä¿å­˜å¤±è´¥\|SaveChangesAsync failed" logs/app.log | tail -50

# 2. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# 3. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -l gamedata.db*

# 4. å°è¯•æ‰‹åŠ¨æ‰§è¡Œ WAL æ£€æŸ¥ç‚¹
sqlite3 gamedata.db "PRAGMA wal_checkpoint(FULL);"
```

**è§£å†³æ–¹æ¡ˆ**:
- é‡Šæ”¾ç£ç›˜ç©ºé—´
- ä¿®å¤æ•°æ®åº“æƒé™
- å¦‚æœæ˜¯æ•°æ®éªŒè¯å¤±è´¥ï¼ŒæŸ¥çœ‹å…·ä½“é”™è¯¯å¹¶ä¿®å¤æ•°æ®

---

### å¼‚å¸¸ç±»å‹ 3: API å“åº”å˜æ…¢

**ç—‡çŠ¶**:
- API å“åº”æ—¶é—´å›å‡åˆ°ä¼˜åŒ–å‰æ°´å¹³
- ç”¨æˆ·åé¦ˆæ“ä½œå»¶è¿Ÿ

**å¯èƒ½åŸå› **:
1. æ•°æ®åº“æŸ¥è¯¢æœªå‘½ä¸­ç¼“å­˜
2. Dirty å®ä½“è¿‡å¤šå¯¼è‡´ä¿å­˜è€—æ—¶
3. å…¶ä»–ç³»ç»Ÿç“¶é¢ˆï¼ˆCPUã€ç£ç›˜ I/Oï¼‰

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ Dirty å®ä½“æ•°
curl http://localhost:5000/health/memory-state

# 2. æŸ¥çœ‹æ‰¹é‡ä¿å­˜è€—æ—¶
grep "æ‰¹é‡ä¿å­˜å®Œæˆ" logs/app.log | tail -20

# 3. æ£€æŸ¥ç³»ç»Ÿèµ„æº
top
iostat -x 1 10

# 4. åˆ†ææ…¢æŸ¥è¯¢
sqlite3 gamedata.db "PRAGMA query_only = ON; EXPLAIN QUERY PLAN SELECT * FROM Characters WHERE Id = '...';"
```

**è§£å†³æ–¹æ¡ˆ**:
- å¦‚æœ Dirty å®ä½“è¿‡å¤šï¼Œè€ƒè™‘ç¼©çŸ­ä¿å­˜é—´éš”
- æ£€æŸ¥æ•°æ®åº“ç´¢å¼•æ˜¯å¦å®Œæ•´
- ä¼˜åŒ–å…¶ä»–ç³»ç»Ÿç“¶é¢ˆ

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: å¯ç”¨å†…å­˜ç¼“å†²ååŠŸèƒ½å¼‚å¸¸

**å¿«é€Ÿè¯Šæ–­**:
```bash
# æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®
grep -A 30 "Persistence" appsettings.json

# æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸æ³¨å†Œ
grep "MemoryStateManager\|PersistenceCoordinator" logs/app.log | head -10
```

**ç´§æ€¥å›æ»š**:
```json
{
  "Persistence": {
    "EnableMemoryBuffering": false  // ç«‹å³ç¦ç”¨
  }
}
```

é‡å¯æœåŠ¡å™¨åï¼Œç³»ç»Ÿæ¢å¤åˆ°ç«‹å³ä¿å­˜æ¨¡å¼ã€‚

---

### é—®é¢˜ 2: æ•°æ®ä¸¢å¤±

**ç—‡çŠ¶**:
- ç”¨æˆ·æŠ¥å‘Šæœ€è¿‘çš„è¿›åº¦ä¸¢å¤±
- æœ€åä¸€æ¬¡å¿ƒè·³æ—¶é—´å¼‚å¸¸æ—§

**å¯èƒ½åŸå› **:
1. æœåŠ¡å™¨æ„å¤–å´©æºƒï¼ˆæœªæ‰§è¡Œä¼˜é›…å…³é—­ï¼‰
2. ä¿å­˜é—´éš”è¿‡é•¿
3. ä¿å­˜å¤±è´¥æœªè¢«å‘ç°

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥æœåŠ¡å™¨å´©æºƒæ—¥å¿—
grep -i "crash\|exception\|error" logs/app.log | tail -50

# 2. æ£€æŸ¥æœ€åä¸€æ¬¡ä¿å­˜æ—¶é—´
sqlite3 gamedata.db "SELECT MAX(LastSeenAtUtc) FROM Characters;"

# 3. æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„å®ä½“
curl http://localhost:5000/health/memory-state
```

**é¢„é˜²æªæ–½**:
- ç¡®ä¿ä½¿ç”¨ systemd æˆ–ç±»ä¼¼å·¥å…·ç®¡ç†æœåŠ¡ï¼ˆè‡ªåŠ¨ä¼˜é›…å…³é—­ï¼‰
- å®šæœŸå¤‡ä»½æ•°æ®åº“
- è€ƒè™‘ç¼©çŸ­å…³é”®æ•°æ®çš„ä¿å­˜é—´éš”

---

## æ€§èƒ½è°ƒä¼˜

### è°ƒä¼˜å‚æ•° 1: SaveIntervalMs

**å½“å‰é…ç½®**:
```json
{
  "EntitySaveStrategies": {
    "BattleSnapshot": { "SaveIntervalMs": 60000 },
    "CharacterHeartbeat": { "SaveIntervalMs": 300000 },
    "ActivityPlan": { "SaveIntervalMs": 30000 }
  }
}
```

**è°ƒä¼˜å»ºè®®**:

| åœºæ™¯ | è°ƒæ•´æ–¹å‘ | æ–°å€¼æ¨è | ç†ç”± |
|------|---------|---------|------|
| æ•°æ®å®‰å…¨æ€§è¦æ±‚é«˜ | ç¼©çŸ­é—´éš” | 30s / 180s / 15s | å‡å°‘æ½œåœ¨æ•°æ®ä¸¢å¤±çª—å£ |
| æ€§èƒ½ä¼˜å…ˆ | å»¶é•¿é—´éš” | 120s / 600s / 60s | è¿›ä¸€æ­¥å‡å°‘æ•°æ®åº“å†™å…¥ |
| å†…å­˜å‹åŠ›å¤§ | ç¼©çŸ­é—´éš” | 30s / 180s / 15s | æ›´å¿«æ¸…ç† Dirty å®ä½“ |

**è°ƒæ•´æ–¹æ³•**:
1. ä¿®æ”¹ `appsettings.json`
2. é‡å¯æœåŠ¡å™¨ï¼ˆé…ç½®çƒ­é‡è½½æœªå®ç°ï¼‰
3. ç›‘æ§24å°æ—¶è§‚å¯Ÿæ•ˆæœ

---

### è°ƒä¼˜å‚æ•° 2: MaxCachedEntities

**å½“å‰é…ç½®**:
```json
{
  "MemoryCache": {
    "MaxCachedEntities": 100000
  }
}
```

**è°ƒä¼˜å»ºè®®**:

| åœºæ™¯ | æ–°å€¼ | ç†ç”± |
|------|------|------|
| å°å‹æœåŠ¡å™¨ï¼ˆ<50ç©å®¶ï¼‰ | 10,000 | èŠ‚çœå†…å­˜ |
| ä¸­å‹æœåŠ¡å™¨ï¼ˆ50-200ç©å®¶ï¼‰ | 50,000 | å¹³è¡¡å†…å­˜å’Œæ€§èƒ½ |
| å¤§å‹æœåŠ¡å™¨ï¼ˆ>200ç©å®¶ï¼‰ | 100,000+ | ç¡®ä¿ç¼“å­˜å‘½ä¸­ç‡ |

---

### è°ƒä¼˜å‚æ•° 3: MaxBatchSize

**å½“å‰é…ç½®**:
```json
{
  "Persistence": {
    "MaxBatchSize": 1000
  }
}
```

**è°ƒä¼˜å»ºè®®**:
- å¦‚æœæ‰¹é‡ä¿å­˜è€—æ—¶è¿‡é•¿ï¼ˆ>200msï¼‰ï¼Œé™ä½åˆ° 500
- å¦‚æœä¿å­˜é¢‘ç‡è¿‡é«˜ï¼Œæé«˜åˆ° 2000
- é€šå¸¸ä¸éœ€è¦è°ƒæ•´

---

## æ€»ç»“

### ç›‘æ§æ¸…å•

**æ¯æ—¥æ£€æŸ¥** âœ…
- [ ] æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼ˆä»»ä½• ERROR/CRITICAL çº§åˆ«ï¼‰
- [ ] éªŒè¯ API å“åº”æ—¶é—´æ­£å¸¸
- [ ] æ£€æŸ¥å†…å­˜ä½¿ç”¨è¶‹åŠ¿

**æ¯å‘¨æ£€æŸ¥** âœ…
- [ ] æ‰§è¡Œä¼˜é›…å…³é—­æµ‹è¯•
- [ ] åˆ†ææ•°æ®åº“å†™å…¥é¢‘ç‡è¶‹åŠ¿
- [ ] æŸ¥çœ‹æ‰¹é‡ä¿å­˜ç»Ÿè®¡ï¼ˆæˆåŠŸç‡ã€è€—æ—¶ï¼‰
- [ ] æ£€æŸ¥ Dirty å®ä½“æ•°é‡åˆ†å¸ƒ

**æ¯æœˆæ£€æŸ¥** âœ…
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯¹æ¯”ä¼˜åŒ–å‰åï¼‰
- [ ] å®¡æŸ¥é…ç½®å‚æ•°æ˜¯å¦éœ€è¦è°ƒä¼˜
- [ ] æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥
- [ ] æ–‡æ¡£æ›´æ–°ï¼ˆè®°å½•è§‚å¯Ÿåˆ°çš„æ¨¡å¼ï¼‰

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ  
**æœ€åæ›´æ–°**: 2025-10-18  
**ä¸‹æ¬¡å®¡æŸ¥**: æ”¶é›†1å‘¨ç”Ÿäº§æ•°æ®å
