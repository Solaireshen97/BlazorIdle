# 数据库迁移问题修复说明

## 问题描述

当角色设置了战斗的计划任务之后，如果关闭 VS 的调试再打开，数据库就会异常，服务器无法正常启动，前端也无法连接服务器。

## 问题原因

经过分析，问题的根本原因是数据库迁移文件管理不当导致的：

1. **模型与数据库不匹配**：`ActivityPlan` 实体模型中包含 `BattleStateJson` 属性，数据库表中也有这个字段
2. **缺少迁移记录**：但是在 EF Core 的迁移历史（`__EFMigrationsHistory` 表）中没有记录添加这个字段的迁移
3. **重复的迁移文件**：发现在错误的目录 `Infrastructure/Persistence/Migrations/` 中有重复的迁移文件
4. **目录位置错误**：EF Core 期望的迁移目录是 `Migrations/`（项目根目录下）

当应用程序重启并尝试执行 `db.Database.Migrate()` 时，EF Core 会检测到：
- 模型快照（包含 `BattleStateJson`）
- 数据库架构（已有此字段）
- 迁移历史（没有记录此字段）

这种不匹配导致数据库迁移系统失败，阻止服务器启动。

## 解决方案

修复包含三个步骤：

### 1. 清理重复的迁移文件

删除了错误目录下的所有重复迁移文件：
- 删除了 `Infrastructure/Persistence/Migrations/` 目录下的 26 个重复文件
- 包括时间戳错误的 `20250107000000_AddBattleStateToActivityPlan.cs` 文件

### 2. 创建正确的迁移

在正确的位置创建了新的迁移：
```
Migrations/20251016072539_AddBattleStateToActivityPlan.cs
```

这个迁移故意是空的，因为数据库中已经存在该字段。它的目的是在迁移历史中记录 `BattleStateJson` 字段已被考虑在内。

### 3. 应用迁移

执行迁移命令更新数据库的迁移历史表：
```bash
dotnet ef database update
```

## 验证结果

修复后：
- ✅ 服务器第一次启动成功
- ✅ 服务器可以多次重启而不出错
- ✅ 所有 ActivityPlan 查询正常工作，包括 `BattleStateJson` 字段
- ✅ 所有 20 个 ActivityPlan 相关测试通过
- ✅ 数据库架构与 EF Core 模型保持一致

## 如何避免类似问题

为了防止将来出现类似问题：

1. **始终使用 EF Core 工具添加迁移**：
   ```bash
   dotnet ef migrations add 迁移名称
   ```

2. **不要手动修改数据库架构**：如果必须修改，也要创建相应的迁移

3. **保持迁移文件在正确的目录**：`Migrations/`（项目根目录级别）

4. **不要在子目录创建多个 Migrations 目录**

5. **在任何数据库架构更改后验证迁移历史**：
   ```bash
   dotnet ef migrations list
   ```

## 技术细节

- **实体**：`ActivityPlan`
- **字段**：`BattleStateJson`（可空字符串/TEXT）
- **用途**：存储战斗状态快照，用于离线/在线无缝切换
- **数据库**：SQLite (`gamedata.db`)
- **EF Core 版本**：9.0.9

## 总结

此问题是由于数据库架构、EF Core 模型和迁移历史不同步造成的。通过清理重复的迁移文件，创建正确的空迁移来同步迁移历史，问题得以解决。现在服务器可以正常启动和重启，所有功能包括计划任务都能正常工作。
