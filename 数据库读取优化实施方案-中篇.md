# BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸­ç¯‡ï¼ˆRepository æ”¹é€ ï¼‰

**é¡¹ç›®**: BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**é˜¶æ®µ**: Phase 2 - Repository å±‚æ”¹é€   
**åˆ›å»ºæ—¥æœŸ**: 2025-10-19  
**é¢„è®¡å·¥æ—¶**: 20-28 å°æ—¶  
**å‰ç½®æ¡ä»¶**: Phase 1 (åŸºç¡€è®¾æ–½) å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

1. [é˜¶æ®µæ¦‚è¿°](#é˜¶æ®µæ¦‚è¿°)
2. [æ”¹é€ ç­–ç•¥](#æ”¹é€ ç­–ç•¥)
3. [æ ¸å¿ƒ Repository æ”¹é€ ](#æ ¸å¿ƒ-repository-æ”¹é€ )
4. [é…ç½®æ•°æ® Repository æ”¹é€ ](#é…ç½®æ•°æ®-repository-æ”¹é€ )
5. [æŸ¥è¯¢ä¼˜åŒ–](#æŸ¥è¯¢ä¼˜åŒ–)
6. [æ•°æ®ä¸€è‡´æ€§ä¿è¯](#æ•°æ®ä¸€è‡´æ€§ä¿è¯)
7. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
8. [æ£€æŸ¥æ¸…å•](#æ£€æŸ¥æ¸…å•)

---

## é˜¶æ®µæ¦‚è¿°

### ç›®æ ‡

Phase 2 æ”¹é€ æ‰€æœ‰ Repository ä½¿ç”¨ç¼“å­˜ä¼˜å…ˆç­–ç•¥ï¼š
1. âœ… æ ¸å¿ƒè¿è¡Œæ€æ•°æ® Repositoryï¼ˆCharacter, BattleSnapshot, ActivityPlan, GearInstanceï¼‰
2. âœ… é…ç½®æ•°æ® Repositoryï¼ˆGearDefinition, Affix, GearSetï¼‰
3. âœ… ä¿æŒæ¥å£å‘åå…¼å®¹
4. âœ… ç¡®ä¿è¯»å†™ä¸€è‡´æ€§

### æ”¹é€ èŒƒå›´

| Repository | æ”¹é€ ç±»å‹ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|-----------|---------|-------|---------|
| CharacterRepository | ä½¿ç”¨ ReadThroughCacheManager | ğŸ”¥ é«˜ | 4h |
| BattleRepository | éƒ¨åˆ†æ”¹é€ ï¼ˆè¯»å–ä¼˜åŒ–ï¼‰ | ğŸ”¥ é«˜ | 3h |
| ActivityPlanRepository | ä½¿ç”¨ ReadThroughCacheManager | ğŸ”¥ é«˜ | 4h |
| GearInstanceRepository | ä½¿ç”¨ ReadThroughCacheManager | âš ï¸ ä¸­ | 5h |
| GearDefinitionRepository | ä½¿ç”¨ ConfigurationCacheService | ğŸ”¥ é«˜ | 3h |
| AffixRepository | ä½¿ç”¨ ConfigurationCacheService | ğŸ”¥ é«˜ | 2h |
| GearSetRepository | ä½¿ç”¨ ConfigurationCacheService | âš ï¸ ä¸­ | 2h |
| **æ€»è®¡** | - | - | **23h** |

### æ”¹é€ åŸåˆ™

1. **æ¥å£ä¸å˜**ï¼šä¿æŒç°æœ‰æ¥å£ç­¾åï¼Œå¯¹ä¸Šå±‚é€æ˜
2. **åŒè·¯å¾„æ”¯æŒ**ï¼šé…ç½®å¼€å…³æ§åˆ¶ä½¿ç”¨ç¼“å­˜è¿˜æ˜¯ç›´æ¥æŸ¥æ•°æ®åº“
3. **è¯»å†™ç»Ÿä¸€**ï¼šè¯»å†™éƒ½é€šè¿‡ç¼“å­˜ç®¡ç†å™¨ï¼Œé¿å…ä¸ä¸€è‡´
4. **å‘åå…¼å®¹**ï¼šæ”¹é€ å¤±è´¥å¯å¿«é€Ÿå›æ»š

---

## æ”¹é€ ç­–ç•¥

### é€šç”¨æ”¹é€ æ¨¡å¼

#### æ”¹é€ å‰ï¼ˆç›´æ¥æŸ¥æ•°æ®åº“ï¼‰

```csharp
public class CharacterRepository : ICharacterRepository
{
    private readonly GameDbContext _db;
    
    public CharacterRepository(GameDbContext db) => _db = db;
    
    public Task<Character?> GetAsync(Guid id, CancellationToken ct = default) =>
        _db.Characters.FirstOrDefaultAsync(c => c.Id == id, ct);  // âŒ ç›´æ¥æŸ¥æ•°æ®åº“
}
```

#### æ”¹é€ åï¼ˆç¼“å­˜ä¼˜å…ˆï¼‰

```csharp
public class CharacterRepository : ICharacterRepository
{
    private readonly GameDbContext _db;
    private readonly IReadThroughCacheManager<Character> _cacheManager;
    private readonly IConfiguration _configuration;
    
    public CharacterRepository(
        GameDbContext db,
        IReadThroughCacheManager<Character> cacheManager,
        IConfiguration configuration)
    {
        _db = db;
        _cacheManager = cacheManager;
        _configuration = configuration;
    }
    
    public Task<Character?> GetAsync(Guid id, CancellationToken ct = default)
    {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨è¯»å–ç¼“å­˜
        var enableReadCache = _configuration.GetValue<bool>("ReadCache:EnableReadCache", true);
        
        if (enableReadCache)
        {
            return _cacheManager.GetByIdAsync(id, ct);  // âœ… ç¼“å­˜ä¼˜å…ˆ
        }
        else
        {
            // Fallback: ç›´æ¥æŸ¥æ•°æ®åº“ï¼ˆå‘åå…¼å®¹ï¼‰
            return _db.Characters.FirstOrDefaultAsync(c => c.Id == id, ct);
        }
    }
}
```

### ä¾èµ–æ³¨å…¥å˜æ›´

#### æ”¹é€ å‰

```csharp
services.AddScoped<ICharacterRepository, CharacterRepository>();
```

#### æ”¹é€ å

```csharp
services.AddScoped<ICharacterRepository, CharacterRepository>();
// ReadThroughCacheManager å·²åœ¨ Phase 1 æ³¨å†Œä¸º Singleton
```

**æ³¨æ„**ï¼šRepository ä¿æŒ Scopedï¼ŒCacheManager æ˜¯ Singletonã€‚

---

## æ ¸å¿ƒ Repository æ”¹é€ 

### 1. CharacterRepository æ”¹é€ ï¼ˆ4 å°æ—¶ï¼‰

#### 1.1 æ„é€ å‡½æ•°æ”¹é€ 

```csharp
public class CharacterRepository : ICharacterRepository
{
    private readonly GameDbContext _db;
    private readonly IReadThroughCacheManager<Character> _cacheManager;
    private readonly IConfiguration _configuration;
    private readonly ILogger<CharacterRepository> _logger;
    
    public CharacterRepository(
        GameDbContext db,
        IReadThroughCacheManager<Character> cacheManager,
        IConfiguration configuration,
        ILogger<CharacterRepository> logger)
    {
        _db = db;
        _cacheManager = cacheManager;
        _configuration = configuration;
        _logger = logger;
    }
}
```

#### 1.2 GetAsync æ”¹é€ 

```csharp
/// <summary>
/// æŒ‰è§’è‰² ID å¼‚æ­¥æŸ¥è¯¢ä¸€ä¸ªè§’è‰²
/// Get character by ID asynchronously
/// </summary>
/// <param name="id">è§’è‰² ID / Character ID</param>
/// <param name="ct">å–æ¶ˆä»¤ç‰Œ / Cancellation token</param>
/// <returns>è§’è‰²æˆ– null / Character or null</returns>
public Task<Character?> GetAsync(Guid id, CancellationToken ct = default)
{
    var enableReadCache = _configuration.GetValue<bool>("ReadCache:EnableReadCache", true);
    
    if (enableReadCache)
    {
        _logger.LogTrace("ä½¿ç”¨ç¼“å­˜æŸ¥è¯¢è§’è‰² {CharacterId}", id);
        return _cacheManager.GetByIdAsync(id, ct);
    }
    else
    {
        _logger.LogTrace("ç›´æ¥æŸ¥è¯¢æ•°æ®åº“è·å–è§’è‰² {CharacterId}", id);
        return _db.Characters.FirstOrDefaultAsync(c => c.Id == id, ct);
    }
}
```

#### 1.3 å†™å…¥æ–¹æ³•ä¿æŒä¸å˜

```csharp
// å†™å…¥æ–¹æ³•ç»§ç»­ä½¿ç”¨ MemoryStateManagerï¼ˆå·²åœ¨ Phase 1-2 å®æ–½ï¼‰
// ä¸éœ€è¦æ”¹åŠ¨
```

**å…³é”®ç‚¹**ï¼š
- âœ… è¯»å–ä½¿ç”¨ ReadThroughCacheManager
- âœ… å†™å…¥ç»§ç»­ä½¿ç”¨ MemoryStateManagerï¼ˆå·²æœ‰ï¼‰
- âœ… ä¿è¯è¯»å†™ä¸€è‡´æ€§ï¼ˆåŒä¸€ä¸ª MemoryStateManagerï¼‰

### 2. ActivityPlanRepository æ”¹é€ ï¼ˆ4 å°æ—¶ï¼‰

#### 2.1 GetAsync æ”¹é€ 

```csharp
public Task<ActivityPlan?> GetAsync(Guid id, CancellationToken ct = default)
{
    var enableReadCache = _configuration.GetValue<bool>("ReadCache:EnableReadCache", true);
    
    return enableReadCache
        ? _cacheManager.GetByIdAsync(id, ct)
        : _db.ActivityPlans.FirstOrDefaultAsync(p => p.Id == id, ct);
}
```

#### 2.2 GetPendingOrRunningAsync æ”¹é€ ï¼ˆåˆ—è¡¨æŸ¥è¯¢ï¼‰

**åŸå®ç°**ï¼š
```csharp
public Task<List<ActivityPlan>> GetPendingOrRunningAsync(Guid characterId, CancellationToken ct = default) =>
    _db.ActivityPlans
        .Where(p => p.CharacterId == characterId &&
                   (p.Status == ActivityPlanStatus.Pending || p.Status == ActivityPlanStatus.Running))
        .ToListAsync(ct);
```

**æ”¹é€ å**ï¼š
```csharp
public Task<List<ActivityPlan>> GetPendingOrRunningAsync(Guid characterId, CancellationToken ct = default)
{
    var enableReadCache = _configuration.GetValue<bool>("ReadCache:EnableReadCache", true);
    
    if (enableReadCache)
    {
        // ä½¿ç”¨ç¼“å­˜æŸ¥è¯¢ç»“æœ
        var cacheKey = $"ActivityPlan:Character:{characterId}:PendingOrRunning";
        
        return _cacheManager.GetListAsync(
            p => p.CharacterId == characterId &&
                 (p.Status == ActivityPlanStatus.Pending || p.Status == ActivityPlanStatus.Running),
            cacheKey,
            ct);
    }
    else
    {
        // Fallback: ç›´æ¥æŸ¥æ•°æ®åº“
        return _db.ActivityPlans
            .Where(p => p.CharacterId == characterId &&
                       (p.Status == ActivityPlanStatus.Pending || p.Status == ActivityPlanStatus.Running))
            .ToListAsync(ct);
    }
}
```

#### 2.3 UpdateAsync æ”¹é€ ï¼ˆå†™å…¥æ—¶æ›´æ–°ç¼“å­˜ï¼‰

```csharp
public async Task UpdateAsync(ActivityPlan plan, CancellationToken ct = default)
{
    var enableMemoryBuffering = _configuration.GetValue<bool>("Persistence:EnableMemoryBuffering", false);
    
    if (enableMemoryBuffering && _memoryStateManager != null)
    {
        // æ›´æ–°å†…å­˜çŠ¶æ€ï¼ˆå·²æœ‰é€»è¾‘ï¼‰
        _memoryStateManager.Update(plan);
        
        // åŒæ­¥æ›´æ–°è¯»å–ç¼“å­˜
        var enableReadCache = _configuration.GetValue<bool>("ReadCache:EnableReadCache", true);
        if (enableReadCache)
        {
            _cacheManager.AddOrUpdate(plan);
            
            // å¤±æ•ˆç›¸å…³çš„åˆ—è¡¨æŸ¥è¯¢ç¼“å­˜
            var cacheKey = $"ActivityPlan:Character:{plan.CharacterId}:PendingOrRunning";
            _cacheManager.InvalidateList(cacheKey);
        }
    }
    else
    {
        // Fallback: ç›´æ¥ä¿å­˜
        await DatabaseRetryPolicy.SaveChangesWithRetryAsync(_db, ct);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… å†™å…¥æ—¶åŒæ—¶æ›´æ–°å•å®ä½“ç¼“å­˜å’Œå¤±æ•ˆåˆ—è¡¨ç¼“å­˜
- âœ… ä¿è¯ç¼“å­˜ä¸€è‡´æ€§

### 3. GearInstanceRepository æ”¹é€ ï¼ˆ5 å°æ—¶ï¼‰

#### 3.1 GetByIdAsync æ”¹é€ 

```csharp
public Task<GearInstance?> GetByIdAsync(Guid id, CancellationToken ct = default)
{
    var enableReadCache = _configuration.GetValue<bool>("ReadCache:EnableReadCache", true);
    
    return enableReadCache
        ? _cacheManager.GetByIdAsync(id, ct)
        : _db.GearInstances
            .Include(g => g.Affixes)
            .Include(g => g.GearDefinition)
            .FirstOrDefaultAsync(g => g.Id == id, ct);
}
```

**æ³¨æ„**ï¼šå¦‚æœä½¿ç”¨ç¼“å­˜ï¼Œéœ€è¦ç¡®ä¿ Include çš„å…³è”æ•°æ®ä¹Ÿè¢«ç¼“å­˜ã€‚

**è§£å†³æ–¹æ¡ˆ 1**ï¼šç¼“å­˜åŒ…å«å…³è”æ•°æ®çš„å®Œæ•´å®ä½“
```csharp
// æ•°æ®åº“åŠ è½½æ—¶ä½¿ç”¨ Include
entity = await db.Set<GearInstance>()
    .Include(g => g.Affixes)
    .Include(g => g.GearDefinition)
    .AsNoTracking()
    .FirstOrDefaultAsync(e => e.Id == id, ct);
```

**è§£å†³æ–¹æ¡ˆ 2**ï¼šåˆ†åˆ«ç¼“å­˜ï¼Œä½¿ç”¨æ—¶ç»„åˆ
```csharp
var gearInstance = await _cacheManager.GetByIdAsync(id, ct);
if (gearInstance != null)
{
    // ä»é…ç½®ç¼“å­˜åŠ è½½ GearDefinition
    gearInstance.GearDefinition = await _configCache.GetGearDefinitionAsync(gearInstance.GearDefinitionId);
    
    // ä» Affix ç¼“å­˜åŠ è½½ Affixes
    var affixIds = gearInstance.AffixIds;
    gearInstance.Affixes = await _affixCache.GetByIdsAsync(affixIds);
}
```

**æ¨è**ï¼šè§£å†³æ–¹æ¡ˆ 1ï¼ˆç®€å•ç›´æ¥ï¼‰

#### 3.2 GetByCharacterIdAsync æ”¹é€ ï¼ˆåˆ—è¡¨æŸ¥è¯¢ï¼‰

```csharp
public Task<List<GearInstance>> GetByCharacterIdAsync(Guid characterId, CancellationToken ct = default)
{
    var enableReadCache = _configuration.GetValue<bool>("ReadCache:EnableReadCache", true);
    
    if (enableReadCache)
    {
        var cacheKey = $"GearInstance:Character:{characterId}";
        
        return _cacheManager.GetListAsync(
            g => g.CharacterId == characterId,
            cacheKey,
            ct);
    }
    else
    {
        return _db.GearInstances
            .Where(g => g.CharacterId == characterId)
            .Include(g => g.Affixes)
            .Include(g => g.GearDefinition)
            .ToListAsync(ct);
    }
}
```

#### 3.3 GetEquippedBySlotAsync æ”¹é€ 

```csharp
public Task<GearInstance?> GetEquippedBySlotAsync(
    Guid characterId,
    EquipmentSlot slot,
    CancellationToken ct = default)
{
    var enableReadCache = _configuration.GetValue<bool>("ReadCache:EnableReadCache", true);
    
    if (enableReadCache)
    {
        // ç­–ç•¥1ï¼šä»åˆ—è¡¨ç¼“å­˜ä¸­ç­›é€‰
        var cacheKey = $"GearInstance:Character:{characterId}";
        
        var allGear = await _cacheManager.GetListAsync(
            g => g.CharacterId == characterId,
            cacheKey,
            ct);
        
        return allGear.FirstOrDefault(g => g.IsEquipped && g.SlotType == slot);
    }
    else
    {
        return _db.GearInstances
            .FirstOrDefaultAsync(g => 
                g.CharacterId == characterId && 
                g.IsEquipped && 
                g.SlotType == slot, 
                ct);
    }
}
```

---

## é…ç½®æ•°æ® Repository æ”¹é€ 

### 4. GearDefinitionRepository æ”¹é€ ï¼ˆ3 å°æ—¶ï¼‰

#### 4.1 å®Œå…¨é‡å†™ä¸ºä½¿ç”¨ ConfigurationCacheService

```csharp
public class GearDefinitionRepository : IGearDefinitionRepository
{
    private readonly IConfigurationCacheService _configCache;
    private readonly ILogger<GearDefinitionRepository> _logger;
    
    public GearDefinitionRepository(
        IConfigurationCacheService configCache,
        ILogger<GearDefinitionRepository> logger)
    {
        _configCache = configCache;
        _logger = logger;
    }
    
    public Task<GearDefinition?> GetByIdAsync(Guid id, CancellationToken ct = default)
    {
        _logger.LogTrace("ä»é…ç½®ç¼“å­˜è·å– GearDefinition {Id}", id);
        return _configCache.GetGearDefinitionAsync(id);
    }
    
    public Task<List<GearDefinition>> GetBySlotAsync(EquipmentSlot slot, CancellationToken ct = default)
    {
        _logger.LogTrace("ä»é…ç½®ç¼“å­˜è·å– GearDefinition by Slot {Slot}", slot);
        return _configCache.GetGearDefinitionsBySlotAsync(slot);
    }
    
    public Task<List<GearDefinition>> GetAllAsync(CancellationToken ct = default)
    {
        _logger.LogTrace("ä»é…ç½®ç¼“å­˜è·å–æ‰€æœ‰ GearDefinition");
        return _configCache.GetAllGearDefinitionsAsync();
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… ç§»é™¤ GameDbContext ä¾èµ–
- âœ… å®Œå…¨ä½¿ç”¨é…ç½®ç¼“å­˜
- âœ… å‡ ä¹é›¶æ•°æ®åº“æŸ¥è¯¢

### 5. AffixRepository æ”¹é€ ï¼ˆ2 å°æ—¶ï¼‰

```csharp
public class AffixRepository : IAffixRepository
{
    private readonly IConfigurationCacheService _configCache;
    private readonly ILogger<AffixRepository> _logger;
    
    public AffixRepository(
        IConfigurationCacheService configCache,
        ILogger<AffixRepository> logger)
    {
        _configCache = configCache;
        _logger = logger;
    }
    
    public Task<Affix?> GetByIdAsync(Guid id, CancellationToken ct = default)
    {
        return _configCache.GetAffixAsync(id);
    }
    
    public Task<List<Affix>> GetAllAsync(CancellationToken ct = default)
    {
        return _configCache.GetAllAffixesAsync();
    }
    
    public Task<List<Affix>> GetByRarityAsync(AffixRarity rarity, CancellationToken ct = default)
    {
        return _configCache.GetAffixesByRarityAsync(rarity);
    }
}
```

### 6. GearSetRepository æ”¹é€ ï¼ˆ2 å°æ—¶ï¼‰

```csharp
public class GearSetRepository : IGearSetRepository
{
    private readonly IConfigurationCacheService _configCache;
    private readonly ILogger<GearSetRepository> _logger;
    
    public GearSetRepository(
        IConfigurationCacheService configCache,
        ILogger<GearSetRepository> logger)
    {
        _configCache = configCache;
        _logger = logger;
    }
    
    public Task<GearSet?> GetByIdAsync(Guid id, CancellationToken ct = default)
    {
        return _configCache.GetGearSetAsync(id);
    }
    
    public Task<List<GearSet>> GetAllAsync(CancellationToken ct = default)
    {
        return _configCache.GetAllGearSetsAsync();
    }
}
```

---

## æŸ¥è¯¢ä¼˜åŒ–

### ç¼“å­˜é”®å‘½åè§„èŒƒ

**æ ¼å¼**ï¼š`{EntityType}:{Scope}:{Identifier}:{Filter}`

**ç¤ºä¾‹**ï¼š
- `Character:Id:123e4567-e89b-12d3-a456-426614174000`
- `ActivityPlan:Character:123e4567:PendingOrRunning`
- `GearInstance:Character:123e4567:Equipped`
- `GearDefinition:Slot:Weapon`

### å¸¸è§æŸ¥è¯¢æ¨¡å¼ä¼˜åŒ–

#### æ¨¡å¼ 1ï¼šæŒ‰å•ä¸ª ID æŸ¥è¯¢

```csharp
// ä½¿ç”¨ GetByIdAsync - è‡ªåŠ¨ç¼“å­˜
var entity = await _cacheManager.GetByIdAsync(id, ct);
```

#### æ¨¡å¼ 2ï¼šæŒ‰å¤–é”®æŸ¥è¯¢åˆ—è¡¨

```csharp
// ä½¿ç”¨ GetListAsync - ç¼“å­˜æŸ¥è¯¢ç»“æœ
var cacheKey = $"EntityType:ForeignKey:{foreignKeyId}";
var results = await _cacheManager.GetListAsync(
    e => e.ForeignKeyId == foreignKeyId,
    cacheKey,
    ct);
```

#### æ¨¡å¼ 3ï¼šå¤æ‚æ¡ä»¶æŸ¥è¯¢

```csharp
// ç»„åˆç¼“å­˜é”®
var cacheKey = $"EntityType:ComplexQuery:{param1}:{param2}";
var results = await _cacheManager.GetListAsync(
    e => e.Param1 == param1 && e.Param2 == param2,
    cacheKey,
    ct);
```

---

## æ•°æ®ä¸€è‡´æ€§ä¿è¯

### å†™å…¥æ—¶åŒæ­¥æ›´æ–°ç¼“å­˜

**è§„åˆ™**ï¼š
1. æ›´æ–°å®ä½“ â†’ æ›´æ–°å•å®ä½“ç¼“å­˜
2. æ›´æ–°å®ä½“ â†’ å¤±æ•ˆç›¸å…³åˆ—è¡¨ç¼“å­˜

**ç¤ºä¾‹**ï¼ˆActivityPlanRepository.UpdateAsyncï¼‰ï¼š

```csharp
public async Task UpdateAsync(ActivityPlan plan, CancellationToken ct = default)
{
    // 1. æ›´æ–°å†…å­˜çŠ¶æ€ï¼ˆå†™å…¥ä¼˜åŒ–ï¼‰
    _memoryStateManager.Update(plan);
    
    // 2. åŒæ­¥æ›´æ–°è¯»å–ç¼“å­˜
    _cacheManager.AddOrUpdate(plan);
    
    // 3. å¤±æ•ˆç›¸å…³åˆ—è¡¨ç¼“å­˜
    var relatedCacheKeys = new[]
    {
        $"ActivityPlan:Character:{plan.CharacterId}:PendingOrRunning",
        $"ActivityPlan:Character:{plan.CharacterId}:All"
    };
    
    foreach (var key in relatedCacheKeys)
    {
        _cacheManager.InvalidateList(key);
    }
}
```

### åˆ é™¤æ—¶æ¸…ç†ç¼“å­˜

```csharp
public async Task DeleteAsync(Guid id, CancellationToken ct = default)
{
    var plan = await GetAsync(id, ct);
    if (plan == null) return;
    
    // 1. ä»å†…å­˜çŠ¶æ€ç§»é™¤
    _memoryStateManager.Remove(id);
    
    // 2. ä»è¯»å–ç¼“å­˜ç§»é™¤
    _cacheManager.Invalidate(id);
    
    // 3. å¤±æ•ˆç›¸å…³åˆ—è¡¨ç¼“å­˜
    _cacheManager.InvalidateList($"ActivityPlan:Character:{plan.CharacterId}:PendingOrRunning");
}
```

---

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

#### CharacterRepository æµ‹è¯•

**æ–‡ä»¶è·¯å¾„**: `tests/BlazorIdle.Tests/Repositories/CharacterRepositoryTests.cs`

**æµ‹è¯•ç”¨ä¾‹**ï¼š
1. âœ… `GetAsync_WithCacheEnabled_UsesCache`
2. âœ… `GetAsync_WithCacheDisabled_QueriesDatabase`
3. âœ… `GetAsync_CacheMiss_LoadsFromDatabase`
4. âœ… `GetAsync_CacheHit_ReturnsFromCache`

#### ActivityPlanRepository æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
1. âœ… `GetPendingOrRunningAsync_CachesResults`
2. âœ… `UpdateAsync_InvalidatesRelatedCaches`
3. âœ… `DeleteAsync_ClearsAllRelatedCaches`

#### GearDefinitionRepository æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
1. âœ… `GetByIdAsync_ReturnsFromConfigCache`
2. âœ… `GetBySlotAsync_ReturnsFromConfigCache`
3. âœ… `GetAllAsync_NeverQueriesDatabase`

### é›†æˆæµ‹è¯•

#### æ•°æ®ä¸€è‡´æ€§æµ‹è¯•

```csharp
[Fact]
public async Task UpdateEntity_ReadImmediately_ReturnsUpdatedData()
{
    // Arrange
    var character = await _repo.GetAsync(characterId);
    character.Name = "NewName";
    
    // Act
    await _repo.UpdateAsync(character);
    
    // Assert - ç«‹å³è¯»å–åº”è¯¥çœ‹åˆ°æ›´æ–°åçš„æ•°æ®
    var updated = await _repo.GetAsync(characterId);
    Assert.Equal("NewName", updated.Name);
}
```

#### ç¼“å­˜å¤±æ•ˆæµ‹è¯•

```csharp
[Fact]
public async Task UpdatePlan_ListQuery_ReturnsUpdatedList()
{
    // Arrange
    var plans = await _repo.GetPendingOrRunningAsync(characterId);
    var count = plans.Count;
    
    // Act - æ›´æ–°ä¸€ä¸ª plan çš„çŠ¶æ€
    var plan = plans.First();
    plan.Status = ActivityPlanStatus.Completed;
    await _repo.UpdateAsync(plan);
    
    // Assert - åˆ—è¡¨æŸ¥è¯¢åº”è¯¥åæ˜ å˜æ›´
    var updatedPlans = await _repo.GetPendingOrRunningAsync(characterId);
    Assert.Equal(count - 1, updatedPlans.Count);
}
```

---

## æ£€æŸ¥æ¸…å•

### Phase 2 å®Œæˆæ ‡å‡†

#### ä»£ç æ”¹é€ 

- [ ] CharacterRepository å·²æ”¹é€ å¹¶æµ‹è¯•
- [ ] ActivityPlanRepository å·²æ”¹é€ å¹¶æµ‹è¯•
- [ ] GearInstanceRepository å·²æ”¹é€ å¹¶æµ‹è¯•
- [ ] GearDefinitionRepository å·²æ”¹é€ å¹¶æµ‹è¯•
- [ ] AffixRepository å·²æ”¹é€ å¹¶æµ‹è¯•
- [ ] GearSetRepository å·²æ”¹é€ å¹¶æµ‹è¯•

#### åŠŸèƒ½éªŒè¯

- [ ] ç¼“å­˜ä¼˜å…ˆè¯»å–æ­£å¸¸å·¥ä½œ
- [ ] Fallback æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] å†™å…¥æ—¶ç¼“å­˜åŒæ­¥æ›´æ–°
- [ ] åˆ—è¡¨ç¼“å­˜å¤±æ•ˆæœºåˆ¶æ­£ç¡®
- [ ] é…ç½®ç¼“å­˜é›¶æ•°æ®åº“æŸ¥è¯¢

#### æ€§èƒ½éªŒè¯

- [ ] æ•°æ®åº“è¯»å–å‡å°‘ > 70%
- [ ] API å“åº”æ—¶é—´æ”¹å–„ > 30%
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 80%
- [ ] å†…å­˜å¢é•¿åœ¨é¢„æœŸèŒƒå›´å†…

#### è´¨é‡ä¿è¯

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ•°æ®ä¸€è‡´æ€§æµ‹è¯•é€šè¿‡
- [ ] å¹¶å‘æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ä¸‹ä¸€æ­¥

Phase 2 å®Œæˆåï¼Œè¿›å…¥ **Phase 3ï¼šç›‘æ§ä¸ä¼˜åŒ–**ï¼ˆä¸‹ç¯‡ï¼‰ï¼Œæ·»åŠ ç¼“å­˜ç›‘æ§ã€æ€§èƒ½åˆ†æå’Œä¼˜åŒ–è°ƒæ•´ã€‚

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… Phase 2 å®æ–½æ–¹æ¡ˆå®Œæˆ  
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š2-3 ä¸ªå·¥ä½œæ—¥  
**æœ€åæ›´æ–°**ï¼š2025-10-19
