# BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸­ç¯‡

**é˜¶æ®µ**: Phase 2 - åˆ†é˜¶æ®µè¿ç§»è¯»å–æ“ä½œ  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-18  
**å·¥ä½œé‡ä¼°ç®—**: 4-6 å¤©  
**å‰ç½®æ¡ä»¶**: Phase 1 (ä¸Šç¯‡) å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

1. [é˜¶æ®µç›®æ ‡](#é˜¶æ®µç›®æ ‡)
2. [è¿ç§»ç­–ç•¥](#è¿ç§»ç­–ç•¥)
3. [ä¸‰ä¸ªè¿ç§»é˜¶æ®µ](#ä¸‰ä¸ªè¿ç§»é˜¶æ®µ)
4. [è¯¦ç»†å®æ–½æ­¥éª¤](#è¯¦ç»†å®æ–½æ­¥éª¤)
5. [æ•°æ®ä¸€è‡´æ€§ä¿è¯](#æ•°æ®ä¸€è‡´æ€§ä¿è¯)
6. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
7. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)

---

## é˜¶æ®µç›®æ ‡

### ä¸»è¦ç›®æ ‡

**å°†ç°æœ‰æ•°æ®åº“è¯»å–æ“ä½œé€æ­¥è¿ç§»åˆ°ç¼“å­˜ä¼˜å…ˆæ¨¡å¼ã€‚**

å…·ä½“ç›®æ ‡ï¼š
1. âœ… ç¬¬ä¸€é˜¶æ®µï¼šè¿ç§»é™æ€é…ç½®æ•°æ®ï¼ˆä½é£é™©ï¼‰
2. âœ… ç¬¬äºŒé˜¶æ®µï¼šè¿ç§»ç”¨æˆ·æ ¸å¿ƒæ•°æ®ï¼ˆä¸­é£é™©ï¼‰
3. âœ… ç¬¬ä¸‰é˜¶æ®µï¼šè¿ç§»æ´»åŠ¨å’Œæˆ˜æ–—æ•°æ®ï¼ˆé«˜é£é™©ï¼‰
4. âœ… æ¯ä¸ªé˜¶æ®µç‹¬ç«‹æµ‹è¯•å’ŒéªŒè¯
5. âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§

### å…³é”®åŸåˆ™

1. **æ¸è¿›å¼è¿ç§»**ï¼šä»ä½é£é™©åˆ°é«˜é£é™©ï¼Œåˆ†é˜¶æ®µæ¨è¿›
2. **ç‹¬ç«‹éªŒè¯**ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆåç‹¬ç«‹æµ‹è¯•
3. **å¯å›é€€**ï¼šé€šè¿‡é…ç½®å¼€å…³å¿«é€Ÿå›é€€
4. **ä¿æŒæ¥å£**ï¼šä¸æ”¹å˜ Repository æ¥å£å®šä¹‰
5. **æ•°æ®ä¸€è‡´æ€§**ï¼šè¯»å†™æ“ä½œååŒï¼Œç¡®ä¿æ•°æ®æœ€æ–°

### è¿ç§»ä¼˜å…ˆçº§

| é˜¶æ®µ | å®ä½“ç±»å‹ | é£é™©ç­‰çº§ | ç¼“å­˜å‘½ä¸­ç‡é¢„æœŸ | å·¥ä½œé‡ |
|-----|---------|---------|--------------|--------|
| ç¬¬ä¸€é˜¶æ®µ | GearDefinition, Affix, GearSet | ä½ | 95-100% | 1-2å¤© |
| ç¬¬äºŒé˜¶æ®µ | Character, GearInstance | ä¸­ | 80-90% | 2-3å¤© |
| ç¬¬ä¸‰é˜¶æ®µ | ActivityPlan, RunningBattleSnapshot | é«˜ | 70-85% | 1-2å¤© |

---

## è¿ç§»ç­–ç•¥

### æ€»ä½“ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿ç§»é˜¶æ®µ        â”‚  å®ä½“ç±»å‹                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ä¸€é˜¶æ®µ (ä½é£é™©) â”‚ GearDefinition          â”‚
â”‚                  â”‚ Affix                   â”‚
â”‚                  â”‚ GearSet                 â”‚
â”‚                  â”‚                         â”‚
â”‚  ç‰¹ç‚¹ï¼š          â”‚ â€¢ é™æ€é…ç½®æ•°æ®            â”‚
â”‚                  â”‚ â€¢ å¯åŠ¨æ—¶é¢„åŠ è½½            â”‚
â”‚                  â”‚ â€¢ æ°¸ä¹…ç¼“å­˜                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬äºŒé˜¶æ®µ (ä¸­é£é™©) â”‚ Character               â”‚
â”‚                  â”‚ GearInstance            â”‚
â”‚                  â”‚                         â”‚
â”‚  ç‰¹ç‚¹ï¼š          â”‚ â€¢ ç”¨æˆ·æ ¸å¿ƒæ•°æ®            â”‚
â”‚                  â”‚ â€¢ ä¸´æ—¶ç¼“å­˜ + TTL          â”‚
â”‚                  â”‚ â€¢ è¯»å†™é¢‘ç¹                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ä¸‰é˜¶æ®µ (é«˜é£é™©) â”‚ ActivityPlan            â”‚
â”‚                  â”‚ RunningBattleSnapshot   â”‚
â”‚                  â”‚                         â”‚
â”‚  ç‰¹ç‚¹ï¼š          â”‚ â€¢ æ´»åŠ¨å’Œæˆ˜æ–—æ•°æ®          â”‚
â”‚                  â”‚ â€¢ ä¸´æ—¶ç¼“å­˜ + çŸ­TTL        â”‚
â”‚                  â”‚ â€¢ å·²æœ‰å†™å…¥ä¼˜åŒ–            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿ç§»æ¨¡å¼

**æ¨¡å¼ 1ï¼šRepository é€‚é…å™¨æ¨¡å¼**ï¼ˆæ¨èï¼‰

```csharp
// åœ¨ Repository ä¸­é€æ˜åœ°ä½¿ç”¨ç¼“å­˜

public class GearDefinitionRepository : IGearDefinitionRepository
{
    private readonly GameDbContext _db;
    private readonly IMemoryStateManager<GearDefinition> _memoryManager;
    private readonly IConfiguration _configuration;
    
    public async Task<GearDefinition?> GetAsync(Guid id, CancellationToken ct = default)
    {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨è¯»å–ç¼“å­˜
        var enableCaching = _configuration.GetValue<bool>(
            "CacheConfiguration:GlobalSettings:EnableReadCaching", true);
        
        if (enableCaching && _memoryManager != null)
        {
            // ä½¿ç”¨ç¼“å­˜
            return await _memoryManager.TryGetAsync(
                id,
                async (id, ct) => await _db.GearDefinitions
                    .FirstOrDefaultAsync(g => g.Id == id, ct),
                ct
            );
        }
        else
        {
            // å›é€€ï¼šç›´æ¥æŸ¥æ•°æ®åº“
            return await _db.GearDefinitions
                .FirstOrDefaultAsync(g => g.Id == id, ct);
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¯¹è°ƒç”¨æ–¹é€æ˜
- âœ… æ˜“äºå›é€€
- âœ… å±€éƒ¨ä¿®æ”¹

**æ¨¡å¼ 2ï¼šService å±‚ç¼“å­˜æ¨¡å¼**ï¼ˆå¯é€‰ï¼‰

```csharp
// åœ¨ Service å±‚ä½¿ç”¨ç¼“å­˜

public class EquipmentService
{
    public async Task<GearDefinition?> GetGearDefinitionAsync(Guid id)
    {
        // æ˜¾å¼ä½¿ç”¨ç¼“å­˜
        var cached = await _cacheManager.GetAsync<GearDefinition>(id);
        if (cached != null)
            return cached;
        
        var fromDb = await _repository.GetAsync(id);
        if (fromDb != null)
        {
            await _cacheManager.SetAsync(id, fromDb);
        }
        
        return fromDb;
    }
}
```

**é€‰æ‹©**ï¼šæœ¬é¡¹ç›®é‡‡ç”¨**æ¨¡å¼ 1 - Repository é€‚é…å™¨æ¨¡å¼**

### æ•°æ®ä¸€è‡´æ€§ç­–ç•¥

**ç­–ç•¥ 1ï¼šå†™å…¥æ—¶åŒæ­¥æ›´æ–°å†…å­˜**

```csharp
// Repository.UpdateAsync
public async Task UpdateAsync(GearInstance gear, CancellationToken ct = default)
{
    // 1. æ›´æ–° EF Core è·Ÿè¸ªçš„å®ä½“
    _db.GearInstances.Update(gear);
    
    // 2. æ£€æŸ¥æ˜¯å¦å¯ç”¨å†…å­˜ç¼“å†²
    var enableMemoryBuffering = _configuration.GetValue<bool>(
        "Persistence:EnableMemoryBuffering", false);
    
    if (enableMemoryBuffering && _memoryManager != null)
    {
        // 3. åŒæ­¥æ›´æ–°å†…å­˜
        _memoryManager.Update(gear.Id, gear);
        // ä¸ç«‹å³ä¿å­˜æ•°æ®åº“ï¼Œç”± PersistenceCoordinator æ‰¹é‡ä¿å­˜
    }
    else
    {
        // 4. å›é€€ï¼šç«‹å³ä¿å­˜æ•°æ®åº“
        await DatabaseRetryPolicy.SaveChangesWithRetryAsync(_db, ct);
    }
}
```

**ç­–ç•¥ 2ï¼šè¯»å–æ—¶ç¡®ä¿æœ€æ–°**

```csharp
// MemoryStateManager.TryGetAsync
public async Task<T?> TryGetAsync(...)
{
    // 1. æŸ¥å†…å­˜
    if (_store.TryGetValue(id, out var cached))
    {
        // 2. æ£€æŸ¥æ˜¯å¦ Dirtyï¼ˆæœ‰æœªä¿å­˜çš„æ›´æ–°ï¼‰
        if (_dirtyEntities.ContainsKey(id))
        {
            // å†…å­˜ä¸­çš„æ˜¯æœ€æ–°çš„ï¼ˆå°šæœªä¿å­˜ä½†å·²æ›´æ–°ï¼‰
            return cached;
        }
        
        // 3. é Dirtyï¼Œç›´æ¥è¿”å›
        return cached;
    }
    
    // 4. æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
    var entity = await databaseLoader(id, ct);
    if (entity != null)
    {
        _store.TryAdd(id, entity);
    }
    
    return entity;
}
```

---

## ä¸‰ä¸ªè¿ç§»é˜¶æ®µ

### ç¬¬ä¸€é˜¶æ®µï¼šé™æ€é…ç½®æ•°æ®ï¼ˆ1-2å¤©ï¼‰

#### ç›®æ ‡å®ä½“

1. **GearDefinitionï¼ˆè£…å¤‡å®šä¹‰ï¼‰**
   - é™æ€é…ç½®ï¼Œæå°‘å˜åŒ–
   - å¯åŠ¨æ—¶é¢„åŠ è½½
   - æ°¸ä¹…ç¼“å­˜

2. **Affixï¼ˆè¯ç¼€å®šä¹‰ï¼‰**
   - é™æ€é…ç½®ï¼Œä¸å˜åŒ–
   - å¯åŠ¨æ—¶é¢„åŠ è½½
   - æ°¸ä¹…ç¼“å­˜

3. **GearSetï¼ˆè£…å¤‡å¥—è£…ï¼‰**
   - é™æ€é…ç½®ï¼Œä¸å˜åŒ–
   - å¯åŠ¨æ—¶é¢„åŠ è½½
   - æ°¸ä¹…ç¼“å­˜

#### è¿ç§»ä»»åŠ¡æ¸…å•

##### Task 1: è¿ç§» GearDefinitionRepository
- [ ] ä¿®æ”¹ GetAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] ä¿®æ”¹ GetBySlotAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] ä¿®æ”¹ GetAllAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] æ·»åŠ é…ç½®å¼€å…³
- [ ] å•å…ƒæµ‹è¯•

##### Task 2: è¿ç§» AffixRepository
- [ ] ä¿®æ”¹ GetAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] ä¿®æ”¹ GetAllAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] ä¿®æ”¹ GetByRarityAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] æ·»åŠ é…ç½®å¼€å…³
- [ ] å•å…ƒæµ‹è¯•

##### Task 3: è¿ç§» GearSetRepository
- [ ] ä¿®æ”¹ GetAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] ä¿®æ”¹ GetAllAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] æ·»åŠ é…ç½®å¼€å…³
- [ ] å•å…ƒæµ‹è¯•

##### Task 4: æµ‹è¯•éªŒè¯
- [ ] å¯åŠ¨æœåŠ¡ï¼ŒéªŒè¯é¢„åŠ è½½
- [ ] æµ‹è¯•æŸ¥è¯¢æ€§èƒ½ï¼ˆåº”è¯¥ <1msï¼‰
- [ ] éªŒè¯ç¼“å­˜å‘½ä¸­ç‡ï¼ˆåº”è¯¥ 100%ï¼‰
- [ ] é›†æˆæµ‹è¯•

---

### ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·æ ¸å¿ƒæ•°æ®ï¼ˆ2-3å¤©ï¼‰

#### ç›®æ ‡å®ä½“

1. **Characterï¼ˆè§’è‰²ï¼‰**
   - ç”¨æˆ·æ ¸å¿ƒæ•°æ®
   - ä¸´æ—¶ç¼“å­˜ï¼ˆTTL 1å°æ—¶ï¼‰
   - è¯»å†™é¢‘ç¹

2. **GearInstanceï¼ˆè£…å¤‡å®ä¾‹ï¼‰**
   - ç”¨æˆ·è£…å¤‡æ•°æ®
   - ä¸´æ—¶ç¼“å­˜ï¼ˆTTL 30åˆ†é’Ÿï¼‰
   - åŒ…å«å…³è”æŸ¥è¯¢ï¼ˆDefinition, Affixesï¼‰

#### ç‰¹æ®ŠæŒ‘æˆ˜

**æŒ‘æˆ˜ 1ï¼šå¤æ‚æŸ¥è¯¢**

```csharp
// å½“å‰æŸ¥è¯¢åŒ…å« Include
var gear = await _db.GearInstances
    .Include(g => g.Definition)
    .Include(g => g.Affixes)
    .Where(g => g.CharacterId == characterId)
    .ToListAsync();
```

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†æ­¥ç¼“å­˜

```csharp
// 1. å…ˆæŸ¥ GearInstanceï¼ˆç¼“å­˜ï¼‰
var gearInstances = await GetGearInstancesByCharacterAsync(characterId);

// 2. å†æŸ¥å…³è”çš„ Definition å’Œ Affixesï¼ˆä¹Ÿç¼“å­˜ï¼‰
foreach (var gear in gearInstances)
{
    gear.Definition = await _gearDefRepo.GetAsync(gear.DefinitionId);
    gear.Affixes = await GetAffixesForGearAsync(gear.Id);
}
```

**æŒ‘æˆ˜ 2ï¼šä¸å†™å…¥ä¼˜åŒ–ååŒ**

è§’è‰²å’Œè£…å¤‡å®ä¾‹å·²åœ¨å†™å…¥æ—¶ä½¿ç”¨ MemoryStateManagerï¼Œéœ€è¦ç¡®ä¿è¯»å†™ä½¿ç”¨åŒä¸€ä»½å†…å­˜æ•°æ®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šè¯»å†™å…±äº« MemoryStateManager

```csharp
// å†™å…¥æ“ä½œï¼ˆå·²å®ç°ï¼‰
_memoryManager.Update(character.Id, character);

// è¯»å–æ“ä½œï¼ˆæ–°å¢ï¼‰
var character = await _memoryManager.TryGetAsync(
    id,
    async (id, ct) => await _db.Characters.FirstOrDefaultAsync(...),
    ct
);
```

#### è¿ç§»ä»»åŠ¡æ¸…å•

##### Task 1: è¿ç§» CharacterRepository
- [ ] ä¿®æ”¹ GetAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] ç¡®ä¿ä¸å†™å…¥æ“ä½œå…±äº«å†…å­˜
- [ ] æ·»åŠ é…ç½®å¼€å…³
- [ ] å•å…ƒæµ‹è¯•

##### Task 2: è¿ç§» GearInstanceRepository
- [ ] ä¿®æ”¹ GetAsync æ–¹æ³•ä½¿ç”¨ç¼“å­˜
- [ ] ä¿®æ”¹ GetByCharacterIdAsync å¤„ç†å…³è”æŸ¥è¯¢
- [ ] ä¿®æ”¹ GetEquippedBySlotAsync ä½¿ç”¨ç¼“å­˜
- [ ] ç¡®ä¿ä¸å†™å…¥æ“ä½œå…±äº«å†…å­˜
- [ ] æ·»åŠ é…ç½®å¼€å…³
- [ ] å•å…ƒæµ‹è¯•

##### Task 3: å¤„ç†å…³è”æŸ¥è¯¢
- [ ] ä¼˜åŒ– Include æŸ¥è¯¢ä¸ºåˆ†æ­¥ç¼“å­˜æŸ¥è¯¢
- [ ] ç¡®ä¿å…³è”æ•°æ®ä¹Ÿä»ç¼“å­˜è¯»å–
- [ ] æ€§èƒ½æµ‹è¯•

##### Task 4: æµ‹è¯•éªŒè¯
- [ ] æµ‹è¯•è¯»å†™ä¸€è‡´æ€§
- [ ] æµ‹è¯•ç¼“å­˜å‘½ä¸­ç‡ï¼ˆç›®æ ‡ 80-90%ï¼‰
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆ100 ä¸ªåœ¨çº¿ç”¨æˆ·ï¼‰
- [ ] é›†æˆæµ‹è¯•

---

### ç¬¬ä¸‰é˜¶æ®µï¼šæ´»åŠ¨å’Œæˆ˜æ–—æ•°æ®ï¼ˆ1-2å¤©ï¼‰

#### ç›®æ ‡å®ä½“

1. **ActivityPlanï¼ˆæ´»åŠ¨è®¡åˆ’ï¼‰**
   - æ´»åŠ¨çŠ¶æ€æ•°æ®
   - ä¸´æ—¶ç¼“å­˜ï¼ˆTTL 10åˆ†é’Ÿï¼‰
   - å·²æœ‰å†™å…¥ä¼˜åŒ–

2. **RunningBattleSnapshotRecordï¼ˆæˆ˜æ–—å¿«ç…§ï¼‰**
   - æˆ˜æ–—çŠ¶æ€æ•°æ®
   - ä¸´æ—¶ç¼“å­˜ï¼ˆTTL 5åˆ†é’Ÿï¼‰
   - å·²æœ‰å†™å…¥ä¼˜åŒ–

#### ç‰¹æ®ŠæŒ‘æˆ˜

**æŒ‘æˆ˜ 1ï¼šé¢‘ç¹æ›´æ–°**

æ´»åŠ¨è®¡åˆ’å’Œæˆ˜æ–—å¿«ç…§æ›´æ–°éå¸¸é¢‘ç¹ï¼ˆæ¯ 30-60 ç§’ï¼‰ï¼Œéœ€è¦ç¡®ä¿ç¼“å­˜ä¸ä¼šè¿‡æ—¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå†™å…¥æ—¶ç«‹å³æ›´æ–°å†…å­˜

```csharp
// åœ¨ ActivityPlanRepository.UpdateAsync ä¸­
public async Task UpdateAsync(ActivityPlan plan, CancellationToken ct = default)
{
    _db.ActivityPlans.Update(plan);
    
    if (_enableMemoryBuffering && _memoryManager != null)
    {
        // ç«‹å³æ›´æ–°å†…å­˜ï¼ˆæ ‡è®°ä¸º Dirtyï¼‰
        _memoryManager.Update(plan.Id, plan);
        // æ•°æ®åº“ä¿å­˜ç”± PersistenceCoordinator æ‰¹é‡å¤„ç†
    }
    else
    {
        await DatabaseRetryPolicy.SaveChangesWithRetryAsync(_db, ct);
    }
}

// è¯»å–æ—¶ä»å†…å­˜è·å–ï¼ˆæ€»æ˜¯æœ€æ–°ï¼‰
public async Task<ActivityPlan?> GetAsync(Guid id, CancellationToken ct = default)
{
    if (_enableCaching && _memoryManager != null)
    {
        return await _memoryManager.TryGetAsync(
            id,
            async (id, ct) => await _db.ActivityPlans
                .FirstOrDefaultAsync(p => p.Id == id, ct),
            ct
        );
    }
    
    return await _db.ActivityPlans.FirstOrDefaultAsync(p => p.Id == id, ct);
}
```

#### è¿ç§»ä»»åŠ¡æ¸…å•

##### Task 1: è¿ç§» ActivityPlanRepository
- [ ] ä¿®æ”¹ GetAsync ä½¿ç”¨ç¼“å­˜
- [ ] ä¿®æ”¹ GetByCharacterIdAsync ä½¿ç”¨ç¼“å­˜
- [ ] ä¿®æ”¹ GetRunningPlanAsync ä½¿ç”¨ç¼“å­˜
- [ ] ç¡®ä¿è¯»å†™å…±äº«å†…å­˜
- [ ] æ·»åŠ é…ç½®å¼€å…³
- [ ] å•å…ƒæµ‹è¯•

##### Task 2: è¿ç§»æˆ˜æ–—å¿«ç…§è¯»å–
- [ ] ä¿®æ”¹ StepBattleSnapshotService.LoadAsync ä½¿ç”¨ç¼“å­˜
- [ ] ç¡®ä¿ä¸å†™å…¥æ“ä½œå…±äº«å†…å­˜
- [ ] æµ‹è¯•æˆ˜æ–—æ¢å¤åŠŸèƒ½
- [ ] å•å…ƒæµ‹è¯•

##### Task 3: æµ‹è¯•éªŒè¯
- [ ] æµ‹è¯•æ´»åŠ¨çŠ¶æ€ä¸€è‡´æ€§
- [ ] æµ‹è¯•æˆ˜æ–—å¿«ç…§æ¢å¤
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆå¤šä¸ªå¹¶å‘æˆ˜æ–—ï¼‰
- [ ] é›†æˆæµ‹è¯•

---

## è¯¦ç»†å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µå®æ–½ï¼ˆ1-2å¤©ï¼‰

#### Step 1: è¿ç§» GearDefinitionRepositoryï¼ˆ2-3å°æ—¶ï¼‰

**æ–‡ä»¶**ï¼š`Infrastructure/Persistence/Repositories/GearDefinitionRepository.cs`

**å½“å‰ä»£ç **ï¼š
```csharp
public Task<GearDefinition?> GetAsync(Guid id, CancellationToken ct = default) =>
    _db.GearDefinitions.FirstOrDefaultAsync(g => g.Id == id, ct);
```

**ä¿®æ”¹ä¸º**ï¼š
```csharp
/// <summary>
/// è·å–è£…å¤‡å®šä¹‰ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
/// Get gear definition (with caching)
/// </summary>
public async Task<GearDefinition?> GetAsync(Guid id, CancellationToken ct = default)
{
    // æ£€æŸ¥æ˜¯å¦å¯ç”¨è¯»å–ç¼“å­˜
    var enableCaching = _configuration.GetValue<bool>(
        "CacheConfiguration:GlobalSettings:EnableReadCaching", true);
    
    if (enableCaching && _memoryManager != null)
    {
        // ä½¿ç”¨ç¼“å­˜ä¼˜å…ˆç­–ç•¥
        return await _memoryManager.TryGetAsync(
            id,
            async (id, ct) => await _db.GearDefinitions
                .FirstOrDefaultAsync(g => g.Id == id, ct),
            ct
        );
    }
    else
    {
        // å›é€€ï¼šç›´æ¥æŸ¥æ•°æ®åº“
        _logger?.LogDebug(
            "è¯»å–ç¼“å­˜å·²ç¦ç”¨æˆ– MemoryManager æœªæ³¨å†Œï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“"
        );
        return await _db.GearDefinitions
            .FirstOrDefaultAsync(g => g.Id == id, ct);
    }
}
```

**ä¿®æ”¹æ„é€ å‡½æ•°**ï¼š
```csharp
private readonly GameDbContext _db;
private readonly IConfiguration _configuration;
private readonly IMemoryStateManager<GearDefinition>? _memoryManager;
private readonly ILogger<GearDefinitionRepository>? _logger;

public GearDefinitionRepository(
    GameDbContext db,
    IConfiguration configuration,
    IMemoryStateManager<GearDefinition>? memoryManager = null,
    ILogger<GearDefinitionRepository>? logger = null)
{
    _db = db;
    _configuration = configuration;
    _memoryManager = memoryManager;
    _logger = logger;
}
```

**ä¿®æ”¹ GetBySlotAsync**ï¼š
```csharp
public async Task<List<GearDefinition>> GetBySlotAsync(
    SlotType slot, 
    CancellationToken ct = default)
{
    var enableCaching = _configuration.GetValue<bool>(
        "CacheConfiguration:GlobalSettings:EnableReadCaching", true);
    
    if (enableCaching && _memoryManager != null)
    {
        // ä»ç¼“å­˜ä¸­ç­›é€‰
        var allCached = _memoryManager.GetAll();
        return allCached
            .Where(g => g.Slot == slot)
            .ToList();
    }
    else
    {
        // ç›´æ¥æŸ¥æ•°æ®åº“
        return await _db.GearDefinitions
            .Where(g => g.Slot == slot)
            .ToListAsync(ct);
    }
}
```

**æ·»åŠ  GetAll æ–¹æ³•åˆ° MemoryStateManager**ï¼š
```csharp
// åœ¨ MemoryStateManager<T> ä¸­æ·»åŠ ï¼š

/// <summary>
/// è·å–æ‰€æœ‰ç¼“å­˜çš„å®ä½“
/// Get all cached entities
/// </summary>
public IEnumerable<T> GetAll()
{
    return _store.Values.ToList();
}
```

#### Step 2: è¿ç§» AffixRepositoryï¼ˆ1-2å°æ—¶ï¼‰

ç±»ä¼¼ GearDefinitionRepository çš„ä¿®æ”¹æ¨¡å¼ã€‚

#### Step 3: è¿ç§» GearSetRepositoryï¼ˆ1å°æ—¶ï¼‰

ç±»ä¼¼ GearDefinitionRepository çš„ä¿®æ”¹æ¨¡å¼ã€‚

#### Step 4: ç¬¬ä¸€é˜¶æ®µæµ‹è¯•ï¼ˆ2-3å°æ—¶ï¼‰

**æµ‹è¯• 1: é¢„åŠ è½½éªŒè¯**

```csharp
[Fact]
public async Task GearDefinition_PreloadOnStartup_Success()
{
    // å¯åŠ¨æœåŠ¡
    var host = CreateTestHost();
    await host.StartAsync();
    
    // ç­‰å¾…é¢„åŠ è½½
    await Task.Delay(2000);
    
    // éªŒè¯
    var repo = host.Services.GetRequiredService<GearDefinitionRepository>();
    var allGear = await repo.GetAllAsync();
    
    Assert.True(allGear.Count > 0);
    
    // éªŒè¯ç¼“å­˜å‘½ä¸­ç‡
    var manager = host.Services.GetRequiredService<
        IMemoryStateManager<GearDefinition>>();
    var stats = manager.GetCacheStatistics();
    Assert.Equal(stats.CachedCount, allGear.Count);
    
    await host.StopAsync();
}
```

**æµ‹è¯• 2: ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•**

```csharp
[Fact]
public async Task GearDefinition_GetAsync_CacheHitRate100Percent()
{
    var repo = CreateRepository();
    var id = Guid.NewGuid(); // å‡è®¾å­˜åœ¨
    
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼šæœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
    var gear1 = await repo.GetAsync(id);
    Assert.NotNull(gear1);
    
    // ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼šåº”è¯¥å‘½ä¸­ç¼“å­˜
    var gear2 = await repo.GetAsync(id);
    Assert.NotNull(gear2);
    
    // éªŒè¯å‘½ä¸­ç‡
    var manager = GetMemoryManager();
    var hitRate = manager.GetCacheHitRate();
    Assert.Equal(0.5, hitRate); // 1 hit, 1 miss = 50%
    
    // ç¬¬ä¸‰æ¬¡æŸ¥è¯¢
    var gear3 = await repo.GetAsync(id);
    hitRate = manager.GetCacheHitRate();
    Assert.True(hitRate > 0.6); // 2 hit, 1 miss = 66.7%
}
```

**æµ‹è¯• 3: æ€§èƒ½æµ‹è¯•**

```csharp
[Fact]
public async Task GearDefinition_GetAsync_PerformanceUnder1ms()
{
    var repo = CreateRepository();
    var id = Guid.NewGuid();
    
    // é¢„çƒ­ï¼šåŠ è½½åˆ°ç¼“å­˜
    await repo.GetAsync(id);
    
    // æ€§èƒ½æµ‹è¯•
    var sw = Stopwatch.StartNew();
    for (int i = 0; i < 1000; i++)
    {
        await repo.GetAsync(id);
    }
    sw.Stop();
    
    var avgMs = sw.ElapsedMilliseconds / 1000.0;
    Assert.True(avgMs < 1.0, $"å¹³å‡æŸ¥è¯¢æ—¶é—´ {avgMs}ms è¶…è¿‡ 1ms");
}
```

---

### ç¬¬äºŒé˜¶æ®µå®æ–½ï¼ˆ2-3å¤©ï¼‰

#### Step 1: è¿ç§» CharacterRepositoryï¼ˆ2-3å°æ—¶ï¼‰

**æ–‡ä»¶**ï¼š`Infrastructure/Persistence/Repositories/CharacterRepository.cs`

**å½“å‰ä»£ç **ï¼š
```csharp
public Task<Character?> GetAsync(Guid id, CancellationToken ct = default) =>
    _db.Characters.FirstOrDefaultAsync(c => c.Id == id, ct);
```

**ä¿®æ”¹ä¸º**ï¼š
```csharp
/// <summary>
/// è·å–è§’è‰²ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
/// Get character (with caching)
/// </summary>
public async Task<Character?> GetAsync(Guid id, CancellationToken ct = default)
{
    var enableCaching = _configuration.GetValue<bool>(
        "CacheConfiguration:GlobalSettings:EnableReadCaching", true);
    
    if (enableCaching && _memoryManager != null)
    {
        // æ³¨æ„ï¼šè§’è‰²æ•°æ®å·²åœ¨å†™å…¥æ—¶ä½¿ç”¨ MemoryStateManager
        // è¿™é‡Œè¯»å–æ—¶ä¹Ÿä½¿ç”¨åŒä¸€ä¸ª MemoryStateManager
        // ç¡®ä¿è¯»å†™å…±äº«åŒä¸€ä»½å†…å­˜æ•°æ®
        return await _memoryManager.TryGetAsync(
            id,
            async (id, ct) => await _db.Characters
                .FirstOrDefaultAsync(c => c.Id == id, ct),
            ct
        );
    }
    else
    {
        return await _db.Characters
            .FirstOrDefaultAsync(c => c.Id == id, ct);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä½¿ç”¨å·²å­˜åœ¨çš„ `IMemoryStateManager<Character>`ï¼ˆå†™å…¥ä¼˜åŒ–æ—¶å·²æ³¨å†Œï¼‰
- âœ… è¯»å†™å…±äº«åŒä¸€ä»½å†…å­˜æ•°æ®
- âœ… ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

#### Step 2: è¿ç§» GearInstanceRepositoryï¼ˆ4-6å°æ—¶ï¼‰

**æŒ‘æˆ˜**ï¼šå¤„ç†å¤æ‚çš„ Include æŸ¥è¯¢

**å½“å‰ä»£ç **ï¼š
```csharp
public async Task<List<GearInstance>> GetByCharacterIdAsync(
    Guid characterId, 
    CancellationToken ct = default)
{
    return await _db.GearInstances
        .Include(g => g.Definition)
        .Include(g => g.Affixes)
        .Where(g => g.CharacterId == characterId)
        .ToListAsync(ct);
}
```

**ä¼˜åŒ–ç­–ç•¥**ï¼šåˆ†æ­¥æŸ¥è¯¢ + ç¼“å­˜

**ä¿®æ”¹ä¸º**ï¼š
```csharp
/// <summary>
/// è·å–è§’è‰²çš„æ‰€æœ‰è£…å¤‡ï¼ˆä¼˜åŒ–ï¼šåˆ†æ­¥æŸ¥è¯¢ + ç¼“å­˜ï¼‰
/// Get all gear instances for a character (optimized: step-by-step + caching)
/// </summary>
public async Task<List<GearInstance>> GetByCharacterIdAsync(
    Guid characterId, 
    CancellationToken ct = default)
{
    var enableCaching = _configuration.GetValue<bool>(
        "CacheConfiguration:GlobalSettings:EnableReadCaching", true);
    
    if (enableCaching && _memoryManager != null)
    {
        // 1. æŸ¥è¯¢æ‰€æœ‰è£…å¤‡å®ä¾‹ï¼ˆä»ç¼“å­˜æˆ–æ•°æ®åº“ï¼‰
        var gearInstances = await GetGearInstancesFromCacheOrDbAsync(
            characterId, ct);
        
        // 2. æ‰¹é‡åŠ è½½å…³è”æ•°æ®ï¼ˆDefinition å’Œ Affixesï¼‰
        await LoadRelatedDataAsync(gearInstances, ct);
        
        return gearInstances;
    }
    else
    {
        // å›é€€ï¼šä½¿ç”¨åŸæœ‰çš„ Include æŸ¥è¯¢
        return await _db.GearInstances
            .Include(g => g.Definition)
            .Include(g => g.Affixes)
            .Where(g => g.CharacterId == characterId)
            .ToListAsync(ct);
    }
}

/// <summary>
/// ä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–è£…å¤‡å®ä¾‹
/// Get gear instances from cache or database
/// </summary>
private async Task<List<GearInstance>> GetGearInstancesFromCacheOrDbAsync(
    Guid characterId, 
    CancellationToken ct)
{
    // å°è¯•ä»ç¼“å­˜è·å–æ‰€æœ‰è£…å¤‡å®ä¾‹
    var allCached = _memoryManager!.GetAll();
    var cachedForCharacter = allCached
        .Where(g => g.CharacterId == characterId)
        .ToList();
    
    if (cachedForCharacter.Any())
    {
        // å‘½ä¸­ç¼“å­˜
        return cachedForCharacter;
    }
    
    // æœªå‘½ä¸­ï¼šä»æ•°æ®åº“åŠ è½½
    var fromDb = await _db.GearInstances
        .Where(g => g.CharacterId == characterId)
        .ToListAsync(ct);
    
    // åŠ è½½åˆ°ç¼“å­˜
    foreach (var gear in fromDb)
    {
        _memoryManager.Add(gear);
    }
    
    return fromDb;
}

/// <summary>
/// åŠ è½½å…³è”æ•°æ®ï¼ˆDefinition å’Œ Affixesï¼‰
/// Load related data (Definition and Affixes)
/// </summary>
private async Task LoadRelatedDataAsync(
    List<GearInstance> gearInstances, 
    CancellationToken ct)
{
    // åŠ è½½ Definitionï¼ˆä» GearDefinition ç¼“å­˜ï¼‰
    var gearDefRepo = _serviceProvider.GetRequiredService<
        IGearDefinitionRepository>();
    
    foreach (var gear in gearInstances)
    {
        if (gear.DefinitionId != Guid.Empty)
        {
            gear.Definition = await gearDefRepo.GetAsync(
                gear.DefinitionId, ct);
        }
    }
    
    // åŠ è½½ Affixesï¼ˆä» Affix ç¼“å­˜ï¼‰
    var affixRepo = _serviceProvider.GetRequiredService<
        IAffixRepository>();
    
    // TODO: å®ç° Affix å…³è”åŠ è½½
    // éœ€è¦ä¸€ä¸ªæ˜ å°„è¡¨ï¼šGearInstance -> Affixes
}
```

**æ³¨æ„**ï¼š
- âš ï¸ éœ€è¦å¤„ç† Affix çš„å¤šå¯¹å¤šå…³ç³»
- âš ï¸ å¯èƒ½éœ€è¦ç¼“å­˜å…³è”è¡¨ï¼ˆGearInstanceAffixesï¼‰

#### Step 3: ç¬¬äºŒé˜¶æ®µæµ‹è¯•ï¼ˆ3-4å°æ—¶ï¼‰

**æµ‹è¯• 1: è¯»å†™ä¸€è‡´æ€§æµ‹è¯•**

```csharp
[Fact]
public async Task Character_ReadWriteConsistency()
{
    var repo = CreateRepository();
    var character = new Character 
    { 
        Id = Guid.NewGuid(), 
        Name = "TestChar",
        Level = 10
    };
    
    // å†™å…¥ï¼ˆåº”è¯¥æ›´æ–°å†…å­˜ï¼‰
    await repo.AddAsync(character);
    
    // ç«‹å³è¯»å–ï¼ˆåº”è¯¥ä»å†…å­˜è¯»åˆ°æœ€æ–°æ•°æ®ï¼‰
    var retrieved = await repo.GetAsync(character.Id);
    
    Assert.NotNull(retrieved);
    Assert.Equal(character.Name, retrieved.Name);
    Assert.Equal(character.Level, retrieved.Level);
    
    // æ›´æ–°
    character.Level = 20;
    await repo.UpdateAsync(character);
    
    // å†æ¬¡è¯»å–ï¼ˆåº”è¯¥è¯»åˆ°æ›´æ–°åçš„æ•°æ®ï¼‰
    var updated = await repo.GetAsync(character.Id);
    Assert.Equal(20, updated.Level);
}
```

**æµ‹è¯• 2: ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•**

```csharp
[Fact]
public async Task Character_CacheHitRate_Above80Percent()
{
    var repo = CreateRepository();
    var characterId = Guid.NewGuid();
    
    // æ¨¡æ‹Ÿ 100 æ¬¡æŸ¥è¯¢
    for (int i = 0; i < 100; i++)
    {
        await repo.GetAsync(characterId);
    }
    
    // éªŒè¯å‘½ä¸­ç‡
    var manager = GetMemoryManager();
    var hitRate = manager.GetCacheHitRate();
    
    Assert.True(hitRate >= 0.8, 
        $"ç¼“å­˜å‘½ä¸­ç‡ {hitRate:P} ä½äº 80%");
}
```

---

### ç¬¬ä¸‰é˜¶æ®µå®æ–½ï¼ˆ1-2å¤©ï¼‰

#### Step 1: è¿ç§» ActivityPlanRepositoryï¼ˆ2-3å°æ—¶ï¼‰

**æ–‡ä»¶**ï¼š`Infrastructure/Persistence/Repositories/ActivityPlanRepository.cs`

**å…³é”®ç‚¹**ï¼š
- âœ… æ´»åŠ¨è®¡åˆ’å·²åœ¨å†™å…¥æ—¶ä½¿ç”¨ MemoryStateManager
- âœ… è¯»å–æ—¶ä¹Ÿä½¿ç”¨åŒä¸€ä¸ª MemoryStateManager
- âœ… ç¡®ä¿é¢‘ç¹æ›´æ–°çš„æ•°æ®è¯»åˆ°æœ€æ–°

**ä¿®æ”¹ GetAsync**ï¼š
```csharp
public async Task<ActivityPlan?> GetAsync(Guid id, CancellationToken ct = default)
{
    var enableCaching = _configuration.GetValue<bool>(
        "CacheConfiguration:GlobalSettings:EnableReadCaching", true);
    
    if (enableCaching && _memoryStateManager != null)
    {
        // ä½¿ç”¨å·²æœ‰çš„ MemoryStateManagerï¼ˆå†™å…¥ä¼˜åŒ–æ—¶å·²æ³¨å†Œï¼‰
        return await _memoryStateManager.TryGetAsync(
            id,
            async (id, ct) => await _db.ActivityPlans
                .FirstOrDefaultAsync(p => p.Id == id, ct),
            ct
        );
    }
    else
    {
        return await _db.ActivityPlans
            .FirstOrDefaultAsync(p => p.Id == id, ct);
    }
}
```

**ä¿®æ”¹ GetByCharacterIdAsync**ï¼š
```csharp
public async Task<List<ActivityPlan>> GetByCharacterIdAsync(
    Guid characterId, 
    CancellationToken ct = default)
{
    var enableCaching = _configuration.GetValue<bool>(
        "CacheConfiguration:GlobalSettings:EnableReadCaching", true);
    
    if (enableCaching && _memoryStateManager != null)
    {
        // ä»ç¼“å­˜ç­›é€‰
        var allCached = _memoryStateManager.GetAll();
        return allCached
            .Where(p => p.CharacterId == characterId)
            .ToList();
    }
    else
    {
        return await _db.ActivityPlans
            .Where(p => p.CharacterId == characterId)
            .ToListAsync(ct);
    }
}
```

#### Step 2: è¿ç§»æˆ˜æ–—å¿«ç…§è¯»å–ï¼ˆ1-2å°æ—¶ï¼‰

**æ–‡ä»¶**ï¼š`Application/Battles/Step/StepBattleSnapshotService.cs`

**å½“å‰ä»£ç **ï¼š
```csharp
public async Task<RunningBattleSnapshotRecord?> LoadAsync(
    Guid characterId, 
    CancellationToken ct = default)
{
    return await _db.RunningBattleSnapshots
        .FirstOrDefaultAsync(s => s.CharacterId == characterId, ct);
}
```

**ä¿®æ”¹ä¸º**ï¼š
```csharp
public async Task<RunningBattleSnapshotRecord?> LoadAsync(
    Guid characterId, 
    CancellationToken ct = default)
{
    var enableCaching = _configuration.GetValue<bool>(
        "CacheConfiguration:GlobalSettings:EnableReadCaching", true);
    
    if (enableCaching && _snapshotManager != null)
    {
        // ä»ç¼“å­˜æŸ¥æ‰¾
        var allCached = _snapshotManager.GetAll();
        var cached = allCached
            .FirstOrDefault(s => s.CharacterId == characterId);
        
        if (cached != null)
        {
            _logger?.LogDebug(
                "æˆ˜æ–—å¿«ç…§ç¼“å­˜å‘½ä¸­: CharacterId={CharacterId}",
                characterId
            );
            return cached;
        }
        
        // æœªå‘½ä¸­ï¼šæŸ¥æ•°æ®åº“å¹¶åŠ è½½åˆ°ç¼“å­˜
        var fromDb = await _db.RunningBattleSnapshots
            .FirstOrDefaultAsync(s => s.CharacterId == characterId, ct);
        
        if (fromDb != null)
        {
            _snapshotManager.Add(fromDb);
        }
        
        return fromDb;
    }
    else
    {
        return await _db.RunningBattleSnapshots
            .FirstOrDefaultAsync(s => s.CharacterId == characterId, ct);
    }
}
```

#### Step 3: ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•ï¼ˆ2-3å°æ—¶ï¼‰

**æµ‹è¯• 1: æ´»åŠ¨çŠ¶æ€ä¸€è‡´æ€§æµ‹è¯•**

```csharp
[Fact]
public async Task ActivityPlan_StateUpdateConsistency()
{
    var repo = CreateRepository();
    var plan = new ActivityPlan
    {
        Id = Guid.NewGuid(),
        CharacterId = Guid.NewGuid(),
        State = ActivityPlanState.Pending
    };
    
    // æ·»åŠ 
    await repo.AddAsync(plan);
    
    // æ›´æ–°çŠ¶æ€
    plan.State = ActivityPlanState.Running;
    await repo.UpdateAsync(plan);
    
    // è¯»å–ï¼ˆåº”è¯¥æ˜¯æœ€æ–°çŠ¶æ€ï¼‰
    var retrieved = await repo.GetAsync(plan.Id);
    Assert.Equal(ActivityPlanState.Running, retrieved.State);
}
```

**æµ‹è¯• 2: æˆ˜æ–—å¿«ç…§æ¢å¤æµ‹è¯•**

```csharp
[Fact]
public async Task BattleSnapshot_LoadAndRestore()
{
    var service = CreateSnapshotService();
    var characterId = Guid.NewGuid();
    
    // ä¿å­˜å¿«ç…§
    var snapshot = new RunningBattleSnapshotRecord
    {
        CharacterId = characterId,
        // ... å…¶ä»–å­—æ®µ
    };
    await service.SaveAsync(snapshot);
    
    // åŠ è½½å¿«ç…§ï¼ˆåº”è¯¥ä»ç¼“å­˜è¯»å–ï¼‰
    var loaded = await service.LoadAsync(characterId);
    
    Assert.NotNull(loaded);
    Assert.Equal(characterId, loaded.CharacterId);
}
```

---

## æ•°æ®ä¸€è‡´æ€§ä¿è¯

### ä¸€è‡´æ€§æ£€æŸ¥æ¸…å•

- [ ] **å†™å…¥æ—¶åŒæ­¥æ›´æ–°å†…å­˜**ï¼šæ‰€æœ‰ Repository çš„ UpdateAsync æ–¹æ³•éƒ½åŒæ­¥æ›´æ–° MemoryStateManager
- [ ] **è¯»å–æ—¶ä¼˜å…ˆå†…å­˜**ï¼šæ‰€æœ‰ Repository çš„ GetAsync æ–¹æ³•éƒ½ä¼˜å…ˆæŸ¥å†…å­˜
- [ ] **Dirty æ•°æ®ä¼˜å…ˆ**ï¼šMemoryStateManager è¿”å›æœªä¿å­˜çš„æœ€æ–°æ•°æ®
- [ ] **æ‰¹é‡ä¿å­˜ä¸å½±å“è¯»å–**ï¼šPersistenceCoordinator ä¿å­˜æ—¶ï¼Œå†…å­˜æ•°æ®å·²æ˜¯æœ€æ–°
- [ ] **æµ‹è¯•è¦†ç›–**ï¼šæ¯ä¸ªè¿ç§»çš„å®ä½“éƒ½æœ‰è¯»å†™ä¸€è‡´æ€§æµ‹è¯•

### ä¸€è‡´æ€§æµ‹è¯•æ¨¡æ¿

```csharp
[Fact]
public async Task EntityType_ReadWriteConsistency_Template()
{
    // 1. å†™å…¥æ–°æ•°æ®
    var entity = CreateTestEntity();
    await repo.AddAsync(entity);
    
    // 2. ç«‹å³è¯»å–ï¼ˆéªŒè¯å†™å…¥æˆåŠŸï¼‰
    var retrieved = await repo.GetAsync(entity.Id);
    Assert.NotNull(retrieved);
    AssertEqual(entity, retrieved);
    
    // 3. æ›´æ–°æ•°æ®
    UpdateEntity(entity);
    await repo.UpdateAsync(entity);
    
    // 4. å†æ¬¡è¯»å–ï¼ˆéªŒè¯æ›´æ–°æˆåŠŸï¼‰
    var updated = await repo.GetAsync(entity.Id);
    AssertEqual(entity, updated);
    
    // 5. è§¦å‘æ‰¹é‡ä¿å­˜ï¼ˆæ¨¡æ‹Ÿ PersistenceCoordinatorï¼‰
    await TriggerBatchSaveAsync();
    
    // 6. æ¸…ç©ºç¼“å­˜ï¼ˆæ¨¡æ‹ŸæœåŠ¡é‡å¯ï¼‰
    ClearCache();
    
    // 7. ä»æ•°æ®åº“è¯»å–ï¼ˆéªŒè¯å·²ä¿å­˜ï¼‰
    var fromDb = await repo.GetAsync(entity.Id);
    AssertEqual(entity, fromDb);
}
```

---

## æµ‹è¯•éªŒè¯

### ç»¼åˆæµ‹è¯•è®¡åˆ’

#### åŠŸèƒ½æµ‹è¯•

1. **ç¼“å­˜è¯»å–åŠŸèƒ½æµ‹è¯•**
   - [ ] é¦–æ¬¡æŸ¥è¯¢ä»æ•°æ®åº“åŠ è½½
   - [ ] äºŒæ¬¡æŸ¥è¯¢ä»ç¼“å­˜è¯»å–
   - [ ] ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡æ­£ç¡®

2. **è¯»å†™ä¸€è‡´æ€§æµ‹è¯•**
   - [ ] å†™å…¥åç«‹å³è¯»å–åˆ°æœ€æ–°æ•°æ®
   - [ ] æ›´æ–°åç«‹å³è¯»å–åˆ°æ›´æ–°æ•°æ®
   - [ ] æ‰¹é‡ä¿å­˜ä¸å½±å“ä¸€è‡´æ€§

3. **å…³è”æŸ¥è¯¢æµ‹è¯•**
   - [ ] Include æŸ¥è¯¢æ­£ç¡®åŠ è½½å…³è”æ•°æ®
   - [ ] å…³è”æ•°æ®ä¹Ÿä»ç¼“å­˜è¯»å–
   - [ ] æ€§èƒ½ä¸é™ä½

#### æ€§èƒ½æµ‹è¯•

1. **å“åº”æ—¶é—´æµ‹è¯•**
   - [ ] ç¼“å­˜å‘½ä¸­ï¼š<1ms
   - [ ] ç¼“å­˜æœªå‘½ä¸­ï¼š5-50msï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰

2. **ååé‡æµ‹è¯•**
   - [ ] 100 å¹¶å‘è¯·æ±‚/ç§’
   - [ ] å†…å­˜ä½¿ç”¨ç¨³å®š

3. **ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•**
   - [ ] é™æ€æ•°æ®ï¼š95-100%
   - [ ] ç”¨æˆ·æ•°æ®ï¼š80-90%
   - [ ] æ´»åŠ¨æ•°æ®ï¼š70-85%

#### å‹åŠ›æµ‹è¯•

1. **é«˜è´Ÿè½½æµ‹è¯•**
   - [ ] 100 ä¸ªåœ¨çº¿ç”¨æˆ·
   - [ ] æŒç»­è¿è¡Œ 1 å°æ—¶
   - [ ] æ— å†…å­˜æ³„æ¼

2. **å¹¶å‘æµ‹è¯•**
   - [ ] 10 ä¸ªå¹¶å‘æˆ˜æ–—
   - [ ] æ— æ•°æ®ç«äº‰
   - [ ] æ— æ­»é”

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§

- [ ] ç¬¬ä¸€é˜¶æ®µï¼š3 ä¸ª Repository è¿ç§»å®Œæˆï¼ˆGearDefinition, Affix, GearSetï¼‰
- [ ] ç¬¬äºŒé˜¶æ®µï¼š2 ä¸ª Repository è¿ç§»å®Œæˆï¼ˆCharacter, GearInstanceï¼‰
- [ ] ç¬¬ä¸‰é˜¶æ®µï¼š2 ä¸ªæ¨¡å—è¿ç§»å®Œæˆï¼ˆActivityPlan, BattleSnapshotï¼‰
- [ ] æ‰€æœ‰è¿ç§»ä¿ç•™é…ç½®å¼€å…³ï¼ˆå¯å›é€€ï¼‰
- [ ] æ‰€æœ‰è¿ç§»ä¸æ”¹å˜ Repository æ¥å£

### æ€§èƒ½æŒ‡æ ‡

- [ ] ç¼“å­˜å‘½ä¸­ç‡ï¼šé™æ€æ•°æ® >95%, ç”¨æˆ·æ•°æ® >80%, æ´»åŠ¨æ•°æ® >70%
- [ ] æ•°æ®åº“è¯»å–å‡å°‘ >85%
- [ ] API å“åº”æ—¶é—´æ”¹å–„ >30%
- [ ] å†…å­˜å¢åŠ  <200MB

### ä»£ç è´¨é‡

- [ ] ç¼–è¯‘æˆåŠŸï¼Œé›¶é”™è¯¯
- [ ] æ‰€æœ‰ä»£ç æœ‰è¯¦ç»†æ³¨é‡Š
- [ ] éµå¾ªé¡¹ç›®å‘½åè§„èŒƒ
- [ ] é€šè¿‡ä»£ç å®¡æŸ¥

### æµ‹è¯•è¦†ç›–

- [ ] æ¯ä¸ªè¿ç§»çš„å®ä½“æœ‰å•å…ƒæµ‹è¯•ï¼ˆè‡³å°‘ 3 ä¸ªæµ‹è¯•ï¼‰
- [ ] è¯»å†™ä¸€è‡´æ€§æµ‹è¯•ï¼ˆæ¯ä¸ªå®ä½“ 1 ä¸ªï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆæ¯ä¸ªé˜¶æ®µ 1 ä¸ªï¼‰
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆæ•´ä½“ 1 ä¸ªï¼‰
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

### æ–‡æ¡£å®Œæ•´æ€§

- [ ] æœ¬å®æ–½æ–¹æ¡ˆæ–‡æ¡£
- [ ] ä»£ç æ³¨é‡Šå®Œæ•´
- [ ] æµ‹è¯•æ–‡æ¡£
- [ ] å›é€€æµç¨‹æ–‡æ¡£

---

## é£é™©å’Œå›é€€è®¡åˆ’

### å›é€€æœºåˆ¶

**é…ç½®å›é€€**ï¼š
```json
{
  "CacheConfiguration": {
    "GlobalSettings": {
      "EnableReadCaching": false  // è®¾ä¸º false ç«‹å³å›é€€
    }
  }
}
```

**ä»£ç å›é€€**ï¼š
```csharp
// Repository ä¸­éƒ½ä¿ç•™äº†å›é€€é€»è¾‘
if (enableCaching && _memoryManager != null)
{
    // ä½¿ç”¨ç¼“å­˜
}
else
{
    // å›é€€ï¼šç›´æ¥æŸ¥æ•°æ®åº“
}
```

### é—®é¢˜å¤„ç†æµç¨‹

1. **å‘ç°é—®é¢˜** â†’ è¯„ä¼°ä¸¥é‡ç¨‹åº¦
2. **ä¸¥é‡é—®é¢˜**ï¼ˆæ•°æ®ä¸ä¸€è‡´ã€åŠŸèƒ½å¼‚å¸¸ï¼‰â†’ ç«‹å³é…ç½®å›é€€
3. **è½»å¾®é—®é¢˜**ï¼ˆæ€§èƒ½ä¸è¾¾æ ‡ï¼‰â†’ è°ƒæ•´é…ç½®å‚æ•°
4. **ä¿®å¤ä»£ç ** â†’ æµ‹è¯•éªŒè¯ â†’ é‡æ–°éƒ¨ç½²

---

## åç»­æ­¥éª¤

å®Œæˆ Phase 2 åï¼Œè¿›å…¥ **ä¸‹ç¯‡ - ä¼˜åŒ–ã€ç›‘æ§å’ŒéªŒæ”¶**ã€‚

---

**é˜¶æ®µçŠ¶æ€**ï¼šâ³ å¾…å®æ–½  
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š4-6 å¤©  
**è´£ä»»äºº**ï¼šå¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**ï¼š2025-10-18
