# BlazorIdle 装备系统优化方案

**项目**: BlazorIdle  
**文档类型**: 设计方案  
**创建日期**: 2025-10-10  
**版本**: 1.0  
**状态**: 设计阶段

---

## 📋 目录

1. [当前状态分析](#1-当前状态分析)
2. [设计目标与原则](#2-设计目标与原则)
3. [装备系统架构设计](#3-装备系统架构设计)
4. [详细执行步骤](#4-详细执行步骤)
5. [数据模型设计](#5-数据模型设计)
6. [与现有系统的集成](#6-与现有系统的集成)
7. [技术实现要点](#7-技术实现要点)
8. [风险与挑战](#8-风险与挑战)

---

## 1. 当前状态分析

### 1.1 已完成的工作

根据项目文档分析，装备系统UI框架已在 **Step 5** 完成：

#### ✅ 已实现部分

1. **前端UI框架** (`EquipmentPanel.razor`)
   - 9个装备槽位UI（头盔/武器/胸甲/副手/腰带/腿部/鞋子/饰品1/饰品2）
   - 总属性展示面板
   - 品质颜色系统（普通/稀有/史诗/传说）
   - 装备槽位布局（3x3网格）

2. **数据模型定义** (`ApiModels.cs`)
   - `EquipmentResponse`: 装备栏响应
   - `EquipmentSlotDto`: 装备槽
   - `GearInstanceDto`: 装备实例
   - `AffixDto`: 装备词条

3. **API接口预留** (`EquipmentController.cs`)
   - `GET /api/equipment/{characterId}` - 获取装备栏（返回空槽）
   - `POST /api/equipment/{characterId}/{slot}` - 装备物品（返回501）
   - `DELETE /api/equipment/{characterId}/{slot}` - 卸下装备（返回501）
   - `GET /api/equipment/{characterId}/stats` - 获取装备属性（返回零属性）

4. **测试覆盖**
   - 18个单元测试全部通过
   - 覆盖槽位类型、品质、属性等核心功能

#### ❌ 缺失部分

根据《整合设计总结.txt》第13节和现有代码分析：

1. **领域模型层**
   - ❌ 装备定义表（GearDefinition）
   - ❌ 装备实例表（GearInstance）
   - ❌ 装备词条系统（Affix）
   - ❌ 套装系统（GearSet）

2. **核心功能**
   - ❌ 装备生成逻辑（品质/Tier/词条随机）
   - ❌ 装备掉落系统（集成到Economy）
   - ❌ 装备/卸下操作
   - ❌ 装备属性计算与汇总
   - ❌ 装备对比功能

3. **增强功能**
   - ❌ 装备分解（DisenchantService）
   - ❌ 装备重铸（品级提升）
   - ❌ 词条重置（Reroll Affixes）
   - ❌ 套装效果计算

4. **战斗集成**
   - ❌ 装备属性注入到 CharacterStats
   - ❌ 装备属性参与战斗计算
   - ❌ 装备特效/触发技能

### 1.2 现有系统能力评估

#### 可复用的系统

1. **经济系统** (`Domain/Combat/Economy/`)
   - ✅ `EconomyRegistry`: 物品注册中心
   - ✅ `LootTable`: 掉落表系统
   - ✅ `EconomyCalculator`: 掉落计算器
   - ✅ `RewardGrantService`: 奖励发放服务
   - ✅ `InventoryItem`: 背包物品表
   - **可扩展**: 将装备作为特殊物品类型集成

2. **战斗系统** (`Domain/Combat/`)
   - ✅ `CharacterStats`: 角色属性（攻击/暴击/急速/穿透）
   - ✅ `PlayerCombatant`: 玩家战斗单位
   - ✅ `StatsBuilder`: 属性构建器
   - ✅ `BuffManager`: Buff管理（可用于套装效果）
   - **需集成**: 装备属性计算注入到属性构建流程

3. **角色系统** (`Domain/Characters/`)
   - ✅ `Character`: 角色实体（主属性/等级/职业）
   - ✅ `PrimaryAttributes`: 主属性（力量/敏捷/智力/耐力）
   - ✅ `ProfessionBaseStatsRegistry`: 职业基础属性
   - **需扩展**: 关联装备实例

4. **数据持久化** (`Infrastructure/Persistence/`)
   - ✅ `GameDbContext`: EF Core 数据库上下文
   - ✅ 配置类模式（`*Configuration.cs`）
   - ✅ 迁移机制
   - **需添加**: 装备相关表配置

### 1.3 设计参考

根据《整合设计总结.txt》第13节：

```
## 13. 装备与物品生态（品级 / 词条 / 套装 / 分解 / 重铸）

| 设计点 | 内容 |
|--------|------|
| GearDefinition | 基础属性范围 / 允许词条池 / slot / 稀有度权重 |
| GearInstance | defId + tier(T1/T2/T3) + affixes[] + setId + qualityScore |
| Tier 系数 | T1=0.8 / T2=1.0 / T3=1.2（可配置） |
| Affix | id, type (Flat/Percent/Proc), rollRange, rarityWeight |
| 套装 | setId + pieceBonuses + activeCount |
| 分解 (Disenchant) | 输入：装备 → 材料（按 tier/rarity） |
| 品级重铸 (ReforgeTier) | 消耗：材料+金币 → +Tier |
| 词条重置 (Reroll) | 重生成 affixes；成本递增 / 保底机制 |
| 词条重铸 (Refine Future) | 精炼指定 affix 小幅提升 |
| 装备技能/特效 | 特殊标签：在事件钩子 (OnHit/OnCast) 注册 |

数值管线 (防膨胀)：  
final = clamp(((base + ΣAdditive) * Π(1+Mult)) + ΣFinalAdd)  
限制：Mult 源数控制；攻速下限；暴击上限。
```

---

## 2. 设计目标与原则

### 2.1 核心目标

1. **完善服务端装备功能**
   - 实现装备生成、掉落、装备/卸下、属性计算
   - 集成到战斗系统和经济系统
   - 支持装备增强（分解/重铸/词条重置）

2. **实现前端装备管理**
   - 完善装备面板功能
   - 实现装备对比、筛选、排序
   - 提供直观的装备操作界面

3. **保持系统一致性**
   - 遵循现有代码风格
   - 复用现有系统能力
   - 保持数据驱动设计
   - 维护向后兼容性

### 2.2 设计原则

根据《整合设计总结.txt》第3节架构原则：

1. **服务端权威** (Server Authoritative)
   - 所有装备操作在服务端验证
   - 装备属性计算在服务端完成
   - 防止客户端作弊

2. **数据驱动** (Data-Driven)
   - 装备定义配置化（JSON/数据表）
   - 词条池、掉落表配置化
   - 便于平衡调整和内容扩展

3. **领域驱动设计** (DDD)
   - 清晰的领域边界（Equipment / Economy / Combat）
   - 聚合根模式（GearInstance 作为聚合根）
   - 领域事件传播（EquipmentChanged / StatsRecalculated）

4. **可测试性** (Testability)
   - 单元测试覆盖核心逻辑
   - 可注入依赖（RNG / Repository）
   - 幂等性保证

5. **性能优化**
   - 属性计算缓存
   - 懒加载装备数据
   - 批量操作支持

6. **安全性**
   - 装备操作限频
   - 交易验证（防止刷装备）
   - 装备绑定机制

---

## 3. 装备系统架构设计

### 3.1 模块划分

```
BlazorIdle.Server/Domain/Equipment/
├── Models/
│   ├── GearDefinition.cs          # 装备定义（配置）
│   ├── GearInstance.cs            # 装备实例（运行时）
│   ├── Affix.cs                   # 词条定义
│   ├── AffixInstance.cs           # 词条实例
│   ├── GearSet.cs                 # 套装定义
│   └── EquipmentSlot.cs           # 装备槽枚举
│
├── Services/
│   ├── GearGenerationService.cs   # 装备生成服务
│   ├── EquipmentService.cs        # 装备管理服务
│   ├── StatsAggregationService.cs # 属性聚合服务
│   ├── DisenchantService.cs       # 分解服务
│   ├── ReforgeService.cs          # 重铸服务
│   └── SetBonusService.cs         # 套装加成服务
│
├── Repositories/
│   ├── IGearDefinitionRepository.cs
│   ├── IGearInstanceRepository.cs
│   └── IAffixRepository.cs
│
└── ValueObjects/
    ├── StatModifier.cs            # 属性修饰符
    ├── TierLevel.cs               # 品级
    └── Rarity.cs                  # 稀有度
```

### 3.2 核心领域模型

#### 装备定义 (GearDefinition)

```
GearDefinition (配置数据)
├── Id: string (唯一标识，如 "sword_iron")
├── Name: string (显示名称)
├── Icon: string (图标)
├── Slot: EquipmentSlot (装备槽位)
├── RequiredLevel: int (需求等级)
├── BaseStats: Dictionary<StatType, StatRange> (基础属性范围)
├── AllowedAffixPool: List<string> (允许的词条ID池)
├── RarityWeights: Dictionary<Rarity, double> (稀有度权重)
└── SetId: string? (套装ID)
```

#### 装备实例 (GearInstance)

```
GearInstance (运行时实例)
├── Id: Guid (实例ID)
├── DefinitionId: string (关联GearDefinition)
├── CharacterId: Guid? (所属角色，null表示在背包)
├── SlotType: EquipmentSlot? (装备位置，null表示未装备)
├── Rarity: Rarity (稀有度：Common/Rare/Epic/Legendary)
├── TierLevel: int (品级：1-3)
├── ItemLevel: int (物品等级)
├── RolledStats: Dictionary<StatType, double> (已roll的基础属性)
├── Affixes: List<AffixInstance> (词条列表)
├── QualityScore: int (装备评分)
├── IsEquipped: bool (是否已装备)
├── IsBound: bool (是否绑定)
├── CreatedAt: DateTime
└── UpdatedAt: DateTime
```

#### 词条实例 (AffixInstance)

```
AffixInstance
├── AffixId: string (词条定义ID)
├── StatType: StatType (影响的属性)
├── ModifierType: ModifierType (Flat/Percent/Proc)
├── RolledValue: double (已roll的数值)
└── DisplayText: string (显示文本，如 "+15 力量")
```

#### 套装定义 (GearSet)

```
GearSet
├── Id: string (套装ID)
├── Name: string (套装名称)
├── Pieces: List<string> (装备定义ID列表)
└── Bonuses: Dictionary<int, List<StatModifier>> (件数 -> 加成)
    例如: { 2: [+100 HP], 4: [+5% Crit], 6: [特殊效果] }
```

### 3.3 装备生成流程

```
装备生成流程 (GearGenerationService)
├── 1. 选择装备定义 (GearDefinition)
├── 2. 确定稀有度 (根据权重随机)
├── 3. 确定品级 (默认T1，后续可升级)
├── 4. 计算物品等级 (基于角色等级 + 稀有度加成)
├── 5. Roll基础属性 (在范围内随机，受Tier影响)
├── 6. 生成词条 (根据稀有度决定数量)
│   ├── Common: 0词条
│   ├── Rare: 1-2词条
│   ├── Epic: 2-3词条
│   └── Legendary: 3-4词条
├── 7. Roll词条数值 (在范围内随机)
├── 8. 计算装备评分 (QualityScore)
└── 9. 返回GearInstance
```

### 3.4 装备属性计算流程

```
属性聚合流程 (StatsAggregationService)
├── 1. 获取角色所有已装备的GearInstance
├── 2. 遍历每个装备
│   ├── 累加基础属性 (RolledStats)
│   └── 累加词条属性 (Affixes)
├── 3. 检查套装效果
│   ├── 统计每个套装的装备件数
│   └── 应用达成的套装加成
├── 4. 应用数值管线
│   └── final = clamp(((base + ΣAdditive) * Π(1+Mult)) + ΣFinalAdd)
└── 5. 返回EquipmentStats
```

### 3.5 与战斗系统集成

```
战斗属性计算流程
├── StatsBuilder.BuildStats(character)
│   ├── 1. 主属性 -> 基础属性转换
│   │   └── Strength -> AttackPower
│   ├── 2. 职业基础属性加成
│   │   └── ProfessionBaseStatsRegistry
│   ├── 3. 【新增】装备属性注入
│   │   └── StatsAggregationService.CalculateEquipmentStats(characterId)
│   ├── 4. Buff属性加成
│   │   └── BuffManager.ApplyBuffModifiers()
│   └── 5. 返回最终CharacterStats
└── 传入战斗系统
```

---

## 4. 详细执行步骤

### Phase 1: 数据库与领域模型 (第1-2周)

#### 目标
建立装备系统的数据基础和领域模型

#### 任务清单

**Task 1.1: 创建数据库表**
- [ ] 创建 `GearDefinitions` 表（装备定义配置）
- [ ] 创建 `GearInstances` 表（装备实例）
- [ ] 创建 `AffixDefinitions` 表（词条定义）
- [ ] 创建 `GearSets` 表（套装定义）
- [ ] 创建数据库迁移

**Task 1.2: 实现领域模型**
- [ ] 创建 `Domain/Equipment/Models/` 目录
- [ ] 实现 `GearDefinition.cs`
- [ ] 实现 `GearInstance.cs`
- [ ] 实现 `Affix.cs` 和 `AffixInstance.cs`
- [ ] 实现 `GearSet.cs`
- [ ] 实现枚举类型 (`EquipmentSlot`, `Rarity`, `ModifierType`)

**Task 1.3: EF Core配置**
- [ ] 创建 `GearDefinitionConfiguration.cs`
- [ ] 创建 `GearInstanceConfiguration.cs`
- [ ] 创建 `AffixDefinitionConfiguration.cs`
- [ ] 创建 `GearSetConfiguration.cs`
- [ ] 更新 `GameDbContext.cs`

**Task 1.4: 初始化配置数据**
- [ ] 创建装备定义种子数据（剑/盾/护甲等）
- [ ] 创建词条定义种子数据（+力量/+暴击等）
- [ ] 创建套装定义种子数据（战士套装等）
- [ ] 实现数据迁移脚本

**验收标准**
- ✅ 数据库迁移成功执行
- ✅ 可以查询和持久化装备数据
- ✅ 种子数据正确加载
- ✅ 单元测试覆盖实体验证逻辑

---

### Phase 2: 装备生成与掉落系统 (第3-4周)

#### 目标
实现装备生成逻辑并集成到掉落系统

#### 任务清单

**Task 2.1: 装备生成服务**
- [ ] 创建 `GearGenerationService.cs`
- [ ] 实现稀有度随机算法（加权随机）
- [ ] 实现基础属性Roll算法（范围内随机）
- [ ] 实现词条生成算法
  - [ ] 根据稀有度决定词条数量
  - [ ] 从词条池随机选择
  - [ ] Roll词条数值
  - [ ] 防止重复词条
- [ ] 实现装备评分计算算法
- [ ] 实现品级系数应用

**Task 2.2: 装备注册到经济系统**
- [ ] 扩展 `EconomyRegistry` 支持装备物品类型
- [ ] 创建装备掉落表（LootTable）
  - [ ] 普通怪物掉落表（低稀有度装备）
  - [ ] 精英怪物掉落表（高稀有度装备）
  - [ ] Boss掉落表（传说装备）
- [ ] 更新 `LootEntry` 支持装备生成参数

**Task 2.3: 集成到战斗奖励**
- [ ] 修改 `EconomyCalculator` 处理装备掉落
- [ ] 修改 `RewardGrantService` 创建装备实例
- [ ] 装备掉落写入背包（InventoryItem关联）
- [ ] 实现装备掉落通知

**Task 2.4: RNG控制**
- [ ] 使用 `RNGContext` 保证装备生成可回放
- [ ] 记录装备生成种子
- [ ] 实现保底机制（连续N次未掉落稀有装备时提升概率）

**验收标准**
- ✅ 能生成各稀有度的装备
- ✅ 装备属性在合理范围内
- ✅ 词条生成符合规则
- ✅ 装备正确写入背包
- ✅ 单元测试覆盖生成逻辑

---

### Phase 3: 装备管理与操作 (第5-6周)

#### 目标
实现装备/卸下、属性计算等核心操作

#### 任务清单

**Task 3.1: 装备管理服务**
- [ ] 创建 `EquipmentService.cs`
- [ ] 实现 `EquipItem(characterId, gearInstanceId, slot)` 方法
  - [ ] 验证装备槽位匹配
  - [ ] 验证等级需求
  - [ ] 验证职业需求（如有）
  - [ ] 处理已有装备（自动卸下到背包）
  - [ ] 更新GearInstance的SlotType和IsEquipped
- [ ] 实现 `UnequipItem(characterId, slot)` 方法
  - [ ] 验证槽位有装备
  - [ ] 移除装备，放回背包
  - [ ] 更新GearInstance状态
- [ ] 实现 `GetEquippedGear(characterId)` 方法
- [ ] 实现 `SwapGear(characterId, slot, gearInstanceId)` 方法

**Task 3.2: 属性聚合服务**
- [ ] 创建 `StatsAggregationService.cs`
- [ ] 实现 `CalculateEquipmentStats(characterId)` 方法
  - [ ] 聚合所有装备的基础属性
  - [ ] 聚合所有词条属性
  - [ ] 应用数值管线（Additive -> Multiplicative -> FinalAdd）
  - [ ] 应用数值上限（暴击≤100%，急速≥-50%等）
- [ ] 实现属性缓存机制（装备变更时失效）

**Task 3.3: 套装加成服务**
- [ ] 创建 `SetBonusService.cs`
- [ ] 实现 `CalculateSetBonuses(equippedGear)` 方法
  - [ ] 统计每个套装的装备件数
  - [ ] 应用达成的套装加成
  - [ ] 返回套装属性加成
- [ ] 集成到属性聚合流程

**Task 3.4: 战斗系统集成**
- [ ] 修改 `StatsBuilder.BuildStats()` 注入装备属性
- [ ] 测试装备属性在战斗中生效
- [ ] 验证属性计算正确性

**Task 3.5: API实现**
- [ ] 更新 `EquipmentController.cs` 实现真实逻辑
  - [ ] `GET /api/equipment/{characterId}` 返回真实装备
  - [ ] `POST /api/equipment/{characterId}/{slot}` 装备物品
  - [ ] `DELETE /api/equipment/{characterId}/{slot}` 卸下装备
  - [ ] `GET /api/equipment/{characterId}/stats` 返回真实属性
- [ ] 添加错误处理和验证
- [ ] 添加操作日志

**验收标准**
- ✅ 能正确装备和卸下装备
- ✅ 装备属性正确计算并注入战斗
- ✅ 套装效果正确触发
- ✅ API返回正确数据
- ✅ 单元测试和集成测试通过

---

### Phase 4: 前端装备管理界面 (第7-8周)

#### 目标
完善前端装备面板，实现装备操作

#### 任务清单

**Task 4.1: 更新前端数据模型**
- [ ] 验证 `ApiModels.cs` 与后端模型一致
- [ ] 添加缺失字段（如IsBound, CreatedAt等）
- [ ] 更新DTO转换逻辑

**Task 4.2: 完善EquipmentPanel组件**
- [ ] 显示真实装备数据（替换占位数据）
- [ ] 实现装备槽点击事件
- [ ] 实现装备详情tooltip
  - [ ] 显示基础属性
  - [ ] 显示词条列表
  - [ ] 显示套装信息
  - [ ] 显示物品等级、品级、评分
- [ ] 实现装备对比功能
  - [ ] 显示属性差异
  - [ ] 高亮更好/更差的属性
- [ ] 实现卸下装备按钮
- [ ] 实现装备品质颜色显示

**Task 4.3: 创建背包装备列表**
- [ ] 扩展 `InventoryPanel.razor` 显示装备
- [ ] 实现装备筛选（按槽位/品质/等级）
- [ ] 实现装备排序（按评分/等级/获取时间）
- [ ] 实现装备点击 -> 装备操作
- [ ] 显示可装备/不可装备标识

**Task 4.4: 装备操作交互**
- [ ] 实现装备按钮功能
- [ ] 添加操作确认对话框
- [ ] 实现操作反馈（成功/失败提示）
- [ ] 实现乐观更新（立即更新UI，失败时回滚）
- [ ] 添加loading状态

**Task 4.5: ApiClient集成**
- [ ] 实现 `EquipItemAsync(characterId, gearInstanceId, slot)`
- [ ] 实现 `UnequipItemAsync(characterId, slot)`
- [ ] 实现 `GetEquipmentAsync(characterId)` （已有，更新）
- [ ] 错误处理和重试逻辑

**验收标准**
- ✅ 装备面板正确显示装备数据
- ✅ 装备/卸下操作正常工作
- ✅ 装备对比功能直观易用
- ✅ 背包装备筛选和排序正常
- ✅ 操作反馈友好

---

### Phase 5: 装备增强系统 (第9-10周)

#### 目标
实现装备分解、重铸、词条重置等高级功能

#### 任务清单

**Task 5.1: 装备分解服务**
- [ ] 创建 `DisenchantService.cs`
- [ ] 实现 `Disenchant(gearInstanceId)` 方法
  - [ ] 计算分解产出（基于稀有度/品级）
  - [ ] 删除装备实例
  - [ ] 发放材料到背包
  - [ ] 记录经济事件
- [ ] 定义分解材料（mat_essence_common/rare/epic/legendary）
- [ ] 配置分解产出表

**Task 5.2: 品级重铸服务**
- [ ] 创建 `ReforgeService.cs`
- [ ] 实现 `ReforgeTier(gearInstanceId)` 方法
  - [ ] 验证品级未达上限（Tier < 3）
  - [ ] 扣除材料和金币
  - [ ] 提升品级
  - [ ] 重新计算基础属性（应用Tier系数）
  - [ ] 更新装备评分
- [ ] 定义重铸成本（递增公式）
- [ ] 实现成功率机制（可选）

**Task 5.3: 词条重置服务**
- [ ] 实现 `RerollAffixes(gearInstanceId)` 方法
  - [ ] 扣除材料和金币
  - [ ] 保留词条数量
  - [ ] 重新Roll词条（类型和数值）
  - [ ] 记录重置次数
  - [ ] 应用成本递增
- [ ] 实现保底机制（连续N次未出高数值时提升roll范围）
- [ ] 可选：锁定特定词条功能

**Task 5.4: API实现**
- [ ] `POST /api/equipment/{gearInstanceId}/disenchant` - 分解
- [ ] `POST /api/equipment/{gearInstanceId}/reforge` - 品级重铸
- [ ] `POST /api/equipment/{gearInstanceId}/reroll-affixes` - 词条重置
- [ ] 添加操作成本计算API
- [ ] 错误处理和验证

**Task 5.5: 前端增强功能界面**
- [ ] 创建 `GearEnhancementDialog.razor` 组件
- [ ] 实现分解确认界面
  - [ ] 显示分解产出预览
  - [ ] 批量分解功能
- [ ] 实现品级重铸界面
  - [ ] 显示重铸成本
  - [ ] 显示属性提升预览
  - [ ] 成功率显示（如有）
- [ ] 实现词条重置界面
  - [ ] 显示当前词条
  - [ ] 显示重置成本
  - [ ] 词条锁定功能（如有）
- [ ] 集成到装备详情界面

**验收标准**
- ✅ 分解功能正常工作，产出正确
- ✅ 品级重铸正确提升装备
- ✅ 词条重置正确重新生成词条
- ✅ 成本计算正确
- ✅ 前端界面直观易用

---

### Phase 6: 套装系统与优化 (第11-12周)

#### 目标
完善套装系统，优化整体性能和用户体验

#### 任务清单

**Task 6.1: 套装系统完善**
- [ ] 创建至少3个完整套装
  - [ ] 战士套装（6件，物理伤害加成）
  - [ ] 法师套装（6件，法术伤害加成）
  - [ ] 坦克套装（6件，生存加成）
- [ ] 实现套装特效（OnHit/OnCast触发）
- [ ] 实现套装Buff（集成到BuffManager）
- [ ] 前端显示套装进度和激活状态

**Task 6.2: 装备对比优化**
- [ ] 改进装备对比算法
- [ ] 考虑套装效果在对比中的影响
- [ ] 实现"总评分"对比
- [ ] 实现装备推荐功能

**Task 6.3: 性能优化**
- [ ] 实现装备属性缓存
- [ ] 实现装备数据懒加载
- [ ] 优化装备列表渲染（虚拟滚动）
- [ ] 优化数据库查询（添加索引）
- [ ] 实现装备预加载策略

**Task 6.4: 用户体验优化**
- [ ] 添加装备获取动画和音效
- [ ] 实现装备快速切换（套装切换）
- [ ] 添加装备锁定功能（防止误分解）
- [ ] 实现装备收藏功能
- [ ] 添加装备搜索功能

**Task 6.5: 数据平衡**
- [ ] 调整装备属性范围
- [ ] 调整词条数值
- [ ] 调整分解产出
- [ ] 调整重铸成本
- [ ] 进行平衡性测试

**验收标准**
- ✅ 套装系统完整可用
- ✅ 性能满足要求（装备列表渲染<100ms）
- ✅ 用户体验流畅
- ✅ 数据平衡合理

---

### Phase 7: 高级功能与扩展 (第13-14周，可选)

#### 目标
实现高级功能，为未来扩展做准备

#### 任务清单

**Task 7.1: 装备强化系统**
- [ ] 实现装备强化等级（+1 ~ +15）
- [ ] 实现强化失败惩罚机制
- [ ] 实现强化保护道具

**Task 7.2: 装备精炼系统**
- [ ] 实现单个词条精炼（小幅提升）
- [ ] 实现精炼上限
- [ ] 实现精炼成本递增

**Task 7.3: 装备传承系统**
- [ ] 实现装备属性传承（旧装备属性转移到新装备）
- [ ] 实现传承成本计算

**Task 7.4: 装备绑定与交易**
- [ ] 实现装备绑定机制（装备后绑定/拾取后绑定）
- [ ] 预留交易接口（玩家间交易/拍卖行）

**Task 7.5: 装备图鉴系统**
- [ ] 实现装备图鉴收集
- [ ] 实现图鉴奖励
- [ ] 前端图鉴展示界面

---

### Phase 8: 测试与文档 (第15-16周)

#### 目标
全面测试和完善文档

#### 任务清单

**Task 8.1: 单元测试**
- [ ] 装备生成逻辑测试
- [ ] 属性计算测试
- [ ] 套装效果测试
- [ ] 分解/重铸/重置测试
- [ ] 边界条件测试

**Task 8.2: 集成测试**
- [ ] 装备掉落流程测试
- [ ] 装备/卸下流程测试
- [ ] 装备增强流程测试
- [ ] 战斗集成测试

**Task 8.3: 性能测试**
- [ ] 装备生成性能测试
- [ ] 属性计算性能测试
- [ ] 数据库查询性能测试
- [ ] 前端渲染性能测试

**Task 8.4: 用户验收测试**
- [ ] 创建测试用例
- [ ] 执行功能测试
- [ ] 收集用户反馈
- [ ] 修复发现的问题

**Task 8.5: 文档完善**
- [ ] 装备系统设计文档
- [ ] API接口文档
- [ ] 数据库设计文档
- [ ] 用户使用手册
- [ ] 开发者指南

---

## 5. 数据模型设计

### 5.1 数据库表结构

#### GearDefinitions（装备定义表）

```sql
CREATE TABLE GearDefinitions (
    Id VARCHAR(100) PRIMARY KEY,              -- 如 "sword_iron"
    Name VARCHAR(200) NOT NULL,               -- 显示名称
    Icon VARCHAR(50),                         -- 图标emoji或URL
    Slot VARCHAR(50) NOT NULL,                -- 装备槽位
    RequiredLevel INT NOT NULL DEFAULT 1,     -- 需求等级
    BaseStatsJson TEXT,                       -- JSON: {"AttackPower": {"Min": 10, "Max": 15}}
    AllowedAffixPoolJson TEXT,                -- JSON: ["affix_strength", "affix_crit"]
    RarityWeightsJson TEXT,                   -- JSON: {"Common": 0.6, "Rare": 0.3, ...}
    SetId VARCHAR(100),                       -- 套装ID，可为null
    CreatedAt DATETIME NOT NULL,
    UpdatedAt DATETIME NOT NULL
);
```

#### GearInstances（装备实例表）

```sql
CREATE TABLE GearInstances (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    DefinitionId VARCHAR(100) NOT NULL,       -- 外键到GearDefinitions
    CharacterId UNIQUEIDENTIFIER,             -- 外键到Characters，null表示在背包
    SlotType VARCHAR(50),                     -- 装备位置，null表示未装备
    Rarity VARCHAR(50) NOT NULL,              -- Common/Rare/Epic/Legendary
    TierLevel INT NOT NULL DEFAULT 1,         -- 品级 1-3
    ItemLevel INT NOT NULL,                   -- 物品等级
    RolledStatsJson TEXT NOT NULL,            -- JSON: {"AttackPower": 12.5}
    AffixesJson TEXT NOT NULL,                -- JSON: [{"AffixId": "...", "Value": ...}]
    QualityScore INT NOT NULL,                -- 装备评分
    IsEquipped BIT NOT NULL DEFAULT 0,        -- 是否已装备
    IsBound BIT NOT NULL DEFAULT 0,           -- 是否绑定
    RerollCount INT NOT NULL DEFAULT 0,       -- 词条重置次数
    CreatedAt DATETIME NOT NULL,
    UpdatedAt DATETIME NOT NULL,
    
    FOREIGN KEY (DefinitionId) REFERENCES GearDefinitions(Id),
    FOREIGN KEY (CharacterId) REFERENCES Characters(Id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX IX_GearInstances_CharacterId ON GearInstances(CharacterId);
CREATE INDEX IX_GearInstances_IsEquipped ON GearInstances(IsEquipped);
CREATE INDEX IX_GearInstances_Rarity ON GearInstances(Rarity);
```

#### AffixDefinitions（词条定义表）

```sql
CREATE TABLE AffixDefinitions (
    Id VARCHAR(100) PRIMARY KEY,              -- 如 "affix_strength"
    Name VARCHAR(200) NOT NULL,               -- 显示名称，如 "力量"
    StatType VARCHAR(50) NOT NULL,            -- 影响的属性类型
    ModifierType VARCHAR(50) NOT NULL,        -- Flat/Percent/Proc
    ValueMin FLOAT NOT NULL,                  -- 数值范围最小
    ValueMax FLOAT NOT NULL,                  -- 数值范围最大
    RarityWeight FLOAT NOT NULL DEFAULT 1.0,  -- 稀有度权重（越低越稀有）
    AllowedSlots TEXT,                        -- JSON: ["weapon", "chest"] 或 null表示全部
    CreatedAt DATETIME NOT NULL,
    UpdatedAt DATETIME NOT NULL
);
```

#### GearSets（套装定义表）

```sql
CREATE TABLE GearSets (
    Id VARCHAR(100) PRIMARY KEY,              -- 如 "set_warrior"
    Name VARCHAR(200) NOT NULL,               -- 套装名称
    PiecesJson TEXT NOT NULL,                 -- JSON: ["gear_def_1", "gear_def_2", ...]
    BonusesJson TEXT NOT NULL,                -- JSON: {"2": [...], "4": [...], "6": [...]}
    CreatedAt DATETIME NOT NULL,
    UpdatedAt DATETIME NOT NULL
);
```

### 5.2 DTO模型（前后端通信）

前端 `ApiModels.cs` 中已定义的DTO：
- `EquipmentResponse`
- `EquipmentSlotDto`
- `GearInstanceDto`
- `AffixDto`

需要添加的DTO：
- `GearEnhancementCostDto`（增强成本）
- `SetBonusDto`（套装加成）
- `DisenchantResultDto`（分解结果）

---

## 6. 与现有系统的集成

### 6.1 与经济系统集成

```
装备掉落流程
├── 战斗结束 (BattleRunner / StepBattleEngine)
├── 收集killCounts
├── EconomyCalculator.ComputeSampled(killCounts, context)
│   └── 【扩展】识别装备掉落项 (itemType == "gear")
├── 【新增】GearGenerationService.Generate(gearDefId, context)
├── 创建GearInstance并保存到数据库
├── 关联到InventoryItem (ItemId = gearInstanceId.ToString())
└── RewardGrantService.GrantRewards() 发放奖励
```

### 6.2 与战斗系统集成

```
战斗属性计算
├── StatsBuilder.BuildStats(character)
│   ├── 1. 主属性 -> 基础属性
│   ├── 2. 职业基础属性
│   ├── 3. 【新增】装备属性
│   │   └── StatsAggregationService.CalculateEquipmentStats(characterId)
│   │       ├── 查询已装备的GearInstance
│   │       ├── 聚合基础属性和词条
│   │       ├── 应用套装加成
│   │       └── 返回EquipmentStats
│   ├── 4. Buff属性
│   └── 5. 最终CharacterStats
└── 传入PlayerCombatant
```

### 6.3 与角色系统集成

```
Character实体扩展
├── 导航属性：public ICollection<GearInstance> EquippedGear { get; set; }
├── 计算属性：public EquipmentStats CachedEquipmentStats { get; private set; }
└── 方法：public void InvalidateEquipmentCache()
```

### 6.4 与背包系统集成

```
背包物品类型扩展
├── 现有：普通物品（材料/消耗品）
├── 【新增】装备类型
│   ├── ItemId格式："gear:{gearInstanceId}"
│   ├── Quantity固定为1
│   └── 关联到GearInstance表
└── 前端InventoryPanel显示装备
```

---

## 7. 技术实现要点

### 7.1 装备生成算法

```csharp
public class GearGenerationService
{
    private readonly RNGContext _rng;
    private readonly IGearDefinitionRepository _definitions;
    private readonly IAffixRepository _affixes;

    public GearInstance Generate(string gearDefId, int characterLevel, RNGContext rng)
    {
        var def = _definitions.GetById(gearDefId);
        
        // 1. 确定稀有度
        var rarity = RollRarity(def.RarityWeights, rng);
        
        // 2. 确定品级（默认T1）
        var tier = 1;
        
        // 3. 计算物品等级
        var itemLevel = characterLevel + GetRarityBonus(rarity);
        
        // 4. Roll基础属性
        var rolledStats = RollBaseStats(def.BaseStats, tier, rng);
        
        // 5. 生成词条
        var affixCount = GetAffixCount(rarity);
        var affixes = GenerateAffixes(def.AllowedAffixPool, affixCount, rng);
        
        // 6. 计算装备评分
        var score = CalculateQualityScore(rolledStats, affixes, rarity, tier);
        
        return new GearInstance
        {
            DefinitionId = gearDefId,
            Rarity = rarity,
            TierLevel = tier,
            ItemLevel = itemLevel,
            RolledStats = rolledStats,
            Affixes = affixes,
            QualityScore = score
        };
    }
}
```

### 7.2 属性聚合算法

```csharp
public class StatsAggregationService
{
    public Dictionary<string, double> CalculateEquipmentStats(Guid characterId)
    {
        var equippedGear = _repository.GetEquippedGear(characterId);
        
        var stats = new Dictionary<string, double>();
        
        // 1. 聚合基础属性和词条
        foreach (var gear in equippedGear)
        {
            // 基础属性
            foreach (var (stat, value) in gear.RolledStats)
            {
                stats[stat] = stats.GetValueOrDefault(stat) + value;
            }
            
            // 词条属性
            foreach (var affix in gear.Affixes)
            {
                var value = CalculateAffixValue(affix);
                stats[affix.StatType] = stats.GetValueOrDefault(affix.StatType) + value;
            }
        }
        
        // 2. 套装加成
        var setBonuses = _setBonusService.CalculateSetBonuses(equippedGear);
        foreach (var (stat, value) in setBonuses)
        {
            stats[stat] = stats.GetValueOrDefault(stat) + value;
        }
        
        // 3. 应用数值上限
        ApplyCaps(stats);
        
        return stats;
    }
}
```

### 7.3 数值管线

```csharp
// 根据《整合设计总结.txt》第13节
public double ApplyStatPipeline(
    double baseValue,
    List<StatModifier> additiveModifiers,
    List<StatModifier> multiplicativeModifiers,
    List<StatModifier> finalAdditiveModifiers)
{
    // 1. 基础值 + 加法修饰符
    var afterAdditive = baseValue + additiveModifiers.Sum(m => m.Value);
    
    // 2. 乘法修饰符（叠乘）
    var afterMultiplicative = afterAdditive;
    foreach (var mod in multiplicativeModifiers)
    {
        afterMultiplicative *= (1.0 + mod.Value);
    }
    
    // 3. 最终加法修饰符
    var final = afterMultiplicative + finalAdditiveModifiers.Sum(m => m.Value);
    
    // 4. 应用上限
    return Clamp(final, minValue, maxValue);
}
```

### 7.4 缓存策略

```csharp
public class EquipmentStatsCache
{
    private readonly ConcurrentDictionary<Guid, (DateTime Timestamp, Dictionary<string, double> Stats)> _cache;
    
    public Dictionary<string, double> GetOrCalculate(Guid characterId, Func<Dictionary<string, double>> calculator)
    {
        if (_cache.TryGetValue(characterId, out var cached))
        {
            // 缓存5分钟
            if (DateTime.UtcNow - cached.Timestamp < TimeSpan.FromMinutes(5))
            {
                return cached.Stats;
            }
        }
        
        var stats = calculator();
        _cache[characterId] = (DateTime.UtcNow, stats);
        return stats;
    }
    
    public void Invalidate(Guid characterId)
    {
        _cache.TryRemove(characterId, out _);
    }
}
```

---

## 8. 风险与挑战

### 8.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 属性计算性能问题 | 高 | 实现缓存机制；优化查询 |
| 装备生成随机性不可控 | 中 | 使用RNGContext保证可回放 |
| 数据库查询慢 | 中 | 添加索引；使用预加载 |
| 前端渲染卡顿 | 中 | 虚拟滚动；懒加载 |
| 装备数据量大 | 低 | 定期清理；归档机制 |

### 8.2 设计风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 数值膨胀 | 高 | 严格数值管线；上限控制 |
| 词条组合不平衡 | 中 | 数据驱动配置；灵活调整 |
| 套装过强/过弱 | 中 | 分阶段测试；逐步调整 |
| 装备获取难度 | 低 | 可配置掉落率；保底机制 |

### 8.3 实施风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 开发时间超期 | 中 | 分Phase实施；优先核心功能 |
| 与现有系统冲突 | 中 | 充分测试；小步集成 |
| 数据迁移问题 | 低 | 向后兼容设计；迁移脚本 |

---

## 9. 总结

### 9.1 核心价值

1. **丰富游戏内容**：装备系统为玩家提供新的成长路径
2. **增强构筑深度**：词条/套装提供多样化构筑选择
3. **延长游戏寿命**：装备追求和优化提供长期目标
4. **经济循环完善**：分解/重铸消耗金币和材料，形成经济循环

### 9.2 实施建议

1. **优先级**：Phase 1-3 是核心功能，必须完成
2. **迭代方式**：每个Phase完成后进行测试和调整
3. **数据驱动**：所有数值配置化，便于快速调整平衡性
4. **用户反馈**：Phase 4后收集用户反馈，指导后续开发

### 9.3 成功标准

- ✅ 装备系统完整可用，无重大bug
- ✅ 装备掉落和生成正常工作
- ✅ 装备属性正确影响战斗
- ✅ 前端界面直观易用
- ✅ 性能满足要求（装备操作<500ms响应）
- ✅ 数据平衡合理，玩家反馈正面

---

## 附录A：快速参考

### 关键类清单

```
后端
├── Domain/Equipment/Models/
│   ├── GearDefinition.cs
│   ├── GearInstance.cs
│   ├── Affix.cs
│   ├── AffixInstance.cs
│   └── GearSet.cs
├── Domain/Equipment/Services/
│   ├── GearGenerationService.cs
│   ├── EquipmentService.cs
│   ├── StatsAggregationService.cs
│   ├── DisenchantService.cs
│   ├── ReforgeService.cs
│   └── SetBonusService.cs
└── Api/
    └── EquipmentController.cs (更新)

前端
├── Components/
│   ├── EquipmentPanel.razor (更新)
│   ├── GearEnhancementDialog.razor (新增)
│   └── InventoryPanel.razor (更新)
└── Services/
    ├── ApiModels.cs (更新)
    └── ApiClient.cs (更新)
```

### API端点清单

```
GET    /api/equipment/{characterId}              获取装备栏
POST   /api/equipment/{characterId}/{slot}       装备物品
DELETE /api/equipment/{characterId}/{slot}       卸下装备
GET    /api/equipment/{characterId}/stats        获取装备总属性
POST   /api/equipment/{gearId}/disenchant       分解装备
POST   /api/equipment/{gearId}/reforge          品级重铸
POST   /api/equipment/{gearId}/reroll-affixes   词条重置
```

---

**文档结束**
