# BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸‹ç¯‡

**é¡¹ç›®åç§°**: BlazorIdle æ•°æ®åº“è¯»å–æ“ä½œä¼˜åŒ–  
**æ–‡æ¡£ç±»å‹**: æµ‹è¯•è®¡åˆ’ã€éªŒæ”¶æ ‡å‡†ä¸éƒ¨ç½²æŒ‡å—  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-18  
**çŠ¶æ€**: æµ‹è¯•ä¸éªŒæ”¶æ ‡å‡† - å¾…å®¡æ ¸

---

## ğŸ“‹ ç›®å½•

1. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
2. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)
3. [éƒ¨ç½²ç­–ç•¥](#éƒ¨ç½²ç­–ç•¥)
4. [ç›‘æ§æŒ‡æ ‡](#ç›‘æ§æŒ‡æ ‡)
5. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
6. [æ€§èƒ½è°ƒä¼˜](#æ€§èƒ½è°ƒä¼˜)
7. [å›æ»šæ–¹æ¡ˆ](#å›æ»šæ–¹æ¡ˆ)
8. [è¿ç»´æ‰‹å†Œ](#è¿ç»´æ‰‹å†Œ)

---

## æµ‹è¯•è®¡åˆ’

### æµ‹è¯•å±‚æ¬¡

```
å•å…ƒæµ‹è¯• â†’ é›†æˆæµ‹è¯• â†’ åŠŸèƒ½æµ‹è¯• â†’ æ€§èƒ½æµ‹è¯• â†’ å‹åŠ›æµ‹è¯• â†’ ç”¨æˆ·éªŒæ”¶æµ‹è¯•
```

### å•å…ƒæµ‹è¯•

#### ç¼“å­˜åŸºç¡€åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç¼“å­˜çš„åŸºæœ¬åŠŸèƒ½

**æµ‹è¯•ç”¨ä¾‹**:

| ç¼–å· | æµ‹è¯•ç”¨ä¾‹ | é¢„æœŸç»“æœ |
|------|---------|---------|
| UT-01 | ç¼“å­˜å‘½ä¸­æµ‹è¯• | ç¬¬äºŒæ¬¡è¯»å–å‘½ä¸­ç¼“å­˜ |
| UT-02 | ç¼“å­˜æœªå‘½ä¸­æµ‹è¯• | é¦–æ¬¡è¯»å–æŸ¥è¯¢æ•°æ®åº“ |
| UT-03 | TTL è¿‡æœŸæµ‹è¯• | è¿‡æœŸåé‡æ–°åŠ è½½ |
| UT-04 | LRU æ¸…ç†æµ‹è¯• | æœ€ä¹…æœªè®¿é—®çš„è¢«æ¸…ç† |
| UT-05 | æ‰¹é‡è·å–æµ‹è¯• | æ­£ç¡®è¿”å›å¤šä¸ªå®ä½“ |
| UT-06 | æ¡ä»¶æŸ¥è¯¢æµ‹è¯• | æ­£ç¡®ç­›é€‰å®ä½“ |
| UT-07 | ç¼“å­˜å¤±æ•ˆæµ‹è¯• | å¤±æ•ˆåé‡æ–°åŠ è½½ |
| UT-08 | é¢„çƒ­æµ‹è¯• | å¯åŠ¨æ—¶åŠ è½½æ•°æ® |
| UT-09 | ç»Ÿè®¡ä¿¡æ¯æµ‹è¯• | å‡†ç¡®è®°å½•å‘½ä¸­ç‡ |
| UT-10 | å¹¶å‘è®¿é—®æµ‹è¯• | çº¿ç¨‹å®‰å…¨ |

**ä»£ç ç¤ºä¾‹**:

```csharp
[Fact]
public async Task GetAsync_FirstAccess_ShouldLoadFromDatabase()
{
    // Arrange
    var testId = Guid.NewGuid();
    
    // Act
    var result = await _manager.GetAsync(testId);
    
    // Assert
    var stats = _manager.GetStatistics();
    Assert.Equal(1, stats.TotalQueries);
    Assert.Equal(1, stats.TotalMisses);  // é¦–æ¬¡åº”è¯¥æœªå‘½ä¸­
    Assert.Equal(0, stats.TotalHits);
}

[Fact]
public async Task GetAsync_SecondAccess_ShouldHitCache()
{
    // Arrange
    var testId = Guid.NewGuid();
    await _manager.GetAsync(testId);  // é¦–æ¬¡åŠ è½½
    
    // Act
    var result = await _manager.GetAsync(testId);  // ç¬¬äºŒæ¬¡è®¿é—®
    
    // Assert
    var stats = _manager.GetStatistics();
    Assert.Equal(2, stats.TotalQueries);
    Assert.Equal(1, stats.TotalMisses);
    Assert.Equal(1, stats.TotalHits);  // ç¬¬äºŒæ¬¡åº”è¯¥å‘½ä¸­
    Assert.True(stats.HitRate >= 50);  // å‘½ä¸­ç‡åº”è¯¥ â‰¥ 50%
}

[Fact]
public async Task GetAsync_ExpiredEntry_ShouldReload()
{
    // Arrange
    // é…ç½®æçŸ­çš„ TTLï¼ˆ1ç§’ï¼‰
    var testId = Guid.NewGuid();
    await _manager.GetAsync(testId);
    
    // Act
    await Task.Delay(TimeSpan.FromSeconds(2));  // ç­‰å¾…è¿‡æœŸ
    var result = await _manager.GetAsync(testId);
    
    // Assert
    var stats = _manager.GetStatistics();
    Assert.True(stats.ExpirationEvictionCount > 0);
}

[Fact]
public void Update_ShouldInvalidateCache()
{
    // Arrange
    var entity = CreateTestEntity();
    _manager.Add(entity);
    
    // Act
    entity.Name = "Updated";
    _manager.Update(entity);
    
    // Assert
    var stats = _manager.GetStatistics();
    Assert.True(stats.InvalidationCount >= 0);  // æ ¹æ®é…ç½®å¯èƒ½è§¦å‘å¤±æ•ˆ
}

[Fact]
public async Task GetManyAsync_ShouldBatchLoad()
{
    // Arrange
    var ids = Enumerable.Range(1, 20).Select(_ => Guid.NewGuid()).ToList();
    
    // Act
    var results = await _manager.GetManyAsync(ids);
    
    // Assert
    Assert.Equal(20, results.Count);
    var stats = _manager.GetStatistics();
    Assert.Equal(20, stats.TotalQueries);
}
```

#### ç¼“å­˜å¤±æ•ˆæœºåˆ¶æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç¼“å­˜å¤±æ•ˆçš„æ­£ç¡®æ€§

**æµ‹è¯•ç”¨ä¾‹**:

```csharp
[Fact]
public async Task WriteOperation_WithInvalidateOnWrite_ShouldInvalidateCache()
{
    // Arrange
    var entity = CreateTestEntity();
    await _manager.GetAsync(entity.Id);  // åŠ è½½åˆ°ç¼“å­˜
    
    // Act
    entity.Value = 999;
    _manager.Update(entity);  // æ›´æ–°åº”è¯¥è§¦å‘å¤±æ•ˆ
    
    // ç­‰å¾…å»¶è¿Ÿå¤±æ•ˆå¤„ç†
    await Task.Delay(TimeSpan.FromMilliseconds(150));
    
    // Assert
    var stats = _manager.GetStatistics();
    Assert.True(stats.InvalidationCount > 0);
}

[Fact]
public void InvalidateAll_ShouldClearAllCache()
{
    // Arrange
    for (int i = 0; i < 10; i++)
    {
        _manager.Add(CreateTestEntity());
    }
    
    // Act
    _manager.InvalidateAll();
    
    // Assert
    var stats = _manager.GetStatistics();
    Assert.Equal(0, stats.CachedCount);
    Assert.Equal(10, stats.InvalidationCount);
}
```

### é›†æˆæµ‹è¯•

#### ç«¯åˆ°ç«¯è¯»å–æµç¨‹æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ä» API åˆ°æ•°æ®åº“çš„å®Œæ•´è¯»å–æµç¨‹

**æµ‹è¯•åœºæ™¯**:

1. **åœºæ™¯ 1: é¦–æ¬¡è¯»å–**
   ```
   API è¯·æ±‚ â†’ Service â†’ CacheManager â†’ Database â†’ ç¼“å­˜ â†’ è¿”å›
   ```
   
2. **åœºæ™¯ 2: ç¼“å­˜å‘½ä¸­**
   ```
   API è¯·æ±‚ â†’ Service â†’ CacheManager â†’ ç¼“å­˜å‘½ä¸­ â†’ è¿”å›
   ```
   
3. **åœºæ™¯ 3: å†™å…¥åè¯»å–**
   ```
   API å†™å…¥ â†’ MemoryStateManager æ›´æ–° â†’ ç¼“å­˜å¤±æ•ˆ
   API è¯»å– â†’ CacheManager â†’ é‡æ–°åŠ è½½ â†’ è¿”å›æœ€æ–°æ•°æ®
   ```

**ä»£ç ç¤ºä¾‹**:

```csharp
[Fact]
public async Task Integration_GetCharacter_FirstAccess_ShouldLoadFromDatabase()
{
    // Arrange
    var characterId = await CreateTestCharacterInDatabase();
    
    // Act
    var response = await _client.GetAsync($"/api/characters/{characterId}");
    
    // Assert
    response.EnsureSuccessStatusCode();
    var character = await response.Content.ReadFromJsonAsync<Character>();
    Assert.NotNull(character);
    
    // éªŒè¯ç¼“å­˜ç»Ÿè®¡
    var statsResponse = await _client.GetAsync("/api/cache/statistics");
    var stats = await statsResponse.Content.ReadFromJsonAsync<CacheStatistics>();
    Assert.True(stats.TotalMisses > 0);  // é¦–æ¬¡åº”è¯¥æœªå‘½ä¸­
}

[Fact]
public async Task Integration_GetCharacter_SecondAccess_ShouldHitCache()
{
    // Arrange
    var characterId = await CreateTestCharacterInDatabase();
    await _client.GetAsync($"/api/characters/{characterId}");  // é¦–æ¬¡è®¿é—®
    
    // Act
    var response = await _client.GetAsync($"/api/characters/{characterId}");  // ç¬¬äºŒæ¬¡è®¿é—®
    
    // Assert
    response.EnsureSuccessStatusCode();
    
    // éªŒè¯ç¼“å­˜ç»Ÿè®¡
    var statsResponse = await _client.GetAsync("/api/cache/statistics");
    var stats = await statsResponse.Content.ReadFromJsonAsync<CacheStatistics>();
    Assert.True(stats.TotalHits > 0);  // ç¬¬äºŒæ¬¡åº”è¯¥å‘½ä¸­
    Assert.True(stats.HitRate > 0);
}

[Fact]
public async Task Integration_UpdateCharacter_ShouldInvalidateCacheAndReload()
{
    // Arrange
    var characterId = await CreateTestCharacterInDatabase();
    await _client.GetAsync($"/api/characters/{characterId}");  // åŠ è½½åˆ°ç¼“å­˜
    
    // Act
    var updateRequest = new { Name = "Updated Name" };
    await _client.PutAsJsonAsync($"/api/characters/{characterId}/heartbeat", updateRequest);
    
    // çŸ­æš‚ç­‰å¾…ç¼“å­˜å¤±æ•ˆ
    await Task.Delay(TimeSpan.FromMilliseconds(200));
    
    // å†æ¬¡è¯»å–
    var response = await _client.GetAsync($"/api/characters/{characterId}");
    
    // Assert
    var character = await response.Content.ReadFromJsonAsync<Character>();
    Assert.Equal("Updated Name", character.Name);  // åº”è¯¥æ˜¯æœ€æ–°æ•°æ®
}
```

#### è¯»å†™ä¸€è‡´æ€§æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: ç¡®ä¿å†™å…¥åç«‹å³è¯»å–èƒ½è·å¾—æœ€æ–°æ•°æ®

**æµ‹è¯•ç”¨ä¾‹**:

```csharp
[Fact]
public async Task ReadWriteConsistency_UpdateThenRead_ShouldGetLatestData()
{
    // Arrange
    var character = CreateTestCharacter();
    _characterManager.Add(character);
    await _characterManager.GetAsync(character.Id);  // åŠ è½½åˆ°ç¼“å­˜
    
    // Act
    character.LastSeenAtUtc = DateTime.UtcNow;
    _characterManager.Update(character);  // æ›´æ–°ï¼ˆå†™å…¥å†…å­˜ï¼Œæ ‡è®°dirtyï¼‰
    
    // ç«‹å³è¯»å–
    var result = await _characterManager.GetAsync(character.Id);
    
    // Assert
    Assert.NotNull(result);
    Assert.Equal(character.LastSeenAtUtc, result.LastSeenAtUtc);  // åº”è¯¥æ˜¯æœ€æ–°å€¼
}

[Fact]
public async Task ReadWriteConsistency_MultipleUpdates_ShouldReflectLatest()
{
    // Arrange
    var character = CreateTestCharacter();
    _characterManager.Add(character);
    
    // Act
    for (int i = 0; i < 10; i++)
    {
        character.Level = i;
        _characterManager.Update(character);
        
        var result = await _characterManager.GetAsync(character.Id);
        
        // Assert
        Assert.Equal(i, result.Level);  // æ¯æ¬¡è¯»å–åº”è¯¥éƒ½æ˜¯æœ€æ–°å€¼
    }
}
```

### æ€§èƒ½æµ‹è¯•

#### å“åº”æ—¶é—´æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç¼“å­˜å¯¹å“åº”æ—¶é—´çš„æ”¹å–„

**æµ‹è¯•æ–¹æ³•**:

```csharp
[Fact]
public async Task Performance_CacheVsDatabase_ResponseTime()
{
    // Arrange
    var testIds = Enumerable.Range(1, 100)
        .Select(_ => CreateTestCharacter().Id)
        .ToList();
    
    // é¢„çƒ­ç¼“å­˜
    foreach (var id in testIds)
    {
        await _manager.GetAsync(id);
    }
    
    // Act & Measure
    var sw1 = Stopwatch.StartNew();
    foreach (var id in testIds)
    {
        await _manager.GetAsync(id);  // ä»ç¼“å­˜è¯»å–
    }
    sw1.Stop();
    var cacheTime = sw1.ElapsedMilliseconds;
    
    // æ¸…ç©ºç¼“å­˜ï¼Œå¼ºåˆ¶ä»æ•°æ®åº“è¯»å–
    _manager.InvalidateAll();
    
    var sw2 = Stopwatch.StartNew();
    foreach (var id in testIds)
    {
        await _manager.GetAsync(id);  // ä»æ•°æ®åº“è¯»å–
    }
    sw2.Stop();
    var dbTime = sw2.ElapsedMilliseconds;
    
    // Assert
    var improvement = (double)(dbTime - cacheTime) / dbTime * 100;
    _output.WriteLine($"ç¼“å­˜æ—¶é—´: {cacheTime}ms, æ•°æ®åº“æ—¶é—´: {dbTime}ms, æ”¹å–„: {improvement:F2}%");
    
    Assert.True(improvement > 30, $"æ€§èƒ½æ”¹å–„åº”è¯¥ > 30%ï¼Œå®é™…: {improvement:F2}%");
}
```

**é¢„æœŸç»“æœ**:
- ç¼“å­˜å‘½ä¸­æ—¶å“åº”æ—¶é—´ < 5ms
- æ•°æ®åº“æŸ¥è¯¢å“åº”æ—¶é—´ 10-50ms
- æ€§èƒ½æ”¹å–„ **50-90%**

#### å¹¶å‘å‹åŠ›æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç¼“å­˜åœ¨é«˜å¹¶å‘ä¸‹çš„ç¨³å®šæ€§

**æµ‹è¯•æ–¹æ³•**:

```csharp
[Fact]
public async Task Stress_ConcurrentReads_ShouldHandleHighLoad()
{
    // Arrange
    var characterId = CreateTestCharacter().Id;
    var concurrentRequests = 1000;
    var tasks = new List<Task<Character?>>();
    
    // Act
    for (int i = 0; i < concurrentRequests; i++)
    {
        tasks.Add(_manager.GetAsync(characterId));
    }
    
    var results = await Task.WhenAll(tasks);
    
    // Assert
    Assert.All(results, r => Assert.NotNull(r));
    
    var stats = _manager.GetStatistics();
    _output.WriteLine($"æ€»è¯·æ±‚: {stats.TotalQueries}, å‘½ä¸­ç‡: {stats.HitRate:F2}%");
    
    Assert.True(stats.HitRate > 95, $"é«˜å¹¶å‘ä¸‹å‘½ä¸­ç‡åº”è¯¥ > 95%ï¼Œå®é™…: {stats.HitRate:F2}%");
    Assert.Equal(concurrentRequests, stats.TotalQueries);
}

[Fact]
public async Task Stress_MixedReadWrite_ShouldMaintainConsistency()
{
    // Arrange
    var character = CreateTestCharacter();
    _manager.Add(character);
    
    var readTasks = new List<Task>();
    var writeTasks = new List<Task>();
    
    // Act - æ··åˆè¯»å†™
    for (int i = 0; i < 500; i++)
    {
        readTasks.Add(_manager.GetAsync(character.Id));
    }
    
    for (int i = 0; i < 50; i++)
    {
        writeTasks.Add(Task.Run(() => {
            character.Level++;
            _manager.Update(character);
        }));
    }
    
    await Task.WhenAll(readTasks.Concat(writeTasks));
    
    // Assert
    var result = await _manager.GetAsync(character.Id);
    Assert.NotNull(result);
    // éªŒè¯æ•°æ®ä¸€è‡´æ€§ï¼ˆæœ€ç»ˆçŠ¶æ€æ­£ç¡®ï¼‰
}
```

### åŠŸèƒ½æµ‹è¯•

#### é™æ€æ•°æ®ç¼“å­˜æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯é™æ€é…ç½®æ•°æ®çš„ç¼“å­˜åŠŸèƒ½

**æµ‹è¯•ç”¨ä¾‹**:

```csharp
[Fact]
public async Task StaticCache_SkillDefinitions_ShouldLoadOnce()
{
    // Arrange
    var staticCache = _serviceProvider.GetRequiredService<StaticDataCacheManager<SkillDefinition>>();
    
    // Act
    var skills1 = await staticCache.GetAllAsync();
    var skills2 = await staticCache.GetAllAsync();  // ç¬¬äºŒæ¬¡ä¸åº”è¯¥æŸ¥æ•°æ®åº“
    
    // Assert
    Assert.NotEmpty(skills1);
    Assert.Same(skills1, skills2);  // åº”è¯¥æ˜¯åŒä¸€ä¸ªå®ä¾‹
}

[Fact]
public async Task StaticCache_Refresh_ShouldReloadData()
{
    // Arrange
    var staticCache = _serviceProvider.GetRequiredService<StaticDataCacheManager<SkillDefinition>>();
    await staticCache.GetAllAsync();  // åˆæ¬¡åŠ è½½
    
    // Act
    await staticCache.RefreshAsync();  // åˆ·æ–°
    var skillsAfterRefresh = await staticCache.GetAllAsync();
    
    // Assert
    Assert.NotEmpty(skillsAfterRefresh);
}
```

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

#### å¿…é¡»æ»¡è¶³çš„åŠŸèƒ½éœ€æ±‚

| ç¼–å· | éœ€æ±‚ | éªŒæ”¶æ¡ä»¶ | çŠ¶æ€ |
|------|------|---------|------|
| FR-01 | è¯»å–ç¼“å­˜åŠŸèƒ½ | é¦–æ¬¡æŸ¥æ•°æ®åº“ï¼Œåç»­è¯»ç¼“å­˜ | [ ] |
| FR-02 | ç¼“å­˜å‘½ä¸­ç‡ | â‰¥ 80% | [ ] |
| FR-03 | TTL å¤±æ•ˆ | è¿‡æœŸåè‡ªåŠ¨é‡æ–°åŠ è½½ | [ ] |
| FR-04 | LRU æ¸…ç† | è¶…å®¹é‡æ—¶æ¸…ç†æœ€ä¹…æœªç”¨ | [ ] |
| FR-05 | å†™å…¥å¤±æ•ˆ | æ›´æ–°åç¼“å­˜å¤±æ•ˆ | [ ] |
| FR-06 | è¯»å†™ä¸€è‡´æ€§ | å†™å…¥åç«‹å³è¯»å–åˆ°æœ€æ–°æ•°æ® | [ ] |
| FR-07 | é™æ€æ•°æ®ç¼“å­˜ | é…ç½®æ•°æ®é•¿æœŸç¼“å­˜ | [ ] |
| FR-08 | æ‰¹é‡è¯»å– | æ”¯æŒæ‰¹é‡è·å–å®ä½“ | [ ] |
| FR-09 | æ¡ä»¶æŸ¥è¯¢ | æ”¯æŒæ¡ä»¶ç­›é€‰ï¼ˆæœ‰é™ï¼‰ | [ ] |
| FR-10 | ç¼“å­˜é¢„çƒ­ | å¯åŠ¨æ—¶å¯é€‰é¢„çƒ­ | [ ] |

#### é…ç½®åŒ–éªŒæ”¶

| ç¼–å· | é…ç½®é¡¹ | éªŒæ”¶æ¡ä»¶ | çŠ¶æ€ |
|------|-------|---------|------|
| CF-01 | EnableReadCache | å¯é€šè¿‡é…ç½®å¼€å…³å¯ç”¨/ç¦ç”¨ | [ ] |
| CF-02 | TimeToLiveSeconds | å¯é…ç½® TTL | [ ] |
| CF-03 | MaxCachedEntities | å¯é…ç½®å®¹é‡é™åˆ¶ | [ ] |
| CF-04 | EvictionPolicy | å¯é…ç½®æ¸…ç†ç­–ç•¥ | [ ] |
| CF-05 | InvalidateOnWrite | å¯é…ç½®æ˜¯å¦å†™å…¥å¤±æ•ˆ | [ ] |
| CF-06 | EntityCacheStrategies | æ”¯æŒå®ä½“ç±»å‹å·®å¼‚åŒ–é…ç½® | [ ] |
| CF-07 | Monitoring | æ”¯æŒç›‘æ§é…ç½® | [ ] |
| CF-08 | WarmUp | æ”¯æŒé¢„çƒ­é…ç½® | [ ] |

### æ€§èƒ½éªŒæ”¶

#### é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡ | åŸºå‡†å€¼ï¼ˆä¼˜åŒ–å‰ï¼‰ | ç›®æ ‡å€¼ | éªŒæ”¶æ¡ä»¶ | çŠ¶æ€ |
|------|---------------|--------|---------|------|
| æ•°æ®åº“è¯»å–æ¬¡æ•° | 120,000æ¬¡/å°æ—¶ | 12,000-36,000æ¬¡/å°æ—¶ | å‡å°‘ 70-90% | [ ] |
| ç¼“å­˜å‘½ä¸­ç‡ | 0% | 80-95% | â‰¥ 80% | [ ] |
| API å“åº”æ—¶é—´ P95 | 150-200ms | <100ms | æ”¹å–„ 30-50% | [ ] |
| æ•°æ®åº“è¿æ¥æ± åˆ©ç”¨ç‡ | 60-80% | 30-50% | é™ä½ 30-50% | [ ] |
| å†…å­˜ä½¿ç”¨ | ~350MB | ~500-650MB | å¢åŠ  <300MB | [ ] |
| ç¼“å­˜å¤±æ•ˆå»¶è¿Ÿ | N/A | <100ms | <100ms | [ ] |

#### æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
- 100 ä¸ªå¹¶å‘ç”¨æˆ·
- æ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿ 10 æ¬¡è¯·æ±‚
- æŒç»­æµ‹è¯• 30 åˆ†é’Ÿ

**é¢„æœŸç»“æœ**ï¼š
- å¹³å‡å“åº”æ—¶é—´ < 50ms
- P95 å“åº”æ—¶é—´ < 100ms
- P99 å“åº”æ—¶é—´ < 200ms
- ç¼“å­˜å‘½ä¸­ç‡ > 80%
- æ— å†…å­˜æº¢å‡º
- æ— æ•°æ®ä¸ä¸€è‡´

### è´¨é‡éªŒæ”¶

#### ä»£ç è´¨é‡

| ç¼–å· | æ£€æŸ¥é¡¹ | éªŒæ”¶æ ‡å‡† | çŠ¶æ€ |
|------|--------|---------|------|
| QA-01 | ç¼–è¯‘æˆåŠŸ | 0 é”™è¯¯ | [ ] |
| QA-02 | ä»£ç è§„èŒƒ | ç¬¦åˆé¡¹ç›®ç¼–ç è§„èŒƒ | [ ] |
| QA-03 | æ³¨é‡Šå®Œæ•´æ€§ | æ‰€æœ‰å…¬å…±APIæœ‰XMLæ–‡æ¡£æ³¨é‡Š | [ ] |
| QA-04 | å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | â‰¥ 80% | [ ] |
| QA-05 | é›†æˆæµ‹è¯•é€šè¿‡ç‡ | 100% | [ ] |

#### å‘åå…¼å®¹æ€§

| ç¼–å· | æ£€æŸ¥é¡¹ | éªŒæ”¶æ ‡å‡† | çŠ¶æ€ |
|------|--------|---------|------|
| BC-01 | API æ¥å£ä¸å˜ | ä¸ä¿®æ”¹ç°æœ‰ API ç­¾å | [ ] |
| BC-02 | é…ç½®å›æ»š | EnableReadCache=false æ¢å¤åŸè¡Œä¸º | [ ] |
| BC-03 | æ•°æ®æ ¼å¼ä¸å˜ | ä¸ä¿®æ”¹æ•°æ®æ¨¡å‹ | [ ] |
| BC-04 | Fallback æœºåˆ¶ | ç¼“å­˜æœªå¯ç”¨æ—¶æ­£å¸¸å·¥ä½œ | [ ] |

### æ–‡æ¡£éªŒæ”¶

| ç¼–å· | æ–‡æ¡£ | éªŒæ”¶æ ‡å‡† | çŠ¶æ€ |
|------|------|---------|------|
| DOC-01 | éœ€æ±‚åˆ†ææ–‡æ¡£ | ä¸Šç¯‡å®Œæˆ | [ ] |
| DOC-02 | å®æ–½æ–¹æ¡ˆæ–‡æ¡£ | ä¸­ç¯‡å®Œæˆ | [ ] |
| DOC-03 | æµ‹è¯•ä¸éªŒæ”¶æ–‡æ¡£ | ä¸‹ç¯‡å®Œæˆ | [ ] |
| DOC-04 | éªŒæ”¶æ–‡æ¡£ | ç‹¬ç«‹éªŒæ”¶æ–‡æ¡£å®Œæˆ | [ ] |
| DOC-05 | é…ç½®è¯´æ˜ | appsettings.json è¯´æ˜å®Œæ•´ | [ ] |
| DOC-06 | è¿ç»´æ‰‹å†Œ | ç›‘æ§ã€æ•…éšœæ’æŸ¥æŒ‡å—å®Œæˆ | [ ] |

---

## éƒ¨ç½²ç­–ç•¥

### åˆ†é˜¶æ®µéƒ¨ç½²

#### é˜¶æ®µ 1: å¼€å‘ç¯å¢ƒéªŒè¯ï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**: åœ¨å¼€å‘ç¯å¢ƒå®Œæ•´æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

**æ­¥éª¤**:
1. å¤‡ä»½å¼€å‘ç¯å¢ƒæ•°æ®åº“
2. éƒ¨ç½²æ–°ä»£ç 
3. å¯ç”¨ç¼“å­˜ï¼ˆEnableReadCache=trueï¼‰
4. æ‰§è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
5. ç›‘æ§æ€§èƒ½æŒ‡æ ‡
6. éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§

**éªŒæ”¶æ ‡å‡†**:
- æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- æ— æ•°æ®ä¸ä¸€è‡´

#### é˜¶æ®µ 2: æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼ˆ3-5å¤©ï¼‰

**ç›®æ ‡**: åœ¨æ¥è¿‘ç”Ÿäº§ç¯å¢ƒçš„æµ‹è¯•ç¯å¢ƒéªŒè¯

**æ­¥éª¤**:
1. æ¢å¤ç”Ÿäº§æ•°æ®åˆ°æµ‹è¯•ç¯å¢ƒ
2. éƒ¨ç½²æ–°ä»£ç 
3. å¯ç”¨ç¼“å­˜
4. æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
5. æ‰§è¡Œå‹åŠ›æµ‹è¯•
6. æ‰§è¡Œç”¨æˆ·éªŒæ”¶æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
- æ€§èƒ½åŸºå‡†æµ‹è¯•é€šè¿‡
- å‹åŠ›æµ‹è¯•æ— é—®é¢˜
- ç”¨æˆ·éªŒæ”¶æµ‹è¯•é€šè¿‡
- å†…å­˜ä½¿ç”¨åœ¨åˆç†èŒƒå›´

#### é˜¶æ®µ 3: ç°åº¦å‘å¸ƒï¼ˆ5-7å¤©ï¼‰

**ç›®æ ‡**: å°èŒƒå›´ç”Ÿäº§ç¯å¢ƒéªŒè¯

**ç­–ç•¥**:
- é€‰æ‹© 10% çš„æœåŠ¡å™¨å¯ç”¨ç¼“å­˜
- å¯†åˆ‡ç›‘æ§æ€§èƒ½å’Œé”™è¯¯
- å¯¹æ¯”ç¼“å­˜ç»„å’Œéç¼“å­˜ç»„çš„æ€§èƒ½

**æ­¥éª¤**:
1. é€‰æ‹© 10% æœåŠ¡å™¨å¯ç”¨ EnableReadCache=true
2. å…¶ä½™ 90% æœåŠ¡å™¨ä¿æŒ EnableReadCache=false
3. ç›‘æ§ 24-48 å°æ—¶
4. æ”¶é›†æ€§èƒ½æ•°æ®å¯¹æ¯”
5. éªŒè¯æ— é—®é¢˜åæ‰©å¤§èŒƒå›´åˆ° 50%
6. å†ç›‘æ§ 24 å°æ—¶
7. éªŒè¯æ— é—®é¢˜åå…¨é¢å¯ç”¨

**ç›‘æ§æŒ‡æ ‡**:
- API å“åº”æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
- ç¼“å­˜å‘½ä¸­ç‡
- é”™è¯¯ç‡
- å†…å­˜ä½¿ç”¨

**å›æ»šæ¡ä»¶**:
- é”™è¯¯ç‡å¢åŠ  > 5%
- å†…å­˜æº¢å‡º
- API å“åº”æ—¶é—´é€€åŒ–
- æ•°æ®ä¸ä¸€è‡´

#### é˜¶æ®µ 4: å…¨é¢å¯ç”¨ï¼ˆ7-10å¤©åï¼‰

**ç›®æ ‡**: åœ¨æ‰€æœ‰æœåŠ¡å™¨å¯ç”¨ç¼“å­˜

**æ­¥éª¤**:
1. åœ¨æ‰€æœ‰æœåŠ¡å™¨å¯ç”¨ EnableReadCache=true
2. æŒç»­ç›‘æ§ 7 å¤©
3. æ”¶é›†å®Œæ•´çš„æ€§èƒ½å¯¹æ¯”æ•°æ®
4. ç”Ÿæˆé¡¹ç›®éªŒæ”¶æŠ¥å‘Š

---

## ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

#### ç¼“å­˜æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æè¿° | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ |
|------|------|--------|---------|
| ç¼“å­˜å‘½ä¸­ç‡ | TotalHits / TotalQueries | â‰¥ 80% | < 70% |
| å¹³å‡æŸ¥è¯¢æ—¶é—´ | ç¼“å­˜è¯»å–å¹³å‡è€—æ—¶ | < 5ms | > 10ms |
| ç¼“å­˜å®¹é‡ | å½“å‰ç¼“å­˜å®ä½“æ•° | - | > 90% MaxCachedEntities |
| å¤±æ•ˆæ¬¡æ•° | æ¯åˆ†é’Ÿå¤±æ•ˆæ¬¡æ•° | - | > 1000/min |
| LRU æ¸…ç†æ¬¡æ•° | æ¯åˆ†é’Ÿ LRU æ¸…ç† | - | > 100/min |

#### æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æè¿° | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ |
|------|------|--------|---------|
| æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•° | æ¯åˆ†é’ŸæŸ¥è¯¢æ¬¡æ•° | 200-600/min | > 2000/min |
| è¿æ¥æ± åˆ©ç”¨ç‡ | æ´»è·ƒè¿æ¥ / æ€»è¿æ¥ | 30-50% | > 80% |
| æŸ¥è¯¢è€—æ—¶ P95 | 95% æŸ¥è¯¢è€—æ—¶ | < 50ms | > 100ms |

#### ç³»ç»Ÿèµ„æºæŒ‡æ ‡

| æŒ‡æ ‡ | æè¿° | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ |
|------|------|--------|---------|
| å†…å­˜ä½¿ç”¨ | è¿›ç¨‹å†…å­˜ | 500-650MB | > 1GB |
| GC é¢‘ç‡ | æ¯åˆ†é’Ÿ GC æ¬¡æ•° | < 10 | > 30 |
| CPU åˆ©ç”¨ç‡ | CPU ä½¿ç”¨ç™¾åˆ†æ¯” | < 50% | > 80% |

### ç›‘æ§ API

```csharp
// GET /api/cache/statistics
{
  "character": {
    "totalHits": 15420,
    "totalMisses": 3580,
    "hitRate": 81.2,
    "cachedCount": 2345,
    "dirtyCount": 123,
    "invalidationCount": 456,
    "averageQueryMs": 3.5
  },
  "battle": { ... },
  "activityPlan": { ... }
}

// GET /api/cache/health
{
  "status": "Healthy",
  "checks": [
    {
      "name": "CacheHitRate",
      "status": "Healthy",
      "description": "Hit rate: 81.2% (>= 70%)"
    },
    {
      "name": "MemoryUsage",
      "status": "Healthy",
      "description": "Memory: 580MB (< 1GB)"
    }
  ]
}
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### é—®é¢˜ 1: ç¼“å­˜å‘½ä¸­ç‡ä½ (<70%)

**å¯èƒ½åŸå› **:
1. TTL è®¾ç½®è¿‡çŸ­
2. æ•°æ®å˜æ›´é¢‘ç¹è§¦å‘å¤±æ•ˆ
3. æŸ¥è¯¢æ¨¡å¼ä¸é€‚åˆç¼“å­˜

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ TTL é…ç½®
2. æŸ¥çœ‹å¤±æ•ˆç»Ÿè®¡
3. åˆ†ææŸ¥è¯¢æ¨¡å¼

**è§£å†³æ–¹æ¡ˆ**:
- å»¶é•¿ TTLï¼ˆå¦‚ä» 5 åˆ†é’Ÿæ”¹ä¸º 10 åˆ†é’Ÿï¼‰
- è°ƒæ•´ InvalidateOnWrite ç­–ç•¥
- ç¦ç”¨ä¸é€‚åˆç¼“å­˜çš„å®ä½“ç±»å‹

#### é—®é¢˜ 2: å†…å­˜å ç”¨è¿‡é«˜

**å¯èƒ½åŸå› **:
1. MaxCachedEntities è®¾ç½®è¿‡å¤§
2. LRU æ¸…ç†ä¸ç”Ÿæ•ˆ
3. å†…å­˜æ³„æ¼

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ CachedCount
2. æŸ¥çœ‹ LRU æ¸…ç†ç»Ÿè®¡
3. ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·

**è§£å†³æ–¹æ¡ˆ**:
- é™ä½ MaxCachedEntities
- ç¼©çŸ­ TTL
- æ‰‹åŠ¨è§¦å‘ InvalidateAll

#### é—®é¢˜ 3: æ•°æ®ä¸ä¸€è‡´

**å¯èƒ½åŸå› **:
1. ç¼“å­˜å¤±æ•ˆæœºåˆ¶æœªç”Ÿæ•ˆ
2. å¹¶å‘æ›´æ–°å†²çª
3. æ•°æ®åº“ç›´æ¥ä¿®æ”¹æœªé€šçŸ¥ç¼“å­˜

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ InvalidateOnWrite é…ç½®
2. æŸ¥çœ‹å¤±æ•ˆæ—¥å¿—
3. éªŒè¯å¹¶å‘æ§åˆ¶

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ InvalidateOnWrite=true
- æ‰‹åŠ¨è°ƒç”¨ Invalidate
- æš‚æ—¶ç¦ç”¨ç¼“å­˜éªŒè¯

---

## æ€§èƒ½è°ƒä¼˜

### è°ƒä¼˜æŒ‡å—

#### 1. æ ¹æ®ä¸šåŠ¡ç‰¹æ€§è°ƒæ•´ TTL

**åŠ¨æ€æ•°æ®**ï¼ˆå¦‚è§’è‰²åœ¨çº¿çŠ¶æ€ï¼‰:
```json
{
  "Character": {
    "TimeToLiveSeconds": 60  // 1åˆ†é’Ÿï¼Œå¿«é€Ÿåæ˜ å˜åŒ–
  }
}
```

**åŠé™æ€æ•°æ®**ï¼ˆå¦‚è£…å¤‡ï¼‰:
```json
{
  "EquipmentInstance": {
    "TimeToLiveSeconds": 1800  // 30åˆ†é’Ÿ
  }
}
```

**é™æ€æ•°æ®**ï¼ˆå¦‚æŠ€èƒ½å®šä¹‰ï¼‰:
```json
{
  "SkillDefinition": {
    "TimeToLiveSeconds": 86400  // 24å°æ—¶
  }
}
```

#### 2. æ ¹æ®è´Ÿè½½è°ƒæ•´å®¹é‡

**ä½è´Ÿè½½åœºæ™¯** (<50 åœ¨çº¿ç”¨æˆ·):
```json
{
  "MaxCachedEntities": 10000
}
```

**ä¸­è´Ÿè½½åœºæ™¯** (50-200 åœ¨çº¿ç”¨æˆ·):
```json
{
  "MaxCachedEntities": 50000
}
```

**é«˜è´Ÿè½½åœºæ™¯** (>200 åœ¨çº¿ç”¨æˆ·):
```json
{
  "MaxCachedEntities": 100000
}
```

#### 3. ä¼˜åŒ–é¢„çƒ­ç­–ç•¥

**ä»…é¢„çƒ­é™æ€æ•°æ®**:
```json
{
  "WarmUp": {
    "EnableOnStartup": true,
    "EntityTypes": [
      "SkillDefinition",
      "ItemDefinition",
      "MonsterTemplate"
    ]
  }
}
```

---

## å›æ»šæ–¹æ¡ˆ

### å¿«é€Ÿå›æ»š

**æ­¥éª¤ 1**: ä¿®æ”¹é…ç½®
```json
{
  "Cache": {
    "EnableReadCache": false  // æ”¹ä¸º false
  }
}
```

**æ­¥éª¤ 2**: é‡å¯æœåŠ¡
```bash
systemctl restart blazoridle-server
```

**æ­¥éª¤ 3**: éªŒè¯åŠŸèƒ½
```bash
curl http://localhost:5000/api/characters/{id}
```

**æ­¥éª¤ 4**: ç›‘æ§æ—¥å¿—
```bash
tail -f /var/log/blazoridle/app.log
```

### å®Œå…¨å›æ»š

å¦‚æœéœ€è¦å›æ»šåˆ°ä¼˜åŒ–å‰çš„ç‰ˆæœ¬ï¼š

1. æ¢å¤ä»£ç åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
2. æ¢å¤æ•°æ®åº“ï¼ˆå¦‚æœ‰å˜æ›´ï¼‰
3. é‡å¯æœåŠ¡
4. éªŒè¯åŠŸèƒ½

---

## è¿ç»´æ‰‹å†Œ

### æ—¥å¸¸ç›‘æ§æ¸…å•

#### æ¯å¤©æ£€æŸ¥

- [ ] æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡ (åº”è¯¥ â‰¥ 80%)
- [ ] æ£€æŸ¥å†…å­˜ä½¿ç”¨ (åº”è¯¥ < 1GB)
- [ ] æ£€æŸ¥é”™è¯¯æ—¥å¿—
- [ ] æ£€æŸ¥ API å“åº”æ—¶é—´

#### æ¯å‘¨æ£€æŸ¥

- [ ] ç”Ÿæˆæ€§èƒ½å¯¹æ¯”æŠ¥å‘Š
- [ ] åˆ†æç¼“å­˜å¤±æ•ˆæ¨¡å¼
- [ ] è¯„ä¼° TTL é…ç½®æ˜¯å¦åˆç†
- [ ] æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°è¶‹åŠ¿

#### æ¯æœˆæ£€æŸ¥

- [ ] å®Œæ•´æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] è¯„ä¼°å®¹é‡è§„åˆ’
- [ ] ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
- [ ] æ›´æ–°ç›‘æ§é˜ˆå€¼

### å¸¸ç”¨å‘½ä»¤

**æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡**:
```bash
curl http://localhost:5000/api/cache/statistics | jq
```

**æ‰‹åŠ¨å¤±æ•ˆæ‰€æœ‰ç¼“å­˜**:
```bash
curl -X POST http://localhost:5000/api/cache/invalidate-all?entityType=Character
```

**æ£€æŸ¥å¥åº·çŠ¶æ€**:
```bash
curl http://localhost:5000/api/cache/health
```

---

## æ€»ç»“

### ä¸‹ç¯‡è¦ç‚¹å›é¡¾

1. **å®Œæ•´çš„æµ‹è¯•è®¡åˆ’**
   - å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
   - è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹å’Œä»£ç ç¤ºä¾‹

2. **æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†**
   - åŠŸèƒ½éªŒæ”¶ã€æ€§èƒ½éªŒæ”¶ã€è´¨é‡éªŒæ”¶
   - é‡åŒ–æŒ‡æ ‡å’ŒéªŒæ”¶æ¡ä»¶

3. **æ¸è¿›å¼éƒ¨ç½²ç­–ç•¥**
   - å¼€å‘ç¯å¢ƒ â†’ æµ‹è¯•ç¯å¢ƒ â†’ ç°åº¦å‘å¸ƒ â†’ å…¨é¢å¯ç”¨
   - æ¯ä¸ªé˜¶æ®µçš„éªŒæ”¶æ ‡å‡†å’Œå›æ»šæ¡ä»¶

4. **å®Œå–„çš„ç›‘æ§ä½“ç³»**
   - å…³é”®æŒ‡æ ‡å®šä¹‰
   - å‘Šè­¦é˜ˆå€¼è®¾ç½®
   - ç›‘æ§ API è®¾è®¡

5. **æ•…éšœæ’æŸ¥æŒ‡å—**
   - å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
   - æ’æŸ¥æ­¥éª¤å’Œè¯Šæ–­æ–¹æ³•

6. **æ€§èƒ½è°ƒä¼˜æŒ‡å—**
   - æ ¹æ®ä¸šåŠ¡ç‰¹æ€§è°ƒæ•´å‚æ•°
   - å®¹é‡è§„åˆ’å»ºè®®

7. **å›æ»šæ–¹æ¡ˆ**
   - å¿«é€Ÿå›æ»šæ­¥éª¤
   - å®Œå…¨å›æ»šæµç¨‹

8. **è¿ç»´æ‰‹å†Œ**
   - æ—¥å¸¸ç›‘æ§æ¸…å•
   - å¸¸ç”¨å‘½ä»¤

---

**æ–‡æ¡£çŠ¶æ€**: âœ… æµ‹è¯•ä¸éªŒæ”¶æ–‡æ¡£å®Œæˆ  
**ä¸‹ä¸€æ–‡æ¡£**: æ•°æ®åº“è¯»å–ä¼˜åŒ–éªŒæ”¶æ–‡æ¡£.md
