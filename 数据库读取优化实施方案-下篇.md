# BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - ä¸‹ç¯‡

**é˜¶æ®µ**: Phase 3 - ä¼˜åŒ–ã€ç›‘æ§å’ŒéªŒæ”¶  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-18  
**å·¥ä½œé‡ä¼°ç®—**: 2-3 å¤©  
**å‰ç½®æ¡ä»¶**: Phase 1-2 (ä¸Šç¯‡ã€ä¸­ç¯‡) å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

1. [é˜¶æ®µç›®æ ‡](#é˜¶æ®µç›®æ ‡)
2. [æ ¸å¿ƒä»»åŠ¡æ¸…å•](#æ ¸å¿ƒä»»åŠ¡æ¸…å•)
3. [æ€§èƒ½è°ƒä¼˜](#æ€§èƒ½è°ƒä¼˜)
4. [ç›‘æ§å®Œå–„](#ç›‘æ§å®Œå–„)
5. [ç®¡ç†æ¥å£](#ç®¡ç†æ¥å£)
6. [æ–‡æ¡£å’ŒéªŒæ”¶](#æ–‡æ¡£å’ŒéªŒæ”¶)
7. [ç”Ÿäº§éƒ¨ç½²æŒ‡å—](#ç”Ÿäº§éƒ¨ç½²æŒ‡å—)

---

## é˜¶æ®µç›®æ ‡

### ä¸»è¦ç›®æ ‡

**å®Œå–„ç¼“å­˜ç³»ç»Ÿï¼Œæä¾›ç”Ÿäº§å°±ç»ªçš„ç›‘æ§å’Œç®¡ç†èƒ½åŠ›ã€‚**

å…·ä½“ç›®æ ‡ï¼š
1. âœ… æ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜
2. âœ… å®Œå–„ç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦
3. âœ… æä¾›ç®¡ç†æ¥å£ï¼ˆæ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ã€æŸ¥çœ‹çŠ¶æ€ï¼‰
4. âœ… ç¼–å†™å®Œæ•´æ–‡æ¡£
5. âœ… ç”ŸæˆéªŒæ”¶æŠ¥å‘Š

### å…³é”®æˆæœ

1. **æ€§èƒ½ç›®æ ‡è¾¾æˆ**ï¼š
   - æ•°æ®åº“è¯»å–å‡å°‘ 85-90%
   - API å“åº”æ—¶é—´æ”¹å–„ 30-50%
   - ç¼“å­˜å‘½ä¸­ç‡è¾¾æ ‡

2. **ç›‘æ§å®Œå–„**ï¼š
   - å®æ—¶æ€§èƒ½æŒ‡æ ‡
   - ç¼“å­˜å¥åº·çŠ¶æ€
   - å‘Šè­¦æœºåˆ¶

3. **å¯è¿ç»´**ï¼š
   - æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ API
   - è¯Šæ–­å·¥å…·
   - è¿ç»´æ–‡æ¡£

---

## æ ¸å¿ƒä»»åŠ¡æ¸…å•

### Task 1: æ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜ï¼ˆ1å¤©ï¼‰

#### 1.1 åŸºå‡†æµ‹è¯•
- [ ] æµ‹è¯•å„å®ä½“ç±»å‹çš„ç¼“å­˜å‘½ä¸­ç‡
- [ ] æµ‹è¯• API å“åº”æ—¶é—´ï¼ˆP50, P95, P99ï¼‰
- [ ] æµ‹è¯•å†…å­˜ä½¿ç”¨æƒ…å†µ
- [ ] æµ‹è¯•å¹¶å‘èƒ½åŠ›

#### 1.2 å‹åŠ›æµ‹è¯•
- [ ] 100 ä¸ªåœ¨çº¿ç”¨æˆ·æŒç»­ 1 å°æ—¶
- [ ] 10 ä¸ªå¹¶å‘æˆ˜æ–—æŒç»­ 30 åˆ†é’Ÿ
- [ ] å†…å­˜æ³„æ¼æ£€æµ‹
- [ ] GC æ€§èƒ½ç›‘æ§

#### 1.3 æ€§èƒ½è°ƒä¼˜
- [ ] æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´é…ç½®å‚æ•°
- [ ] ä¼˜åŒ–ç¼“å­˜æ¸…ç†ç­–ç•¥
- [ ] ä¼˜åŒ– LRU ç®—æ³•
- [ ] å‡å°‘ä¸å¿…è¦çš„ç¼“å­˜

**å·¥ä½œé‡**ï¼š6-8 å°æ—¶

---

### Task 2: ç›‘æ§å®Œå–„ï¼ˆ0.5å¤©ï¼‰

#### 2.1 æ·»åŠ æ€§èƒ½æ—¥å¿—
- [ ] å®šæœŸè¾“å‡ºç¼“å­˜å‘½ä¸­ç‡
- [ ] å®šæœŸè¾“å‡ºå†…å­˜ä½¿ç”¨
- [ ] å®šæœŸè¾“å‡ºæ¸…ç†ç»Ÿè®¡
- [ ] å¼‚å¸¸æ—¥å¿—å¢å¼º

#### 2.2 é›†æˆ Prometheus æŒ‡æ ‡ï¼ˆå¯é€‰ï¼‰
- [ ] CacheHitRate æŒ‡æ ‡
- [ ] CacheSize æŒ‡æ ‡
- [ ] DatabaseReadCount æŒ‡æ ‡
- [ ] ApiResponseTime æŒ‡æ ‡

#### 2.3 å‘Šè­¦é…ç½®
- [ ] ç¼“å­˜å‘½ä¸­ç‡ä½äºé˜ˆå€¼å‘Šè­¦
- [ ] å†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼å‘Šè­¦
- [ ] æ•°æ®åº“è¯»å–å¼‚å¸¸å¢å¤šå‘Šè­¦

**å·¥ä½œé‡**ï¼š3-4 å°æ—¶

---

### Task 3: ç®¡ç†æ¥å£ï¼ˆ0.5å¤©ï¼‰

#### 3.1 ç¼“å­˜åˆ·æ–° API
- [ ] POST /api/admin/cache/refresh/{entityType}
- [ ] POST /api/admin/cache/refresh-all
- [ ] æƒé™ä¿æŠ¤ï¼ˆAdmin onlyï¼‰

#### 3.2 ç¼“å­˜è¯Šæ–­ API
- [ ] GET /api/admin/cache/diagnostics
- [ ] GET /api/admin/cache/entity/{entityType}
- [ ] è¯¦ç»†çš„ç¼“å­˜çŠ¶æ€ä¿¡æ¯

#### 3.3 é…ç½®çƒ­æ›´æ–° APIï¼ˆå¯é€‰ï¼‰
- [ ] POST /api/admin/cache/config/reload
- [ ] åŠ¨æ€è°ƒæ•´ TTLã€æ¸…ç†é—´éš”ç­‰

**å·¥ä½œé‡**ï¼š3-4 å°æ—¶

---

### Task 4: æ–‡æ¡£å’ŒéªŒæ”¶ï¼ˆ0.5å¤©ï¼‰

#### 4.1 æŠ€æœ¯æ–‡æ¡£
- [ ] ç¼“å­˜æ¶æ„è¯´æ˜
- [ ] é…ç½®å‚æ•°è¯¦è§£
- [ ] æ•…éšœæ’æŸ¥æŒ‡å—
- [ ] æ€§èƒ½è°ƒä¼˜æŒ‡å—

#### 4.2 è¿ç»´æ–‡æ¡£
- [ ] éƒ¨ç½²æµç¨‹
- [ ] ç›‘æ§æŒ‡æ ‡è¯´æ˜
- [ ] å¸¸è§é—®é¢˜è§£ç­”
- [ ] å›é€€æµç¨‹

#### 4.3 éªŒæ”¶æ–‡æ¡£
- [ ] åŠŸèƒ½éªŒæ”¶æ¸…å•
- [ ] æ€§èƒ½éªŒæ”¶æŠ¥å‘Š
- [ ] æµ‹è¯•è¦†ç›–æŠ¥å‘Š
- [ ] æœ€ç»ˆéªŒæ”¶æŠ¥å‘Š

**å·¥ä½œé‡**ï¼š3-4 å°æ—¶

---

## æ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜

### åŸºå‡†æµ‹è¯•æ–¹æ¡ˆ

#### æµ‹è¯•ç¯å¢ƒ

```
ç¡¬ä»¶é…ç½®ï¼š
- CPU: 4 æ ¸
- å†…å­˜: 8 GB
- ç£ç›˜: SSD

è½¯ä»¶é…ç½®ï¼š
- .NET 8.0
- SQLite 3
- æµ‹è¯•æ•°æ®ï¼š500 ä¸ªè£…å¤‡å®šä¹‰ã€100 ä¸ªè§’è‰²ã€1000 ä¸ªè£…å¤‡å®ä¾‹
```

#### æµ‹è¯•è„šæœ¬

**æµ‹è¯• 1: ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•**

```csharp
[Fact]
public async Task CacheHitRate_BenchmarkTest()
{
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    var characterIds = GenerateTestCharacterIds(100);
    
    // é¢„çƒ­ï¼šåŠ è½½æ‰€æœ‰è§’è‰²åˆ°ç¼“å­˜
    foreach (var id in characterIds)
    {
        await _characterRepo.GetAsync(id);
    }
    
    // æµ‹è¯•ï¼š1000 æ¬¡éšæœºæŸ¥è¯¢
    var random = new Random();
    var hitCount = 0;
    var missCount = 0;
    
    for (int i = 0; i < 1000; i++)
    {
        var randomId = characterIds[random.Next(characterIds.Count)];
        var character = await _characterRepo.GetAsync(randomId);
        
        // ç»Ÿè®¡å‘½ä¸­ç‡
        var stats = _memoryManager.GetCacheStatistics();
        // ...
    }
    
    var hitRate = (double)hitCount / (hitCount + missCount);
    
    _logger.LogInformation("ç¼“å­˜å‘½ä¸­ç‡: {HitRate:P}", hitRate);
    Assert.True(hitRate >= 0.80, $"ç¼“å­˜å‘½ä¸­ç‡ {hitRate:P} ä½äº 80%");
}
```

**æµ‹è¯• 2: API å“åº”æ—¶é—´æµ‹è¯•**

```csharp
[Fact]
public async Task ApiResponseTime_BenchmarkTest()
{
    var characterId = Guid.NewGuid();
    
    // é¢„çƒ­
    await _characterRepo.GetAsync(characterId);
    
    // æµ‹è¯• 1000 æ¬¡
    var durations = new List<long>();
    
    for (int i = 0; i < 1000; i++)
    {
        var sw = Stopwatch.StartNew();
        await _characterRepo.GetAsync(characterId);
        sw.Stop();
        
        durations.Add(sw.ElapsedMilliseconds);
    }
    
    // ç»Ÿè®¡
    var p50 = durations.OrderBy(x => x).ElementAt((int)(durations.Count * 0.5));
    var p95 = durations.OrderBy(x => x).ElementAt((int)(durations.Count * 0.95));
    var p99 = durations.OrderBy(x => x).ElementAt((int)(durations.Count * 0.99));
    
    _logger.LogInformation("å“åº”æ—¶é—´ P50: {P50}ms, P95: {P95}ms, P99: {P99}ms",
        p50, p95, p99);
    
    Assert.True(p95 < 5, $"P95 å“åº”æ—¶é—´ {p95}ms è¶…è¿‡ 5ms");
}
```

**æµ‹è¯• 3: å†…å­˜ä½¿ç”¨æµ‹è¯•**

```csharp
[Fact]
public async Task MemoryUsage_BenchmarkTest()
{
    var initialMemory = GC.GetTotalMemory(true);
    
    // åŠ è½½å¤§é‡æ•°æ®åˆ°ç¼“å­˜
    for (int i = 0; i < 10000; i++)
    {
        var character = new Character { Id = Guid.NewGuid(), Name = $"Char{i}" };
        _memoryManager.Add(character);
    }
    
    var usedMemory = GC.GetTotalMemory(false) - initialMemory;
    var usedMemoryMB = usedMemory / 1024.0 / 1024.0;
    
    _logger.LogInformation("ç¼“å­˜ 10000 ä¸ªè§’è‰²ï¼Œå†…å­˜ä½¿ç”¨: {MemoryMB:F2} MB", usedMemoryMB);
    
    Assert.True(usedMemoryMB < 50, $"å†…å­˜ä½¿ç”¨ {usedMemoryMB:F2} MB è¶…è¿‡ 50 MB");
}
```

### å‹åŠ›æµ‹è¯•æ–¹æ¡ˆ

**æµ‹è¯•åœºæ™¯ 1: é«˜å¹¶å‘æŸ¥è¯¢**

```csharp
[Fact]
public async Task HighConcurrency_StressTest()
{
    var characterIds = GenerateTestCharacterIds(100);
    var tasks = new List<Task>();
    
    // 100 ä¸ªå¹¶å‘ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡æŸ¥è¯¢ 100 æ¬¡
    for (int i = 0; i < 100; i++)
    {
        tasks.Add(Task.Run(async () =>
        {
            var random = new Random();
            for (int j = 0; j < 100; j++)
            {
                var id = characterIds[random.Next(characterIds.Count)];
                await _characterRepo.GetAsync(id);
            }
        }));
    }
    
    await Task.WhenAll(tasks);
    
    // éªŒè¯ï¼šæ— å¼‚å¸¸ï¼Œç¼“å­˜çŠ¶æ€æ­£å¸¸
    var stats = _memoryManager.GetCacheStatistics();
    Assert.True(stats.HitRate > 0.5);
}
```

**æµ‹è¯•åœºæ™¯ 2: é•¿æ—¶é—´è¿è¡Œ**

```csharp
[Fact]
public async Task LongRunning_StressTest()
{
    var cts = new CancellationTokenSource(TimeSpan.FromMinutes(60));
    var queryCount = 0;
    
    while (!cts.Token.IsCancellationRequested)
    {
        // æ¨¡æ‹Ÿæ­£å¸¸ä¸šåŠ¡æµé‡
        await SimulateUserActivityAsync();
        queryCount++;
        
        // æ¯ 1000 æ¬¡æŸ¥è¯¢æ£€æŸ¥ä¸€æ¬¡å†…å­˜
        if (queryCount % 1000 == 0)
        {
            var memory = GC.GetTotalMemory(false);
            _logger.LogInformation("æŸ¥è¯¢ {Count} æ¬¡ï¼Œå†…å­˜ä½¿ç”¨: {MemoryMB:F2} MB",
                queryCount, memory / 1024.0 / 1024.0);
        }
        
        await Task.Delay(100); // æ¨¡æ‹Ÿè¯·æ±‚é—´éš”
    }
    
    // éªŒè¯ï¼šå†…å­˜æ— æ³„æ¼
    GC.Collect();
    var finalMemory = GC.GetTotalMemory(true);
    Assert.True(finalMemory < 500 * 1024 * 1024, "å†…å­˜æ³„æ¼æ£€æµ‹å¤±è´¥");
}
```

### æ€§èƒ½è°ƒä¼˜æŒ‡å—

#### è°ƒä¼˜å‚æ•°

| å‚æ•° | åˆå§‹å€¼ | è°ƒä¼˜å»ºè®® | è¯´æ˜ |
|-----|-------|---------|------|
| TtlSeconds (Character) | 3600 | æ ¹æ®åœ¨çº¿æ—¶é•¿è°ƒæ•´ | æ´»è·ƒç”¨æˆ·å¯å»¶é•¿è‡³ 7200 |
| TtlSeconds (GearInstance) | 1800 | æ ¹æ®è£…å¤‡å˜æ›´é¢‘ç‡ | å¾ˆå°‘å˜æ›´å¯å»¶é•¿è‡³ 3600 |
| MaxCachedCount | 10000 | æ ¹æ®å®é™…ç”¨æˆ·æ•° | é¿å…é¢‘ç¹ LRU æ¸…ç† |
| CleanupIntervalMinutes | 5 | æ ¹æ®è¿‡æœŸé€Ÿåº¦ | å¯å»¶é•¿è‡³ 10 å‡å°‘å¼€é”€ |

#### è°ƒä¼˜æ­¥éª¤

1. **æ”¶é›†åŸºå‡†æ•°æ®**
   ```bash
   # å¯åŠ¨ç›‘æ§
   curl http://localhost:5000/api/database/cache-stats
   
   # è®°å½•åˆå§‹æŒ‡æ ‡
   - ç¼“å­˜å‘½ä¸­ç‡
   - å†…å­˜ä½¿ç”¨
   - API å“åº”æ—¶é—´
   ```

2. **è¯†åˆ«ç“¶é¢ˆ**
   - å‘½ä¸­ç‡ä½äº 70%ï¼Ÿâ†’ å¢åŠ  TTL æˆ– MaxCachedCount
   - å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Ÿâ†’ å‡å°‘ MaxCachedCount æˆ– TTL
   - LRU æ¸…ç†é¢‘ç¹ï¼Ÿâ†’ å¢åŠ  MaxCachedCount

3. **è°ƒæ•´å‚æ•°**
   ```json
   {
     "CacheConfiguration": {
       "EntityStrategies": {
         "Character": {
           "TtlSeconds": 7200,  // ä» 3600 å¢åŠ åˆ° 7200
           "MaxCachedCount": 20000  // ä» 10000 å¢åŠ åˆ° 20000
         }
       }
     }
   }
   ```

4. **é‡æ–°æµ‹è¯•**
   - é‡å¯æœåŠ¡
   - è¿è¡Œç›¸åŒçš„æµ‹è¯•
   - å¯¹æ¯”æŒ‡æ ‡æ”¹å–„

5. **è¿­ä»£ä¼˜åŒ–**
   - é‡å¤æ­¥éª¤ 2-4
   - ç›´åˆ°è¾¾åˆ°æ€§èƒ½ç›®æ ‡

---

## ç›‘æ§å®Œå–„

### æ€§èƒ½æ—¥å¿—å¢å¼º

#### å®šæœŸæ—¥å¿—è¾“å‡º

**åœ¨ CacheCoordinator ä¸­æ·»åŠ **ï¼š

```csharp
/// <summary>
/// å®šæœŸè¾“å‡ºç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
/// Periodic cache statistics logging
/// </summary>
private async Task LogCacheStatisticsAsync(CancellationToken ct)
{
    var interval = TimeSpan.FromMinutes(
        _cacheConfig.Value.GlobalSettings.HitRateLogIntervalMinutes);
    
    while (!ct.IsCancellationRequested)
    {
        try
        {
            await Task.Delay(interval, ct);
            
            _logger.LogInformation("=== ç¼“å­˜ç»Ÿè®¡æŠ¥å‘Š ===");
            
            // è¾“å‡ºå„å®ä½“ç±»å‹çš„ç»Ÿè®¡
            LogEntityStatistics("GearDefinition", _gearDefManager);
            LogEntityStatistics("Affix", _affixManager);
            LogEntityStatistics("Character", _characterManager);
            LogEntityStatistics("GearInstance", _gearInstanceManager);
            LogEntityStatistics("ActivityPlan", _activityPlanManager);
            
            _logger.LogInformation("==================");
        }
        catch (OperationCanceledException)
        {
            break;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è¾“å‡ºç¼“å­˜ç»Ÿè®¡ä¿¡æ¯å¤±è´¥");
        }
    }
}

private void LogEntityStatistics<T>(
    string entityType,
    IMemoryStateManager<T>? manager) where T : class, IEntity
{
    if (manager == null)
        return;
    
    var stats = manager.GetCacheStatistics();
    
    _logger.LogInformation(
        "{EntityType}: ç¼“å­˜ {CachedCount} ä¸ª, Dirty {DirtyCount} ä¸ª, " +
        "å‘½ä¸­ {Hits} æ¬¡, æœªå‘½ä¸­ {Misses} æ¬¡, å‘½ä¸­ç‡ {HitRate:P}",
        entityType, stats.CachedCount, stats.DirtyCount,
        stats.CacheHits, stats.CacheMisses, stats.HitRate
    );
}
```

#### å¼‚å¸¸æ—¥å¿—å¢å¼º

```csharp
// åœ¨ MemoryStateManager.TryGetAsync ä¸­
try
{
    // ... æŸ¥è¯¢é€»è¾‘
}
catch (Exception ex)
{
    _logger.LogError(ex, 
        "ç¼“å­˜è¯»å–å¤±è´¥: EntityType={EntityType}, Id={Id}",
        typeof(T).Name, id);
    
    // é™çº§ï¼šç›´æ¥æŸ¥æ•°æ®åº“
    return await databaseLoader(id, ct);
}
```

### Prometheus é›†æˆï¼ˆå¯é€‰ï¼‰

å¦‚æœé¡¹ç›®ä½¿ç”¨ Prometheus ç›‘æ§ï¼Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡ï¼š

```csharp
/// <summary>
/// Prometheus æŒ‡æ ‡æ”¶é›†å™¨
/// </summary>
public class CachePrometheusMetrics
{
    private readonly Counter _cacheHits;
    private readonly Counter _cacheMisses;
    private readonly Gauge _cacheSize;
    private readonly Gauge _dirtySize;
    
    public CachePrometheusMetrics()
    {
        _cacheHits = Metrics.CreateCounter(
            "blazoridle_cache_hits_total",
            "Total number of cache hits",
            new CounterConfiguration { LabelNames = new[] { "entity_type" } }
        );
        
        _cacheMisses = Metrics.CreateCounter(
            "blazoridle_cache_misses_total",
            "Total number of cache misses",
            new CounterConfiguration { LabelNames = new[] { "entity_type" } }
        );
        
        _cacheSize = Metrics.CreateGauge(
            "blazoridle_cache_size",
            "Number of cached entities",
            new GaugeConfiguration { LabelNames = new[] { "entity_type" } }
        );
        
        _dirtySize = Metrics.CreateGauge(
            "blazoridle_cache_dirty_size",
            "Number of dirty entities",
            new GaugeConfiguration { LabelNames = new[] { "entity_type" } }
        );
    }
    
    public void RecordHit(string entityType) => _cacheHits.WithLabels(entityType).Inc();
    public void RecordMiss(string entityType) => _cacheMisses.WithLabels(entityType).Inc();
    public void UpdateCacheSize(string entityType, int count) 
        => _cacheSize.WithLabels(entityType).Set(count);
    public void UpdateDirtySize(string entityType, int count) 
        => _dirtySize.WithLabels(entityType).Set(count);
}
```

### å‘Šè­¦é…ç½®

**å‘Šè­¦è§„åˆ™**ï¼ˆåŸºäºæ—¥å¿—æˆ– Prometheusï¼‰ï¼š

```yaml
# Prometheus å‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
  - name: blazoridle_cache_alerts
    rules:
      - alert: CacheHitRateLow
        expr: |
          (
            sum(rate(blazoridle_cache_hits_total[5m])) by (entity_type) /
            (
              sum(rate(blazoridle_cache_hits_total[5m])) by (entity_type) +
              sum(rate(blazoridle_cache_misses_total[5m])) by (entity_type)
            )
          ) < 0.7
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "ç¼“å­˜å‘½ä¸­ç‡ä½äº 70%"
          description: "å®ä½“ç±»å‹ {{ $labels.entity_type }} çš„ç¼“å­˜å‘½ä¸­ç‡ä¸º {{ $value | humanizePercentage }}"
      
      - alert: CacheSizeHigh
        expr: blazoridle_cache_size > 50000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ç¼“å­˜å¤§å°è¿‡å¤§"
          description: "å®ä½“ç±»å‹ {{ $labels.entity_type }} çš„ç¼“å­˜æ•°é‡ä¸º {{ $value }}"
```

---

## ç®¡ç†æ¥å£

### ç¼“å­˜åˆ·æ–° API

**æ–‡ä»¶**ï¼š`Api/Admin/CacheAdminController.cs`

```csharp
/// <summary>
/// ç¼“å­˜ç®¡ç† API æ§åˆ¶å™¨
/// Cache Administration API Controller
/// 
/// æä¾›ç¼“å­˜ç®¡ç†åŠŸèƒ½ï¼š
/// - åˆ·æ–°ç‰¹å®šå®ä½“ç±»å‹çš„ç¼“å­˜
/// - åˆ·æ–°æ‰€æœ‰ç¼“å­˜
/// - æŸ¥çœ‹ç¼“å­˜è¯Šæ–­ä¿¡æ¯
/// 
/// éœ€è¦ç®¡ç†å‘˜æƒé™
/// </summary>
[ApiController]
[Route("api/admin/cache")]
[Authorize(Roles = "Admin")] // éœ€è¦ç®¡ç†å‘˜æƒé™
public class CacheAdminController : ControllerBase
{
    private readonly CacheCoordinator _cacheCoordinator;
    private readonly ILogger<CacheAdminController> _logger;
    
    public CacheAdminController(
        CacheCoordinator cacheCoordinator,
        ILogger<CacheAdminController> logger)
    {
        _cacheCoordinator = cacheCoordinator;
        _logger = logger;
    }
    
    /// <summary>
    /// åˆ·æ–°ç‰¹å®šå®ä½“ç±»å‹çš„ç¼“å­˜
    /// Refresh cache for a specific entity type
    /// </summary>
    /// <param name="entityType">å®ä½“ç±»å‹åç§°ï¼ˆå¦‚ "GearDefinition", "Character"ï¼‰</param>
    /// <returns>åˆ·æ–°ç»“æœ</returns>
    /// <response code="200">åˆ·æ–°æˆåŠŸ</response>
    /// <response code="400">å®ä½“ç±»å‹ä¸æ”¯æŒ</response>
    /// <response code="401">æœªæˆæƒ</response>
    [HttpPost("refresh/{entityType}")]
    [ProducesResponseType(typeof(CacheRefreshResponse), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<CacheRefreshResponse>> RefreshCache(string entityType)
    {
        try
        {
            _logger.LogInformation(
                "ç®¡ç†å‘˜ {Admin} è¯·æ±‚åˆ·æ–° {EntityType} ç¼“å­˜",
                User.Identity?.Name, entityType
            );
            
            var result = await _cacheCoordinator.RefreshCacheAsync(entityType);
            
            if (!result.Success)
            {
                return BadRequest(new { error = result.ErrorMessage });
            }
            
            return Ok(new CacheRefreshResponse
            {
                EntityType = entityType,
                RefreshedCount = result.RefreshedCount,
                Message = $"å·²åˆ·æ–° {entityType} ç¼“å­˜ï¼Œå…± {result.RefreshedCount} ä¸ªå®ä½“"
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "åˆ·æ–°ç¼“å­˜å¤±è´¥: {EntityType}", entityType);
            return StatusCode(500, new { error = "åˆ·æ–°ç¼“å­˜å¤±è´¥" });
        }
    }
    
    /// <summary>
    /// åˆ·æ–°æ‰€æœ‰ç¼“å­˜
    /// Refresh all caches
    /// </summary>
    /// <returns>åˆ·æ–°ç»“æœ</returns>
    /// <response code="200">åˆ·æ–°æˆåŠŸ</response>
    /// <response code="401">æœªæˆæƒ</response>
    [HttpPost("refresh-all")]
    [ProducesResponseType(typeof(CacheRefreshAllResponse), StatusCodes.Status200OK)]
    public async Task<ActionResult<CacheRefreshAllResponse>> RefreshAllCaches()
    {
        try
        {
            _logger.LogWarning(
                "ç®¡ç†å‘˜ {Admin} è¯·æ±‚åˆ·æ–°æ‰€æœ‰ç¼“å­˜",
                User.Identity?.Name
            );
            
            var results = await _cacheCoordinator.RefreshAllCachesAsync();
            
            return Ok(new CacheRefreshAllResponse
            {
                TotalRefreshed = results.Sum(r => r.RefreshedCount),
                EntityResults = results.ToDictionary(r => r.EntityType, r => r.RefreshedCount),
                Message = $"å·²åˆ·æ–°æ‰€æœ‰ç¼“å­˜ï¼Œå…± {results.Sum(r => r.RefreshedCount)} ä¸ªå®ä½“"
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "åˆ·æ–°æ‰€æœ‰ç¼“å­˜å¤±è´¥");
            return StatusCode(500, new { error = "åˆ·æ–°æ‰€æœ‰ç¼“å­˜å¤±è´¥" });
        }
    }
    
    /// <summary>
    /// è·å–ç¼“å­˜è¯Šæ–­ä¿¡æ¯
    /// Get cache diagnostics
    /// </summary>
    /// <returns>è¯¦ç»†çš„ç¼“å­˜çŠ¶æ€ä¿¡æ¯</returns>
    [HttpGet("diagnostics")]
    [ProducesResponseType(typeof(CacheDiagnosticsResponse), StatusCodes.Status200OK)]
    public ActionResult<CacheDiagnosticsResponse> GetDiagnostics()
    {
        try
        {
            var diagnostics = _cacheCoordinator.GetDiagnostics();
            
            return Ok(diagnostics);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è·å–ç¼“å­˜è¯Šæ–­ä¿¡æ¯å¤±è´¥");
            return StatusCode(500, new { error = "è·å–è¯Šæ–­ä¿¡æ¯å¤±è´¥" });
        }
    }
}

/// <summary>
/// ç¼“å­˜åˆ·æ–°å“åº”
/// </summary>
public class CacheRefreshResponse
{
    public string EntityType { get; set; } = string.Empty;
    public int RefreshedCount { get; set; }
    public string Message { get; set; } = string.Empty;
}

/// <summary>
/// åˆ·æ–°æ‰€æœ‰ç¼“å­˜å“åº”
/// </summary>
public class CacheRefreshAllResponse
{
    public int TotalRefreshed { get; set; }
    public Dictionary<string, int> EntityResults { get; set; } = new();
    public string Message { get; set; } = string.Empty;
}

/// <summary>
/// ç¼“å­˜è¯Šæ–­å“åº”
/// </summary>
public class CacheDiagnosticsResponse
{
    public DateTime Timestamp { get; set; }
    public bool CacheEnabled { get; set; }
    public Dictionary<string, EntityDiagnostics> EntityDiagnostics { get; set; } = new();
}

public class EntityDiagnostics
{
    public int CachedCount { get; set; }
    public int DirtyCount { get; set; }
    public long CacheHits { get; set; }
    public long CacheMisses { get; set; }
    public double HitRate { get; set; }
    public string Strategy { get; set; } = string.Empty;
    public int TtlSeconds { get; set; }
}
```

### CacheCoordinator æ”¯æŒæ–¹æ³•

åœ¨ `CacheCoordinator` ä¸­æ·»åŠ ç®¡ç†æ–¹æ³•ï¼š

```csharp
/// <summary>
/// åˆ·æ–°ç‰¹å®šå®ä½“ç±»å‹çš„ç¼“å­˜
/// </summary>
public async Task<RefreshResult> RefreshCacheAsync(string entityType)
{
    switch (entityType)
    {
        case "GearDefinition":
            return await RefreshEntityCacheAsync(_gearDefManager, entityType);
        case "Affix":
            return await RefreshEntityCacheAsync(_affixManager, entityType);
        case "Character":
            return await RefreshEntityCacheAsync(_characterManager, entityType);
        case "GearInstance":
            return await RefreshEntityCacheAsync(_gearInstanceManager, entityType);
        case "ActivityPlan":
            return await RefreshEntityCacheAsync(_activityPlanManager, entityType);
        default:
            return new RefreshResult
            {
                Success = false,
                ErrorMessage = $"ä¸æ”¯æŒçš„å®ä½“ç±»å‹: {entityType}"
            };
    }
}

private async Task<RefreshResult> RefreshEntityCacheAsync<T>(
    IMemoryStateManager<T>? manager,
    string entityType) where T : class, IEntity
{
    if (manager == null)
    {
        return new RefreshResult
        {
            Success = false,
            ErrorMessage = $"MemoryStateManager for {entityType} not registered"
        };
    }
    
    // 1. æ¸…ç©ºç°æœ‰ç¼“å­˜
    manager.ClearAll();
    
    // 2. ä»æ•°æ®åº“é‡æ–°åŠ è½½
    using var scope = _scopeFactory.CreateScope();
    var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
    
    await manager.PreloadFromDatabaseAsync(db);
    
    var stats = manager.GetCacheStatistics();
    
    return new RefreshResult
    {
        Success = true,
        EntityType = entityType,
        RefreshedCount = stats.CachedCount
    };
}

public class RefreshResult
{
    public bool Success { get; set; }
    public string EntityType { get; set; } = string.Empty;
    public int RefreshedCount { get; set; }
    public string? ErrorMessage { get; set; }
}
```

---

## æ–‡æ¡£å’ŒéªŒæ”¶

### æŠ€æœ¯æ–‡æ¡£

#### 1. ç¼“å­˜æ¶æ„æ–‡æ¡£

åˆ›å»º `docs/CacheArchitecture.md`ï¼š

```markdown
# BlazorIdle ç¼“å­˜æ¶æ„æ–‡æ¡£

## æ¦‚è¿°

BlazorIdle å®ç°äº†ä¸€ä¸ªåˆ†å±‚ç¼“å­˜ç³»ç»Ÿï¼Œä¼˜å…ˆä½¿ç”¨å†…å­˜ç¼“å­˜ï¼Œæœªå‘½ä¸­æ—¶æ‰æŸ¥è¯¢æ•°æ®åº“ã€‚

## æ¶æ„å›¾

```
[API Layer]
     â†“
[Repository Layer]
     â†“
[MemoryStateManager] â† å†…å­˜ç¼“å­˜å±‚
     â†“ (cache miss)
[DbContext / EF Core]
     â†“
[SQLite Database]
```

## ç¼“å­˜ç­–ç•¥

### æ°¸ä¹…ç¼“å­˜ï¼ˆPermanentï¼‰
- é€‚ç”¨äºï¼šé™æ€é…ç½®æ•°æ®
- å®ä½“ï¼šGearDefinition, Affix, GearSet
- ç‰¹ç‚¹ï¼šå¯åŠ¨æ—¶é¢„åŠ è½½ï¼Œä¸è¿‡æœŸ

### ä¸´æ—¶ç¼“å­˜ï¼ˆTemporaryï¼‰
- é€‚ç”¨äºï¼šç”¨æˆ·æ•°æ®
- å®ä½“ï¼šCharacter, GearInstance, ActivityPlan
- ç‰¹ç‚¹ï¼šæŒ‰éœ€åŠ è½½ï¼ŒTTL è¿‡æœŸï¼ŒLRU æ¸…ç†

## è¯»å†™ååŒ

å†™å…¥æ“ä½œå’Œè¯»å–æ“ä½œå…±äº«åŒä¸€ä¸ª MemoryStateManagerï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

...
```

#### 2. é…ç½®å‚æ•°è¯¦è§£

åˆ›å»º `docs/CacheConfiguration.md`ï¼ˆå‚è€ƒä¸Šç¯‡ã€ä¸­ç¯‡ä¸­çš„é…ç½®è¯´æ˜ï¼‰

#### 3. æ•…éšœæ’æŸ¥æŒ‡å—

åˆ›å»º `docs/CacheTroubleshooting.md`ï¼š

```markdown
# ç¼“å­˜ç³»ç»Ÿæ•…éšœæ’æŸ¥æŒ‡å—

## å¸¸è§é—®é¢˜

### é—®é¢˜ 1: ç¼“å­˜å‘½ä¸­ç‡ä½

**ç—‡çŠ¶**ï¼š
- ç›‘æ§æ˜¾ç¤ºå‘½ä¸­ç‡ < 70%
- æ•°æ®åº“æŸ¥è¯¢é¢‘ç¹

**å¯èƒ½åŸå› **ï¼š
1. TTL è®¾ç½®è¿‡çŸ­
2. MaxCachedCount è¿‡å°å¯¼è‡´é¢‘ç¹æ¸…ç†
3. ç¼“å­˜æœªå¯ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥é…ç½®ï¼š`EnableReadCaching = true`
2. å¢åŠ  TTLï¼šCharacter ä» 3600 â†’ 7200
3. å¢åŠ  MaxCachedCountï¼š10000 â†’ 20000
4. æŸ¥çœ‹æ—¥å¿—ï¼šæ˜¯å¦æœ‰é¢‘ç¹çš„ LRU æ¸…ç†

### é—®é¢˜ 2: å†…å­˜ä½¿ç”¨è¿‡é«˜

**ç—‡çŠ¶**ï¼š
- å†…å­˜ä½¿ç”¨æŒç»­å¢é•¿
- GC é¢‘ç¹

**å¯èƒ½åŸå› **ï¼š
1. MaxCachedCount è®¾ç½®è¿‡å¤§
2. å†…å­˜æ³„æ¼

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å‡å°‘ MaxCachedCount
2. å‡å°‘ TTL
3. è¿è¡Œå‹åŠ›æµ‹è¯•æ£€æµ‹æ³„æ¼

...
```

### è¿ç»´æ–‡æ¡£

#### 1. éƒ¨ç½²æµç¨‹

åˆ›å»º `docs/DeploymentGuide.md`ï¼š

```markdown
# ç¼“å­˜ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## éƒ¨ç½²å‰æ£€æŸ¥

1. ç¡®è®¤ Phase 1-2 å·²å®Œæˆ
2. è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š`dotnet test`
3. æ€§èƒ½æµ‹è¯•é€šè¿‡
4. å¤‡ä»½æ•°æ®åº“

## éƒ¨ç½²æ­¥éª¤

### 1. é…ç½®æ›´æ–°

æ›´æ–° `appsettings.json` æˆ– `appsettings.Production.json`ï¼š

```json
{
  "CacheConfiguration": {
    "GlobalSettings": {
      "EnableReadCaching": true  // å¯ç”¨ç¼“å­˜
    }
  }
}
```

### 2. å‘å¸ƒåº”ç”¨

```bash
dotnet publish -c Release
```

### 3. é‡å¯æœåŠ¡

```bash
systemctl restart blazoridle
```

### 4. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status blazoridle

# æ£€æŸ¥ç¼“å­˜ç»Ÿè®¡
curl http://localhost:5000/api/database/cache-stats

# æ£€æŸ¥æ—¥å¿—
tail -f /var/log/blazoridle/app.log | grep "ç¼“å­˜"
```

## å›é€€æµç¨‹

å¦‚æœéƒ¨ç½²åå‡ºç°é—®é¢˜ï¼š

1. ç¦ç”¨ç¼“å­˜ï¼š
   ```json
   {
     "CacheConfiguration": {
       "GlobalSettings": {
         "EnableReadCaching": false
       }
     }
   }
   ```

2. é‡å¯æœåŠ¡
3. éªŒè¯åŠŸèƒ½æ¢å¤

...
```

### éªŒæ”¶æ–‡æ¡£

åˆ›å»ºç‹¬ç«‹çš„éªŒæ”¶æ–‡æ¡£ï¼ˆè§ä¸‹ä¸€èŠ‚ï¼‰ã€‚

---

## ç”Ÿäº§éƒ¨ç½²æŒ‡å—

### éƒ¨ç½²å‰æ¸…å•

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡
- [ ] å‹åŠ›æµ‹è¯•å®Œæˆ
- [ ] æ–‡æ¡£é½å…¨
- [ ] å¤‡ä»½æ•°æ®åº“
- [ ] å‡†å¤‡å›é€€æ–¹æ¡ˆ

### ç°åº¦å‘å¸ƒå»ºè®®

**é˜¶æ®µ 1: å°èŒƒå›´éªŒè¯ï¼ˆ1-2å¤©ï¼‰**
- ä»…åœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨
- ç›‘æ§æ—¥å¿—å’ŒæŒ‡æ ‡
- éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§

**é˜¶æ®µ 2: éƒ¨åˆ†ç”Ÿäº§ç¯å¢ƒï¼ˆ3-5å¤©ï¼‰**
- åœ¨ 10-20% çš„æœåŠ¡å™¨å¯ç”¨
- å¯†åˆ‡ç›‘æ§æ€§èƒ½å’Œé”™è¯¯
- æ”¶é›†ç”¨æˆ·åé¦ˆ

**é˜¶æ®µ 3: å…¨é‡éƒ¨ç½²ï¼ˆ7å¤©åï¼‰**
- åœ¨æ‰€æœ‰æœåŠ¡å™¨å¯ç”¨
- æŒç»­ç›‘æ§ 24-48 å°æ—¶
- ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š

### ç›‘æ§æŒ‡æ ‡

**å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡**ï¼š
- ç¼“å­˜å‘½ä¸­ç‡ï¼ˆç›®æ ‡ >80%ï¼‰
- æ•°æ®åº“è¯»å–æ¬¡æ•°ï¼ˆç›®æ ‡å‡å°‘ >85%ï¼‰
- API å“åº”æ—¶é—´ï¼ˆç›®æ ‡æ”¹å–„ >30%ï¼‰
- å†…å­˜ä½¿ç”¨ï¼ˆç›®æ ‡å¢åŠ  <200MBï¼‰
- é”™è¯¯ç‡ï¼ˆç›®æ ‡æ— å¢é•¿ï¼‰

### å‘Šè­¦é˜ˆå€¼

| æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | å¤„ç†æ–¹å¼ |
|-----|---------|---------|
| ç¼“å­˜å‘½ä¸­ç‡ | <70% | è°ƒæ•´ TTL æˆ– MaxCachedCount |
| å†…å­˜ä½¿ç”¨ | >2GB | å‡å°‘ç¼“å­˜å¤§å°æˆ–æ£€æŸ¥æ³„æ¼ |
| é”™è¯¯ç‡ | å¢é•¿ >10% | å›é€€é…ç½® |
| API å“åº”æ—¶é—´ | P95 >500ms | è°ƒæŸ¥æ€§èƒ½ç“¶é¢ˆ |

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] æ‰€æœ‰å®ä½“ç±»å‹å·²è¿ç§»åˆ°ç¼“å­˜è¯»å–
- [ ] é…ç½®å¼€å…³åŠŸèƒ½æ­£å¸¸ï¼ˆEnableReadCachingï¼‰
- [ ] æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ API å·¥ä½œæ­£å¸¸
- [ ] ç¼“å­˜è¯Šæ–­ API è¿”å›æ­£ç¡®ä¿¡æ¯
- [ ] è¯»å†™æ•°æ®ä¸€è‡´æ€§

### æ€§èƒ½éªŒæ”¶

- [ ] æ•°æ®åº“è¯»å–å‡å°‘ â‰¥85%
- [ ] ç¼“å­˜å‘½ä¸­ç‡ï¼šé™æ€æ•°æ® â‰¥95%, ç”¨æˆ·æ•°æ® â‰¥80%
- [ ] API å“åº”æ—¶é—´ P95 æ”¹å–„ â‰¥30%
- [ ] å†…å­˜å¢åŠ  â‰¤200MB
- [ ] æ— æ€§èƒ½é€€åŒ–

### æµ‹è¯•éªŒæ”¶

- [ ] å•å…ƒæµ‹è¯•è¦†ç›– â‰¥80%
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] å‹åŠ›æµ‹è¯•å®Œæˆï¼ˆ100 ç”¨æˆ· Ã— 1 å°æ—¶ï¼‰
- [ ] æ— å†…å­˜æ³„æ¼

### æ–‡æ¡£éªŒæ”¶

- [ ] æŠ€æœ¯æ–‡æ¡£å®Œæ•´
- [ ] è¿ç»´æ–‡æ¡£å®Œæ•´
- [ ] é…ç½®å‚æ•°æ–‡æ¡£å®Œæ•´
- [ ] æ•…éšœæ’æŸ¥æŒ‡å—å®Œæ•´

### ç›‘æ§éªŒæ”¶

- [ ] ç¼“å­˜ç»Ÿè®¡æ—¥å¿—æ­£å¸¸è¾“å‡º
- [ ] å¥åº·æ£€æŸ¥ API å·¥ä½œæ­£å¸¸
- [ ] å‘Šè­¦è§„åˆ™é…ç½®å®Œæˆï¼ˆå¦‚é€‚ç”¨ï¼‰

---

## æœ€ç»ˆäº¤ä»˜ç‰©

### ä»£ç äº¤ä»˜

- [ ] ä¸Šç¯‡ï¼ˆPhase 1ï¼‰ï¼šç¼“å­˜åŸºç¡€è®¾æ–½
- [ ] ä¸­ç¯‡ï¼ˆPhase 2ï¼‰ï¼šåˆ†é˜¶æ®µè¿ç§»
- [ ] ä¸‹ç¯‡ï¼ˆPhase 3ï¼‰ï¼šä¼˜åŒ–å’Œç®¡ç†æ¥å£
- [ ] æ‰€æœ‰æµ‹è¯•ä»£ç 

### æ–‡æ¡£äº¤ä»˜

- [ ] æ•°æ®åº“è¯»å–ä¼˜åŒ–æ–¹æ¡ˆ-å®Œæ•´åˆ†æ.md
- [ ] æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸Šç¯‡.md
- [ ] æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸­ç¯‡.md
- [ ] æ•°æ®åº“è¯»å–ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ-ä¸‹ç¯‡.mdï¼ˆæœ¬æ–‡æ¡£ï¼‰
- [ ] æ•°æ®åº“è¯»å–ä¼˜åŒ–éªŒæ”¶æ–‡æ¡£.md
- [ ] docs/CacheArchitecture.md
- [ ] docs/CacheConfiguration.md
- [ ] docs/CacheTroubleshooting.md
- [ ] docs/DeploymentGuide.md

### æ€§èƒ½æŠ¥å‘Š

- [ ] åŸºå‡†æµ‹è¯•æŠ¥å‘Š
- [ ] å‹åŠ›æµ‹è¯•æŠ¥å‘Š
- [ ] æ€§èƒ½å¯¹æ¯”æŠ¥å‘Šï¼ˆä¼˜åŒ–å‰ vs ä¼˜åŒ–åï¼‰

---

**é˜¶æ®µçŠ¶æ€**ï¼šâ³ å¾…å®æ–½  
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š2-3 å¤©  
**è´£ä»»äºº**ï¼šå¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**ï¼š2025-10-18
