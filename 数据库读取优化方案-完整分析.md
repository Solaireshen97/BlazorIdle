# BlazorIdle æ•°æ®åº“è¯»å–æ“ä½œä¼˜åŒ–æ–¹æ¡ˆ - å®Œæ•´åˆ†æ

**é¡¹ç›®**: BlazorIdle æ•°æ®åº“è¯»å–ä¼˜åŒ–ï¼ˆç¼“å­˜å±‚è®¾è®¡ï¼‰  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-18  
**çŠ¶æ€**: éœ€æ±‚åˆ†æå®Œæˆ - å¾…è¯„å®¡

---

## ğŸ“‹ ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [å½“å‰çŠ¶æ€å›é¡¾](#å½“å‰çŠ¶æ€å›é¡¾)
3. [æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ](#æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ)
4. [è¯»å–ä¼˜åŒ–éœ€æ±‚åˆ†æ](#è¯»å–ä¼˜åŒ–éœ€æ±‚åˆ†æ)
5. [ç¼“å­˜å±‚è®¾è®¡æ–¹æ¡ˆ](#ç¼“å­˜å±‚è®¾è®¡æ–¹æ¡ˆ)
6. [é…ç½®è®¾è®¡](#é…ç½®è®¾è®¡)
7. [æ€§èƒ½é¢„æœŸ](#æ€§èƒ½é¢„æœŸ)
8. [é£é™©è¯„ä¼°](#é£é™©è¯„ä¼°)

---

## æ‰§è¡Œæ‘˜è¦

### èƒŒæ™¯

BlazorIdle é¡¹ç›®å·²å®Œæˆæ•°æ®åº“**å†™å…¥æ“ä½œ**çš„ä¼˜åŒ–ï¼ˆPhase 1-3ï¼‰ï¼ŒæˆåŠŸå°†æ•°æ®åº“å†™å…¥æ¬¡æ•°å‡å°‘ 97.9%ã€‚ç„¶è€Œï¼Œç»è¿‡åˆ†æå‘ç°ï¼š

1. âœ… **å†™å…¥ä¼˜åŒ–å·²å®Œæˆ**ï¼šé€šè¿‡å†…å­˜ç¼“å†²å’Œæ‰¹é‡ä¿å­˜æœºåˆ¶
2. âš ï¸ **è¯»å–æ“ä½œä»éœ€ä¼˜åŒ–**ï¼šå¤§é‡å®ä½“ä¿¡æ¯æ¯æ¬¡éƒ½ä»æ•°æ®åº“è¯»å–
3. ğŸ¯ **æ–°éœ€æ±‚**ï¼šå®ç°"è¯»å–æ—¶ä¼˜å…ˆå†…å­˜ï¼Œæœªå‘½ä¸­æ‰æŸ¥æ•°æ®åº“"çš„ç¼“å­˜ç­–ç•¥

### æ ¸å¿ƒé—®é¢˜

**å½“å‰è¯»å–æ¨¡å¼**ï¼š
```
æ¯æ¬¡è¯·æ±‚ â†’ ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å›ç»“æœ
```

**å­˜åœ¨çš„é—®é¢˜**ï¼š
1. è§’è‰²ä¿¡æ¯ã€è£…å¤‡å®šä¹‰ã€æŠ€èƒ½é…ç½®ç­‰é™æ€æˆ–å‡†é™æ€æ•°æ®é‡å¤è¯»å–
2. æ¯ä¸ªAPIè¯·æ±‚éƒ½è§¦å‘æ•°æ®åº“æŸ¥è¯¢ï¼Œå³ä½¿æ•°æ®æœªå˜åŒ–
3. æ²¡æœ‰åˆ©ç”¨å·²æœ‰çš„å†…å­˜ç¼“å†²æœºåˆ¶ï¼ˆMemoryStateManagerï¼‰
4. è¯»å–æ“ä½œä¸å†™å…¥ä¼˜åŒ–æœªååŒå·¥ä½œ

### ä¼˜åŒ–ç›®æ ‡

**æ–°çš„è¯»å–æ¨¡å¼**ï¼š
```
æ¯æ¬¡è¯·æ±‚ â†’ å…ˆæŸ¥å†…å­˜ç¼“å­˜ â†’ å‘½ä¸­åˆ™ç›´æ¥è¿”å›
                      â†“ æœªå‘½ä¸­
                  æŸ¥è¯¢æ•°æ®åº“ â†’ åŠ è½½åˆ°å†…å­˜ â†’ è¿”å›ç»“æœ
```

**å…·ä½“ç›®æ ‡**ï¼š
1. **ç¼“å­˜å‘½ä¸­ç‡**ï¼šè¾¾åˆ° 80-95%ï¼ˆå¸¸ç”¨æ•°æ®ï¼‰
2. **è¯»å–æ€§èƒ½**ï¼šå†…å­˜è¯»å–å»¶è¿Ÿ < 1msï¼ˆvs æ•°æ®åº“ 5-50msï¼‰
3. **é…ç½®åŒ–**ï¼šæ‰€æœ‰ç¼“å­˜å‚æ•°å¯é…ç½®ï¼Œä¸å†™æ­»åœ¨ä»£ç ä¸­
4. **ä¸å†™å…¥ååŒ**ï¼šåˆ©ç”¨ç°æœ‰ MemoryStateManager åŸºç¡€è®¾æ–½
5. **é€æ˜å‡çº§**ï¼šä¸æ”¹å˜ç°æœ‰ Repository æ¥å£
6. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿è¯»åˆ°çš„æ•°æ®æ˜¯æœ€æ–°çš„

### é¢„æœŸæ•ˆæœ

- æ•°æ®åº“è¯»å–æ¬¡æ•°å‡å°‘ **70-90%**
- API å“åº”æ—¶é—´æ”¹å–„ **30-50%**
- æ•°æ®åº“ I/O æ€»é‡ï¼ˆè¯»+å†™ï¼‰å‡å°‘ **85-95%**
- ç³»ç»Ÿååé‡æå‡ **50-100%**

---

## å½“å‰çŠ¶æ€å›é¡¾

### å·²å®Œæˆçš„å†™å…¥ä¼˜åŒ–

#### Phase 1: åŸºç¡€è®¾æ–½ âœ…
- âœ… MemoryStateManager<T>ï¼šå†…å­˜çŠ¶æ€ç®¡ç†å™¨
- âœ… PersistenceCoordinatorï¼šæ‰¹é‡ä¿å­˜åè°ƒå™¨
- âœ… EnhancedShutdownManagerï¼šä¼˜é›…å…³é—­ç®¡ç†å™¨
- âœ… é…ç½®ç³»ç»Ÿï¼šPersistenceOptions, ShutdownOptions, MemoryCacheOptions

#### Phase 2: é«˜é¢‘å†™å…¥è¿ç§» âœ…
- âœ… è§’è‰²å¿ƒè·³ï¼šä»æ¯ 10-20 ç§’å†™å…¥æ”¹ä¸ºæ¯ 5 åˆ†é’Ÿæ‰¹é‡ä¿å­˜
- âœ… æˆ˜æ–—å¿«ç…§ï¼šä»æ¯ 500ms å†™å…¥æ”¹ä¸ºæ¯ 60 ç§’æ‰¹é‡ä¿å­˜
- âœ… æ´»åŠ¨è®¡åˆ’ï¼šå®æ—¶å†™å…¥æ”¹ä¸ºæ¯ 30 ç§’æ‰¹é‡ä¿å­˜

#### Phase 3: ç›‘æ§è¯Šæ–­ âœ…
- âœ… DatabaseMetricsCollectorï¼šæ€§èƒ½æŒ‡æ ‡æ”¶é›†
- âœ… DatabaseHealthControllerï¼šå¥åº·æ£€æŸ¥ API
- âœ… å®Œå…¨é…ç½®åŒ–ï¼šMonitoringOptions

### å½“å‰æ¶æ„

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
API Controllers
    â†“
Application Services
    â†“
Repositories â†’ DbContext (EF Core)
    â†“
[å†™å…¥] â†’ MemoryStateManager â†’ PersistenceCoordinator â†’ SQLite
[è¯»å–] â†’ ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ â† å¾…ä¼˜åŒ–ï¼
```

---

## æ•°æ®åº“è¯»å–æ“ä½œåˆ†æ

### é«˜é¢‘è¯»å–æ“ä½œè¯†åˆ«

é€šè¿‡ä»£ç åˆ†æï¼Œè¯†åˆ«å‡ºä»¥ä¸‹é«˜é¢‘æ•°æ®åº“è¯»å–åœºæ™¯ï¼š

#### 1. è§’è‰²ä¿¡æ¯è¯»å– âš ï¸âš ï¸âš ï¸

**ä½ç½®**ï¼šCharactersController, å„ç§ Service
**é¢‘ç‡**ï¼šæ¯ä¸ª API è¯·æ±‚éƒ½å¯èƒ½è¯»å–
**å½±å“**ï¼šæé«˜

**å…¸å‹åœºæ™¯**ï¼š
```csharp
// CharactersController.Get
var character = await _db.Characters.FirstOrDefaultAsync(c => c.Id == id);

// CharactersController.Heartbeat
var character = await _db.Characters.FirstOrDefaultAsync(c => c.Id == id);

// å„ç§ä¸šåŠ¡é€»è¾‘
var character = await _characterRepo.GetAsync(characterId);
```

**è¯»å–é¢‘ç‡ä¼°ç®—**ï¼š
- æ¯ä¸ªåœ¨çº¿ç©å®¶æ¯ 10 ç§’å¿ƒè·³ = 360 æ¬¡/å°æ—¶/ç©å®¶
- 100 ä¸ªåœ¨çº¿ç©å®¶ = **36,000 æ¬¡/å°æ—¶**
- è¿˜ä¸åŒ…æ‹¬å…¶ä»– API è°ƒç”¨

#### 2. è£…å¤‡å®šä¹‰è¯»å– âš ï¸âš ï¸

**ä½ç½®**ï¼šGearDefinitionRepository, EquipmentService
**é¢‘ç‡**ï¼šæ¯æ¬¡è£…å¤‡ç›¸å…³æ“ä½œ
**å½±å“**ï¼šé«˜

**å…¸å‹åœºæ™¯**ï¼š
```csharp
// æŸ¥è¯¢ç‰¹å®šè£…å¤‡å®šä¹‰
var gearDef = await _db.GearDefinitions.FirstOrDefaultAsync(g => g.Id == id);

// æŸ¥è¯¢ç‰¹å®šæ§½ä½çš„æ‰€æœ‰è£…å¤‡
var gearDefs = await _db.GearDefinitions
    .Where(g => g.Slot == slot)
    .ToListAsync();

// æŸ¥è¯¢æ‰€æœ‰è£…å¤‡å®šä¹‰
var allDefs = await _db.GearDefinitions.ToListAsync();
```

**ç‰¹ç‚¹**ï¼š
- è£…å¤‡å®šä¹‰æ˜¯**é™æ€é…ç½®æ•°æ®**ï¼Œæå°‘å˜åŒ–
- é€‚åˆæ°¸ä¹…ç¼“å­˜æˆ–é•¿æ—¶é—´ç¼“å­˜
- æ¯æ¬¡ç”Ÿæˆè£…å¤‡ã€è®¡ç®—å±æ€§éƒ½è¦è¯»å–

#### 3. è£…å¤‡å®ä¾‹è¯»å– âš ï¸âš ï¸

**ä½ç½®**ï¼šGearInstanceRepository, EquipmentService
**é¢‘ç‡**ï¼šæ¯æ¬¡è£…å¤‡æ“ä½œã€æˆ˜æ–—åˆå§‹åŒ–
**å½±å“**ï¼šé«˜

**å…¸å‹åœºæ™¯**ï¼š
```csharp
// æŸ¥è¯¢è§’è‰²çš„æ‰€æœ‰è£…å¤‡
var gear = await _db.GearInstances
    .Include(g => g.Definition)
    .Include(g => g.Affixes)
    .Where(g => g.CharacterId == characterId)
    .ToListAsync();

// æŸ¥è¯¢ç‰¹å®šæ§½ä½çš„è£…å¤‡
var equippedGear = await _db.GearInstances
    .FirstOrDefaultAsync(g => g.CharacterId == characterId 
                           && g.IsEquipped 
                           && g.SlotType == slot);
```

**ç‰¹ç‚¹**ï¼š
- è£…å¤‡æ•°æ®ç›¸å¯¹ç¨³å®šï¼ˆé™¤äº†ç©¿è„±æ“ä½œï¼‰
- Include å¯¼è‡´çš„å…³è”æŸ¥è¯¢å¼€é”€å¤§
- æˆ˜æ–—å¼€å§‹æ—¶æ‰¹é‡åŠ è½½æ‰€æœ‰è£…å¤‡

#### 4. æ´»åŠ¨è®¡åˆ’è¯»å– âš ï¸

**ä½ç½®**ï¼šActivityPlanRepository, ActivityPlanService
**é¢‘ç‡**ï¼šæ¯æ¬¡æ´»åŠ¨çŠ¶æ€æŸ¥è¯¢
**å½±å“**ï¼šä¸­

**å…¸å‹åœºæ™¯**ï¼š
```csharp
// æŸ¥è¯¢è§’è‰²çš„æ‰€æœ‰æ´»åŠ¨è®¡åˆ’
var plans = await _db.ActivityPlans
    .Where(p => p.CharacterId == characterId)
    .ToListAsync();

// æŸ¥è¯¢è¿è¡Œä¸­çš„æ´»åŠ¨
var runningPlan = await _db.ActivityPlans
    .FirstOrDefaultAsync(p => p.CharacterId == characterId 
                           && p.State == ActivityPlanState.Running);
```

**ç‰¹ç‚¹**ï¼š
- æ´»åŠ¨è®¡åˆ’å·²åœ¨å†™å…¥æ—¶ä½¿ç”¨ MemoryStateManager
- ä½†è¯»å–æ“ä½œå°šæœªä½¿ç”¨å†…å­˜ç¼“å­˜
- å­˜åœ¨"å†™å…¥ç”¨å†…å­˜ï¼Œè¯»å–æŸ¥æ•°æ®åº“"çš„ä¸ä¸€è‡´

#### 5. è¯ç¼€å®šä¹‰è¯»å– âš ï¸

**ä½ç½®**ï¼šAffixRepository
**é¢‘ç‡**ï¼šè£…å¤‡ç”Ÿæˆã€å±æ€§è®¡ç®—
**å½±å“**ï¼šä¸­

**å…¸å‹åœºæ™¯**ï¼š
```csharp
// æŸ¥è¯¢æ‰€æœ‰è¯ç¼€
var affixes = await _db.Affixes.ToListAsync();

// æŸ¥è¯¢ç‰¹å®šç±»å‹çš„è¯ç¼€
var affixes = await _db.Affixes
    .Where(a => a.Rarity == rarity)
    .ToListAsync();
```

**ç‰¹ç‚¹**ï¼š
- è¯ç¼€å®šä¹‰æ˜¯**é™æ€é…ç½®æ•°æ®**
- é€‚åˆæ°¸ä¹…ç¼“å­˜

#### 6. æˆ˜æ–—å¿«ç…§è¯»å– âš ï¸

**ä½ç½®**ï¼šStepBattleSnapshotService
**é¢‘ç‡**ï¼šæˆ˜æ–—æ¢å¤ã€çŠ¶æ€æŸ¥è¯¢
**å½±å“**ï¼šä¸­

**å…¸å‹åœºæ™¯**ï¼š
```csharp
// åŠ è½½æˆ˜æ–—å¿«ç…§
var snapshot = await _db.RunningBattleSnapshots
    .FirstOrDefaultAsync(s => s.CharacterId == characterId);
```

**ç‰¹ç‚¹**ï¼š
- æˆ˜æ–—å¿«ç…§å·²åœ¨å†™å…¥æ—¶ä½¿ç”¨ MemoryStateManager
- ä½†åŠ è½½å¿«ç…§æ—¶å¯èƒ½ç›´æ¥æŸ¥è¯¢æ•°æ®åº“

### è¯»å–æ“ä½œç»Ÿè®¡

| æ•°æ®ç±»å‹ | æ¯å°æ—¶è¯»å–æ¬¡æ•°ï¼ˆ100ç©å®¶ï¼‰ | å˜åŒ–é¢‘ç‡ | ç¼“å­˜é€‚ç”¨æ€§ | ä¼˜å…ˆçº§ |
|---------|------------------------|---------|----------|--------|
| è§’è‰²ä¿¡æ¯ (Character) | ~36,000 | ä¸­ç­‰ | é«˜ | âš ï¸âš ï¸âš ï¸ |
| è£…å¤‡å®šä¹‰ (GearDefinition) | ~5,000 | æä½ | æé«˜ | âš ï¸âš ï¸ |
| è£…å¤‡å®ä¾‹ (GearInstance) | ~8,000 | ä½ | é«˜ | âš ï¸âš ï¸ |
| æ´»åŠ¨è®¡åˆ’ (ActivityPlan) | ~3,000 | ä¸­ç­‰ | é«˜ | âš ï¸ |
| è¯ç¼€å®šä¹‰ (Affix) | ~2,000 | æä½ | æé«˜ | âš ï¸ |
| æˆ˜æ–—å¿«ç…§ (Snapshot) | ~1,000 | é«˜ | ä¸­ | âš ï¸ |
| **æ€»è®¡** | **~55,000** | - | - | - |

### æ ¹æœ¬é—®é¢˜

**é—®é¢˜ 1ï¼šè¯»å†™ä¸ååŒ**
```
å†™å…¥ï¼šä½¿ç”¨ MemoryStateManagerï¼ˆå†…å­˜ç¼“å†²ï¼‰
è¯»å–ï¼šç›´æ¥æŸ¥æ•°æ®åº“ï¼ˆæœªåˆ©ç”¨å†…å­˜ä¸­çš„æ•°æ®ï¼‰

ç»“æœï¼šåŒä¸€ä»½æ•°æ®ï¼Œå†™åœ¨å†…å­˜ï¼Œè¯»ä»æ•°æ®åº“
```

**é—®é¢˜ 2ï¼šé™æ€æ•°æ®é‡å¤è¯»å–**
```
è£…å¤‡å®šä¹‰ã€è¯ç¼€å®šä¹‰ç­‰é…ç½®æ•°æ®ï¼š
- å¯åŠ¨åä¸å†å˜åŒ–
- æ¯æ¬¡éƒ½ä»æ•°æ®åº“è¯»å–
- æµªè´¹ I/O å’Œ CPU
```

**é—®é¢˜ 3ï¼šç¼ºå°‘ç¼“å­˜å¤±æ•ˆæœºåˆ¶**
```
å¦‚æœå®ç°ç¼“å­˜ï¼Œéœ€è¦ï¼š
- æ•°æ®å˜æ›´æ—¶ä½¿ç¼“å­˜å¤±æ•ˆ
- æ‰¹é‡ä¿å­˜ååŒæ­¥æ›´æ–°ç¼“å­˜
- ä¿è¯æ•°æ®ä¸€è‡´æ€§
```

---

## è¯»å–ä¼˜åŒ–éœ€æ±‚åˆ†æ

### æ ¸å¿ƒéœ€æ±‚

**ç”¨æˆ·åŸå§‹éœ€æ±‚**ï¼ˆæ¥è‡ªé—®é¢˜æè¿°ï¼‰ï¼š
> "è¯»å–éƒ¨åˆ†æˆ‘æ„Ÿè§‰ä¹Ÿåº”è¯¥ä¿®æ”¹ï¼Œå„é¡¹ä¿¡æ¯ä¸åº”è¯¥å®æ—¶è¯»å–æ•°æ®åº“çš„éƒ¨åˆ†ï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­æ“ä½œï¼Œæˆ‘çš„æƒ³æ³•æ˜¯éœ€è¦è¯»å–çš„ä¿¡æ¯åœ¨å†…å­˜ä¸­æ²¡æœ‰çš„æ—¶å€™æ‰è¯»å–æ•°æ®åº“"

**åˆ†è§£éœ€æ±‚**ï¼š

#### éœ€æ±‚ 1ï¼šå†…å­˜ä¼˜å…ˆè¯»å–
- æ‰€æœ‰ GetAsync æ“ä½œå…ˆæŸ¥å†…å­˜
- æœªå‘½ä¸­å†æŸ¥æ•°æ®åº“
- æŸ¥åˆ°ååŠ è½½åˆ°å†…å­˜

#### éœ€æ±‚ 2ï¼šä¸ç°æœ‰å†™å…¥ååŒ
- åˆ©ç”¨å·²æœ‰çš„ MemoryStateManager
- è¯»å†™éƒ½ä½¿ç”¨åŒä¸€ä»½å†…å­˜æ•°æ®
- é¿å…é‡å¤å®ç°

#### éœ€æ±‚ 3ï¼šé…ç½®åŒ–å‚æ•°
- ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆMaxCachedEntitiesï¼‰
- ç¼“å­˜è¿‡æœŸç­–ç•¥ï¼ˆTTLï¼‰
- é¢„åŠ è½½ç­–ç•¥ï¼ˆå¯åŠ¨æ—¶åŠ è½½é™æ€æ•°æ®ï¼‰
- ç¼“å­˜å¤±æ•ˆç­–ç•¥

#### éœ€æ±‚ 4ï¼šä¿æŒä»£ç é£æ ¼
- ä¸æ”¹å˜ç°æœ‰ Repository æ¥å£
- éµå¾ªé¡¹ç›®å‘½åè§„èŒƒ
- ä¿æŒä¸­è‹±æ–‡æ³¨é‡Šé£æ ¼
- DDD åˆ†å±‚æ¶æ„

#### éœ€æ±‚ 5ï¼šæ•°æ®ä¸€è‡´æ€§
- ç¡®ä¿è¯»åˆ°çš„æ˜¯æœ€æ–°æ•°æ®
- æ‰¹é‡ä¿å­˜åæ›´æ–°å†…å­˜
- ç›´æ¥å†™å…¥çš„æ“ä½œç«‹å³æ›´æ–°å†…å­˜

### éåŠŸèƒ½éœ€æ±‚

#### æ€§èƒ½éœ€æ±‚
- å†…å­˜è¯»å–å»¶è¿Ÿ < 1ms
- ç¼“å­˜å‘½ä¸­ç‡ > 80%
- ä¸å¢åŠ å†…å­˜è¶…è¿‡ 200MB

#### å¯é æ€§éœ€æ±‚
- ç¼“å­˜å¤±æ•ˆåèƒ½è‡ªåŠ¨æ¢å¤
- æœåŠ¡é‡å¯åèƒ½å¿«é€Ÿé¢„çƒ­
- ä¸å› ç¼“å­˜é—®é¢˜å¯¼è‡´æ•°æ®é”™è¯¯

#### å¯ç»´æŠ¤æ€§éœ€æ±‚
- ç¼“å­˜é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- æ–¹ä¾¿æ·»åŠ æ–°çš„ç¼“å­˜å®ä½“ç±»å‹
- æä¾›ç›‘æ§æŒ‡æ ‡ï¼ˆå‘½ä¸­ç‡ã€å†…å­˜ä½¿ç”¨ï¼‰

---

## ç¼“å­˜å±‚è®¾è®¡æ–¹æ¡ˆ

### è®¾è®¡ç†å¿µ

#### 1. åˆ†å±‚ç¼“å­˜ç­–ç•¥

```
                 [L1: çƒ­æ•°æ®ç¼“å­˜]
                 æ°¸ä¹…ç¼“å­˜ï¼šé…ç½®æ•°æ®ï¼ˆGearDefinition, Affixï¼‰
                 â†“
[L2: æ´»è·ƒæ•°æ®ç¼“å­˜] 
ä¸´æ—¶ç¼“å­˜ï¼šç”¨æˆ·æ•°æ®ï¼ˆCharacter, GearInstance, ActivityPlanï¼‰
TTL æœºåˆ¶ + LRU æ¸…ç†
                 â†“
              [æ•°æ®åº“]
            æœ€ç»ˆæŒä¹…åŒ–å±‚
```

#### 2. è¯»å†™ååŒæœºåˆ¶

```
                   MemoryStateManager<T>
                           |
        +------------------+------------------+
        |                                     |
    [è¯»å–è·¯å¾„]                            [å†™å…¥è·¯å¾„]
        |                                     |
  1. å…ˆæŸ¥å†…å­˜                           1. æ›´æ–°å†…å­˜
  2. æœªå‘½ä¸­æŸ¥æ•°æ®åº“                     2. æ ‡è®° Dirty
  3. åŠ è½½åˆ°å†…å­˜                         3. æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“
        |                                     |
        +------------------+------------------+
                           |
                    åŒä¸€ä»½å†…å­˜æ•°æ®
                   ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
```

### æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### ç»„ä»¶ 1ï¼šCacheConfigurationï¼ˆç¼“å­˜é…ç½®ï¼‰

**ä½œç”¨**ï¼šå®šä¹‰ä¸åŒå®ä½“çš„ç¼“å­˜ç­–ç•¥

```csharp
/// <summary>
/// ç¼“å­˜é…ç½® - å®šä¹‰ä¸åŒå®ä½“ç±»å‹çš„ç¼“å­˜ç­–ç•¥
/// Cache Configuration - Define caching strategies for different entity types
/// </summary>
public class CacheConfiguration
{
    /// <summary>
    /// ç¼“å­˜ç­–ç•¥ç±»å‹
    /// Cache Strategy Type
    /// </summary>
    public enum CacheStrategy
    {
        /// <summary>æ— ç¼“å­˜ï¼ˆç›´æ¥æŸ¥æ•°æ®åº“ï¼‰</summary>
        None,
        /// <summary>æ°¸ä¹…ç¼“å­˜ï¼ˆé…ç½®æ•°æ®ï¼Œå¯åŠ¨æ—¶é¢„åŠ è½½ï¼‰</summary>
        Permanent,
        /// <summary>ä¸´æ—¶ç¼“å­˜ï¼ˆç”¨æˆ·æ•°æ®ï¼ŒTTL + LRUï¼‰</summary>
        Temporary
    }

    /// <summary>
    /// å®ä½“ç±»å‹çš„ç¼“å­˜ç­–ç•¥
    /// Entity-specific cache strategies
    /// </summary>
    public Dictionary<string, EntityCacheStrategy> EntityStrategies { get; set; } = new();
}

/// <summary>
/// å•ä¸ªå®ä½“ç±»å‹çš„ç¼“å­˜ç­–ç•¥
/// Cache strategy for a single entity type
/// </summary>
public class EntityCacheStrategy
{
    /// <summary>ç¼“å­˜ç­–ç•¥ç±»å‹</summary>
    public CacheStrategy Strategy { get; set; }
    
    /// <summary>TTLï¼ˆç§’ï¼‰- ä»…å¯¹ Temporary ç­–ç•¥æœ‰æ•ˆ</summary>
    public int TtlSeconds { get; set; } = 3600;
    
    /// <summary>æœ€å¤§ç¼“å­˜æ•°é‡ - è¶…è¿‡åè§¦å‘ LRU æ¸…ç†</summary>
    public int MaxCachedCount { get; set; } = 10000;
    
    /// <summary>æ˜¯å¦åœ¨å¯åŠ¨æ—¶é¢„åŠ è½½</summary>
    public bool PreloadOnStartup { get; set; } = false;
    
    /// <summary>é¢„åŠ è½½æ—¶çš„æ‰¹é‡å¤§å°</summary>
    public int PreloadBatchSize { get; set; } = 1000;
}
```

#### ç»„ä»¶ 2ï¼šCacheCoordinatorï¼ˆç¼“å­˜åè°ƒå™¨ï¼‰

**ä½œç”¨**ï¼šç®¡ç†ç¼“å­˜é¢„åŠ è½½å’Œå¤±æ•ˆ

```csharp
/// <summary>
/// ç¼“å­˜åè°ƒå™¨ - ç®¡ç†ç¼“å­˜çš„é¢„åŠ è½½ã€å¤±æ•ˆå’Œç›‘æ§
/// Cache Coordinator - Manages cache preloading, invalidation, and monitoring
/// </summary>
public class CacheCoordinator : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly CacheConfiguration _config;
    private readonly ILogger<CacheCoordinator> _logger;
    
    // å„ç±»å‹å®ä½“çš„å†…å­˜ç®¡ç†å™¨
    private readonly IMemoryStateManager<GearDefinition> _gearDefManager;
    private readonly IMemoryStateManager<Affix> _affixManager;
    private readonly IMemoryStateManager<Character> _characterManager;
    private readonly IMemoryStateManager<GearInstance> _gearInstanceManager;
    private readonly IMemoryStateManager<ActivityPlan> _activityPlanManager;
    
    /// <summary>
    /// å¯åŠ¨æ—¶é¢„åŠ è½½é™æ€æ•°æ®
    /// Preload static data on startup
    /// </summary>
    public async Task PreloadStaticDataAsync(CancellationToken ct)
    {
        // 1. é¢„åŠ è½½è£…å¤‡å®šä¹‰
        await PreloadEntityAsync<GearDefinition>("GearDefinition", ct);
        
        // 2. é¢„åŠ è½½è¯ç¼€å®šä¹‰
        await PreloadEntityAsync<Affix>("Affix", ct);
        
        // 3. å…¶ä»–éœ€è¦é¢„åŠ è½½çš„é™æ€æ•°æ®...
    }
    
    /// <summary>
    /// é¢„åŠ è½½ç‰¹å®šå®ä½“ç±»å‹
    /// Preload specific entity type
    /// </summary>
    private async Task PreloadEntityAsync<T>(string entityType, CancellationToken ct) 
        where T : class, IEntity
    {
        // æ£€æŸ¥æ˜¯å¦é…ç½®ä¸ºé¢„åŠ è½½
        if (!_config.EntityStrategies.TryGetValue(entityType, out var strategy))
            return;
            
        if (!strategy.PreloadOnStartup)
            return;
        
        // ä»æ•°æ®åº“æ‰¹é‡åŠ è½½
        using var scope = _scopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<GameDbContext>();
        
        var entities = await db.Set<T>().ToListAsync(ct);
        
        // åŠ è½½åˆ°å†…å­˜ç®¡ç†å™¨
        var manager = GetManagerForType<T>();
        foreach (var entity in entities)
        {
            manager.Add(entity);
        }
        
        _logger.LogInformation(
            "å·²é¢„åŠ è½½ {EntityType} æ•°æ®ï¼š{Count} æ¡",
            entityType, entities.Count
        );
    }
    
    /// <summary>
    /// å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
    /// Periodic cleanup of expired cache entries
    /// </summary>
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
            
            // æ¸…ç†è¿‡æœŸçš„ä¸´æ—¶ç¼“å­˜
            await CleanupExpiredCachesAsync(stoppingToken);
        }
    }
}
```

#### ç»„ä»¶ 3ï¼šå¢å¼º MemoryStateManager çš„è¯»å–èƒ½åŠ›

**æ”¹è¿›ç‚¹**ï¼š
1. æ·»åŠ  TryGetAsync æ–¹æ³•ï¼ˆå…ˆæŸ¥å†…å­˜ï¼Œæœªå‘½ä¸­å†æŸ¥æ•°æ®åº“ï¼‰
2. æ·»åŠ æ‰¹é‡é¢„åŠ è½½æ–¹æ³•
3. æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

```csharp
/// <summary>
/// å¢å¼ºçš„å†…å­˜çŠ¶æ€ç®¡ç†å™¨ - æ”¯æŒè¯»å–ç¼“å­˜
/// Enhanced Memory State Manager - Supports read caching
/// </summary>
public class MemoryStateManager<T> : IMemoryStateManager<T> 
    where T : class, IEntity
{
    // ç°æœ‰å­—æ®µ...
    private readonly ConcurrentDictionary<Guid, T> _store;
    private readonly ConcurrentDictionary<Guid, DateTime> _dirtyEntities;
    
    // æ–°å¢ï¼šç¼“å­˜ç»Ÿè®¡
    private long _cacheHits = 0;
    private long _cacheMisses = 0;
    
    /// <summary>
    /// å°è¯•è·å–å®ä½“ï¼ˆè¯»å–ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
    /// Try to get entity (optimized read version)
    /// 
    /// é€»è¾‘ï¼š
    /// 1. å…ˆæŸ¥å†…å­˜ç¼“å­˜ï¼ˆ_storeï¼‰
    /// 2. å‘½ä¸­åˆ™ç›´æ¥è¿”å›ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
    /// 3. æœªå‘½ä¸­åˆ™æŸ¥æ•°æ®åº“
    /// 4. æŸ¥åˆ°ååŠ è½½åˆ°å†…å­˜
    /// 5. è¿”å›ç»“æœ
    /// </summary>
    public async Task<T?> TryGetAsync(Guid id, 
        Func<Guid, Task<T?>> databaseLoader, 
        CancellationToken ct = default)
    {
        // 1. å…ˆæŸ¥å†…å­˜
        if (_store.TryGetValue(id, out var cached))
        {
            Interlocked.Increment(ref _cacheHits);
            return cached;
        }
        
        // 2. æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
        Interlocked.Increment(ref _cacheMisses);
        var entity = await databaseLoader(id);
        
        // 3. åŠ è½½åˆ°å†…å­˜ï¼ˆå¦‚æœæŸ¥åˆ°äº†ï¼‰
        if (entity != null)
        {
            _store.TryAdd(id, entity);
        }
        
        return entity;
    }
    
    /// <summary>
    /// æ‰¹é‡é¢„åŠ è½½å®ä½“
    /// Batch preload entities
    /// </summary>
    public void PreloadBatch(IEnumerable<T> entities)
    {
        foreach (var entity in entities)
        {
            _store.TryAdd(entity.Id, entity);
        }
    }
    
    /// <summary>
    /// è·å–ç¼“å­˜å‘½ä¸­ç‡
    /// Get cache hit rate
    /// </summary>
    public double GetCacheHitRate()
    {
        var total = _cacheHits + _cacheMisses;
        return total > 0 ? (double)_cacheHits / total : 0.0;
    }
}
```

#### ç»„ä»¶ 4ï¼šRepository é€‚é…å™¨ï¼ˆé€æ˜ç¼“å­˜ï¼‰

**ç›®æ ‡**ï¼šä¸æ”¹å˜ç°æœ‰ Repository æ¥å£ï¼Œé€æ˜åœ°ä½¿ç”¨ç¼“å­˜

```csharp
/// <summary>
/// è§’è‰²ä»“å‚¨ï¼ˆç¼“å­˜å¢å¼ºç‰ˆï¼‰
/// Character Repository (with caching)
/// </summary>
public class CharacterRepository : ICharacterRepository
{
    private readonly GameDbContext _db;
    private readonly IMemoryStateManager<Character> _memoryManager;
    
    /// <summary>
    /// è·å–è§’è‰²ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
    /// Get character (with caching)
    /// </summary>
    public async Task<Character?> GetAsync(Guid id, CancellationToken ct = default)
    {
        // ä½¿ç”¨ TryGetAsyncï¼šå…ˆæŸ¥å†…å­˜ï¼Œæœªå‘½ä¸­å†æŸ¥æ•°æ®åº“
        return await _memoryManager.TryGetAsync(
            id,
            async (id) => await _db.Characters
                .FirstOrDefaultAsync(c => c.Id == id, ct),
            ct
        );
    }
    
    // å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜...
}
```

### æ•°æ®ä¸€è‡´æ€§ä¿è¯

#### ç­–ç•¥ 1ï¼šå†™å…¥æ—¶åŒæ­¥æ›´æ–°å†…å­˜

```csharp
// åœ¨ Repository çš„ UpdateAsync ä¸­
public async Task UpdateAsync(Character character, CancellationToken ct = default)
{
    // 1. æ›´æ–°æ•°æ®åº“å®ä½“
    _db.Characters.Update(character);
    
    // 2. åŒæ­¥æ›´æ–°å†…å­˜
    _memoryManager.Update(character.Id, character);
    
    // 3. æ ‡è®°ä¸º Dirtyï¼ˆç­‰å¾…æ‰¹é‡ä¿å­˜ï¼‰
    // å·²åœ¨ _memoryManager.Update ä¸­å¤„ç†
}
```

#### ç­–ç•¥ 2ï¼šæ‰¹é‡ä¿å­˜ååˆ·æ–°ç¼“å­˜

```csharp
// åœ¨ PersistenceCoordinator çš„ PeriodicSaveAsync ä¸­
private async Task PeriodicSaveAsync(CancellationToken ct)
{
    // 1. æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“
    await db.SaveChangesAsync(ct);
    
    // 2. æ¸…é™¤ Dirty æ ‡è®°
    _characterManager.ClearDirty(savedIds);
    
    // 3. ç¼“å­˜ä¸­çš„æ•°æ®å·²æ˜¯æœ€æ–°ï¼ˆå› ä¸ºå†™å…¥æ—¶å·²æ›´æ–°ï¼‰
    // æ— éœ€é¢å¤–æ“ä½œ
}
```

#### ç­–ç•¥ 3ï¼šç›´æ¥å†™å…¥æ—¶ç«‹å³æ›´æ–°å†…å­˜

```csharp
// å¯¹äºå¿…é¡»ç«‹å³ä¿å­˜çš„æ“ä½œï¼ˆå¦‚è´­ä¹°ï¼‰
public async Task<bool> PurchaseItemAsync(...)
{
    // 1. ç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
    await db.SaveChangesAsync();
    
    // 2. ç«‹å³æ›´æ–°å†…å­˜
    _characterManager.Update(character.Id, character);
    
    // 3. ä¸æ ‡è®°ä¸º Dirtyï¼ˆå·²ä¿å­˜ï¼‰
    _characterManager.ClearDirty(new[] { character.Id });
}
```

---

## é…ç½®è®¾è®¡

### é…ç½®æ–‡ä»¶ç»“æ„

```json
// appsettings.json
{
  "CacheConfiguration": {
    "EntityStrategies": {
      // è£…å¤‡å®šä¹‰ï¼šæ°¸ä¹…ç¼“å­˜ï¼Œå¯åŠ¨æ—¶é¢„åŠ è½½
      "GearDefinition": {
        "Strategy": "Permanent",
        "PreloadOnStartup": true,
        "PreloadBatchSize": 500,
        "MaxCachedCount": 10000
      },
      
      // è¯ç¼€å®šä¹‰ï¼šæ°¸ä¹…ç¼“å­˜ï¼Œå¯åŠ¨æ—¶é¢„åŠ è½½
      "Affix": {
        "Strategy": "Permanent",
        "PreloadOnStartup": true,
        "PreloadBatchSize": 1000,
        "MaxCachedCount": 10000
      },
      
      // è£…å¤‡å¥—è£…ï¼šæ°¸ä¹…ç¼“å­˜ï¼Œå¯åŠ¨æ—¶é¢„åŠ è½½
      "GearSet": {
        "Strategy": "Permanent",
        "PreloadOnStartup": true,
        "PreloadBatchSize": 100,
        "MaxCachedCount": 1000
      },
      
      // è§’è‰²ï¼šä¸´æ—¶ç¼“å­˜ï¼ŒTTL 1å°æ—¶
      "Character": {
        "Strategy": "Temporary",
        "TtlSeconds": 3600,
        "MaxCachedCount": 10000,
        "PreloadOnStartup": false
      },
      
      // è£…å¤‡å®ä¾‹ï¼šä¸´æ—¶ç¼“å­˜ï¼ŒTTL 30åˆ†é’Ÿ
      "GearInstance": {
        "Strategy": "Temporary",
        "TtlSeconds": 1800,
        "MaxCachedCount": 50000,
        "PreloadOnStartup": false
      },
      
      // æ´»åŠ¨è®¡åˆ’ï¼šä¸´æ—¶ç¼“å­˜ï¼ŒTTL 10åˆ†é’Ÿ
      "ActivityPlan": {
        "Strategy": "Temporary",
        "TtlSeconds": 600,
        "MaxCachedCount": 20000,
        "PreloadOnStartup": false
      },
      
      // æˆ˜æ–—å¿«ç…§ï¼šä¸´æ—¶ç¼“å­˜ï¼ŒTTL 5åˆ†é’Ÿ
      "RunningBattleSnapshot": {
        "Strategy": "Temporary",
        "TtlSeconds": 300,
        "MaxCachedCount": 5000,
        "PreloadOnStartup": false
      }
    },
    
    // å…¨å±€ç¼“å­˜é…ç½®
    "GlobalSettings": {
      // æ˜¯å¦å¯ç”¨è¯»å–ç¼“å­˜ï¼ˆæ€»å¼€å…³ï¼‰
      "EnableReadCaching": true,
      
      // ç¼“å­˜æ¸…ç†é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
      "CleanupIntervalMinutes": 5,
      
      // æ˜¯å¦è®°å½•ç¼“å­˜å‘½ä¸­ç‡
      "TrackCacheHitRate": true,
      
      // å‘½ä¸­ç‡è®°å½•é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
      "HitRateLogIntervalMinutes": 10
    }
  },
  
  // æ‰©å±•ç°æœ‰çš„ Monitoring é…ç½®
  "Monitoring": {
    "MaxRecentOperations": 100,
    "EnableDetailedLogging": false,
    "DefaultTimeWindowMinutes": 10,
    "MemoryStateSnapshotIntervalSeconds": 0,
    
    // æ–°å¢ï¼šç¼“å­˜ç›‘æ§é…ç½®
    "CacheMonitoring": {
      "EnableCacheMetrics": true,
      "TrackPerEntityMetrics": true,
      "CacheMetricsIntervalSeconds": 60
    }
  }
}
```

### é…ç½®ç±»å®šä¹‰

```csharp
/// <summary>
/// ç¼“å­˜é…ç½®é€‰é¡¹
/// Cache Configuration Options
/// </summary>
public class CacheConfiguration
{
    /// <summary>
    /// å®ä½“ç‰¹å®šçš„ç¼“å­˜ç­–ç•¥
    /// Entity-specific cache strategies
    /// </summary>
    public Dictionary<string, EntityCacheStrategy> EntityStrategies { get; set; } = new();
    
    /// <summary>
    /// å…¨å±€ç¼“å­˜è®¾ç½®
    /// Global cache settings
    /// </summary>
    public GlobalCacheSettings GlobalSettings { get; set; } = new();
}

/// <summary>
/// å•ä¸ªå®ä½“ç±»å‹çš„ç¼“å­˜ç­–ç•¥
/// Cache strategy for a single entity type
/// </summary>
public class EntityCacheStrategy
{
    /// <summary>
    /// ç¼“å­˜ç­–ç•¥ç±»å‹ï¼ˆNone/Permanent/Temporaryï¼‰
    /// Cache strategy type
    /// </summary>
    [JsonConverter(typeof(JsonStringEnumConverter))]
    public CacheStrategyType Strategy { get; set; } = CacheStrategyType.Temporary;
    
    /// <summary>
    /// TTLï¼ˆç§’ï¼‰- ä»…å¯¹ Temporary ç­–ç•¥æœ‰æ•ˆ
    /// Time-to-live in seconds (for Temporary strategy only)
    /// </summary>
    [Range(60, 86400)] // 1åˆ†é’Ÿ åˆ° 24å°æ—¶
    public int TtlSeconds { get; set; } = 3600;
    
    /// <summary>
    /// æœ€å¤§ç¼“å­˜æ•°é‡
    /// Maximum cached entities
    /// </summary>
    [Range(100, 1000000)]
    public int MaxCachedCount { get; set; } = 10000;
    
    /// <summary>
    /// æ˜¯å¦åœ¨å¯åŠ¨æ—¶é¢„åŠ è½½
    /// Preload on startup
    /// </summary>
    public bool PreloadOnStartup { get; set; } = false;
    
    /// <summary>
    /// é¢„åŠ è½½æ‰¹é‡å¤§å°
    /// Preload batch size
    /// </summary>
    [Range(100, 10000)]
    public int PreloadBatchSize { get; set; } = 1000;
}

/// <summary>
/// ç¼“å­˜ç­–ç•¥ç±»å‹æšä¸¾
/// Cache Strategy Type Enum
/// </summary>
public enum CacheStrategyType
{
    /// <summary>æ— ç¼“å­˜</summary>
    None,
    /// <summary>æ°¸ä¹…ç¼“å­˜ï¼ˆé…ç½®æ•°æ®ï¼‰</summary>
    Permanent,
    /// <summary>ä¸´æ—¶ç¼“å­˜ï¼ˆç”¨æˆ·æ•°æ®ï¼Œå¸¦TTLï¼‰</summary>
    Temporary
}

/// <summary>
/// å…¨å±€ç¼“å­˜è®¾ç½®
/// Global Cache Settings
/// </summary>
public class GlobalCacheSettings
{
    /// <summary>
    /// æ˜¯å¦å¯ç”¨è¯»å–ç¼“å­˜ï¼ˆæ€»å¼€å…³ï¼‰
    /// Enable read caching (master switch)
    /// </summary>
    public bool EnableReadCaching { get; set; } = true;
    
    /// <summary>
    /// ç¼“å­˜æ¸…ç†é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
    /// Cleanup interval in minutes
    /// </summary>
    [Range(1, 60)]
    public int CleanupIntervalMinutes { get; set; } = 5;
    
    /// <summary>
    /// æ˜¯å¦è®°å½•ç¼“å­˜å‘½ä¸­ç‡
    /// Track cache hit rate
    /// </summary>
    public bool TrackCacheHitRate { get; set; } = true;
    
    /// <summary>
    /// å‘½ä¸­ç‡è®°å½•é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
    /// Hit rate logging interval in minutes
    /// </summary>
    [Range(1, 60)]
    public int HitRateLogIntervalMinutes { get; set; } = 10;
}

/// <summary>
/// ç¼“å­˜ç›‘æ§é…ç½®ï¼ˆæ‰©å±• MonitoringOptionsï¼‰
/// Cache Monitoring Configuration
/// </summary>
public class CacheMonitoringSettings
{
    /// <summary>
    /// æ˜¯å¦å¯ç”¨ç¼“å­˜æŒ‡æ ‡æ”¶é›†
    /// Enable cache metrics collection
    /// </summary>
    public bool EnableCacheMetrics { get; set; } = true;
    
    /// <summary>
    /// æ˜¯å¦è·Ÿè¸ªæ¯ä¸ªå®ä½“ç±»å‹çš„æŒ‡æ ‡
    /// Track per-entity metrics
    /// </summary>
    public bool TrackPerEntityMetrics { get; set; } = true;
    
    /// <summary>
    /// ç¼“å­˜æŒ‡æ ‡è®°å½•é—´éš”ï¼ˆç§’ï¼‰
    /// Cache metrics interval in seconds
    /// </summary>
    [Range(10, 600)]
    public int CacheMetricsIntervalSeconds { get; set; } = 60;
}
```

---

## æ€§èƒ½é¢„æœŸ

### æ•°æ®åº“è¯»å–æ¬¡æ•°å¯¹æ¯”

#### ä¼˜åŒ–å‰ï¼ˆå½“å‰ï¼‰

| æ•°æ®ç±»å‹ | æ¯å°æ—¶è¯»å–æ¬¡æ•°ï¼ˆ100ç©å®¶ï¼‰ | è¯´æ˜ |
|---------|------------------------|------|
| Character | 36,000 | å¿ƒè·³ + API è°ƒç”¨ |
| GearDefinition | 5,000 | è£…å¤‡ç”Ÿæˆã€å±æ€§è®¡ç®— |
| GearInstance | 8,000 | è£…å¤‡æ“ä½œã€æˆ˜æ–—åˆå§‹åŒ– |
| ActivityPlan | 3,000 | æ´»åŠ¨çŠ¶æ€æŸ¥è¯¢ |
| Affix | 2,000 | è£…å¤‡ç”Ÿæˆ |
| RunningBattleSnapshot | 1,000 | æˆ˜æ–—æ¢å¤ |
| **æ€»è®¡** | **55,000** | - |

#### ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰

| æ•°æ®ç±»å‹ | ç¼“å­˜å‘½ä¸­ç‡ | å®é™…è¯»å–æ¬¡æ•° | å‡å°‘æ¯”ä¾‹ |
|---------|----------|------------|---------|
| Character | 90% | 3,600 | **-90%** |
| GearDefinition | 100% (é¢„åŠ è½½) | 0 | **-100%** |
| GearInstance | 85% | 1,200 | **-85%** |
| ActivityPlan | 80% | 600 | **-80%** |
| Affix | 100% (é¢„åŠ è½½) | 0 | **-100%** |
| RunningBattleSnapshot | 75% | 250 | **-75%** |
| **æ€»è®¡** | **~89%** | **5,650** | **-90%** |

### æ€§èƒ½æ”¹å–„é¢„æœŸ

#### å“åº”æ—¶é—´

```
API å“åº”æ—¶é—´ï¼ˆP95ï¼‰ï¼š

å½“å‰ï¼š
- è§’è‰²æŸ¥è¯¢ï¼š50-100msï¼ˆå«æ•°æ®åº“æŸ¥è¯¢ 20-50msï¼‰
- è£…å¤‡åŠ è½½ï¼š100-200msï¼ˆå«å¤šæ¬¡å…³è”æŸ¥è¯¢ï¼‰

ä¼˜åŒ–åï¼š
- è§’è‰²æŸ¥è¯¢ï¼š10-30msï¼ˆå†…å­˜è¯»å– <1msï¼‰
- è£…å¤‡åŠ è½½ï¼š20-60msï¼ˆå¤§éƒ¨åˆ†ä»å†…å­˜ï¼‰

æ”¹å–„ï¼š50-70%
```

#### ååé‡

```
å¹¶å‘è¯·æ±‚å¤„ç†èƒ½åŠ›ï¼š

å½“å‰ï¼š~50 req/sï¼ˆå—æ•°æ®åº“ I/O é™åˆ¶ï¼‰
ä¼˜åŒ–åï¼š~100-150 req/sï¼ˆå†…å­˜è®¿é—®ä¸ºä¸»ï¼‰

æå‡ï¼š100-200%
```

#### æ€»ä½“ I/O æ”¹å–„

```
æ•°æ®åº“æ€» I/Oï¼ˆè¯»+å†™ï¼‰ï¼š

å†™å…¥ä¼˜åŒ–åï¼šä» 93K/h â†’ 1.9K/hï¼ˆ-97.9%ï¼‰
è¯»å–ä¼˜åŒ–åï¼šä» 55K/h â†’ 5.6K/hï¼ˆ-90%ï¼‰

æ€» I/Oï¼š
ä¼˜åŒ–å‰ï¼š148K/h (93Kå†™ + 55Kè¯»)
ä¼˜åŒ–åï¼š7.5K/h (1.9Kå†™ + 5.6Kè¯»)

æ€»å‡å°‘ï¼š-95%
```

### å†…å­˜æ¶ˆè€—é¢„æœŸ

```
é¢å¤–å†…å­˜æ¶ˆè€—ï¼š

æ°¸ä¹…ç¼“å­˜ï¼ˆé…ç½®æ•°æ®ï¼‰ï¼š
- GearDefinition: ~1000 æ¡ Ã— 2KB = ~2MB
- Affix: ~500 æ¡ Ã— 1KB = ~0.5MB
- GearSet: ~50 æ¡ Ã— 1KB = ~0.05MB
å°è®¡ï¼š~2.5MB

ä¸´æ—¶ç¼“å­˜ï¼ˆç”¨æˆ·æ•°æ®ï¼Œ100ç©å®¶ï¼‰ï¼š
- Character: ~100 æ¡ Ã— 5KB = ~0.5MB
- GearInstance: ~1000 æ¡ Ã— 3KB = ~3MB
- ActivityPlan: ~500 æ¡ Ã— 2KB = ~1MB
- RunningBattleSnapshot: ~50 æ¡ Ã— 10KB = ~0.5MB
å°è®¡ï¼š~5MB

æ€»é¢å¤–å†…å­˜ï¼š~8MBï¼ˆéå¸¸å°ï¼‰

å¯¹æ¯”å†™å…¥ä¼˜åŒ–çš„å†…å­˜æ¶ˆè€—ï¼ˆ60-120MBï¼‰ï¼Œ
è¯»å–ä¼˜åŒ–çš„å†…å­˜å¼€é”€æä½ã€‚
```

---

## é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©

#### é£é™© 1ï¼šç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ âš ï¸âš ï¸

**é£é™©æè¿°**ï¼š
- å†…å­˜ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¸ä¸€è‡´
- å…¶ä»–è¿›ç¨‹æˆ–ç®¡ç†å·¥å…·ç›´æ¥ä¿®æ”¹æ•°æ®åº“

**å½±å“**ï¼š
- è¯»å–åˆ°è¿‡æ—¶æ•°æ®
- ä¸šåŠ¡é€»è¾‘é”™è¯¯

**ç¼“è§£æªæ–½**ï¼š
1. **å†™å…¥æ—¶åŒæ­¥æ›´æ–°å†…å­˜**ï¼šæ‰€æœ‰å†™å…¥æ“ä½œå¿…é¡»åŒæ—¶æ›´æ–°å†…å­˜å’Œæ•°æ®åº“
2. **æ‰¹é‡ä¿å­˜åä¿æŒåŒæ­¥**ï¼šPersistenceCoordinator ä¿å­˜åæ— éœ€é¢å¤–æ“ä½œï¼ˆå†…å­˜å·²æ˜¯æœ€æ–°ï¼‰
3. **TTL æœºåˆ¶**ï¼šä¸´æ—¶ç¼“å­˜å®šæœŸè¿‡æœŸï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
4. **é…ç½®æ•°æ®ç‰ˆæœ¬æ§åˆ¶**ï¼šé…ç½®æ•°æ®å˜æ›´æ—¶éœ€è¦é‡å¯æœåŠ¡æˆ–æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜

**ç›‘æ§æŒ‡æ ‡**ï¼š
- ç¼“å­˜å¤±æ•ˆæ¬¡æ•°
- æ•°æ®ä¸ä¸€è‡´æ£€æµ‹ï¼ˆå¯é€‰ï¼šå®šæœŸæŠ½æ ·å¯¹æ¯”ï¼‰

#### é£é™© 2ï¼šç¼“å­˜é›ªå´© âš ï¸

**é£é™©æè¿°**ï¼š
- å¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸ
- å¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“

**å½±å“**ï¼š
- æ•°æ®åº“å‹åŠ›çªå¢
- å“åº”æ—¶é—´å‰§å¢

**ç¼“è§£æªæ–½**ï¼š
1. **é”™å³°è¿‡æœŸ**ï¼šTTL æ·»åŠ éšæœºåç§»ï¼ˆÂ±10%ï¼‰
2. **é¢„åŠ è½½é™æ€æ•°æ®**ï¼šæ°¸ä¹…ç¼“å­˜ä¸ä¼šè¿‡æœŸ
3. **æ‡’åŠ è½½ + é”æœºåˆ¶**ï¼šåŒä¸€ä¸ªé”®åªæœ‰ä¸€ä¸ªè¯·æ±‚åŠ è½½æ•°æ®åº“ï¼Œå…¶ä»–ç­‰å¾…

#### é£é™© 3ï¼šå†…å­˜æ³„æ¼ âš ï¸

**é£é™©æè¿°**ï¼š
- ç¼“å­˜æŒç»­å¢é•¿ï¼Œä¸æ¸…ç†
- æµ‹è¯•ç¯å¢ƒæ•°æ®æœªæ¸…ç†

**å½±å“**ï¼š
- å†…å­˜æº¢å‡º
- GC å‹åŠ›

**ç¼“è§£æªæ–½**ï¼š
1. **MaxCachedCount é™åˆ¶**ï¼šæ¯ç§å®ä½“ç±»å‹è®¾ç½®ä¸Šé™
2. **LRU æ¸…ç†**ï¼šè¶…è¿‡ä¸Šé™æ—¶æ¸…ç†æœ€ä¹…æœªè®¿é—®çš„
3. **å®šæœŸæ¸…ç†**ï¼šCacheCoordinator å®šæœŸæ¸…ç†è¿‡æœŸé¡¹
4. **ç›‘æ§å‘Šè­¦**ï¼šå†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼å‘Šè­¦

**ç›‘æ§æŒ‡æ ‡**ï¼š
- æ¯ç§å®ä½“çš„ç¼“å­˜æ•°é‡
- æ€»å†…å­˜ä½¿ç”¨é‡
- GC é¢‘ç‡å’Œæ—¶é•¿

### ä¸šåŠ¡é£é™©

#### é£é™© 4ï¼šé…ç½®æ•°æ®æ›´æ–°ä¸åŠæ—¶ âš ï¸

**é£é™©æè¿°**ï¼š
- é…ç½®æ•°æ®ï¼ˆè£…å¤‡å®šä¹‰ã€è¯ç¼€ï¼‰è¢«æ ‡è®°ä¸ºæ°¸ä¹…ç¼“å­˜
- éœ€è¦æ›´æ–°é…ç½®æ—¶ï¼Œç¼“å­˜ä¸ä¼šè‡ªåŠ¨åˆ·æ–°

**å½±å“**ï¼š
- æ–°é…ç½®ä¸ç”Ÿæ•ˆ
- éœ€è¦é‡å¯æœåŠ¡

**ç¼“è§£æªæ–½**ï¼š
1. **æä¾›æ‰‹åŠ¨åˆ·æ–°æ¥å£**ï¼š
   ```
   POST /api/admin/cache/refresh/{entityType}
   ```
2. **é…ç½®å˜æ›´æ£€æµ‹**ï¼šå¯é€‰çš„æ•°æ®åº“è½®è¯¢æœºåˆ¶
3. **é‡å¯æµç¨‹ä¼˜åŒ–**ï¼šå¿«é€Ÿé‡å¯èƒ½åŠ›ï¼ˆ<10ç§’ï¼‰
4. **ç°åº¦å‘å¸ƒ**ï¼šé…ç½®å˜æ›´å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

#### é£é™© 5ï¼šè¿ç§»å…¼å®¹æ€§ âš ï¸

**é£é™©æè¿°**ï¼š
- ç°æœ‰ä»£ç ä¾èµ–ç›´æ¥æ•°æ®åº“æŸ¥è¯¢çš„è¡Œä¸º
- æŸäº›è¾¹ç¼˜æƒ…å†µæœªæµ‹è¯•

**å½±å“**ï¼š
- åŠŸèƒ½å¼‚å¸¸
- æ•°æ®é”™è¯¯

**ç¼“è§£æªæ–½**ï¼š
1. **é…ç½®æ€»å¼€å…³**ï¼šEnableReadCaching å¯å¿«é€Ÿå›é€€
2. **åˆ†é˜¶æ®µè¿ç§»**ï¼šå…ˆè¿ç§»ä½é£é™©å®ä½“ï¼ˆGearDefinitionï¼‰
3. **å……åˆ†æµ‹è¯•**ï¼šå…¨é¢çš„é›†æˆæµ‹è¯•
4. **é‡‘ä¸é›€å‘å¸ƒ**ï¼šå°èŒƒå›´éªŒè¯åå†å…¨é‡

### é£é™©ä¼˜å…ˆçº§

| é£é™© | ä¼˜å…ˆçº§ | æ¦‚ç‡ | å½±å“ | ç¼“è§£éš¾åº¦ | è¯„çº§ |
|------|-------|------|------|---------|------|
| ç¼“å­˜ä¸€è‡´æ€§ | P1 | ä¸­ | é«˜ | ä¸­ | âš ï¸âš ï¸ |
| ç¼“å­˜é›ªå´© | P2 | ä½ | ä¸­ | ä½ | âš ï¸ |
| å†…å­˜æ³„æ¼ | P2 | ä½ | é«˜ | ä½ | âš ï¸ |
| é…ç½®æ›´æ–°ä¸åŠæ—¶ | P3 | é«˜ | ä½ | ä½ | âš ï¸ |
| è¿ç§»å…¼å®¹æ€§ | P2 | ä¸­ | ä¸­ | ä½ | âš ï¸ |

---

## æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **å¤§å¹…å‡å°‘æ•°æ®åº“è¯»å–**ï¼šå‡å°‘ 90%ï¼ˆ55K/h â†’ 5.6K/hï¼‰
2. **ç»“åˆå†™å…¥ä¼˜åŒ–**ï¼šæ€» I/O å‡å°‘ 95%ï¼ˆ148K/h â†’ 7.5K/hï¼‰
3. **æ˜¾è‘—æå‡æ€§èƒ½**ï¼šAPI å“åº”æ—¶é—´æ”¹å–„ 50-70%
4. **æä½å†…å­˜å¼€é”€**ï¼šä»…å¢åŠ  ~8MB
5. **å®Œå…¨é…ç½®åŒ–**ï¼šæ‰€æœ‰å‚æ•°å¯é…ç½®ï¼Œçµæ´»è°ƒæ•´
6. **ä¸ç°æœ‰æ¶æ„ååŒ**ï¼šåˆ©ç”¨å·²æœ‰ MemoryStateManager

### å®æ–½ä»·å€¼

**æŠ€æœ¯ä»·å€¼**ï¼š
- å®Œå–„æ•°æ®åº“ä¼˜åŒ–ä½“ç³»ï¼ˆè¯»+å†™ï¼‰
- å»ºç«‹å®Œæ•´çš„ç¼“å­˜å±‚
- æä¾›å¯ç›‘æ§çš„æ€§èƒ½æŒ‡æ ‡

**ä¸šåŠ¡ä»·å€¼**ï¼š
- æ”¯æŒæ›´é«˜å¹¶å‘ï¼ˆ100-200% æå‡ï¼‰
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆå“åº”æ›´å¿«ï¼‰
- é™ä½åŸºç¡€è®¾æ–½æˆæœ¬

**ç®¡ç†ä»·å€¼**ï¼š
- æ¸…æ™°çš„åˆ†é˜¶æ®µè®¡åˆ’
- é‡åŒ–çš„éªŒæ”¶æ ‡å‡†
- å¯å›é€€çš„å®‰å…¨è®¾è®¡

---

## ä¸‹ä¸€æ­¥ï¼šå®æ–½æ–¹æ¡ˆ

åŸºäºæœ¬åˆ†æï¼Œå°†ç”Ÿæˆä»¥ä¸‹ä¸‰ç¯‡è¯¦ç»†å®æ–½æ–¹æ¡ˆï¼š

### ä¸Šç¯‡ï¼šç¼“å­˜å±‚åŸºç¡€è®¾æ–½å»ºè®¾
- ç›®æ ‡ï¼šå»ºç«‹ç¼“å­˜åŸºç¡€è®¾æ–½
- å†…å®¹ï¼š
  1. å¢å¼º MemoryStateManagerï¼ˆæ·»åŠ  TryGetAsyncï¼‰
  2. åˆ›å»º CacheCoordinator
  3. å®ç°é…ç½®ç³»ç»Ÿ
  4. æ·»åŠ ç¼“å­˜ç›‘æ§æŒ‡æ ‡
- å·¥ä½œé‡ï¼š3-4 å¤©

### ä¸­ç¯‡ï¼šåˆ†é˜¶æ®µè¿ç§»è¯»å–æ“ä½œ
- ç›®æ ‡ï¼šé€æ­¥è¿ç§»å„ç±»å®ä½“åˆ°ç¼“å­˜è¯»å–
- å†…å®¹ï¼š
  1. ç¬¬ä¸€é˜¶æ®µï¼šé™æ€é…ç½®æ•°æ®ï¼ˆGearDefinition, Affixï¼‰
  2. ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·æ•°æ®ï¼ˆCharacter, GearInstanceï¼‰
  3. ç¬¬ä¸‰é˜¶æ®µï¼šæ´»åŠ¨å’Œæˆ˜æ–—æ•°æ®
  4. æ¯é˜¶æ®µæµ‹è¯•éªŒè¯
- å·¥ä½œé‡ï¼š4-6 å¤©

### ä¸‹ç¯‡ï¼šä¼˜åŒ–ã€ç›‘æ§å’ŒéªŒæ”¶
- ç›®æ ‡ï¼šæ€§èƒ½è°ƒä¼˜å’Œå®Œå–„
- å†…å®¹ï¼š
  1. æ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜
  2. ç›‘æ§æŒ‡æ ‡å®Œå–„
  3. ç®¡ç†æ¥å£å¼€å‘ï¼ˆæ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ï¼‰
  4. æ–‡æ¡£å’ŒéªŒæ”¶
- å·¥ä½œé‡ï¼š2-3 å¤©

**æ€»å·¥æ—¶ä¼°ç®—ï¼š9-13 å¤©**

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… åˆ†æå®Œæˆ  
**ä¸‹ä¸€æ­¥**ï¼šç”Ÿæˆä¸‰ç¯‡å®æ–½æ–¹æ¡ˆï¼ˆä¸Šä¸­ä¸‹ï¼‰  
**æœ€åæ›´æ–°**ï¼š2025-10-18
